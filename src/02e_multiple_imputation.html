<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="BjÃ¶rn Holzhauer - bjoern.holzhauer@novartis.com">

<title>(Bayesian) Applied Modelling in Drug Development (BAMDD) - 7&nbsp; Multiple imputation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../src/02g_longitudinal.html" rel="next">
<link href="../src/02c_dose_escalation.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/02_case_studies.html">Case studies</a></li><li class="breadcrumb-item"><a href="../src/02e_multiple_imputation.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Multiple imputation</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">(Bayesian) Applied Modelling in Drug Development (BAMDD)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/Novartis/bamdd/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Getting started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01a_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01b_basic_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic workflow</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../src/02_case_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Case studies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02a_meta_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Use of historical control data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02ab_meta_analysis_trtdiff.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Meta-analysis to estimate treatment effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02b_dose_finding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Dose finding</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02c_dose_escalation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Oncology dose escalation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02e_multiple_imputation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Multiple imputation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02g_longitudinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Longitudinal data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02h_mmrm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Bayesian Mixed effects Model for Repeated Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02i_time_to_event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Time-to-event data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02j_network_meta_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Network meta-analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Advanced topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03a_stan_code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Exposing stan code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03b_parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Parallel computation</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background"><span class="header-section-number">7.1</span> Background</a>
  <ul class="collapse">
  <li><a href="#why-multiple-imputation" id="toc-why-multiple-imputation" class="nav-link" data-scroll-target="#why-multiple-imputation"><span class="header-section-number">7.1.1</span> Why multiple imputation?</a></li>
  <li><a href="#how-do-the-inner-workings-of-multiple-imputation-look-like" id="toc-how-do-the-inner-workings-of-multiple-imputation-look-like" class="nav-link" data-scroll-target="#how-do-the-inner-workings-of-multiple-imputation-look-like"><span class="header-section-number">7.1.2</span> How do the inner workings of multiple imputation look like?</a></li>
  <li><a href="#how-many-imputations-to-use" id="toc-how-many-imputations-to-use" class="nav-link" data-scroll-target="#how-many-imputations-to-use"><span class="header-section-number">7.1.3</span> How many imputations to use?</a></li>
  </ul></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">7.2</span> Data</a></li>
  <li><a href="#model-description" id="toc-model-description" class="nav-link" data-scroll-target="#model-description"><span class="header-section-number">7.3</span> Model description</a>
  <ul class="collapse">
  <li><a href="#negative-binomial-regression-as-a-poisson-random-effects-model" id="toc-negative-binomial-regression-as-a-poisson-random-effects-model" class="nav-link" data-scroll-target="#negative-binomial-regression-as-a-poisson-random-effects-model"><span class="header-section-number">7.3.1</span> Negative binomial regression as a Poisson random effects model</a></li>
  <li><a href="#extension-to-multiple-observed-time-periods-per-patient" id="toc-extension-to-multiple-observed-time-periods-per-patient" class="nav-link" data-scroll-target="#extension-to-multiple-observed-time-periods-per-patient"><span class="header-section-number">7.3.2</span> Extension to multiple observed time periods per patient</a></li>
  <li><a href="#an-imputation-framework-for-missing-count-data" id="toc-an-imputation-framework-for-missing-count-data" class="nav-link" data-scroll-target="#an-imputation-framework-for-missing-count-data"><span class="header-section-number">7.3.3</span> An imputation framework for missing count data</a></li>
  </ul></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><span class="header-section-number">7.4</span> Implementation</a>
  <ul class="collapse">
  <li><a href="#imputation-from-observed-off-treatment-data" id="toc-imputation-from-observed-off-treatment-data" class="nav-link" data-scroll-target="#imputation-from-observed-off-treatment-data"><span class="header-section-number">7.4.1</span> Imputation from observed off-treatment data</a></li>
  <li><a href="#imputation-based-on-the-control-group-event-rate-jump-to-reference" id="toc-imputation-based-on-the-control-group-event-rate-jump-to-reference" class="nav-link" data-scroll-target="#imputation-based-on-the-control-group-event-rate-jump-to-reference"><span class="header-section-number">7.4.2</span> Imputation based on the control group event rate (âjump-to-referenceâ)</a></li>
  <li><a href="#imputation-under-a-hypothetical-estimand" id="toc-imputation-under-a-hypothetical-estimand" class="nav-link" data-scroll-target="#imputation-under-a-hypothetical-estimand"><span class="header-section-number">7.4.3</span> Imputation under a hypothetical estimand</a></li>
  <li><a href="#combining-the-imputations-and-a-quick-look-at-them" id="toc-combining-the-imputations-and-a-quick-look-at-them" class="nav-link" data-scroll-target="#combining-the-imputations-and-a-quick-look-at-them"><span class="header-section-number">7.4.4</span> Combining the imputations and a quick look at them</a></li>
  <li><a href="#negative-binomial-regression-for-each-imputed-dataset" id="toc-negative-binomial-regression-for-each-imputed-dataset" class="nav-link" data-scroll-target="#negative-binomial-regression-for-each-imputed-dataset"><span class="header-section-number">7.4.5</span> Negative binomial regression for each imputed dataset</a></li>
  <li><a href="#combining-the-results-of-the-analysis-of-each-dataset-using-rubins-rule" id="toc-combining-the-results-of-the-analysis-of-each-dataset-using-rubins-rule" class="nav-link" data-scroll-target="#combining-the-results-of-the-analysis-of-each-dataset-using-rubins-rule"><span class="header-section-number">7.4.6</span> Combining the results of the analysis of each dataset using Rubinâs rule</a></li>
  <li><a href="#what-if-we-want-to-do-a-bayesian-analysis-after-mi" id="toc-what-if-we-want-to-do-a-bayesian-analysis-after-mi" class="nav-link" data-scroll-target="#what-if-we-want-to-do-a-bayesian-analysis-after-mi"><span class="header-section-number">7.4.7</span> What if we want to do a Bayesian analysis after MI?</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="header-section-number">7.5</span> Results</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">7.6</span> Conclusion</a></li>
  <li><a href="#excercises" id="toc-excercises" class="nav-link" data-scroll-target="#excercises"><span class="header-section-number">7.7</span> Excercises</a>
  <ul class="collapse">
  <li><a href="#excercise-1-food-allergy" id="toc-excercise-1-food-allergy" class="nav-link" data-scroll-target="#excercise-1-food-allergy"><span class="header-section-number">7.7.1</span> Excercise 1: Food allergy</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/02_case_studies.html">Case studies</a></li><li class="breadcrumb-item"><a href="../src/02e_multiple_imputation.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Multiple imputation</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Multiple imputation</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>BjÃ¶rn Holzhauer - <a href="mailto:bjoern.holzhauer@novartis.com" class="email">bjoern.holzhauer@novartis.com</a> </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="background" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="background"><span class="header-section-number">7.1</span> Background</h2>
<section id="why-multiple-imputation" class="level3" data-number="7.1.1">
<h3 data-number="7.1.1" class="anchored" data-anchor-id="why-multiple-imputation"><span class="header-section-number">7.1.1</span> Why multiple imputation?</h3>
<p>In clinical trials, some data we would like to observed will inevitably be missing, or the data that we observe will not be of interest for our estimand (the quantity we really want to estimate with our clinical trial) due to some intercurrent event (<a href="https://database.ich.org/sites/default/files/E9-R1_Step4_Guideline_2019_1203.pdf" class="uri">https://database.ich.org/sites/default/files/E9-R1_Step4_Guideline_2019_1203.pdf</a>). A common approach to deal with this situation is to perform some form of imputation for such values. We do this, because there is no realistic scenario under which an analysis of only the observed data (âcomplete case analysisâ) targets a meaningful estimand in a valid way.</p>
<p>When would a complete case analysis ever be appropriate? One scenario would be for a hypothetical âas-if-patients-had-been-able-to-complete-treatmentâ estimand, if we assume that patients stopping treatment or stopping trial participation happens completely at random and has nothing to do with patient characteristics and previous (efficacy and safety) outcomes for the patients. However, this is obviously rather implausible and even if it were the case, a pharmaceutical company would be hard pressed to convince the scientific community and regulatory authorities that it is so.</p>
<p>At least until about 2010, people would often impute a single value to replace any data that were missing or not of interest. One popular single value imputation approach was âlast-observation-carried-forwardâ (LOCF), in which the last observed value of interest was used to as a single imputation for any future values. However, even if the imputed value is the best possible guess for the missing value, imputing a single value completely ignores the uncertainty about the unobserved value. This is where multiple imputation (MI) comes in. MI imputes not one single value, but multiple ones. This set of values represent a sample from a distribution that describes the uncertainty about the unobserved values.</p>
</section>
<section id="how-do-the-inner-workings-of-multiple-imputation-look-like" class="level3" data-number="7.1.2">
<h3 data-number="7.1.2" class="anchored" data-anchor-id="how-do-the-inner-workings-of-multiple-imputation-look-like"><span class="header-section-number">7.1.2</span> How do the inner workings of multiple imputation look like?</h3>
<p>In general, an analysis using MI involves four steps (Rubin Donald B. âMultiple imputation for nonresponse in surveysâ. Hoboken: Wiley; 2004.):</p>
<ol type="1">
<li><p>A (Bayesian) imputation model is fit to the data and <span class="math inline">\(M\)</span> samples are drawn from the posterior distribution of the model parameters given the data.</p>
<ul>
<li><p>This imputation model could be a single model for all treatment groups without treatment group by covariate interactions, a model that has completely separate parameters for each treatment group, or a model that assumes that (some) parameters in different treatment groups are similar.</p></li>
<li><p>In a single model for all treatment groups, we can also allow for treatment by covariate interactions.</p></li>
<li><p>Generally, we need to ensure that imputation model is âcongenialâ to the analysis model. I.e. it needs to be able to capture all the complexity present in the analysis model. It will often be more complex than the analysis model, for example it might be a model for the longitudinal data of patients over time when the analysis model is only for the final study visit, or it might separately model on- and off-treatment records for patients.</p></li>
</ul></li>
<li><p>For each of the <span class="math inline">\(M\)</span> posterior samples <span class="math inline">\(M=1,\ldots,M\)</span> the missing data are simulated based on the sampled values from the posterior of the model parameters. What set of parameter values applies depends on the estimand of interest.</p>
<ul>
<li><p>Under a treatment policy estimand implemented using a âjump-to-referenceâ (J2R) approach, we would impute missing values after treatment discontinuation in all treatment groups based on placebo group parameters.</p></li>
<li><p>Alternatively, we could target a treatment policy estimand by imputing missing values after treatment discontinuation in each treatment group based on parameters that describe what happens in that treatment group after treatment discontinuation (based on observed off-treatment data).</p></li>
<li><p>Under a hypothetical âas-if-patients-had-been-able-to-complete-treatmentâ estimand, we would impute missing values for patients based on the parameters of the treatment group they were assigned to.</p></li>
<li><p>We will often use have patient specific latent random effect(s) that are used to reflect the correlation of observation from the same patient. In both of the scenarios described above, we would use the sampled values of the random effect(s) for each patients to simulate missing values for the patient. It usually computationally convenient to use latent normal random effects.</p></li>
</ul></li>
<li><p>Each of the <span class="math inline">\(M\)</span> sets of partially directly observed and partially imputed data are analyzed separately. This is done using an analysis model that need not be identical to the imputation model.</p></li>
<li><p>The results of the <span class="math inline">\(M\)</span> analyses are aggregated e.g.&nbsp;using Rubinâs rule (Rubin Donald B. âMultiple imputation for nonresponse in surveysâ. Hoboken: Wiley; 2004.).</p></li>
</ol>
<p>This all sounds pretty complicated, but it gets surprisingly easy with <code>brms</code>. Interestingly, <code>brms</code> letâs us specify some pretty complex imputation models for a wide range of situations that would otherwise require bespoke and error-prone code e.g.&nbsp;in Stan. We will illustrate that in the next sections.</p>
</section>
<section id="how-many-imputations-to-use" class="level3" data-number="7.1.3">
<h3 data-number="7.1.3" class="anchored" data-anchor-id="how-many-imputations-to-use"><span class="header-section-number">7.1.3</span> How many imputations to use?</h3>
<p>While older literature suggests as few as 3 to 5, or maybe 50 imputations, there is usually some further reduction in standard errors by using a larger number of observations such as 250. Additionally, it is desirable to make our results as independent of pure play of chance in our MCMC sampling (it is just akward when the interpretation of the results may change with the choice of a random number seed). Thus, in practice we would frequently use 1000 or even 2500 imputations, as long as the added runtime is not prohibitive.</p>
</section>
</section>
<section id="data" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="data"><span class="header-section-number">7.2</span> Data</h2>
<p>We will need the following R packages in this Section:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend=</span><span class="st">"cmdstanr"</span>, <span class="at">cmdstanr_write_stan_file_dir=</span><span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># create cache directory if not yet available</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7894562</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># we also disable normalization of the likelihood which accelerates Poisson models used</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.normalize=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us consider some simulated data for a trial in chronic obstructive pulmonary disease (COPD). Patients are enrolled into this trial, if they had at least one COPD exacerbation requiring oral corticosteroids, antibiotics, emergency department visit or hospitalization, or leading to death. Patients are then randomized to receive a drug or placebo and followed for up to 1 year. However, some patients discontinue treatment before 1 year. Some proportion of these patients agrees to be followed until the end of the trial, while some proportion is lost to follow-up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">&lt;-</span> <span class="dv">2000</span> <span class="co"># Total number of patients randomized</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>multiple <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># Multiple of patients randomized to be simulated before applying inclusion criteria</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>minmum_for_inclusion <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># Mininum number of events in previous year for inclusion in trial</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>mean_rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># Mean event rate in simulated population before applying inclusion criteria</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>kappa <span class="ot">&lt;-</span> <span class="fl">1.5</span> <span class="co"># Dispersion parameter of simulated population</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>study_length <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># Length of simulated study</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>discontinuation_rate <span class="ot">&lt;-</span> <span class="fl">0.2</span> <span class="co"># Exponential rate at which patients discontinue treatment</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>loss_proportion <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># Proportion of discontinued patients that is lost to follow-up</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>num_imputations <span class="ot">&lt;-</span> <span class="dv">500</span> <span class="co"># number of imputations to use</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">67588</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate true event rates for patient population that is screened</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>patient_rates <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="at">n=</span>patients<span class="sc">*</span>multiple, <span class="at">shape=</span><span class="dv">1</span><span class="sc">/</span>kappa, <span class="at">rate =</span> <span class="dv">1</span><span class="sc">/</span>kappa)<span class="sc">*</span>mean_rate</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw random number of events in previous year before trial</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>previous_year <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n=</span>patients<span class="sc">*</span>multiple, patient_rates)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply inclusion criteria</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>patient_rates <span class="ot">&lt;-</span> patient_rates[previous_year<span class="sc">&gt;=</span>minmum_for_inclusion][<span class="dv">1</span><span class="sc">:</span>patients]</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>previous_year <span class="ot">&lt;-</span> previous_year[previous_year<span class="sc">&gt;=</span>minmum_for_inclusion][<span class="dv">1</span><span class="sc">:</span>patients]</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate data for patients that met inclusion criteria</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>count_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">patient=</span><span class="dv">1</span><span class="sc">:</span>patients, </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                    <span class="at">BASE =</span> previous_year,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                    <span class="at">treatment =</span> <span class="fu">ifelse</span>(patient<span class="sc">&lt;=</span>patients<span class="sc">/</span><span class="dv">2</span>, <span class="dv">0</span>L, <span class="dv">1</span>L),</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                    <span class="at">discontinuation_time =</span> <span class="fu">rexp</span>(<span class="at">n=</span>patients, <span class="at">rate=</span>discontinuation_rate),</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lost_to_followup =</span> <span class="fu">rbinom</span>(<span class="at">n=</span>patients,<span class="at">size=</span><span class="dv">1</span>, <span class="at">prob=</span>loss_proportion),</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                    <span class="at">patient_follow_up =</span> <span class="fu">min</span>(study_length, discontinuation_time),</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#drop_out = (drop_out_time&lt;study_length),</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                    <span class="at">patient_rate =</span> patient_rates[patient]) <span class="sc">%&gt;%</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">expand_grid</span>(<span class="at">patient=</span><span class="dv">1</span><span class="sc">:</span>patients,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>                        <span class="at">period=</span><span class="fu">factor</span>(<span class="dv">1</span>L<span class="sc">:</span><span class="dv">3</span>L, <span class="at">levels=</span><span class="dv">1</span>L<span class="sc">:</span><span class="dv">3</span>L, </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"On-treatment"</span>, </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">"Post-treatment"</span>, </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">"Lost-to-follow-up"</span>))), </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">"patient"</span>, <span class="at">multiple =</span> <span class="st">"all"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">follow_up =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    period<span class="sc">==</span><span class="st">"On-treatment"</span> <span class="sc">~</span> <span class="fu">pmin</span>(discontinuation_time, study_length),</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    period<span class="sc">==</span><span class="st">"Post-treatment"</span> <span class="sc">~</span> (<span class="dv">1</span><span class="sc">-</span>lost_to_followup) <span class="sc">*</span> <span class="fu">pmax</span>(study_length<span class="sc">-</span>discontinuation_time, <span class="dv">0</span>), </span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    period<span class="sc">==</span><span class="st">"Lost-to-follow-up"</span> <span class="sc">~</span> lost_to_followup <span class="sc">*</span> <span class="fu">pmax</span>(study_length<span class="sc">-</span>discontinuation_time, <span class="dv">0</span>),</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fl">1.0</span>),</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">events =</span> <span class="fu">ifelse</span>(period<span class="sc">==</span><span class="st">"Lost-to-follow-up"</span>, <span class="cn">NA_integer_</span>,</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">rpois</span>(<span class="at">n=</span>patients<span class="sc">*</span><span class="dv">3</span>, </span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>                          <span class="at">lambda=</span>follow_up<span class="sc">*</span>patient_rate<span class="sc">*</span><span class="fl">0.5</span><span class="sc">^</span>(treatment<span class="sc">*</span>(period<span class="sc">==</span><span class="st">"On-treatment"</span>)))),</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">patient =</span> <span class="fu">factor</span>(patient, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span>patients),</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment =</span> <span class="fu">factor</span>(treatment, <span class="at">levels=</span><span class="dv">0</span>L<span class="sc">:</span><span class="dv">1</span>L),</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">logBASE =</span> <span class="fu">log</span>(BASE))</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>count_data  <span class="sc">%&gt;%</span> </span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(treatment, period) <span class="sc">%&gt;%</span> </span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Events=</span><span class="fu">sum</span>(events), </span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">Patient-years</span><span class="st">`</span><span class="ot">=</span><span class="fu">sum</span>(follow_up), </span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">Event rate (/p-y)</span><span class="st">`</span> <span class="ot">=</span> Events<span class="sc">/</span><span class="st">`</span><span class="at">Patient-years</span><span class="st">`</span>,</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">Total events prev. year</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(BASE),</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">Rate in previous year</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(BASE),</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups=</span><span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 8%">
<col style="width: 15%">
<col style="width: 6%">
<col style="width: 12%">
<col style="width: 15%">
<col style="width: 21%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">treatment</th>
<th style="text-align: left;">period</th>
<th style="text-align: right;">Events</th>
<th style="text-align: right;">Patient-years</th>
<th style="text-align: right;">Event rate (/p-y)</th>
<th style="text-align: right;">Total events prev. year</th>
<th style="text-align: right;">Rate in previous year</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: left;">On-treatment</td>
<td style="text-align: right;">1505</td>
<td style="text-align: right;">903.36</td>
<td style="text-align: right;">1.67</td>
<td style="text-align: right;">2182</td>
<td style="text-align: right;">2.18</td>
</tr>
<tr class="even">
<td style="text-align: left;">0</td>
<td style="text-align: left;">Post-treatment</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">48.18</td>
<td style="text-align: right;">1.62</td>
<td style="text-align: right;">2182</td>
<td style="text-align: right;">2.18</td>
</tr>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: left;">Lost-to-follow-up</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">48.47</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">2182</td>
<td style="text-align: right;">2.18</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: left;">On-treatment</td>
<td style="text-align: right;">753</td>
<td style="text-align: right;">898.05</td>
<td style="text-align: right;">0.84</td>
<td style="text-align: right;">2162</td>
<td style="text-align: right;">2.16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: left;">Post-treatment</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">50.63</td>
<td style="text-align: right;">1.42</td>
<td style="text-align: right;">2162</td>
<td style="text-align: right;">2.16</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: left;">Lost-to-follow-up</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">51.32</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">2162</td>
<td style="text-align: right;">2.16</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="model-description" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="model-description"><span class="header-section-number">7.3</span> Model description</h2>
<section id="negative-binomial-regression-as-a-poisson-random-effects-model" class="level3" data-number="7.3.1">
<h3 data-number="7.3.1" class="anchored" data-anchor-id="negative-binomial-regression-as-a-poisson-random-effects-model"><span class="header-section-number">7.3.1</span> Negative binomial regression as a Poisson random effects model</h3>
<p>Our example uses overdispersed count data that follows a negative binomial distribution. We will use the parameterization of the negative binomial distribution, which can be derived as a Poisson random effects model with independent and identically distributed (i.i.d.) random effects. These random effects follow a gamma distribution with shape parameter <span class="math inline">\(1/\kappa\)</span> and a rate parameter <span class="math inline">\(1/\kappa\)</span> <span class="math display">\[\begin{equation*}
U_i \sim \text{Gamma}(1/\kappa, 1/\kappa),
\end{equation*}\]</span> where <span class="math inline">\(\kappa&gt;0\)</span>. The distribution of the <span class="math inline">\(Y_i\)</span> for patient <span class="math inline">\(i=1,\ldots,N\)</span> conditional on the random patient effect <span class="math inline">\(U_i=u_i\)</span> and on the observed follow-up time <span class="math inline">\(T_i=t_i\)</span> is <span class="math display">\[\begin{equation}\label{eq:poissondist}
Y_i|(U_i=u_i \text{ and } T_i=t_i) \sim \text{Poisson}(\mu u_i t_i).
\end{equation}\]</span> Note that as <span class="math inline">\(\kappa\)</span> approaches zero the negative binomial distribution becomes increasingly similar to a Poisson distribution. The <code>glm.nb</code> in the <code>MASS</code> R package instead uses a parametrization in terms of <span class="math inline">\(\theta := 1/\kappa\)</span>.</p>
<p>Thus, a negative binomial regression model is a Poisson random effects model with a log-link function: <span class="math display">\[\begin{equation}\label{eq:Poisson_re_model}
\log E(Y_i|U_i=u_i \text{ and } T_i=t_i) = \log \mu + \log u_i + \log t_i
\end{equation}\]</span> or more generally: <span class="math display">\[\begin{equation*}
\log E(Y_i|U_i=u_i \text{ and } T_i=t_i) = \boldsymbol{x_i}\boldsymbol{\beta} + \log u_i + \log t_i.
\end{equation*}\]</span> <span class="math inline">\(\boldsymbol{x_i}\)</span> is the covariate vector for subject <span class="math inline">\(i\)</span> and <span class="math inline">\(\log t_i\)</span> is an offset variable â i.e.&nbsp;a covariate with coefficient 1. In a clinical trial setting <span class="math inline">\(\boldsymbol{\beta}\)</span> will usually consist of the coefficient for an intercept <span class="math inline">\(\beta_0\)</span>, coefficients <span class="math inline">\(\beta_k\)</span> for each test treatment group <span class="math inline">\(k=1, \ldots, K\)</span> â these are the log-rate-ratios for each test group compared to the control group â and the coefficients for other covariates. Other covariates might be e.g.@ the logarithm of number of events in some preceding time period.</p>
</section>
<section id="extension-to-multiple-observed-time-periods-per-patient" class="level3" data-number="7.3.2">
<h3 data-number="7.3.2" class="anchored" data-anchor-id="extension-to-multiple-observed-time-periods-per-patient"><span class="header-section-number">7.3.2</span> Extension to multiple observed time periods per patient</h3>
<p>We can extent this model to having multiple records per patient with potentially different follow-up and covariates in each time period, with all observations from the same patient being linked through/sharing the same random effect <span class="math inline">\(u_i\)</span>. E.g. for observation <span class="math inline">\(j\)</span> of patient <span class="math inline">\(i\)</span>, we can use <span class="math display">\[\begin{equation*}
\log E(Y_{ij}|U_i=u_i \text{ and } T_{ij}=t_{ij}) = \boldsymbol{x_{ij}}\boldsymbol{\beta} + \log u_i + \log t_{ij},
\end{equation*}\]</span></p>
<p>Instead of gamma-distributed random effects <span class="math inline">\(\log U_i\)</span>, we will use normally distributed random effects <span class="math inline">\(\nu_i \sim N(0, \tau)\)</span> in our imputation model. This is computationally an easier model to fit for <code>brms</code>. Additionally, we can approximate the distribution of a log-transformed gamma random variable quite well with a normal distribution.</p>
</section>
<section id="an-imputation-framework-for-missing-count-data" class="level3" data-number="7.3.3">
<h3 data-number="7.3.3" class="anchored" data-anchor-id="an-imputation-framework-for-missing-count-data"><span class="header-section-number">7.3.3</span> An imputation framework for missing count data</h3>
<p>We will look at different estimands for count data that have all been used in practice:</p>
<ul>
<li><p>Hypothetical estimand (âas if all patients had stayed on treatment until the end of the trialâ)</p>
<ul>
<li><p>Approach #1: Maximum likelihood estimation using a negative binomial regression model for the on-treatment data (discarding any observed off-treatment data)</p></li>
<li><p>Approach #2: Explicit imputation of off-treatment or lost-to-follow-up time periods based on on-treatment data.</p></li>
<li><p>These two approaches should give almost identical results.</p></li>
<li><p>In the second approach we fit a Bayesian imputation model on the on-treatment data. Then we perform prediction with this model (=multiple imputation) setting the treatment covariate to the treatment assigned as randomization for the records that need imputation. We will impute hypothetical on-treatment data for both time periods that were unobserved, but also for any observed post-treatment time periods.</p></li>
</ul></li>
<li><p>Treatment policy estimand (reflecting that after treatment discontinuations patients are off treatment):</p>
<ul>
<li><p>Approach #1: Imputation from observed off-treatment data</p></li>
<li><p>Approach #2: Imputation based on the control (âreferenceâ) group event rate (âjump-to-referenceâ or âJ2Râ)</p></li>
<li><p>In the first approach, we fit a Bayesian imputation model on the on-treatment and observed off-treatment data. We add a âtype of time periodâ (on- or off-treatment) covariate, as well as its interaction with the assigned treatment group. This allows us to predict off-treatment records for all treatment groups based on the observed off-treatment data by setting the type of time period to âoff-treatmentâ for the periods that we did not observe data for.</p></li>
<li><p>In the second approach, we fit a Bayesian imputation model on the on-treatment data and impute the unobserved off-treatment data based on the reference group distribution (i.e.&nbsp;we set the treatment covariate to the reference group before predicting the unobserved data for these time periods). We do not impute the observed off-treatment data and include it in the data for each patient before the analysis of each imputed dataset.</p></li>
<li><p>Arguably the first approach is the more logical, because it directly uses the available evidence on what happens after discontinuing treatment. However, there are some difficulties. Firstly, there is often very little observed post-treatment data so that there will be a lot of uncertainty about the post-discontinuation event rate. Secondly, it is very challenging to model to what extent the event rate may change the more time has passed post-treatment-discontinuation (e.g.&nbsp;is there a residual treatment effect that needs to âwash-outâ over time?) and in practice this is usually ignored.</p></li>
</ul></li>
</ul>
</section>
</section>
<section id="implementation" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="implementation"><span class="header-section-number">7.4</span> Implementation</h2>
<section id="imputation-from-observed-off-treatment-data" class="level3" data-number="7.4.1">
<h3 data-number="7.4.1" class="anchored" data-anchor-id="imputation-from-observed-off-treatment-data"><span class="header-section-number">7.4.1</span> Imputation from observed off-treatment data</h3>
<p>First, let us conduct an imputation model based on the observed off-treatment data, in which we specify that event rates can be different on- and off-treatment for each treatment group. Using this model, we perform predictions for the missing post-treatment values (patients lost-to-follow-up).</p>
<p>We use <code>family=poisson()</code> here, because a Poisson model with a random patient effect on the intercept is approximately equivalent to a negative binomial regression model and this is a way of reflecting the correlation of multiple observation periods for a patient that is consistent with that. However, we could also make the imputation model more complex e.g.&nbsp;by allowing counts to be overdispersed within patient by using <code>family=negbinomial()</code>, or allowing for some interactions such as <code>treatment:logBASE</code> or <code>period:logBASE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit imputation model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>brmfit1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> events <span class="sc">|</span> <span class="fu">rate</span>(follow_up) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient) <span class="sc">+</span> treatment <span class="sc">+</span> period <span class="sc">+</span> treatment<span class="sc">:</span>period <span class="sc">+</span> logBASE,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"On-treatment"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">family=</span><span class="fu">poisson</span>(),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">silent =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 11.2 seconds.
Chain 2 finished in 10.5 seconds.
Chain 3 finished in 13.6 seconds.
Chain 4 finished in 13.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 12.1 seconds.
Total execution time: 48.8 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions for missing (lost-to-follow-up) post-treatment values</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Output format is a matrix with each column being a patient record and each row being one imputation</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>imputations1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(brmfit1, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">newdata=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="st">"Lost-to-follow-up"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">mutate</span>(<span class="at">period=</span><span class="st">"Post-treatment"</span>),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">summary =</span> F,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ndraws =</span> num_imputations) </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine predictions with existing data frame of lost-to-follow-up records</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># (results in one row per imputation per patient), then bind together with </span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># non-missing values (on-treatment and observed off-treatment values), for</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># which we have one record per patient and `.imputation` will be missing.</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>imputed1 <span class="ot">&lt;-</span> count_data <span class="sc">%&gt;%</span> </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="st">"Lost-to-follow-up"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_number=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">imputed_values =</span> <span class="fu">map</span>(row_number, </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">function</span>(x) <span class="fu">tibble</span>(<span class="at">events=</span>imputations1[,x]) <span class="sc">%&gt;%</span> </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">mutate</span>(<span class="at">.imputation=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()))) <span class="sc">%&gt;%</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>events) <span class="sc">%&gt;%</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(imputed_values) <span class="sc">%&gt;%</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(count_data <span class="sc">%&gt;%</span> </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"On-treatment"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>                     follow_up<span class="sc">&gt;</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="imputation-based-on-the-control-group-event-rate-jump-to-reference" class="level3" data-number="7.4.2">
<h3 data-number="7.4.2" class="anchored" data-anchor-id="imputation-based-on-the-control-group-event-rate-jump-to-reference"><span class="header-section-number">7.4.2</span> Imputation based on the control group event rate (âjump-to-referenceâ)</h3>
<p>Now, we do an imputation based on control group data (i.e.&nbsp;assuming that after treatment discontinuation patients are off treatment and we use either the observed off-treatment data or impute missing data based on the control group event rate).</p>
<p>For this the code looks very similar to what we did in the previous subsection. We just slightly change our imputation model, and now predict based on setting the <code>period</code> covariate to <code>"On-treatment"</code> and the <code>treatment</code> covariate to <code>"0"</code> (=control group).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>brmfit2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> events <span class="sc">|</span> <span class="fu">rate</span>(follow_up) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient) <span class="sc">+</span> treatment <span class="sc">+</span> logBASE,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(period<span class="sc">==</span><span class="st">"On-treatment"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">family=</span><span class="fu">poisson</span>(),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">silent =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 10.2 seconds.
Chain 2 finished in 10.1 seconds.
Chain 3 finished in 12.9 seconds.
Chain 4 finished in 12.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 11.3 seconds.
Total execution time: 45.8 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>imputations2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(brmfit2, </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">newdata=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="st">"Lost-to-follow-up"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">period=</span><span class="st">"On-treatment"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">treatment=</span><span class="st">"0"</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">summary =</span> F,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ndraws =</span> num_imputations) </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>imputed2 <span class="ot">&lt;-</span> count_data <span class="sc">%&gt;%</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="st">"Lost-to-follow-up"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_number=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">imputed_values =</span> <span class="fu">map</span>(row_number, </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">function</span>(x) <span class="fu">tibble</span>(<span class="at">events=</span>imputations2[,x]) <span class="sc">%&gt;%</span> </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">mutate</span>(<span class="at">.imputation=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()))) <span class="sc">%&gt;%</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>events) <span class="sc">%&gt;%</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(imputed_values) <span class="sc">%&gt;%</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(count_data <span class="sc">%&gt;%</span> </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"On-treatment"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                     follow_up<span class="sc">&gt;</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="imputation-under-a-hypothetical-estimand" class="level3" data-number="7.4.3">
<h3 data-number="7.4.3" class="anchored" data-anchor-id="imputation-under-a-hypothetical-estimand"><span class="header-section-number">7.4.3</span> Imputation under a hypothetical estimand</h3>
<p>Finally, we also do an imputation based on on-treatment data of the same treatment group. I.e. we do an analysis under a hypothetical estimand âas if all patients had finished treatmentâ. As before, we just change our imputation model and the covariates for the data to be imputed accordingly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>brmfit3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> events <span class="sc">|</span> <span class="fu">rate</span>(follow_up) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient) <span class="sc">+</span> treatment <span class="sc">+</span> logBASE,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(period<span class="sc">==</span><span class="st">"On-treatment"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">family=</span><span class="fu">poisson</span>(),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">silent =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 12.5 seconds.
Chain 2 finished in 9.6 seconds.
Chain 3 finished in 10.3 seconds.
Chain 4 finished in 12.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 11.3 seconds.
Total execution time: 45.4 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>imputations3 <span class="ot">&lt;-</span> <span class="fu">predict</span>(brmfit3, </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">newdata=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lost-to-follow-up"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">period=</span><span class="st">"On-treatment"</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">summary =</span> F,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ndraws =</span> num_imputations) </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>imputed3 <span class="ot">&lt;-</span> count_data <span class="sc">%&gt;%</span> </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lost-to-follow-up"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_number=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">imputed_values =</span> <span class="fu">map</span>(row_number, </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">function</span>(x) <span class="fu">tibble</span>(<span class="at">events=</span>imputations3[,x]) <span class="sc">%&gt;%</span> </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">mutate</span>(<span class="at">.imputation=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()))) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>events) <span class="sc">%&gt;%</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(imputed_values) <span class="sc">%&gt;%</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(count_data <span class="sc">%&gt;%</span> </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(period<span class="sc">==</span><span class="st">"On-treatment"</span> <span class="sc">&amp;</span>  follow_up<span class="sc">&gt;</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combining-the-imputations-and-a-quick-look-at-them" class="level3" data-number="7.4.4">
<h3 data-number="7.4.4" class="anchored" data-anchor-id="combining-the-imputations-and-a-quick-look-at-them"><span class="header-section-number">7.4.4</span> Combining the imputations and a quick look at them</h3>
<p>We combine the imputations from the different approaches and have a look at the mean rates under the different imputation approaches. As you can see, assuming a continued treatment effect results in a lower imputed mean event rate than assuming a cessation of the treatment effect (or basing the imputation on observed off-treatment data).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How different are the numbers?</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>imputed <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  imputed1 <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">"Retrieved drop-out imputation"</span>),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  imputed2 <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">"Jump-to-reference (J2R)"</span>),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  imputed3 <span class="sc">%&gt;%</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">"Hypothetical (MAR)"</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>imputed <span class="sc">%&gt;%</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Method, treatment, period, patient) <span class="sc">%&gt;%</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">event_rate=</span><span class="fu">mean</span>(events<span class="sc">/</span>follow_up), <span class="at">.groups=</span><span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(treatment, period, Method) <span class="sc">%&gt;%</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">event_rate=</span><span class="fu">mean</span>(event_rate), <span class="at">.groups=</span><span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 Ã 4
   treatment period            Method                        event_rate
   &lt;fct&gt;     &lt;fct&gt;             &lt;chr&gt;                              &lt;dbl&gt;
 1 0         On-treatment      Hypothetical (MAR)                 1.61 
 2 0         On-treatment      Jump-to-reference (J2R)            1.61 
 3 0         On-treatment      Retrieved drop-out imputation      1.61 
 4 0         Post-treatment    Hypothetical (MAR)                 1.68 
 5 0         Post-treatment    Jump-to-reference (J2R)            1.48 
 6 0         Post-treatment    Retrieved drop-out imputation      1.48 
 7 0         Lost-to-follow-up Hypothetical (MAR)                 1.56 
 8 0         Lost-to-follow-up Jump-to-reference (J2R)            1.55 
 9 0         Lost-to-follow-up Retrieved drop-out imputation      1.54 
10 1         On-treatment      Hypothetical (MAR)                 0.830
11 1         On-treatment      Jump-to-reference (J2R)            0.830
12 1         On-treatment      Retrieved drop-out imputation      0.830
13 1         Post-treatment    Hypothetical (MAR)                 0.859
14 1         Post-treatment    Jump-to-reference (J2R)            1.49 
15 1         Post-treatment    Retrieved drop-out imputation      1.49 
16 1         Lost-to-follow-up Hypothetical (MAR)                 0.899
17 1         Lost-to-follow-up Jump-to-reference (J2R)            1.75 
18 1         Lost-to-follow-up Retrieved drop-out imputation      1.49 </code></pre>
</div>
</div>
</section>
<section id="negative-binomial-regression-for-each-imputed-dataset" class="level3" data-number="7.4.5">
<h3 data-number="7.4.5" class="anchored" data-anchor-id="negative-binomial-regression-for-each-imputed-dataset"><span class="header-section-number">7.4.5</span> Negative binomial regression for each imputed dataset</h3>
<p>We can now conduct an analysis of each imputed dataset and look at how much the results vary between them. To do that, we need to fit a negative binomial regression to each imputed dataset. Negative binomial regression is implemented in all popular statistical software, but there are some particular challenges. Skip the next sub-section, if you are not interested in these particular points regarding negtive binomial regression using R.</p>
<section id="negative-binomial-regression-in-r-optional-subsection" class="level4" data-number="7.4.5.1">
<h4 data-number="7.4.5.1" class="anchored" data-anchor-id="negative-binomial-regression-in-r-optional-subsection"><span class="header-section-number">7.4.5.1</span> Negative binomial regression in R (optional subsection)</h4>
<p>For example, the SAS/STATsoftware provides the <code>GENMOD</code> procedure and for the Poisson random effects version the <code>COUNTREG</code> procedure. Similarly, R has the <code>glm.nb</code> function in the <code>MASS</code> package. <!-- ~\cite{venables2002MASS}. --></p>
<p>These implementations differ in their parameterization. The <code>GENMOD</code> procedure estimates <span class="math inline">\(\kappa\)</span> and reverts to Poisson regression on the boundary of the parameter space when <span class="math inline">\(\hat{\kappa}=0\)</span>. The <code>glm.nb</code> function parameterizes the model in terms of <span class="math inline">\(\theta:=1/\kappa\)</span> and its algorithm will not converge to a finite estimate <span class="math inline">\(\hat{\theta}\)</span> whenever the maximum likelihood estimator for <span class="math inline">\(\kappa\)</span> is <span class="math inline">\(\hat{\kappa}=0\)</span>. However, after a sufficient number of iterations <span class="math inline">\(\hat{\theta}\)</span> will be large enough that the estimates of the regression coefficients will be those we would obtain by Poisson regression â alternatively, we can use the results from Poisson regression in this case. This is implemented in the code below.</p>
<p>Instead of the preferable observed Fisher information used in the <code>GENMOD</code> procedure, the <code>glm.nb</code> function uses the expected Fisher information for the standard errors of the regression coefficients â while the standard error for <span class="math inline">\(\hat{\theta}\)</span> is based on the observed rather than the expected Fisher information â as of version 7.3-47 of the <code>MASS</code> package. Especially for small samples sizes this may result in too small standard errors. Thus, they should â especially for confirmatory clinical trials â be corrected, which is easily done using <a href="https://stats.stackexchange.com/questions/221648/negative-binomial-regression-in-r-allowing-for-correlation-between-dispersion">code provded by Bartlett</a>. <!-- ~\cite{lee2006general} --> <!-- % ~\cite{bartlett2016negbin}. --></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>glm.nb.cov <span class="ot">&lt;-</span> <span class="cf">function</span>(mod) {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Basis of code for this function: </span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># https://stats.stackexchange.com/questions/221648/negative-binomial-regression-in-r-allowing-for-correlation-between-dispersion</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#given a model fitted by glm.nb in MASS, this function returns a variance covariance matrix for the</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#regression coefficients and dispersion parameter, without assuming independence between these</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#note that the model must have been fitted with x=TRUE argument so that design matrix is available</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#formulae based on p23-p24 of http://pointer.esalq.usp.br/departamentos/lce/arquivos/aulas/2011/LCE5868/OverdispersionBook.pdf</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">#and http://www.math.mcgill.ca/~dstephens/523/Papers/Lawless-1987-CJS.pdf</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> mod<span class="sc">$</span>theta</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">dim</span>(<span class="fu">vcov</span>(mod))[<span class="dv">1</span>]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#construct observed information matrix</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  obsInfo <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(p<span class="sc">+</span><span class="dv">1</span>, p<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#first calculate top left part for regression coefficients</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>      obsInfo[i,j] <span class="ot">&lt;-</span> <span class="fu">sum</span>( (<span class="dv">1</span><span class="sc">+</span>mod<span class="sc">$</span>y<span class="sc">/</span>mod<span class="sc">$</span>theta)<span class="sc">*</span>mod<span class="sc">$</span>fitted.values<span class="sc">*</span>mod<span class="sc">$</span>x[,i]<span class="sc">*</span>mod<span class="sc">$</span>x[,j] <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span>mod<span class="sc">$</span>fitted.values<span class="sc">/</span>mod<span class="sc">$</span>theta)<span class="sc">^</span><span class="dv">2</span>  )</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#information for dispersion parameter</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  obsInfo[(p<span class="sc">+</span><span class="dv">1</span>),(p<span class="sc">+</span><span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">trigamma</span>(mod<span class="sc">$</span>theta<span class="sc">+</span>mod<span class="sc">$</span>y) <span class="sc">-</span> <span class="fu">trigamma</span>(mod<span class="sc">$</span>theta) <span class="sc">-</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">1</span><span class="sc">/</span>(mod<span class="sc">$</span>fitted.values<span class="sc">+</span>mod<span class="sc">$</span>theta) <span class="sc">+</span> (mod<span class="sc">$</span>theta<span class="sc">+</span>mod<span class="sc">$</span>y)<span class="sc">/</span>(mod<span class="sc">$</span>theta<span class="sc">+</span>mod<span class="sc">$</span>fitted.values)<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">1</span><span class="sc">/</span>(mod<span class="sc">$</span>fitted.values<span class="sc">+</span>mod<span class="sc">$</span>theta) <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>mod<span class="sc">$</span>theta)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#covariance between regression coefficients and dispersion</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    obsInfo[(p<span class="sc">+</span><span class="dv">1</span>),i] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">sum</span>(((mod<span class="sc">$</span>y<span class="sc">-</span>mod<span class="sc">$</span>fitted.values) <span class="sc">*</span> mod<span class="sc">$</span>fitted.values <span class="sc">/</span> ( (mod<span class="sc">$</span>theta<span class="sc">+</span>mod<span class="sc">$</span>fitted.values)<span class="sc">^</span><span class="dv">2</span> )) <span class="sc">*</span> mod<span class="sc">$</span>x[,i] )</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    obsInfo[i,(p<span class="sc">+</span><span class="dv">1</span>)] <span class="ot">&lt;-</span> obsInfo[(p<span class="sc">+</span><span class="dv">1</span>),i]</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">#return variance covariance matrix</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve</span>(obsInfo)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>fitmodel <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to fit NB model - returns result of Poisson model,</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if estimate of 1/dispersion parameter appears to go towards infinity.</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Additionally, standard errors are calculated using the observed</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># information matrix by calling the previously defined function for that.</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  poifit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> events <span class="sc">~</span> treatment <span class="sc">+</span> logBASE <span class="sc">+</span> <span class="fu">offset</span>(logfollowup),</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">glm.control</span>(<span class="at">maxit =</span> <span class="dv">2500</span>),</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">poisson</span>()</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># glm.nb may fail to converge with a message such as</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Warning: step size truncated due to divergence"</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Error in glm.fitter(X[, "(Intercept)", drop = FALSE], Y, w, offset = offset,: NA/NaN/Inf in 'x'"</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We need to make sure we catch that issue. In that case we set nbfit = list(theta=10001), which</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># results in Poisson regression results being used (see check on nbfit$theta later).</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>  nbfit <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glm.nb</span>(</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> data,</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> aval <span class="sc">~</span> events <span class="sc">~</span> treatment <span class="sc">+</span> logBASE <span class="sc">+</span> <span class="fu">offset</span>(logfollowup),</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> poifit<span class="sc">$</span>coefficients,</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">init.theta =</span> <span class="fl">1.25</span>,</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> <span class="fu">glm.control</span>(<span class="at">maxit =</span> <span class="dv">30</span>),</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="cn">TRUE</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>      ), <span class="at">warning =</span> <span class="cf">function</span>(err)</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">theta =</span> <span class="dv">99999</span>),</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(err)</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">theta =</span> <span class="dv">99999</span>)</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">emm_options</span>(<span class="at">msg.nesting =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>              <span class="at">msg.interaction =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (nbfit<span class="sc">$</span>theta <span class="sc">&gt;</span> <span class="dv">10000</span>) {</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">treatment =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>treatment)),</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">logrr =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">summary</span>(poifit)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span>]),</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">logrrSE =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">summary</span>(poifit)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>]),</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="fu">summary</span>(</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>        <span class="fu">emmeans</span>(</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>          poifit,</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span> <span class="fu">factor</span>(treatment),</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>          <span class="at">weights =</span> <span class="st">"proportional"</span>,</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>          <span class="at">at =</span> <span class="fu">list</span>(<span class="at">logfollowup =</span> <span class="dv">0</span>)</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>      ))[, <span class="fu">c</span>(<span class="st">"emmean"</span>, <span class="st">"SE"</span>)])</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">trt =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>treatment)),</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">logrr =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">summary</span>(nbfit)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span>]),</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">logrrSE =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">sqrt</span>(<span class="fu">diag</span>(</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>        <span class="fu">glm.nb.cov</span>(nbfit)</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>      ))[<span class="dv">2</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="fu">summary</span>(</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>        <span class="fu">emmeans</span>(</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>          nbfit,</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span> <span class="fu">factor</span>(treatment),</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>          <span class="at">weights =</span> <span class="st">"proportional"</span>,</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>          <span class="at">at =</span> <span class="fu">list</span>(<span class="at">logfollowup =</span> <span class="dv">0</span>),</span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>          <span class="at">vcov =</span> <span class="fu">glm.nb.cov</span>(nbfit)[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(nbfit<span class="sc">$</span>coefficients), <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(nbfit<span class="sc">$</span>coefficients)]</span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>      ))[, <span class="fu">c</span>(<span class="st">"emmean"</span>, <span class="st">"SE"</span>)])</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fitting-the-negative-binomial-regression-to-the-imputed-data" class="level4" data-number="7.4.5.2">
<h4 data-number="7.4.5.2" class="anchored" data-anchor-id="fitting-the-negative-binomial-regression-to-the-imputed-data"><span class="header-section-number">7.4.5.2</span> Fitting the negative binomial regression to the imputed data</h4>
<p>Actually fitting negative binomial regression on each imputed datasets is now easy with the function above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">.imputation =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(imputed<span class="sc">$</span>.imputation, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(.imputation , <span class="cf">function</span>(x)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>      imputed <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>          Method <span class="sc">==</span> <span class="st">"Hypothetical (MAR)"</span> <span class="sc">&amp;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>            .imputation <span class="sc">%in%</span> <span class="fu">c</span>(x, <span class="cn">NA_integer_</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(patient, treatment, BASE, logBASE, .imputation) <span class="sc">%&gt;%</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">logfollowup =</span> <span class="fu">log</span>(<span class="fu">sum</span>(follow_up)),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">events =</span> <span class="fu">sum</span>(events),</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fitmodel</span>(<span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(treatment <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Hypothetical (MAR)"</span>),</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>      imputed <span class="sc">%&gt;%</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>          Method <span class="sc">==</span> <span class="st">"Retrieved drop-out imputation"</span> <span class="sc">&amp;</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>            .imputation <span class="sc">%in%</span> <span class="fu">c</span>(x, <span class="cn">NA_integer_</span>)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(patient, treatment, BASE, logBASE, .imputation) <span class="sc">%&gt;%</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">logfollowup =</span> <span class="fu">log</span>(<span class="fu">sum</span>(follow_up)),</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>          <span class="at">events =</span> <span class="fu">sum</span>(events),</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>          <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fitmodel</span>(<span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(treatment <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Retrieved drop-out imputation"</span>),</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>      imputed <span class="sc">%&gt;%</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>          Method <span class="sc">==</span> <span class="st">"Jump-to-reference (J2R)"</span> <span class="sc">&amp;</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>            .imputation <span class="sc">%in%</span> <span class="fu">c</span>(x, <span class="cn">NA_integer_</span>)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(patient, treatment, BASE, logBASE, .imputation) <span class="sc">%&gt;%</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>          <span class="at">logfollowup =</span> <span class="fu">log</span>(<span class="fu">sum</span>(follow_up)),</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>          <span class="at">events =</span> <span class="fu">sum</span>(events),</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fitmodel</span>(<span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(treatment <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Jump-to-reference (J2R)"</span>)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    ))) <span class="sc">%&gt;%</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>logrr, <span class="at">xmin=</span>logrr<span class="sc">-</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span>logrrSE,</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>             <span class="at">xmax=</span>logrr<span class="sc">+</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span>logrrSE, <span class="at">y=</span>.imputation, )) <span class="sc">+</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size=</span><span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">0</span>, <span class="at">linetype=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>() <span class="sc">+</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Method) <span class="sc">+</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.9</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Imputation number"</span>) <span class="sc">+</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"log-rate ratio (drug versus placebo, &lt;0 favors drug)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02e_multiple_imputation_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="combining-the-results-of-the-analysis-of-each-dataset-using-rubins-rule" class="level3" data-number="7.4.6">
<h3 data-number="7.4.6" class="anchored" data-anchor-id="combining-the-results-of-the-analysis-of-each-dataset-using-rubins-rule"><span class="header-section-number">7.4.6</span> Combining the results of the analysis of each dataset using Rubinâs rule</h3>
<p>Finally, we use Rubinâs rule to combine results across the different imputed datasets for each imputation method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>rubins_rule <span class="ot">&lt;-</span> <span class="cf">function</span>(estimates, SEs) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  nmi <span class="ot">&lt;-</span> <span class="fu">length</span>(estimates)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  mi_estimate <span class="ot">&lt;-</span> <span class="fu">mean</span>(estimates)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  mi_SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>( <span class="fu">sum</span>(SEs<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>nmi <span class="sc">+</span> (<span class="dv">1</span><span class="sc">+</span><span class="dv">1</span><span class="sc">/</span>nmi) <span class="sc">*</span> <span class="fu">sum</span>((mi_estimate<span class="sc">-</span>estimates)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (nmi<span class="dv">-1</span>) )</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  mi_Z <span class="ot">&lt;-</span> mi_estimate<span class="sc">/</span>mi_SE</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  mi_p <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">min</span>(<span class="fu">pnorm</span>(mi_Z), <span class="dv">1</span><span class="sc">-</span><span class="fu">pnorm</span>(mi_Z))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="fu">tibble</span>(<span class="at">logrr=</span>mi_estimate, <span class="at">logrrSE=</span>mi_SE, <span class="at">p=</span>mi_p) )</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Method) <span class="sc">%&gt;%</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do</span>(<span class="fu">rubins_rule</span>(.<span class="sc">$</span>logrr, .<span class="sc">$</span>logrrSE)) <span class="sc">%&gt;%</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    count_data <span class="sc">%&gt;%</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(period<span class="sc">==</span><span class="st">"On-treatment"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">logfollowup=</span><span class="fu">log</span>(follow_up)) <span class="sc">%&gt;%</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fitmodel</span>(<span class="at">data=</span>.) <span class="sc">%&gt;%</span> </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(treatment<span class="sc">==</span><span class="st">"1"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">"Hypothetical</span><span class="sc">\n</span><span class="st">(NegBin for on-treatment data)"</span>,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">p=</span><span class="dv">2</span><span class="sc">*</span><span class="fu">min</span>(<span class="fu">pnorm</span>(logrr<span class="sc">/</span>logrrSE), <span class="dv">1</span><span class="sc">-</span><span class="fu">pnorm</span>(logrr<span class="sc">/</span>logrrSE)) ) <span class="sc">%&gt;%</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treatment, <span class="sc">-</span>emmean, <span class="sc">-</span>SE)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">upper =</span> logrr <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span>logrrSE,</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">lower =</span> logrr <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span>logrrSE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="what-if-we-want-to-do-a-bayesian-analysis-after-mi" class="level3" data-number="7.4.7">
<h3 data-number="7.4.7" class="anchored" data-anchor-id="what-if-we-want-to-do-a-bayesian-analysis-after-mi"><span class="header-section-number">7.4.7</span> What if we want to do a Bayesian analysis after MI?</h3>
<p>If we have multiple imputated datasets and wish to perform Bayesian inference, we would recommend the approach of described in the Bayesian Data Analysis book by Gelman et al.&nbsp;(Gelman, A., Carlin, J.B., Stern, H.S., Dunson, D.B., Vehtari, A. and Rubin, D.B., 2014. Bayesian data analysis (3rd ed.). CRC press. p.452) that uses the (equally weighted) mixture distribution of the posterior distributions as the combined posterior distribution. I.e. we use all the (or a random subset) of the MCMC samples from each analysis as samples from the combined posterior distribution. This has been reported to perform well with a sufficient number of imputations such as 100 (Zhou, X. and Reiter, J.P., 2010. A note on Bayesian inference after multiple imputation. The American Statistician, 64(2), pp.159-163.).</p>
<p>We could of course write some code to fit separate Bayesian models for each imputed dataset and then combine the posterior samples, but we do not have to, because <code>brms</code> can take care of it for us. E.g. the code below would run 1 MCMC chain for each of 20 imputed datasets (without specifying any prior distributions, which we would in practice of course also do).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>fit_multiple1 <span class="ot">&lt;-</span> <span class="fu">brm_multiple</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    events <span class="sc">|</span> <span class="fu">rate</span>(follow_up) <span class="sc">~</span> treatment <span class="sc">+</span> logBASE,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map</span>(<span class="dv">1</span>L<span class="sc">:</span><span class="dv">20</span>L, </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>               <span class="cf">function</span>(x) imputed1 <span class="sc">%&gt;%</span> </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">filter</span>(<span class="fu">is.na</span>(.imputation) <span class="sc">|</span> .imputation<span class="sc">==</span>x) <span class="sc">%&gt;%</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">group_by</span>(patient, logBASE, treatment) <span class="sc">%&gt;%</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">summarize</span>(<span class="at">events=</span><span class="fu">sum</span>(events), <span class="at">follow_up=</span><span class="fu">sum</span>(follow_up))),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">negbinomial</span>(),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">1</span>, <span class="at">seed =</span> <span class="dv">6234</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="results" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="results"><span class="header-section-number">7.5</span> Results</h2>
<p>As we can see the results from imputing explicitly âas if all patients had finished treatmentâ matches the results from a negative binomial regression of on-treatment data rather closely. Similarly, the two approaches for treatment policy estimands (jump-to-reference or imputation based on retrieved drop-outs) give quite similar results, but with higher variability when basing imputations on the small number of subjects with post-treatment-discontinuation data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>final_results <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">exp</span>(logrr), <span class="at">y=</span>Method, <span class="at">xmin=</span><span class="fu">exp</span>(lower), <span class="at">xmax=</span><span class="fu">exp</span>(upper))) <span class="sc">+</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">1</span>, <span class="at">linetype=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="at">height=</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">1.0</span>)) <span class="sc">+</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Rate ratio (drug vs. placebo)</span><span class="sc">\n</span><span class="st">(values &lt;1.0 favor drug over placebo)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02e_multiple_imputation_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">7.6</span> Conclusion</h2>
<p>Imputation for overdispersed count data is not covered by popular alternatives for missing data imputation such as the PROC MI procedure in SAS or the <code>Amelia</code> package in R. We are able to quickyly implement something sensible in <code>brms</code>. For this purpose, <code>brms</code> enabled us to fit imputation models and do imputation based on MAR (hypothetical estimand), J2R (treatment policy estimand) or retrieved drop-out data (treatment policy estimand).</p>
<p>We can also fit multivariate imputation models (see the <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_multivariate.html">corresponding <code>brms</code> vignette</a>) across different types of outcomes that could be missing and correlated. For that we would use syntax like <code>bf1 &lt;- bf(severity | subset(is_obs_severity) ~ (1|p|gr(USUBJID, by=treatment))) + cumulative()</code>, <code>bf2 &lt;- bf(CHG1 | subset(is_obs_CHG1) ~ treatment + (1|p|gr(USUBJID, by=treatment))) + gaussian()</code> and <code>bf9 &lt;- bf(country | subset(is_obs_country) ~ (1|p|gr(USUBJID, by=treatment))) + categorical()</code> in combination with <code>formula = bf1 + bf2 + bf3 + set_rescor(FALSE)</code> in our call to the <code>brm</code> function. However, such models can be more challenging to fit and we aim to add examples on this in the future.</p>
</section>
<section id="excercises" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="excercises"><span class="header-section-number">7.7</span> Excercises</h2>
<section id="excercise-1-food-allergy" class="level3" data-number="7.7.1">
<h3 data-number="7.7.1" class="anchored" data-anchor-id="excercise-1-food-allergy"><span class="header-section-number">7.7.1</span> Excercise 1: Food allergy</h3>
<p>This is example is about a simulated randomized controlled trial of a new treatment compared with placebo for peanut allergy. The primary endpoint is the result of a double-blind, placebo controlled food challenge (DBPCFC), during which patients take increasing amounts of peanut flour (1, 3, 10, 30, 100, 300, 600 and 1000 mg). Tolerating a higher amount of peaanut flour is a better outcome and the proportion of patients tolerating at least 600 mg at week 52 will be analyzed in the primary analysis. DBPCFC is performed at baseline, at week 12, 26 and 52 (1-year). The code below creates a <code>tibble</code> with simulated data from a hypothetical study.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>patients <span class="ot">=</span> <span class="dv">200</span>L</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>amounts <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">10</span>, <span class="dv">30</span>, <span class="dv">100</span>, <span class="dv">300</span>, <span class="dv">600</span>, <span class="dv">1000</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>patient_re <span class="ot">=</span> <span class="fu">rnorm</span>(patients, <span class="at">mean=</span><span class="dv">1</span>, <span class="at">sd=</span><span class="fl">0.5</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>simulated <span class="ot">=</span> <span class="fu">expand_grid</span>(<span class="at">patient=</span><span class="dv">1</span>L<span class="sc">:</span>patients, <span class="at">visit=</span><span class="fu">c</span>(<span class="dv">0</span>L,<span class="dv">12</span>L,<span class="dv">26</span>L,<span class="dv">52</span>L)) <span class="sc">%&gt;%</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Treatment =</span> <span class="dv">1</span>L<span class="sc">*</span>(patient<span class="sc">&gt;</span>patients<span class="sc">/</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(patient, visit) <span class="sc">%&gt;%</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(patient) <span class="sc">%&gt;%</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">discontinued =</span> ( <span class="fu">cumsum</span>( (visit<span class="sc">&gt;=</span><span class="dv">12</span>L)<span class="sc">*</span><span class="fu">rbinom</span>(<span class="at">n=</span><span class="fu">n</span>(), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob=</span><span class="fl">0.2</span>) ) <span class="sc">&gt;=</span><span class="dv">1</span>),</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">lost_to_followup =</span> ( <span class="fu">cumsum</span>( discontinued <span class="sc">*</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="fu">n</span>(), <span class="at">size=</span><span class="dv">1</span>, <span class="at">prob=</span><span class="fl">0.3</span>) ) <span class="sc">&gt;=</span> <span class="dv">1</span>) ,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">latent =</span> <span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="at">n=</span><span class="fu">n</span>(), <span class="at">sd=</span><span class="fl">1.0</span>) <span class="sc">+</span> <span class="fl">4.0</span><span class="sc">*</span>(visit<span class="sc">&gt;=</span><span class="dv">12</span>L) <span class="sc">+</span> ((visit<span class="sc">&gt;=</span><span class="dv">12</span>L)<span class="sc">*</span><span class="fl">2.0</span><span class="sc">+</span>(visit<span class="sc">&gt;=</span><span class="dv">26</span>)<span class="sc">*</span><span class="fl">2.0</span><span class="sc">+</span>(visit<span class="sc">&gt;=</span><span class="dv">52</span>)<span class="sc">*</span><span class="fl">1.0</span>)<span class="sc">*</span>Treatment<span class="sc">*</span>(discontinued<span class="sc">==</span>F) <span class="sc">+</span> patient_re[patient]),</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">aval =</span> <span class="fu">case_when</span>(latent<span class="sc">&lt;</span><span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span>L,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>                     latent<span class="sc">&lt;</span><span class="dv">3</span> <span class="sc">~</span> <span class="dv">2</span>L,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>                     latent<span class="sc">&lt;</span><span class="dv">10</span> <span class="sc">~</span> <span class="dv">3</span>L,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>                     latent<span class="sc">&lt;</span><span class="dv">30</span> <span class="sc">~</span> <span class="dv">4</span>L,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>                     latent<span class="sc">&lt;</span><span class="dv">100</span> <span class="sc">~</span> <span class="dv">5</span>L,</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>                     latent<span class="sc">&lt;</span><span class="dv">300</span> <span class="sc">~</span> <span class="dv">6</span>L,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>                     latent<span class="sc">&lt;</span><span class="dv">600</span> <span class="sc">~</span> <span class="dv">7</span>L,</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>                     latent<span class="sc">&lt;</span><span class="dv">1000</span> <span class="sc">~</span> <span class="dv">8</span>L,</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>                     <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">9</span>L))  <span class="sc">%&gt;%</span>  </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">aval =</span> <span class="fu">ifelse</span>(lost_to_followup, <span class="cn">NA_integer_</span>, aval)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>latent)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">=</span> simulated <span class="sc">%&gt;%</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(visit<span class="sc">&gt;</span><span class="dv">0</span>L) <span class="sc">%&gt;%</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(simulated <span class="sc">%&gt;%</span> </span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(visit<span class="sc">==</span><span class="dv">0</span>L) <span class="sc">%&gt;%</span> </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">base=</span>aval) <span class="sc">%&gt;%</span> </span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(patient, base), </span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">"patient"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Treatment =</span> <span class="fu">factor</span>(Treatment, <span class="at">levels=</span><span class="dv">0</span>L<span class="sc">:</span><span class="dv">1</span>L, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Placebo"</span>, <span class="st">"Drug"</span>)),</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">aval =</span> <span class="fu">ordered</span>(aval, <span class="at">levels=</span><span class="dv">1</span>L<span class="sc">:</span><span class="dv">9</span>L),</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>         <span class="at">visit =</span> <span class="fu">factor</span>(visit, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">12</span>L, <span class="dv">26</span>L, <span class="dv">52</span>L)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Summarizing the data by treatment group and visit as a bar plot, it appears like the new drug may have a large effect on the outcome of the DBPCFC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>simulated <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Treatment =</span> <span class="fu">factor</span>(Treatment, <span class="at">levels=</span><span class="dv">0</span>L<span class="sc">:</span><span class="dv">1</span>L, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Placebo"</span>, <span class="st">"Drug"</span>)),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">Tolerated amount</span><span class="sc">\n</span><span class="at">of peanut flour</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ordered</span>(aval, <span class="at">levels=</span><span class="fu">c</span>(<span class="cn">NA_integer_</span>, <span class="dv">1</span>L<span class="sc">:</span><span class="dv">9</span>L),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>( <span class="st">"&lt; 1 mg"</span>, <span class="fu">paste0</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">10</span>, <span class="dv">30</span>, <span class="dv">100</span>, <span class="dv">300</span>, <span class="dv">600</span>, <span class="dv">1000</span>), <span class="st">" mg"</span>))),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">visit =</span> <span class="fu">ordered</span>(visit, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">0</span>L,<span class="dv">12</span>L,<span class="dv">26</span>L,<span class="dv">52</span>L),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> <span class="fu">paste0</span>(<span class="st">"Visit "</span>, <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">12</span>,<span class="dv">26</span>,<span class="dv">52</span>)))) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Treatment, <span class="at">fill=</span><span class="st">`</span><span class="at">Tolerated amount</span><span class="sc">\n</span><span class="at">of peanut flour</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">col=</span><span class="st">"darkgrey"</span>) <span class="sc">+</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette=</span><span class="st">"PuBu"</span>, <span class="at">na.value=</span><span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>visit, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Patients"</span>) <span class="sc">+</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="fu">rel</span>(<span class="fl">0.5</span>)), </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="fu">rel</span>(<span class="fl">0.5</span>)),</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">"cm"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02e_multiple_imputation_files/figure-html/food_allergy_barplot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Or, as an alternative display as a spaghetti plot (note the handy <code>seed</code> option in <code>position_jitter()</code> to keep the line and point geoms aligned).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>simulated <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(aval)) <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Treatment =</span> <span class="fu">factor</span>(Treatment, <span class="at">levels=</span><span class="dv">0</span>L<span class="sc">:</span><span class="dv">1</span>L, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Placebo"</span>, <span class="st">"Drug"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>visit, <span class="at">y=</span>aval, <span class="at">group=</span>patient, <span class="at">color=</span>Treatment)) <span class="sc">+</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height=</span><span class="fl">0.1</span>, <span class="at">seed =</span> <span class="dv">123</span>)) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.2</span>, <span class="at">position =</span> <span class="fu">position_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">height=</span><span class="fl">0.1</span>, <span class="at">seed =</span> <span class="dv">123</span>)) <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">labels=</span><span class="fu">c</span>( <span class="st">"&lt; 1 mg"</span>, <span class="fu">paste0</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">10</span>, <span class="dv">30</span>, <span class="dv">100</span>, <span class="dv">300</span>, <span class="dv">600</span>, <span class="dv">1000</span>), <span class="st">" mg"</span>))) <span class="sc">+</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">12</span>,<span class="dv">26</span>,<span class="dv">52</span>)) <span class="sc">+</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Treatment) <span class="sc">+</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (weeks)"</span>) <span class="sc">+</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Tolerated amount of peanut flour"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02e_multiple_imputation_files/figure-html/food_allergy_spaghetti-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Excercises in increasing order of complexity (* marks advanced questions):</p>
<ol type="1">
<li><p>Fit a simple logistic regression (i.e.&nbsp;<code>glm(formula = response ~ Treatment, family=binomial(link="logit"))</code>) that uses a composite estimand treating discontinuation of treatment as equivalent to the worst response category (not tolerating 1 mg of peanut flour, i.e.&nbsp;<code>model_data %&gt;% filter(visit == 52L) %&gt;% mutate(aval = ifelse(is.na(aval), 1L, aval), response = 1L*(aval &gt;= 8L))</code>). Does this support the alternative hypothesis that the new drug is better than placebo? What if we change the null hypothesis to the difference in response rate being less than 10 percentage points higher than the placebo response rate (and the alternative hypothesis to it being 10 or more percentage points better than placebo)?</p></li>
<li><p>Compare the results to imputing the ordinal outcome under a treatment policy estimand either based on the observed post-treatment data for patients that discontinued treatemnt. For this, you could use <code>family=cumulative()</code> and <code>formula = aval ~ 1 + (1|patient) + visit*Treatment*discontinued*mo(base)</code>. Note that <code>mo(base)</code> implies a monotonic effect of the baseline DBPCFC outcome being higher without imposing a linear relationship. Allowing for all of the interactions we are specifying and the adjustment for baseline are examples of making an imputation model more complex than our analysis model. Perform, say, 100 imputations, perform the analysis for each imputation and combine estimates of the log-odds-ratio.</p>
<ol type="a">
<li>In this case, do we appear to gain much for the purposes of showing that the drug works from the more complex imputation approach?</li>
<li>Do you think the answer to this would change, if half of the discontinuation occurred due to the COVID-19 pandemic and we imputed post-treatment data for these patients under a hypothetical estimand (assuming patients would continue to take treatment to the end of the study)?</li>
</ol></li>
<li><p>How would you target the treatment policy estimand using the jump-to-reference approach? What would your imputation model look like and for which records would you perform the imputation?</p></li>
<li><p>* Would a linear model for log-tolerated amount of peanut flour fit the data better than the ordinal regression model we used to fit the data? For this, treat not tolerating 1 mg as being right-censored below 1 mg (<code>brms</code> allows you to use the <code>aval | cens(censored) ~ regression formula</code> syntax, where the variable <code>censored</code> would contain the values <code>'none'</code> for uncensored observations and <code>'right'</code> for right-censored observations).</p></li>
<li><p>* Perform similar analyses as above (1-3), but use an ordinal regression model e.g.&nbsp;via <code>MASS::polr</code> or <a href="https://search.r-project.org/CRAN/refmans/rms/html/orm.html"><code>rms::orm</code></a>.</p></li>
</ol>
<p>Further reading: Several blogposts by Frank Harrell cover proportional odds models (e.g.&nbsp;<a href="https://www.fharrell.com/post/ordinal-info/">1</a>, <a href="https://www.fharrell.com/post/impactpo">2</a>, <a href="https://www.fharrell.com/post/wpo/">3</a> and <a href="https://www.fharrell.com/post/po/">4</a>).</p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/opensource\.nibr\.com\/bamdd\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../src/02c_dose_escalation.html" class="pagination-link" aria-label="Oncology dose escalation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Oncology dose escalation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../src/02g_longitudinal.html" class="pagination-link" aria-label="Longitudinal data">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Longitudinal data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb25" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">  - BjÃ¶rn Holzhauer - &lt;bjoern.holzhauer@novartis.com&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Multiple imputation</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include=FALSE}</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="in">source(here::here("src", "setup.R"))</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-profile="dummy"}</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview Video</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>{{&lt; video videos/brms-case-4-multiple-imputation.mp4 &gt;}}</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="fu">## Background</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why multiple imputation?</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>In clinical trials, some data we would like to observed will inevitably be missing, or the data that we observe will not be of interest for our estimand (the quantity we really want to estimate with our clinical trial) due to some intercurrent event (<span class="ot">&lt;https://database.ich.org/sites/default/files/E9-R1_Step4_Guideline_2019_1203.pdf&gt;</span>). A common approach to deal with this situation is to perform some form of imputation for such values. We do this, because there is no realistic scenario under which an analysis of only the observed data ("complete case analysis") targets a meaningful estimand in a valid way.</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>When would a complete case analysis ever be appropriate? One scenario would be for a hypothetical "as-if-patients-had-been-able-to-complete-treatment" estimand, if we assume that patients stopping treatment or stopping trial participation happens completely at random and has nothing to do with patient characteristics and previous (efficacy and safety) outcomes for the patients. However, this is obviously rather implausible and even if it were the case, a pharmaceutical company would be hard pressed to convince the scientific community and regulatory authorities that it is so.</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>At least until about 2010, people would often impute a single value to replace any data that were missing or not of interest. One popular single value imputation approach was "last-observation-carried-forward" (LOCF), in which the last observed value of interest was used to as a single imputation for any future values. However, even if the imputed value is the best possible guess for the missing value, imputing a single value completely ignores the uncertainty about the unobserved value. This is where multiple imputation (MI) comes in. MI imputes not one single value, but multiple ones. This set of values represent a sample from a distribution that describes the uncertainty about the unobserved values.</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="fu">### How do the inner workings of multiple imputation look like?</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>In general, an analysis using MI involves four steps (Rubin Donald B. "Multiple imputation for nonresponse in surveys". Hoboken: Wiley; 2004.):</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>A (Bayesian) imputation model is fit to the data and $M$ samples are drawn from the posterior distribution of the model parameters given the data.</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>This imputation model could be a single model for all treatment groups without treatment group by covariate interactions, a model that has completely separate parameters for each treatment group, or a model that assumes that (some) parameters in different treatment groups are similar.</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>In a single model for all treatment groups, we can also allow for treatment by covariate interactions.</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Generally, we need to ensure that imputation model is "congenial" to the analysis model. I.e. it needs to be able to capture all the complexity present in the analysis model. It will often be more complex than the analysis model, for example it might be a model for the longitudinal data of patients over time when the analysis model is only for the final study visit, or it might separately model on- and off-treatment records for patients.</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>For each of the $M$ posterior samples $M=1,\ldots,M$ the missing data are simulated based on the sampled values from the posterior of the model parameters. What set of parameter values applies depends on the estimand of interest.</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Under a treatment policy estimand implemented using a "jump-to-reference" (J2R) approach, we would impute missing values after treatment discontinuation in all treatment groups based on placebo group parameters.</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Alternatively, we could target a treatment policy estimand by imputing missing values after treatment discontinuation in each treatment group based on parameters that describe what happens in that treatment group after treatment discontinuation (based on observed off-treatment data).</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Under a hypothetical "as-if-patients-had-been-able-to-complete-treatment" estimand, we would impute missing values for patients based on the parameters of the treatment group they were assigned to.</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>We will often use have patient specific latent random effect(s) that are used to reflect the correlation of observation from the same patient. In both of the scenarios described above, we would use the sampled values of the random effect(s) for each patients to simulate missing values for the patient. It usually computationally convenient to use latent normal random effects.</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Each of the $M$ sets of partially directly observed and partially imputed data are analyzed separately. This is done using an analysis model that need not be identical to the imputation model.</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>The results of the $M$ analyses are aggregated e.g. using Rubin's rule (Rubin Donald B. "Multiple imputation for nonresponse in surveys". Hoboken: Wiley; 2004.).</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>This all sounds pretty complicated, but it gets surprisingly easy with <span class="in">`brms`</span>. Interestingly, <span class="in">`brms`</span> let's us specify some pretty complex imputation models for a wide range of situations that would otherwise require bespoke and error-prone code e.g. in Stan. We will illustrate that in the next sections.</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a><span class="fu">### How many imputations to use?</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>While older literature suggests as few as 3 to 5, or maybe 50 imputations, there is usually some further reduction in standard errors by using a larger number of observations such as 250. Additionally, it is desirable to make our results as independent of pure play of chance in our MCMC sampling (it is just akward when the interpretation of the results may change with the choice of a random number seed). Thus, in practice we would frequently use 1000 or even 2500 imputations, as long as the added runtime is not prohibitive.</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>We will need the following R packages in this Section:</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show_packages_2e, eval=TRUE,echo=TRUE,message=FALSE,warning=FALSE}</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggrepel)</span></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a><span class="in">library(MASS)</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a><span class="in">library(emmeans)</span></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a><span class="in">library(here)</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a><span class="in"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a><span class="in">options(brms.backend="cmdstanr", cmdstanr_write_stan_file_dir=here("_brms-cache"))</span></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a><span class="in"># create cache directory if not yet available</span></span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a><span class="in">dir.create(here("_brms-cache"), FALSE)</span></span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(7894562)</span></span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a><span class="in"># we also disable normalization of the likelihood which accelerates Poisson models used</span></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a><span class="in">options(brms.normalize=FALSE)</span></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include=FALSE}</span></span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a><span class="in"># invisible to the reader we move the cache directory</span></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a><span class="in">options(cmdstanr_write_stan_file_dir=brms_cache_dir)</span></span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>Let us consider some simulated data for a trial in chronic obstructive</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>pulmonary disease (COPD). Patients are enrolled into this trial, if they</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>had at least one COPD exacerbation requiring oral corticosteroids,</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>antibiotics, emergency department visit or hospitalization, or leading</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>to death. Patients are then randomized to receive a drug or placebo and</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>followed for up to 1 year. However, some patients discontinue treatment</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>before 1 year. Some proportion of these patients agrees to be followed</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>until the end of the trial, while some proportion is lost to follow-up.</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{r generate_data}</span></span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a><span class="in">patients &lt;- 2000 # Total number of patients randomized</span></span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a><span class="in">multiple &lt;- 10 # Multiple of patients randomized to be simulated before applying inclusion criteria</span></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a><span class="in">minmum_for_inclusion &lt;- 1 # Mininum number of events in previous year for inclusion in trial</span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a><span class="in">mean_rate &lt;- 1 # Mean event rate in simulated population before applying inclusion criteria</span></span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a><span class="in">kappa &lt;- 1.5 # Dispersion parameter of simulated population</span></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a><span class="in">study_length &lt;- 1 # Length of simulated study</span></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a><span class="in">discontinuation_rate &lt;- 0.2 # Exponential rate at which patients discontinue treatment</span></span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a><span class="in">loss_proportion &lt;- 0.5 # Proportion of discontinued patients that is lost to follow-up</span></span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a><span class="in">num_imputations &lt;- 500 # number of imputations to use</span></span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(67588)</span></span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a><span class="in"># Simulate true event rates for patient population that is screened</span></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a><span class="in">patient_rates &lt;- rgamma(n=patients*multiple, shape=1/kappa, rate = 1/kappa)*mean_rate</span></span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a><span class="in"># Draw random number of events in previous year before trial</span></span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a><span class="in">previous_year &lt;- rpois(n=patients*multiple, patient_rates)</span></span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a><span class="in"># Apply inclusion criteria</span></span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a><span class="in">patient_rates &lt;- patient_rates[previous_year&gt;=minmum_for_inclusion][1:patients]</span></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a><span class="in">previous_year &lt;- previous_year[previous_year&gt;=minmum_for_inclusion][1:patients]</span></span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a><span class="in"># Simulate data for patients that met inclusion criteria</span></span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a><span class="in">count_data &lt;- tibble(patient=1:patients, </span></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a><span class="in">                    BASE = previous_year,</span></span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a><span class="in">                    treatment = ifelse(patient&lt;=patients/2, 0L, 1L),</span></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a><span class="in">                    discontinuation_time = rexp(n=patients, rate=discontinuation_rate),</span></span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a><span class="in">                    lost_to_followup = rbinom(n=patients,size=1, prob=loss_proportion),</span></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a><span class="in">                    patient_follow_up = min(study_length, discontinuation_time),</span></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a><span class="in">                    #drop_out = (drop_out_time&lt;study_length),</span></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a><span class="in">                    patient_rate = patient_rates[patient]) %&gt;%</span></span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(expand_grid(patient=1:patients,</span></span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a><span class="in">                        period=factor(1L:3L, levels=1L:3L, </span></span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a><span class="in">                                      labels=c("On-treatment", </span></span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a><span class="in">                                               "Post-treatment", </span></span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a><span class="in">                                               "Lost-to-follow-up"))), </span></span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a><span class="in">            by = "patient", multiple = "all") %&gt;%</span></span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(follow_up = case_when(</span></span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a><span class="in">    period=="On-treatment" ~ pmin(discontinuation_time, study_length),</span></span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a><span class="in">    period=="Post-treatment" ~ (1-lost_to_followup) * pmax(study_length-discontinuation_time, 0), </span></span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a><span class="in">    period=="Lost-to-follow-up" ~ lost_to_followup * pmax(study_length-discontinuation_time, 0),</span></span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a><span class="in">    TRUE ~ 1.0),</span></span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a><span class="in">    events = ifelse(period=="Lost-to-follow-up", NA_integer_,</span></span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a><span class="in">                    rpois(n=patients*3, </span></span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a><span class="in">                          lambda=follow_up*patient_rate*0.5^(treatment*(period=="On-treatment")))),</span></span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a><span class="in">    patient = factor(patient, levels=1:patients),</span></span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a><span class="in">    treatment = factor(treatment, levels=0L:1L),</span></span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a><span class="in">    logBASE = log(BASE))</span></span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a><span class="in">count_data  %&gt;% </span></span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(treatment, period) %&gt;% </span></span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(Events=sum(events), </span></span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a><span class="in">            `Patient-years`=sum(follow_up), </span></span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a><span class="in">            `Event rate (/p-y)` = Events/`Patient-years`,</span></span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a><span class="in">            `Total events prev. year` = sum(BASE),</span></span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a><span class="in">            `Rate in previous year` = mean(BASE),</span></span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a><span class="in">            .groups="drop") %&gt;%</span></span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a><span class="in">  knitr::kable(digits=2)</span></span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model description</span></span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a><span class="fu">### Negative binomial regression as a Poisson random effects model</span></span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a>Our example uses overdispersed count data that follows a negative</span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a>binomial distribution. We will use the parameterization of the negative</span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a>binomial distribution, which can be derived as a Poisson random effects</span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a>model with independent and identically distributed (i.i.d.) random</span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a>effects. These random effects follow a gamma distribution with shape</span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a>parameter $1/\kappa$ and a rate parameter $1/\kappa$ \begin{equation*}</span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a>U_i \sim \text{Gamma}(1/\kappa, 1/\kappa),</span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a>\end{equation*} where $\kappa&gt;0$. The distribution of the $Y_i$ for</span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a>patient $i=1,\ldots,N$ conditional on the random patient effect</span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a>$U_i=u_i$ and on the observed follow-up time $T_i=t_i$ is</span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a>\begin{equation}\label{eq:poissondist}</span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a>Y_i|(U_i=u_i \text{ and } T_i=t_i) \sim \text{Poisson}(\mu u_i t_i).</span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a>\end{equation} Note that as $\kappa$ approaches zero the negative</span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a>binomial distribution becomes increasingly similar to a Poisson</span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a>distribution. The <span class="in">`glm.nb`</span> in the <span class="in">`MASS`</span> R package instead uses a </span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a>parametrization in terms of $\theta := 1/\kappa$.</span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a>Thus, a negative binomial regression model is a Poisson random effects</span>
<span id="cb25-176"><a href="#cb25-176" aria-hidden="true" tabindex="-1"></a>model with a log-link function:</span>
<span id="cb25-177"><a href="#cb25-177" aria-hidden="true" tabindex="-1"></a>\begin{equation}\label{eq:Poisson_re_model}</span>
<span id="cb25-178"><a href="#cb25-178" aria-hidden="true" tabindex="-1"></a>\log E(Y_i|U_i=u_i \text{ and } T_i=t_i) = \log \mu + \log u_i + \log t_i</span>
<span id="cb25-179"><a href="#cb25-179" aria-hidden="true" tabindex="-1"></a>\end{equation} or more generally: </span>
<span id="cb25-180"><a href="#cb25-180" aria-hidden="true" tabindex="-1"></a>\begin{equation*}</span>
<span id="cb25-181"><a href="#cb25-181" aria-hidden="true" tabindex="-1"></a>\log E(Y_i|U_i=u_i \text{ and } T_i=t_i) = \boldsymbol{x_i}\boldsymbol{\beta} + \log u_i + \log t_i.</span>
<span id="cb25-182"><a href="#cb25-182" aria-hidden="true" tabindex="-1"></a>\end{equation*} </span>
<span id="cb25-183"><a href="#cb25-183" aria-hidden="true" tabindex="-1"></a>$\boldsymbol{x_i}$ is the covariate vector for</span>
<span id="cb25-184"><a href="#cb25-184" aria-hidden="true" tabindex="-1"></a>subject $i$ and $\log t_i$ is an offset variable --- i.e. a covariate</span>
<span id="cb25-185"><a href="#cb25-185" aria-hidden="true" tabindex="-1"></a>with coefficient 1. In a clinical trial setting $\boldsymbol{\beta}$</span>
<span id="cb25-186"><a href="#cb25-186" aria-hidden="true" tabindex="-1"></a>will usually consist of the coefficient for an intercept $\beta_0$,</span>
<span id="cb25-187"><a href="#cb25-187" aria-hidden="true" tabindex="-1"></a>coefficients $\beta_k$ for each test treatment group $k=1, \ldots, K$</span>
<span id="cb25-188"><a href="#cb25-188" aria-hidden="true" tabindex="-1"></a>--- these are the log-rate-ratios for each test group compared to the</span>
<span id="cb25-189"><a href="#cb25-189" aria-hidden="true" tabindex="-1"></a>control group --- and the coefficients for other covariates. Other</span>
<span id="cb25-190"><a href="#cb25-190" aria-hidden="true" tabindex="-1"></a>covariates might be e.g.\@ the logarithm of number of events in some</span>
<span id="cb25-191"><a href="#cb25-191" aria-hidden="true" tabindex="-1"></a>preceding time period.</span>
<span id="cb25-192"><a href="#cb25-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-193"><a href="#cb25-193" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extension to multiple observed time periods per patient</span></span>
<span id="cb25-194"><a href="#cb25-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-195"><a href="#cb25-195" aria-hidden="true" tabindex="-1"></a>We can extent this model to having multiple records per patient with</span>
<span id="cb25-196"><a href="#cb25-196" aria-hidden="true" tabindex="-1"></a>potentially different follow-up and covariates in each time period, with</span>
<span id="cb25-197"><a href="#cb25-197" aria-hidden="true" tabindex="-1"></a>all observations from the same patient being linked through/sharing the</span>
<span id="cb25-198"><a href="#cb25-198" aria-hidden="true" tabindex="-1"></a>same random effect $u_i$. E.g. for observation $j$ of patient $i$, we</span>
<span id="cb25-199"><a href="#cb25-199" aria-hidden="true" tabindex="-1"></a>can use \begin{equation*}</span>
<span id="cb25-200"><a href="#cb25-200" aria-hidden="true" tabindex="-1"></a>\log E(Y_{ij}|U_i=u_i \text{ and } T_{ij}=t_{ij}) = \boldsymbol{x_{ij}}\boldsymbol{\beta} + \log u_i + \log t_{ij},</span>
<span id="cb25-201"><a href="#cb25-201" aria-hidden="true" tabindex="-1"></a>\end{equation*}</span>
<span id="cb25-202"><a href="#cb25-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-203"><a href="#cb25-203" aria-hidden="true" tabindex="-1"></a>Instead of gamma-distributed random effects $\log U_i$, we will use</span>
<span id="cb25-204"><a href="#cb25-204" aria-hidden="true" tabindex="-1"></a>normally distributed random effects $\nu_i \sim N(0, \tau)$ in our</span>
<span id="cb25-205"><a href="#cb25-205" aria-hidden="true" tabindex="-1"></a>imputation model. This is computationally an easier model to fit for</span>
<span id="cb25-206"><a href="#cb25-206" aria-hidden="true" tabindex="-1"></a><span class="in">`brms`</span>. Additionally, we can approximate the distribution of a</span>
<span id="cb25-207"><a href="#cb25-207" aria-hidden="true" tabindex="-1"></a>log-transformed gamma random variable quite well with a normal</span>
<span id="cb25-208"><a href="#cb25-208" aria-hidden="true" tabindex="-1"></a>distribution.</span>
<span id="cb25-209"><a href="#cb25-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-210"><a href="#cb25-210" aria-hidden="true" tabindex="-1"></a><span class="fu">### An imputation framework for missing count data</span></span>
<span id="cb25-211"><a href="#cb25-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-212"><a href="#cb25-212" aria-hidden="true" tabindex="-1"></a>We will look at different estimands for count data that have all been</span>
<span id="cb25-213"><a href="#cb25-213" aria-hidden="true" tabindex="-1"></a>used in practice:</span>
<span id="cb25-214"><a href="#cb25-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-215"><a href="#cb25-215" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Hypothetical estimand ("as if all patients had stayed on treatment</span>
<span id="cb25-216"><a href="#cb25-216" aria-hidden="true" tabindex="-1"></a>    until the end of the trial")</span>
<span id="cb25-217"><a href="#cb25-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-218"><a href="#cb25-218" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Approach #1: Maximum likelihood estimation using a negative</span>
<span id="cb25-219"><a href="#cb25-219" aria-hidden="true" tabindex="-1"></a>        binomial regression model for the on-treatment data (discarding</span>
<span id="cb25-220"><a href="#cb25-220" aria-hidden="true" tabindex="-1"></a>        any observed off-treatment data)</span>
<span id="cb25-221"><a href="#cb25-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-222"><a href="#cb25-222" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Approach #2: Explicit imputation of off-treatment or</span>
<span id="cb25-223"><a href="#cb25-223" aria-hidden="true" tabindex="-1"></a>        lost-to-follow-up time periods based on on-treatment data.</span>
<span id="cb25-224"><a href="#cb25-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-225"><a href="#cb25-225" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>These two approaches should give almost identical results.</span>
<span id="cb25-226"><a href="#cb25-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-227"><a href="#cb25-227" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>In the second approach we fit a Bayesian imputation model on the</span>
<span id="cb25-228"><a href="#cb25-228" aria-hidden="true" tabindex="-1"></a>        on-treatment data. Then we perform prediction with this model</span>
<span id="cb25-229"><a href="#cb25-229" aria-hidden="true" tabindex="-1"></a>        (=multiple imputation) setting the treatment covariate to the</span>
<span id="cb25-230"><a href="#cb25-230" aria-hidden="true" tabindex="-1"></a>        treatment assigned as randomization for the records that need</span>
<span id="cb25-231"><a href="#cb25-231" aria-hidden="true" tabindex="-1"></a>        imputation. We will impute hypothetical on-treatment data for</span>
<span id="cb25-232"><a href="#cb25-232" aria-hidden="true" tabindex="-1"></a>        both time periods that were unobserved, but also for any</span>
<span id="cb25-233"><a href="#cb25-233" aria-hidden="true" tabindex="-1"></a>        observed post-treatment time periods.</span>
<span id="cb25-234"><a href="#cb25-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-235"><a href="#cb25-235" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Treatment policy estimand (reflecting that after treatment</span>
<span id="cb25-236"><a href="#cb25-236" aria-hidden="true" tabindex="-1"></a>    discontinuations patients are off treatment):</span>
<span id="cb25-237"><a href="#cb25-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-238"><a href="#cb25-238" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Approach #1: Imputation from observed off-treatment data</span>
<span id="cb25-239"><a href="#cb25-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-240"><a href="#cb25-240" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Approach #2: Imputation based on the control ("reference") group</span>
<span id="cb25-241"><a href="#cb25-241" aria-hidden="true" tabindex="-1"></a>        event rate ("jump-to-reference" or "J2R")</span>
<span id="cb25-242"><a href="#cb25-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-243"><a href="#cb25-243" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>In the first approach, we fit a Bayesian imputation model on the</span>
<span id="cb25-244"><a href="#cb25-244" aria-hidden="true" tabindex="-1"></a>        on-treatment and observed off-treatment data. We add a "type of</span>
<span id="cb25-245"><a href="#cb25-245" aria-hidden="true" tabindex="-1"></a>        time period" (on- or off-treatment) covariate, as well as its</span>
<span id="cb25-246"><a href="#cb25-246" aria-hidden="true" tabindex="-1"></a>        interaction with the assigned treatment group. This allows us to</span>
<span id="cb25-247"><a href="#cb25-247" aria-hidden="true" tabindex="-1"></a>        predict off-treatment records for all treatment groups based on</span>
<span id="cb25-248"><a href="#cb25-248" aria-hidden="true" tabindex="-1"></a>        the observed off-treatment data by setting the type of time</span>
<span id="cb25-249"><a href="#cb25-249" aria-hidden="true" tabindex="-1"></a>        period to "off-treatment" for the periods that we did not</span>
<span id="cb25-250"><a href="#cb25-250" aria-hidden="true" tabindex="-1"></a>        observe data for.</span>
<span id="cb25-251"><a href="#cb25-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-252"><a href="#cb25-252" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>In the second approach, we fit a Bayesian imputation model on</span>
<span id="cb25-253"><a href="#cb25-253" aria-hidden="true" tabindex="-1"></a>        the on-treatment data and impute the unobserved off-treatment</span>
<span id="cb25-254"><a href="#cb25-254" aria-hidden="true" tabindex="-1"></a>        data based on the reference group distribution (i.e. we set the</span>
<span id="cb25-255"><a href="#cb25-255" aria-hidden="true" tabindex="-1"></a>        treatment covariate to the reference group before predicting the</span>
<span id="cb25-256"><a href="#cb25-256" aria-hidden="true" tabindex="-1"></a>        unobserved data for these time periods). We do not impute the</span>
<span id="cb25-257"><a href="#cb25-257" aria-hidden="true" tabindex="-1"></a>        observed off-treatment data and include it in the data for each</span>
<span id="cb25-258"><a href="#cb25-258" aria-hidden="true" tabindex="-1"></a>        patient before the analysis of each imputed dataset.</span>
<span id="cb25-259"><a href="#cb25-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-260"><a href="#cb25-260" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Arguably the first approach is the more logical, because it</span>
<span id="cb25-261"><a href="#cb25-261" aria-hidden="true" tabindex="-1"></a>        directly uses the available evidence on what happens after</span>
<span id="cb25-262"><a href="#cb25-262" aria-hidden="true" tabindex="-1"></a>        discontinuing treatment. However, there are some difficulties.</span>
<span id="cb25-263"><a href="#cb25-263" aria-hidden="true" tabindex="-1"></a>        Firstly, there is often very little observed post-treatment data</span>
<span id="cb25-264"><a href="#cb25-264" aria-hidden="true" tabindex="-1"></a>        so that there will be a lot of uncertainty about the</span>
<span id="cb25-265"><a href="#cb25-265" aria-hidden="true" tabindex="-1"></a>        post-discontinuation event rate. Secondly, it is very</span>
<span id="cb25-266"><a href="#cb25-266" aria-hidden="true" tabindex="-1"></a>        challenging to model to what extent the event rate may change</span>
<span id="cb25-267"><a href="#cb25-267" aria-hidden="true" tabindex="-1"></a>        the more time has passed post-treatment-discontinuation (e.g. is</span>
<span id="cb25-268"><a href="#cb25-268" aria-hidden="true" tabindex="-1"></a>        there a residual treatment effect that needs to "wash-out" over</span>
<span id="cb25-269"><a href="#cb25-269" aria-hidden="true" tabindex="-1"></a>        time?) and in practice this is usually ignored.</span>
<span id="cb25-270"><a href="#cb25-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-271"><a href="#cb25-271" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementation</span></span>
<span id="cb25-272"><a href="#cb25-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-273"><a href="#cb25-273" aria-hidden="true" tabindex="-1"></a><span class="fu">### Imputation from observed off-treatment data</span></span>
<span id="cb25-274"><a href="#cb25-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-275"><a href="#cb25-275" aria-hidden="true" tabindex="-1"></a>First, let us conduct an imputation model based on the observed off-treatment</span>
<span id="cb25-276"><a href="#cb25-276" aria-hidden="true" tabindex="-1"></a>data, in which we specify that event rates can be different on- and off-treatment</span>
<span id="cb25-277"><a href="#cb25-277" aria-hidden="true" tabindex="-1"></a>for each treatment group. Using this model, we perform predictions for the </span>
<span id="cb25-278"><a href="#cb25-278" aria-hidden="true" tabindex="-1"></a>missing post-treatment values (patients lost-to-follow-up). </span>
<span id="cb25-279"><a href="#cb25-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-280"><a href="#cb25-280" aria-hidden="true" tabindex="-1"></a>We use <span class="in">`family=poisson()`</span> here, because a Poisson model with a random patient effect</span>
<span id="cb25-281"><a href="#cb25-281" aria-hidden="true" tabindex="-1"></a>on the intercept is approximately equivalent to a negative binomial regression</span>
<span id="cb25-282"><a href="#cb25-282" aria-hidden="true" tabindex="-1"></a>model and this is a way of reflecting the correlation of multiple observation</span>
<span id="cb25-283"><a href="#cb25-283" aria-hidden="true" tabindex="-1"></a>periods for a patient that is consistent with that. However, we could also make</span>
<span id="cb25-284"><a href="#cb25-284" aria-hidden="true" tabindex="-1"></a>the imputation model more complex e.g. by allowing counts to be overdispersed within</span>
<span id="cb25-285"><a href="#cb25-285" aria-hidden="true" tabindex="-1"></a>patient by using <span class="in">`family=negbinomial()`</span>, or allowing for some interactions such as</span>
<span id="cb25-286"><a href="#cb25-286" aria-hidden="true" tabindex="-1"></a><span class="in">`treatment:logBASE`</span> or <span class="in">`period:logBASE`</span>.</span>
<span id="cb25-287"><a href="#cb25-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-290"><a href="#cb25-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-291"><a href="#cb25-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit imputation model</span></span>
<span id="cb25-292"><a href="#cb25-292" aria-hidden="true" tabindex="-1"></a>brmfit1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> events <span class="sc">|</span> <span class="fu">rate</span>(follow_up) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient) <span class="sc">+</span> treatment <span class="sc">+</span> period <span class="sc">+</span> treatment<span class="sc">:</span>period <span class="sc">+</span> logBASE,</span>
<span id="cb25-293"><a href="#cb25-293" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-294"><a href="#cb25-294" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"On-treatment"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>),</span>
<span id="cb25-295"><a href="#cb25-295" aria-hidden="true" tabindex="-1"></a>               <span class="at">family=</span><span class="fu">poisson</span>(),</span>
<span id="cb25-296"><a href="#cb25-296" aria-hidden="true" tabindex="-1"></a>               <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">silent =</span> <span class="dv">0</span>)</span>
<span id="cb25-297"><a href="#cb25-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-298"><a href="#cb25-298" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions for missing (lost-to-follow-up) post-treatment values</span></span>
<span id="cb25-299"><a href="#cb25-299" aria-hidden="true" tabindex="-1"></a><span class="co"># Output format is a matrix with each column being a patient record and each row being one imputation</span></span>
<span id="cb25-300"><a href="#cb25-300" aria-hidden="true" tabindex="-1"></a>imputations1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(brmfit1, </span>
<span id="cb25-301"><a href="#cb25-301" aria-hidden="true" tabindex="-1"></a>                        <span class="at">newdata=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-302"><a href="#cb25-302" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="st">"Lost-to-follow-up"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-303"><a href="#cb25-303" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">mutate</span>(<span class="at">period=</span><span class="st">"Post-treatment"</span>),</span>
<span id="cb25-304"><a href="#cb25-304" aria-hidden="true" tabindex="-1"></a>                        <span class="at">summary =</span> F,</span>
<span id="cb25-305"><a href="#cb25-305" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ndraws =</span> num_imputations) </span>
<span id="cb25-306"><a href="#cb25-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-307"><a href="#cb25-307" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine predictions with existing data frame of lost-to-follow-up records</span></span>
<span id="cb25-308"><a href="#cb25-308" aria-hidden="true" tabindex="-1"></a><span class="co"># (results in one row per imputation per patient), then bind together with </span></span>
<span id="cb25-309"><a href="#cb25-309" aria-hidden="true" tabindex="-1"></a><span class="co"># non-missing values (on-treatment and observed off-treatment values), for</span></span>
<span id="cb25-310"><a href="#cb25-310" aria-hidden="true" tabindex="-1"></a><span class="co"># which we have one record per patient and `.imputation` will be missing.</span></span>
<span id="cb25-311"><a href="#cb25-311" aria-hidden="true" tabindex="-1"></a>imputed1 <span class="ot">&lt;-</span> count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-312"><a href="#cb25-312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="st">"Lost-to-follow-up"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-313"><a href="#cb25-313" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_number=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb25-314"><a href="#cb25-314" aria-hidden="true" tabindex="-1"></a>           <span class="at">imputed_values =</span> <span class="fu">map</span>(row_number, </span>
<span id="cb25-315"><a href="#cb25-315" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">function</span>(x) <span class="fu">tibble</span>(<span class="at">events=</span>imputations1[,x]) <span class="sc">%&gt;%</span> </span>
<span id="cb25-316"><a href="#cb25-316" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">mutate</span>(<span class="at">.imputation=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()))) <span class="sc">%&gt;%</span></span>
<span id="cb25-317"><a href="#cb25-317" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>events) <span class="sc">%&gt;%</span></span>
<span id="cb25-318"><a href="#cb25-318" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(imputed_values) <span class="sc">%&gt;%</span></span>
<span id="cb25-319"><a href="#cb25-319" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-320"><a href="#cb25-320" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"On-treatment"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> </span>
<span id="cb25-321"><a href="#cb25-321" aria-hidden="true" tabindex="-1"></a>                     follow_up<span class="sc">&gt;</span><span class="dv">0</span>))</span>
<span id="cb25-322"><a href="#cb25-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-323"><a href="#cb25-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-324"><a href="#cb25-324" aria-hidden="true" tabindex="-1"></a><span class="fu">### Imputation based on the control group event rate ("jump-to-reference")</span></span>
<span id="cb25-325"><a href="#cb25-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-326"><a href="#cb25-326" aria-hidden="true" tabindex="-1"></a>Now, we do an imputation based on control group data (i.e. assuming</span>
<span id="cb25-327"><a href="#cb25-327" aria-hidden="true" tabindex="-1"></a>that after treatment discontinuation patients are off treatment and we</span>
<span id="cb25-328"><a href="#cb25-328" aria-hidden="true" tabindex="-1"></a>use either the observed off-treatment data or impute missing data based</span>
<span id="cb25-329"><a href="#cb25-329" aria-hidden="true" tabindex="-1"></a>on the control group event rate).</span>
<span id="cb25-330"><a href="#cb25-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-331"><a href="#cb25-331" aria-hidden="true" tabindex="-1"></a>For this the code looks very similar to what we did in the previous subsection.</span>
<span id="cb25-332"><a href="#cb25-332" aria-hidden="true" tabindex="-1"></a>We just slightly change our imputation model, and now predict based on setting</span>
<span id="cb25-333"><a href="#cb25-333" aria-hidden="true" tabindex="-1"></a>the <span class="in">`period`</span> covariate to <span class="in">`"On-treatment"`</span> and the <span class="in">`treatment`</span> covariate to </span>
<span id="cb25-334"><a href="#cb25-334" aria-hidden="true" tabindex="-1"></a><span class="in">`"0"`</span> (=control group).</span>
<span id="cb25-335"><a href="#cb25-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-338"><a href="#cb25-338" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-339"><a href="#cb25-339" aria-hidden="true" tabindex="-1"></a>brmfit2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> events <span class="sc">|</span> <span class="fu">rate</span>(follow_up) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient) <span class="sc">+</span> treatment <span class="sc">+</span> logBASE,</span>
<span id="cb25-340"><a href="#cb25-340" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-341"><a href="#cb25-341" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(period<span class="sc">==</span><span class="st">"On-treatment"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>),</span>
<span id="cb25-342"><a href="#cb25-342" aria-hidden="true" tabindex="-1"></a>               <span class="at">family=</span><span class="fu">poisson</span>(),</span>
<span id="cb25-343"><a href="#cb25-343" aria-hidden="true" tabindex="-1"></a>               <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">silent =</span> <span class="dv">0</span>)</span>
<span id="cb25-344"><a href="#cb25-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-345"><a href="#cb25-345" aria-hidden="true" tabindex="-1"></a>imputations2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(brmfit2, </span>
<span id="cb25-346"><a href="#cb25-346" aria-hidden="true" tabindex="-1"></a>                        <span class="at">newdata=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-347"><a href="#cb25-347" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="st">"Lost-to-follow-up"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-348"><a href="#cb25-348" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">period=</span><span class="st">"On-treatment"</span>,</span>
<span id="cb25-349"><a href="#cb25-349" aria-hidden="true" tabindex="-1"></a>                               <span class="at">treatment=</span><span class="st">"0"</span>),</span>
<span id="cb25-350"><a href="#cb25-350" aria-hidden="true" tabindex="-1"></a>                        <span class="at">summary =</span> F,</span>
<span id="cb25-351"><a href="#cb25-351" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ndraws =</span> num_imputations) </span>
<span id="cb25-352"><a href="#cb25-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-353"><a href="#cb25-353" aria-hidden="true" tabindex="-1"></a>imputed2 <span class="ot">&lt;-</span> count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-354"><a href="#cb25-354" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="st">"Lost-to-follow-up"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-355"><a href="#cb25-355" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_number=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb25-356"><a href="#cb25-356" aria-hidden="true" tabindex="-1"></a>           <span class="at">imputed_values =</span> <span class="fu">map</span>(row_number, </span>
<span id="cb25-357"><a href="#cb25-357" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">function</span>(x) <span class="fu">tibble</span>(<span class="at">events=</span>imputations2[,x]) <span class="sc">%&gt;%</span> </span>
<span id="cb25-358"><a href="#cb25-358" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">mutate</span>(<span class="at">.imputation=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()))) <span class="sc">%&gt;%</span></span>
<span id="cb25-359"><a href="#cb25-359" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>events) <span class="sc">%&gt;%</span></span>
<span id="cb25-360"><a href="#cb25-360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(imputed_values) <span class="sc">%&gt;%</span></span>
<span id="cb25-361"><a href="#cb25-361" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-362"><a href="#cb25-362" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"On-treatment"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> </span>
<span id="cb25-363"><a href="#cb25-363" aria-hidden="true" tabindex="-1"></a>                     follow_up<span class="sc">&gt;</span><span class="dv">0</span>))</span>
<span id="cb25-364"><a href="#cb25-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-365"><a href="#cb25-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-366"><a href="#cb25-366" aria-hidden="true" tabindex="-1"></a><span class="fu">### Imputation under a hypothetical estimand</span></span>
<span id="cb25-367"><a href="#cb25-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-368"><a href="#cb25-368" aria-hidden="true" tabindex="-1"></a>Finally, we also do an imputation based on on-treatment data of the same</span>
<span id="cb25-369"><a href="#cb25-369" aria-hidden="true" tabindex="-1"></a>treatment group. I.e. we do an analysis under a hypothetical estimand</span>
<span id="cb25-370"><a href="#cb25-370" aria-hidden="true" tabindex="-1"></a>"as if all patients had finished treatment". As before, we just change our </span>
<span id="cb25-371"><a href="#cb25-371" aria-hidden="true" tabindex="-1"></a>imputation model and the covariates for the data to be imputed accordingly.</span>
<span id="cb25-372"><a href="#cb25-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-375"><a href="#cb25-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-376"><a href="#cb25-376" aria-hidden="true" tabindex="-1"></a>brmfit3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="at">formula =</span> events <span class="sc">|</span> <span class="fu">rate</span>(follow_up) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>patient) <span class="sc">+</span> treatment <span class="sc">+</span> logBASE,</span>
<span id="cb25-377"><a href="#cb25-377" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-378"><a href="#cb25-378" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(period<span class="sc">==</span><span class="st">"On-treatment"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>),</span>
<span id="cb25-379"><a href="#cb25-379" aria-hidden="true" tabindex="-1"></a>               <span class="at">family=</span><span class="fu">poisson</span>(),</span>
<span id="cb25-380"><a href="#cb25-380" aria-hidden="true" tabindex="-1"></a>               <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">silent =</span> <span class="dv">0</span>)</span>
<span id="cb25-381"><a href="#cb25-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-382"><a href="#cb25-382" aria-hidden="true" tabindex="-1"></a>imputations3 <span class="ot">&lt;-</span> <span class="fu">predict</span>(brmfit3, </span>
<span id="cb25-383"><a href="#cb25-383" aria-hidden="true" tabindex="-1"></a>                        <span class="at">newdata=</span>count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-384"><a href="#cb25-384" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lost-to-follow-up"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-385"><a href="#cb25-385" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">period=</span><span class="st">"On-treatment"</span>),</span>
<span id="cb25-386"><a href="#cb25-386" aria-hidden="true" tabindex="-1"></a>                        <span class="at">summary =</span> F,</span>
<span id="cb25-387"><a href="#cb25-387" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ndraws =</span> num_imputations) </span>
<span id="cb25-388"><a href="#cb25-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-389"><a href="#cb25-389" aria-hidden="true" tabindex="-1"></a>imputed3 <span class="ot">&lt;-</span> count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-390"><a href="#cb25-390" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(period <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Lost-to-follow-up"</span>, <span class="st">"Post-treatment"</span>) <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-391"><a href="#cb25-391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_number=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb25-392"><a href="#cb25-392" aria-hidden="true" tabindex="-1"></a>           <span class="at">imputed_values =</span> <span class="fu">map</span>(row_number, </span>
<span id="cb25-393"><a href="#cb25-393" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">function</span>(x) <span class="fu">tibble</span>(<span class="at">events=</span>imputations3[,x]) <span class="sc">%&gt;%</span> </span>
<span id="cb25-394"><a href="#cb25-394" aria-hidden="true" tabindex="-1"></a>                                            <span class="fu">mutate</span>(<span class="at">.imputation=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()))) <span class="sc">%&gt;%</span></span>
<span id="cb25-395"><a href="#cb25-395" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>events) <span class="sc">%&gt;%</span></span>
<span id="cb25-396"><a href="#cb25-396" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(imputed_values) <span class="sc">%&gt;%</span></span>
<span id="cb25-397"><a href="#cb25-397" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(count_data <span class="sc">%&gt;%</span> </span>
<span id="cb25-398"><a href="#cb25-398" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(period<span class="sc">==</span><span class="st">"On-treatment"</span> <span class="sc">&amp;</span>  follow_up<span class="sc">&gt;</span><span class="dv">0</span>))</span>
<span id="cb25-399"><a href="#cb25-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-400"><a href="#cb25-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-401"><a href="#cb25-401" aria-hidden="true" tabindex="-1"></a><span class="fu">### Combining the imputations and a quick look at them</span></span>
<span id="cb25-402"><a href="#cb25-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-403"><a href="#cb25-403" aria-hidden="true" tabindex="-1"></a>We combine the imputations from the different approaches and have a look at the </span>
<span id="cb25-404"><a href="#cb25-404" aria-hidden="true" tabindex="-1"></a>mean rates under the different imputation approaches. As you can see, assuming</span>
<span id="cb25-405"><a href="#cb25-405" aria-hidden="true" tabindex="-1"></a>a continued treatment effect results in a lower imputed mean event rate than</span>
<span id="cb25-406"><a href="#cb25-406" aria-hidden="true" tabindex="-1"></a>assuming a cessation of the treatment effect (or basing the imputation on</span>
<span id="cb25-407"><a href="#cb25-407" aria-hidden="true" tabindex="-1"></a>observed off-treatment data).</span>
<span id="cb25-408"><a href="#cb25-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-411"><a href="#cb25-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-412"><a href="#cb25-412" aria-hidden="true" tabindex="-1"></a><span class="co"># How different are the numbers?</span></span>
<span id="cb25-413"><a href="#cb25-413" aria-hidden="true" tabindex="-1"></a>imputed <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb25-414"><a href="#cb25-414" aria-hidden="true" tabindex="-1"></a>  imputed1 <span class="sc">%&gt;%</span></span>
<span id="cb25-415"><a href="#cb25-415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">"Retrieved drop-out imputation"</span>),</span>
<span id="cb25-416"><a href="#cb25-416" aria-hidden="true" tabindex="-1"></a>  imputed2 <span class="sc">%&gt;%</span></span>
<span id="cb25-417"><a href="#cb25-417" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">"Jump-to-reference (J2R)"</span>),</span>
<span id="cb25-418"><a href="#cb25-418" aria-hidden="true" tabindex="-1"></a>  imputed3 <span class="sc">%&gt;%</span></span>
<span id="cb25-419"><a href="#cb25-419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">"Hypothetical (MAR)"</span>)</span>
<span id="cb25-420"><a href="#cb25-420" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb25-421"><a href="#cb25-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-422"><a href="#cb25-422" aria-hidden="true" tabindex="-1"></a>imputed <span class="sc">%&gt;%</span></span>
<span id="cb25-423"><a href="#cb25-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Method, treatment, period, patient) <span class="sc">%&gt;%</span></span>
<span id="cb25-424"><a href="#cb25-424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">event_rate=</span><span class="fu">mean</span>(events<span class="sc">/</span>follow_up), <span class="at">.groups=</span><span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-425"><a href="#cb25-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(treatment, period, Method) <span class="sc">%&gt;%</span></span>
<span id="cb25-426"><a href="#cb25-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">event_rate=</span><span class="fu">mean</span>(event_rate), <span class="at">.groups=</span><span class="st">"drop"</span>)</span>
<span id="cb25-427"><a href="#cb25-427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-428"><a href="#cb25-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-429"><a href="#cb25-429" aria-hidden="true" tabindex="-1"></a><span class="fu">### Negative binomial regression for each imputed dataset</span></span>
<span id="cb25-430"><a href="#cb25-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-431"><a href="#cb25-431" aria-hidden="true" tabindex="-1"></a>We can now conduct an analysis of each imputed dataset and look at how</span>
<span id="cb25-432"><a href="#cb25-432" aria-hidden="true" tabindex="-1"></a>much the results vary between them. To do that, we need to fit a</span>
<span id="cb25-433"><a href="#cb25-433" aria-hidden="true" tabindex="-1"></a>negative binomial regression to each imputed dataset. Negative binomial</span>
<span id="cb25-434"><a href="#cb25-434" aria-hidden="true" tabindex="-1"></a>regression is implemented in all popular statistical software, but there are </span>
<span id="cb25-435"><a href="#cb25-435" aria-hidden="true" tabindex="-1"></a>some particular challenges. Skip the next sub-section, if you are not interested</span>
<span id="cb25-436"><a href="#cb25-436" aria-hidden="true" tabindex="-1"></a>in these particular points regarding negtive binomial regression using R.</span>
<span id="cb25-437"><a href="#cb25-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-438"><a href="#cb25-438" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Negative binomial regression in R (optional subsection)</span></span>
<span id="cb25-439"><a href="#cb25-439" aria-hidden="true" tabindex="-1"></a>For example, the </span>
<span id="cb25-440"><a href="#cb25-440" aria-hidden="true" tabindex="-1"></a>SAS/STAT\textregistered  software provides the <span class="in">`GENMOD`</span> procedure and for the Poisson random effects version the <span class="in">`COUNTREG`</span> procedure. Similarly, R has the <span class="in">`glm.nb`</span> function in the <span class="in">`MASS`</span> package. </span>
<span id="cb25-441"><a href="#cb25-441" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ~\cite{venables2002MASS}. --&gt;</span></span>
<span id="cb25-442"><a href="#cb25-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-443"><a href="#cb25-443" aria-hidden="true" tabindex="-1"></a>These implementations differ in their parameterization. The <span class="in">`GENMOD`</span> procedure estimates $\kappa$ and reverts to Poisson regression on the boundary of the parameter space when $\hat{\kappa}=0$. The <span class="in">`glm.nb`</span> function parameterizes the model in terms of $\theta:=1/\kappa$ and its algorithm will not converge to a finite estimate $\hat{\theta}$ whenever the maximum likelihood estimator for $\kappa$ is $\hat{\kappa}=0$. However, after a sufficient number of iterations $\hat{\theta}$ will be large enough that the estimates of the regression coefficients will be those we would obtain by Poisson regression --- alternatively, we can use the results from Poisson regression in this case. This is implemented in the code below.</span>
<span id="cb25-444"><a href="#cb25-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-445"><a href="#cb25-445" aria-hidden="true" tabindex="-1"></a>Instead of the preferable observed Fisher information used in the <span class="in">`GENMOD`</span> procedure, the <span class="in">`glm.nb`</span> function uses the expected Fisher information for the standard errors of the regression coefficients --- while the standard error for $\hat{\theta}$ is based on the observed rather than the expected Fisher information --- as of version 7.3-47 of the <span class="in">`MASS`</span> package. Especially for small samples sizes this may result in too small standard errors. Thus, they should --- especially for confirmatory clinical trials --- be corrected, which is easily done using <span class="co">[</span><span class="ot">code provded by Bartlett</span><span class="co">](https://stats.stackexchange.com/questions/221648/negative-binomial-regression-in-r-allowing-for-correlation-between-dispersion)</span>. </span>
<span id="cb25-446"><a href="#cb25-446" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ~\cite{lee2006general} --&gt;</span></span>
<span id="cb25-447"><a href="#cb25-447" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- % ~\cite{bartlett2016negbin}. --&gt;</span></span>
<span id="cb25-448"><a href="#cb25-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-451"><a href="#cb25-451" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-452"><a href="#cb25-452" aria-hidden="true" tabindex="-1"></a>glm.nb.cov <span class="ot">&lt;-</span> <span class="cf">function</span>(mod) {</span>
<span id="cb25-453"><a href="#cb25-453" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Basis of code for this function: </span></span>
<span id="cb25-454"><a href="#cb25-454" aria-hidden="true" tabindex="-1"></a>  <span class="co"># https://stats.stackexchange.com/questions/221648/negative-binomial-regression-in-r-allowing-for-correlation-between-dispersion</span></span>
<span id="cb25-455"><a href="#cb25-455" aria-hidden="true" tabindex="-1"></a>  <span class="co">#given a model fitted by glm.nb in MASS, this function returns a variance covariance matrix for the</span></span>
<span id="cb25-456"><a href="#cb25-456" aria-hidden="true" tabindex="-1"></a>  <span class="co">#regression coefficients and dispersion parameter, without assuming independence between these</span></span>
<span id="cb25-457"><a href="#cb25-457" aria-hidden="true" tabindex="-1"></a>  <span class="co">#note that the model must have been fitted with x=TRUE argument so that design matrix is available</span></span>
<span id="cb25-458"><a href="#cb25-458" aria-hidden="true" tabindex="-1"></a>  <span class="co">#formulae based on p23-p24 of http://pointer.esalq.usp.br/departamentos/lce/arquivos/aulas/2011/LCE5868/OverdispersionBook.pdf</span></span>
<span id="cb25-459"><a href="#cb25-459" aria-hidden="true" tabindex="-1"></a>  <span class="co">#and http://www.math.mcgill.ca/~dstephens/523/Papers/Lawless-1987-CJS.pdf</span></span>
<span id="cb25-460"><a href="#cb25-460" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-461"><a href="#cb25-461" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> mod<span class="sc">$</span>theta</span>
<span id="cb25-462"><a href="#cb25-462" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">dim</span>(<span class="fu">vcov</span>(mod))[<span class="dv">1</span>]</span>
<span id="cb25-463"><a href="#cb25-463" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-464"><a href="#cb25-464" aria-hidden="true" tabindex="-1"></a>  <span class="co">#construct observed information matrix</span></span>
<span id="cb25-465"><a href="#cb25-465" aria-hidden="true" tabindex="-1"></a>  obsInfo <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim=</span><span class="fu">c</span>(p<span class="sc">+</span><span class="dv">1</span>, p<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb25-466"><a href="#cb25-466" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-467"><a href="#cb25-467" aria-hidden="true" tabindex="-1"></a>  <span class="co">#first calculate top left part for regression coefficients</span></span>
<span id="cb25-468"><a href="#cb25-468" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb25-469"><a href="#cb25-469" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb25-470"><a href="#cb25-470" aria-hidden="true" tabindex="-1"></a>      obsInfo[i,j] <span class="ot">&lt;-</span> <span class="fu">sum</span>( (<span class="dv">1</span><span class="sc">+</span>mod<span class="sc">$</span>y<span class="sc">/</span>mod<span class="sc">$</span>theta)<span class="sc">*</span>mod<span class="sc">$</span>fitted.values<span class="sc">*</span>mod<span class="sc">$</span>x[,i]<span class="sc">*</span>mod<span class="sc">$</span>x[,j] <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span>mod<span class="sc">$</span>fitted.values<span class="sc">/</span>mod<span class="sc">$</span>theta)<span class="sc">^</span><span class="dv">2</span>  )</span>
<span id="cb25-471"><a href="#cb25-471" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-472"><a href="#cb25-472" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-473"><a href="#cb25-473" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-474"><a href="#cb25-474" aria-hidden="true" tabindex="-1"></a>  <span class="co">#information for dispersion parameter</span></span>
<span id="cb25-475"><a href="#cb25-475" aria-hidden="true" tabindex="-1"></a>  obsInfo[(p<span class="sc">+</span><span class="dv">1</span>),(p<span class="sc">+</span><span class="dv">1</span>)] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">trigamma</span>(mod<span class="sc">$</span>theta<span class="sc">+</span>mod<span class="sc">$</span>y) <span class="sc">-</span> <span class="fu">trigamma</span>(mod<span class="sc">$</span>theta) <span class="sc">-</span></span>
<span id="cb25-476"><a href="#cb25-476" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">1</span><span class="sc">/</span>(mod<span class="sc">$</span>fitted.values<span class="sc">+</span>mod<span class="sc">$</span>theta) <span class="sc">+</span> (mod<span class="sc">$</span>theta<span class="sc">+</span>mod<span class="sc">$</span>y)<span class="sc">/</span>(mod<span class="sc">$</span>theta<span class="sc">+</span>mod<span class="sc">$</span>fitted.values)<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> </span>
<span id="cb25-477"><a href="#cb25-477" aria-hidden="true" tabindex="-1"></a>                                 <span class="dv">1</span><span class="sc">/</span>(mod<span class="sc">$</span>fitted.values<span class="sc">+</span>mod<span class="sc">$</span>theta) <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>mod<span class="sc">$</span>theta)</span>
<span id="cb25-478"><a href="#cb25-478" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-479"><a href="#cb25-479" aria-hidden="true" tabindex="-1"></a>  <span class="co">#covariance between regression coefficients and dispersion</span></span>
<span id="cb25-480"><a href="#cb25-480" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb25-481"><a href="#cb25-481" aria-hidden="true" tabindex="-1"></a>    obsInfo[(p<span class="sc">+</span><span class="dv">1</span>),i] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">sum</span>(((mod<span class="sc">$</span>y<span class="sc">-</span>mod<span class="sc">$</span>fitted.values) <span class="sc">*</span> mod<span class="sc">$</span>fitted.values <span class="sc">/</span> ( (mod<span class="sc">$</span>theta<span class="sc">+</span>mod<span class="sc">$</span>fitted.values)<span class="sc">^</span><span class="dv">2</span> )) <span class="sc">*</span> mod<span class="sc">$</span>x[,i] )</span>
<span id="cb25-482"><a href="#cb25-482" aria-hidden="true" tabindex="-1"></a>    obsInfo[i,(p<span class="sc">+</span><span class="dv">1</span>)] <span class="ot">&lt;-</span> obsInfo[(p<span class="sc">+</span><span class="dv">1</span>),i]</span>
<span id="cb25-483"><a href="#cb25-483" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-484"><a href="#cb25-484" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-485"><a href="#cb25-485" aria-hidden="true" tabindex="-1"></a>  <span class="co">#return variance covariance matrix</span></span>
<span id="cb25-486"><a href="#cb25-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solve</span>(obsInfo)</span>
<span id="cb25-487"><a href="#cb25-487" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-488"><a href="#cb25-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-489"><a href="#cb25-489" aria-hidden="true" tabindex="-1"></a>fitmodel <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb25-490"><a href="#cb25-490" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function to fit NB model - returns result of Poisson model,</span></span>
<span id="cb25-491"><a href="#cb25-491" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if estimate of 1/dispersion parameter appears to go towards infinity.</span></span>
<span id="cb25-492"><a href="#cb25-492" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Additionally, standard errors are calculated using the observed</span></span>
<span id="cb25-493"><a href="#cb25-493" aria-hidden="true" tabindex="-1"></a>  <span class="co"># information matrix by calling the previously defined function for that.</span></span>
<span id="cb25-494"><a href="#cb25-494" aria-hidden="true" tabindex="-1"></a>  poifit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb25-495"><a href="#cb25-495" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb25-496"><a href="#cb25-496" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> events <span class="sc">~</span> treatment <span class="sc">+</span> logBASE <span class="sc">+</span> <span class="fu">offset</span>(logfollowup),</span>
<span id="cb25-497"><a href="#cb25-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">glm.control</span>(<span class="at">maxit =</span> <span class="dv">2500</span>),</span>
<span id="cb25-498"><a href="#cb25-498" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">poisson</span>()</span>
<span id="cb25-499"><a href="#cb25-499" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-500"><a href="#cb25-500" aria-hidden="true" tabindex="-1"></a>  <span class="co"># glm.nb may fail to converge with a message such as</span></span>
<span id="cb25-501"><a href="#cb25-501" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Warning: step size truncated due to divergence"</span></span>
<span id="cb25-502"><a href="#cb25-502" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Error in glm.fitter(X[, "(Intercept)", drop = FALSE], Y, w, offset = offset,: NA/NaN/Inf in 'x'"</span></span>
<span id="cb25-503"><a href="#cb25-503" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We need to make sure we catch that issue. In that case we set nbfit = list(theta=10001), which</span></span>
<span id="cb25-504"><a href="#cb25-504" aria-hidden="true" tabindex="-1"></a>  <span class="co"># results in Poisson regression results being used (see check on nbfit$theta later).</span></span>
<span id="cb25-505"><a href="#cb25-505" aria-hidden="true" tabindex="-1"></a>  nbfit <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb25-506"><a href="#cb25-506" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glm.nb</span>(</span>
<span id="cb25-507"><a href="#cb25-507" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> data,</span>
<span id="cb25-508"><a href="#cb25-508" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> aval <span class="sc">~</span> events <span class="sc">~</span> treatment <span class="sc">+</span> logBASE <span class="sc">+</span> <span class="fu">offset</span>(logfollowup),</span>
<span id="cb25-509"><a href="#cb25-509" aria-hidden="true" tabindex="-1"></a>        <span class="at">start =</span> poifit<span class="sc">$</span>coefficients,</span>
<span id="cb25-510"><a href="#cb25-510" aria-hidden="true" tabindex="-1"></a>        <span class="at">init.theta =</span> <span class="fl">1.25</span>,</span>
<span id="cb25-511"><a href="#cb25-511" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> <span class="fu">glm.control</span>(<span class="at">maxit =</span> <span class="dv">30</span>),</span>
<span id="cb25-512"><a href="#cb25-512" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="cn">TRUE</span></span>
<span id="cb25-513"><a href="#cb25-513" aria-hidden="true" tabindex="-1"></a>      ), <span class="at">warning =</span> <span class="cf">function</span>(err)</span>
<span id="cb25-514"><a href="#cb25-514" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">theta =</span> <span class="dv">99999</span>),</span>
<span id="cb25-515"><a href="#cb25-515" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(err)</span>
<span id="cb25-516"><a href="#cb25-516" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">theta =</span> <span class="dv">99999</span>)</span>
<span id="cb25-517"><a href="#cb25-517" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-518"><a href="#cb25-518" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-519"><a href="#cb25-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">emm_options</span>(<span class="at">msg.nesting =</span> <span class="cn">FALSE</span>,</span>
<span id="cb25-520"><a href="#cb25-520" aria-hidden="true" tabindex="-1"></a>              <span class="at">msg.interaction =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-521"><a href="#cb25-521" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (nbfit<span class="sc">$</span>theta <span class="sc">&gt;</span> <span class="dv">10000</span>) {</span>
<span id="cb25-522"><a href="#cb25-522" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb25-523"><a href="#cb25-523" aria-hidden="true" tabindex="-1"></a>      <span class="at">treatment =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>treatment)),</span>
<span id="cb25-524"><a href="#cb25-524" aria-hidden="true" tabindex="-1"></a>      <span class="at">logrr =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">summary</span>(poifit)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span>]),</span>
<span id="cb25-525"><a href="#cb25-525" aria-hidden="true" tabindex="-1"></a>      <span class="at">logrrSE =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">summary</span>(poifit)<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">2</span>]),</span>
<span id="cb25-526"><a href="#cb25-526" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="fu">summary</span>(</span>
<span id="cb25-527"><a href="#cb25-527" aria-hidden="true" tabindex="-1"></a>        <span class="fu">emmeans</span>(</span>
<span id="cb25-528"><a href="#cb25-528" aria-hidden="true" tabindex="-1"></a>          poifit,</span>
<span id="cb25-529"><a href="#cb25-529" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span> <span class="fu">factor</span>(treatment),</span>
<span id="cb25-530"><a href="#cb25-530" aria-hidden="true" tabindex="-1"></a>          <span class="at">weights =</span> <span class="st">"proportional"</span>,</span>
<span id="cb25-531"><a href="#cb25-531" aria-hidden="true" tabindex="-1"></a>          <span class="at">at =</span> <span class="fu">list</span>(<span class="at">logfollowup =</span> <span class="dv">0</span>)</span>
<span id="cb25-532"><a href="#cb25-532" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-533"><a href="#cb25-533" aria-hidden="true" tabindex="-1"></a>      ))[, <span class="fu">c</span>(<span class="st">"emmean"</span>, <span class="st">"SE"</span>)])</span>
<span id="cb25-534"><a href="#cb25-534" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-535"><a href="#cb25-535" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-536"><a href="#cb25-536" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb25-537"><a href="#cb25-537" aria-hidden="true" tabindex="-1"></a>      <span class="at">trt =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(data<span class="sc">$</span>treatment)),</span>
<span id="cb25-538"><a href="#cb25-538" aria-hidden="true" tabindex="-1"></a>      <span class="at">logrr =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">summary</span>(nbfit)<span class="sc">$</span>coefficients[<span class="dv">2</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span>]),</span>
<span id="cb25-539"><a href="#cb25-539" aria-hidden="true" tabindex="-1"></a>      <span class="at">logrrSE =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">sqrt</span>(<span class="fu">diag</span>(</span>
<span id="cb25-540"><a href="#cb25-540" aria-hidden="true" tabindex="-1"></a>        <span class="fu">glm.nb.cov</span>(nbfit)</span>
<span id="cb25-541"><a href="#cb25-541" aria-hidden="true" tabindex="-1"></a>      ))[<span class="dv">2</span><span class="sc">:</span><span class="dv">2</span>]),</span>
<span id="cb25-542"><a href="#cb25-542" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="fu">summary</span>(</span>
<span id="cb25-543"><a href="#cb25-543" aria-hidden="true" tabindex="-1"></a>        <span class="fu">emmeans</span>(</span>
<span id="cb25-544"><a href="#cb25-544" aria-hidden="true" tabindex="-1"></a>          nbfit,</span>
<span id="cb25-545"><a href="#cb25-545" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span> <span class="fu">factor</span>(treatment),</span>
<span id="cb25-546"><a href="#cb25-546" aria-hidden="true" tabindex="-1"></a>          <span class="at">weights =</span> <span class="st">"proportional"</span>,</span>
<span id="cb25-547"><a href="#cb25-547" aria-hidden="true" tabindex="-1"></a>          <span class="at">at =</span> <span class="fu">list</span>(<span class="at">logfollowup =</span> <span class="dv">0</span>),</span>
<span id="cb25-548"><a href="#cb25-548" aria-hidden="true" tabindex="-1"></a>          <span class="at">vcov =</span> <span class="fu">glm.nb.cov</span>(nbfit)[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(nbfit<span class="sc">$</span>coefficients), <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(nbfit<span class="sc">$</span>coefficients)]</span>
<span id="cb25-549"><a href="#cb25-549" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-550"><a href="#cb25-550" aria-hidden="true" tabindex="-1"></a>      ))[, <span class="fu">c</span>(<span class="st">"emmean"</span>, <span class="st">"SE"</span>)])</span>
<span id="cb25-551"><a href="#cb25-551" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-552"><a href="#cb25-552" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-553"><a href="#cb25-553" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-554"><a href="#cb25-554" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-555"><a href="#cb25-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb25-556"><a href="#cb25-556" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-557"><a href="#cb25-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span>  </span>
<span id="cb25-558"><a href="#cb25-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-559"><a href="#cb25-559" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Fitting the negative binomial regression to the imputed data</span></span>
<span id="cb25-560"><a href="#cb25-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-561"><a href="#cb25-561" aria-hidden="true" tabindex="-1"></a>Actually fitting negative binomial regression on each imputed datasets is now easy with the function above: </span>
<span id="cb25-564"><a href="#cb25-564" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-565"><a href="#cb25-565" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">.imputation =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(imputed<span class="sc">$</span>.imputation, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span></span>
<span id="cb25-566"><a href="#cb25-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">results =</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(.imputation , <span class="cf">function</span>(x)</span>
<span id="cb25-567"><a href="#cb25-567" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb25-568"><a href="#cb25-568" aria-hidden="true" tabindex="-1"></a>      imputed <span class="sc">%&gt;%</span></span>
<span id="cb25-569"><a href="#cb25-569" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(</span>
<span id="cb25-570"><a href="#cb25-570" aria-hidden="true" tabindex="-1"></a>          Method <span class="sc">==</span> <span class="st">"Hypothetical (MAR)"</span> <span class="sc">&amp;</span></span>
<span id="cb25-571"><a href="#cb25-571" aria-hidden="true" tabindex="-1"></a>            .imputation <span class="sc">%in%</span> <span class="fu">c</span>(x, <span class="cn">NA_integer_</span>)</span>
<span id="cb25-572"><a href="#cb25-572" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb25-573"><a href="#cb25-573" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(patient, treatment, BASE, logBASE, .imputation) <span class="sc">%&gt;%</span></span>
<span id="cb25-574"><a href="#cb25-574" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(</span>
<span id="cb25-575"><a href="#cb25-575" aria-hidden="true" tabindex="-1"></a>          <span class="at">logfollowup =</span> <span class="fu">log</span>(<span class="fu">sum</span>(follow_up)),</span>
<span id="cb25-576"><a href="#cb25-576" aria-hidden="true" tabindex="-1"></a>          <span class="at">events =</span> <span class="fu">sum</span>(events),</span>
<span id="cb25-577"><a href="#cb25-577" aria-hidden="true" tabindex="-1"></a>          <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb25-578"><a href="#cb25-578" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb25-579"><a href="#cb25-579" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fitmodel</span>(<span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb25-580"><a href="#cb25-580" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-581"><a href="#cb25-581" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(treatment <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-582"><a href="#cb25-582" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Hypothetical (MAR)"</span>),</span>
<span id="cb25-583"><a href="#cb25-583" aria-hidden="true" tabindex="-1"></a>      imputed <span class="sc">%&gt;%</span></span>
<span id="cb25-584"><a href="#cb25-584" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(</span>
<span id="cb25-585"><a href="#cb25-585" aria-hidden="true" tabindex="-1"></a>          Method <span class="sc">==</span> <span class="st">"Retrieved drop-out imputation"</span> <span class="sc">&amp;</span></span>
<span id="cb25-586"><a href="#cb25-586" aria-hidden="true" tabindex="-1"></a>            .imputation <span class="sc">%in%</span> <span class="fu">c</span>(x, <span class="cn">NA_integer_</span>)</span>
<span id="cb25-587"><a href="#cb25-587" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb25-588"><a href="#cb25-588" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(patient, treatment, BASE, logBASE, .imputation) <span class="sc">%&gt;%</span></span>
<span id="cb25-589"><a href="#cb25-589" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(</span>
<span id="cb25-590"><a href="#cb25-590" aria-hidden="true" tabindex="-1"></a>          <span class="at">logfollowup =</span> <span class="fu">log</span>(<span class="fu">sum</span>(follow_up)),</span>
<span id="cb25-591"><a href="#cb25-591" aria-hidden="true" tabindex="-1"></a>          <span class="at">events =</span> <span class="fu">sum</span>(events),</span>
<span id="cb25-592"><a href="#cb25-592" aria-hidden="true" tabindex="-1"></a>          <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb25-593"><a href="#cb25-593" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb25-594"><a href="#cb25-594" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fitmodel</span>(<span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb25-595"><a href="#cb25-595" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-596"><a href="#cb25-596" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(treatment <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-597"><a href="#cb25-597" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Retrieved drop-out imputation"</span>),</span>
<span id="cb25-598"><a href="#cb25-598" aria-hidden="true" tabindex="-1"></a>      imputed <span class="sc">%&gt;%</span></span>
<span id="cb25-599"><a href="#cb25-599" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(</span>
<span id="cb25-600"><a href="#cb25-600" aria-hidden="true" tabindex="-1"></a>          Method <span class="sc">==</span> <span class="st">"Jump-to-reference (J2R)"</span> <span class="sc">&amp;</span></span>
<span id="cb25-601"><a href="#cb25-601" aria-hidden="true" tabindex="-1"></a>            .imputation <span class="sc">%in%</span> <span class="fu">c</span>(x, <span class="cn">NA_integer_</span>)</span>
<span id="cb25-602"><a href="#cb25-602" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb25-603"><a href="#cb25-603" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(patient, treatment, BASE, logBASE, .imputation) <span class="sc">%&gt;%</span></span>
<span id="cb25-604"><a href="#cb25-604" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(</span>
<span id="cb25-605"><a href="#cb25-605" aria-hidden="true" tabindex="-1"></a>          <span class="at">logfollowup =</span> <span class="fu">log</span>(<span class="fu">sum</span>(follow_up)),</span>
<span id="cb25-606"><a href="#cb25-606" aria-hidden="true" tabindex="-1"></a>          <span class="at">events =</span> <span class="fu">sum</span>(events),</span>
<span id="cb25-607"><a href="#cb25-607" aria-hidden="true" tabindex="-1"></a>          <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb25-608"><a href="#cb25-608" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb25-609"><a href="#cb25-609" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fitmodel</span>(<span class="at">data =</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb25-610"><a href="#cb25-610" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-611"><a href="#cb25-611" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(treatment <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-612"><a href="#cb25-612" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Jump-to-reference (J2R)"</span>)</span>
<span id="cb25-613"><a href="#cb25-613" aria-hidden="true" tabindex="-1"></a>    ))) <span class="sc">%&gt;%</span></span>
<span id="cb25-614"><a href="#cb25-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(results)</span>
<span id="cb25-615"><a href="#cb25-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-616"><a href="#cb25-616" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb25-617"><a href="#cb25-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>logrr, <span class="at">xmin=</span>logrr<span class="sc">-</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span>logrrSE,</span>
<span id="cb25-618"><a href="#cb25-618" aria-hidden="true" tabindex="-1"></a>             <span class="at">xmax=</span>logrr<span class="sc">+</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span>logrrSE, <span class="at">y=</span>.imputation, )) <span class="sc">+</span></span>
<span id="cb25-619"><a href="#cb25-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size=</span><span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb25-620"><a href="#cb25-620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">0</span>, <span class="at">linetype=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb25-621"><a href="#cb25-621" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb25-622"><a href="#cb25-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>() <span class="sc">+</span></span>
<span id="cb25-623"><a href="#cb25-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Method) <span class="sc">+</span></span>
<span id="cb25-624"><a href="#cb25-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.9</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb25-625"><a href="#cb25-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Imputation number"</span>) <span class="sc">+</span></span>
<span id="cb25-626"><a href="#cb25-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"log-rate ratio (drug versus placebo, &lt;0 favors drug)"</span>)</span>
<span id="cb25-627"><a href="#cb25-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-628"><a href="#cb25-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-629"><a href="#cb25-629" aria-hidden="true" tabindex="-1"></a><span class="fu">### Combining the results of the analysis of each dataset using Rubin's rule</span></span>
<span id="cb25-630"><a href="#cb25-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-631"><a href="#cb25-631" aria-hidden="true" tabindex="-1"></a>Finally, we use Rubin's rule to combine results across the different</span>
<span id="cb25-632"><a href="#cb25-632" aria-hidden="true" tabindex="-1"></a>imputed datasets for each imputation method.</span>
<span id="cb25-633"><a href="#cb25-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-636"><a href="#cb25-636" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-637"><a href="#cb25-637" aria-hidden="true" tabindex="-1"></a>rubins_rule <span class="ot">&lt;-</span> <span class="cf">function</span>(estimates, SEs) {</span>
<span id="cb25-638"><a href="#cb25-638" aria-hidden="true" tabindex="-1"></a>  nmi <span class="ot">&lt;-</span> <span class="fu">length</span>(estimates)</span>
<span id="cb25-639"><a href="#cb25-639" aria-hidden="true" tabindex="-1"></a>  mi_estimate <span class="ot">&lt;-</span> <span class="fu">mean</span>(estimates)</span>
<span id="cb25-640"><a href="#cb25-640" aria-hidden="true" tabindex="-1"></a>  mi_SE <span class="ot">&lt;-</span> <span class="fu">sqrt</span>( <span class="fu">sum</span>(SEs<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>nmi <span class="sc">+</span> (<span class="dv">1</span><span class="sc">+</span><span class="dv">1</span><span class="sc">/</span>nmi) <span class="sc">*</span> <span class="fu">sum</span>((mi_estimate<span class="sc">-</span>estimates)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> (nmi<span class="dv">-1</span>) )</span>
<span id="cb25-641"><a href="#cb25-641" aria-hidden="true" tabindex="-1"></a>  mi_Z <span class="ot">&lt;-</span> mi_estimate<span class="sc">/</span>mi_SE</span>
<span id="cb25-642"><a href="#cb25-642" aria-hidden="true" tabindex="-1"></a>  mi_p <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">min</span>(<span class="fu">pnorm</span>(mi_Z), <span class="dv">1</span><span class="sc">-</span><span class="fu">pnorm</span>(mi_Z))</span>
<span id="cb25-643"><a href="#cb25-643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="fu">tibble</span>(<span class="at">logrr=</span>mi_estimate, <span class="at">logrrSE=</span>mi_SE, <span class="at">p=</span>mi_p) )</span>
<span id="cb25-644"><a href="#cb25-644" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-645"><a href="#cb25-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-646"><a href="#cb25-646" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb25-647"><a href="#cb25-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Method) <span class="sc">%&gt;%</span></span>
<span id="cb25-648"><a href="#cb25-648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do</span>(<span class="fu">rubins_rule</span>(.<span class="sc">$</span>logrr, .<span class="sc">$</span>logrrSE)) <span class="sc">%&gt;%</span></span>
<span id="cb25-649"><a href="#cb25-649" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-650"><a href="#cb25-650" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb25-651"><a href="#cb25-651" aria-hidden="true" tabindex="-1"></a>    count_data <span class="sc">%&gt;%</span></span>
<span id="cb25-652"><a href="#cb25-652" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(period<span class="sc">==</span><span class="st">"On-treatment"</span> <span class="sc">&amp;</span> follow_up<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-653"><a href="#cb25-653" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">logfollowup=</span><span class="fu">log</span>(follow_up)) <span class="sc">%&gt;%</span></span>
<span id="cb25-654"><a href="#cb25-654" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fitmodel</span>(<span class="at">data=</span>.) <span class="sc">%&gt;%</span> </span>
<span id="cb25-655"><a href="#cb25-655" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-656"><a href="#cb25-656" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(treatment<span class="sc">==</span><span class="st">"1"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-657"><a href="#cb25-657" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">"Hypothetical</span><span class="sc">\n</span><span class="st">(NegBin for on-treatment data)"</span>,</span>
<span id="cb25-658"><a href="#cb25-658" aria-hidden="true" tabindex="-1"></a>             <span class="at">p=</span><span class="dv">2</span><span class="sc">*</span><span class="fu">min</span>(<span class="fu">pnorm</span>(logrr<span class="sc">/</span>logrrSE), <span class="dv">1</span><span class="sc">-</span><span class="fu">pnorm</span>(logrr<span class="sc">/</span>logrrSE)) ) <span class="sc">%&gt;%</span></span>
<span id="cb25-659"><a href="#cb25-659" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>treatment, <span class="sc">-</span>emmean, <span class="sc">-</span>SE)</span>
<span id="cb25-660"><a href="#cb25-660" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-661"><a href="#cb25-661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">upper =</span> logrr <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span>logrrSE,</span>
<span id="cb25-662"><a href="#cb25-662" aria-hidden="true" tabindex="-1"></a>         <span class="at">lower =</span> logrr <span class="sc">-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span>logrrSE)</span>
<span id="cb25-663"><a href="#cb25-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-664"><a href="#cb25-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-665"><a href="#cb25-665" aria-hidden="true" tabindex="-1"></a><span class="fu">### What if we want to do a Bayesian analysis after MI?</span></span>
<span id="cb25-666"><a href="#cb25-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-667"><a href="#cb25-667" aria-hidden="true" tabindex="-1"></a>If we have multiple imputated datasets and wish to perform Bayesian inference, we would recommend the approach of described in the Bayesian Data Analysis book by Gelman et al. (Gelman, A., Carlin, J.B., Stern, H.S., Dunson, D.B., Vehtari, A. and Rubin, D.B., 2014. Bayesian data analysis (3rd ed.). CRC press. p.452) that uses the (equally weighted) mixture distribution of the posterior distributions as the combined posterior distribution. I.e. we use all the (or a random subset) of the MCMC samples from each analysis as samples from the combined posterior distribution. This has been reported to perform well with a sufficient number of imputations such as 100 (Zhou, X. and Reiter, J.P., 2010. A note on Bayesian inference after multiple imputation. The American Statistician, 64(2), pp.159-163.).</span>
<span id="cb25-668"><a href="#cb25-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-669"><a href="#cb25-669" aria-hidden="true" tabindex="-1"></a>We could of course write some code to fit separate Bayesian models for each imputed dataset and then combine the posterior samples, but we do not have to, because <span class="in">`brms`</span> can take care of it for us. E.g. the code below would run 1 MCMC chain for each of 20 imputed datasets (without specifying any prior distributions, which we would in practice of course also do).</span>
<span id="cb25-670"><a href="#cb25-670" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb25-671"><a href="#cb25-671" aria-hidden="true" tabindex="-1"></a><span class="in">library(future)</span></span>
<span id="cb25-672"><a href="#cb25-672" aria-hidden="true" tabindex="-1"></a><span class="in">plan(multisession)</span></span>
<span id="cb25-673"><a href="#cb25-673" aria-hidden="true" tabindex="-1"></a><span class="in">fit_multiple1 &lt;- brm_multiple(</span></span>
<span id="cb25-674"><a href="#cb25-674" aria-hidden="true" tabindex="-1"></a><span class="in">    events | rate(follow_up) ~ treatment + logBASE,</span></span>
<span id="cb25-675"><a href="#cb25-675" aria-hidden="true" tabindex="-1"></a><span class="in">    data = map(1L:20L, </span></span>
<span id="cb25-676"><a href="#cb25-676" aria-hidden="true" tabindex="-1"></a><span class="in">               function(x) imputed1 %&gt;% </span></span>
<span id="cb25-677"><a href="#cb25-677" aria-hidden="true" tabindex="-1"></a><span class="in">                 filter(is.na(.imputation) | .imputation==x) %&gt;%</span></span>
<span id="cb25-678"><a href="#cb25-678" aria-hidden="true" tabindex="-1"></a><span class="in">                 group_by(patient, logBASE, treatment) %&gt;%</span></span>
<span id="cb25-679"><a href="#cb25-679" aria-hidden="true" tabindex="-1"></a><span class="in">                 summarize(events=sum(events), follow_up=sum(follow_up))),</span></span>
<span id="cb25-680"><a href="#cb25-680" aria-hidden="true" tabindex="-1"></a><span class="in">    family = negbinomial(),</span></span>
<span id="cb25-681"><a href="#cb25-681" aria-hidden="true" tabindex="-1"></a><span class="in">    chains = 1, seed = 6234)</span></span>
<span id="cb25-682"><a href="#cb25-682" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-683"><a href="#cb25-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-684"><a href="#cb25-684" aria-hidden="true" tabindex="-1"></a><span class="fu">## Results</span></span>
<span id="cb25-685"><a href="#cb25-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-686"><a href="#cb25-686" aria-hidden="true" tabindex="-1"></a>As we can see the results from imputing explicitly "as if all patients</span>
<span id="cb25-687"><a href="#cb25-687" aria-hidden="true" tabindex="-1"></a>had finished treatment" matches the results from a negative binomial</span>
<span id="cb25-688"><a href="#cb25-688" aria-hidden="true" tabindex="-1"></a>regression of on-treatment data rather closely. Similarly, the two</span>
<span id="cb25-689"><a href="#cb25-689" aria-hidden="true" tabindex="-1"></a>approaches for treatment policy estimands (jump-to-reference or</span>
<span id="cb25-690"><a href="#cb25-690" aria-hidden="true" tabindex="-1"></a>imputation based on retrieved drop-outs) give quite similar results, but</span>
<span id="cb25-691"><a href="#cb25-691" aria-hidden="true" tabindex="-1"></a>with higher variability when basing imputations on the small number of</span>
<span id="cb25-692"><a href="#cb25-692" aria-hidden="true" tabindex="-1"></a>subjects with post-treatment-discontinuation data.</span>
<span id="cb25-693"><a href="#cb25-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-696"><a href="#cb25-696" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb25-697"><a href="#cb25-697" aria-hidden="true" tabindex="-1"></a>final_results <span class="sc">%&gt;%</span></span>
<span id="cb25-698"><a href="#cb25-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">exp</span>(logrr), <span class="at">y=</span>Method, <span class="at">xmin=</span><span class="fu">exp</span>(lower), <span class="at">xmax=</span><span class="fu">exp</span>(upper))) <span class="sc">+</span></span>
<span id="cb25-699"><a href="#cb25-699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="dv">1</span>, <span class="at">linetype=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb25-700"><a href="#cb25-700" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb25-701"><a href="#cb25-701" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(<span class="at">height=</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb25-702"><a href="#cb25-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">1.0</span>)) <span class="sc">+</span></span>
<span id="cb25-703"><a href="#cb25-703" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Rate ratio (drug vs. placebo)</span><span class="sc">\n</span><span class="st">(values &lt;1.0 favor drug over placebo)"</span>)</span>
<span id="cb25-704"><a href="#cb25-704" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-705"><a href="#cb25-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-706"><a href="#cb25-706" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb25-707"><a href="#cb25-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-708"><a href="#cb25-708" aria-hidden="true" tabindex="-1"></a>Imputation for overdispersed count data is not covered by popular alternatives for missing data imputation such as the PROC MI procedure in SAS or the <span class="in">`Amelia`</span> package in R. We are able to quickyly implement something sensible in <span class="in">`brms`</span>. For this purpose, <span class="in">`brms`</span> enabled us to fit imputation models and do imputation based on MAR (hypothetical estimand), J2R (treatment policy estimand) or retrieved drop-out data (treatment policy estimand). </span>
<span id="cb25-709"><a href="#cb25-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-710"><a href="#cb25-710" aria-hidden="true" tabindex="-1"></a>We can also fit multivariate imputation models (see the <span class="co">[</span><span class="ot">corresponding `brms` vignette</span><span class="co">](https://cran.r-project.org/web/packages/brms/vignettes/brms_multivariate.html)</span>) across different types of outcomes that could be missing and correlated. For that we would use syntax like <span class="in">`bf1 &lt;- bf(severity | subset(is_obs_severity) ~ (1|p|gr(USUBJID, by=treatment))) + cumulative()`</span>, <span class="in">`bf2 &lt;- bf(CHG1 | subset(is_obs_CHG1) ~ treatment + (1|p|gr(USUBJID, by=treatment))) + gaussian()`</span> and <span class="in">`bf9 &lt;- bf(country | subset(is_obs_country) ~ (1|p|gr(USUBJID, by=treatment))) + categorical()`</span> in combination with <span class="in">`formula = bf1 + bf2 + bf3 + set_rescor(FALSE)`</span> in our call to the <span class="in">`brm`</span> function. However, such models can be more challenging to fit and we aim to add examples on this in the future.</span>
<span id="cb25-711"><a href="#cb25-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-712"><a href="#cb25-712" aria-hidden="true" tabindex="-1"></a><span class="fu">## Excercises</span></span>
<span id="cb25-713"><a href="#cb25-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-714"><a href="#cb25-714" aria-hidden="true" tabindex="-1"></a><span class="fu">### Excercise 1: Food allergy</span></span>
<span id="cb25-715"><a href="#cb25-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-716"><a href="#cb25-716" aria-hidden="true" tabindex="-1"></a>This is example is about a simulated randomized controlled trial of a new treatment compared with placebo for peanut allergy. The primary endpoint is the result of a double-blind, placebo controlled food challenge (DBPCFC), during which patients take increasing amounts of peanut flour (1, 3, 10, 30, 100, 300, 600 and 1000 mg). Tolerating a higher amount of peaanut flour is a better outcome and the proportion of patients tolerating at least 600 mg at week 52 will be analyzed in the primary analysis. DBPCFC is performed at baseline, at week 12, 26 and 52 (1-year). The code below creates a <span class="in">`tibble`</span> with simulated data from a hypothetical study.</span>
<span id="cb25-717"><a href="#cb25-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-718"><a href="#cb25-718" aria-hidden="true" tabindex="-1"></a><span class="in">```{r food_allergy_missing}</span></span>
<span id="cb25-719"><a href="#cb25-719" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(1234)</span></span>
<span id="cb25-720"><a href="#cb25-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-721"><a href="#cb25-721" aria-hidden="true" tabindex="-1"></a><span class="in">patients = 200L</span></span>
<span id="cb25-722"><a href="#cb25-722" aria-hidden="true" tabindex="-1"></a><span class="in">amounts = c(1, 3, 10, 30, 100, 300, 600, 1000)</span></span>
<span id="cb25-723"><a href="#cb25-723" aria-hidden="true" tabindex="-1"></a><span class="in">patient_re = rnorm(patients, mean=1, sd=0.5)</span></span>
<span id="cb25-724"><a href="#cb25-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-725"><a href="#cb25-725" aria-hidden="true" tabindex="-1"></a><span class="in">simulated = expand_grid(patient=1L:patients, visit=c(0L,12L,26L,52L)) %&gt;%</span></span>
<span id="cb25-726"><a href="#cb25-726" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Treatment = 1L*(patient&gt;patients/2)) %&gt;%</span></span>
<span id="cb25-727"><a href="#cb25-727" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(patient, visit) %&gt;%</span></span>
<span id="cb25-728"><a href="#cb25-728" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(patient) %&gt;%</span></span>
<span id="cb25-729"><a href="#cb25-729" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb25-730"><a href="#cb25-730" aria-hidden="true" tabindex="-1"></a><span class="in">    discontinued = ( cumsum( (visit&gt;=12L)*rbinom(n=n(), size = 1, prob=0.2) ) &gt;=1),</span></span>
<span id="cb25-731"><a href="#cb25-731" aria-hidden="true" tabindex="-1"></a><span class="in">    lost_to_followup = ( cumsum( discontinued * rbinom(n=n(), size=1, prob=0.3) ) &gt;= 1) ,</span></span>
<span id="cb25-732"><a href="#cb25-732" aria-hidden="true" tabindex="-1"></a><span class="in">    latent = exp(rnorm(n=n(), sd=1.0) + 4.0*(visit&gt;=12L) + ((visit&gt;=12L)*2.0+(visit&gt;=26)*2.0+(visit&gt;=52)*1.0)*Treatment*(discontinued==F) + patient_re[patient]),</span></span>
<span id="cb25-733"><a href="#cb25-733" aria-hidden="true" tabindex="-1"></a><span class="in">    aval = case_when(latent&lt;1 ~ 1L,</span></span>
<span id="cb25-734"><a href="#cb25-734" aria-hidden="true" tabindex="-1"></a><span class="in">                     latent&lt;3 ~ 2L,</span></span>
<span id="cb25-735"><a href="#cb25-735" aria-hidden="true" tabindex="-1"></a><span class="in">                     latent&lt;10 ~ 3L,</span></span>
<span id="cb25-736"><a href="#cb25-736" aria-hidden="true" tabindex="-1"></a><span class="in">                     latent&lt;30 ~ 4L,</span></span>
<span id="cb25-737"><a href="#cb25-737" aria-hidden="true" tabindex="-1"></a><span class="in">                     latent&lt;100 ~ 5L,</span></span>
<span id="cb25-738"><a href="#cb25-738" aria-hidden="true" tabindex="-1"></a><span class="in">                     latent&lt;300 ~ 6L,</span></span>
<span id="cb25-739"><a href="#cb25-739" aria-hidden="true" tabindex="-1"></a><span class="in">                     latent&lt;600 ~ 7L,</span></span>
<span id="cb25-740"><a href="#cb25-740" aria-hidden="true" tabindex="-1"></a><span class="in">                     latent&lt;1000 ~ 8L,</span></span>
<span id="cb25-741"><a href="#cb25-741" aria-hidden="true" tabindex="-1"></a><span class="in">                     TRUE ~ 9L))  %&gt;%  </span></span>
<span id="cb25-742"><a href="#cb25-742" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(aval = ifelse(lost_to_followup, NA_integer_, aval)) %&gt;% </span></span>
<span id="cb25-743"><a href="#cb25-743" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;%</span></span>
<span id="cb25-744"><a href="#cb25-744" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(-latent)</span></span>
<span id="cb25-745"><a href="#cb25-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-746"><a href="#cb25-746" aria-hidden="true" tabindex="-1"></a><span class="in">model_data = simulated %&gt;%</span></span>
<span id="cb25-747"><a href="#cb25-747" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(visit&gt;0L) %&gt;%</span></span>
<span id="cb25-748"><a href="#cb25-748" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(simulated %&gt;% </span></span>
<span id="cb25-749"><a href="#cb25-749" aria-hidden="true" tabindex="-1"></a><span class="in">              filter(visit==0L) %&gt;% </span></span>
<span id="cb25-750"><a href="#cb25-750" aria-hidden="true" tabindex="-1"></a><span class="in">              mutate(base=aval) %&gt;% </span></span>
<span id="cb25-751"><a href="#cb25-751" aria-hidden="true" tabindex="-1"></a><span class="in">              dplyr::select(patient, base), </span></span>
<span id="cb25-752"><a href="#cb25-752" aria-hidden="true" tabindex="-1"></a><span class="in">            by="patient") %&gt;%</span></span>
<span id="cb25-753"><a href="#cb25-753" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Treatment = factor(Treatment, levels=0L:1L, labels=c("Placebo", "Drug")),</span></span>
<span id="cb25-754"><a href="#cb25-754" aria-hidden="true" tabindex="-1"></a><span class="in">         aval = ordered(aval, levels=1L:9L),</span></span>
<span id="cb25-755"><a href="#cb25-755" aria-hidden="true" tabindex="-1"></a><span class="in">         visit = factor(visit, levels=c(12L, 26L, 52L)))</span></span>
<span id="cb25-756"><a href="#cb25-756" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-757"><a href="#cb25-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-758"><a href="#cb25-758" aria-hidden="true" tabindex="-1"></a>Summarizing the data by treatment group and visit as a bar plot, it appears like the new drug may have a large effect on the outcome of the DBPCFC.</span>
<span id="cb25-759"><a href="#cb25-759" aria-hidden="true" tabindex="-1"></a><span class="in">```{r food_allergy_barplot}</span></span>
<span id="cb25-760"><a href="#cb25-760" aria-hidden="true" tabindex="-1"></a><span class="in">simulated %&gt;%</span></span>
<span id="cb25-761"><a href="#cb25-761" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Treatment = factor(Treatment, levels=0L:1L, labels=c("Placebo", "Drug")),</span></span>
<span id="cb25-762"><a href="#cb25-762" aria-hidden="true" tabindex="-1"></a><span class="in">         `Tolerated amount\nof peanut flour` = ordered(aval, levels=c(NA_integer_, 1L:9L),</span></span>
<span id="cb25-763"><a href="#cb25-763" aria-hidden="true" tabindex="-1"></a><span class="in">                        labels=c( "&lt; 1 mg", paste0(c(1, 3, 10, 30, 100, 300, 600, 1000), " mg"))),</span></span>
<span id="cb25-764"><a href="#cb25-764" aria-hidden="true" tabindex="-1"></a><span class="in">         visit = ordered(visit, levels=c(0L,12L,26L,52L),</span></span>
<span id="cb25-765"><a href="#cb25-765" aria-hidden="true" tabindex="-1"></a><span class="in">                         labels = paste0("Visit ", c(0,12,26,52)))) %&gt;%</span></span>
<span id="cb25-766"><a href="#cb25-766" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=Treatment, fill=`Tolerated amount\nof peanut flour`)) +</span></span>
<span id="cb25-767"><a href="#cb25-767" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_bar(col="darkgrey") +</span></span>
<span id="cb25-768"><a href="#cb25-768" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_fill_brewer(palette="PuBu", na.value="black") +</span></span>
<span id="cb25-769"><a href="#cb25-769" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~visit, nrow = 1, ncol=4) +</span></span>
<span id="cb25-770"><a href="#cb25-770" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.position="bottom") +</span></span>
<span id="cb25-771"><a href="#cb25-771" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Patients") +</span></span>
<span id="cb25-772"><a href="#cb25-772" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(legend.text=element_text(size=rel(0.5)), </span></span>
<span id="cb25-773"><a href="#cb25-773" aria-hidden="true" tabindex="-1"></a><span class="in">        legend.title = element_text(size=rel(0.5)),</span></span>
<span id="cb25-774"><a href="#cb25-774" aria-hidden="true" tabindex="-1"></a><span class="in">        legend.key.size = unit(0.2, "cm"))</span></span>
<span id="cb25-775"><a href="#cb25-775" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-776"><a href="#cb25-776" aria-hidden="true" tabindex="-1"></a>Or, as an alternative display as a spaghetti plot (note the handy <span class="in">`seed`</span> option in <span class="in">`position_jitter()`</span> to keep the line and point geoms aligned).</span>
<span id="cb25-777"><a href="#cb25-777" aria-hidden="true" tabindex="-1"></a><span class="in">```{r food_allergy_spaghetti}</span></span>
<span id="cb25-778"><a href="#cb25-778" aria-hidden="true" tabindex="-1"></a><span class="in">simulated %&gt;%</span></span>
<span id="cb25-779"><a href="#cb25-779" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(aval)) %&gt;%</span></span>
<span id="cb25-780"><a href="#cb25-780" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Treatment = factor(Treatment, levels=0L:1L, labels=c("Placebo", "Drug"))) %&gt;%</span></span>
<span id="cb25-781"><a href="#cb25-781" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=visit, y=aval, group=patient, color=Treatment)) +</span></span>
<span id="cb25-782"><a href="#cb25-782" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(alpha=0.2, position = position_jitter(width = 0.2, height=0.1, seed = 123)) +</span></span>
<span id="cb25-783"><a href="#cb25-783" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(alpha=0.2, position = position_jitter(width = 0.2, height=0.1, seed = 123)) +</span></span>
<span id="cb25-784"><a href="#cb25-784" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks=1:9, labels=c( "&lt; 1 mg", paste0(c(1, 3, 10, 30, 100, 300, 600, 1000), " mg"))) +</span></span>
<span id="cb25-785"><a href="#cb25-785" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks=c(0,12,26,52)) +</span></span>
<span id="cb25-786"><a href="#cb25-786" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~Treatment) +</span></span>
<span id="cb25-787"><a href="#cb25-787" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Time since randomization (weeks)") +</span></span>
<span id="cb25-788"><a href="#cb25-788" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Tolerated amount of peanut flour")</span></span>
<span id="cb25-789"><a href="#cb25-789" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb25-790"><a href="#cb25-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-791"><a href="#cb25-791" aria-hidden="true" tabindex="-1"></a>Excercises in increasing order of complexity (<span class="sc">\*</span> marks advanced questions):</span>
<span id="cb25-792"><a href="#cb25-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-793"><a href="#cb25-793" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Fit a simple logistic regression (i.e. <span class="in">`glm(formula = response ~ Treatment, family=binomial(link="logit"))`</span>) that uses a composite estimand treating discontinuation of treatment as equivalent to the worst response category (not tolerating 1 mg of peanut flour, i.e. <span class="in">`model_data %&gt;% filter(visit == 52L) %&gt;% mutate(aval = ifelse(is.na(aval), 1L, aval), response = 1L*(aval &gt;= 8L))`</span>). Does this support the alternative hypothesis that the new drug is better than placebo? What if we change the null hypothesis to the difference in response rate being less than 10 percentage points higher than the placebo response rate (and the alternative hypothesis to it being 10 or more percentage points better than placebo)?</span>
<span id="cb25-794"><a href="#cb25-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-795"><a href="#cb25-795" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Compare the results to imputing the ordinal outcome under a treatment policy estimand either based on the observed post-treatment data for patients that discontinued treatemnt. For this, you could use <span class="in">`family=cumulative()`</span> and <span class="in">`formula = aval ~ 1 + (1|patient) + visit*Treatment*discontinued*mo(base)`</span>. Note that <span class="in">`mo(base)`</span> implies a monotonic effect of the baseline DBPCFC outcome being higher without imposing a linear relationship. Allowing for all of the interactions we are specifying and the adjustment for baseline are examples of making an imputation model more complex than our analysis model. Perform, say, 100 imputations, perform the analysis for each imputation and combine estimates of the log-odds-ratio.</span>
<span id="cb25-796"><a href="#cb25-796" aria-hidden="true" tabindex="-1"></a>     a.  In this case, do we appear to gain much for the purposes of showing that the drug works from the more complex imputation approach?</span>
<span id="cb25-797"><a href="#cb25-797" aria-hidden="true" tabindex="-1"></a>     b.  Do you think the answer to this would change, if half of the discontinuation occurred due to the COVID-19 pandemic and we imputed post-treatment data for these patients under a hypothetical estimand (assuming patients would continue to take treatment to the end of the study)?</span>
<span id="cb25-798"><a href="#cb25-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-799"><a href="#cb25-799" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>How would you target the treatment policy estimand using the jump-to-reference approach? What would your imputation model look like and for which records would you perform the imputation?</span>
<span id="cb25-800"><a href="#cb25-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-801"><a href="#cb25-801" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span><span class="sc">\*</span> Would a linear model for log-tolerated amount of peanut flour fit the data better than the ordinal regression model we used to fit the data? For this, treat not tolerating 1 mg as being right-censored below 1 mg (<span class="in">`brms`</span> allows you to use the <span class="in">`aval | cens(censored) ~ regression formula`</span> syntax, where the variable <span class="in">`censored`</span> would contain the values <span class="in">`'none'`</span> for uncensored observations and <span class="in">`'right'`</span> for right-censored observations).</span>
<span id="cb25-802"><a href="#cb25-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-803"><a href="#cb25-803" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span><span class="sc">\*</span> Perform similar analyses as above (1-3), but use an ordinal regression model e.g. via <span class="in">`MASS::polr`</span> or <span class="co">[</span><span class="ot">`rms::orm`</span><span class="co">](https://search.r-project.org/CRAN/refmans/rms/html/orm.html)</span>.</span>
<span id="cb25-804"><a href="#cb25-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-805"><a href="#cb25-805" aria-hidden="true" tabindex="-1"></a>Further reading: Several blogposts by Frank Harrell cover proportional odds models (e.g. <span class="co">[</span><span class="ot">1</span><span class="co">](https://www.fharrell.com/post/ordinal-info/)</span>, <span class="co">[</span><span class="ot">2</span><span class="co">](https://www.fharrell.com/post/impactpo)</span>, <span class="co">[</span><span class="ot">3</span><span class="co">](https://www.fharrell.com/post/wpo/)</span> and <span class="co">[</span><span class="ot">4</span><span class="co">](https://www.fharrell.com/post/po/)</span>).</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>