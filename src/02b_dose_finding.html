<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Björn Holzhauer - bjoern.holzhauer@novartis.com">

<title>Applied Modelling in Drug Development - 8&nbsp; Dose finding</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../src/02c_dose_escalation.html" rel="next">
<link href="../src/02l_single_arm_pos.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/02_case_studies.html">Case studies</a></li><li class="breadcrumb-item"><a href="../src/02b_dose_finding.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dose finding</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../bamdd_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Applied Modelling in Drug Development</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/Novartis/bamdd/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Getting started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01a_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01b_basic_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01c_priors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Model setup &amp; priors</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../src/02_case_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Case studies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02a_meta_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Use of historical control data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02ab_meta_analysis_trtdiff.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Meta-analysis to estimate treatment effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02ac_meta_analysis_strata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Use of historical control data with stratification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02l_single_arm_pos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Probability of success from a single arm trial</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02b_dose_finding.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dose finding</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02c_dose_escalation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Oncology dose escalation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02cb_tte_dose_escalation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Time-to-event modelling in Oncology dose escalation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02e_multiple_imputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Multiple imputation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02g_longitudinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Longitudinal data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02h_mmrm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Bayesian Mixed effects Model for Repeated Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02i_time_to_event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Time-to-event data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02j_network_meta_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Network meta-analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Advanced topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03a_stan_code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Exposing stan code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03b_parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Parallel computation</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background"><span class="header-section-number">8.1</span> Background</a></li>
  <li><a href="#what-role-does-dose-response-modeling-play-in-drug-development" id="toc-what-role-does-dose-response-modeling-play-in-drug-development" class="nav-link" data-scroll-target="#what-role-does-dose-response-modeling-play-in-drug-development"><span class="header-section-number">8.2</span> What role does dose response modeling play in drug development?</a></li>
  <li><a href="#data-pathway-asthma-example" id="toc-data-pathway-asthma-example" class="nav-link" data-scroll-target="#data-pathway-asthma-example"><span class="header-section-number">8.3</span> Data: PATHWAY asthma example</a></li>
  <li><a href="#model-description" id="toc-model-description" class="nav-link" data-scroll-target="#model-description"><span class="header-section-number">8.4</span> Model description</a>
  <ul class="collapse">
  <li><a href="#the-likelihood-function-into-which-we-put-the-dose-response-model" id="toc-the-likelihood-function-into-which-we-put-the-dose-response-model" class="nav-link" data-scroll-target="#the-likelihood-function-into-which-we-put-the-dose-response-model"><span class="header-section-number">8.4.1</span> The likelihood function into which we put the dose response model</a></li>
  <li><a href="#the-sigmoid-emax-and-the-emax-model" id="toc-the-sigmoid-emax-and-the-emax-model" class="nav-link" data-scroll-target="#the-sigmoid-emax-and-the-emax-model"><span class="header-section-number">8.4.2</span> The sigmoid-Emax and the Emax model</a></li>
  <li><a href="#the-modified-beta-model" id="toc-the-modified-beta-model" class="nav-link" data-scroll-target="#the-modified-beta-model"><span class="header-section-number">8.4.3</span> The modified beta model</a></li>
  <li><a href="#exponential-model-and-linear-and-quadratic-functions-of-dose-or-log-dose" id="toc-exponential-model-and-linear-and-quadratic-functions-of-dose-or-log-dose" class="nav-link" data-scroll-target="#exponential-model-and-linear-and-quadratic-functions-of-dose-or-log-dose"><span class="header-section-number">8.4.4</span> Exponential model, and linear and quadratic functions of dose or log-dose</a></li>
  <li><a href="#bayesian-model-averaging" id="toc-bayesian-model-averaging" class="nav-link" data-scroll-target="#bayesian-model-averaging"><span class="header-section-number">8.4.5</span> Bayesian Model averaging</a></li>
  </ul></li>
  <li><a href="#implementation-and-results" id="toc-implementation-and-results" class="nav-link" data-scroll-target="#implementation-and-results"><span class="header-section-number">8.5</span> Implementation and results</a>
  <ul class="collapse">
  <li><a href="#fitting-dose-response-models-with-brms-sigmoid-emax-model" id="toc-fitting-dose-response-models-with-brms-sigmoid-emax-model" class="nav-link" data-scroll-target="#fitting-dose-response-models-with-brms-sigmoid-emax-model"><span class="header-section-number">8.5.1</span> Fitting dose response models with <code>brms</code>: sigmoid-Emax model</a></li>
  <li><a href="#fitting-dose-response-models-with-brms-modified-beta-model" id="toc-fitting-dose-response-models-with-brms-modified-beta-model" class="nav-link" data-scroll-target="#fitting-dose-response-models-with-brms-modified-beta-model"><span class="header-section-number">8.5.2</span> Fitting dose response models with <code>brms</code>: modified beta model</a></li>
  <li><a href="#perform-bayesian-model-averaging" id="toc-perform-bayesian-model-averaging" class="nav-link" data-scroll-target="#perform-bayesian-model-averaging"><span class="header-section-number">8.5.3</span> Perform Bayesian model averaging</a></li>
  <li><a href="#going-beyond-the-default-mcp-mod-models" id="toc-going-beyond-the-default-mcp-mod-models" class="nav-link" data-scroll-target="#going-beyond-the-default-mcp-mod-models"><span class="header-section-number">8.5.4</span> Going beyond the default MCP-Mod models</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">8.6</span> Conclusion</a></li>
  <li><a href="#excercises" id="toc-excercises" class="nav-link" data-scroll-target="#excercises"><span class="header-section-number">8.7</span> Excercises</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/02_case_studies.html">Case studies</a></li><li class="breadcrumb-item"><a href="../src/02b_dose_finding.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dose finding</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-dose-finding" class="quarto-section-identifier"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dose finding</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Björn Holzhauer - <a href="mailto:bjoern.holzhauer@novartis.com" class="email">bjoern.holzhauer@novartis.com</a> </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="background" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="background"><span class="header-section-number">8.1</span> Background</h2>
</section>
<section id="what-role-does-dose-response-modeling-play-in-drug-development" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="what-role-does-dose-response-modeling-play-in-drug-development"><span class="header-section-number">8.2</span> What role does dose response modeling play in drug development?</h2>
<p>In clinical drug development, one key question is what dose of a drug should be used to treat a disease. Ideally, we would want a dose that achieves (nearly) optimal efficacy, while at the same time minimizing side effects to optimize the benefit-risk balance. In many therapeutic areas the relationship between dose and efficacy is characterized in Phase IIb clinical trials that randomize patients to received either one of several doses of a drug or a matching placebo.</p>
<p>In such studies, it would be inefficient to try a lot of doses and just look at the performance of each dose in isolation. Instead, we know that biologically there should be some smooth function that describes the relationship between dose and efficacy. We can exploit this knowledge to make the analysis of such studies more efficient. There are a number of methods for analyzing such trials that exploit that the true expected difference to placebo will follow some smooth function of the dose. However, we typically do not know what smooth function best approximates the true underlying dose response function. Obvious candidate functions include monotone functions that eventually plateau, and functions that initially achieve a maximum and then decline.</p>
</section>
<section id="data-pathway-asthma-example" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="data-pathway-asthma-example"><span class="header-section-number">8.3</span> Data: PATHWAY asthma example</h2>
<p>We will use the PATHWAY trial as an example. This was a placebo-controlled randomized trial of three different tezepelumab dosing regimens compared with placebo in severe asthma. Two of the tezepelumab dosing regimens were given every 4 weeks. We will treat the third regimen of 280 mg every 2 weeks as if it had been 560 mg every 4 weeks. The primary endpoint of PATHWAY was the annualized rate of asthma exacerbations. The plot below shows the published estimates with 95% confidence intervals per dose. Many standard dose response modeling approaches do not require access to individual patient data - which in this case is not publically available -, but can be conducted given estimates and standard error for each dose.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend=</span><span class="st">"cmdstanr"</span>, <span class="at">cmdstanr_write_stan_file_dir=</span><span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># create cache directory if not yet available</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">8979476</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the PATHWAY DRF data by group</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pathway <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">dose =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">70</span>, <span class="dv">210</span>, <span class="dv">280</span><span class="sc">*</span><span class="dv">2</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">group =</span> <span class="fu">c</span>(<span class="st">"placebo"</span>, <span class="st">"tezepelumab 70 mg q4w"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"tezepelumab 210 mg q4w"</span>, <span class="st">"tezepelumab 280 mg q2w"</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">est =</span> <span class="fu">log</span>(<span class="fu">c</span>(<span class="fl">0.67</span>, <span class="fl">0.26</span>, <span class="fl">0.19</span>, <span class="fl">0.22</span>)),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">stderr =</span> <span class="fu">c</span>(<span class="fl">0.10304</span>, <span class="fl">0.17689</span>, <span class="fl">0.22217</span>, <span class="fl">0.19108</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple plot of the data</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>pathway <span class="sc">%&gt;%</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>dose, <span class="at">y=</span>est, <span class="at">label=</span><span class="fu">str_wrap</span>(group, <span class="dv">12</span>), <span class="at">col=</span>group,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">ymin=</span>est<span class="sc">-</span>stderr<span class="sc">*</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>), <span class="at">ymax=</span>est<span class="sc">+</span>stderr<span class="sc">*</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>))) <span class="sc">+</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">width=</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">log</span>(<span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="fl">0.1</span>)), <span class="at">labels=</span><span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Annualized rate (95% CI)"</span>) <span class="sc">+</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Tezepelumab dose (mg/month)"</span>) <span class="sc">+</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="at">nudge_x=</span><span class="fu">c</span>(<span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="sc">-</span><span class="dv">30</span>), <span class="at">segment.color =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/get_annualized_rates-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Or to show this as rate ratios compared with the placebo group:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the PATHWAY DRF log-rate-ratios vs. placebo</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pathway_deltas <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">dose=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">70</span>, <span class="dv">210</span>, <span class="dv">280</span><span class="sc">*</span><span class="dv">2</span>),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">group =</span> <span class="fu">c</span>(<span class="st">"reference level"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"tezepelumab 70 mg q4w vs. placebo"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"tezepelumab 210 mg q4w vs. placebo"</span>, </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"tezepelumab 280 mg q2w vs. placebo"</span>),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">logRR=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">log</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="fl">-0.61</span>, <span class="dv">1</span><span class="fl">-0.71</span>, <span class="dv">1</span><span class="fl">-0.66</span>))),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.lower90 =</span> <span class="fu">log</span>(<span class="fu">c</span>(<span class="cn">NA_real_</span>, <span class="dv">1</span><span class="fl">-0.75</span>, <span class="dv">1</span><span class="fl">-0.82</span>, <span class="dv">1</span><span class="fl">-0.79</span>)), <span class="co"># Paper reports 90% CIs</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.upper90 =</span> <span class="fu">log</span>(<span class="fu">c</span>(<span class="cn">NA_real_</span>, <span class="dv">1</span><span class="fl">-0.39</span>, <span class="dv">1</span><span class="fl">-0.53</span>, <span class="dv">1</span><span class="fl">-0.47</span>)),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stderr =</span> (.upper90<span class="sc">-</span>.lower90)<span class="sc">/</span><span class="dv">2</span><span class="sc">/</span><span class="fu">qnorm</span>(<span class="fl">0.95</span>),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.lower =</span> logRR<span class="sc">-</span>stderr<span class="sc">*</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>), <span class="co"># Get 95% CIs</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                        <span class="at">.upper =</span> logRR<span class="sc">+</span>stderr<span class="sc">*</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot log-rate ratios</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>pathway_deltas <span class="sc">%&gt;%</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>dose, <span class="at">y=</span>logRR, </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">label=</span><span class="fu">str_wrap</span>(group, <span class="dv">12</span>), <span class="at">col=</span>group,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">ymin=</span>.lower, <span class="at">ymax=</span>.upper)) <span class="sc">+</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">width=</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_errorbar(width=10, aes(ymin=.lower90, ymax=.upper90)) +</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">log</span>(<span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="fl">0.1</span>)), <span class="at">labels=</span><span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">600</span>)) <span class="sc">+</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Exacerbation rate ratio (95% CI)"</span>) <span class="sc">+</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Tezepelumab dose (mg/month)"</span>) <span class="sc">+</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="at">nudge_x=</span><span class="fu">c</span>(<span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="sc">-</span><span class="dv">30</span>), <span class="at">nudge_y=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.15</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>                  <span class="at">segment.color =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/get_pathway_deltas-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-description" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="model-description"><span class="header-section-number">8.4</span> Model description</h2>
<p>To conduct dose response analyses under model uncertainty a number of approaches such as the <a href="https://doi.org/10.1002/sim.3802">Multiple Comparison Procedures and Modeling (MCP-Mod)</a>, the <a href="https://doi.org/10.1002/sim.6052">generalized MCP-Mod approach</a> and Gaussian process based approaches are popular. Within the generalized MCP-Mod framework <a href="https://doi.org/10.1002/pst.1671">model averaging is an attractive approach</a> for dealing with model uncertainty that has <a href="https://doi.org/10.1002/sim.6991">performed well in simulation studies</a>. Here, we take a Bayesian approach to model averaging in the MCP-Mod framework, which <a href="https://doi.org/10.1002/bimj.201700211">Gould (2018)</a> called BMA-Mod (BMA stands for Bayesian model averaging).</p>
<p>While more complex mechanistic pharmacokinetic/pharmacodynamic (PK/PD) models are often important, here, we discuss directly modelling the relationship between dose and some clinical outcome in patients.</p>
<p>BMA-Mod, just as MCP-Mod, uses a set of candidate models that might describe dose response relationships. In the subsections that follow, we describe each model.</p>
<section id="the-likelihood-function-into-which-we-put-the-dose-response-model" class="level3" data-number="8.4.1">
<h3 data-number="8.4.1" class="anchored" data-anchor-id="the-likelihood-function-into-which-we-put-the-dose-response-model"><span class="header-section-number">8.4.1</span> The likelihood function into which we put the dose response model</h3>
<p>No matter whether we use summary data consiting of estimates with standard errors with each treatment group, or whether we have individual patient data (IPD) for a continuous, binary, count, time-to-event or ordinal outcome, our regression model will be one of the dose response models we will describe in the subsequent sections.</p>
<p>What will differ is the likelihood function, into which we insert the dose response function. In the PATHWAY example, we will use that the estimates for log-mean-event-rate for each dose level <span class="math inline">\(i=1,\ldots,I\)</span> are approximately indpendent with <span class="math inline">\(\hat{\theta}_i \sim N(\theta_i, \text{SE}(\hat{\theta}_i))\)</span> distributions. Thus, we can use a Gaussian likelihood with known standard deviation. In case of IPD, we would instead use suitable IPD-likelihoods. This only requires minimal changes in the code for the examples.</p>
</section>
<section id="the-sigmoid-emax-and-the-emax-model" class="level3" data-number="8.4.2">
<h3 data-number="8.4.2" class="anchored" data-anchor-id="the-sigmoid-emax-and-the-emax-model"><span class="header-section-number">8.4.2</span> The sigmoid-Emax and the Emax model</h3>
<p>A very popular dose response model is the <strong>sigmoid-Emax model</strong>. This model assumes that the outcome for each dose group can be described by a function of the form <span class="math display">\[f(\text{dose}; \text{parameters}) = \text{E}_0 + \text{E}_\text{max} \times \frac{\text{dose}^h}{\text{dose}^h + \text{ED}_{50}^h}.\]</span> This is a monotone curve that starts at no difference to placebo at dose 0 (the expected placebo response is <span class="math inline">\(\text{E}_0\)</span>) and plateaus at a maximum effect of size <span class="math inline">\(\text{E}_\text{max} \in (-\infty, \infty)\)</span>. 50% of the maximum effect is reached at the dose <span class="math inline">\(\text{ED}_{50} \in (0, \infty)\)</span>. The steepness of the curve is determined by the so-called Hill parameter <span class="math inline">\(h \in (0, \infty)\)</span>. For <span class="math inline">\(h=1\)</span>, we have the simple <strong>Emax model</strong>, for <span class="math inline">\(h&gt;1\)</span> the dose response curve is steeper around <span class="math inline">\(\text{ED}_{50}\)</span> (and plateaus faster) than for a simple Emax model, while for <span class="math inline">\(h&lt;1\)</span> the curve is less steep. Typical values of <span class="math inline">\(h\)</span> are smaller than 5 and usually at most 3, so assigning a prior that puts most of the prior weight for <span class="math inline">\(\log h\)</span> between <span class="math inline">\(-\log 5\)</span> and <span class="math inline">\(\log 5\)</span> makes sense.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/sigemax_plots-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The Emax model is a simple model with some biological plausibility. It is the equation that results from assuming the drug concentrations at the site of drug action are proportional to the administered dose, that drug binds to and unbinds from a receptor at a rate proportional to the drug concentration, and that drugs effects are proportional to receptor occupancy. And, it assumes that all these relationships are exactly the same for all patients. All of these assumptions can be relaxed/avoided when individual patient data (and even better, if also the necessary data for PK/PD modeling) are available.</p>
</section>
<section id="the-modified-beta-model" class="level3" data-number="8.4.3">
<h3 data-number="8.4.3" class="anchored" data-anchor-id="the-modified-beta-model"><span class="header-section-number">8.4.3</span> The modified beta model</h3>
<p>Another possible dose response model is the modified beta model. <span class="math display">\[f(\text{dose}; \text{parameters}) = \text{E}_0 + \text{E}_{\text{max }2} \times \frac{(\delta_1 + \delta_2)^{\delta_1 + \delta_2}}{\delta_1^{\delta_1} + \delta_2^{\delta_2}} \times (\frac{\text{dose}}{S})^{\delta_1} \times (1-\frac{\text{dose}}{S})^{\delta_2}\]</span> This model is capable of describing a non-monotone dose response.</p>
</section>
<section id="exponential-model-and-linear-and-quadratic-functions-of-dose-or-log-dose" class="level3" data-number="8.4.4">
<h3 data-number="8.4.4" class="anchored" data-anchor-id="exponential-model-and-linear-and-quadratic-functions-of-dose-or-log-dose"><span class="header-section-number">8.4.4</span> Exponential model, and linear and quadratic functions of dose or log-dose</h3>
<p>The exponential model <span class="math display">\[f(\text{dose}; \text{parameters}) = b_1 + b_2 (\exp(b_3 \times \text{dose})-1)\]</span> with <span class="math inline">\(b_3&lt;0\)</span> was also discussed by <a href="https://doi.org/10.1002/bimj.201700211">Gould</a>.</p>
<p><a href="https://doi.org/10.1002/bimj.201700211">Gould</a> also considered linear and quadratic functions of dose or log-dose. I.e. <span class="math display">\[f(\text{dose}; \text{parameters}) = \text{E}_0 + \beta \times \text{dose},\]</span> <span class="math display">\[f(\text{dose}; \text{parameters}) = \text{E}_0 + \beta \times \log (\text{dose}),\]</span> <span class="math display">\[f(\text{dose}; \text{parameters}) = \text{E}_0 + \beta_1 \times \text{dose} + \beta_2 \times \text{dose}^2\]</span> or <span class="math display">\[f(\text{dose}; \text{parameters}) = \text{E}_0 + \beta_1 \times \log (\text{dose}) + \beta_2 \times (\log (\text{dose}))^2.\]</span> These models are perhaps better suited towards modeling the dose-response relationship within the range of tested dose and would not necessarily be expected to extrapolate well beyond the data range. Nevertheless, they may be useful for providing a more flexible set of models.</p>
</section>
<section id="bayesian-model-averaging" class="level3" data-number="8.4.5">
<h3 data-number="8.4.5" class="anchored" data-anchor-id="bayesian-model-averaging"><span class="header-section-number">8.4.5</span> Bayesian Model averaging</h3>
<p>If we have multiple models that are similarly plausible given our prior information and the data we observed, then picking a single model out of these ignores the model uncertainty. For this reason, model averaging is known to be a good approach for dealing with model uncertainty. It assigns greater weight to more plausible models and can - given enough evidence - give all weight to a single clearly best model (and also give near-zero weight to clearly inappropriate models). So, - given enough data - it effectively results in model selection, but as long as we only have limited information multiple models will contribute to our inference.</p>
<p><a href="https://doi.org/10.1002/bimj.201700211">Gould</a> proposes to use a weighted combination of the predictions for each dose level from each of the candidate models and suggests to base the posterior model weigths on <a href="https://doi.org/10.1016/j.ijforecast.2009.08.001">predictive likelihood weights</a>.</p>
</section>
</section>
<section id="implementation-and-results" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="implementation-and-results"><span class="header-section-number">8.5</span> Implementation and results</h2>
<p>We will now fit the various dose response models introduced in the statistical model section using <code>brms</code>. We will start with the sigmoid-Emax model and look at the things <code>brms</code> let us do easily with a single fitted model. We will not repeat that level of exploration for other models, but you may wish to do so in practice.</p>
<section id="fitting-dose-response-models-with-brms-sigmoid-emax-model" class="level3" data-number="8.5.1">
<h3 data-number="8.5.1" class="anchored" data-anchor-id="fitting-dose-response-models-with-brms-sigmoid-emax-model"><span class="header-section-number">8.5.1</span> Fitting dose response models with <code>brms</code>: sigmoid-Emax model</h3>
<p>We use the capabilities of <code>brms</code> for fitting non-linear models. For example, a sigmoid-Emax model can be fitted as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a sigmoid Emax model</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>brmfit1 <span class="ot">&lt;-</span>  <span class="fu">brm</span>( <span class="fu">bf</span>( est <span class="sc">|</span> <span class="fu">se</span>(stderr) <span class="sc">~</span> E0 <span class="sc">+</span> Emax <span class="sc">*</span> dose<span class="sc">^</span>h<span class="sc">/</span>(dose<span class="sc">^</span>h <span class="sc">+</span> ED50<span class="sc">^</span>h),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">nlf</span>(h <span class="sc">~</span> <span class="fu">exp</span>(logh)), <span class="fu">nlf</span>(ED50 <span class="sc">~</span> <span class="fu">exp</span>(logED50)),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                    E0 <span class="sc">~</span> <span class="dv">1</span>, logED50 <span class="sc">~</span> <span class="dv">1</span>, logh <span class="sc">~</span> <span class="dv">1</span>, Emax <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">nl=</span><span class="cn">TRUE</span>, <span class="at">family=</span><span class="fu">gaussian</span>()),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">data=</span>pathway,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"E0"</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"logh"</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"Emax"</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="at">nlpar=</span><span class="st">"logED50"</span>)),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.999</span>),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">seed=</span><span class="dv">3624</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that with individual patient data, we would not write <code>est | se(stderr) ~</code>, but would instead use <code>outcome ~</code> and <code>bf() + negbinomial()</code> (and similarly, e.g.&nbsp;<code>+ gaussian()</code> for continuous data). With the settings above, you might still experience a divergent transition or two and you may wish to increase <code>adapt_delta</code> to <code>0.9999</code> or <code>0.99999</code>, or alternatively try to come up with a way to reparameterize the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize model fit</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(brmfit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 1 divergent transitions after warmup. Increasing
adapt_delta above 0.999 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: est | se(stderr) ~ E0 + Emax * dose^h/(dose^h + ED50^h) 
         h ~ exp(logh)
         ED50 ~ exp(logED50)
         E0 ~ 1
         logED50 ~ 1
         logh ~ 1
         Emax ~ 1
   Data: pathway (Number of observations: 4) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
E0_Intercept         -0.42      0.10    -0.61    -0.21 1.00     2050     2044
logED50_Intercept     2.73      1.29    -0.10     4.99 1.00     1251     1246
logh_Intercept        0.00      0.95    -1.82     1.85 1.00     1397     1605
Emax_Intercept       -1.28      0.30    -2.05    -0.83 1.00     1502     1168

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     0.00      0.00     0.00     0.00   NA       NA       NA

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>So what does the model fit look like? We have two options for looking at this. The easiest and fastest uses the <code>conditional_effects</code> function from <code>brms</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">conditional_effects</span>(brmfit1, <span class="st">"dose"</span>), </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">points =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The downside is that in a controlled trial we are primarily interested in the contrast with placebo and that we would like to see the confidence intervals around the point estimates for each dose. We can obtain that with a little bit more code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We are going to predict the annualized rate for all doses from 0,1,2,...600.</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We are setting stderr=0 to avoid predicting with sampling variability.</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>dr_curve_data <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">dose=</span><span class="fu">as.integer</span>(<span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">600</span>)), <span class="at">stderr=</span><span class="dv">0</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we get the predictions and turn this into a dataset with one row per dose per MCMC sample</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>dr_curve_pred <span class="ot">&lt;-</span> tidybayes<span class="sc">::</span><span class="fu">add_predicted_draws</span>(dr_curve_data, brmfit1) <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(dose, <span class="at">.sample =</span> .draw, <span class="at">pred =</span> .prediction)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we get the rate ratio by subtracting the annualized placebo rate for each MCMC sample  </span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>dr_curve_pred <span class="ot">=</span> dr_curve_pred <span class="sc">%&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dr_curve_pred  <span class="sc">%&gt;%</span> </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(dose<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dose) <span class="sc">%&gt;%</span> </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename</span>(<span class="at">placebo=</span>pred), </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">".sample"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">logRR =</span> pred <span class="sc">-</span> placebo) <span class="sc">%&gt;%</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(dose, .sample, logRR)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we get median prediction, 50 and 95% credible intervals </span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># and plot those with the original data overlaid.</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> dr_curve_pred  <span class="sc">%&gt;%</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>.sample) <span class="sc">%&gt;%</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dose) <span class="sc">%&gt;%</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>(<span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>dose, <span class="at">y=</span>logRR, <span class="at">ymin=</span>.lower, <span class="at">ymax=</span>.upper)) <span class="sc">+</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>)  <span class="sc">+</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.95</span>), <span class="at">fill=</span><span class="st">"red"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.5</span>), <span class="at">fill=</span><span class="st">"red"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.5</span>), <span class="at">col=</span><span class="st">"darkred"</span>) <span class="sc">+</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>pathway_deltas) <span class="sc">+</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>pathway_deltas, <span class="at">width=</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span><span class="fu">tibble</span>(<span class="at">dose=</span><span class="dv">300</span>, <span class="at">logRR=</span><span class="fu">log</span>(<span class="fl">0.6</span>), <span class="at">.lower=</span><span class="cn">NA_real_</span>, <span class="at">.upper=</span><span class="cn">NA_real_</span>),</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label=</span><span class="st">"SigMod Emax model fit"</span>), <span class="at">col=</span><span class="st">"darkred"</span>, <span class="at">size=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">log</span>(<span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">paste</span>(<span class="dv">100</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), <span class="st">"%"</span>)) <span class="sc">+</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Relative rate reduction"</span>) <span class="sc">+</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Total tezepelumab dose [mg/month]"</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/predict_sigemax-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also plot the dose response curve for each MCMC sample:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a> dr_curve_pred  <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>dose, <span class="at">y=</span>logRR, <span class="at">group=</span><span class="fu">factor</span>(.sample))) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>)  <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">col=</span><span class="st">"darkred"</span>, <span class="at">alpha=</span><span class="fl">0.1</span>, <span class="at">size=</span><span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>pathway_deltas <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">.sample=</span><span class="cn">NA_integer_</span>)) <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>pathway_deltas <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">.sample=</span><span class="cn">NA_integer_</span>), </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">ymin=</span>.lower, <span class="at">ymax=</span>.upper), <span class="at">width=</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">log</span>(<span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">paste</span>(<span class="dv">100</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), <span class="st">"%"</span>)) <span class="sc">+</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Relative rate reduction"</span>) <span class="sc">+</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Total tezepelumab dose [mg/month]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/plot_each_curve-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note, that this also makes it really easy to determine a distribution for the lowest dose that achieves a 50% relative rate reduction:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>dr_curve_pred  <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(logRR<span class="sc">&lt;</span><span class="fu">log</span>(<span class="fl">0.5</span>) <span class="sc">|</span> (logRR<span class="sc">&gt;=</span><span class="fu">log</span>(<span class="fl">0.5</span>) <span class="sc">&amp;</span> dose<span class="sc">==</span><span class="dv">600</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(.sample) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">dose =</span> <span class="fu">min</span>(dose), <span class="at">logRR=</span><span class="fu">max</span>(logRR)) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Has 50% RRR</span><span class="st">`</span><span class="ot">=</span>(logRR<span class="sc">&lt;</span><span class="fu">log</span>(<span class="fl">0.5</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>dose, <span class="at">y=</span><span class="st">"Dose with</span><span class="sc">\n</span><span class="st">&gt;50% RRR"</span>)) <span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>() <span class="sc">+</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">200</span>)) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Tezepelumab dose [mg/month]"</span>) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/plot_dose_with_50rrr-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As the plot below shows the data resulted in a substantially different posterior distribution compared with the prior distribution for the <code>logED50</code> parameter and the <code>Emax</code> parameter. These parameters are reasonably well-identified even with just 3 doses - although the ED50 would be better estimated, if doses with approximately 50% of the Emax (maximum relative rate reduction) had been included in the study. In contrast, the log-Hill-parameter is poorly identified, when there are very few doses (as in this study), which is why the posterior distribution is more or less the prior distribution for the <code>logED50</code> parameter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>brmfit1 <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread_draws</span>(b_logED50_Intercept, b_logh_Intercept, b_Emax_Intercept) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">"b_logED50_Intercept"</span>, <span class="st">"b_logh_Intercept"</span>, <span class="st">"b_Emax_Intercept"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>value)) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size=</span><span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span><span class="fu">tibble</span>(<span class="at">name=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"b_logED50_Intercept"</span>,<span class="dv">151</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">rep</span>(<span class="st">"b_logh_Intercept"</span>,<span class="dv">71</span>),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">rep</span>(<span class="st">"b_Emax_Intercept"</span>,<span class="dv">61</span>)),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">xval =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">10</span>,<span class="fl">0.1</span>),</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">4</span>,<span class="fl">0.1</span>),</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.1</span>)),</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">density=</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">case_when</span>(<span class="fu">str_detect</span>(name,<span class="st">"ED50"</span>) <span class="sc">~</span> <span class="fu">dnorm</span>(xval,<span class="at">mean=</span><span class="dv">4</span>,<span class="at">sd=</span><span class="dv">2</span>),</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                                    <span class="fu">str_detect</span>(name,<span class="st">"logh"</span>) <span class="sc">~</span>  <span class="fu">dnorm</span>(xval,<span class="at">mean=</span><span class="dv">0</span>,<span class="at">sd=</span><span class="dv">1</span>),</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                                    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">dnorm</span>(xval,<span class="at">mean=</span><span class="dv">0</span>,<span class="at">sd=</span><span class="dv">1</span>))),</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x=</span>xval, <span class="at">y=</span>density), <span class="at">col=</span><span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span><span class="fu">tibble</span>(<span class="at">name=</span><span class="st">"b_Emax_Intercept"</span>, <span class="at">density=</span><span class="fl">0.6</span>, <span class="at">xval=</span><span class="dv">1</span>),</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x=</span>xval, <span class="at">y=</span>density, <span class="at">label=</span><span class="st">"prior"</span>), <span class="at">col=</span><span class="st">"red"</span>, <span class="at">size=</span><span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span><span class="fu">tibble</span>(<span class="at">name=</span><span class="st">"b_Emax_Intercept"</span>, <span class="at">density=</span><span class="dv">1</span>, <span class="at">xval=</span><span class="fl">0.5</span>),</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x=</span>xval, <span class="at">y=</span>density, <span class="at">label=</span><span class="st">"posterior"</span>), <span class="at">col=</span><span class="st">"black"</span>, <span class="at">size=</span><span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/paramident-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fitting-dose-response-models-with-brms-modified-beta-model" class="level3" data-number="8.5.2">
<h3 data-number="8.5.2" class="anchored" data-anchor-id="fitting-dose-response-models-with-brms-modified-beta-model"><span class="header-section-number">8.5.2</span> Fitting dose response models with <code>brms</code>: modified beta model</h3>
<p>We now fit the modified beta model that can capture non-monotone dose response relationships.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Try a modified beta model</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>brmfit2 <span class="ot">&lt;-</span>  <span class="fu">brm</span>( <span class="fu">bf</span>( est <span class="sc">|</span> <span class="fu">se</span>(stderr) <span class="sc">~</span> E0 <span class="sc">+</span> Emax<span class="sc">*</span>(delta1<span class="sc">+</span>delta2)<span class="sc">^</span>(delta1<span class="sc">+</span>delta2)<span class="sc">/</span>(delta1<span class="sc">^</span>delta1<span class="sc">*</span>delta2<span class="sc">^</span>delta2)<span class="sc">*</span>(dose<span class="sc">/</span><span class="dv">850</span>)<span class="sc">^</span>delta1<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>dose<span class="sc">/</span><span class="dv">850</span>)<span class="sc">^</span>delta2,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                   E0 <span class="sc">~</span> <span class="dv">1</span>, delta1 <span class="sc">~</span> <span class="dv">1</span>, delta2 <span class="sc">~</span> <span class="dv">1</span>, Emax <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nl=</span><span class="cn">TRUE</span>, </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">family =</span> <span class="fu">gaussian</span>()),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>pathway,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"E0"</span>),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"Emax"</span>),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"delta1"</span>, <span class="at">lb=</span><span class="dv">0</span>),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"delta2"</span>, <span class="at">lb=</span><span class="dv">0</span>)),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.999</span>),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">save_pars =</span> <span class="fu">save_pars</span>(<span class="at">all =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">seed =</span> <span class="dv">7304</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us summarize the model fit:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(brmfit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: est | se(stderr) ~ E0 + Emax * (delta1 + delta2)^(delta1 + delta2)/(delta1^delta1 * delta2^delta2) * (dose/850)^delta1 * (1 - dose/850)^delta2 
         E0 ~ 1
         delta1 ~ 1
         delta2 ~ 1
         Emax ~ 1
   Data: pathway (Number of observations: 4) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
E0_Intercept        -0.43      0.10    -0.63    -0.23 1.00     1535     2122
delta1_Intercept     0.45      0.22     0.13     0.98 1.00     1303     1812
delta2_Intercept     0.75      0.42     0.16     1.75 1.00     1304     1577
Emax_Intercept      -1.30      0.21    -1.73    -0.90 1.00     1640     1769

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     0.00      0.00     0.00     0.00   NA       NA       NA

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>So what does the model fit look like? We could, again, just use <code>plot(conditional_effects(brmfit2, "dose"), points = TRUE)</code> or get a slightly more tailored plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we get the predictions and turn this into a dataset with one row per dose per MCMC sample</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>dr_curve_pred2 <span class="ot">&lt;-</span> tidybayes<span class="sc">::</span><span class="fu">add_predicted_draws</span>(dr_curve_data, brmfit2) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(dose, <span class="at">.sample =</span> .draw, <span class="at">pred =</span> .prediction)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we get the rate ratio by subtracting the annualized placebo rate for each MCMC sample  </span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>dr_curve_pred2 <span class="ot">=</span> dr_curve_pred2 <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dr_curve_pred2  <span class="sc">%&gt;%</span> </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(dose<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dose) <span class="sc">%&gt;%</span> </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename</span>(<span class="at">placebo=</span>pred), </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">".sample"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">logRR =</span> pred <span class="sc">-</span> placebo) <span class="sc">%&gt;%</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(dose, .sample, logRR)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we get median prediction, 50 and 95% credible intervals </span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># and plot those with the original data overlaid.</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> dr_curve_pred2  <span class="sc">%&gt;%</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>.sample) <span class="sc">%&gt;%</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dose) <span class="sc">%&gt;%</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>(<span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>dose, <span class="at">y=</span>logRR, <span class="at">ymin=</span>.lower, <span class="at">ymax=</span>.upper)) <span class="sc">+</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>)  <span class="sc">+</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.95</span>), <span class="at">fill=</span><span class="st">"royalblue"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.5</span>), <span class="at">fill=</span><span class="st">"royalblue"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.5</span>), <span class="at">col=</span><span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>pathway_deltas) <span class="sc">+</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>pathway_deltas, <span class="at">width=</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span><span class="fu">tibble</span>(<span class="at">dose=</span><span class="dv">300</span>, <span class="at">logRR=</span><span class="fu">log</span>(<span class="fl">0.6</span>), <span class="at">.lower=</span><span class="cn">NA_real_</span>, <span class="at">.upper=</span><span class="cn">NA_real_</span>),</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label=</span><span class="st">"modified-beta model fit"</span>), <span class="at">col=</span><span class="st">"darkblue"</span>, <span class="at">size=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">log</span>(<span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), </span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">paste</span>(<span class="dv">100</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), <span class="st">"%"</span>)) <span class="sc">+</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Relative rate reduction"</span>) <span class="sc">+</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Total tezepelumab dose [mg/month]"</span>)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/predict_modbeta-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="perform-bayesian-model-averaging" class="level3" data-number="8.5.3">
<h3 data-number="8.5.3" class="anchored" data-anchor-id="perform-bayesian-model-averaging"><span class="header-section-number">8.5.3</span> Perform Bayesian model averaging</h3>
<p>Now we have two fitted model. We can see both of them together below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/show_both_plots-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>In practice, we do not really know, whether one of these is the true data generating model. In fact, realistically both models are going to be at least somewhat misspecified, because we made no attempt to fully model the full complexity of the underlying biological system. So, really, the question is which of the two models provides the better approximation. At a glance both seem to fit the data somewhat decently, so it seems unlikely that we can completely rule one of the two models out. That is where Bayesian model averaging comes in.</p>
<p>First, we need to compare how well each model fits. As it turns out, when you just have 4 data points (due to us using summary data), it is problematic to just use the “standard” <code>brms::loo</code> function to perform approximate leave-one-out cross-validation (LOO-CV) based on the posterior likelihood as implemented in the <code>loo</code> package, as can be seen by running</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(brmfit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 1 observations with a pareto_k &gt; 0.7 in model 'brmfit1'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 4 log-likelihood matrix.

         Estimate  SE
elpd_loo      1.0 0.3
p_loo         1.3 0.5
looic        -2.1 0.7
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 0.9]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     3     75.0%   852     
   (0.7, 1]   (bad)      1     25.0%   &lt;NA&gt;    
   (1, Inf)   (very bad) 0      0.0%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>and</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(brmfit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 4 observations with a pareto_k &gt; 0.7 in model 'brmfit2'. We
recommend to set 'moment_match = TRUE' in order to perform moment matching for
problematic observations.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 4 log-likelihood matrix.

         Estimate  SE
elpd_loo     -0.4 0.4
p_loo         2.7 0.7
looic         0.7 0.8
------
MCSE of elpd_loo is NA.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.5, 0.6]).

Pareto k diagnostic values:
                         Count Pct.    Min. ESS
(-Inf, 0.7]   (good)     0      0.0%   &lt;NA&gt;    
   (0.7, 1]   (bad)      2     50.0%   &lt;NA&gt;    
   (1, Inf)   (very bad) 2     50.0%   &lt;NA&gt;    
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>Instead, we actually fit each model leaving each dose group out. We could probably do something more sophisticated by simulating consistent individual patient data (and then performing approximate LOO-CV) or parametric sampling from the normal distribution around the point estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>(loo_exact_brmfit1 <span class="ot">&lt;-</span> <span class="fu">kfold</span>(brmfit1, <span class="at">folds =</span> <span class="st">"loo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.6 seconds.
Chain 2 finished in 0.7 seconds.
Chain 3 finished in 0.8 seconds.
Chain 4 finished in 0.8 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.7 seconds.
Total execution time: 3.1 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 0.3 seconds.
Chain 2 finished in 0.2 seconds.
Chain 3 finished in 0.3 seconds.
Chain 4 finished in 0.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.3 seconds.
Total execution time: 1.5 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 0.2 seconds.
Chain 2 finished in 0.4 seconds.
Chain 3 finished in 0.3 seconds.
Chain 4 finished in 0.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.3 seconds.
Total execution time: 1.6 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 0.3 seconds.
Chain 2 finished in 0.3 seconds.
Chain 3 finished in 0.3 seconds.
Chain 4 finished in 0.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.3 seconds.
Total execution time: 1.6 seconds.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Based on 4-fold cross-validation.

           Estimate  SE
elpd_kfold     -0.5 1.3
p_kfold         2.8 1.9
kfoldic         1.0 2.7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(loo_exact_brmfit2 <span class="ot">&lt;-</span> <span class="fu">kfold</span>(brmfit2, <span class="at">folds =</span> <span class="st">"loo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.6 seconds.
Chain 2 finished in 0.5 seconds.
Chain 3 finished in 0.4 seconds.
Chain 4 finished in 0.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.5 seconds.
Total execution time: 2.0 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 0.2 seconds.
Chain 2 finished in 0.3 seconds.
Chain 3 finished in 0.3 seconds.
Chain 4 finished in 0.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.3 seconds.
Total execution time: 1.4 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 0.3 seconds.
Chain 2 finished in 0.3 seconds.
Chain 3 finished in 0.4 seconds.
Chain 4 finished in 0.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.3 seconds.
Total execution time: 1.5 seconds.

Running MCMC with 4 sequential chains...

Chain 1 finished in 0.2 seconds.
Chain 2 finished in 0.5 seconds.
Chain 3 finished in 0.5 seconds.
Chain 4 finished in 0.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.4 seconds.
Total execution time: 2.0 seconds.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Based on 4-fold cross-validation.

           Estimate  SE
elpd_kfold     -2.1 1.7
p_kfold         4.4 2.2
kfoldic         4.2 3.4</code></pre>
</div>
</div>
<p>Now, we can compare the models via</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(loo_exact_brmfit1, loo_exact_brmfit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        elpd_diff se_diff
brmfit1  0.0       0.0   
brmfit2 -1.6       0.8   </code></pre>
</div>
</div>
<section id="approach-1-manual-without-brms" class="level4" data-number="8.5.3.1">
<h4 data-number="8.5.3.1" class="anchored" data-anchor-id="approach-1-manual-without-brms"><span class="header-section-number">8.5.3.1</span> Approach 1 (manual without <code>brms</code>)</h4>
<p>Let us say that we a-priori assign a 75% probability to the SigEmax model and 25% to the modified beta model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># follows: </span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Gould, A. L. (2019). BMA‐Mod: A Bayesian model averaging strategy for determining dose‐response relationships in the presence of model uncertainty. Biometrical Journal, 61(5), 1141-1159.</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># https://dx.doi.org/10.1002/bimj.201700211</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>prior_weights <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.75</span>,<span class="fl">0.25</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>posterior_weigths <span class="ot">=</span> <span class="fu">c</span>(prior_weights[<span class="dv">1</span>]<span class="sc">*</span><span class="fu">exp</span>(loo_exact_brmfit1<span class="sc">$</span>estimates[<span class="st">"elpd_kfold"</span>, <span class="st">"Estimate"</span>]), </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                      prior_weights[<span class="dv">2</span>]<span class="sc">*</span><span class="fu">exp</span>(loo_exact_brmfit2<span class="sc">$</span>estimates[<span class="st">"elpd_kfold"</span>, <span class="st">"Estimate"</span>]))</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>(<span class="at">posterior_weigths =</span> posterior_weigths<span class="sc">/</span><span class="fu">sum</span>(posterior_weigths))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.93629621 0.06370379</code></pre>
</div>
</div>
<p>As we can see, using leaving-one-dose-group out cross-validation, suggests that the SigEmax model should be given most of the weight. A-posteriori, we assign 93.6% weight to the SigEmax model and 6.4% weight to the modified beta model. However, if we had done approximate LOO-CV with individual patient data, the modified beta model might have been given more weight.</p>
<p>When we average the predictions of the two models with these weights, we get the dose response curve below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>bma_curve <span class="ot">=</span> dr_curve_pred <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(dr_curve_pred2, <span class="at">by=</span><span class="fu">c</span>(<span class="st">".sample"</span>, <span class="st">"dose"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">logRR =</span> posterior_weigths[<span class="dv">1</span>]<span class="sc">*</span>logRR.x <span class="sc">+</span> posterior_weigths[<span class="dv">2</span>]<span class="sc">*</span>logRR.y) <span class="sc">%&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>logRR.x, <span class="sc">-</span>logRR.y, <span class="sc">-</span>.sample) <span class="sc">%&gt;%</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dose) <span class="sc">%&gt;%</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>(<span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>pbma <span class="ot">=</span> bma_curve <span class="sc">%&gt;%</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>dose, <span class="at">y=</span>logRR, <span class="at">ymin=</span>.lower, <span class="at">ymax=</span>.upper)) <span class="sc">+</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>)  <span class="sc">+</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.95</span>), <span class="at">fill=</span><span class="st">"orange"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.5</span>), <span class="at">fill=</span><span class="st">"orange"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">col=</span><span class="st">"darkorange"</span>) <span class="sc">+</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>pathway_deltas) <span class="sc">+</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>pathway_deltas, <span class="at">width=</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span><span class="fu">tibble</span>(<span class="at">dose=</span><span class="dv">300</span>, <span class="at">logRR=</span><span class="fu">log</span>(<span class="fl">0.6</span>), <span class="at">.lower=</span><span class="cn">NA_real_</span>, <span class="at">.upper=</span><span class="cn">NA_real_</span>),</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label=</span><span class="st">"Bayesian model averaging"</span>), <span class="at">col=</span><span class="st">"darkorange"</span>, <span class="at">size=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">log</span>(<span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">paste</span>(<span class="dv">100</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), <span class="st">"%"</span>)) <span class="sc">+</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Relative rate reduction"</span>) <span class="sc">+</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Total tezepelumab dose"</span>)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>( ( (p1 <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">axis.title.x=</span><span class="fu">element_blank</span>()) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Sigmoid Emax model"</span>)) <span class="sc">|</span> </span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>          (p2 <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">axis.title.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">axis.title.x=</span><span class="fu">element_blank</span>()) <span class="sc">+</span> </span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>             <span class="fu">ggtitle</span>(<span class="st">"Modified beta model"</span>))) <span class="sc">/</span> </span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>        (pbma <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Bayesian model averaging"</span>) <span class="sc">|</span> <span class="fu">plot_spacer</span>()) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/bma_curves-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="approach-2-using-brms-functions" class="level4" data-number="8.5.3.2">
<h4 data-number="8.5.3.2" class="anchored" data-anchor-id="approach-2-using-brms-functions"><span class="header-section-number">8.5.3.2</span> Approach 2: Using brms functions</h4>
<p>Before, we needed to do a lot of manual work to get model-averaged predictions, but the below using <code>brms::pp_average</code> would be a lot simpler, if we could rely on the approximate LOO-CV.</p>
<section id="approach-2a-not-appropriate-here" class="level5" data-number="8.5.3.2.1">
<h5 data-number="8.5.3.2.1" class="anchored" data-anchor-id="approach-2a-not-appropriate-here"><span class="header-section-number">8.5.3.2.1</span> Approach 2a: Not appropriate here</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>bma_brms_curve <span class="ot">=</span> dr_curve_data <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>stderr) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">as_tibble</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>(<span class="fu">pp_average</span>(brmfit1, brmfit2, <span class="at">newdata=</span>dr_curve_data, </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">weights=</span><span class="st">"loo"</span>, <span class="co"># Not a good option in this case.</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">summary=</span>F)),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.name_repair=</span>vctrs<span class="sc">::</span><span class="fu">vec_as_names</span>(<span class="at">repair=</span><span class="st">"unique"</span>, <span class="at">quiet =</span>T))) <span class="sc">%&gt;%</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">starts_with</span>(<span class="st">"V"</span>), <span class="at">names_to=</span><span class="st">".sample"</span>, <span class="at">values_to=</span><span class="st">"pred"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">.sample =</span> <span class="fu">as.integer</span>(<span class="fu">str_extract</span>(.sample, <span class="st">"[0-9]+"</span>)))</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Forming differences to placebo by merging with the placebo (dose=0) predictions for each sample</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>bma_brms_curve <span class="ot">=</span> bma_brms_curve <span class="sc">%&gt;%</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(bma_brms_curve  <span class="sc">%&gt;%</span> </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(dose<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dose) <span class="sc">%&gt;%</span> </span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename</span>(<span class="at">placebo=</span>pred), </span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">".sample"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">logRR =</span> pred <span class="sc">-</span> placebo) <span class="sc">%&gt;%</span> <span class="co"># Calculate log rate ratio (difference on log scale vs. placebo)</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(dose, .sample, logRR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="approach-2b-using-leave-one-dose-out-cv" class="level5" data-number="8.5.3.2.2">
<h5 data-number="8.5.3.2.2" class="anchored" data-anchor-id="approach-2b-using-leave-one-dose-out-cv"><span class="header-section-number">8.5.3.2.2</span> Approach 2b: Using leave-one-dose-out CV</h5>
<p>Because we want to avoid using approximate LOO-CV in this case, we first replace the internally calculated approximate LOO-CV results with our own</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>brmfit1<span class="sc">$</span>criteria<span class="sc">$</span>loo <span class="ot">&lt;-</span> loo_exact_brmfit1</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>brmfit2<span class="sc">$</span>criteria<span class="sc">$</span>loo <span class="ot">&lt;-</span> loo_exact_brmfit2</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>(w_dose <span class="ot">&lt;-</span> <span class="fu">model_weights</span>(brmfit1, brmfit2, <span class="at">weights =</span> <span class="st">"loo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> brmfit1  brmfit2 
0.830486 0.169514 </code></pre>
</div>
</div>
<p>We can then do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>bmapreds1 <span class="ot">&lt;-</span> <span class="fu">posterior_epred</span>(brmfit1, <span class="at">newdata =</span> dr_curve_data)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>bmapreds2 <span class="ot">&lt;-</span> <span class="fu">posterior_epred</span>(brmfit2, <span class="at">newdata =</span> dr_curve_data)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>pe_avg <span class="ot">&lt;-</span> bmapreds1 <span class="sc">*</span> w_dose[<span class="dv">1</span>] <span class="sc">+</span> bmapreds2 <span class="sc">*</span> w_dose[<span class="dv">2</span>]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(pe_avg) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pe_avg)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># log-rate predictions for each dose</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>pe_avg <span class="ot">=</span> pe_avg <span class="sc">%&gt;%</span> </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(dr_curve_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(dose)) <span class="sc">%&gt;%</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="sc">-</span>dose, <span class="at">names_to =</span> <span class="st">".sample"</span>, <span class="at">values_to=</span><span class="st">"pred"</span>) </span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># form difference to placebo (log-rate-ratio) and plot</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a> pbma2 <span class="ot">=</span> pe_avg <span class="sc">%&gt;%</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="at">y=</span>pe_avg <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dose<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dose), </span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">".sample"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">logRR=</span>pred.x<span class="sc">-</span>pred.y) <span class="sc">%&gt;%</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>.sample, <span class="sc">-</span>pred.x, <span class="sc">-</span>pred.y) <span class="sc">%&gt;%</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dose) <span class="sc">%&gt;%</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>(<span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>dose, <span class="at">y=</span>logRR, <span class="at">ymin=</span>.lower, <span class="at">ymax=</span>.upper)) <span class="sc">+</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>)  <span class="sc">+</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.95</span>), <span class="at">fill=</span><span class="st">"green"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.5</span>), <span class="at">fill=</span><span class="st">"darkgreen"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.5</span>), <span class="at">col=</span><span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>pathway_deltas) <span class="sc">+</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>pathway_deltas, <span class="at">width=</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span><span class="fu">tibble</span>(<span class="at">dose=</span><span class="dv">300</span>, <span class="at">logRR=</span><span class="fu">log</span>(<span class="fl">0.6</span>), <span class="at">.lower=</span><span class="cn">NA_real_</span>, <span class="at">.upper=</span><span class="cn">NA_real_</span>),</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label=</span><span class="st">"BMA (LOO weights)"</span>), <span class="at">col=</span><span class="st">"darkgreen"</span>, <span class="at">size=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">log</span>(<span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), </span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">paste</span>(<span class="dv">100</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), <span class="st">"%"</span>)) <span class="sc">+</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Relative rate reduction"</span>) <span class="sc">+</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Total tezepelumab dose [mg/month]"</span>)</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pbma2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="why-did-we-do-this-form-of-bayesian-model-averaging" class="level4" data-number="8.5.3.3">
<h4 data-number="8.5.3.3" class="anchored" data-anchor-id="why-did-we-do-this-form-of-bayesian-model-averaging"><span class="header-section-number">8.5.3.3</span> Why did we do this form of Bayesian model averaging?</h4>
<p>Why are we doing it like this? Can we not just fit a single model like this (as an example where we average a sigmoid-Emax and a modified beta model)? <span class="math display">\[
\begin{aligned}
f(\text{dose}; \text{parameters}) = &amp; \text{E}_0 + w \times \text{E}_{\text{max }1} \times \frac{\text{dose}^h}{\text{dose}^h + \text{ED}_{50}^h} \\
  &amp; + (1-w) \times \text{E}_{\text{max }2} \times \frac{(\delta_1 + \delta_2)^{\delta_1 + \delta_2}}{\delta_1^{\delta_1} + \delta_2^{\delta_2}} \times (\frac{\text{dose}}{S})^{\delta_1} \times (1-\frac{\text{dose}}{S})^{\delta_2}
\end{aligned}
\]</span> <code>brms</code> certainly lets us specify such a model (see below). But, part of the reason why we do not use it, is that the model parameters are really badly identified: you can still obtain a similarly good fit at each observed dose level by making one of the two models fit better for one dose (and worse for another dose), if the other model in turn is made to fit worse for that dose (and better for the other dose).</p>
<p>If you run the code below, you will see how much the sampler struggles to fit this model, if we try to fit it. That is the case, even if we make things easier and fix the model weights to 50:50.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The model below does not work so well</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>brmfit3 <span class="ot">&lt;-</span>  <span class="fu">brm</span>( <span class="fu">bf</span>( est <span class="sc">|</span> <span class="fu">se</span>(stderr) <span class="sc">~</span> E0 <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> Emax <span class="sc">*</span> dose<span class="sc">^</span>h<span class="sc">/</span>(dose<span class="sc">^</span>h <span class="sc">+</span> ED50<span class="sc">^</span>h) <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>Emax2<span class="sc">*</span>(delta1<span class="sc">+</span>delta2)<span class="sc">^</span>(delta1<span class="sc">+</span>delta2)<span class="sc">/</span>(delta1<span class="sc">^</span>delta1<span class="sc">*</span>delta2<span class="sc">^</span>delta2)<span class="sc">*</span>(dose<span class="sc">/</span><span class="dv">850</span>)<span class="sc">^</span>delta1<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>dose<span class="sc">/</span><span class="dv">850</span>)<span class="sc">^</span>delta2,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                   E0 <span class="sc">~</span> <span class="dv">1</span>, ED50 <span class="sc">~</span> <span class="dv">1</span>, h <span class="sc">~</span> <span class="dv">1</span>, Emax <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                   <span class="co">#modelwgt ~ 1,</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                   delta1 <span class="sc">~</span> <span class="dv">1</span>, delta2 <span class="sc">~</span> <span class="dv">1</span>, Emax2 <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nl=</span>T),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>pathway,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"E0"</span>),</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"h"</span>),</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"Emax"</span>),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="at">nlpar=</span><span class="st">"ED50"</span>),</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>                         <span class="co">#prior(beta(4,1), nlpar="modelwgt", lb=0, ub=1),</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"Emax2"</span>),</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"delta1"</span>, <span class="at">lb=</span><span class="dv">0</span>),</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">lognormal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"delta2"</span>, <span class="at">lb=</span><span class="dv">0</span>)),</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.999</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you run this code, it produces a lot of severe warnings (which you should not ignore) about divergent transitions after warmup and a very high largest R-hat. Additionally, “Bulk Effective Samples Size” and “Tail Effective Samples Size (ESS)” are too low, and a lot of transitions after warmup that exceeded the maximum treedepth.</p>
</section>
</section>
<section id="going-beyond-the-default-mcp-mod-models" class="level3" data-number="8.5.4">
<h3 data-number="8.5.4" class="anchored" data-anchor-id="going-beyond-the-default-mcp-mod-models"><span class="header-section-number">8.5.4</span> Going beyond the default MCP-Mod models</h3>
<p>So far, a lot of what we did could also be done in a frequentist manner using the MCP-Mod approach. However, with <code>brms</code> it is easy to make our models more complex when necessary. For example, we assumed that a 280 mg q2w dose is equivalent to a 560 mg q4w dose. This is of course only the case in terms of the total amount of drug injected over the trial period. However, the two dose regimens differ in terms of their blood concentrations over time as shown in the plot below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>sim_1st_order_pk <span class="ot">=</span> <span class="cf">function</span>(<span class="at">injected=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">28</span><span class="sc">*</span><span class="dv">5</span>)), <span class="at">dose=</span><span class="dv">1</span>, <span class="at">thalf=</span><span class="dv">28</span><span class="sc">*</span><span class="dv">24</span>, <span class="at">V=</span><span class="dv">10</span>){</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">=</span> <span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>thalf  </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  concentration <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(injected))</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(injected)){</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i<span class="sc">&gt;</span><span class="dv">1</span>) {</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>      concentration[i] <span class="ot">=</span> concentration[i<span class="dv">-1</span>] <span class="sc">-</span> k<span class="sc">*</span>concentration[i<span class="dv">-1</span>] <span class="sc">+</span> dose<span class="sc">*</span>injected[i]<span class="sc">/</span>V</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>      concentration[i] <span class="ot">=</span> dose<span class="sc">*</span>injected[i]<span class="sc">/</span>V</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(concentration)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">regimen=</span><span class="st">"q4wk"</span>,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dose=</span><span class="dv">280</span>,</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>                   <span class="at">concentration =</span> <span class="fu">sim_1st_order_pk</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">28</span><span class="sc">*</span><span class="dv">24-1</span>)),<span class="dv">12</span>), <span class="at">dose=</span><span class="dv">280</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hour=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">regimen=</span><span class="st">"q2wk"</span>,</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">dose=</span><span class="dv">280</span>,</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">concentration =</span> <span class="fu">sim_1st_order_pk</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">14</span><span class="sc">*</span><span class="dv">24-1</span>)),<span class="dv">24</span>), <span class="at">dose=</span><span class="dv">280</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mutate</span>(<span class="at">hour=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">regimen=</span><span class="st">"q4wk"</span>,</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">dose=</span><span class="dv">560</span>,</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">concentration =</span> <span class="fu">sim_1st_order_pk</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">28</span><span class="sc">*</span><span class="dv">24-1</span>)),<span class="dv">12</span>), <span class="at">dose=</span><span class="dv">560</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mutate</span>(<span class="at">hour=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>()))) <span class="sc">%&gt;%</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dose_regimen =</span> <span class="fu">paste0</span>(dose, <span class="st">" mg "</span>, regimen)) </span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>plot_data <span class="sc">%&gt;%</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>hour, <span class="at">y=</span>concentration, <span class="at">col=</span>dose_regimen)) <span class="sc">+</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">120</span>)) <span class="sc">+</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">12</span>)<span class="sc">*</span><span class="dv">28</span><span class="sc">*</span><span class="dv">24</span>, <span class="at">labels=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>. <span class="sc">%&gt;%</span> <span class="fu">filter</span>( (hour<span class="sc">==</span><span class="dv">8025</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(dose_regimen, <span class="st">"280 mg q2"</span>)) <span class="sc">|</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>                               (hour<span class="sc">==</span><span class="dv">500</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(dose_regimen, <span class="st">"560 mg q4"</span>)) <span class="sc">|</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>                               (hour<span class="sc">==</span><span class="dv">5000</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(dose_regimen, <span class="st">"280 mg q4"</span>))),</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label=</span>dose_regimen), <span class="at">nudge_y=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">20</span>,<span class="dv">25</span>, <span class="dv">60</span>), <span class="at">angle=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">75</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time in trial (months)"</span>) <span class="sc">+</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Drug concentration [mg/L]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/simplepk-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These differences in pharmacokinetic profiles likely lead to at least somewhat different efficacy outcomes. For example, if efficacy is more driven by the peak concentration achieved in each dosing interval, 280 mg q2w might be less effective than a 560 mg q4w regiment would have been. On the other hand, if efficacy is more determined by the minimum concentration maintained throughout time, then 280 mg q2w could be more effective than 560 mg q4w. If the main determinant of efficacy is the average drug concentration over time, and peaks and troughs do not matter (at least within the concentrations seen), then the two dosing regimens might be exactly identical.</p>
<p>So, we could update our previous sigmoid Emax model and add an extra term that describes how the 280 mg q2w dose might relate to q4w doses. Note that assuming a monotone concentration response, a 280 mg q2w regimen cannot be worse than a 280 mg q4w regimen - this is also illustrated by the plot showing that the concentrations of 280 mg q2w are (unsurprisingly) always above those of 280 mg q4w. This gives us a lower bound for the efficacy of 280 mg q2w. Similarly, its peak concentrations stay below 2.5 times the peak concentrations of 280 mg q2w, which gives us an upper bound. We will specify a log-normal prior with mean 0 and SD 0.67 for a regimen factor that indicates what q4w dose a q2w dose is equivalent to.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>brmfit3 <span class="ot">&lt;-</span> <span class="fu">brm</span>( <span class="fu">bf</span>( est <span class="sc">|</span> <span class="fu">se</span>(stderr) <span class="sc">~</span> E0 <span class="sc">+</span> Emax <span class="sc">*</span> (dose<span class="sc">*</span>dosefactor)<span class="sc">^</span>h <span class="sc">/</span> ((dose<span class="sc">*</span>dosefactor)<span class="sc">^</span>h <span class="sc">+</span> ED50<span class="sc">^</span>h),</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">nlf</span>(h <span class="sc">~</span> <span class="fu">exp</span>(logh)), <span class="fu">nlf</span>(ED50 <span class="sc">~</span> <span class="fu">exp</span>(logED50)), <span class="fu">nlf</span>(dosefactor <span class="sc">~</span> <span class="fu">exp</span>((dose<span class="sc">==</span><span class="dv">560</span>)<span class="sc">*</span>regimen)),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                   E0 <span class="sc">~</span> <span class="dv">1</span>, logED50 <span class="sc">~</span> <span class="dv">1</span>, logh <span class="sc">~</span> <span class="dv">1</span>, Emax <span class="sc">~</span> <span class="dv">1</span>, regimen <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">nl=</span>T, <span class="at">family=</span><span class="fu">gaussian</span>()),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>pathway,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"E0"</span>),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"logh"</span>),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">nlpar=</span><span class="st">"Emax"</span>),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="at">nlpar=</span><span class="st">"logED50"</span>),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="fl">0.67</span>), <span class="at">nlpar=</span><span class="st">"regimen"</span>)),</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.999</span>),</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">seed=</span><span class="dv">2023</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">save_pars =</span> <span class="fu">save_pars</span>(<span class="at">all =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s summarize the model results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(brmfit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 3 divergent transitions after warmup. Increasing
adapt_delta above 0.999 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: est | se(stderr) ~ E0 + Emax * (dose * dosefactor)^h/((dose * dosefactor)^h + ED50^h) 
         h ~ exp(logh)
         ED50 ~ exp(logED50)
         dosefactor ~ exp((dose == 560) * regimen)
         E0 ~ 1
         logED50 ~ 1
         logh ~ 1
         Emax ~ 1
         regimen ~ 1
   Data: pathway (Number of observations: 4) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
E0_Intercept         -0.42      0.10    -0.61    -0.22 1.00     2624     2529
logED50_Intercept     2.76      1.34    -0.33     5.09 1.00     1552     1553
logh_Intercept        0.00      0.98    -1.81     1.98 1.00     1388     1769
Emax_Intercept       -1.30      0.33    -2.11    -0.84 1.00     1429     1348
regimen_Intercept    -0.05      0.68    -1.36     1.25 1.00     2553     2452

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     0.00      0.00     0.00     0.00   NA       NA       NA

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>As we can see, we can fit such a model, but the marginal posterior for the log-regimen factor is still a N(0, 0.67) distribution. Thus, the data do not inform this parameter very well - which should not surprise us. However, if we had information external to the PATHWAY trial, such as the elicited judgments of experts, we could incorporate it via this type of model.</p>
</section>
</section>
<section id="conclusion" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">8.6</span> Conclusion</h2>
<p>As we could see <code>brms</code> makes it surprisingly easy to fit non-linear dose response models and to perform model averaging. Taking a Bayesian approach to dose response modeling is attractive for a number of reasons: * using prior information e.g.&nbsp;on expected placebo outcomes, the maximum plausible treatment effect and typical dose response patterns, * (weakly-)informative priors avoid issues with maximum likelihood estimation such as infinitely steep sigmoid Emax models (common when the lowest tested dose has the best point estimate), * the convenience of obtaining predictions about things that are transformations of the model parameters (e.g.&nbsp;the dose with at least a certain effect), and * the straightforward way, in which we can extend the basic models to account for the specifics of our dose finding study.</p>
</section>
<section id="excercises" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="excercises"><span class="header-section-number">8.7</span> Excercises</h2>
<p>The data below are from a non-clinical study published by Goodner and Horsfall in 1935 (Goodner, K. and Horsfall Jr, F.L., 1935. The protective action of type I antipneumococcus serum in mice: I. The quantitative aspects of the mouse protection test. The Journal of Experimental Medicine, 62(3), pp.359-374.). Mice were given injections of different amounts from a pneumococcus culture, which at the doses given would in the absence of treatment be invariably fatal, mixed together with different doses of type I antipenumococcus horse and rabbit sera. Over several days it was recorded whether each mouse survived or died. This is an example of a dose response curve that appears to have been accepted to be truly non-monotonic in the scientific literature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>mice <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Source of immune serum</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">factor</span>( <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>L, <span class="dv">29</span><span class="sc">*</span><span class="dv">3</span>), <span class="fu">rep</span>(<span class="dv">2</span>L, <span class="dv">32</span><span class="sc">*</span><span class="dv">3</span>)),</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">1</span>L, <span class="dv">2</span>L), </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"rabbit"</span>, <span class="st">"horse"</span>)),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Amount of serum (cc.)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">rep</span>(<span class="fl">0.4</span><span class="sc">*</span><span class="fl">0.5</span><span class="sc">^</span><span class="fu">c</span>(<span class="dv">0</span>L<span class="sc">:</span><span class="dv">5</span>L, <span class="dv">0</span>L<span class="sc">:</span><span class="dv">6</span>L, <span class="dv">0</span>L<span class="sc">:</span><span class="dv">7</span>L, <span class="dv">0</span>L<span class="sc">:</span><span class="dv">7</span>L,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>                                          <span class="dv">1</span>L<span class="sc">:</span><span class="dv">5</span>L, <span class="dv">0</span>L<span class="sc">:</span><span class="dv">8</span>L, <span class="dv">0</span>L<span class="sc">:</span><span class="dv">8</span>L, <span class="dv">0</span>L<span class="sc">:</span><span class="dv">8</span>L),</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>                                <span class="at">each=</span><span class="dv">3</span>),</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Amount of culture (cc.)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fl">0.4</span>, <span class="dv">18</span>), <span class="fu">rep</span>(<span class="fl">0.2</span>, <span class="dv">21</span>), <span class="fu">rep</span>(<span class="fl">0.1</span>, <span class="dv">24</span>), </span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rep</span>(<span class="fl">0.05</span>, <span class="dv">24</span>), <span class="fu">rep</span>(<span class="fl">0.4</span>, <span class="dv">15</span>), <span class="fu">rep</span>(<span class="fl">0.2</span>, <span class="dv">27</span>), </span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rep</span>(<span class="fl">0.1</span>, <span class="dv">27</span>), <span class="fu">rep</span>(<span class="fl">0.05</span>,<span class="dv">27</span>)),</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Died =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>L, <span class="dv">18</span>),</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span>L,<span class="fu">rep</span>(<span class="dv">0</span>L,<span class="dv">5</span>), <span class="dv">1</span>L,<span class="dv">1</span>L,<span class="dv">0</span>L, <span class="dv">1</span>L,<span class="dv">0</span>L,<span class="dv">0</span>L, <span class="dv">1</span>L,<span class="dv">1</span>L,<span class="dv">1</span>L, <span class="dv">1</span>L,<span class="dv">0</span>L,<span class="dv">0</span>L, <span class="dv">1</span>L,<span class="dv">1</span>L,<span class="dv">1</span>L,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="dv">0</span>L, <span class="dv">14</span>),<span class="dv">1</span>L, <span class="dv">0</span>L,<span class="dv">0</span>L,<span class="dv">0</span>L, <span class="dv">1</span>L,<span class="dv">1</span>L,<span class="dv">0</span>L, <span class="dv">1</span>L,<span class="dv">1</span>L,<span class="dv">1</span>L,</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="dv">0</span>L,<span class="dv">24</span>), </span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="dv">1</span>L, <span class="dv">15</span>),</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="dv">1</span>L, <span class="dv">8</span>),<span class="dv">0</span>L, <span class="dv">1</span>L,<span class="dv">0</span>L,<span class="dv">0</span>L, <span class="dv">1</span>L,<span class="dv">0</span>L,<span class="dv">0</span>L, <span class="fu">rep</span>(<span class="dv">1</span>L,<span class="dv">5</span>),<span class="dv">0</span>L, <span class="dv">0</span>L,<span class="fu">rep</span>(<span class="dv">1</span>L,<span class="dv">5</span>),</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="dv">1</span>L,<span class="dv">5</span>), <span class="dv">0</span>L,<span class="dv">1</span>L,<span class="fu">rep</span>(<span class="dv">0</span>L,<span class="dv">9</span>),<span class="fu">rep</span>(<span class="dv">1</span>L,<span class="dv">4</span>),<span class="dv">0</span>L, <span class="fu">rep</span>(<span class="dv">1</span>L,<span class="dv">6</span>),</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(<span class="dv">1</span>L,<span class="dv">5</span>), <span class="fu">rep</span>(<span class="dv">0</span>L,<span class="dv">12</span>),<span class="dv">1</span>L, <span class="dv">0</span>L,<span class="dv">0</span>L, <span class="fu">rep</span>(<span class="dv">1</span>L,<span class="dv">7</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Survived =</span> <span class="dv">1</span>L<span class="sc">-</span>Died)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Displayed in a fashion similar to the original article, the data look as in the figure below.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/plot_mice_data-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>An alternative display showing the proportion of mice that survived versus the amount of serum given as displayed in the figure below.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02b_dose_finding_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Excercises in increasing order of complexity:</p>
<ol type="1">
<li><p>Fit a sigmoid Emax model to the horse serum data of each individual mouse assuming a Bernoulli distribution after choosing reasonable weakly informative priors, but remember that 0 cc. of serum was stated to result in a death rate of near 100%. Perform model checking.</p></li>
<li><p>Fit a modified beta model to the horse serum data and also perform Bayesian model averaging. Does this result in a better fit?</p></li>
</ol>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/opensource\.nibr\.com\/bamdd\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../src/02l_single_arm_pos.html" class="pagination-link" aria-label="Probability of success from a single arm trial">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Probability of success from a single arm trial</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../src/02c_dose_escalation.html" class="pagination-link" aria-label="Oncology dose escalation">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Oncology dose escalation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb46" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">  - Björn Holzhauer - &lt;bjoern.holzhauer@novartis.com&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Dose finding {#sec-dose-finding}</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include=FALSE}</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="in">source(here::here("src", "setup.R"))</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="fu">## Background</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## What role does dose response modeling play in drug development?</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>In clinical drug development, one key question is what dose of a drug should be used to treat a disease. </span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>Ideally, we would want a dose that achieves (nearly) optimal efficacy, while at the same time minimizing side effects to optimize the benefit-risk balance.</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>In many therapeutic areas the relationship between dose and efficacy is characterized in Phase IIb clinical trials that randomize patients to received either one of several doses of a drug or a matching placebo. </span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>In such studies, it would be inefficient to try a lot of doses and just look at the performance of each dose in isolation. </span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>Instead, we know that biologically there should be some smooth function that describes the relationship between dose and efficacy. </span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>We can exploit this knowledge to make the analysis of such studies more efficient. </span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>There are a number of methods for analyzing such trials that exploit that the true expected difference to placebo will follow some smooth function of the dose. </span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>However, we typically do not know what smooth function best approximates the true underlying dose response function. </span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>Obvious candidate functions include monotone functions that eventually plateau, and functions that initially achieve a maximum and then decline.</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-profile="dummy"}</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview Video</span></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>{{&lt; video videos/brms-case-2-dose-finding.mp4 &gt;}}</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data: PATHWAY asthma example</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>We will use the PATHWAY trial as an example. This was a placebo-controlled randomized trial of three different tezepelumab dosing regimens compared with placebo in severe asthma. Two of the tezepelumab dosing regimens were given every 4 weeks. We will treat the third regimen of 280 mg every 2 weeks as if it had been 560 mg every 4 weeks. The primary endpoint of PATHWAY was the annualized rate of asthma exacerbations. The plot below shows the published estimates with 95\% confidence intervals per dose. Many standard dose response modeling approaches do not require access to individual patient data - which in this case is not publically available -, but can be conducted given estimates and standard error for each dose.</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show_packages, eval=TRUE,echo=TRUE,message=FALSE,warning=FALSE}</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidybayes)</span></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggrepel)</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a><span class="in">library(patchwork)</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a><span class="in">library(here)</span></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a><span class="in"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a><span class="in">options(brms.backend="cmdstanr", cmdstanr_write_stan_file_dir=here("_brms-cache"))</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a><span class="in"># create cache directory if not yet available</span></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a><span class="in">dir.create(here("_brms-cache"), FALSE)</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(8979476)</span></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include=FALSE}</span></span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a><span class="in"># invisible to the reader we move the cache directory</span></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a><span class="in">options(cmdstanr_write_stan_file_dir=brms_cache_dir)</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_annualized_rates}</span></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a><span class="in"># This is the PATHWAY DRF data by group</span></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a><span class="in">pathway = tibble(dose = c(0, 70, 210, 280*2),</span></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a><span class="in">                 group = c("placebo", "tezepelumab 70 mg q4w",</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a><span class="in">                           "tezepelumab 210 mg q4w", "tezepelumab 280 mg q2w"),</span></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a><span class="in">                 est = log(c(0.67, 0.26, 0.19, 0.22)),</span></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a><span class="in">                 stderr = c(0.10304, 0.17689, 0.22217, 0.19108))</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a><span class="in"># Simple plot of the data</span></span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a><span class="in">pathway %&gt;%</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=dose, y=est, label=str_wrap(group, 12), col=group,</span></span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a><span class="in">             ymin=est-stderr*qnorm(0.975), ymax=est+stderr*qnorm(0.975))) +</span></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(width=10) +</span></span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point() +</span></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks=log(seq(0.1,1,0.1)), labels=seq(0.1,1,0.1)) +</span></span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Annualized rate (95% CI)") +</span></span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Tezepelumab dose (mg/month)") +</span></span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text_repel(nudge_x=c(25, 30, 60, -30), segment.color = NA)</span></span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>Or to show this as rate ratios compared with the placebo group:</span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_pathway_deltas}</span></span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a><span class="in"># This is the PATHWAY DRF log-rate-ratios vs. placebo</span></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a><span class="in">pathway_deltas = tibble(dose= c(0, 70, 210, 280*2),</span></span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a><span class="in">                        group = c("reference level",</span></span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a><span class="in">                                  "tezepelumab 70 mg q4w vs. placebo",</span></span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a><span class="in">                                  "tezepelumab 210 mg q4w vs. placebo", </span></span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a><span class="in">                                  "tezepelumab 280 mg q2w vs. placebo"),</span></span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a><span class="in">                        logRR= c(0,log(c(1-0.61, 1-0.71, 1-0.66))),</span></span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a><span class="in">                        .lower90 = log(c(NA_real_, 1-0.75, 1-0.82, 1-0.79)), # Paper reports 90% CIs</span></span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a><span class="in">                        .upper90 = log(c(NA_real_, 1-0.39, 1-0.53, 1-0.47)),</span></span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a><span class="in">                        stderr = (.upper90-.lower90)/2/qnorm(0.95),</span></span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a><span class="in">                        .lower = logRR-stderr*qnorm(0.975), # Get 95% CIs</span></span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a><span class="in">                        .upper = logRR+stderr*qnorm(0.975))</span></span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a><span class="in"># Plot log-rate ratios</span></span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a><span class="in">pathway_deltas %&gt;%</span></span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=dose, y=logRR, </span></span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a><span class="in">             label=str_wrap(group, 12), col=group,</span></span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a><span class="in">             ymin=.lower, ymax=.upper)) +</span></span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept=0) +</span></span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(width=10) +</span></span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a><span class="in">  #geom_errorbar(width=10, aes(ymin=.lower90, ymax=.upper90)) +</span></span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point() +</span></span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks=log(seq(0.1,1,0.1)), labels=seq(0.1,1,0.1)) +</span></span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(limits=c(0,600)) +</span></span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Exacerbation rate ratio (95% CI)") +</span></span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Tezepelumab dose (mg/month)") +</span></span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text_repel(nudge_x=c(25, 30, 60, -30), nudge_y=c(-0.15, 0, 0, 0), </span></span>
<span id="cb46-108"><a href="#cb46-108" aria-hidden="true" tabindex="-1"></a><span class="in">                  segment.color = NA)</span></span>
<span id="cb46-109"><a href="#cb46-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-110"><a href="#cb46-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-111"><a href="#cb46-111" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model description</span></span>
<span id="cb46-112"><a href="#cb46-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-113"><a href="#cb46-113" aria-hidden="true" tabindex="-1"></a>To conduct dose response analyses under model uncertainty a number of approaches such as the </span>
<span id="cb46-114"><a href="#cb46-114" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Multiple Comparison Procedures and Modeling (MCP-Mod)</span><span class="co">](https://doi.org/10.1002/sim.3802)</span>, </span>
<span id="cb46-115"><a href="#cb46-115" aria-hidden="true" tabindex="-1"></a>the <span class="co">[</span><span class="ot">generalized MCP-Mod approach</span><span class="co">](https://doi.org/10.1002/sim.6052)</span> and Gaussian process based approaches are popular. </span>
<span id="cb46-116"><a href="#cb46-116" aria-hidden="true" tabindex="-1"></a>Within the generalized MCP-Mod framework <span class="co">[</span><span class="ot">model averaging is an attractive approach</span><span class="co">](https://doi.org/10.1002/pst.1671)</span> </span>
<span id="cb46-117"><a href="#cb46-117" aria-hidden="true" tabindex="-1"></a>for dealing with model uncertainty that has <span class="co">[</span><span class="ot">performed well in simulation studies</span><span class="co">](https://doi.org/10.1002/sim.6991)</span>. </span>
<span id="cb46-118"><a href="#cb46-118" aria-hidden="true" tabindex="-1"></a>Here, we take a Bayesian approach to model averaging in the MCP-Mod framework, which <span class="co">[</span><span class="ot">Gould (2018)</span><span class="co">](https://doi.org/10.1002/bimj.201700211)</span> </span>
<span id="cb46-119"><a href="#cb46-119" aria-hidden="true" tabindex="-1"></a>called BMA-Mod (BMA stands for Bayesian model averaging).</span>
<span id="cb46-120"><a href="#cb46-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-121"><a href="#cb46-121" aria-hidden="true" tabindex="-1"></a>While more complex mechanistic pharmacokinetic/pharmacodynamic (PK/PD) models are often important, </span>
<span id="cb46-122"><a href="#cb46-122" aria-hidden="true" tabindex="-1"></a>here, we discuss directly modelling the relationship between dose and some clinical outcome in patients.</span>
<span id="cb46-123"><a href="#cb46-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-124"><a href="#cb46-124" aria-hidden="true" tabindex="-1"></a>BMA-Mod, just as MCP-Mod, uses a set of candidate models that might describe dose response relationships. </span>
<span id="cb46-125"><a href="#cb46-125" aria-hidden="true" tabindex="-1"></a>In the subsections that follow, we describe each model.</span>
<span id="cb46-126"><a href="#cb46-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-127"><a href="#cb46-127" aria-hidden="true" tabindex="-1"></a><span class="fu">### The likelihood function into which we put the dose response model</span></span>
<span id="cb46-128"><a href="#cb46-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-129"><a href="#cb46-129" aria-hidden="true" tabindex="-1"></a>No matter whether we use summary data consiting of estimates with standard errors with each treatment group, </span>
<span id="cb46-130"><a href="#cb46-130" aria-hidden="true" tabindex="-1"></a>or whether we have individual patient data (IPD) for a continuous, binary, count, time-to-event or ordinal outcome,</span>
<span id="cb46-131"><a href="#cb46-131" aria-hidden="true" tabindex="-1"></a>our regression model will be one of the dose response models we will describe in the subsequent sections.</span>
<span id="cb46-132"><a href="#cb46-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-133"><a href="#cb46-133" aria-hidden="true" tabindex="-1"></a>What will differ is the likelihood function, into which we insert the dose response function.</span>
<span id="cb46-134"><a href="#cb46-134" aria-hidden="true" tabindex="-1"></a>In the PATHWAY example, we will use that the estimates for log-mean-event-rate for each dose level $i=1,\ldots,I$ are </span>
<span id="cb46-135"><a href="#cb46-135" aria-hidden="true" tabindex="-1"></a>approximately indpendent with $\hat{\theta}_i \sim N(\theta_i, \text{SE}(\hat{\theta}_i))$ distributions.</span>
<span id="cb46-136"><a href="#cb46-136" aria-hidden="true" tabindex="-1"></a>Thus, we can use a Gaussian likelihood with known standard deviation. In case of IPD, we would instead</span>
<span id="cb46-137"><a href="#cb46-137" aria-hidden="true" tabindex="-1"></a>use suitable IPD-likelihoods. This only requires minimal changes in the code for the examples.</span>
<span id="cb46-138"><a href="#cb46-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-139"><a href="#cb46-139" aria-hidden="true" tabindex="-1"></a><span class="fu">### The sigmoid-Emax and the Emax model</span></span>
<span id="cb46-140"><a href="#cb46-140" aria-hidden="true" tabindex="-1"></a>A very popular dose response model is the **sigmoid-Emax model**. This model assumes that the outcome for each dose group can be described by a function of the form</span>
<span id="cb46-141"><a href="#cb46-141" aria-hidden="true" tabindex="-1"></a>$$f(\text{dose}; \text{parameters}) = \text{E}_0 + \text{E}_\text{max} \times \frac{\text{dose}^h}{\text{dose}^h + \text{ED}_{50}^h}.$$</span>
<span id="cb46-142"><a href="#cb46-142" aria-hidden="true" tabindex="-1"></a>This is a monotone curve that starts at no difference to placebo at dose 0 (the expected placebo response is $\text{E}_0$) </span>
<span id="cb46-143"><a href="#cb46-143" aria-hidden="true" tabindex="-1"></a>and plateaus at a maximum effect of size $\text{E}_\text{max} \in (-\infty, \infty)$. 50\% of the maximum effect </span>
<span id="cb46-144"><a href="#cb46-144" aria-hidden="true" tabindex="-1"></a>is reached at the dose $\text{ED}_{50} \in (0, \infty)$.</span>
<span id="cb46-145"><a href="#cb46-145" aria-hidden="true" tabindex="-1"></a>The steepness of the curve is determined by the so-called Hill parameter $h \in (0, \infty)$. For $h=1$, we have the simple **Emax model**, </span>
<span id="cb46-146"><a href="#cb46-146" aria-hidden="true" tabindex="-1"></a>for $h&gt;1$ the dose response curve is steeper around $\text{ED}_{50}$ (and plateaus faster) than for a simple Emax model, while for $h&lt;1$ the curve is less steep.</span>
<span id="cb46-147"><a href="#cb46-147" aria-hidden="true" tabindex="-1"></a>Typical values of $h$ are smaller than 5 and usually at most 3, so assigning a prior that puts most of the prior weight for $\log h$ between $-\log 5$ and $\log 5$ makes sense.</span>
<span id="cb46-148"><a href="#cb46-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-149"><a href="#cb46-149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sigemax_plots, echo=FALSE}</span></span>
<span id="cb46-150"><a href="#cb46-150" aria-hidden="true" tabindex="-1"></a><span class="in"># Plot some example sigEmax curves</span></span>
<span id="cb46-151"><a href="#cb46-151" aria-hidden="true" tabindex="-1"></a><span class="in">expand_grid(Dose=seq(0, 100, 0.1), Emax=1, E0=0, ED50=c(5,25), h=c(1/3, 1, 3)) %&gt;%</span></span>
<span id="cb46-152"><a href="#cb46-152" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(`Dose response` = E0 + Emax * Dose^h/(Dose^h + ED50^h),</span></span>
<span id="cb46-153"><a href="#cb46-153" aria-hidden="true" tabindex="-1"></a><span class="in">         text = paste0("ED50=", ED50, "/h=",round(h,2))) %&gt;%</span></span>
<span id="cb46-154"><a href="#cb46-154" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=Dose, y=`Dose response`, col=text, label=text)) +</span></span>
<span id="cb46-155"><a href="#cb46-155" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line() +</span></span>
<span id="cb46-156"><a href="#cb46-156" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(labels=scales::percent(seq(0,1,0.25))) +</span></span>
<span id="cb46-157"><a href="#cb46-157" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text_repel(data=. %&gt;% filter( Dose==50), max.iter = 100, #max.time = 10, </span></span>
<span id="cb46-158"><a href="#cb46-158" aria-hidden="true" tabindex="-1"></a><span class="in">                  nudge_x=c(35, 30,-16, 30, 10, 5), segment.color = NA,</span></span>
<span id="cb46-159"><a href="#cb46-159" aria-hidden="true" tabindex="-1"></a><span class="in">                  nudge_y=c(0,-0.02,-0.05, -0.02, -0.03,-0.1))</span></span>
<span id="cb46-160"><a href="#cb46-160" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-161"><a href="#cb46-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-162"><a href="#cb46-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-163"><a href="#cb46-163" aria-hidden="true" tabindex="-1"></a>The Emax model is a simple model with some biological plausibility. </span>
<span id="cb46-164"><a href="#cb46-164" aria-hidden="true" tabindex="-1"></a>It is the equation that results from assuming the drug concentrations at the site of drug action are proportional to the administered dose, </span>
<span id="cb46-165"><a href="#cb46-165" aria-hidden="true" tabindex="-1"></a>that drug binds to and unbinds from a receptor at a rate proportional to the drug concentration, and that drugs effects are proportional to receptor occupancy. </span>
<span id="cb46-166"><a href="#cb46-166" aria-hidden="true" tabindex="-1"></a>And, it assumes that all these relationships are exactly the same for all patients. </span>
<span id="cb46-167"><a href="#cb46-167" aria-hidden="true" tabindex="-1"></a>All of these assumptions can be relaxed/avoided when individual patient data (and even better, if also the necessary data for PK/PD modeling) are available.</span>
<span id="cb46-168"><a href="#cb46-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-169"><a href="#cb46-169" aria-hidden="true" tabindex="-1"></a><span class="fu">### The modified beta model</span></span>
<span id="cb46-170"><a href="#cb46-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-171"><a href="#cb46-171" aria-hidden="true" tabindex="-1"></a>Another possible dose response model is the modified beta model. </span>
<span id="cb46-172"><a href="#cb46-172" aria-hidden="true" tabindex="-1"></a>$$f(\text{dose}; \text{parameters}) = \text{E}_0 + \text{E}_{\text{max }2} \times \frac{(\delta_1 + \delta_2)^{\delta_1 + \delta_2}}{\delta_1^{\delta_1} + \delta_2^{\delta_2}} \times (\frac{\text{dose}}{S})^{\delta_1} \times (1-\frac{\text{dose}}{S})^{\delta_2}$$</span>
<span id="cb46-173"><a href="#cb46-173" aria-hidden="true" tabindex="-1"></a>This model is capable of describing a non-monotone dose response.</span>
<span id="cb46-174"><a href="#cb46-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-175"><a href="#cb46-175" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exponential model, and linear and quadratic functions of dose or log-dose</span></span>
<span id="cb46-176"><a href="#cb46-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-177"><a href="#cb46-177" aria-hidden="true" tabindex="-1"></a>The exponential model</span>
<span id="cb46-178"><a href="#cb46-178" aria-hidden="true" tabindex="-1"></a>$$f(\text{dose}; \text{parameters}) = b_1 + b_2 (\exp(b_3 \times \text{dose})-1)$$</span>
<span id="cb46-179"><a href="#cb46-179" aria-hidden="true" tabindex="-1"></a>with $b_3&lt;0$ was also discussed by <span class="co">[</span><span class="ot">Gould</span><span class="co">](https://doi.org/10.1002/bimj.201700211)</span>.</span>
<span id="cb46-180"><a href="#cb46-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-181"><a href="#cb46-181" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Gould</span><span class="co">](https://doi.org/10.1002/bimj.201700211)</span> also considered linear and quadratic functions of dose or log-dose. I.e.</span>
<span id="cb46-182"><a href="#cb46-182" aria-hidden="true" tabindex="-1"></a>$$f(\text{dose}; \text{parameters}) = \text{E}_0 + \beta \times \text{dose},$$</span>
<span id="cb46-183"><a href="#cb46-183" aria-hidden="true" tabindex="-1"></a>$$f(\text{dose}; \text{parameters}) = \text{E}_0 + \beta \times \log (\text{dose}),$$</span>
<span id="cb46-184"><a href="#cb46-184" aria-hidden="true" tabindex="-1"></a>$$f(\text{dose}; \text{parameters}) = \text{E}_0 + \beta_1 \times \text{dose} + \beta_2 \times \text{dose}^2$$</span>
<span id="cb46-185"><a href="#cb46-185" aria-hidden="true" tabindex="-1"></a>or</span>
<span id="cb46-186"><a href="#cb46-186" aria-hidden="true" tabindex="-1"></a>$$f(\text{dose}; \text{parameters}) = \text{E}_0 + \beta_1 \times \log (\text{dose}) + \beta_2 \times (\log (\text{dose}))^2.$$</span>
<span id="cb46-187"><a href="#cb46-187" aria-hidden="true" tabindex="-1"></a>These models are perhaps better suited towards modeling the dose-response relationship within the range of tested dose </span>
<span id="cb46-188"><a href="#cb46-188" aria-hidden="true" tabindex="-1"></a>and would not necessarily be expected to extrapolate well beyond the data range. Nevertheless, they may be useful for providing a more flexible set of models.</span>
<span id="cb46-189"><a href="#cb46-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-190"><a href="#cb46-190" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian Model averaging</span></span>
<span id="cb46-191"><a href="#cb46-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-192"><a href="#cb46-192" aria-hidden="true" tabindex="-1"></a>If we have multiple models that are similarly plausible given our prior information and the data we observed, </span>
<span id="cb46-193"><a href="#cb46-193" aria-hidden="true" tabindex="-1"></a>then picking a single model out of these ignores the model uncertainty.</span>
<span id="cb46-194"><a href="#cb46-194" aria-hidden="true" tabindex="-1"></a>For this reason, model averaging is known to be a good approach for dealing with model uncertainty.</span>
<span id="cb46-195"><a href="#cb46-195" aria-hidden="true" tabindex="-1"></a>It assigns greater weight to more plausible models and can - given enough evidence - give all weight to a single clearly best model</span>
<span id="cb46-196"><a href="#cb46-196" aria-hidden="true" tabindex="-1"></a>(and also give near-zero weight to clearly inappropriate models).</span>
<span id="cb46-197"><a href="#cb46-197" aria-hidden="true" tabindex="-1"></a>So, - given enough data - it effectively results in model selection, but as long as we only have limited information multiple models will contribute to our inference.</span>
<span id="cb46-198"><a href="#cb46-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-199"><a href="#cb46-199" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Gould</span><span class="co">](https://doi.org/10.1002/bimj.201700211)</span> proposes to use a weighted combination of the predictions for each dose level from each of the candidate models </span>
<span id="cb46-200"><a href="#cb46-200" aria-hidden="true" tabindex="-1"></a>and suggests to base the posterior model weigths on <span class="co">[</span><span class="ot">predictive likelihood weights</span><span class="co">](https://doi.org/10.1016/j.ijforecast.2009.08.001)</span>.</span>
<span id="cb46-201"><a href="#cb46-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-202"><a href="#cb46-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-203"><a href="#cb46-203" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementation and results</span></span>
<span id="cb46-204"><a href="#cb46-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-205"><a href="#cb46-205" aria-hidden="true" tabindex="-1"></a>We will now fit the various dose response models introduced in the statistical model section using <span class="in">`brms`</span>. </span>
<span id="cb46-206"><a href="#cb46-206" aria-hidden="true" tabindex="-1"></a>We will start with the sigmoid-Emax model and look at the things <span class="in">`brms`</span> let us do easily with a single fitted model.</span>
<span id="cb46-207"><a href="#cb46-207" aria-hidden="true" tabindex="-1"></a>We will not repeat that level of exploration for other models, but you may wish to do so in practice.</span>
<span id="cb46-208"><a href="#cb46-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-209"><a href="#cb46-209" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fitting dose response models with `brms`: sigmoid-Emax model</span></span>
<span id="cb46-210"><a href="#cb46-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-211"><a href="#cb46-211" aria-hidden="true" tabindex="-1"></a>We use the capabilities of <span class="in">`brms`</span> for fitting non-linear models. For example, a sigmoid-Emax model can be fitted as follows:</span>
<span id="cb46-212"><a href="#cb46-212" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fit_sigemax, results='hide', message=FALSE, warning=FALSE}</span></span>
<span id="cb46-213"><a href="#cb46-213" aria-hidden="true" tabindex="-1"></a><span class="in"># Fitting a sigmoid Emax model</span></span>
<span id="cb46-214"><a href="#cb46-214" aria-hidden="true" tabindex="-1"></a><span class="in">brmfit1 &lt;-  brm( bf( est | se(stderr) ~ E0 + Emax * dose^h/(dose^h + ED50^h),</span></span>
<span id="cb46-215"><a href="#cb46-215" aria-hidden="true" tabindex="-1"></a><span class="in">                    nlf(h ~ exp(logh)), nlf(ED50 ~ exp(logED50)),</span></span>
<span id="cb46-216"><a href="#cb46-216" aria-hidden="true" tabindex="-1"></a><span class="in">                    E0 ~ 1, logED50 ~ 1, logh ~ 1, Emax ~ 1, </span></span>
<span id="cb46-217"><a href="#cb46-217" aria-hidden="true" tabindex="-1"></a><span class="in">                    nl=TRUE, family=gaussian()),</span></span>
<span id="cb46-218"><a href="#cb46-218" aria-hidden="true" tabindex="-1"></a><span class="in">                data=pathway,</span></span>
<span id="cb46-219"><a href="#cb46-219" aria-hidden="true" tabindex="-1"></a><span class="in">                prior = c(prior(normal(0,1), nlpar="E0"),</span></span>
<span id="cb46-220"><a href="#cb46-220" aria-hidden="true" tabindex="-1"></a><span class="in">                          prior(normal(0,1), nlpar="logh"),</span></span>
<span id="cb46-221"><a href="#cb46-221" aria-hidden="true" tabindex="-1"></a><span class="in">                          prior(normal(0,1), nlpar="Emax"),</span></span>
<span id="cb46-222"><a href="#cb46-222" aria-hidden="true" tabindex="-1"></a><span class="in">                          prior(normal(4,2), nlpar="logED50")),</span></span>
<span id="cb46-223"><a href="#cb46-223" aria-hidden="true" tabindex="-1"></a><span class="in">                control=list(adapt_delta=0.999),</span></span>
<span id="cb46-224"><a href="#cb46-224" aria-hidden="true" tabindex="-1"></a><span class="in">                seed=3624)</span></span>
<span id="cb46-225"><a href="#cb46-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-226"><a href="#cb46-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-227"><a href="#cb46-227" aria-hidden="true" tabindex="-1"></a>Note that with individual patient data, we would not write <span class="in">`est | se(stderr) ~`</span>,</span>
<span id="cb46-228"><a href="#cb46-228" aria-hidden="true" tabindex="-1"></a>but would instead use <span class="in">`outcome ~ `</span> and  <span class="in">`bf() + negbinomial()`</span> </span>
<span id="cb46-229"><a href="#cb46-229" aria-hidden="true" tabindex="-1"></a>(and similarly, e.g. <span class="in">`+ gaussian()`</span> for continuous data). With the settings above,</span>
<span id="cb46-230"><a href="#cb46-230" aria-hidden="true" tabindex="-1"></a>you might still experience a divergent transition or two and you may wish to increase</span>
<span id="cb46-231"><a href="#cb46-231" aria-hidden="true" tabindex="-1"></a><span class="in">`adapt_delta`</span> to <span class="in">`0.9999`</span> or <span class="in">`0.99999`</span>, or alternatively try to come up with a way </span>
<span id="cb46-232"><a href="#cb46-232" aria-hidden="true" tabindex="-1"></a>to reparameterize the model.</span>
<span id="cb46-233"><a href="#cb46-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-234"><a href="#cb46-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r summarize_fit1}</span></span>
<span id="cb46-235"><a href="#cb46-235" aria-hidden="true" tabindex="-1"></a><span class="in"># Summarize model fit</span></span>
<span id="cb46-236"><a href="#cb46-236" aria-hidden="true" tabindex="-1"></a><span class="in">summary(brmfit1)</span></span>
<span id="cb46-237"><a href="#cb46-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-238"><a href="#cb46-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-239"><a href="#cb46-239" aria-hidden="true" tabindex="-1"></a>So what does the model fit look like? We have two options for looking at this. </span>
<span id="cb46-240"><a href="#cb46-240" aria-hidden="true" tabindex="-1"></a>The easiest and fastest uses the <span class="in">`conditional_effects`</span> function from <span class="in">`brms`</span>.</span>
<span id="cb46-241"><a href="#cb46-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb46-242"><a href="#cb46-242" aria-hidden="true" tabindex="-1"></a><span class="in">plot(conditional_effects(brmfit1, "dose"), </span></span>
<span id="cb46-243"><a href="#cb46-243" aria-hidden="true" tabindex="-1"></a><span class="in">     points = TRUE)</span></span>
<span id="cb46-244"><a href="#cb46-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-245"><a href="#cb46-245" aria-hidden="true" tabindex="-1"></a>The downside is that in a controlled trial we are primarily interested in </span>
<span id="cb46-246"><a href="#cb46-246" aria-hidden="true" tabindex="-1"></a>the contrast with placebo and that we would like to see the confidence</span>
<span id="cb46-247"><a href="#cb46-247" aria-hidden="true" tabindex="-1"></a>intervals around the point estimates for each dose. We can obtain that </span>
<span id="cb46-248"><a href="#cb46-248" aria-hidden="true" tabindex="-1"></a>with a little bit more code:</span>
<span id="cb46-249"><a href="#cb46-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r predict_sigemax, results='hide'}</span></span>
<span id="cb46-250"><a href="#cb46-250" aria-hidden="true" tabindex="-1"></a><span class="in"># We are going to predict the annualized rate for all doses from 0,1,2,...600.</span></span>
<span id="cb46-251"><a href="#cb46-251" aria-hidden="true" tabindex="-1"></a><span class="in"># We are setting stderr=0 to avoid predicting with sampling variability.</span></span>
<span id="cb46-252"><a href="#cb46-252" aria-hidden="true" tabindex="-1"></a><span class="in">dr_curve_data = tibble(dose=as.integer(seq(0,600)), stderr=0)</span></span>
<span id="cb46-253"><a href="#cb46-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-254"><a href="#cb46-254" aria-hidden="true" tabindex="-1"></a><span class="in"># Now we get the predictions and turn this into a dataset with one row per dose per MCMC sample</span></span>
<span id="cb46-255"><a href="#cb46-255" aria-hidden="true" tabindex="-1"></a><span class="in">dr_curve_pred &lt;- tidybayes::add_predicted_draws(dr_curve_data, brmfit1) %&gt;%</span></span>
<span id="cb46-256"><a href="#cb46-256" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;%</span></span>
<span id="cb46-257"><a href="#cb46-257" aria-hidden="true" tabindex="-1"></a><span class="in">  transmute(dose, .sample = .draw, pred = .prediction)</span></span>
<span id="cb46-258"><a href="#cb46-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-259"><a href="#cb46-259" aria-hidden="true" tabindex="-1"></a><span class="in"># Now we get the rate ratio by subtracting the annualized placebo rate for each MCMC sample  </span></span>
<span id="cb46-260"><a href="#cb46-260" aria-hidden="true" tabindex="-1"></a><span class="in">dr_curve_pred = dr_curve_pred %&gt;%</span></span>
<span id="cb46-261"><a href="#cb46-261" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(dr_curve_pred  %&gt;% </span></span>
<span id="cb46-262"><a href="#cb46-262" aria-hidden="true" tabindex="-1"></a><span class="in">              filter(dose==0) %&gt;% </span></span>
<span id="cb46-263"><a href="#cb46-263" aria-hidden="true" tabindex="-1"></a><span class="in">              dplyr::select(-dose) %&gt;% </span></span>
<span id="cb46-264"><a href="#cb46-264" aria-hidden="true" tabindex="-1"></a><span class="in">              rename(placebo=pred), </span></span>
<span id="cb46-265"><a href="#cb46-265" aria-hidden="true" tabindex="-1"></a><span class="in">            by=".sample") %&gt;%</span></span>
<span id="cb46-266"><a href="#cb46-266" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(logRR = pred - placebo) %&gt;%</span></span>
<span id="cb46-267"><a href="#cb46-267" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(dose, .sample, logRR)</span></span>
<span id="cb46-268"><a href="#cb46-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-269"><a href="#cb46-269" aria-hidden="true" tabindex="-1"></a><span class="in"># Now we get median prediction, 50 and 95% credible intervals </span></span>
<span id="cb46-270"><a href="#cb46-270" aria-hidden="true" tabindex="-1"></a><span class="in"># and plot those with the original data overlaid.</span></span>
<span id="cb46-271"><a href="#cb46-271" aria-hidden="true" tabindex="-1"></a><span class="in">p1 = dr_curve_pred  %&gt;%</span></span>
<span id="cb46-272"><a href="#cb46-272" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(-.sample) %&gt;%</span></span>
<span id="cb46-273"><a href="#cb46-273" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(dose) %&gt;%</span></span>
<span id="cb46-274"><a href="#cb46-274" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(.width = c(0.5, 0.95)) %&gt;%</span></span>
<span id="cb46-275"><a href="#cb46-275" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;%</span></span>
<span id="cb46-276"><a href="#cb46-276" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=dose, y=logRR, ymin=.lower, ymax=.upper)) +</span></span>
<span id="cb46-277"><a href="#cb46-277" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept=0)  +</span></span>
<span id="cb46-278"><a href="#cb46-278" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(data=.%&gt;% filter(.width==0.95), fill="red", alpha=0.5) +</span></span>
<span id="cb46-279"><a href="#cb46-279" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(data=.%&gt;% filter(.width==0.5), fill="red", alpha=0.5) +</span></span>
<span id="cb46-280"><a href="#cb46-280" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(data=.%&gt;% filter(.width==0.5), col="darkred") +</span></span>
<span id="cb46-281"><a href="#cb46-281" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data=pathway_deltas) +</span></span>
<span id="cb46-282"><a href="#cb46-282" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data=pathway_deltas, width=10) +</span></span>
<span id="cb46-283"><a href="#cb46-283" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(data=tibble(dose=300, logRR=log(0.6), .lower=NA_real_, .upper=NA_real_),</span></span>
<span id="cb46-284"><a href="#cb46-284" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(label="SigMod Emax model fit"), col="darkred", size=4) +</span></span>
<span id="cb46-285"><a href="#cb46-285" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks=log(c(0.2, 0.3, 0.4, 0.5, 0.6, 0.75, 1)), </span></span>
<span id="cb46-286"><a href="#cb46-286" aria-hidden="true" tabindex="-1"></a><span class="in">                     labels=paste(100*(1-c(0.2, 0.3, 0.4, 0.5, 0.6, 0.75, 1)), "%")) +</span></span>
<span id="cb46-287"><a href="#cb46-287" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Relative rate reduction") +</span></span>
<span id="cb46-288"><a href="#cb46-288" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Total tezepelumab dose [mg/month]")</span></span>
<span id="cb46-289"><a href="#cb46-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-290"><a href="#cb46-290" aria-hidden="true" tabindex="-1"></a><span class="in">plot(p1)</span></span>
<span id="cb46-291"><a href="#cb46-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-292"><a href="#cb46-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-293"><a href="#cb46-293" aria-hidden="true" tabindex="-1"></a>We can also plot the dose response curve for each MCMC sample:</span>
<span id="cb46-294"><a href="#cb46-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot_each_curve}</span></span>
<span id="cb46-295"><a href="#cb46-295" aria-hidden="true" tabindex="-1"></a><span class="in"> dr_curve_pred  %&gt;%</span></span>
<span id="cb46-296"><a href="#cb46-296" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=dose, y=logRR, group=factor(.sample))) +</span></span>
<span id="cb46-297"><a href="#cb46-297" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept=0)  +</span></span>
<span id="cb46-298"><a href="#cb46-298" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(col="darkred", alpha=0.1, size=0.25) +</span></span>
<span id="cb46-299"><a href="#cb46-299" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data=pathway_deltas %&gt;% mutate(.sample=NA_integer_)) +</span></span>
<span id="cb46-300"><a href="#cb46-300" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data=pathway_deltas %&gt;% mutate(.sample=NA_integer_), </span></span>
<span id="cb46-301"><a href="#cb46-301" aria-hidden="true" tabindex="-1"></a><span class="in">                aes(ymin=.lower, ymax=.upper), width=10) +</span></span>
<span id="cb46-302"><a href="#cb46-302" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks=log(c(0.2, 0.3, 0.4, 0.5, 0.6, 0.75, 1)), </span></span>
<span id="cb46-303"><a href="#cb46-303" aria-hidden="true" tabindex="-1"></a><span class="in">                     labels=paste(100*(1-c(0.2, 0.3, 0.4, 0.5, 0.6, 0.75, 1)), "%")) +</span></span>
<span id="cb46-304"><a href="#cb46-304" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Relative rate reduction") +</span></span>
<span id="cb46-305"><a href="#cb46-305" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Total tezepelumab dose [mg/month]")</span></span>
<span id="cb46-306"><a href="#cb46-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-307"><a href="#cb46-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-308"><a href="#cb46-308" aria-hidden="true" tabindex="-1"></a>Note, that this also makes it really easy to determine a distribution for the lowest dose that achieves a 50% relative rate reduction:</span>
<span id="cb46-309"><a href="#cb46-309" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot_dose_with_50rrr, results='hide'}</span></span>
<span id="cb46-310"><a href="#cb46-310" aria-hidden="true" tabindex="-1"></a><span class="in">dr_curve_pred  %&gt;%</span></span>
<span id="cb46-311"><a href="#cb46-311" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(logRR&lt;log(0.5) | (logRR&gt;=log(0.5) &amp; dose==600)) %&gt;%</span></span>
<span id="cb46-312"><a href="#cb46-312" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(.sample) %&gt;%</span></span>
<span id="cb46-313"><a href="#cb46-313" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(dose = min(dose), logRR=max(logRR)) %&gt;%</span></span>
<span id="cb46-314"><a href="#cb46-314" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(`Has 50% RRR`=(logRR&lt;log(0.5))) %&gt;%</span></span>
<span id="cb46-315"><a href="#cb46-315" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=dose, y="Dose with\n&gt;50% RRR")) +</span></span>
<span id="cb46-316"><a href="#cb46-316" aria-hidden="true" tabindex="-1"></a><span class="in">  stat_halfeye() +</span></span>
<span id="cb46-317"><a href="#cb46-317" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(xlim=c(0,200)) +</span></span>
<span id="cb46-318"><a href="#cb46-318" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Tezepelumab dose [mg/month]") +</span></span>
<span id="cb46-319"><a href="#cb46-319" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("")</span></span>
<span id="cb46-320"><a href="#cb46-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-321"><a href="#cb46-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-322"><a href="#cb46-322" aria-hidden="true" tabindex="-1"></a>As the plot below shows the data resulted in a substantially different posterior distribution compared with the prior distribution </span>
<span id="cb46-323"><a href="#cb46-323" aria-hidden="true" tabindex="-1"></a>for the <span class="in">`logED50`</span> parameter and the <span class="in">`Emax`</span> parameter. </span>
<span id="cb46-324"><a href="#cb46-324" aria-hidden="true" tabindex="-1"></a>These parameters are reasonably well-identified even with just 3 doses - although the ED50 would be better estimated, </span>
<span id="cb46-325"><a href="#cb46-325" aria-hidden="true" tabindex="-1"></a>if doses with approximately 50\% of the Emax (maximum relative rate reduction) had been included in the study. </span>
<span id="cb46-326"><a href="#cb46-326" aria-hidden="true" tabindex="-1"></a>In contrast, the log-Hill-parameter is poorly identified, when there are very few doses (as in this study), </span>
<span id="cb46-327"><a href="#cb46-327" aria-hidden="true" tabindex="-1"></a>which is why the posterior distribution is more or less the prior distribution for the <span class="in">`logED50`</span> parameter.   </span>
<span id="cb46-328"><a href="#cb46-328" aria-hidden="true" tabindex="-1"></a><span class="in">```{r paramident}</span></span>
<span id="cb46-329"><a href="#cb46-329" aria-hidden="true" tabindex="-1"></a><span class="in">brmfit1 %&gt;%</span></span>
<span id="cb46-330"><a href="#cb46-330" aria-hidden="true" tabindex="-1"></a><span class="in">  spread_draws(b_logED50_Intercept, b_logh_Intercept, b_Emax_Intercept) %&gt;%</span></span>
<span id="cb46-331"><a href="#cb46-331" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(cols=c("b_logED50_Intercept", "b_logh_Intercept", "b_Emax_Intercept")) %&gt;%</span></span>
<span id="cb46-332"><a href="#cb46-332" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=value)) +</span></span>
<span id="cb46-333"><a href="#cb46-333" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_bw(base_size=16) +</span></span>
<span id="cb46-334"><a href="#cb46-334" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_density() +</span></span>
<span id="cb46-335"><a href="#cb46-335" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(data=tibble(name=c(rep("b_logED50_Intercept",151),</span></span>
<span id="cb46-336"><a href="#cb46-336" aria-hidden="true" tabindex="-1"></a><span class="in">                               rep("b_logh_Intercept",71),</span></span>
<span id="cb46-337"><a href="#cb46-337" aria-hidden="true" tabindex="-1"></a><span class="in">                               rep("b_Emax_Intercept",61)),</span></span>
<span id="cb46-338"><a href="#cb46-338" aria-hidden="true" tabindex="-1"></a><span class="in">                        xval = c(seq(-5,10,0.1),</span></span>
<span id="cb46-339"><a href="#cb46-339" aria-hidden="true" tabindex="-1"></a><span class="in">                                 seq(-3,4,0.1),</span></span>
<span id="cb46-340"><a href="#cb46-340" aria-hidden="true" tabindex="-1"></a><span class="in">                                 seq(-3,3,0.1)),</span></span>
<span id="cb46-341"><a href="#cb46-341" aria-hidden="true" tabindex="-1"></a><span class="in">                        density=</span></span>
<span id="cb46-342"><a href="#cb46-342" aria-hidden="true" tabindex="-1"></a><span class="in">                          case_when(str_detect(name,"ED50") ~ dnorm(xval,mean=4,sd=2),</span></span>
<span id="cb46-343"><a href="#cb46-343" aria-hidden="true" tabindex="-1"></a><span class="in">                                    str_detect(name,"logh") ~  dnorm(xval,mean=0,sd=1),</span></span>
<span id="cb46-344"><a href="#cb46-344" aria-hidden="true" tabindex="-1"></a><span class="in">                                    TRUE ~ dnorm(xval,mean=0,sd=1))),</span></span>
<span id="cb46-345"><a href="#cb46-345" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(x=xval, y=density), col="red") +</span></span>
<span id="cb46-346"><a href="#cb46-346" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(data=tibble(name="b_Emax_Intercept", density=0.6, xval=1),</span></span>
<span id="cb46-347"><a href="#cb46-347" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(x=xval, y=density, label="prior"), col="red", size=8) +</span></span>
<span id="cb46-348"><a href="#cb46-348" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(data=tibble(name="b_Emax_Intercept", density=1, xval=0.5),</span></span>
<span id="cb46-349"><a href="#cb46-349" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(x=xval, y=density, label="posterior"), col="black", size=8) +</span></span>
<span id="cb46-350"><a href="#cb46-350" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~name, scales = "free")</span></span>
<span id="cb46-351"><a href="#cb46-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-352"><a href="#cb46-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-353"><a href="#cb46-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-354"><a href="#cb46-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-355"><a href="#cb46-355" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fitting dose response models with `brms`: modified beta model</span></span>
<span id="cb46-356"><a href="#cb46-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-357"><a href="#cb46-357" aria-hidden="true" tabindex="-1"></a>We now fit the modified beta model that can capture non-monotone dose response relationships.</span>
<span id="cb46-358"><a href="#cb46-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-359"><a href="#cb46-359" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fit_modbeta, results='hide', message = FALSE}</span></span>
<span id="cb46-360"><a href="#cb46-360" aria-hidden="true" tabindex="-1"></a><span class="in"># Try a modified beta model</span></span>
<span id="cb46-361"><a href="#cb46-361" aria-hidden="true" tabindex="-1"></a><span class="in">brmfit2 &lt;-  brm( bf( est | se(stderr) ~ E0 + Emax*(delta1+delta2)^(delta1+delta2)/(delta1^delta1*delta2^delta2)*(dose/850)^delta1*(1-dose/850)^delta2,</span></span>
<span id="cb46-362"><a href="#cb46-362" aria-hidden="true" tabindex="-1"></a><span class="in">                   E0 ~ 1, delta1 ~ 1, delta2 ~ 1, Emax ~ 1,</span></span>
<span id="cb46-363"><a href="#cb46-363" aria-hidden="true" tabindex="-1"></a><span class="in">                   nl=TRUE, </span></span>
<span id="cb46-364"><a href="#cb46-364" aria-hidden="true" tabindex="-1"></a><span class="in">                   family = gaussian()),</span></span>
<span id="cb46-365"><a href="#cb46-365" aria-hidden="true" tabindex="-1"></a><span class="in">               data=pathway,</span></span>
<span id="cb46-366"><a href="#cb46-366" aria-hidden="true" tabindex="-1"></a><span class="in">               prior = c(prior(normal(0,1), nlpar="E0"),</span></span>
<span id="cb46-367"><a href="#cb46-367" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(normal(0,1), nlpar="Emax"),</span></span>
<span id="cb46-368"><a href="#cb46-368" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(lognormal(0,1), nlpar="delta1", lb=0),</span></span>
<span id="cb46-369"><a href="#cb46-369" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(lognormal(0,1), nlpar="delta2", lb=0)),</span></span>
<span id="cb46-370"><a href="#cb46-370" aria-hidden="true" tabindex="-1"></a><span class="in">               control=list(adapt_delta=0.999),</span></span>
<span id="cb46-371"><a href="#cb46-371" aria-hidden="true" tabindex="-1"></a><span class="in">               save_pars = save_pars(all = TRUE),</span></span>
<span id="cb46-372"><a href="#cb46-372" aria-hidden="true" tabindex="-1"></a><span class="in">               seed = 7304)</span></span>
<span id="cb46-373"><a href="#cb46-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-374"><a href="#cb46-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-375"><a href="#cb46-375" aria-hidden="true" tabindex="-1"></a>Let us summarize the model fit:</span>
<span id="cb46-376"><a href="#cb46-376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r summarize_modbetafit}</span></span>
<span id="cb46-377"><a href="#cb46-377" aria-hidden="true" tabindex="-1"></a><span class="in">summary(brmfit2)</span></span>
<span id="cb46-378"><a href="#cb46-378" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-379"><a href="#cb46-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-380"><a href="#cb46-380" aria-hidden="true" tabindex="-1"></a>So what does the model fit look like? We could, again, just use </span>
<span id="cb46-381"><a href="#cb46-381" aria-hidden="true" tabindex="-1"></a><span class="in">`plot(conditional_effects(brmfit2, "dose"), points = TRUE)`</span> or </span>
<span id="cb46-382"><a href="#cb46-382" aria-hidden="true" tabindex="-1"></a>get a slightly more tailored plot.</span>
<span id="cb46-383"><a href="#cb46-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r predict_modbeta}</span></span>
<span id="cb46-384"><a href="#cb46-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-385"><a href="#cb46-385" aria-hidden="true" tabindex="-1"></a><span class="in"># Now we get the predictions and turn this into a dataset with one row per dose per MCMC sample</span></span>
<span id="cb46-386"><a href="#cb46-386" aria-hidden="true" tabindex="-1"></a><span class="in">dr_curve_pred2 &lt;- tidybayes::add_predicted_draws(dr_curve_data, brmfit2) %&gt;%</span></span>
<span id="cb46-387"><a href="#cb46-387" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;%</span></span>
<span id="cb46-388"><a href="#cb46-388" aria-hidden="true" tabindex="-1"></a><span class="in">  transmute(dose, .sample = .draw, pred = .prediction)</span></span>
<span id="cb46-389"><a href="#cb46-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-390"><a href="#cb46-390" aria-hidden="true" tabindex="-1"></a><span class="in"># Now we get the rate ratio by subtracting the annualized placebo rate for each MCMC sample  </span></span>
<span id="cb46-391"><a href="#cb46-391" aria-hidden="true" tabindex="-1"></a><span class="in">dr_curve_pred2 = dr_curve_pred2 %&gt;%</span></span>
<span id="cb46-392"><a href="#cb46-392" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(dr_curve_pred2  %&gt;% </span></span>
<span id="cb46-393"><a href="#cb46-393" aria-hidden="true" tabindex="-1"></a><span class="in">              filter(dose==0) %&gt;% </span></span>
<span id="cb46-394"><a href="#cb46-394" aria-hidden="true" tabindex="-1"></a><span class="in">              dplyr::select(-dose) %&gt;% </span></span>
<span id="cb46-395"><a href="#cb46-395" aria-hidden="true" tabindex="-1"></a><span class="in">              rename(placebo=pred), </span></span>
<span id="cb46-396"><a href="#cb46-396" aria-hidden="true" tabindex="-1"></a><span class="in">            by=".sample") %&gt;%</span></span>
<span id="cb46-397"><a href="#cb46-397" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(logRR = pred - placebo) %&gt;%</span></span>
<span id="cb46-398"><a href="#cb46-398" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(dose, .sample, logRR)</span></span>
<span id="cb46-399"><a href="#cb46-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-400"><a href="#cb46-400" aria-hidden="true" tabindex="-1"></a><span class="in"># Now we get median prediction, 50 and 95% credible intervals </span></span>
<span id="cb46-401"><a href="#cb46-401" aria-hidden="true" tabindex="-1"></a><span class="in"># and plot those with the original data overlaid.</span></span>
<span id="cb46-402"><a href="#cb46-402" aria-hidden="true" tabindex="-1"></a><span class="in">p2 = dr_curve_pred2  %&gt;%</span></span>
<span id="cb46-403"><a href="#cb46-403" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(-.sample) %&gt;%</span></span>
<span id="cb46-404"><a href="#cb46-404" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(dose) %&gt;%</span></span>
<span id="cb46-405"><a href="#cb46-405" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(.width = c(0.5, 0.95)) %&gt;%</span></span>
<span id="cb46-406"><a href="#cb46-406" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;%</span></span>
<span id="cb46-407"><a href="#cb46-407" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=dose, y=logRR, ymin=.lower, ymax=.upper)) +</span></span>
<span id="cb46-408"><a href="#cb46-408" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept=0)  +</span></span>
<span id="cb46-409"><a href="#cb46-409" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(data=.%&gt;% filter(.width==0.95), fill="royalblue", alpha=0.5) +</span></span>
<span id="cb46-410"><a href="#cb46-410" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(data=.%&gt;% filter(.width==0.5), fill="royalblue", alpha=0.5) +</span></span>
<span id="cb46-411"><a href="#cb46-411" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(data=.%&gt;% filter(.width==0.5), col="darkblue") +</span></span>
<span id="cb46-412"><a href="#cb46-412" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data=pathway_deltas) +</span></span>
<span id="cb46-413"><a href="#cb46-413" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data=pathway_deltas, width=10) +</span></span>
<span id="cb46-414"><a href="#cb46-414" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(data=tibble(dose=300, logRR=log(0.6), .lower=NA_real_, .upper=NA_real_),</span></span>
<span id="cb46-415"><a href="#cb46-415" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(label="modified-beta model fit"), col="darkblue", size=4) +</span></span>
<span id="cb46-416"><a href="#cb46-416" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks=log(c(0.2, 0.3, 0.4, 0.5, 0.6, 0.75, 1)), </span></span>
<span id="cb46-417"><a href="#cb46-417" aria-hidden="true" tabindex="-1"></a><span class="in">                     labels=paste(100*(1-c(0.2, 0.3, 0.4, 0.5, 0.6, 0.75, 1)), "%")) +</span></span>
<span id="cb46-418"><a href="#cb46-418" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Relative rate reduction") +</span></span>
<span id="cb46-419"><a href="#cb46-419" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Total tezepelumab dose [mg/month]")</span></span>
<span id="cb46-420"><a href="#cb46-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-421"><a href="#cb46-421" aria-hidden="true" tabindex="-1"></a><span class="in">plot(p2)</span></span>
<span id="cb46-422"><a href="#cb46-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-423"><a href="#cb46-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-424"><a href="#cb46-424" aria-hidden="true" tabindex="-1"></a><span class="fu">### Perform Bayesian model averaging</span></span>
<span id="cb46-425"><a href="#cb46-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-426"><a href="#cb46-426" aria-hidden="true" tabindex="-1"></a>Now we have two fitted model. We can see both of them together below:</span>
<span id="cb46-427"><a href="#cb46-427" aria-hidden="true" tabindex="-1"></a><span class="in">```{r show_both_plots, fig.width = 10}</span></span>
<span id="cb46-428"><a href="#cb46-428" aria-hidden="true" tabindex="-1"></a><span class="in">p1 + p2</span></span>
<span id="cb46-429"><a href="#cb46-429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-430"><a href="#cb46-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-431"><a href="#cb46-431" aria-hidden="true" tabindex="-1"></a>In practice, we do not really know, whether one of these is the true data generating model. </span>
<span id="cb46-432"><a href="#cb46-432" aria-hidden="true" tabindex="-1"></a>In fact, realistically both models are going to be at least somewhat misspecified, </span>
<span id="cb46-433"><a href="#cb46-433" aria-hidden="true" tabindex="-1"></a>because we made no attempt to fully model the full complexity of the underlying biological system. </span>
<span id="cb46-434"><a href="#cb46-434" aria-hidden="true" tabindex="-1"></a>So, really, the question is which of the two models provides the better approximation. </span>
<span id="cb46-435"><a href="#cb46-435" aria-hidden="true" tabindex="-1"></a>At a glance both seem to fit the data somewhat decently, so it seems unlikely that we can completely rule one of the two models out. </span>
<span id="cb46-436"><a href="#cb46-436" aria-hidden="true" tabindex="-1"></a>That is where Bayesian model averaging comes in. </span>
<span id="cb46-437"><a href="#cb46-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-438"><a href="#cb46-438" aria-hidden="true" tabindex="-1"></a>First, we need to compare how well each model fits. </span>
<span id="cb46-439"><a href="#cb46-439" aria-hidden="true" tabindex="-1"></a>As it turns out, when you just have 4 data points </span>
<span id="cb46-440"><a href="#cb46-440" aria-hidden="true" tabindex="-1"></a>(due to us using summary data), it is problematic</span>
<span id="cb46-441"><a href="#cb46-441" aria-hidden="true" tabindex="-1"></a>to just use the "standard" <span class="in">`brms::loo`</span> function to</span>
<span id="cb46-442"><a href="#cb46-442" aria-hidden="true" tabindex="-1"></a>perform approximate leave-one-out cross-validation (LOO-CV)</span>
<span id="cb46-443"><a href="#cb46-443" aria-hidden="true" tabindex="-1"></a>based on the posterior likelihood as implemented</span>
<span id="cb46-444"><a href="#cb46-444" aria-hidden="true" tabindex="-1"></a>in the <span class="in">`loo`</span> package, as can be seen by running</span>
<span id="cb46-445"><a href="#cb46-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loo_1}</span></span>
<span id="cb46-446"><a href="#cb46-446" aria-hidden="true" tabindex="-1"></a><span class="in">loo(brmfit1)</span></span>
<span id="cb46-447"><a href="#cb46-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-448"><a href="#cb46-448" aria-hidden="true" tabindex="-1"></a>and</span>
<span id="cb46-449"><a href="#cb46-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loo_2}</span></span>
<span id="cb46-450"><a href="#cb46-450" aria-hidden="true" tabindex="-1"></a><span class="in">loo(brmfit2)</span></span>
<span id="cb46-451"><a href="#cb46-451" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-452"><a href="#cb46-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-453"><a href="#cb46-453" aria-hidden="true" tabindex="-1"></a>Instead, we actually fit each model leaving each </span>
<span id="cb46-454"><a href="#cb46-454" aria-hidden="true" tabindex="-1"></a>dose group out. We could probably do something</span>
<span id="cb46-455"><a href="#cb46-455" aria-hidden="true" tabindex="-1"></a>more sophisticated by simulating consistent individual</span>
<span id="cb46-456"><a href="#cb46-456" aria-hidden="true" tabindex="-1"></a>patient data (and then performing approximate LOO-CV)</span>
<span id="cb46-457"><a href="#cb46-457" aria-hidden="true" tabindex="-1"></a>or parametric sampling from the normal distribution </span>
<span id="cb46-458"><a href="#cb46-458" aria-hidden="true" tabindex="-1"></a>around the point estimates.</span>
<span id="cb46-459"><a href="#cb46-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loo_exact, message = FALSE}</span></span>
<span id="cb46-460"><a href="#cb46-460" aria-hidden="true" tabindex="-1"></a><span class="in">(loo_exact_brmfit1 &lt;- kfold(brmfit1, folds = "loo"))</span></span>
<span id="cb46-461"><a href="#cb46-461" aria-hidden="true" tabindex="-1"></a><span class="in">(loo_exact_brmfit2 &lt;- kfold(brmfit2, folds = "loo"))</span></span>
<span id="cb46-462"><a href="#cb46-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-463"><a href="#cb46-463" aria-hidden="true" tabindex="-1"></a>Now, we can compare the models via</span>
<span id="cb46-464"><a href="#cb46-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r loo_compare}</span></span>
<span id="cb46-465"><a href="#cb46-465" aria-hidden="true" tabindex="-1"></a><span class="in">loo_compare(loo_exact_brmfit1, loo_exact_brmfit2)</span></span>
<span id="cb46-466"><a href="#cb46-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-467"><a href="#cb46-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-468"><a href="#cb46-468" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Approach 1 (manual without `brms`)</span></span>
<span id="cb46-469"><a href="#cb46-469" aria-hidden="true" tabindex="-1"></a>Let us say that we a-priori assign a 75% probability to the SigEmax model and 25% to the modified beta model.</span>
<span id="cb46-470"><a href="#cb46-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-471"><a href="#cb46-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{r get_post_wgts}</span></span>
<span id="cb46-472"><a href="#cb46-472" aria-hidden="true" tabindex="-1"></a><span class="in"># follows: </span></span>
<span id="cb46-473"><a href="#cb46-473" aria-hidden="true" tabindex="-1"></a><span class="in"># Gould, A. L. (2019). BMA‐Mod: A Bayesian model averaging strategy for determining dose‐response relationships in the presence of model uncertainty. Biometrical Journal, 61(5), 1141-1159.</span></span>
<span id="cb46-474"><a href="#cb46-474" aria-hidden="true" tabindex="-1"></a><span class="in"># https://dx.doi.org/10.1002/bimj.201700211</span></span>
<span id="cb46-475"><a href="#cb46-475" aria-hidden="true" tabindex="-1"></a><span class="in">prior_weights = c(0.75,0.25)</span></span>
<span id="cb46-476"><a href="#cb46-476" aria-hidden="true" tabindex="-1"></a><span class="in">posterior_weigths = c(prior_weights[1]*exp(loo_exact_brmfit1$estimates["elpd_kfold", "Estimate"]), </span></span>
<span id="cb46-477"><a href="#cb46-477" aria-hidden="true" tabindex="-1"></a><span class="in">                      prior_weights[2]*exp(loo_exact_brmfit2$estimates["elpd_kfold", "Estimate"]))</span></span>
<span id="cb46-478"><a href="#cb46-478" aria-hidden="true" tabindex="-1"></a><span class="in">(posterior_weigths = posterior_weigths/sum(posterior_weigths))</span></span>
<span id="cb46-479"><a href="#cb46-479" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-480"><a href="#cb46-480" aria-hidden="true" tabindex="-1"></a>As we can see, using leaving-one-dose-group out cross-validation, suggests that the SigEmax model should be given most of the weight.</span>
<span id="cb46-481"><a href="#cb46-481" aria-hidden="true" tabindex="-1"></a>A-posteriori, we assign <span class="in">`r 100*round(posterior_weigths[1], 3)`</span>\% weight to the SigEmax model and <span class="in">`r 100*round(posterior_weigths[2], 3)`</span>\% weight to the modified beta model. However, if we had done approximate LOO-CV with individual patient data, the modified beta model might have been given more weight.</span>
<span id="cb46-482"><a href="#cb46-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-483"><a href="#cb46-483" aria-hidden="true" tabindex="-1"></a>When we average the predictions of the two models with these weights, we get the dose response curve below.</span>
<span id="cb46-484"><a href="#cb46-484" aria-hidden="true" tabindex="-1"></a><span class="in">```{r bma_curves, fig.width=10, fig.height=10}</span></span>
<span id="cb46-485"><a href="#cb46-485" aria-hidden="true" tabindex="-1"></a><span class="in">bma_curve = dr_curve_pred %&gt;%</span></span>
<span id="cb46-486"><a href="#cb46-486" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_join(dr_curve_pred2, by=c(".sample", "dose")) %&gt;%</span></span>
<span id="cb46-487"><a href="#cb46-487" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(logRR = posterior_weigths[1]*logRR.x + posterior_weigths[2]*logRR.y) %&gt;%</span></span>
<span id="cb46-488"><a href="#cb46-488" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(-logRR.x, -logRR.y, -.sample) %&gt;%</span></span>
<span id="cb46-489"><a href="#cb46-489" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(dose) %&gt;%</span></span>
<span id="cb46-490"><a href="#cb46-490" aria-hidden="true" tabindex="-1"></a><span class="in">  median_qi(.width = c(0.5, 0.95))</span></span>
<span id="cb46-491"><a href="#cb46-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-492"><a href="#cb46-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-493"><a href="#cb46-493" aria-hidden="true" tabindex="-1"></a><span class="in">pbma = bma_curve %&gt;%</span></span>
<span id="cb46-494"><a href="#cb46-494" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=dose, y=logRR, ymin=.lower, ymax=.upper)) +</span></span>
<span id="cb46-495"><a href="#cb46-495" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept=0)  +</span></span>
<span id="cb46-496"><a href="#cb46-496" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(data=.%&gt;% filter(.width==0.95), fill="orange", alpha=0.5) +</span></span>
<span id="cb46-497"><a href="#cb46-497" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_ribbon(data=.%&gt;% filter(.width==0.5), fill="orange", alpha=0.5) +</span></span>
<span id="cb46-498"><a href="#cb46-498" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line(col="darkorange") +</span></span>
<span id="cb46-499"><a href="#cb46-499" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(data=pathway_deltas) +</span></span>
<span id="cb46-500"><a href="#cb46-500" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_errorbar(data=pathway_deltas, width=10) +</span></span>
<span id="cb46-501"><a href="#cb46-501" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(data=tibble(dose=300, logRR=log(0.6), .lower=NA_real_, .upper=NA_real_),</span></span>
<span id="cb46-502"><a href="#cb46-502" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(label="Bayesian model averaging"), col="darkorange", size=4) +</span></span>
<span id="cb46-503"><a href="#cb46-503" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(breaks=log(c(0.2, 0.3, 0.4, 0.5, 0.6, 0.75, 1)), </span></span>
<span id="cb46-504"><a href="#cb46-504" aria-hidden="true" tabindex="-1"></a><span class="in">                     labels=paste(100*(1-c(0.2, 0.3, 0.4, 0.5, 0.6, 0.75, 1)), "%")) +</span></span>
<span id="cb46-505"><a href="#cb46-505" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Relative rate reduction") +</span></span>
<span id="cb46-506"><a href="#cb46-506" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Total tezepelumab dose")</span></span>
<span id="cb46-507"><a href="#cb46-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-508"><a href="#cb46-508" aria-hidden="true" tabindex="-1"></a><span class="in">plot( ( (p1 + theme(axis.title.x=element_blank()) + ggtitle("Sigmoid Emax model")) | </span></span>
<span id="cb46-509"><a href="#cb46-509" aria-hidden="true" tabindex="-1"></a><span class="in">          (p2 + theme(axis.title.y=element_blank(),</span></span>
<span id="cb46-510"><a href="#cb46-510" aria-hidden="true" tabindex="-1"></a><span class="in">                      axis.title.x=element_blank()) + </span></span>
<span id="cb46-511"><a href="#cb46-511" aria-hidden="true" tabindex="-1"></a><span class="in">             ggtitle("Modified beta model"))) / </span></span>
<span id="cb46-512"><a href="#cb46-512" aria-hidden="true" tabindex="-1"></a><span class="in">        (pbma + ggtitle("Bayesian model averaging") | plot_spacer()) )</span></span>
<span id="cb46-513"><a href="#cb46-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-514"><a href="#cb46-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-515"><a href="#cb46-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-516"><a href="#cb46-516" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Approach 2: Using brms functions</span></span>
<span id="cb46-517"><a href="#cb46-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-518"><a href="#cb46-518" aria-hidden="true" tabindex="-1"></a>Before, we needed to do a lot of manual work to get model-averaged predictions, but the below using <span class="in">`brms::pp_average`</span> would be a lot simpler, if we could rely on the approximate LOO-CV.</span>
<span id="cb46-519"><a href="#cb46-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-520"><a href="#cb46-520" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Approach 2a: Not appropriate here</span></span>
<span id="cb46-521"><a href="#cb46-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-522"><a href="#cb46-522" aria-hidden="true" tabindex="-1"></a><span class="in">```{r brms_bma, eval=FALSE}</span></span>
<span id="cb46-523"><a href="#cb46-523" aria-hidden="true" tabindex="-1"></a><span class="in">bma_brms_curve = dr_curve_data %&gt;%</span></span>
<span id="cb46-524"><a href="#cb46-524" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(-stderr) %&gt;%</span></span>
<span id="cb46-525"><a href="#cb46-525" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_cols(as_tibble(</span></span>
<span id="cb46-526"><a href="#cb46-526" aria-hidden="true" tabindex="-1"></a><span class="in">    t(pp_average(brmfit1, brmfit2, newdata=dr_curve_data, </span></span>
<span id="cb46-527"><a href="#cb46-527" aria-hidden="true" tabindex="-1"></a><span class="in">                 weights="loo", # Not a good option in this case.</span></span>
<span id="cb46-528"><a href="#cb46-528" aria-hidden="true" tabindex="-1"></a><span class="in">                 summary=F)),</span></span>
<span id="cb46-529"><a href="#cb46-529" aria-hidden="true" tabindex="-1"></a><span class="in">    .name_repair=vctrs::vec_as_names(repair="unique", quiet =T))) %&gt;%</span></span>
<span id="cb46-530"><a href="#cb46-530" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(cols=starts_with("V"), names_to=".sample", values_to="pred") %&gt;%</span></span>
<span id="cb46-531"><a href="#cb46-531" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.sample = as.integer(str_extract(.sample, "[0-9]+")))</span></span>
<span id="cb46-532"><a href="#cb46-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-533"><a href="#cb46-533" aria-hidden="true" tabindex="-1"></a><span class="in"># Forming differences to placebo by merging with the placebo (dose=0) predictions for each sample</span></span>
<span id="cb46-534"><a href="#cb46-534" aria-hidden="true" tabindex="-1"></a><span class="in">bma_brms_curve = bma_brms_curve %&gt;%</span></span>
<span id="cb46-535"><a href="#cb46-535" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(bma_brms_curve  %&gt;% </span></span>
<span id="cb46-536"><a href="#cb46-536" aria-hidden="true" tabindex="-1"></a><span class="in">              filter(dose==0) %&gt;% </span></span>
<span id="cb46-537"><a href="#cb46-537" aria-hidden="true" tabindex="-1"></a><span class="in">              dplyr::select(-dose) %&gt;% </span></span>
<span id="cb46-538"><a href="#cb46-538" aria-hidden="true" tabindex="-1"></a><span class="in">              rename(placebo=pred), </span></span>
<span id="cb46-539"><a href="#cb46-539" aria-hidden="true" tabindex="-1"></a><span class="in">            by=".sample") %&gt;%</span></span>
<span id="cb46-540"><a href="#cb46-540" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(logRR = pred - placebo) %&gt;% # Calculate log rate ratio (difference on log scale vs. placebo)</span></span>
<span id="cb46-541"><a href="#cb46-541" aria-hidden="true" tabindex="-1"></a><span class="in">  dplyr::select(dose, .sample, logRR)</span></span>
<span id="cb46-542"><a href="#cb46-542" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-543"><a href="#cb46-543" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Approach 2b: Using leave-one-dose-out CV</span></span>
<span id="cb46-544"><a href="#cb46-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-545"><a href="#cb46-545" aria-hidden="true" tabindex="-1"></a>Because we want to avoid using approximate LOO-CV in this case, </span>
<span id="cb46-546"><a href="#cb46-546" aria-hidden="true" tabindex="-1"></a>we first replace the internally calculated approximate LOO-CV</span>
<span id="cb46-547"><a href="#cb46-547" aria-hidden="true" tabindex="-1"></a>results with our own</span>
<span id="cb46-550"><a href="#cb46-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-551"><a href="#cb46-551" aria-hidden="true" tabindex="-1"></a>brmfit1<span class="sc">$</span>criteria<span class="sc">$</span>loo <span class="ot">&lt;-</span> loo_exact_brmfit1</span>
<span id="cb46-552"><a href="#cb46-552" aria-hidden="true" tabindex="-1"></a>brmfit2<span class="sc">$</span>criteria<span class="sc">$</span>loo <span class="ot">&lt;-</span> loo_exact_brmfit2</span>
<span id="cb46-553"><a href="#cb46-553" aria-hidden="true" tabindex="-1"></a>(w_dose <span class="ot">&lt;-</span> <span class="fu">model_weights</span>(brmfit1, brmfit2, <span class="at">weights =</span> <span class="st">"loo"</span>))</span>
<span id="cb46-554"><a href="#cb46-554" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-555"><a href="#cb46-555" aria-hidden="true" tabindex="-1"></a>We can then do the following:</span>
<span id="cb46-558"><a href="#cb46-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb46-559"><a href="#cb46-559" aria-hidden="true" tabindex="-1"></a>bmapreds1 <span class="ot">&lt;-</span> <span class="fu">posterior_epred</span>(brmfit1, <span class="at">newdata =</span> dr_curve_data)</span>
<span id="cb46-560"><a href="#cb46-560" aria-hidden="true" tabindex="-1"></a>bmapreds2 <span class="ot">&lt;-</span> <span class="fu">posterior_epred</span>(brmfit2, <span class="at">newdata =</span> dr_curve_data)</span>
<span id="cb46-561"><a href="#cb46-561" aria-hidden="true" tabindex="-1"></a>pe_avg <span class="ot">&lt;-</span> bmapreds1 <span class="sc">*</span> w_dose[<span class="dv">1</span>] <span class="sc">+</span> bmapreds2 <span class="sc">*</span> w_dose[<span class="dv">2</span>]</span>
<span id="cb46-562"><a href="#cb46-562" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(pe_avg) <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pe_avg)</span>
<span id="cb46-563"><a href="#cb46-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-564"><a href="#cb46-564" aria-hidden="true" tabindex="-1"></a><span class="co"># log-rate predictions for each dose</span></span>
<span id="cb46-565"><a href="#cb46-565" aria-hidden="true" tabindex="-1"></a>pe_avg <span class="ot">=</span> pe_avg <span class="sc">%&gt;%</span> </span>
<span id="cb46-566"><a href="#cb46-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb46-567"><a href="#cb46-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-568"><a href="#cb46-568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(dr_curve_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(dose)) <span class="sc">%&gt;%</span></span>
<span id="cb46-569"><a href="#cb46-569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="sc">-</span>dose, <span class="at">names_to =</span> <span class="st">".sample"</span>, <span class="at">values_to=</span><span class="st">"pred"</span>) </span>
<span id="cb46-570"><a href="#cb46-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-571"><a href="#cb46-571" aria-hidden="true" tabindex="-1"></a><span class="co"># form difference to placebo (log-rate-ratio) and plot</span></span>
<span id="cb46-572"><a href="#cb46-572" aria-hidden="true" tabindex="-1"></a> pbma2 <span class="ot">=</span> pe_avg <span class="sc">%&gt;%</span></span>
<span id="cb46-573"><a href="#cb46-573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="at">y=</span>pe_avg <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dose<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dose), </span>
<span id="cb46-574"><a href="#cb46-574" aria-hidden="true" tabindex="-1"></a>            <span class="at">by=</span><span class="st">".sample"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-575"><a href="#cb46-575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">logRR=</span>pred.x<span class="sc">-</span>pred.y) <span class="sc">%&gt;%</span></span>
<span id="cb46-576"><a href="#cb46-576" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>.sample, <span class="sc">-</span>pred.x, <span class="sc">-</span>pred.y) <span class="sc">%&gt;%</span></span>
<span id="cb46-577"><a href="#cb46-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dose) <span class="sc">%&gt;%</span></span>
<span id="cb46-578"><a href="#cb46-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median_qi</span>(<span class="at">.width =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb46-579"><a href="#cb46-579" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-580"><a href="#cb46-580" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>dose, <span class="at">y=</span>logRR, <span class="at">ymin=</span>.lower, <span class="at">ymax=</span>.upper)) <span class="sc">+</span></span>
<span id="cb46-581"><a href="#cb46-581" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>)  <span class="sc">+</span></span>
<span id="cb46-582"><a href="#cb46-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.95</span>), <span class="at">fill=</span><span class="st">"green"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb46-583"><a href="#cb46-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.5</span>), <span class="at">fill=</span><span class="st">"darkgreen"</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb46-584"><a href="#cb46-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(.width<span class="sc">==</span><span class="fl">0.5</span>), <span class="at">col=</span><span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb46-585"><a href="#cb46-585" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data=</span>pathway_deltas) <span class="sc">+</span></span>
<span id="cb46-586"><a href="#cb46-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">data=</span>pathway_deltas, <span class="at">width=</span><span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb46-587"><a href="#cb46-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span><span class="fu">tibble</span>(<span class="at">dose=</span><span class="dv">300</span>, <span class="at">logRR=</span><span class="fu">log</span>(<span class="fl">0.6</span>), <span class="at">.lower=</span><span class="cn">NA_real_</span>, <span class="at">.upper=</span><span class="cn">NA_real_</span>),</span>
<span id="cb46-588"><a href="#cb46-588" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label=</span><span class="st">"BMA (LOO weights)"</span>), <span class="at">col=</span><span class="st">"darkgreen"</span>, <span class="at">size=</span><span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb46-589"><a href="#cb46-589" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks=</span><span class="fu">log</span>(<span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), </span>
<span id="cb46-590"><a href="#cb46-590" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels=</span><span class="fu">paste</span>(<span class="dv">100</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.75</span>, <span class="dv">1</span>)), <span class="st">"%"</span>)) <span class="sc">+</span></span>
<span id="cb46-591"><a href="#cb46-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Relative rate reduction"</span>) <span class="sc">+</span></span>
<span id="cb46-592"><a href="#cb46-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Total tezepelumab dose [mg/month]"</span>)</span>
<span id="cb46-593"><a href="#cb46-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-594"><a href="#cb46-594" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pbma2)</span>
<span id="cb46-595"><a href="#cb46-595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-596"><a href="#cb46-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-597"><a href="#cb46-597" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Why did we do this form of Bayesian model averaging?</span></span>
<span id="cb46-598"><a href="#cb46-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-599"><a href="#cb46-599" aria-hidden="true" tabindex="-1"></a>Why are we doing it like this? Can we not just fit a single model like this (as an example where we average a sigmoid-Emax and a modified beta model)?</span>
<span id="cb46-600"><a href="#cb46-600" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb46-601"><a href="#cb46-601" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb46-602"><a href="#cb46-602" aria-hidden="true" tabindex="-1"></a>f(\text{dose}; \text{parameters}) = &amp; \text{E}_0 + w \times \text{E}_{\text{max }1} \times \frac{\text{dose}^h}{\text{dose}^h + \text{ED}_{50}^h} <span class="sc">\\</span></span>
<span id="cb46-603"><a href="#cb46-603" aria-hidden="true" tabindex="-1"></a>  &amp; + (1-w) \times \text{E}_{\text{max }2} \times \frac{(\delta_1 + \delta_2)^{\delta_1 + \delta_2}}{\delta_1^{\delta_1} + \delta_2^{\delta_2}} \times (\frac{\text{dose}}{S})^{\delta_1} \times (1-\frac{\text{dose}}{S})^{\delta_2}</span>
<span id="cb46-604"><a href="#cb46-604" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb46-605"><a href="#cb46-605" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb46-606"><a href="#cb46-606" aria-hidden="true" tabindex="-1"></a><span class="in">`brms`</span> certainly lets us specify such a model (see below).</span>
<span id="cb46-607"><a href="#cb46-607" aria-hidden="true" tabindex="-1"></a>But, part of the reason why we do not use it, is that the model parameters are really badly identified: </span>
<span id="cb46-608"><a href="#cb46-608" aria-hidden="true" tabindex="-1"></a>you can still obtain a similarly good fit at each observed dose level by making one of the two models fit better for one dose (and worse for another dose), </span>
<span id="cb46-609"><a href="#cb46-609" aria-hidden="true" tabindex="-1"></a>if the other model in turn is made to fit worse for that dose (and better for the other dose).</span>
<span id="cb46-610"><a href="#cb46-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-611"><a href="#cb46-611" aria-hidden="true" tabindex="-1"></a>If you run the code below, you will see how much the sampler struggles to fit this model, if we try to fit it. That is the case, even if we make things easier and fix the model weights to 50:50.</span>
<span id="cb46-612"><a href="#cb46-612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fit_problem_model, eval=FALSE}</span></span>
<span id="cb46-613"><a href="#cb46-613" aria-hidden="true" tabindex="-1"></a><span class="in"># The model below does not work so well</span></span>
<span id="cb46-614"><a href="#cb46-614" aria-hidden="true" tabindex="-1"></a><span class="in">brmfit3 &lt;-  brm( bf( est | se(stderr) ~ E0 + 0.5 * Emax * dose^h/(dose^h + ED50^h) + 0.5*Emax2*(delta1+delta2)^(delta1+delta2)/(delta1^delta1*delta2^delta2)*(dose/850)^delta1*(1-dose/850)^delta2,</span></span>
<span id="cb46-615"><a href="#cb46-615" aria-hidden="true" tabindex="-1"></a><span class="in">                   E0 ~ 1, ED50 ~ 1, h ~ 1, Emax ~ 1,</span></span>
<span id="cb46-616"><a href="#cb46-616" aria-hidden="true" tabindex="-1"></a><span class="in">                   #modelwgt ~ 1,</span></span>
<span id="cb46-617"><a href="#cb46-617" aria-hidden="true" tabindex="-1"></a><span class="in">                   delta1 ~ 1, delta2 ~ 1, Emax2 ~ 1,</span></span>
<span id="cb46-618"><a href="#cb46-618" aria-hidden="true" tabindex="-1"></a><span class="in">                   nl=T),</span></span>
<span id="cb46-619"><a href="#cb46-619" aria-hidden="true" tabindex="-1"></a><span class="in">               data=pathway,</span></span>
<span id="cb46-620"><a href="#cb46-620" aria-hidden="true" tabindex="-1"></a><span class="in">               prior = c(prior(normal(0,1), nlpar="E0"),</span></span>
<span id="cb46-621"><a href="#cb46-621" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(lognormal(0,1), nlpar="h"),</span></span>
<span id="cb46-622"><a href="#cb46-622" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(normal(0,1), nlpar="Emax"),</span></span>
<span id="cb46-623"><a href="#cb46-623" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(lognormal(4,2), nlpar="ED50"),</span></span>
<span id="cb46-624"><a href="#cb46-624" aria-hidden="true" tabindex="-1"></a><span class="in">                         #prior(beta(4,1), nlpar="modelwgt", lb=0, ub=1),</span></span>
<span id="cb46-625"><a href="#cb46-625" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(normal(0,1), nlpar="Emax2"),</span></span>
<span id="cb46-626"><a href="#cb46-626" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(lognormal(0,1), nlpar="delta1", lb=0),</span></span>
<span id="cb46-627"><a href="#cb46-627" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(lognormal(0,1), nlpar="delta2", lb=0)),</span></span>
<span id="cb46-628"><a href="#cb46-628" aria-hidden="true" tabindex="-1"></a><span class="in">               control=list(adapt_delta=0.999))</span></span>
<span id="cb46-629"><a href="#cb46-629" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-630"><a href="#cb46-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-631"><a href="#cb46-631" aria-hidden="true" tabindex="-1"></a>If you run this code, it produces a lot of severe warnings (which you should not ignore) about divergent transitions after warmup and a very high largest R-hat. Additionally, "Bulk Effective Samples Size" and "Tail Effective Samples Size (ESS)" are too low, and a lot of transitions after warmup that exceeded the maximum treedepth.</span>
<span id="cb46-632"><a href="#cb46-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-633"><a href="#cb46-633" aria-hidden="true" tabindex="-1"></a><span class="fu">### Going beyond the default MCP-Mod models</span></span>
<span id="cb46-634"><a href="#cb46-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-635"><a href="#cb46-635" aria-hidden="true" tabindex="-1"></a>So far, a lot of what we did could also be done in a frequentist manner using the MCP-Mod approach. </span>
<span id="cb46-636"><a href="#cb46-636" aria-hidden="true" tabindex="-1"></a>However, with <span class="in">`brms`</span> it is easy to make our models more complex when necessary. </span>
<span id="cb46-637"><a href="#cb46-637" aria-hidden="true" tabindex="-1"></a>For example, we assumed that a 280 mg q2w dose is equivalent to a 560 mg q4w dose. </span>
<span id="cb46-638"><a href="#cb46-638" aria-hidden="true" tabindex="-1"></a>This is of course only the case in terms of the total amount of drug injected over the trial period. </span>
<span id="cb46-639"><a href="#cb46-639" aria-hidden="true" tabindex="-1"></a>However, the two dose regimens differ in terms of their blood concentrations over time as shown in the plot below.</span>
<span id="cb46-640"><a href="#cb46-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-641"><a href="#cb46-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r simplepk}</span></span>
<span id="cb46-642"><a href="#cb46-642" aria-hidden="true" tabindex="-1"></a><span class="in">sim_1st_order_pk = function(injected=c(1,rep(0,28*5)), dose=1, thalf=28*24, V=10){</span></span>
<span id="cb46-643"><a href="#cb46-643" aria-hidden="true" tabindex="-1"></a><span class="in">  k = log(2)/thalf  </span></span>
<span id="cb46-644"><a href="#cb46-644" aria-hidden="true" tabindex="-1"></a><span class="in">  concentration = rep(0, length(injected))</span></span>
<span id="cb46-645"><a href="#cb46-645" aria-hidden="true" tabindex="-1"></a><span class="in">  for (i in 1:length(injected)){</span></span>
<span id="cb46-646"><a href="#cb46-646" aria-hidden="true" tabindex="-1"></a><span class="in">    if (i&gt;1) {</span></span>
<span id="cb46-647"><a href="#cb46-647" aria-hidden="true" tabindex="-1"></a><span class="in">      concentration[i] = concentration[i-1] - k*concentration[i-1] + dose*injected[i]/V</span></span>
<span id="cb46-648"><a href="#cb46-648" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb46-649"><a href="#cb46-649" aria-hidden="true" tabindex="-1"></a><span class="in">      concentration[i] = dose*injected[i]/V</span></span>
<span id="cb46-650"><a href="#cb46-650" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb46-651"><a href="#cb46-651" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb46-652"><a href="#cb46-652" aria-hidden="true" tabindex="-1"></a><span class="in">  return(concentration)</span></span>
<span id="cb46-653"><a href="#cb46-653" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb46-654"><a href="#cb46-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-655"><a href="#cb46-655" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data = tibble(regimen="q4wk",</span></span>
<span id="cb46-656"><a href="#cb46-656" aria-hidden="true" tabindex="-1"></a><span class="in">                   dose=280,</span></span>
<span id="cb46-657"><a href="#cb46-657" aria-hidden="true" tabindex="-1"></a><span class="in">                   concentration = sim_1st_order_pk(rep(c(1,rep(0, 28*24-1)),12), dose=280)) %&gt;%</span></span>
<span id="cb46-658"><a href="#cb46-658" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(hour=1:n()) %&gt;%</span></span>
<span id="cb46-659"><a href="#cb46-659" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_rows(tibble(regimen="q2wk",</span></span>
<span id="cb46-660"><a href="#cb46-660" aria-hidden="true" tabindex="-1"></a><span class="in">       dose=280,</span></span>
<span id="cb46-661"><a href="#cb46-661" aria-hidden="true" tabindex="-1"></a><span class="in">       concentration = sim_1st_order_pk(rep(c(1,rep(0, 14*24-1)),24), dose=280)) %&gt;%</span></span>
<span id="cb46-662"><a href="#cb46-662" aria-hidden="true" tabindex="-1"></a><span class="in">         mutate(hour=1:n())) %&gt;%</span></span>
<span id="cb46-663"><a href="#cb46-663" aria-hidden="true" tabindex="-1"></a><span class="in">  bind_rows(bind_rows(tibble(regimen="q4wk",</span></span>
<span id="cb46-664"><a href="#cb46-664" aria-hidden="true" tabindex="-1"></a><span class="in">       dose=560,</span></span>
<span id="cb46-665"><a href="#cb46-665" aria-hidden="true" tabindex="-1"></a><span class="in">       concentration = sim_1st_order_pk(rep(c(1,rep(0, 28*24-1)),12), dose=560)) %&gt;%</span></span>
<span id="cb46-666"><a href="#cb46-666" aria-hidden="true" tabindex="-1"></a><span class="in">         mutate(hour=1:n()))) %&gt;%</span></span>
<span id="cb46-667"><a href="#cb46-667" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(dose_regimen = paste0(dose, " mg ", regimen)) </span></span>
<span id="cb46-668"><a href="#cb46-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-669"><a href="#cb46-669" aria-hidden="true" tabindex="-1"></a><span class="in">plot_data %&gt;%</span></span>
<span id="cb46-670"><a href="#cb46-670" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=hour, y=concentration, col=dose_regimen)) +</span></span>
<span id="cb46-671"><a href="#cb46-671" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line() +</span></span>
<span id="cb46-672"><a href="#cb46-672" aria-hidden="true" tabindex="-1"></a><span class="in">  coord_cartesian(ylim=c(0,120)) +</span></span>
<span id="cb46-673"><a href="#cb46-673" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(breaks=seq(0,12)*28*24, labels=seq(0,12)) +</span></span>
<span id="cb46-674"><a href="#cb46-674" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_text(data=. %&gt;% filter( (hour==8025 &amp; str_detect(dose_regimen, "280 mg q2")) |</span></span>
<span id="cb46-675"><a href="#cb46-675" aria-hidden="true" tabindex="-1"></a><span class="in">                               (hour==500 &amp; str_detect(dose_regimen, "560 mg q4")) |</span></span>
<span id="cb46-676"><a href="#cb46-676" aria-hidden="true" tabindex="-1"></a><span class="in">                               (hour==5000 &amp; str_detect(dose_regimen, "280 mg q4"))),</span></span>
<span id="cb46-677"><a href="#cb46-677" aria-hidden="true" tabindex="-1"></a><span class="in">            aes(label=dose_regimen), nudge_y=c(-20,25, 60), angle=c(0,-75,0)) +</span></span>
<span id="cb46-678"><a href="#cb46-678" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Time in trial (months)") +</span></span>
<span id="cb46-679"><a href="#cb46-679" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Drug concentration [mg/L]")</span></span>
<span id="cb46-680"><a href="#cb46-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-681"><a href="#cb46-681" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-682"><a href="#cb46-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-683"><a href="#cb46-683" aria-hidden="true" tabindex="-1"></a>These differences in pharmacokinetic profiles likely lead to at least somewhat different efficacy outcomes.</span>
<span id="cb46-684"><a href="#cb46-684" aria-hidden="true" tabindex="-1"></a>For example, if efficacy is more driven by the peak concentration achieved in each dosing interval, </span>
<span id="cb46-685"><a href="#cb46-685" aria-hidden="true" tabindex="-1"></a>280 mg q2w might be less effective than a 560 mg q4w regiment would have been. </span>
<span id="cb46-686"><a href="#cb46-686" aria-hidden="true" tabindex="-1"></a>On the other hand, if efficacy is more determined by the minimum concentration maintained throughout time, </span>
<span id="cb46-687"><a href="#cb46-687" aria-hidden="true" tabindex="-1"></a>then 280 mg q2w could be more effective than 560 mg q4w.</span>
<span id="cb46-688"><a href="#cb46-688" aria-hidden="true" tabindex="-1"></a>If the main determinant of efficacy is the average drug concentration over time, and peaks and troughs do not matter </span>
<span id="cb46-689"><a href="#cb46-689" aria-hidden="true" tabindex="-1"></a>(at least within the concentrations seen), then the two dosing regimens might be exactly identical.</span>
<span id="cb46-690"><a href="#cb46-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-691"><a href="#cb46-691" aria-hidden="true" tabindex="-1"></a>So, we could update our previous sigmoid Emax model and add an extra term that describes how the 280 mg q2w dose might relate to q4w doses.</span>
<span id="cb46-692"><a href="#cb46-692" aria-hidden="true" tabindex="-1"></a>Note that assuming a monotone concentration response, a 280 mg q2w regimen cannot be worse than a 280 mg q4w regimen - this is also illustrated </span>
<span id="cb46-693"><a href="#cb46-693" aria-hidden="true" tabindex="-1"></a>by the plot showing that the concentrations of 280 mg q2w are (unsurprisingly) always above those of 280 mg q4w. </span>
<span id="cb46-694"><a href="#cb46-694" aria-hidden="true" tabindex="-1"></a>This gives us a lower bound for the efficacy of 280 mg q2w. </span>
<span id="cb46-695"><a href="#cb46-695" aria-hidden="true" tabindex="-1"></a>Similarly, its peak concentrations stay below 2.5 times the peak concentrations of 280 mg q2w, </span>
<span id="cb46-696"><a href="#cb46-696" aria-hidden="true" tabindex="-1"></a>which gives us an upper bound. We will specify a log-normal prior with mean 0 </span>
<span id="cb46-697"><a href="#cb46-697" aria-hidden="true" tabindex="-1"></a>and SD 0.67 for a regimen factor that indicates what q4w dose a q2w dose is equivalent to.</span>
<span id="cb46-698"><a href="#cb46-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-699"><a href="#cb46-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-700"><a href="#cb46-700" aria-hidden="true" tabindex="-1"></a><span class="in">```{r adding_regimen_factor, results='hide', message = FALSE}</span></span>
<span id="cb46-701"><a href="#cb46-701" aria-hidden="true" tabindex="-1"></a><span class="in">brmfit3 &lt;- brm( bf( est | se(stderr) ~ E0 + Emax * (dose*dosefactor)^h / ((dose*dosefactor)^h + ED50^h),</span></span>
<span id="cb46-702"><a href="#cb46-702" aria-hidden="true" tabindex="-1"></a><span class="in">                   nlf(h ~ exp(logh)), nlf(ED50 ~ exp(logED50)), nlf(dosefactor ~ exp((dose==560)*regimen)),</span></span>
<span id="cb46-703"><a href="#cb46-703" aria-hidden="true" tabindex="-1"></a><span class="in">                   E0 ~ 1, logED50 ~ 1, logh ~ 1, Emax ~ 1, regimen ~ 1, </span></span>
<span id="cb46-704"><a href="#cb46-704" aria-hidden="true" tabindex="-1"></a><span class="in">                   nl=T, family=gaussian()),</span></span>
<span id="cb46-705"><a href="#cb46-705" aria-hidden="true" tabindex="-1"></a><span class="in">               data=pathway,</span></span>
<span id="cb46-706"><a href="#cb46-706" aria-hidden="true" tabindex="-1"></a><span class="in">               prior = c(prior(normal(0,1), nlpar="E0"),</span></span>
<span id="cb46-707"><a href="#cb46-707" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(normal(0,1), nlpar="logh"),</span></span>
<span id="cb46-708"><a href="#cb46-708" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(normal(0,1), nlpar="Emax"),</span></span>
<span id="cb46-709"><a href="#cb46-709" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(normal(4,2), nlpar="logED50"),</span></span>
<span id="cb46-710"><a href="#cb46-710" aria-hidden="true" tabindex="-1"></a><span class="in">                         prior(normal(0,0.67), nlpar="regimen")),</span></span>
<span id="cb46-711"><a href="#cb46-711" aria-hidden="true" tabindex="-1"></a><span class="in">               control=list(adapt_delta=0.999),</span></span>
<span id="cb46-712"><a href="#cb46-712" aria-hidden="true" tabindex="-1"></a><span class="in">               seed=2023,</span></span>
<span id="cb46-713"><a href="#cb46-713" aria-hidden="true" tabindex="-1"></a><span class="in">               save_pars = save_pars(all = TRUE))</span></span>
<span id="cb46-714"><a href="#cb46-714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-715"><a href="#cb46-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-716"><a href="#cb46-716" aria-hidden="true" tabindex="-1"></a>Let's summarize the model results:</span>
<span id="cb46-717"><a href="#cb46-717" aria-hidden="true" tabindex="-1"></a><span class="in">```{r summarize_arf_results}</span></span>
<span id="cb46-718"><a href="#cb46-718" aria-hidden="true" tabindex="-1"></a><span class="in">summary(brmfit3)</span></span>
<span id="cb46-719"><a href="#cb46-719" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-720"><a href="#cb46-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-721"><a href="#cb46-721" aria-hidden="true" tabindex="-1"></a>As we can see, we can fit such a model, but the marginal posterior for the log-regimen factor is still a N(0, 0.67) distribution. </span>
<span id="cb46-722"><a href="#cb46-722" aria-hidden="true" tabindex="-1"></a>Thus, the data do not inform this parameter very well - which should not surprise us. </span>
<span id="cb46-723"><a href="#cb46-723" aria-hidden="true" tabindex="-1"></a>However, if we had information external to the PATHWAY trial, such as the elicited judgments of experts, we could incorporate it via this type of model.</span>
<span id="cb46-724"><a href="#cb46-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-725"><a href="#cb46-725" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb46-726"><a href="#cb46-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-727"><a href="#cb46-727" aria-hidden="true" tabindex="-1"></a>As we could see <span class="in">`brms`</span> makes it surprisingly easy to fit non-linear dose response models and to perform model averaging.</span>
<span id="cb46-728"><a href="#cb46-728" aria-hidden="true" tabindex="-1"></a>Taking a Bayesian approach to dose response modeling is attractive for a number of reasons:</span>
<span id="cb46-729"><a href="#cb46-729" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>using prior information e.g. on expected placebo outcomes, the maximum plausible treatment effect and typical dose response patterns,</span>
<span id="cb46-730"><a href="#cb46-730" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>(weakly-)informative priors avoid issues with maximum likelihood estimation such as infinitely steep sigmoid Emax models (common when the lowest tested dose has the best point estimate),</span>
<span id="cb46-731"><a href="#cb46-731" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>the convenience of obtaining predictions about things that are transformations of the model parameters (e.g. the dose with at least a certain effect), and</span>
<span id="cb46-732"><a href="#cb46-732" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>the straightforward way, in which we can extend the basic models to account for the specifics of our dose finding study.</span>
<span id="cb46-733"><a href="#cb46-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-734"><a href="#cb46-734" aria-hidden="true" tabindex="-1"></a><span class="fu">## Excercises</span></span>
<span id="cb46-735"><a href="#cb46-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-736"><a href="#cb46-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-737"><a href="#cb46-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-738"><a href="#cb46-738" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-profile="dummy"}</span>
<span id="cb46-739"><a href="#cb46-739" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise: Antipneumococcus serum in mice</span></span>
<span id="cb46-740"><a href="#cb46-740" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb46-741"><a href="#cb46-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-742"><a href="#cb46-742" aria-hidden="true" tabindex="-1"></a>The data below are from a non-clinical study published by Goodner and Horsfall in 1935 (Goodner, K. and Horsfall Jr, F.L., 1935. The protective action of type I antipneumococcus serum in mice: I. The quantitative aspects of the mouse protection test. The Journal of Experimental Medicine, 62(3), pp.359-374.).</span>
<span id="cb46-743"><a href="#cb46-743" aria-hidden="true" tabindex="-1"></a>Mice were given injections of different amounts from a pneumococcus culture, which at the doses given would in the absence of treatment be invariably fatal, mixed together with different doses of type I antipenumococcus horse and rabbit sera. </span>
<span id="cb46-744"><a href="#cb46-744" aria-hidden="true" tabindex="-1"></a>Over several days it was recorded whether each mouse survived or died. This is an example of a dose response curve that appears to have been accepted to be truly non-monotonic in the scientific literature.</span>
<span id="cb46-745"><a href="#cb46-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-746"><a href="#cb46-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mice_data}</span></span>
<span id="cb46-747"><a href="#cb46-747" aria-hidden="true" tabindex="-1"></a><span class="in">mice = tibble(</span></span>
<span id="cb46-748"><a href="#cb46-748" aria-hidden="true" tabindex="-1"></a><span class="in">  `Source of immune serum` = factor( c(rep(1L, 29*3), rep(2L, 32*3)),</span></span>
<span id="cb46-749"><a href="#cb46-749" aria-hidden="true" tabindex="-1"></a><span class="in">                                     levels=c(1L, 2L), </span></span>
<span id="cb46-750"><a href="#cb46-750" aria-hidden="true" tabindex="-1"></a><span class="in">                                     labels=c("rabbit", "horse")),</span></span>
<span id="cb46-751"><a href="#cb46-751" aria-hidden="true" tabindex="-1"></a><span class="in">  `Amount of serum (cc.)` = rep(0.4*0.5^c(0L:5L, 0L:6L, 0L:7L, 0L:7L,</span></span>
<span id="cb46-752"><a href="#cb46-752" aria-hidden="true" tabindex="-1"></a><span class="in">                                          1L:5L, 0L:8L, 0L:8L, 0L:8L),</span></span>
<span id="cb46-753"><a href="#cb46-753" aria-hidden="true" tabindex="-1"></a><span class="in">                                each=3),</span></span>
<span id="cb46-754"><a href="#cb46-754" aria-hidden="true" tabindex="-1"></a><span class="in">  `Amount of culture (cc.)` = c(rep(0.4, 18), rep(0.2, 21), rep(0.1, 24), </span></span>
<span id="cb46-755"><a href="#cb46-755" aria-hidden="true" tabindex="-1"></a><span class="in">                                rep(0.05, 24), rep(0.4, 15), rep(0.2, 27), </span></span>
<span id="cb46-756"><a href="#cb46-756" aria-hidden="true" tabindex="-1"></a><span class="in">                                rep(0.1, 27), rep(0.05,27)),</span></span>
<span id="cb46-757"><a href="#cb46-757" aria-hidden="true" tabindex="-1"></a><span class="in">  Died = c(rep(1L, 18),</span></span>
<span id="cb46-758"><a href="#cb46-758" aria-hidden="true" tabindex="-1"></a><span class="in">            1L,rep(0L,5), 1L,1L,0L, 1L,0L,0L, 1L,1L,1L, 1L,0L,0L, 1L,1L,1L,</span></span>
<span id="cb46-759"><a href="#cb46-759" aria-hidden="true" tabindex="-1"></a><span class="in">            rep(0L, 14),1L, 0L,0L,0L, 1L,1L,0L, 1L,1L,1L,</span></span>
<span id="cb46-760"><a href="#cb46-760" aria-hidden="true" tabindex="-1"></a><span class="in">            rep(0L,24), </span></span>
<span id="cb46-761"><a href="#cb46-761" aria-hidden="true" tabindex="-1"></a><span class="in">            rep(1L, 15),</span></span>
<span id="cb46-762"><a href="#cb46-762" aria-hidden="true" tabindex="-1"></a><span class="in">            rep(1L, 8),0L, 1L,0L,0L, 1L,0L,0L, rep(1L,5),0L, 0L,rep(1L,5),</span></span>
<span id="cb46-763"><a href="#cb46-763" aria-hidden="true" tabindex="-1"></a><span class="in">            rep(1L,5), 0L,1L,rep(0L,9),rep(1L,4),0L, rep(1L,6),</span></span>
<span id="cb46-764"><a href="#cb46-764" aria-hidden="true" tabindex="-1"></a><span class="in">            rep(1L,5), rep(0L,12),1L, 0L,0L, rep(1L,7))) %&gt;%</span></span>
<span id="cb46-765"><a href="#cb46-765" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(Survived = 1L-Died)</span></span>
<span id="cb46-766"><a href="#cb46-766" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-767"><a href="#cb46-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-768"><a href="#cb46-768" aria-hidden="true" tabindex="-1"></a>Displayed in a fashion similar to the original article, the data look as in the figure below.</span>
<span id="cb46-769"><a href="#cb46-769" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot_mice_data, echo=FALSE}</span></span>
<span id="cb46-770"><a href="#cb46-770" aria-hidden="true" tabindex="-1"></a><span class="in">mice %&gt;%</span></span>
<span id="cb46-771"><a href="#cb46-771" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(`Source of immune serum` = factor(`Source of immune serum`,</span></span>
<span id="cb46-772"><a href="#cb46-772" aria-hidden="true" tabindex="-1"></a><span class="in">                                           levels=c("rabbit", "horse"),</span></span>
<span id="cb46-773"><a href="#cb46-773" aria-hidden="true" tabindex="-1"></a><span class="in">                                           labels=c("Immune serum\nfrom rabbits",</span></span>
<span id="cb46-774"><a href="#cb46-774" aria-hidden="true" tabindex="-1"></a><span class="in">                                                    "Immune serum\nfrom horses")),</span></span>
<span id="cb46-775"><a href="#cb46-775" aria-hidden="true" tabindex="-1"></a><span class="in">         Survived = factor(Survived, </span></span>
<span id="cb46-776"><a href="#cb46-776" aria-hidden="true" tabindex="-1"></a><span class="in">                           levels=0L:1L, </span></span>
<span id="cb46-777"><a href="#cb46-777" aria-hidden="true" tabindex="-1"></a><span class="in">                           labels=c("Died", "Survived"))) %&gt;%</span></span>
<span id="cb46-778"><a href="#cb46-778" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(`Source of immune serum`, `Amount of serum (cc.)`, </span></span>
<span id="cb46-779"><a href="#cb46-779" aria-hidden="true" tabindex="-1"></a><span class="in">                      `Amount of culture (cc.)`) %&gt;%</span></span>
<span id="cb46-780"><a href="#cb46-780" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(desc(Survived)) %&gt;%</span></span>
<span id="cb46-781"><a href="#cb46-781" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(mouse_number = 1:n()) %&gt;%</span></span>
<span id="cb46-782"><a href="#cb46-782" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() %&gt;%</span></span>
<span id="cb46-783"><a href="#cb46-783" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=mouse_number, y=`Amount of serum (cc.)`, </span></span>
<span id="cb46-784"><a href="#cb46-784" aria-hidden="true" tabindex="-1"></a><span class="in">             col=Survived)) +</span></span>
<span id="cb46-785"><a href="#cb46-785" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(size=5) +</span></span>
<span id="cb46-786"><a href="#cb46-786" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_grid(rows=vars(`Source of immune serum`),</span></span>
<span id="cb46-787"><a href="#cb46-787" aria-hidden="true" tabindex="-1"></a><span class="in">             cols=vars(`Amount of culture (cc.)`)) +</span></span>
<span id="cb46-788"><a href="#cb46-788" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_continuous(expand = c(0.3,0.3), position = "top") +</span></span>
<span id="cb46-789"><a href="#cb46-789" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_log10(breaks=c(0.4*0.5^c(0L:8L)),</span></span>
<span id="cb46-790"><a href="#cb46-790" aria-hidden="true" tabindex="-1"></a><span class="in">                labels=c(0.4*0.5^c(0L:8L)),</span></span>
<span id="cb46-791"><a href="#cb46-791" aria-hidden="true" tabindex="-1"></a><span class="in">                expand = c(0.05,0.05)) +</span></span>
<span id="cb46-792"><a href="#cb46-792" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid = element_blank(),</span></span>
<span id="cb46-793"><a href="#cb46-793" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.text.x = element_blank(),</span></span>
<span id="cb46-794"><a href="#cb46-794" aria-hidden="true" tabindex="-1"></a><span class="in">        axis.ticks.x = element_blank(),</span></span>
<span id="cb46-795"><a href="#cb46-795" aria-hidden="true" tabindex="-1"></a><span class="in">        legend.position = "bottom") +</span></span>
<span id="cb46-796"><a href="#cb46-796" aria-hidden="true" tabindex="-1"></a><span class="in">  xlab("Amount of culture (cc.)")</span></span>
<span id="cb46-797"><a href="#cb46-797" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-798"><a href="#cb46-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-799"><a href="#cb46-799" aria-hidden="true" tabindex="-1"></a>An alternative display showing the proportion of mice that survived versus the amount of serum given as displayed in the figure below.</span>
<span id="cb46-800"><a href="#cb46-800" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE}</span></span>
<span id="cb46-801"><a href="#cb46-801" aria-hidden="true" tabindex="-1"></a><span class="in">mice %&gt;% </span></span>
<span id="cb46-802"><a href="#cb46-802" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(`Source of immune serum`, `Amount of serum (cc.)`, </span></span>
<span id="cb46-803"><a href="#cb46-803" aria-hidden="true" tabindex="-1"></a><span class="in">           `Amount of culture (cc.)`) %&gt;%</span></span>
<span id="cb46-804"><a href="#cb46-804" aria-hidden="true" tabindex="-1"></a><span class="in">  summarize(`Proportion of mice that survived` = mean(Survived), .groups="drop") %&gt;%</span></span>
<span id="cb46-805"><a href="#cb46-805" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(aes(x=`Amount of serum (cc.)`, y=`Proportion of mice that survived`, </span></span>
<span id="cb46-806"><a href="#cb46-806" aria-hidden="true" tabindex="-1"></a><span class="in">             col=factor(`Amount of culture (cc.)`),</span></span>
<span id="cb46-807"><a href="#cb46-807" aria-hidden="true" tabindex="-1"></a><span class="in">             label=paste0("Amount of\nculture\n(cc.) =",</span></span>
<span id="cb46-808"><a href="#cb46-808" aria-hidden="true" tabindex="-1"></a><span class="in">                          `Amount of culture (cc.)`))) +</span></span>
<span id="cb46-809"><a href="#cb46-809" aria-hidden="true" tabindex="-1"></a><span class="in">  theme(panel.grid.major.y = element_blank(),</span></span>
<span id="cb46-810"><a href="#cb46-810" aria-hidden="true" tabindex="-1"></a><span class="in">        panel.grid.minor.y = element_blank()) +</span></span>
<span id="cb46-811"><a href="#cb46-811" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_hline(yintercept=c(0,0.25,0.5,0.75,1), col="grey") +</span></span>
<span id="cb46-812"><a href="#cb46-812" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_line() +</span></span>
<span id="cb46-813"><a href="#cb46-813" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_color_manual(values=c("#fdbb84", "#fc8d59", "#e34a33", "#b30000")) +</span></span>
<span id="cb46-814"><a href="#cb46-814" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_x_log10(breaks=c(0.4*0.5^c(0L:8L)),</span></span>
<span id="cb46-815"><a href="#cb46-815" aria-hidden="true" tabindex="-1"></a><span class="in">                labels=c(0.4*0.5^c(0L:8L)),</span></span>
<span id="cb46-816"><a href="#cb46-816" aria-hidden="true" tabindex="-1"></a><span class="in">                guide=guide_axis(angle = 45),</span></span>
<span id="cb46-817"><a href="#cb46-817" aria-hidden="true" tabindex="-1"></a><span class="in">                expand=c(0.1,0.1)) +</span></span>
<span id="cb46-818"><a href="#cb46-818" aria-hidden="true" tabindex="-1"></a><span class="in">  scale_y_continuous(expand=c(0.15, 0.15), breaks=c(0,0.25,0.5,0.75,1)) +</span></span>
<span id="cb46-819"><a href="#cb46-819" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(~`Source of immune serum`) +</span></span>
<span id="cb46-820"><a href="#cb46-820" aria-hidden="true" tabindex="-1"></a><span class="in">  ggrepel::geom_text_repel(data=.%&gt;% </span></span>
<span id="cb46-821"><a href="#cb46-821" aria-hidden="true" tabindex="-1"></a><span class="in">                             filter(`Source of immune serum`=="rabbit" &amp;</span></span>
<span id="cb46-822"><a href="#cb46-822" aria-hidden="true" tabindex="-1"></a><span class="in">                                    ((`Amount of serum (cc.)`==0.003125 &amp; </span></span>
<span id="cb46-823"><a href="#cb46-823" aria-hidden="true" tabindex="-1"></a><span class="in">                                      `Amount of culture (cc.)`==0.05) |</span></span>
<span id="cb46-824"><a href="#cb46-824" aria-hidden="true" tabindex="-1"></a><span class="in">                                      (`Amount of serum (cc.)`==0.00625 &amp; </span></span>
<span id="cb46-825"><a href="#cb46-825" aria-hidden="true" tabindex="-1"></a><span class="in">                                      `Amount of culture (cc.)`==0.1) |</span></span>
<span id="cb46-826"><a href="#cb46-826" aria-hidden="true" tabindex="-1"></a><span class="in">                                      (`Amount of serum (cc.)`==0.1 &amp; </span></span>
<span id="cb46-827"><a href="#cb46-827" aria-hidden="true" tabindex="-1"></a><span class="in">                                      `Amount of culture (cc.)`==0.2) |</span></span>
<span id="cb46-828"><a href="#cb46-828" aria-hidden="true" tabindex="-1"></a><span class="in">                                      (`Amount of serum (cc.)`==0.1 &amp; </span></span>
<span id="cb46-829"><a href="#cb46-829" aria-hidden="true" tabindex="-1"></a><span class="in">                                      `Amount of culture (cc.)`==0.4))),</span></span>
<span id="cb46-830"><a href="#cb46-830" aria-hidden="true" tabindex="-1"></a><span class="in">                           size=4, lineheight = .7, </span></span>
<span id="cb46-831"><a href="#cb46-831" aria-hidden="true" tabindex="-1"></a><span class="in">                           nudge_y = c(0.05, 0, 0, -0.1),</span></span>
<span id="cb46-832"><a href="#cb46-832" aria-hidden="true" tabindex="-1"></a><span class="in">                           nudge_x=c(0, -0.05, 0.1,-0.03))</span></span>
<span id="cb46-833"><a href="#cb46-833" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb46-834"><a href="#cb46-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-835"><a href="#cb46-835" aria-hidden="true" tabindex="-1"></a>Excercises in increasing order of complexity:</span>
<span id="cb46-836"><a href="#cb46-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-837"><a href="#cb46-837" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Fit a sigmoid Emax model to the horse serum data of each individual mouse assuming a Bernoulli distribution after choosing reasonable weakly informative priors, but remember that 0 cc. of serum was stated to result in a death rate of near 100%. Perform model checking.</span>
<span id="cb46-838"><a href="#cb46-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-839"><a href="#cb46-839" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Fit a modified beta model to the horse serum data and also perform Bayesian model averaging. Does this result in a better fit?</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>