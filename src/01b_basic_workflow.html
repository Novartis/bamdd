<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sebastian Weber - sebastian.weber@novartis.com">

<title>2&nbsp; Basic workflow – Applied Modelling in Drug Development</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../src/01c_priors.html" rel="next">
<link href="../src/01a_introduction.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="../resources/mathjax/tex-mml-chtml.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../bamdd.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/01a_introduction.html">Getting started</a></li><li class="breadcrumb-item"><a href="../src/01b_basic_workflow.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic workflow</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../bamdd_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Applied Modelling in Drug Development</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/Novartis/bamdd/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01a_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01b_basic_workflow.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01c_priors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Model setup &amp; priors</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../src/02_case_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Case studies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02a_meta_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Use of historical control data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02ab_meta_analysis_trtdiff.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Meta-analysis to estimate treatment effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02ac_meta_analysis_strata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Use of historical control data with stratification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02l_single_arm_pos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Probability of success from a single arm trial</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02b_dose_finding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dose finding</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02c_dose_escalation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Oncology dose escalation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02cb_tte_dose_escalation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Time-to-event modelling in Oncology dose escalation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02e_multiple_imputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Multiple imputation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02g_longitudinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Longitudinal data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02h_mmrm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Bayesian Mixed effects Model for Repeated Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02i_time_to_event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Time-to-event data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02j_network_meta_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Network meta-analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03a_stan_code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Exposing stan code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03b_parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Parallel computation</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#simple-example" id="toc-simple-example" class="nav-link active" data-scroll-target="#simple-example"><span class="header-section-number">2.1</span> Simple example</a></li>
  <li><a href="#r-session-setup" id="toc-r-session-setup" class="nav-link" data-scroll-target="#r-session-setup"><span class="header-section-number">2.2</span> R session setup</a></li>
  <li><a href="#model-formula" id="toc-model-formula" class="nav-link" data-scroll-target="#model-formula"><span class="header-section-number">2.3</span> Model formula</a></li>
  <li><a href="#prior-specification" id="toc-prior-specification" class="nav-link" data-scroll-target="#prior-specification"><span class="header-section-number">2.4</span> Prior specification</a></li>
  <li><a href="#fitting-the-model" id="toc-fitting-the-model" class="nav-link" data-scroll-target="#fitting-the-model"><span class="header-section-number">2.5</span> Fitting the model</a></li>
  <li><a href="#model-summary" id="toc-model-summary" class="nav-link" data-scroll-target="#model-summary"><span class="header-section-number">2.6</span> Model summary</a></li>
  <li><a href="#model-analysis" id="toc-model-analysis" class="nav-link" data-scroll-target="#model-analysis"><span class="header-section-number">2.7</span> Model analysis</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/01a_introduction.html">Getting started</a></li><li class="breadcrumb-item"><a href="../src/01b_basic_workflow.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic workflow</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-basic-workflow" class="quarto-section-identifier"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic workflow</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sebastian Weber - <a href="mailto:sebastian.weber@novartis.com" class="email">sebastian.weber@novartis.com</a> </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>This section demonstrates the basic steps needed to setup and run an analysis using <code>brms</code>.</p>
<section id="simple-example" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="simple-example"><span class="header-section-number">2.1</span> Simple example</h2>
<p>Here we will use a simplified version of the case study presented in <a href="02a_meta_analysis.html" class="quarto-xref"><span>Chapter 4</span></a>. Specifically, we will run a random-effects meta-analysis for a binary responder variable which has been measured in multiple trials:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load historical data on responses by arm from the RBesT package:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>arm_data <span class="ot">&lt;-</span> RBesT<span class="sc">::</span>AS</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(arm_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">study</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">r</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Study 1</td>
<td style="text-align: right;">107</td>
<td style="text-align: right;">23</td>
</tr>
<tr class="even">
<td style="text-align: left;">Study 2</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Study 3</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="even">
<td style="text-align: left;">Study 4</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Study 5</td>
<td style="text-align: right;">139</td>
<td style="text-align: right;">39</td>
</tr>
<tr class="even">
<td style="text-align: left;">Study 6</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Study 7</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">Study 8</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">10</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>While in the case study an informative prior for a future study will be derived, we here restrict the analysis to a random-effects meta-analysis with the goal to infer the mean response rate of the control arm as measured in the 8 reported studies.</p>
<p>The statistical model we wish to fit to this data is a random-effects varying intercept model</p>
<p><span class="math display">\[ y_i|\theta_i,n_i \sim \mbox{Binomial}(\theta_i,n_i) \]</span> <span class="math display">\[ \mbox{logit}{(\theta_i)}|\beta,\eta_i = \beta + \eta_i \]</span> <span class="math display">\[ \eta_i|\tau \sim \mbox{Normal}(0, \tau^2).\]</span></p>
<p>Thus, each study <span class="math inline">\(i\)</span> will recieve it’s study-specific response rate <span class="math inline">\(\theta_i\)</span> as given by the sum of the study-specific random effect <span class="math inline">\(\eta_i\)</span> and the overall typical responder rate <span class="math inline">\(\beta\)</span>, which are inferred on the logit scale. We choose the priors in a conservative manner aligned with the case study</p>
<p><span class="math display">\[ \beta \sim \mbox{Normal}(0, 2^2)\]</span> <span class="math display">\[ \tau \sim \mbox{Normal}^+(0, 1).\]</span></p>
</section>
<section id="r-session-setup" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="r-session-setup"><span class="header-section-number">2.2</span> R session setup</h2>
<p>Ideally your R session will have access to sufficient computational resources, e.g.&nbsp;at least 4 CPU cores and 8000 MB of RAM. The 4 cores are needed to run multiple chains in parallel and the RAM is used during compilation of Stan models.</p>
<p>When working with <code>brms</code> in an applied modeling setting, one often wishes to fit various related models and compare their outputs. With this in mind a recommended preamble for an analysis R script may start with:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tools to process model outputs</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># useful plotting facilities</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># further customization of plots</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># common data processing utilities</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># other utilities</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr) <span class="co"># used for the "kable" command</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)  <span class="co"># useful to specify path's relative to project</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend=</span><span class="st">"cmdstanr"</span>, <span class="at">cmdstanr_write_stan_file_dir=</span><span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># create cache directory if not yet available</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># set the R random seed of the session for reproducibility</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5886935</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># invisible to the reader additional setup steps, which are optional</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="do">## common setup code for each section; enables compilation of each</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="do">## section on it's own</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">echo =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>here<span class="sc">::</span><span class="fu">i_am</span>(<span class="st">"src/setup.R"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(future)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    cl <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">makePSOCKcluster</span>(parallelly<span class="sc">::</span><span class="fu">availableCores</span>())</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    parallel<span class="sc">::</span><span class="fu">setDefaultCluster</span>(cl)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">on.exit</span>(parallel<span class="sc">::</span><span class="fu">stopCluster</span>(cl))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="do">## avoid that rstan tries to access ressources on the internet</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">rstan_options</span>(<span class="at">javascript =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Set defaults for ggplot2 ----</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">theme_set</span>( ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>(<span class="at">base_size=</span><span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>                    ggplot2<span class="sc">::</span><span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>scale_colour_discrete <span class="ot">&lt;-</span> scale_color_discrete <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Alternative: ggsci::scale_color_nejm(...)</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_colour_brewer</span>(..., <span class="at">palette=</span><span class="st">"Dark2"</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>scale_fill_discrete <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Alternative: ggsci::scale_fill_nejm(...)</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">scale_fill_brewer</span>(..., <span class="at">palette=</span><span class="st">"Dark2"</span>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>scale_colour_continuous <span class="ot">&lt;-</span> scale_color_continuous <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  viridis<span class="sc">::</span><span class="fu">scale_colour_viridis_c</span>(..., <span class="at">option=</span><span class="st">"turbo"</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">update_geom_defaults</span>(<span class="st">"point"</span>, <span class="fu">list</span>(<span class="at">size=</span><span class="dv">2</span>))</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">update_geom_defaults</span>(<span class="st">"line"</span>, <span class="fu">list</span>(<span class="at">size=</span><span class="fl">1.5</span>))</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="co"># To allow adding label to points e.g. as geom_text_repel(data=. %&gt;% filter(1:n()==n()))</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="co"># update_geom_defaults("text_repel", list(label.size = NA, fill = rgb(0,0,0,0),</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co">#                                         segment.color = "transparent", size=6))</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co"># variables we would like to set differently in a CI/CD environment</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>chains <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">Sys.getenv</span>(<span class="st">"BRMS_NUM_CHAINS"</span>, <span class="dv">4</span>))</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>iter <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">Sys.getenv</span>(<span class="st">"BRMS_NUM_ITER"</span>, <span class="dv">2000</span>))</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>brms_cache_dir <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">"BRMS_CACHE_DIR"</span>, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(brms_cache_dir, <span class="cn">FALSE</span>)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="co"># use this flag as argument to the cache option of selected knitr</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="co"># blocks which take long =&gt; gets now controlled from Quarto</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co"># use_knitr_cache &lt;- Sys.getenv("USE_KNITR_CACHE", "yes") == "yes"</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="do">##knitr::opts_chunk$set(cache.path = file.path(brms_cache_dir, "knitr-cache-"))</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.iter =</span> iter</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">brms.chains =</span> chains</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">brms.backend=</span><span class="st">"cmdstanr"</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>       ,<span class="at">cmdstanr_write_stan_file_dir=</span>brms_cache_dir</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Set chapter-specific seed</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="fu">sum</span>(<span class="fu">as.integer</span>(digest<span class="sc">::</span><span class="fu">digest</span>(knitr<span class="sc">::</span><span class="fu">current_input</span>(), <span class="at">raw =</span> T))))</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="co"># too old brms versions used with too recent cmdstan versions lead to</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a><span class="co"># a borken caching of model binaries...this is a brute force fix for</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="co"># this</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"src"</span>, <span class="st">"brms_utils.R"</span>))</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressWarnings</span>(<span class="fu">patch_brms_recompile</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As <code>brms</code> models are translated to Stan model files, which must be compiled as a C++ program before the model is run, it is useful to cache this compilation step such that repeated model evaluation avoids the compilation (speeding up model reruns with different data or model reruns after restarting R). Thus, the <code>brms.backend</code> option <code>cmdstanr</code> is configured as a default. Doing so allows to cache the binary Stan executables in the directory configured with the option <code>cmdstanr_write_stan_file_dir</code>.</p>
<p>In case the model fitted is taking a long time for one chain (more than a minute at least), then it is advisable to turn on parallelization of the multiple chains by default by adding to the preamble:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use 4 cores for parallel sampling by default - only recommended if</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># model takes &gt; 1 minute to run for each chain otherwise the</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># parallelization introduces substantial overhead</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is discouraged to run chains always in parallel, since the parallelization itself consumes some ressources and is only beneficial if the model runtime is at least at the order of minutes. In case the model runtime becomes excessivley long, then each chain can itself be run with multiple cores as discussed in the section <a href="../src/03b_parallel.html">Parallel computation</a>.</p>
</section>
<section id="model-formula" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="model-formula"><span class="header-section-number">2.3</span> Model formula</h2>
<p>With <code>brms</code> statistical models are specified via a model formula and specification of a response <code>family</code>. The family encodes the likelihood and link functions used for the distribution parameters. A distribution parameter is, for example, the response rate of a binomial outcome, the counting rate for a negative binomial endpoint or the overdispersion of a negative binomial.</p>
<p>In general formulaes can be recognized by a <code>~</code> sign. Anything on the left-hand side of the <code>~</code> describes the response (outcome) while terms on the right-hand side setup the design matrix, random effects or even a non-linear model formula. The left-hand side and the right-hand side can contain special terms which encode additional information and the chosen example makes use of this feature. It’s good practice to store the <code>brms</code> model formula in a separate R variable like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>model_meta_random <span class="ot">&lt;-</span> <span class="fu">bf</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> study), <span class="at">family=</span>binomial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The left-hand side of the formula <code>r | trials(n)</code> encodes the main outcome response variable <code>r</code> (number of responders) and it passes along additional information needed for the binomial response here, the number of respondents using <code>trials(n)</code>. Using the same notation, the case-study “<a href="02ab_meta_analysis_trtdiff.html">Meta-analysis to estimate treatment effects</a>” shows how the exposure time can be varyied for count outcomes. The right-hand side of the formula specifies a linear predictor <code>1</code>. This defines the fixed effect design matrix, which is the intercept only term in this example, but covariates could be included here. In addition, the term <code>(1 | study)</code> defines a random effect with a by <code>study</code> varying intercept. Finally, the <code>family</code> argument specifies the statistical family being used. The link function is by default a <code>logit</code> link for the <code>binomial</code> family. Note that <code>brms</code> supports a large set of families, please refer to</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>?brmsfamily</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>for an overview on the available families in <code>brms</code>. In case your specific family neededed is not available, users even have the option to define their own family. This is a somewhat advanced use of <code>brms</code>, but as <code>brms</code> is designed to accomodate many different families this is in fact not too difficult and a full vignette is <a href="https://paul-buerkner.github.io/brms/articles/brms_customfamilies.html">available online</a>.</p>
<p>An alternative model in this context could be a fixed effect only model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model_meta_fixed <span class="ot">&lt;-</span> <span class="fu">bf</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family=</span>binomial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that for some models one may even need to specify multiple model formulas. This can be the case whenever multiple distribution parameters must be specified (a negative binomial needs a mean rate model and a model for the dispersion parameter) or whenever a non-linear model is used, see the case study on dose finding in section @ref(dose-finding).</p>
</section>
<section id="prior-specification" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="prior-specification"><span class="header-section-number">2.4</span> Prior specification</h2>
<p>The specification of priors is not strictly required for generalized linear models in <code>brms</code>. In this case very wide defaults priors are setup for the user. However, these only work well whenever a lot of data is available and it is furthermore a much better practice to be specific about the priors being used in a given analysis.</p>
<p>In order to support the user in specifying priors, the <code>brms</code> package provides the <code>get_prior</code> function. We start with the simple fixed effect model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">get_prior</span>(model_meta_fixed, arm_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 29%">
<col style="width: 13%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">prior</th>
<th style="text-align: left;">class</th>
<th style="text-align: left;">coef</th>
<th style="text-align: left;">group</th>
<th style="text-align: left;">resp</th>
<th style="text-align: left;">dpar</th>
<th style="text-align: left;">nlpar</th>
<th style="text-align: left;">lb</th>
<th style="text-align: left;">ub</th>
<th style="text-align: left;">source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">student_t(3, 0, 2.5)</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Note that <code>brms</code> requires the model formula <strong>and</strong> the data to which the model is being fitted to. This is due to fact that only model and data together define all parameters fully. For example, the model formula could contain a categorical variable and then only knowing all categories as defined by the data allows to define the full model with all parameters. For the fixed effect model only a single parameter, the intercept only term is defined. To now define a prior for the intercept, we may use the <code>prior</code> command as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>prior_meta_fixed <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">class=</span><span class="st">"Intercept"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The prior for the random effects model is slightly more complicated as it involves a heterogeniety parameter <span class="math inline">\(\tau\)</span> (standard deviation of the study random effect):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">get_prior</span>(model_meta_random, arm_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 27%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">prior</th>
<th style="text-align: left;">class</th>
<th style="text-align: left;">coef</th>
<th style="text-align: left;">group</th>
<th style="text-align: left;">resp</th>
<th style="text-align: left;">dpar</th>
<th style="text-align: left;">nlpar</th>
<th style="text-align: left;">lb</th>
<th style="text-align: left;">ub</th>
<th style="text-align: left;">source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">student_t(3, 0, 2.5)</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
<tr class="even">
<td style="text-align: left;">student_t(3, 0, 2.5)</td>
<td style="text-align: left;">sd</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">sd</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">study</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">sd</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">study</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Given that the random effects model is a generalization of the fixed effect model, it is natural to write the prior in a way which expands the fixed effect case as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>prior_meta_random <span class="ot">&lt;-</span> prior_meta_fixed <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class=</span><span class="st">"sd"</span>, <span class="at">coef=</span><span class="st">"Intercept"</span>, <span class="at">group=</span><span class="st">"study"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The logic to defined priors on specifc parameters is to use the different parameter identifiers as provided by the <code>get_prior</code> command. In this context <code>class</code>, <code>coef</code> and <code>group</code> is used for parameter class, parameter coefficient and grouping, respectivley. The identifiers <code>resp</code>, <code>dlpar</code> and <code>nlpar</code> are used in the context of multiple responses, multiple distribution parameters oe non-linear parameters, respectivley. It is preferable to be specific as above in the definition of priors while it is admissable to be less specific like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>prior_meta_random <span class="ot">&lt;-</span> prior_meta_fixed <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class=</span><span class="st">"sd"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This statement assign to <em>all</em> random effect standard deviations of the model the same prior, which can be convenient in some situations.</p>
</section>
<section id="fitting-the-model" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="fitting-the-model"><span class="header-section-number">2.5</span> Fitting the model</h2>
<p>Having defined the model formula, the family and the priors we can now fit the models with the <code>brm</code> command.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fit_meta_fixed  <span class="ot">&lt;-</span> <span class="fu">brm</span>(model_meta_fixed, <span class="at">data=</span>arm_data, <span class="at">prior=</span>prior_meta_fixed,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                       <span class="do">## setup Stan sampler to be more conservative, but more robust</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                       <span class="do">## these options silence Stan</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">seed=</span><span class="dv">4658758</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.0 seconds.
Chain 2 finished in 0.0 seconds.
Chain 3 finished in 0.0 seconds.
Chain 4 finished in 0.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.0 seconds.
Total execution time: 0.6 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fit_meta_random  <span class="ot">&lt;-</span> <span class="fu">brm</span>(model_meta_random, <span class="at">data=</span>arm_data, <span class="at">prior=</span>prior_meta_random,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">seed=</span><span class="dv">5868467</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.1 seconds.
Chain 2 finished in 0.1 seconds.
Chain 3 finished in 0.1 seconds.
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.1 seconds.
Total execution time: 0.9 seconds.</code></pre>
</div>
</div>
<p>When calling <code>brm</code> a Stan model file will be created, compiled and run with the data provided. The arguments used are:</p>
<ul>
<li><code>formula</code> is the first argument here. It specifies the model. Since we have in this case provided <code>family</code> as part of the formula, we do not need to specify it as argument to <code>brm</code>, which is also possible to do.</li>
<li><code>data</code> the data used to fit.</li>
<li><code>prior</code> definition of the priors for all model parameters</li>
<li><code>control</code> defines additional control arguments to the Stan sampler. A higher than standard <code>adapt_delta</code> (defaults to <code>0.8</code>) causes the sampler to run less aggressively which makes the sampler more robust, but somewhat slower.</li>
<li><code>refresh &amp; silent</code> are used here to suppress Stan sampling output.</li>
<li><code>seed</code> sets the seed use for the fit.</li>
</ul>
<p>In the course of an exploratory analysis one often wishes to modify a given model slightly to study, for example, the sensitivity to different assumptions. For this purpose the <code>update</code> mechanism is a convenient way to simply change certain arguments specified previously. To change the prior on the study level random effect parameter one may use:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>prior_meta_random_alt <span class="ot">&lt;-</span> prior_meta_fixed <span class="sc">+</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="fl">0.5</span>), <span class="at">class=</span><span class="st">"sd"</span>, <span class="at">coef=</span><span class="st">"Intercept"</span>, <span class="at">group=</span><span class="st">"study"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>fit_meta_random_alt  <span class="ot">&lt;-</span> <span class="fu">update</span>(fit_meta_random, <span class="at">prior=</span>prior_meta_random_alt,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seed=</span><span class="dv">6845736</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The desired updates require recompiling the model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.1 seconds.
Chain 2 finished in 0.1 seconds.
Chain 3 finished in 0.1 seconds.
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.1 seconds.
Total execution time: 0.9 seconds.</code></pre>
</div>
</div>
<p>As changing the prior results in this case in a need to recompile the model, the benefits of using <code>update</code> are not large in this case. However, whenever a model recompilation is not needed, then using <code>update</code> significantly speeds up the workflow as the compilation step is avoided, e.g.&nbsp;when looking at data subsets:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>prior_meta_random_alt <span class="ot">&lt;-</span> prior_meta_fixed <span class="sc">+</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="fl">0.5</span>), <span class="at">class=</span><span class="st">"sd"</span>, <span class="at">coef=</span><span class="st">"Intercept"</span>, <span class="at">group=</span><span class="st">"study"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>fit_meta_random_alt2  <span class="ot">&lt;-</span> <span class="fu">update</span>(fit_meta_random, <span class="at">newdata=</span><span class="fu">slice_head</span>(arm_data, <span class="at">n=</span><span class="dv">4</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                                <span class="at">seed=</span><span class="dv">5868467</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.1 seconds.
Chain 2 finished in 0.1 seconds.
Chain 3 finished in 0.1 seconds.
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.1 seconds.
Total execution time: 0.6 seconds.</code></pre>
</div>
</div>
<p>Now the fit starts instantly leading to a faster and more convenient modeling workflow.</p>
<p>When working with <code>brms</code> you will encounter warnings now and then which originate from Stan itself. While <code>brms</code> attempts to add explanations to these warnings as to what they mean and how to avoid them, the Stan community has provided an <a href="https://mc-stan.org/misc/warnings.html">online help-page</a> on possible warnings occuring during a Stan fit.</p>
</section>
<section id="model-summary" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="model-summary"><span class="header-section-number">2.6</span> Model summary</h2>
<p>Once models are fit, we obtain - by default - a posterior sample of the model. Given that priors are used in such an analysis it can be convenient to first consider the priors which were used to create a given fitting object like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">prior_summary</span>(fit_meta_random))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 27%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">prior</th>
<th style="text-align: left;">class</th>
<th style="text-align: left;">coef</th>
<th style="text-align: left;">group</th>
<th style="text-align: left;">resp</th>
<th style="text-align: left;">dpar</th>
<th style="text-align: left;">nlpar</th>
<th style="text-align: left;">lb</th>
<th style="text-align: left;">ub</th>
<th style="text-align: left;">source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">normal(0, 2)</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">user</td>
</tr>
<tr class="even">
<td style="text-align: left;">student_t(3, 0, 2.5)</td>
<td style="text-align: left;">sd</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">0</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">sd</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">study</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">default</td>
</tr>
<tr class="even">
<td style="text-align: left;">normal(0, 1)</td>
<td style="text-align: left;">sd</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">study</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">user</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>An even more explicit way to analyze the prior of a model is to <em>sample</em> it directly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>prior_meta_random  <span class="ot">&lt;-</span> <span class="fu">update</span>(fit_meta_random, <span class="at">sample_prior=</span><span class="st">"only"</span>,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">seed=</span><span class="dv">5868467</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.0 seconds.
Chain 2 finished in 0.0 seconds.
Chain 3 finished in 0.0 seconds.
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.0 seconds.
Total execution time: 0.5 seconds.</code></pre>
</div>
</div>
<p>This will sample the model in the usual way, but simply leave out the terms implied by the data likelihood. The resulting model sample can be analyzed in exactly the same way as the model posterior itself. This technique is called prior (predictive) checks.</p>
<p>Returning to the model posterior, the obvious first thing to do is to simply print the results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_meta_random)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: r | trials(n) ~ 1 + (1 | study) 
   Data: arm_data (Number of observations: 8) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~study (Number of levels: 8) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     0.39      0.22     0.04     0.90 1.00     1052     1256

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    -1.11      0.20    -1.50    -0.70 1.00     1127     1227

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>We see that we fitted the default 4 chains and ran each chain for 1000 warmup iterations and 2000 total iterations such that we are left with 4k iterations overall. <code>brms</code> reports by default as estimate the mean of the posterior with it’s standard error and the 95% credible interval. The <code>Rhat</code> column is a convergence diagnostic which should be close to <code>1.0</code>. Values above <code>1.1</code> indicate non-convergence of the Markov Chain for the particular parameter. The additional two columns on bulk and tail ESS indicate statistical information on central moments and tail properties of the target quantitiy. The ESS is the effective sample size of the MC estimator, which assumes that the estimation error of the mean scales with <span class="math inline">\(1/\sqrt{ESS}\)</span>. An ESS of ~200 is usually sufficient for a precise estimate of the mean. It is important to note that the Stan HMC sampler often requires fewer iterations (for which more time is spent) as compared to BUGS or JAGS in order to reach a comparable ESS. For more details on the ESS, please refer to the <a href="https://mc-stan.org/docs/2_29/reference-manual/effective-sample-size.html">Stan reference manual on ESS</a>.</p>
<p><code>brms</code> supports the common R functions to extract model results:</p>
<ul>
<li><code>fitted</code> to get the posterior estimates of expected values of for each data row (no sampling uncertainty)</li>
<li><code>predict</code> to get the posterior predictive estimates of the response for each data row (includes sampling uncertainty)</li>
<li><code>coef</code>/<code>ranef</code> to get the random effect estimates including/excluding the linear predictor part</li>
<li>many more, please refer to the reference manual of <code>brms</code></li>
</ul>
<p>Of note is the argument <code>summary</code>, which is used in a number of these functions. The default is set to <code>TRUE</code> such that the output are summaries of the posterior sample in the form of means, credible intervals, etc. When setting the argument <code>summary=FALSE</code> then the posterior sample is returned in the format of a matrix. Each row of the matrix is one iteration while the columns of the matrix run with the rows of the input data-set.</p>
<p>For example, we can compare the estimated mean response fo the two different models as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(fit_meta_random)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Estimate Est.Error      Q2.5     Q97.5
[1,] 24.422596  3.688009 17.310181 31.705575
[2,] 11.498271  2.131884  7.613735 16.218670
[3,] 16.123568  3.074037 11.162169 22.887761
[4,]  9.410968  1.905810  5.770311 13.470430
[5,] 37.780937  4.620416 29.236132 47.479274
[6,]  5.382889  1.218695  3.209769  8.154431
[7,] 13.513251  3.589218  7.002771 20.590007
[8,]  9.320552  1.880953  6.039857 13.473071</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(fit_meta_fixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Estimate Est.Error      Q2.5     Q97.5
[1,] 26.533687 2.0380505 22.574910 30.640824
[2,] 10.911049 0.8380768  9.283141 12.599965
[3,] 12.646898 0.9714072 10.760004 14.604505
[4,]  9.671157 0.7428408  8.228238 11.168151
[5,] 34.468995 2.6475609 29.326285 39.804435
[6,]  4.959568 0.3809440  4.219609  5.727257
[7,] 19.342314 1.4856817 16.456477 22.336302
[8,]  8.679243 0.6666520  7.384316 10.022699</code></pre>
</div>
</div>
<p>As expected, the standard errors for the fixed effect analysis are considerably smaller.</p>
</section>
<section id="model-analysis" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="model-analysis"><span class="header-section-number">2.7</span> Model analysis</h2>
<p>How to analyze a given model obviously depends very much on details of the problem at hand. Often we wish to evaluate how well the model describes the problem data used to fit the model. Thus, the ability of the model to describe certain summaries of the data set accuratley is one way to critize the model. Such an approach requires to compare predictions of the data by the model <span class="math inline">\(y_{rep}\)</span> to the actual data <span class="math inline">\(y\)</span>. This procedure is referred to as posterior predictive checks. A key feautre of the approach is to account for sampling uncertainty implied by the endpoint and sample size.</p>
<p>For a meta-analysis we may wish to check how well the summary statistics of the historical data is predicted by the model. The <code>brms</code> package integrates with the <code>bayesplot</code> package for the purpose of posterior predictive checks, which could look in this case like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create intervals plot and label plot accordingly</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(fit_meta_random, <span class="at">type=</span><span class="st">"intervals"</span>, <span class="at">ndraws=</span><span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">"Study"</span>, <span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(arm_data), <span class="at">labels=</span>arm_data<span class="sc">$</span>study) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>          <span class="do">## suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior predictive check"</span>, <span class="st">"Random effects model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="01b_basic_workflow_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(fit_meta_fixed, <span class="at">type=</span><span class="st">"intervals"</span>, <span class="at">ndraws=</span><span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">"Study"</span>, <span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(arm_data), <span class="at">labels=</span>arm_data<span class="sc">$</span>study) <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>          <span class="do">## suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior predictive check"</span>, <span class="st">"Fixed effects model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="01b_basic_workflow_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Shown is a central 50% credible interval with a thick line, a thinner line shows the 90% credible interval, the open dot marks the median prediction and the filled dark dot marks the observed value of the data. We see is that in particular study 7 is predicted unsatisfactory by the fixed effect model. An additional interesting predictice check in this case is in view of a possibile use as historical control information part of a new study. While the above predictive check of the random effects was conditional on the fitted data, we can instead use the random effects model and predict each study as if it were a new study:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create intervals plot and label plot accordingly</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>pp_arm_data_new <span class="ot">&lt;-</span> <span class="fu">posterior_predict</span>(fit_meta_random,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">newdata=</span><span class="fu">mutate</span>(arm_data, <span class="at">study=</span><span class="fu">paste0</span>(<span class="st">"new_"</span>, study)),</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">allow_new_levels=</span><span class="cn">TRUE</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">sample_new_levels=</span><span class="st">"gaussian"</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># use bayesplot::ppc_intervals directly here</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_intervals</span>(<span class="at">y=</span>arm_data<span class="sc">$</span>r, <span class="at">yrep=</span>pp_arm_data_new) <span class="sc">+</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">"Study"</span>, <span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(arm_data), <span class="at">labels=</span>arm_data<span class="sc">$</span>study) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>          <span class="do">## suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior predictive check - new studies"</span>, <span class="st">"Random effects model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="01b_basic_workflow_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now the credible intervals are wider as these contain additional variability. As for study 7 the random effect is not anymore conditioned on the data of the study, we see again that the model struggles to account for the study nicely. However, with the additional heterogeniety the result of study 7 is at least plausible given that it is contained in the 90% credible interval.</p>
<p>In the above discussion we have ensured the comparability of the plots via matching the axis limits. A more straightforward is a side by side comparison of the models, which can be achieved like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use bayesplot::ppc_intervals_data directly here</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>model_cmp <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="at">random_new=</span><span class="fu">ppc_intervals_data</span>(<span class="at">y=</span>arm_data<span class="sc">$</span>r, <span class="at">yrep=</span>pp_arm_data_new),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">random=</span><span class="fu">ppc_intervals_data</span>(<span class="at">y=</span>arm_data<span class="sc">$</span>r, <span class="at">yrep=</span><span class="fu">posterior_predict</span>(fit_meta_random)),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fixed=</span><span class="fu">ppc_intervals_data</span>(<span class="at">y=</span>arm_data<span class="sc">$</span>r, <span class="at">yrep=</span><span class="fu">posterior_predict</span>(fit_meta_fixed)),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.id=</span><span class="st">"Model"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add in labels into the data-set</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="fu">select</span>(<span class="fu">mutate</span>(arm_data, <span class="at">x=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>), x, study), <span class="at">by=</span><span class="st">"x"</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model_cmp, <span class="fu">aes</span>(study, m, <span class="at">colour=</span>Model)) <span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>ll, <span class="at">ymax=</span>hh), <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.4</span>)) <span class="sc">+</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y=</span>y_obs), <span class="at">colour=</span><span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Study"</span>) <span class="sc">+</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>          <span class="co"># suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior predictive check"</span>, <span class="st">"All models"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="01b_basic_workflow_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A more formal way to compare these models is to consider their ability to predict new data. In absence of new data we may instead turn to scores which evaluate the ability of the model to predict data which has been left out when fitting the model. The leave-one-out scores can be calculated using fast approximations (see <code>loo</code> command) whenever the data-set is large enough. We refer the reader to the case study on <a href="02b_dose_finding.html">Dose finding</a> where these model comparisons are discussed in greater detail.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/opensource\.nibr\.com\/bamdd\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../src/01a_introduction.html" class="pagination-link" aria-label="Introduction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../src/01c_priors.html" class="pagination-link" aria-label="Model setup &amp; priors">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Model setup &amp; priors</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb40" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">  - Sebastian Weber - &lt;sebastian.weber@novartis.com&gt;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Basic workflow {#sec-basic-workflow}</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>This section demonstrates the basic steps needed to setup and run an</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>analysis using <span class="in">`brms`</span>. </span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simple example</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>Here we will use a simplified version of the case study presented in</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>@sec-use-hist-control-data. Specifically, we will run a random-effects</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>meta-analysis for a binary responder variable which has been measured</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>in multiple trials:</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="co"># load historical data on responses by arm from the RBesT package:</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>arm_data <span class="ot">&lt;-</span> RBesT<span class="sc">::</span>AS</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(arm_data)</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>While in the case study an informative prior for a future study will</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>be derived, we here restrict the analysis to a random-effects</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>meta-analysis with the goal to infer the mean response rate of the</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>control arm as measured in the 8 reported studies.</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>The statistical model we wish to fit to this data is a random-effects</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>varying intercept model</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>$$ y_i|\theta_i,n_i \sim \mbox{Binomial}(\theta_i,n_i) $$</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>$$ \mbox{logit}{(\theta_i)}|\beta,\eta_i = \beta + \eta_i $$</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>$$ \eta_i|\tau \sim \mbox{Normal}(0, \tau^2).$$</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>Thus, each study $i$ will recieve it's study-specific response rate</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>$\theta_i$ as given by the sum of the study-specific random effect</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>$\eta_i$ and the overall typical responder rate $\beta$, which are</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>inferred on the logit scale. We choose the priors in a conservative</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>manner aligned with the case study</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>$$ \beta \sim \mbox{Normal}(0, 2^2)$$</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>$$ \tau \sim \mbox{Normal}^+(0, 1).$$</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a><span class="fu">## R session setup</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-profile="public"}</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>Ideally your R session will have access to sufficient computational</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>resources, e.g. at least 4 CPU cores and 8000 MB of RAM. The 4 </span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>cores are needed to run multiple chains in parallel and</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>the RAM is used during compilation of Stan models.</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>When working with <span class="in">`brms`</span> in an applied modeling setting, one often</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>wishes to fit various related models and compare their outputs. With</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>this in mind a recommended preamble for an analysis R script may start</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>with:</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=TRUE,echo=TRUE,message=FALSE,warning=FALSE}</span></span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a><span class="in">library(brms)</span></span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a><span class="in"># tools to process model outputs</span></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a><span class="in">library(posterior)</span></span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a><span class="in"># useful plotting facilities</span></span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a><span class="in">library(bayesplot)</span></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a><span class="in"># further customization of plots</span></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a><span class="in"># common data processing utilities</span></span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyr)</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a><span class="in"># other utilities</span></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a><span class="in">library(knitr) # used for the "kable" command</span></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a><span class="in">library(here)  # useful to specify path's relative to project</span></span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a><span class="in"># ...</span></span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a><span class="in"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a><span class="in">options(brms.backend="cmdstanr", cmdstanr_write_stan_file_dir=here("_brms-cache"))</span></span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a><span class="in"># create cache directory if not yet available</span></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a><span class="in">dir.create(here("_brms-cache"), FALSE)</span></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a><span class="in"># set the R random seed of the session for reproducibility</span></span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(5886935)</span></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true </span></span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a><span class="co"># invisible to the reader additional setup steps, which are optional</span></span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>{{<span class="sc">&lt;</span> include setup.R <span class="sc">&gt;</span>}}</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>As <span class="in">`brms`</span> models are translated to Stan model files, which must be</span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a>compiled as a C++ program before the model is run, it is useful to</span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>cache this compilation step such that repeated model evaluation avoids</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a>the compilation (speeding up model reruns with different data or model</span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a>reruns after restarting R). Thus, the <span class="in">`brms.backend`</span> option</span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a><span class="in">`cmdstanr`</span> is configured as a default. Doing so allows to cache the</span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>binary Stan executables in the directory configured with the option</span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a><span class="in">`cmdstanr_write_stan_file_dir`</span>.</span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>In case the model fitted is taking a long time for one chain (more</span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>than a minute at least), then it is advisable to turn on</span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>parallelization of the multiple chains by default by adding to the</span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>preamble:</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE, eval=FALSE}</span></span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a><span class="in"># use 4 cores for parallel sampling by default - only recommended if</span></span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a><span class="in"># model takes &gt; 1 minute to run for each chain otherwise the</span></span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a><span class="in"># parallelization introduces substantial overhead</span></span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a><span class="in">options(mc.cores = 4)</span></span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a>It is discouraged to run chains always in parallel, since the</span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>parallelization itself consumes some ressources and is only beneficial</span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a>if the model runtime is at least at the order of minutes. In case the</span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a>model runtime becomes excessivley long, then each chain can itself be</span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a>run with multiple cores as discussed in the section [Parallel</span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a>computation](03b_parallel.qmd). </span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model formula</span></span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a>With <span class="in">`brms`</span> statistical models are specified via a model formula and</span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a>specification of a response <span class="in">`family`</span>. The family encodes the</span>
<span id="cb40-131"><a href="#cb40-131" aria-hidden="true" tabindex="-1"></a>likelihood and link functions used for the distribution parameters. A</span>
<span id="cb40-132"><a href="#cb40-132" aria-hidden="true" tabindex="-1"></a>distribution parameter is, for example, the response rate of a</span>
<span id="cb40-133"><a href="#cb40-133" aria-hidden="true" tabindex="-1"></a>binomial outcome, the counting rate for a negative binomial endpoint</span>
<span id="cb40-134"><a href="#cb40-134" aria-hidden="true" tabindex="-1"></a>or the overdispersion of a negative binomial.</span>
<span id="cb40-135"><a href="#cb40-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-136"><a href="#cb40-136" aria-hidden="true" tabindex="-1"></a>In general formulaes can be recognized by a <span class="in">`~`</span> sign. Anything on the</span>
<span id="cb40-137"><a href="#cb40-137" aria-hidden="true" tabindex="-1"></a>left-hand side of the <span class="in">`~`</span> describes the response (outcome) while terms</span>
<span id="cb40-138"><a href="#cb40-138" aria-hidden="true" tabindex="-1"></a>on the right-hand side setup the design matrix, random effects or even</span>
<span id="cb40-139"><a href="#cb40-139" aria-hidden="true" tabindex="-1"></a>a non-linear model formula. The left-hand side and the right-hand side</span>
<span id="cb40-140"><a href="#cb40-140" aria-hidden="true" tabindex="-1"></a>can contain special terms which encode additional information and the</span>
<span id="cb40-141"><a href="#cb40-141" aria-hidden="true" tabindex="-1"></a>chosen example makes use of this feature. It's good practice to store</span>
<span id="cb40-142"><a href="#cb40-142" aria-hidden="true" tabindex="-1"></a>the <span class="in">`brms`</span> model formula in a separate R variable like:</span>
<span id="cb40-143"><a href="#cb40-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-146"><a href="#cb40-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-147"><a href="#cb40-147" aria-hidden="true" tabindex="-1"></a>model_meta_random <span class="ot">&lt;-</span> <span class="fu">bf</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> study), <span class="at">family=</span>binomial)</span>
<span id="cb40-148"><a href="#cb40-148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-149"><a href="#cb40-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-150"><a href="#cb40-150" aria-hidden="true" tabindex="-1"></a>The left-hand side of the formula <span class="in">` r | trials(n)`</span> encodes the main</span>
<span id="cb40-151"><a href="#cb40-151" aria-hidden="true" tabindex="-1"></a>outcome response variable <span class="in">` r`</span> (number of responders) and it passes</span>
<span id="cb40-152"><a href="#cb40-152" aria-hidden="true" tabindex="-1"></a>along additional information needed for the binomial response here,</span>
<span id="cb40-153"><a href="#cb40-153" aria-hidden="true" tabindex="-1"></a>the number of respondents using <span class="in">`trials(n)`</span>. Using the same notation,</span>
<span id="cb40-154"><a href="#cb40-154" aria-hidden="true" tabindex="-1"></a>the case-study "[Meta-analysis to estimate treatment</span>
<span id="cb40-155"><a href="#cb40-155" aria-hidden="true" tabindex="-1"></a>effects](02ab_meta_analysis_trtdiff.html)" shows how</span>
<span id="cb40-156"><a href="#cb40-156" aria-hidden="true" tabindex="-1"></a>the exposure time can be varyied for count outcomes. The right-hand</span>
<span id="cb40-157"><a href="#cb40-157" aria-hidden="true" tabindex="-1"></a>side of the formula specifies a linear predictor <span class="in">`1`</span>. This defines the</span>
<span id="cb40-158"><a href="#cb40-158" aria-hidden="true" tabindex="-1"></a>fixed effect design matrix, which is the intercept only term in this</span>
<span id="cb40-159"><a href="#cb40-159" aria-hidden="true" tabindex="-1"></a>example, but covariates could be included here. In addition, the term</span>
<span id="cb40-160"><a href="#cb40-160" aria-hidden="true" tabindex="-1"></a><span class="in">`(1 | study)`</span> defines a random effect with a by <span class="in">`study`</span> varying</span>
<span id="cb40-161"><a href="#cb40-161" aria-hidden="true" tabindex="-1"></a>intercept. Finally, the <span class="in">`family`</span> argument specifies the statistical</span>
<span id="cb40-162"><a href="#cb40-162" aria-hidden="true" tabindex="-1"></a>family being used. The link function is by default a <span class="in">`logit`</span> link for</span>
<span id="cb40-163"><a href="#cb40-163" aria-hidden="true" tabindex="-1"></a>the <span class="in">`binomial`</span> family. Note that <span class="in">`brms`</span> supports a large set of</span>
<span id="cb40-164"><a href="#cb40-164" aria-hidden="true" tabindex="-1"></a>families, please refer to</span>
<span id="cb40-165"><a href="#cb40-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-166"><a href="#cb40-166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb40-167"><a href="#cb40-167" aria-hidden="true" tabindex="-1"></a><span class="in">?brmsfamily</span></span>
<span id="cb40-168"><a href="#cb40-168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-169"><a href="#cb40-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-170"><a href="#cb40-170" aria-hidden="true" tabindex="-1"></a>for an overview on the available families in <span class="in">`brms`</span>. In case your</span>
<span id="cb40-171"><a href="#cb40-171" aria-hidden="true" tabindex="-1"></a>specific family neededed is not available, users even have the option</span>
<span id="cb40-172"><a href="#cb40-172" aria-hidden="true" tabindex="-1"></a>to define their own family. This is a somewhat advanced use of <span class="in">`brms`</span>,</span>
<span id="cb40-173"><a href="#cb40-173" aria-hidden="true" tabindex="-1"></a>but as <span class="in">`brms`</span> is designed to accomodate many different families this</span>
<span id="cb40-174"><a href="#cb40-174" aria-hidden="true" tabindex="-1"></a>is in fact not too difficult and a full vignette is [available</span>
<span id="cb40-175"><a href="#cb40-175" aria-hidden="true" tabindex="-1"></a>online](https://paul-buerkner.github.io/brms/articles/brms_customfamilies.html).</span>
<span id="cb40-176"><a href="#cb40-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-177"><a href="#cb40-177" aria-hidden="true" tabindex="-1"></a>An alternative model in this context could be a fixed effect only</span>
<span id="cb40-178"><a href="#cb40-178" aria-hidden="true" tabindex="-1"></a>model:</span>
<span id="cb40-179"><a href="#cb40-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-182"><a href="#cb40-182" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-183"><a href="#cb40-183" aria-hidden="true" tabindex="-1"></a>model_meta_fixed <span class="ot">&lt;-</span> <span class="fu">bf</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family=</span>binomial)</span>
<span id="cb40-184"><a href="#cb40-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-185"><a href="#cb40-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-186"><a href="#cb40-186" aria-hidden="true" tabindex="-1"></a>Note that for some models one may even need to specify multiple model</span>
<span id="cb40-187"><a href="#cb40-187" aria-hidden="true" tabindex="-1"></a>formulas. This can be the case whenever multiple distribution</span>
<span id="cb40-188"><a href="#cb40-188" aria-hidden="true" tabindex="-1"></a>parameters must be specified (a negative binomial needs a mean rate</span>
<span id="cb40-189"><a href="#cb40-189" aria-hidden="true" tabindex="-1"></a>model and a model for the dispersion parameter) or whenever a</span>
<span id="cb40-190"><a href="#cb40-190" aria-hidden="true" tabindex="-1"></a>non-linear model is used, see the case study on dose finding in</span>
<span id="cb40-191"><a href="#cb40-191" aria-hidden="true" tabindex="-1"></a>section \@ref(dose-finding).</span>
<span id="cb40-192"><a href="#cb40-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-193"><a href="#cb40-193" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prior specification</span></span>
<span id="cb40-194"><a href="#cb40-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-195"><a href="#cb40-195" aria-hidden="true" tabindex="-1"></a>The specification of priors is not strictly required for generalized</span>
<span id="cb40-196"><a href="#cb40-196" aria-hidden="true" tabindex="-1"></a>linear models in <span class="in">`brms`</span>. In this case very wide defaults priors are</span>
<span id="cb40-197"><a href="#cb40-197" aria-hidden="true" tabindex="-1"></a>setup for the user. However, these only work well whenever a lot of</span>
<span id="cb40-198"><a href="#cb40-198" aria-hidden="true" tabindex="-1"></a>data is available and it is furthermore a much better practice to be</span>
<span id="cb40-199"><a href="#cb40-199" aria-hidden="true" tabindex="-1"></a>specific about the priors being used in a given analysis.</span>
<span id="cb40-200"><a href="#cb40-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-201"><a href="#cb40-201" aria-hidden="true" tabindex="-1"></a>In order to support the user in specifying priors, the <span class="in">`brms`</span> package</span>
<span id="cb40-202"><a href="#cb40-202" aria-hidden="true" tabindex="-1"></a>provides the <span class="in">`get_prior`</span> function. We start with the simple fixed</span>
<span id="cb40-203"><a href="#cb40-203" aria-hidden="true" tabindex="-1"></a>effect model:</span>
<span id="cb40-204"><a href="#cb40-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-207"><a href="#cb40-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-208"><a href="#cb40-208" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">get_prior</span>(model_meta_fixed, arm_data))</span>
<span id="cb40-209"><a href="#cb40-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-210"><a href="#cb40-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-211"><a href="#cb40-211" aria-hidden="true" tabindex="-1"></a>Note that <span class="in">`brms`</span> requires the model formula **and** the data to which</span>
<span id="cb40-212"><a href="#cb40-212" aria-hidden="true" tabindex="-1"></a>the model is being fitted to. This is due to fact that only model and</span>
<span id="cb40-213"><a href="#cb40-213" aria-hidden="true" tabindex="-1"></a>data together define all parameters fully. For example, the model</span>
<span id="cb40-214"><a href="#cb40-214" aria-hidden="true" tabindex="-1"></a>formula could contain a categorical variable and then only knowing all</span>
<span id="cb40-215"><a href="#cb40-215" aria-hidden="true" tabindex="-1"></a>categories as defined by the data allows to define the full model with</span>
<span id="cb40-216"><a href="#cb40-216" aria-hidden="true" tabindex="-1"></a>all parameters. For the fixed effect model only a single parameter,</span>
<span id="cb40-217"><a href="#cb40-217" aria-hidden="true" tabindex="-1"></a>the intercept only term is defined. To now define a prior for the</span>
<span id="cb40-218"><a href="#cb40-218" aria-hidden="true" tabindex="-1"></a>intercept, we may use the <span class="in">`prior`</span> command as:</span>
<span id="cb40-219"><a href="#cb40-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-222"><a href="#cb40-222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-223"><a href="#cb40-223" aria-hidden="true" tabindex="-1"></a>prior_meta_fixed <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">class=</span><span class="st">"Intercept"</span>)</span>
<span id="cb40-224"><a href="#cb40-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-225"><a href="#cb40-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-226"><a href="#cb40-226" aria-hidden="true" tabindex="-1"></a>The prior for the random effects model is slightly more complicated as</span>
<span id="cb40-227"><a href="#cb40-227" aria-hidden="true" tabindex="-1"></a>it involves a heterogeniety parameter $\tau$ (standard deviation of</span>
<span id="cb40-228"><a href="#cb40-228" aria-hidden="true" tabindex="-1"></a>the study random effect):</span>
<span id="cb40-229"><a href="#cb40-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-230"><a href="#cb40-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-233"><a href="#cb40-233" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-234"><a href="#cb40-234" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">get_prior</span>(model_meta_random, arm_data))</span>
<span id="cb40-235"><a href="#cb40-235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-236"><a href="#cb40-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-237"><a href="#cb40-237" aria-hidden="true" tabindex="-1"></a>Given that the random effects model is a generalization of the fixed</span>
<span id="cb40-238"><a href="#cb40-238" aria-hidden="true" tabindex="-1"></a>effect model, it is natural to write the prior in a way which expands</span>
<span id="cb40-239"><a href="#cb40-239" aria-hidden="true" tabindex="-1"></a>the fixed effect case as:</span>
<span id="cb40-240"><a href="#cb40-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-241"><a href="#cb40-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-244"><a href="#cb40-244" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-245"><a href="#cb40-245" aria-hidden="true" tabindex="-1"></a>prior_meta_random <span class="ot">&lt;-</span> prior_meta_fixed <span class="sc">+</span></span>
<span id="cb40-246"><a href="#cb40-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class=</span><span class="st">"sd"</span>, <span class="at">coef=</span><span class="st">"Intercept"</span>, <span class="at">group=</span><span class="st">"study"</span>)</span>
<span id="cb40-247"><a href="#cb40-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-248"><a href="#cb40-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-249"><a href="#cb40-249" aria-hidden="true" tabindex="-1"></a>The logic to defined priors on specifc parameters is to use the</span>
<span id="cb40-250"><a href="#cb40-250" aria-hidden="true" tabindex="-1"></a>different parameter identifiers as provided by the <span class="in">`get_prior`</span></span>
<span id="cb40-251"><a href="#cb40-251" aria-hidden="true" tabindex="-1"></a>command. In this context <span class="in">`class`</span>, <span class="in">`coef`</span> and <span class="in">`group`</span> is used for</span>
<span id="cb40-252"><a href="#cb40-252" aria-hidden="true" tabindex="-1"></a>parameter class, parameter coefficient and grouping, respectivley. The</span>
<span id="cb40-253"><a href="#cb40-253" aria-hidden="true" tabindex="-1"></a>identifiers <span class="in">`resp`</span>, <span class="in">`dlpar`</span> and <span class="in">`nlpar`</span> are used in the context of</span>
<span id="cb40-254"><a href="#cb40-254" aria-hidden="true" tabindex="-1"></a>multiple responses, multiple distribution parameters oe non-linear</span>
<span id="cb40-255"><a href="#cb40-255" aria-hidden="true" tabindex="-1"></a>parameters, respectivley. It is preferable to be specific as</span>
<span id="cb40-256"><a href="#cb40-256" aria-hidden="true" tabindex="-1"></a>above in the definition of priors while it is admissable to be less</span>
<span id="cb40-257"><a href="#cb40-257" aria-hidden="true" tabindex="-1"></a>specific like:</span>
<span id="cb40-258"><a href="#cb40-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-259"><a href="#cb40-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-260"><a href="#cb40-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb40-261"><a href="#cb40-261" aria-hidden="true" tabindex="-1"></a><span class="in">prior_meta_random &lt;- prior_meta_fixed +</span></span>
<span id="cb40-262"><a href="#cb40-262" aria-hidden="true" tabindex="-1"></a><span class="in">    prior(normal(0,1), class="sd")</span></span>
<span id="cb40-263"><a href="#cb40-263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-264"><a href="#cb40-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-265"><a href="#cb40-265" aria-hidden="true" tabindex="-1"></a>This statement assign to *all* random effect standard deviations of</span>
<span id="cb40-266"><a href="#cb40-266" aria-hidden="true" tabindex="-1"></a>the model the same prior, which can be convenient in some situations.</span>
<span id="cb40-267"><a href="#cb40-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-268"><a href="#cb40-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-269"><a href="#cb40-269" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting the model</span></span>
<span id="cb40-270"><a href="#cb40-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-271"><a href="#cb40-271" aria-hidden="true" tabindex="-1"></a>Having defined the model formula, the family and the priors we can now</span>
<span id="cb40-272"><a href="#cb40-272" aria-hidden="true" tabindex="-1"></a>fit the models with the <span class="in">`brm`</span> command.</span>
<span id="cb40-273"><a href="#cb40-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-276"><a href="#cb40-276" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-277"><a href="#cb40-277" aria-hidden="true" tabindex="-1"></a>fit_meta_fixed  <span class="ot">&lt;-</span> <span class="fu">brm</span>(model_meta_fixed, <span class="at">data=</span>arm_data, <span class="at">prior=</span>prior_meta_fixed,</span>
<span id="cb40-278"><a href="#cb40-278" aria-hidden="true" tabindex="-1"></a>                       <span class="do">## setup Stan sampler to be more conservative, but more robust</span></span>
<span id="cb40-279"><a href="#cb40-279" aria-hidden="true" tabindex="-1"></a>                       <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb40-280"><a href="#cb40-280" aria-hidden="true" tabindex="-1"></a>                       <span class="do">## these options silence Stan</span></span>
<span id="cb40-281"><a href="#cb40-281" aria-hidden="true" tabindex="-1"></a>                       <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb40-282"><a href="#cb40-282" aria-hidden="true" tabindex="-1"></a>                       <span class="at">seed=</span><span class="dv">4658758</span>)</span>
<span id="cb40-283"><a href="#cb40-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-284"><a href="#cb40-284" aria-hidden="true" tabindex="-1"></a>fit_meta_random  <span class="ot">&lt;-</span> <span class="fu">brm</span>(model_meta_random, <span class="at">data=</span>arm_data, <span class="at">prior=</span>prior_meta_random,</span>
<span id="cb40-285"><a href="#cb40-285" aria-hidden="true" tabindex="-1"></a>                        <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb40-286"><a href="#cb40-286" aria-hidden="true" tabindex="-1"></a>                        <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb40-287"><a href="#cb40-287" aria-hidden="true" tabindex="-1"></a>                        <span class="at">seed=</span><span class="dv">5868467</span>)</span>
<span id="cb40-288"><a href="#cb40-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-289"><a href="#cb40-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-290"><a href="#cb40-290" aria-hidden="true" tabindex="-1"></a>When calling <span class="in">`brm`</span> a Stan model file will be created, compiled and run</span>
<span id="cb40-291"><a href="#cb40-291" aria-hidden="true" tabindex="-1"></a>with the data provided. The arguments used are:</span>
<span id="cb40-292"><a href="#cb40-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-293"><a href="#cb40-293" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`formula`</span> is the first argument here. It specifies the model. Since</span>
<span id="cb40-294"><a href="#cb40-294" aria-hidden="true" tabindex="-1"></a>  we have in this case provided <span class="in">`family`</span> as part of the formula, we do</span>
<span id="cb40-295"><a href="#cb40-295" aria-hidden="true" tabindex="-1"></a>  not need to specify it as argument to <span class="in">`brm`</span>, which is also possible</span>
<span id="cb40-296"><a href="#cb40-296" aria-hidden="true" tabindex="-1"></a>  to do.</span>
<span id="cb40-297"><a href="#cb40-297" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`data`</span> the data used to fit.</span>
<span id="cb40-298"><a href="#cb40-298" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`prior`</span> definition of the priors for all model parameters</span>
<span id="cb40-299"><a href="#cb40-299" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`control`</span> defines additional control arguments to the Stan</span>
<span id="cb40-300"><a href="#cb40-300" aria-hidden="true" tabindex="-1"></a>  sampler. A higher than standard <span class="in">`adapt_delta`</span> (defaults to <span class="in">`0.8`</span>)</span>
<span id="cb40-301"><a href="#cb40-301" aria-hidden="true" tabindex="-1"></a>  causes the sampler to run less aggressively which makes the sampler</span>
<span id="cb40-302"><a href="#cb40-302" aria-hidden="true" tabindex="-1"></a>  more robust, but somewhat slower.</span>
<span id="cb40-303"><a href="#cb40-303" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`refresh &amp; silent`</span> are used here to suppress Stan sampling output.</span>
<span id="cb40-304"><a href="#cb40-304" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`seed`</span> sets the seed use for the fit.</span>
<span id="cb40-305"><a href="#cb40-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-306"><a href="#cb40-306" aria-hidden="true" tabindex="-1"></a>In the course of an exploratory analysis one often wishes to modify a</span>
<span id="cb40-307"><a href="#cb40-307" aria-hidden="true" tabindex="-1"></a>given model slightly to study, for example, the sensitivity to</span>
<span id="cb40-308"><a href="#cb40-308" aria-hidden="true" tabindex="-1"></a>different assumptions. For this purpose the <span class="in">`update`</span> mechanism is a</span>
<span id="cb40-309"><a href="#cb40-309" aria-hidden="true" tabindex="-1"></a>convenient way to simply change certain arguments specified</span>
<span id="cb40-310"><a href="#cb40-310" aria-hidden="true" tabindex="-1"></a>previously. To change the prior on the study level random effect</span>
<span id="cb40-311"><a href="#cb40-311" aria-hidden="true" tabindex="-1"></a>parameter one may use:</span>
<span id="cb40-312"><a href="#cb40-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-315"><a href="#cb40-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-316"><a href="#cb40-316" aria-hidden="true" tabindex="-1"></a>prior_meta_random_alt <span class="ot">&lt;-</span> prior_meta_fixed <span class="sc">+</span></span>
<span id="cb40-317"><a href="#cb40-317" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="fl">0.5</span>), <span class="at">class=</span><span class="st">"sd"</span>, <span class="at">coef=</span><span class="st">"Intercept"</span>, <span class="at">group=</span><span class="st">"study"</span>)</span>
<span id="cb40-318"><a href="#cb40-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-319"><a href="#cb40-319" aria-hidden="true" tabindex="-1"></a>fit_meta_random_alt  <span class="ot">&lt;-</span> <span class="fu">update</span>(fit_meta_random, <span class="at">prior=</span>prior_meta_random_alt,</span>
<span id="cb40-320"><a href="#cb40-320" aria-hidden="true" tabindex="-1"></a>                               <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb40-321"><a href="#cb40-321" aria-hidden="true" tabindex="-1"></a>                               <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb40-322"><a href="#cb40-322" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seed=</span><span class="dv">6845736</span>)</span>
<span id="cb40-323"><a href="#cb40-323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-324"><a href="#cb40-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-325"><a href="#cb40-325" aria-hidden="true" tabindex="-1"></a>As changing the prior results in this case in a need to recompile the</span>
<span id="cb40-326"><a href="#cb40-326" aria-hidden="true" tabindex="-1"></a>model, the benefits of using <span class="in">`update`</span> are not large in this</span>
<span id="cb40-327"><a href="#cb40-327" aria-hidden="true" tabindex="-1"></a>case. However, whenever a model recompilation is not needed, then</span>
<span id="cb40-328"><a href="#cb40-328" aria-hidden="true" tabindex="-1"></a>using <span class="in">`update`</span> significantly speeds up the workflow as the compilation</span>
<span id="cb40-329"><a href="#cb40-329" aria-hidden="true" tabindex="-1"></a>step is avoided, e.g. when looking at data subsets:</span>
<span id="cb40-330"><a href="#cb40-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-333"><a href="#cb40-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-334"><a href="#cb40-334" aria-hidden="true" tabindex="-1"></a>prior_meta_random_alt <span class="ot">&lt;-</span> prior_meta_fixed <span class="sc">+</span></span>
<span id="cb40-335"><a href="#cb40-335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="fl">0.5</span>), <span class="at">class=</span><span class="st">"sd"</span>, <span class="at">coef=</span><span class="st">"Intercept"</span>, <span class="at">group=</span><span class="st">"study"</span>)</span>
<span id="cb40-336"><a href="#cb40-336" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-337"><a href="#cb40-337" aria-hidden="true" tabindex="-1"></a>fit_meta_random_alt2  <span class="ot">&lt;-</span> <span class="fu">update</span>(fit_meta_random, <span class="at">newdata=</span><span class="fu">slice_head</span>(arm_data, <span class="at">n=</span><span class="dv">4</span>),</span>
<span id="cb40-338"><a href="#cb40-338" aria-hidden="true" tabindex="-1"></a>                                <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb40-339"><a href="#cb40-339" aria-hidden="true" tabindex="-1"></a>                                <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb40-340"><a href="#cb40-340" aria-hidden="true" tabindex="-1"></a>                                <span class="at">seed=</span><span class="dv">5868467</span>)</span>
<span id="cb40-341"><a href="#cb40-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-342"><a href="#cb40-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-343"><a href="#cb40-343" aria-hidden="true" tabindex="-1"></a>Now the fit starts instantly leading to a faster and more convenient</span>
<span id="cb40-344"><a href="#cb40-344" aria-hidden="true" tabindex="-1"></a>modeling workflow.</span>
<span id="cb40-345"><a href="#cb40-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-346"><a href="#cb40-346" aria-hidden="true" tabindex="-1"></a>When working with <span class="in">`brms`</span> you will encounter warnings now and then</span>
<span id="cb40-347"><a href="#cb40-347" aria-hidden="true" tabindex="-1"></a>which originate from Stan itself. While <span class="in">`brms`</span> attempts to add</span>
<span id="cb40-348"><a href="#cb40-348" aria-hidden="true" tabindex="-1"></a>explanations to these warnings as to what they mean and how to avoid</span>
<span id="cb40-349"><a href="#cb40-349" aria-hidden="true" tabindex="-1"></a>them, the Stan community has provided an [online</span>
<span id="cb40-350"><a href="#cb40-350" aria-hidden="true" tabindex="-1"></a>help-page](https://mc-stan.org/misc/warnings.html) on possible</span>
<span id="cb40-351"><a href="#cb40-351" aria-hidden="true" tabindex="-1"></a>warnings occuring during a Stan fit.</span>
<span id="cb40-352"><a href="#cb40-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-353"><a href="#cb40-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-354"><a href="#cb40-354" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model summary</span></span>
<span id="cb40-355"><a href="#cb40-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-356"><a href="#cb40-356" aria-hidden="true" tabindex="-1"></a>Once models are fit, we obtain - by default - a posterior sample of</span>
<span id="cb40-357"><a href="#cb40-357" aria-hidden="true" tabindex="-1"></a>the model. Given that priors are used in such an analysis it can be</span>
<span id="cb40-358"><a href="#cb40-358" aria-hidden="true" tabindex="-1"></a>convenient to first consider the priors which were used to create a</span>
<span id="cb40-359"><a href="#cb40-359" aria-hidden="true" tabindex="-1"></a>given fitting object like:</span>
<span id="cb40-360"><a href="#cb40-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-363"><a href="#cb40-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-364"><a href="#cb40-364" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">prior_summary</span>(fit_meta_random))</span>
<span id="cb40-365"><a href="#cb40-365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-366"><a href="#cb40-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-367"><a href="#cb40-367" aria-hidden="true" tabindex="-1"></a>An even more explicit way to analyze the prior of a model is to</span>
<span id="cb40-368"><a href="#cb40-368" aria-hidden="true" tabindex="-1"></a>*sample* it directly:</span>
<span id="cb40-369"><a href="#cb40-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-372"><a href="#cb40-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-373"><a href="#cb40-373" aria-hidden="true" tabindex="-1"></a>prior_meta_random  <span class="ot">&lt;-</span> <span class="fu">update</span>(fit_meta_random, <span class="at">sample_prior=</span><span class="st">"only"</span>,</span>
<span id="cb40-374"><a href="#cb40-374" aria-hidden="true" tabindex="-1"></a>                             <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb40-375"><a href="#cb40-375" aria-hidden="true" tabindex="-1"></a>                             <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="cn">TRUE</span>,</span>
<span id="cb40-376"><a href="#cb40-376" aria-hidden="true" tabindex="-1"></a>                             <span class="at">seed=</span><span class="dv">5868467</span>)</span>
<span id="cb40-377"><a href="#cb40-377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-378"><a href="#cb40-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-379"><a href="#cb40-379" aria-hidden="true" tabindex="-1"></a>This will sample the model in the usual way, but simply leave out the</span>
<span id="cb40-380"><a href="#cb40-380" aria-hidden="true" tabindex="-1"></a>terms implied by the data likelihood. The resulting model sample can</span>
<span id="cb40-381"><a href="#cb40-381" aria-hidden="true" tabindex="-1"></a>be analyzed in exactly the same way as the model posterior</span>
<span id="cb40-382"><a href="#cb40-382" aria-hidden="true" tabindex="-1"></a>itself. This technique is called prior (predictive) checks.</span>
<span id="cb40-383"><a href="#cb40-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-384"><a href="#cb40-384" aria-hidden="true" tabindex="-1"></a>Returning to the model posterior, the obvious first thing to do is to</span>
<span id="cb40-385"><a href="#cb40-385" aria-hidden="true" tabindex="-1"></a>simply print the results:</span>
<span id="cb40-386"><a href="#cb40-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-389"><a href="#cb40-389" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-390"><a href="#cb40-390" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit_meta_random)</span>
<span id="cb40-391"><a href="#cb40-391" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-392"><a href="#cb40-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-393"><a href="#cb40-393" aria-hidden="true" tabindex="-1"></a>We see that we fitted the default 4 chains and ran each chain for 1000</span>
<span id="cb40-394"><a href="#cb40-394" aria-hidden="true" tabindex="-1"></a>warmup iterations and 2000 total iterations such that we are left with</span>
<span id="cb40-395"><a href="#cb40-395" aria-hidden="true" tabindex="-1"></a>4k iterations overall. <span class="in">`brms`</span> reports by default as estimate the mean</span>
<span id="cb40-396"><a href="#cb40-396" aria-hidden="true" tabindex="-1"></a>of the posterior with it's standard error and the 95% credible</span>
<span id="cb40-397"><a href="#cb40-397" aria-hidden="true" tabindex="-1"></a>interval. The <span class="in">`Rhat`</span> column is a convergence diagnostic which should</span>
<span id="cb40-398"><a href="#cb40-398" aria-hidden="true" tabindex="-1"></a>be close to <span class="in">`1.0`</span>. Values above <span class="in">`1.1`</span> indicate non-convergence of the</span>
<span id="cb40-399"><a href="#cb40-399" aria-hidden="true" tabindex="-1"></a>Markov Chain for the particular parameter. The additional two columns</span>
<span id="cb40-400"><a href="#cb40-400" aria-hidden="true" tabindex="-1"></a>on bulk and tail ESS indicate statistical information on central</span>
<span id="cb40-401"><a href="#cb40-401" aria-hidden="true" tabindex="-1"></a>moments and tail properties of the target quantitiy. The ESS is the</span>
<span id="cb40-402"><a href="#cb40-402" aria-hidden="true" tabindex="-1"></a>effective sample size of the MC estimator, which assumes that the</span>
<span id="cb40-403"><a href="#cb40-403" aria-hidden="true" tabindex="-1"></a>estimation error of the mean scales with $1/\sqrt{ESS}$. An ESS of</span>
<span id="cb40-404"><a href="#cb40-404" aria-hidden="true" tabindex="-1"></a>~200 is usually sufficient for a precise estimate of the mean. It is</span>
<span id="cb40-405"><a href="#cb40-405" aria-hidden="true" tabindex="-1"></a>important to note that the Stan HMC sampler often requires fewer</span>
<span id="cb40-406"><a href="#cb40-406" aria-hidden="true" tabindex="-1"></a>iterations (for which more time is spent) as compared to BUGS or JAGS</span>
<span id="cb40-407"><a href="#cb40-407" aria-hidden="true" tabindex="-1"></a>in order to reach a comparable ESS. For more details on the ESS,</span>
<span id="cb40-408"><a href="#cb40-408" aria-hidden="true" tabindex="-1"></a>please refer to the [Stan reference manual on</span>
<span id="cb40-409"><a href="#cb40-409" aria-hidden="true" tabindex="-1"></a>ESS](https://mc-stan.org/docs/2_29/reference-manual/effective-sample-size.html).</span>
<span id="cb40-410"><a href="#cb40-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-411"><a href="#cb40-411" aria-hidden="true" tabindex="-1"></a><span class="in">`brms`</span> supports the common R functions to extract model results:</span>
<span id="cb40-412"><a href="#cb40-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-413"><a href="#cb40-413" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`fitted`</span> to get the posterior estimates of expected values of for</span>
<span id="cb40-414"><a href="#cb40-414" aria-hidden="true" tabindex="-1"></a>  each data row (no sampling uncertainty)</span>
<span id="cb40-415"><a href="#cb40-415" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`predict`</span> to get the posterior predictive estimates of the response for each</span>
<span id="cb40-416"><a href="#cb40-416" aria-hidden="true" tabindex="-1"></a>  data row (includes sampling uncertainty)</span>
<span id="cb40-417"><a href="#cb40-417" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`coef`</span>/<span class="in">`ranef`</span> to get the random effect estimates including/excluding the linear</span>
<span id="cb40-418"><a href="#cb40-418" aria-hidden="true" tabindex="-1"></a>  predictor part</span>
<span id="cb40-419"><a href="#cb40-419" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>many more, please refer to the reference manual of <span class="in">`brms`</span></span>
<span id="cb40-420"><a href="#cb40-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-421"><a href="#cb40-421" aria-hidden="true" tabindex="-1"></a>Of note is the argument <span class="in">`summary`</span>, which is used in a number of these</span>
<span id="cb40-422"><a href="#cb40-422" aria-hidden="true" tabindex="-1"></a>functions. The default is set to <span class="in">`TRUE`</span> such that the output are</span>
<span id="cb40-423"><a href="#cb40-423" aria-hidden="true" tabindex="-1"></a>summaries of the posterior sample in the form of means, credible</span>
<span id="cb40-424"><a href="#cb40-424" aria-hidden="true" tabindex="-1"></a>intervals, etc. When setting the argument <span class="in">`summary=FALSE`</span> then the</span>
<span id="cb40-425"><a href="#cb40-425" aria-hidden="true" tabindex="-1"></a>posterior sample is returned in the format of a matrix. Each row of</span>
<span id="cb40-426"><a href="#cb40-426" aria-hidden="true" tabindex="-1"></a>the matrix is one iteration while the columns of the matrix run with</span>
<span id="cb40-427"><a href="#cb40-427" aria-hidden="true" tabindex="-1"></a>the rows of the input data-set.</span>
<span id="cb40-428"><a href="#cb40-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-429"><a href="#cb40-429" aria-hidden="true" tabindex="-1"></a>For example, we can compare the estimated mean response fo the two</span>
<span id="cb40-430"><a href="#cb40-430" aria-hidden="true" tabindex="-1"></a>different models as:</span>
<span id="cb40-431"><a href="#cb40-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-434"><a href="#cb40-434" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-435"><a href="#cb40-435" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(fit_meta_random)</span>
<span id="cb40-436"><a href="#cb40-436" aria-hidden="true" tabindex="-1"></a><span class="fu">fitted</span>(fit_meta_fixed)</span>
<span id="cb40-437"><a href="#cb40-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-438"><a href="#cb40-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-439"><a href="#cb40-439" aria-hidden="true" tabindex="-1"></a>As expected, the standard errors for the fixed effect analysis are</span>
<span id="cb40-440"><a href="#cb40-440" aria-hidden="true" tabindex="-1"></a>considerably smaller.</span>
<span id="cb40-441"><a href="#cb40-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-442"><a href="#cb40-442" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model analysis</span></span>
<span id="cb40-443"><a href="#cb40-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-444"><a href="#cb40-444" aria-hidden="true" tabindex="-1"></a>How to analyze a given model obviously depends very much on details of</span>
<span id="cb40-445"><a href="#cb40-445" aria-hidden="true" tabindex="-1"></a>the problem at hand. Often we wish to evaluate how well the model</span>
<span id="cb40-446"><a href="#cb40-446" aria-hidden="true" tabindex="-1"></a>describes the problem data used to fit the model. Thus, the ability of</span>
<span id="cb40-447"><a href="#cb40-447" aria-hidden="true" tabindex="-1"></a>the model to describe certain summaries of the data set accuratley is</span>
<span id="cb40-448"><a href="#cb40-448" aria-hidden="true" tabindex="-1"></a>one way to critize the model. Such an approach requires to compare</span>
<span id="cb40-449"><a href="#cb40-449" aria-hidden="true" tabindex="-1"></a>predictions of the data by the model $y_{rep}$ to the actual data</span>
<span id="cb40-450"><a href="#cb40-450" aria-hidden="true" tabindex="-1"></a>$y$. This procedure is referred to as posterior predictive checks. A</span>
<span id="cb40-451"><a href="#cb40-451" aria-hidden="true" tabindex="-1"></a>key feautre of the approach is to account for sampling uncertainty</span>
<span id="cb40-452"><a href="#cb40-452" aria-hidden="true" tabindex="-1"></a>implied by the endpoint and sample size.</span>
<span id="cb40-453"><a href="#cb40-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-454"><a href="#cb40-454" aria-hidden="true" tabindex="-1"></a>For a meta-analysis we may wish to check how well the summary</span>
<span id="cb40-455"><a href="#cb40-455" aria-hidden="true" tabindex="-1"></a>statistics of the historical data is predicted by the model. The</span>
<span id="cb40-456"><a href="#cb40-456" aria-hidden="true" tabindex="-1"></a><span class="in">`brms`</span> package integrates with the <span class="in">`bayesplot`</span> package for the purpose</span>
<span id="cb40-457"><a href="#cb40-457" aria-hidden="true" tabindex="-1"></a>of posterior predictive checks, which could look in this case like:</span>
<span id="cb40-458"><a href="#cb40-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-461"><a href="#cb40-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-462"><a href="#cb40-462" aria-hidden="true" tabindex="-1"></a><span class="co"># create intervals plot and label plot accordingly</span></span>
<span id="cb40-463"><a href="#cb40-463" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(fit_meta_random, <span class="at">type=</span><span class="st">"intervals"</span>, <span class="at">ndraws=</span><span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb40-464"><a href="#cb40-464" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">"Study"</span>, <span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(arm_data), <span class="at">labels=</span>arm_data<span class="sc">$</span>study) <span class="sc">+</span></span>
<span id="cb40-465"><a href="#cb40-465" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb40-466"><a href="#cb40-466" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb40-467"><a href="#cb40-467" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb40-468"><a href="#cb40-468" aria-hidden="true" tabindex="-1"></a>          <span class="do">## suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb40-469"><a href="#cb40-469" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb40-470"><a href="#cb40-470" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior predictive check"</span>, <span class="st">"Random effects model"</span>)</span>
<span id="cb40-471"><a href="#cb40-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-472"><a href="#cb40-472" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(fit_meta_fixed, <span class="at">type=</span><span class="st">"intervals"</span>, <span class="at">ndraws=</span><span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb40-473"><a href="#cb40-473" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">"Study"</span>, <span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(arm_data), <span class="at">labels=</span>arm_data<span class="sc">$</span>study) <span class="sc">+</span></span>
<span id="cb40-474"><a href="#cb40-474" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb40-475"><a href="#cb40-475" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb40-476"><a href="#cb40-476" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb40-477"><a href="#cb40-477" aria-hidden="true" tabindex="-1"></a>          <span class="do">## suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb40-478"><a href="#cb40-478" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb40-479"><a href="#cb40-479" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior predictive check"</span>, <span class="st">"Fixed effects model"</span>)</span>
<span id="cb40-480"><a href="#cb40-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-481"><a href="#cb40-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-482"><a href="#cb40-482" aria-hidden="true" tabindex="-1"></a>Shown is a central 50% credible interval with a thick line, a thinner</span>
<span id="cb40-483"><a href="#cb40-483" aria-hidden="true" tabindex="-1"></a>line shows the 90% credible interval, the open dot marks the median</span>
<span id="cb40-484"><a href="#cb40-484" aria-hidden="true" tabindex="-1"></a>prediction and the filled dark dot marks the observed value of the</span>
<span id="cb40-485"><a href="#cb40-485" aria-hidden="true" tabindex="-1"></a>data. We see is that in particular study 7 is predicted</span>
<span id="cb40-486"><a href="#cb40-486" aria-hidden="true" tabindex="-1"></a>unsatisfactory by the fixed effect model. An additional interesting</span>
<span id="cb40-487"><a href="#cb40-487" aria-hidden="true" tabindex="-1"></a>predictice check in this case is in view of a possibile use as</span>
<span id="cb40-488"><a href="#cb40-488" aria-hidden="true" tabindex="-1"></a>historical control information part of a new study. While the above</span>
<span id="cb40-489"><a href="#cb40-489" aria-hidden="true" tabindex="-1"></a>predictive check of the random effects was conditional on the fitted</span>
<span id="cb40-490"><a href="#cb40-490" aria-hidden="true" tabindex="-1"></a>data, we can instead use the random effects model and predict each</span>
<span id="cb40-491"><a href="#cb40-491" aria-hidden="true" tabindex="-1"></a>study as if it were a new study:</span>
<span id="cb40-492"><a href="#cb40-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-495"><a href="#cb40-495" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-496"><a href="#cb40-496" aria-hidden="true" tabindex="-1"></a><span class="co"># create intervals plot and label plot accordingly</span></span>
<span id="cb40-497"><a href="#cb40-497" aria-hidden="true" tabindex="-1"></a>pp_arm_data_new <span class="ot">&lt;-</span> <span class="fu">posterior_predict</span>(fit_meta_random,</span>
<span id="cb40-498"><a href="#cb40-498" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">newdata=</span><span class="fu">mutate</span>(arm_data, <span class="at">study=</span><span class="fu">paste0</span>(<span class="st">"new_"</span>, study)),</span>
<span id="cb40-499"><a href="#cb40-499" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">allow_new_levels=</span><span class="cn">TRUE</span>,</span>
<span id="cb40-500"><a href="#cb40-500" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">sample_new_levels=</span><span class="st">"gaussian"</span>)</span>
<span id="cb40-501"><a href="#cb40-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-502"><a href="#cb40-502" aria-hidden="true" tabindex="-1"></a><span class="co"># use bayesplot::ppc_intervals directly here</span></span>
<span id="cb40-503"><a href="#cb40-503" aria-hidden="true" tabindex="-1"></a><span class="fu">ppc_intervals</span>(<span class="at">y=</span>arm_data<span class="sc">$</span>r, <span class="at">yrep=</span>pp_arm_data_new) <span class="sc">+</span></span>
<span id="cb40-504"><a href="#cb40-504" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">"Study"</span>, <span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(arm_data), <span class="at">labels=</span>arm_data<span class="sc">$</span>study) <span class="sc">+</span></span>
<span id="cb40-505"><a href="#cb40-505" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb40-506"><a href="#cb40-506" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb40-507"><a href="#cb40-507" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb40-508"><a href="#cb40-508" aria-hidden="true" tabindex="-1"></a>          <span class="do">## suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb40-509"><a href="#cb40-509" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb40-510"><a href="#cb40-510" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior predictive check - new studies"</span>, <span class="st">"Random effects model"</span>)</span>
<span id="cb40-511"><a href="#cb40-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-512"><a href="#cb40-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-513"><a href="#cb40-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-514"><a href="#cb40-514" aria-hidden="true" tabindex="-1"></a>Now the credible intervals are wider as these contain additional</span>
<span id="cb40-515"><a href="#cb40-515" aria-hidden="true" tabindex="-1"></a>variability. As for study 7 the random effect is not anymore</span>
<span id="cb40-516"><a href="#cb40-516" aria-hidden="true" tabindex="-1"></a>conditioned on the data of the study, we see again that the model</span>
<span id="cb40-517"><a href="#cb40-517" aria-hidden="true" tabindex="-1"></a>struggles to account for the study nicely. However, with the additional</span>
<span id="cb40-518"><a href="#cb40-518" aria-hidden="true" tabindex="-1"></a>heterogeniety the result of study 7 is at least plausible given that</span>
<span id="cb40-519"><a href="#cb40-519" aria-hidden="true" tabindex="-1"></a>it is contained in the 90% credible interval.</span>
<span id="cb40-520"><a href="#cb40-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-521"><a href="#cb40-521" aria-hidden="true" tabindex="-1"></a>In the above discussion we have ensured the comparability of the plots</span>
<span id="cb40-522"><a href="#cb40-522" aria-hidden="true" tabindex="-1"></a>via matching the axis limits. A more straightforward is a side by side</span>
<span id="cb40-523"><a href="#cb40-523" aria-hidden="true" tabindex="-1"></a>comparison of the models, which can be achieved like:</span>
<span id="cb40-524"><a href="#cb40-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-525"><a href="#cb40-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-528"><a href="#cb40-528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb40-529"><a href="#cb40-529" aria-hidden="true" tabindex="-1"></a><span class="co"># use bayesplot::ppc_intervals_data directly here</span></span>
<span id="cb40-530"><a href="#cb40-530" aria-hidden="true" tabindex="-1"></a>model_cmp <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="at">random_new=</span><span class="fu">ppc_intervals_data</span>(<span class="at">y=</span>arm_data<span class="sc">$</span>r, <span class="at">yrep=</span>pp_arm_data_new),</span>
<span id="cb40-531"><a href="#cb40-531" aria-hidden="true" tabindex="-1"></a>                       <span class="at">random=</span><span class="fu">ppc_intervals_data</span>(<span class="at">y=</span>arm_data<span class="sc">$</span>r, <span class="at">yrep=</span><span class="fu">posterior_predict</span>(fit_meta_random)),</span>
<span id="cb40-532"><a href="#cb40-532" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fixed=</span><span class="fu">ppc_intervals_data</span>(<span class="at">y=</span>arm_data<span class="sc">$</span>r, <span class="at">yrep=</span><span class="fu">posterior_predict</span>(fit_meta_fixed)),</span>
<span id="cb40-533"><a href="#cb40-533" aria-hidden="true" tabindex="-1"></a>                       <span class="at">.id=</span><span class="st">"Model"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-534"><a href="#cb40-534" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add in labels into the data-set</span></span>
<span id="cb40-535"><a href="#cb40-535" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(<span class="fu">select</span>(<span class="fu">mutate</span>(arm_data, <span class="at">x=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>), x, study), <span class="at">by=</span><span class="st">"x"</span>)</span>
<span id="cb40-536"><a href="#cb40-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-537"><a href="#cb40-537" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(model_cmp, <span class="fu">aes</span>(study, m, <span class="at">colour=</span>Model)) <span class="sc">+</span></span>
<span id="cb40-538"><a href="#cb40-538" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>ll, <span class="at">ymax=</span>hh), <span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.4</span>)) <span class="sc">+</span></span>
<span id="cb40-539"><a href="#cb40-539" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y=</span>y_obs), <span class="at">colour=</span><span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb40-540"><a href="#cb40-540" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb40-541"><a href="#cb40-541" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Study"</span>) <span class="sc">+</span></span>
<span id="cb40-542"><a href="#cb40-542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb40-543"><a href="#cb40-543" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb40-544"><a href="#cb40-544" aria-hidden="true" tabindex="-1"></a>          <span class="co"># suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb40-545"><a href="#cb40-545" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb40-546"><a href="#cb40-546" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Posterior predictive check"</span>, <span class="st">"All models"</span>)</span>
<span id="cb40-547"><a href="#cb40-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-548"><a href="#cb40-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-549"><a href="#cb40-549" aria-hidden="true" tabindex="-1"></a>A more formal way to compare these models is to consider their ability</span>
<span id="cb40-550"><a href="#cb40-550" aria-hidden="true" tabindex="-1"></a>to predict new data. In absence of new data we may instead turn to</span>
<span id="cb40-551"><a href="#cb40-551" aria-hidden="true" tabindex="-1"></a>scores which evaluate the ability of the model to predict data which</span>
<span id="cb40-552"><a href="#cb40-552" aria-hidden="true" tabindex="-1"></a>has been left out when fitting the model. The leave-one-out scores can</span>
<span id="cb40-553"><a href="#cb40-553" aria-hidden="true" tabindex="-1"></a>be calculated using fast approximations (see <span class="in">`loo`</span> command) whenever</span>
<span id="cb40-554"><a href="#cb40-554" aria-hidden="true" tabindex="-1"></a>the data-set is large enough. We refer the reader to the case study on</span>
<span id="cb40-555"><a href="#cb40-555" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Dose finding</span><span class="co">](02b_dose_finding.html)</span> where these model comparisons are</span>
<span id="cb40-556"><a href="#cb40-556" aria-hidden="true" tabindex="-1"></a>discussed in greater detail.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>