<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sebastian Weber - sebastian.weber@novartis.com">

<title>4&nbsp; Use of historical control data – Applied Modelling in Drug Development</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../src/02ab_meta_analysis_trtdiff.html" rel="next">
<link href="../src/02_case_studies.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-989f635e0436309011e17b1a0ac5a5c1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="../resources/mathjax/tex-mml-chtml.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../bamdd.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/02_case_studies.html">Case studies</a></li><li class="breadcrumb-item"><a href="../src/02a_meta_analysis.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Use of historical control data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../bamdd_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Applied Modelling in Drug Development</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/Novartis/bamdd/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01a_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01b_basic_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01c_priors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Model setup &amp; priors</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../src/02_case_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Case studies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02a_meta_analysis.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Use of historical control data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02ab_meta_analysis_trtdiff.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Meta-analysis to estimate treatment effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02ac_meta_analysis_strata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Use of historical control data with stratification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02k_nuisance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Nuisance parameters, expected power and the “significance threshold”</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02l_single_arm_pos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Probability of success from a single arm trial</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02k_nuisance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Nuisance parameters, expected power and the “significance threshold”</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02b_dose_finding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Dose finding</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02c_dose_escalation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Oncology dose escalation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02cb_tte_dose_escalation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Time-to-event modelling in Oncology dose escalation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02e_multiple_imputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multiple imputation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02g_longitudinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Longitudinal data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02h_mmrm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Bayesian Mixed effects Model for Repeated Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02i_time_to_event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Time-to-event data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02j_network_meta_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Network meta-analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02m_proportion_difference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Difference in proportions from a fitted logistic regression</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03a_stan_code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Exposing stan code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03b_parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Parallel computation</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background"><span class="header-section-number">4.1</span> Background</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">4.2</span> Data</a></li>
  <li><a href="#model-description" id="toc-model-description" class="nav-link" data-scroll-target="#model-description"><span class="header-section-number">4.3</span> Model description</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><span class="header-section-number">4.4</span> Implementation</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="header-section-number">4.5</span> Results</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">4.6</span> Conclusion</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">4.7</span> Exercises</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/02_case_studies.html">Case studies</a></li><li class="breadcrumb-item"><a href="../src/02a_meta_analysis.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Use of historical control data</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-use-hist-control-data" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Use of historical control data</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sebastian Weber - <a href="mailto:sebastian.weber@novartis.com" class="email">sebastian.weber@novartis.com</a> </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<!-- https://raw.githubusercontent.com/Novartis/bamdd/main/src/_macros.qmd -->
<p>Here we will demonstrate the use of historical control data as an example for a meta-analytic predictive (MAP) prior approach based on random-effects meta-analyses. The intention of using a MAP prior is to reduce the sample size in a control group of a new trial while maintaining power to detect a treatment effect. This is achieved by synthesizing available information on a control treatment, which is then used in the form of an informative prior for the analysis in the new trial.</p>
<p>This case study demonstrates</p>
<ul>
<li>setting up a random effect meta-analysis with up to two levels</li>
<li>setting up model priors</li>
<li>how to use the model outputs from <code>brms</code> as input to the R package <code>RBesT</code>, which allows to further evaluate MAP priors for a trial design.</li>
</ul>
<p>To run the R code of this section please ensure to load these libraries and options first:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RBesT)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend=</span><span class="st">"cmdstanr"</span>, <span class="at">cmdstanr_write_stan_file_dir=</span><span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create cache directory if not yet available</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">593467</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="background" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="background"><span class="header-section-number">4.1</span> Background</h2>
<p>Given the relevance of the use of historical control data problem for drug development, a full R package <code>RBesT</code> (R Bayesian evidence synthesis tools) is available on <a href="https://cran.r-project.org/package=RBesT">CRAN</a>. Here we will re-implement the example of the vignette of <code>RBesT</code> for the <a href="https://cran.r-project.org/web/packages/RBesT/vignettes/introduction.html">binary case</a> and will illustrate how <code>brms</code> can be used in a more complex setting as a case study. In particular, we are going to assume as a complication that the historical trial data has been collected in specific regions of the world and how this can be used to borrow strength between regions. As a simplifying assumption it is assumed that trials are nested within regions thereby implying that trials are conducting exclusively in specific regions.</p>
<p>For details on the <code>RBesT</code> R package, please refer to</p>
<ul>
<li>Weber et al.&nbsp;(2021) <a href="https://doi.org/10.18637/jss.v100.i19">doi:10.18637/jss.v100.i19</a> for details on applying the <code>RBesT</code> package, and</li>
<li>Neuenschwander et al.&nbsp;(2010) <a href="https://doi.org/10.1177/1740774509356002">doi:10.1177/1740774509356002</a> and</li>
<li>Schmidli et al.&nbsp;(2014) <a href="https://doi.org/10.1111/biom.12242">doi:10.1111/biom.12242</a> for details on the MAP methodology.</li>
</ul>
</section>
<section id="data" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="data"><span class="header-section-number">4.2</span> Data</h2>
<p>A Phase II study is planned to evaluate the efficacy of a test treatment in a randomized comparison with placebo in the disease ankylosing spondilityis. At the design stage of the trial control group data were available from a total of eight historical studies.</p>
<p>This data-set is part of the <code>RBesT</code> package as the <code>AS</code> data-set and here we add as additional column a randomly assigned <code>region</code> variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RBesT)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>AS_region <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(AS, <span class="at">region=</span><span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"asia"</span>, <span class="st">"europe"</span>, <span class="st">"north_america"</span>), <span class="dv">8</span>, <span class="cn">TRUE</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(AS_region)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">study</th>
<th style="text-align: right;">n</th>
<th style="text-align: right;">r</th>
<th style="text-align: left;">region</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Study 1</td>
<td style="text-align: right;">107</td>
<td style="text-align: right;">23</td>
<td style="text-align: left;">asia</td>
</tr>
<tr class="even">
<td style="text-align: left;">Study 2</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">europe</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Study 3</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">19</td>
<td style="text-align: left;">north_america</td>
</tr>
<tr class="even">
<td style="text-align: left;">Study 4</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">9</td>
<td style="text-align: left;">europe</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Study 5</td>
<td style="text-align: right;">139</td>
<td style="text-align: right;">39</td>
<td style="text-align: left;">north_america</td>
</tr>
<tr class="even">
<td style="text-align: left;">Study 6</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">asia</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Study 7</td>
<td style="text-align: right;">78</td>
<td style="text-align: right;">9</td>
<td style="text-align: left;">europe</td>
</tr>
<tr class="even">
<td style="text-align: left;">Study 8</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">asia</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The total number of 513 patients in the 8 trials is quite substantial.</p>
</section>
<section id="model-description" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="model-description"><span class="header-section-number">4.3</span> Model description</h2>
<p>The <code>RBesT</code> package implements the MAP approach following a standard generalized linear modeling framework for a random-effects meta-analysis:</p>
<ul>
<li><p><span class="math inline">\(Y\)</span> is the (control) group summary data for <span class="math inline">\(H\)</span> historical trials</p></li>
<li><p><span class="math inline">\(Y_{h}|\theta_{h} \sim f(\theta_{h})\)</span></p></li>
<li><p><span class="math inline">\(g(\theta_{h}) = \beta + \eta_h\)</span></p></li>
<li><p><span class="math inline">\(\eta_h|\tau \sim \mbox{Normal}(0, \tau^2)\)</span></p></li>
<li><p><span class="math inline">\(f\)</span> likelihood: Binomial, Normal (known <span class="math inline">\(\sigma\)</span>) or Poisson</p></li>
<li><p><span class="math inline">\(g\)</span> link function for each likelihood <span class="math inline">\(f\)</span>: <span class="math inline">\(\mbox{logit}\)</span>, identity or <span class="math inline">\(\log\)</span></p></li>
<li><p><span class="math inline">\(\beta\)</span> population mean with prior <span class="math inline">\(\mbox{Normal}(m_{\beta}, s_{\beta}^2)\)</span></p></li>
<li><p><span class="math inline">\(\tau\)</span> between-trial heterogeneity with prior <span class="math inline">\(P_\tau\)</span></p></li>
</ul>
<p>The priors used for this data-set will be:</p>
<ul>
<li><span class="math inline">\(\beta \sim \mbox{Normal}(0, 2^2)\)</span></li>
<li><span class="math inline">\(\tau \sim \mbox{Normal}^+(0, 1)\)</span></li>
</ul>
<p>We will first run the analysis with the <code>RBesT</code> command <code>gMAP</code>. As a next step we will convert the analysis to use <code>brms</code> for the inference. Finally, we will add an additional random effect for the region <span class="math inline">\(j\)</span> and treat the random effect for the studies to be nested within the region. As the more general model requires two levels of random effects, it is outside the possible models of <code>RBesT</code>. Such a more general region specific model can be useful in various situations whenever we wish to borrow strength across regions. Denoting with <span class="math inline">\(j\)</span> specific regions, the more general model is then:</p>
<ul>
<li><p><span class="math inline">\(Y_{h,j}|\theta_{h,j} \sim f(\theta_{h,j})\)</span></p></li>
<li><p><span class="math inline">\(g(\theta_{h,j}) = \beta + \eta_h + \nu_j\)</span></p></li>
<li><p><span class="math inline">\(\eta_h|\tau \sim \mbox{Normal}(0, \tau^2)\)</span></p></li>
<li><p><span class="math inline">\(\nu_j|\omega \sim \mbox{Normal}(0, \omega^2)\)</span></p></li>
</ul>
<p>In our case study we make a simplifying assumption that any trial <span class="math inline">\(h\)</span> is run entirely within a given region <span class="math inline">\(j\)</span>. Therefore we have a nested structure (trials within regions) such that no correlation is modeled between region and trial. This would be different if some trials were run across different regions and trial results would be reported by region.</p>
</section>
<section id="implementation" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="implementation"><span class="header-section-number">4.4</span> Implementation</h2>
<p>With the <code>gMAP</code> command in <code>RBesT</code> we can obtain MCMC samples from posterior for the first model as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">34767</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>map_mc_rbest <span class="ot">&lt;-</span> <span class="fu">gMAP</span>(<span class="fu">cbind</span>(r, n<span class="sc">-</span>r) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> study,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family=</span>binomial,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data=</span>AS_region,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">tau.dist=</span><span class="st">"HalfNormal"</span>, <span class="at">tau.prior=</span><span class="dv">1</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">beta.prior=</span><span class="fu">cbind</span>(<span class="dv">0</span>,<span class="dv">2</span>))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>map_mc_rbest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized Meta Analytic Predictive Prior Analysis

Call:  gMAP(formula = cbind(r, n - r) ~ 1 | study, family = binomial, 
    data = AS_region, tau.dist = "HalfNormal", tau.prior = 1, 
    beta.prior = cbind(0, 2))

Exchangeability tau strata: 1 
Prediction tau stratum    : 1 
Maximal Rhat              : 1 

Between-trial heterogeneity of tau prediction stratum
  mean     sd   2.5%    50%  97.5% 
0.3730 0.2040 0.0441 0.3490 0.8450 

MAP Prior MCMC sample
  mean     sd   2.5%    50%  97.5% 
0.2560 0.0863 0.1090 0.2470 0.4710 </code></pre>
</div>
</div>
<p>Using <code>brms</code> we now specify the MAP model step by step. Binomial data is specified slightly different in <code>brms</code>. We first define the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">bf</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> study), <span class="at">family=</span>binomial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The left hand side of the formula, <code>r | trials(n) ~ ...</code>, denotes with <code>r</code> the data being modeled - the number of responders - and adds with a bar <code>|</code> additional information on the response, which are the number of overall trials, needed to interpret the binomial likelihood.</p>
<p>With the model (and data) being defined, we are left to specify the model priors. With the help of the call</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(model, AS_region)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior     class      coef group resp dpar nlpar lb ub
 student_t(3, 0, 2.5) Intercept                                      
 student_t(3, 0, 2.5)        sd                                  0   
 student_t(3, 0, 2.5)        sd           study                  0   
 student_t(3, 0, 2.5)        sd Intercept study                  0   
       source
      default
      default
 (vectorized)
 (vectorized)</code></pre>
</div>
</div>
<p>we can ask <code>brms</code> as to what model parameters it has detected for which priors should be specified. In this example, we need to define the population mean intercept (<span class="math inline">\(\beta\)</span>) and the between-study heterogeneity parameter (<span class="math inline">\(\tau\)</span>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model_prior <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>Intercept) <span class="sc">+</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>study)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are ready to run the model in <code>brms</code> (we are setting <code>refresh=1000</code> to suppress most progress output):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>map_mc_brms  <span class="ot">&lt;-</span> <span class="fu">brm</span>(model, AS_region, <span class="at">prior=</span>model_prior,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed=</span><span class="dv">4767</span>, <span class="at">refresh=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>make[2]: warning: jobserver unavailable: using -j1.  Add '+' to parent make rule.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.2 seconds.
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 0.2 seconds.
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 0.2 seconds.
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 0.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.2 seconds.
Total execution time: 1.2 seconds.</code></pre>
</div>
</div>
<p>The model is compiled and then run. Occasionally one observes a warning on divergent transitions after warmup reported like:</p>
<blockquote class="blockquote">
<p><code>## Warning: There were 1 divergent transitions after warmup.</code></p>
</blockquote>
<p>This is caused in this case by the choice of very conservative priors, which lead to a difficult to sample posterior. As a quick fix we may reduce the aggressiveness of the sampler and increase the sampler parameter on the target acceptance probability <code>adapt_delta</code> from it’s default value <span class="math inline">\(0.8\)</span> to a value closer to the maximum possible value of <span class="math inline">\(1.0\)</span>. For most analyses with weak priors using a value of <span class="math inline">\(0.95\)</span> can be used as a starting value. This is at the cost of some sampling speed as the sampler will take smaller steps, but the choice of a higher than default acceptance probability results in more robust inference and avoids in many instances the warning about divergences. For a more comprehensive overview on possible warnings, their meanings and how to address these, please refer to the <a href="https://mc-stan.org/misc/warnings.html">online help of the Stan project on possible Stan stampler warnings and messages</a>.</p>
<p>In order to also avoid having to compile the Stan code for the model once more, we use the <code>update</code> functionality of <code>brms</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>map_mc_brms_2 <span class="ot">&lt;-</span> <span class="fu">update</span>(map_mc_brms, <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># the two options below only silence Stan sampling output</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.3 seconds.
Chain 2 finished in 0.2 seconds.
Chain 3 finished in 0.2 seconds.
Chain 4 finished in 0.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.2 seconds.
Total execution time: 1.2 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>map_mc_brms_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: r | trials(n) ~ 1 + (1 | study) 
   Data: AS_region (Number of observations: 8) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~study (Number of levels: 8) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     0.38      0.21     0.05     0.88 1.00     1086     1053

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept    -1.10      0.19    -1.49    -0.74 1.00     1517     1680

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>We can see that the estimate of the between-study heterogeneity <span class="math inline">\(\tau\)</span> is very similar between <code>RBesT</code> and <code>brms</code>. However, the MAP prior is not apparent from the output of <code>brms</code> directly (as it’s not designed with this specific application in mind).</p>
<p>To obtain the MAP prior from <code>brms</code>, we have to predict the response rate of a new study. To do so, a new data set with the same columns as the modeling data sets needs to be created.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>AS_region_new <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">study=</span><span class="st">"new_study_asia"</span>, <span class="at">r=</span><span class="dv">0</span>, <span class="at">n=</span><span class="dv">6</span>, <span class="at">region=</span><span class="st">"asia"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>post_map_mc_brms <span class="ot">&lt;-</span> <span class="fu">posterior_linpred</span>(map_mc_brms_2,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">newdata=</span>AS_region_new,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="co"># apply inverse link function</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">transform=</span><span class="cn">TRUE</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="co"># allows new studies</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>                                      <span class="co"># and samples these according to the model</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">sample_new_levels =</span> <span class="st">"gaussian"</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>                                      )</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's have a look at what we got:</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(post_map_mc_brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> num [1:4000, 1] 0.233 0.219 0.181 0.252 0.2 ...</code></pre>
</div>
</div>
<p>Model outputs are returned in the standard format of a matrix which contains the model simulations. While the rows label the draws, the columns go along with the rows of the input data set. As in this case we have as input data set a 1-row data frame <code>AS_region_new</code> corresponding to predictions for a (single) new study, the output is a 1 column matrix with 4000 rows, since 4000 draws in total were obtained from the sampler run with 4 chains and 1000 draws per chain from the sampling phase.</p>
<p>Note the following important arguments used to obtain the posterior:</p>
<ul>
<li><code>transform=TRUE</code> applies automatically the inverse link function such that we get response rates rather than logit values.</li>
<li><code>allow_new_levels=TRUE</code> is needed to instruct <code>brms</code> that new levels of the fitted random effects are admissible in the data. In this case we sample a new study random effect level.</li>
<li><code>sample_new_levels="gaussian"</code> ensures that the new random effect is sampled according to normal distributions as specified with the model. The default option <code>"uncertainty"</code> samples for each draw from the fitted random effect levels one realization, which is essentially bootstrapping random effects on the level of posterior draws. The option <code>"old_levels"</code> samples a random effect level and substitutes <em>all</em> draws for the new level corresponding to bootstrapping the existing levels. While this avoids normality assumptions, it can only work well in situations with many levels of the random effect. The option <code>"gaussian"</code> is for most models the preferred choice and for more details, please refer to the <code>brms</code> help page on <code>prepare_predictions</code>.</li>
</ul>
<p>A convenient way to get a summary of the samples is to use the <code>summarize_draws</code> function from the <code>posterior</code> package (used as a helper package in <code>brms</code> already):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize_draws</span>(post_map_mc_brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  variable  mean median     sd    mad    q5   q95  rhat ess_bulk ess_tail
  &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 ...1     0.259  0.250 0.0860 0.0672 0.135 0.414 1.000    2466.    2855.</code></pre>
</div>
</div>
<p>These estimates are now very similar to the results reported from <code>RBesT</code> reported above (up to sampling error).</p>
<p>Expanding the model to include region would only be possible in <code>RBesT</code> via the use of an additional fixed effect. However, this would essentially refit the model for each region <em>separately</em> and hence limit the amount of information we can borrow among regions. With <code>brms</code> it is straightforward to specify the nested random effects structure described in the <em>Model Details</em> Section. Following the same steps as before, setting up the brms model may look like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>region_model <span class="ot">&lt;-</span> <span class="fu">bf</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> region<span class="sc">/</span>study), <span class="at">family=</span>binomial)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(region_model, AS_region)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                prior     class      coef        group resp dpar nlpar lb ub
 student_t(3, 0, 2.5) Intercept                                             
 student_t(3, 0, 2.5)        sd                                         0   
 student_t(3, 0, 2.5)        sd                 region                  0   
 student_t(3, 0, 2.5)        sd Intercept       region                  0   
 student_t(3, 0, 2.5)        sd           region:study                  0   
 student_t(3, 0, 2.5)        sd Intercept region:study                  0   
       source
      default
      default
 (vectorized)
 (vectorized)
 (vectorized)
 (vectorized)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>region_model_prior <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>Intercept) <span class="sc">+</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>region) <span class="sc">+</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.25</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>region<span class="sc">:</span>study)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>region_map_mc_brms  <span class="ot">&lt;-</span> <span class="fu">brm</span>(region_model, AS_region, <span class="at">prior=</span>region_model_prior, <span class="at">seed=</span><span class="dv">4767</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.99</span>),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>make[2]: warning: jobserver unavailable: using -j1.  Add '+' to parent make rule.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.6 seconds.
Chain 2 finished in 0.6 seconds.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: binomial_logit_lpmf: Probability parameter[1] is -inf, but must be finite! (in '/tmp/Rtmp5Ah5rS/model-25e053924072.stan', line 53, column 4 to column 50)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 finished in 0.8 seconds.
Chain 4 finished in 0.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.7 seconds.
Total execution time: 3.3 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>post_region_map_mc_brms <span class="ot">&lt;-</span> <span class="fu">posterior_linpred</span>(region_map_mc_brms,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">newdata=</span>AS_region_new,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">transform=</span><span class="cn">TRUE</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">sample_new_levels =</span> <span class="st">"gaussian"</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>                                             )</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's have a look at what we got:</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize_draws</span>(post_region_map_mc_brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  variable  mean median     sd    mad    q5   q95  rhat ess_bulk ess_tail
  &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 ...1     0.250  0.246 0.0587 0.0490 0.165 0.356  1.00    4336.    3960.</code></pre>
</div>
</div>
<p>The key difference to the previous model is the nested random effect specification term <code>(1 | region/study)</code> of the model formula. This syntax denotes a random intercept term for <code>region</code> and <code>study</code> in a way which assumes a nested data structure in that a given study is only run in a single region.</p>
</section>
<section id="results" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="results"><span class="header-section-number">4.5</span> Results</h2>
<p>Once the MAP prior is obtained in MCMC form a model check of is recommended. In <code>RBesT</code> a forest plot augmented with model shrinkage estimates is suggested for this purpose:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map_mc_rbest)<span class="sc">$</span>forest_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02a_meta_analysis_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The dashed lines show the 95% confidence intervals of each study estimate on it’s own while the solid line shows the respective shrinkage estimate of the MAP model. This plot is useful to assess the plausibility of the results and may unveil possible issues with the model specification. In <code>brms</code> model diagnostic functions are directly available and essentially expose the functionality found in the <a href="https://mc-stan.org/bayesplot/index.html"><code>bayesplot</code></a> R package. A suitable <code>bayesplot</code> plot in this situation could be an <code>intervals</code> plot as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(map_mc_brms_2, <span class="at">type=</span><span class="st">"intervals"</span>) <span class="sc">+</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">"Study"</span>, <span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(AS_region), <span class="at">labels=</span>AS_region<span class="sc">$</span>study) <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>          <span class="co"># suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using all posterior draws for ppc type 'intervals' by default.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02a_meta_analysis_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The call of the <code>pp_check</code> function is forwarded to the respective <code>ppc_*</code> functions for posterior predictive checks from <code>bayesplot</code> (depending on the <code>type</code> argument). The plots are designed to compare the <em>posterior predictive</em> distribution to the observed data rather than comparing mean estimates to one another. Thus, the outcome of each trial in the original data set is sampled according to the fitted model and the resulting predictive distribution of the outcome (number of responders) is compared to the observed outcome. The <code>intervals</code> predictive probability check summarises the predictive distributions using a light color for an outer credible interval range and a darker line for an inner credible interval. The outer defaults to a 90% credible interval (<code>prob_outer</code> argument) while the inner uses a 50% credible interval (<code>prob</code> argument). The light dot in the middle is the median of the predictive distribution and the dark dot is the outcome <span class="math inline">\(y\)</span>. As we can observe, the outcomes <span class="math inline">\(y\)</span> of the trials all are contained within outer credible intervals of the predictive distributions for the simulated replicate data <span class="math inline">\(y_{rep}\)</span>. However, one may critizise that also the 50% credible intervals contain all but two trials (study 3, study 7). Hence, the <em>calibration</em> of the model with the data is possibly not ideal given that every other trial outcome should be outside (or inside) of the 50% predictive interval. Comparing with a binomial distribution one can find that such an outcome can occur in 14% of the cases and does not represent an extreme finding such that we can conclude that the model is consistent with the data.</p>
<p>Once the model has been checked for plausibility, we can proceed and derive the main target of the MAP analysis, which is the MAP prior in <em>parametric</em> form. <code>RBesT</code> provides a fitting procedure, based in the EM algorithm, for approximating the MCMC output of the MAP prior in parametric form using mixture distributions. In the case of a binomial response Beta mixtures are being estimated:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>map_rbest <span class="ot">&lt;-</span> <span class="fu">automixfit</span>(map_mc_rbest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And a comparison of the fitted density vs the histogram of the MCMC sample is available as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map_rbest)<span class="sc">$</span>mix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02a_meta_analysis_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The <code>automixfit</code> function above recognizes that the <code>map_mc_rbest</code> object is a <code>gMAP</code> analysis object and automatically calls the correct Beta EM mixture algorithm for proportions. When working with <code>brms</code> we also do obtain the MAP prior in MCMC form on the response scale, but we need to provide <code>automixfit</code> additional information on the provided MCMC sample like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>map_brms <span class="ot">&lt;-</span> <span class="fu">automixfit</span>(post_map_mc_brms[,<span class="dv">1</span>], <span class="at">type=</span><span class="st">"beta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this stage we can work with <code>map_brms_2</code> just like we would when using <code>RBesT</code> directly such that the graphical diagnostic of the fit still works:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map_brms)<span class="sc">$</span>mix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02a_meta_analysis_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Comparing the results of using either packages shows that the two resulting MAP prior distributions are representing the same evidence (up to MCMC sampling error):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">rbind</span>(<span class="at">rbest=</span><span class="fu">summary</span>(map_rbest),</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">brms=</span><span class="fu">summary</span>(map_brms)),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">2.5%</th>
<th style="text-align: right;">50.0%</th>
<th style="text-align: right;">97.5%</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">rbest</td>
<td style="text-align: right;">0.256</td>
<td style="text-align: right;">0.086</td>
<td style="text-align: right;">0.105</td>
<td style="text-align: right;">0.247</td>
<td style="text-align: right;">0.472</td>
</tr>
<tr class="even">
<td style="text-align: left;">brms</td>
<td style="text-align: right;">0.259</td>
<td style="text-align: right;">0.086</td>
<td style="text-align: right;">0.111</td>
<td style="text-align: right;">0.250</td>
<td style="text-align: right;">0.474</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For the region specific model, two different types of priors can be derived. One may wish to obtain a MAP prior for one of the considered regions or for a new region:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predict a new study for all fitted region and other (=a new region)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>AS_region_all <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">region=</span><span class="fu">c</span>(<span class="st">"asia"</span>, <span class="st">"europe"</span>, <span class="st">"north_america"</span>, <span class="st">"other"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study=</span><span class="fu">paste</span>(<span class="st">"new_study"</span>, region, <span class="at">sep=</span><span class="st">"_"</span>), <span class="at">r=</span><span class="dv">0</span>, <span class="at">n=</span><span class="dv">6</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>post_region_all_map_mc_brms <span class="ot">&lt;-</span> <span class="fu">posterior_linpred</span>(region_map_mc_brms,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">newdata=</span>AS_region_all,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">transform=</span><span class="cn">TRUE</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">sample_new_levels =</span> <span class="st">"gaussian"</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                                                 )</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co"># name columns according to their region...</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(post_region_all_map_mc_brms) <span class="ot">&lt;-</span> AS_region_all<span class="sc">$</span>region</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="co">#...to obtain nice labels in a visualization with bayesplot</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_intervals</span>(post_region_all_map_mc_brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02a_meta_analysis_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain parametric mixture for each region, always using </span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 mixture components (often sufficient) to speed up inference</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>map_region <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(r <span class="cf">in</span> AS_region_all<span class="sc">$</span>region) {</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    map_region[[r]] <span class="ot">&lt;-</span> <span class="fu">mixfit</span>(post_region_all_map_mc_brms[,r], <span class="at">type=</span><span class="st">"beta"</span>, <span class="at">Nc=</span><span class="dv">3</span>, <span class="at">constrain_gt1=</span><span class="cn">TRUE</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These MAP priors summaries are:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">bind_rows</span>(<span class="fu">lapply</span>(map_region, summary), <span class="at">.id=</span><span class="st">"MAP"</span>), <span class="at">digits=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">MAP</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">2.5%</th>
<th style="text-align: right;">50.0%</th>
<th style="text-align: right;">97.5%</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">asia</td>
<td style="text-align: right;">0.250</td>
<td style="text-align: right;">0.058</td>
<td style="text-align: right;">0.150</td>
<td style="text-align: right;">0.246</td>
<td style="text-align: right;">0.394</td>
</tr>
<tr class="even">
<td style="text-align: left;">europe</td>
<td style="text-align: right;">0.219</td>
<td style="text-align: right;">0.057</td>
<td style="text-align: right;">0.122</td>
<td style="text-align: right;">0.214</td>
<td style="text-align: right;">0.356</td>
</tr>
<tr class="odd">
<td style="text-align: left;">north_america</td>
<td style="text-align: right;">0.285</td>
<td style="text-align: right;">0.063</td>
<td style="text-align: right;">0.167</td>
<td style="text-align: right;">0.282</td>
<td style="text-align: right;">0.433</td>
</tr>
<tr class="even">
<td style="text-align: left;">other</td>
<td style="text-align: right;">0.260</td>
<td style="text-align: right;">0.095</td>
<td style="text-align: right;">0.102</td>
<td style="text-align: right;">0.249</td>
<td style="text-align: right;">0.499</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The summaries show that we have higher precision for regions with more trials and the least precision for the MAP prior for a new (<code>"other"</code>) region, for which there were no trials. An alternative way to quantify the informativeness of the MAP prior is the effective sample size as provided by <code>RBesT</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(map_region, ess)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         asia        europe north_america         other 
     72.13054      62.49456      60.78744      25.74403 </code></pre>
</div>
</div>
<p>At this point the tools from <code>RBesT</code> can be used to assess further properties of trial designs which use these MAP priors. Please refer to the <a href="https://cran.r-project.org/web/packages/RBesT/vignettes/introduction.html">getting started vignette</a> of <code>RBesT</code>.</p>
</section>
<section id="conclusion" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">4.6</span> Conclusion</h2>
<p>The random-effects meta-analysis model implemented in <code>RBesT</code> has been re-implemented with <code>brms</code>. In a second step the meta-analysis has been extended to account for trial regions. This enables stronger borrowing within regions and hence a more informative MAP prior as can be seen by the effective sample size measure. Moreover, the case study also demonstrates how posterior samples produced with <code>brms</code> can be used as an input to <code>RBesT</code> such that both tools can be used in combination.</p>
</section>
<section id="exercises" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="exercises"><span class="header-section-number">4.7</span> Exercises</h2>
<ol type="1">
<li>Create a posterior predictive check based on the predictive distribution for the response rate.<br>
Steps:
<ul>
<li>Use <code>posterior_predict</code> to create samples from the predictive distribution of outcomes per trial.</li>
<li>Use <code>sweep(predictive, 2, AS_region$n, "/")</code> to convert these samples from the predictive distribution of the outcome counts to samples from the predictive distribution for responder rates.</li>
<li>Use <code>ppc_intervals</code> from <code>bayesplot</code> to create a plot showing your results.</li>
</ul></li>
<li>Redo the analysis with region, but treat region as a fixed effect. Evaluate the informativeness of the obtained MAP priors. The model formula for <code>brms</code> should look like <code>region_model_fixed &lt;- bf(r | trials(n) ~ 1 + region + (1 | study),    family=binomial)</code>. Steps:
<ul>
<li>Consider the prior for the region fixed effect first. The reference region is included in the intercept. The reference region is implicitly defined by the first level of the variable region when defined as <code>factor</code>.
<ul>
<li>Define <code>asia</code> to be the reference region in the example. Also include a level <code>other</code> in the set of levels.</li>
<li>Assume that an odds-ratio of <span class="math inline">\(2\)</span> between regions can be seen as very large such that a prior of <span class="math inline">\(\mbox{Normal}(0, (\log(2)/1.96)^2)\)</span> for the region main effect is adequate.</li>
</ul></li>
<li>Obtain the MAP prior for each region by using the <code>AS_region_all</code> data frame defined above and apply <code>posterior_linpred</code> as shown above.</li>
<li>Convert the MCMC samples from the MAP prior distribution into mixture distributions with the same code as above.</li>
<li>Calculate the ESS for each prior distribution with the <code>ess</code> function from <code>RBesT</code>.</li>
</ul></li>
<li>Run the analysis for the normal endpoint in the <code>crohn</code> data set of <code>RBesT</code>. Refer to the <code>RBesT</code> vignette for a <a href="https://cran.r-project.org/web/packages/RBesT/vignettes/introduction_normal.html">normal endpoint</a> on more details and context. Steps:
<ul>
<li>Use as <code>family=gaussian</code> and use the <code>se</code> response modifier in place of <code>trials</code> to specify a known standard error.</li>
<li>Use the same priors as proposed in the vignette.</li>
<li>Compare the obtained MAP prior (in MCMC sample form) from <code>RBesT</code> and <code>brms</code>.</li>
</ul></li>
</ol>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/opensource\.nibr\.com\/bamdd\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../src/02_case_studies.html" class="pagination-link" aria-label="Case studies">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Case studies</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../src/02ab_meta_analysis_trtdiff.html" class="pagination-link" aria-label="Meta-analysis to estimate treatment effects">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Meta-analysis to estimate treatment effects</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb49" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co">  - Sebastian Weber - &lt;sebastian.weber@novartis.com&gt;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu"># Use of historical control data {#sec-use-hist-control-data}</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- https://raw.githubusercontent.com/Novartis/bamdd/main/src/_macros.qmd --&gt;</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>{{&lt; include _macros.qmd &gt;}}</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>Here we will demonstrate the use of historical control data as an</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>example for a meta-analytic predictive (MAP) prior approach based on</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>random-effects meta-analyses. The intention of using a MAP prior is to</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>reduce the sample size in a control group of a new trial while</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>maintaining power to detect a treatment effect. This is achieved by</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>synthesizing available information on a control treatment, which is</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>then used in the form of an informative prior for the analysis in the</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>new trial.</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>This case study demonstrates</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>setting up a random effect meta-analysis with up to two levels</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>setting up model priors</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>how to use the model outputs from <span class="in">`brms`</span> as input to the R package</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>  <span class="in">`RBesT`</span>, which allows to further evaluate MAP priors for a trial</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>  design.</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>To run the R code of this section please ensure to load these</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>libraries and options first:</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=TRUE,echo=TRUE,message=FALSE,warning=FALSE}</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RBesT)</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a><span class="co"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend=</span><span class="st">"cmdstanr"</span>, <span class="at">cmdstanr_write_stan_file_dir=</span><span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="co"># create cache directory if not yet available</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>)</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">593467</span>)</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include=FALSE, echo=FALSE, eval=TRUE}</span></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="co"># invisible to the reader additional setup steps, which are optional</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a><span class="co"># {{&lt; include setup.R &gt;}}</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"setup.R"</span>)</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a><span class="fu">## Background</span></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>Given the relevance of the use of historical control data problem for</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>drug development, a full R package <span class="in">`RBesT`</span> (R Bayesian evidence</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>synthesis tools) is available on</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">CRAN</span><span class="co">](https://cran.r-project.org/package=RBesT)</span>. Here we will</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>re-implement the example of the vignette of <span class="in">`RBesT`</span> for the [binary</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>case](https://cran.r-project.org/web/packages/RBesT/vignettes/introduction.html)</span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>and will illustrate how <span class="in">`brms`</span> can be used in a more complex setting</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>as a case study. In particular, we are going to assume as a</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>complication that the historical trial data has been collected in</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>specific regions of the world and how this can be used to borrow</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>strength between regions. As a simplifying assumption it is assumed</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>that trials are nested within regions thereby implying that trials are</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>conducting exclusively in specific regions. </span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a>For details on the <span class="in">`RBesT`</span> R package, please refer to</span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Weber et al. (2021) <span class="co">[</span><span class="ot">doi:10.18637/jss.v100.i19</span><span class="co">](https://doi.org/10.18637/jss.v100.i19)</span> for</span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a>details on applying the <span class="in">`RBesT`</span> package, and</span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Neuenschwander et al. (2010) <span class="co">[</span><span class="ot">doi:10.1177/1740774509356002</span><span class="co">](https://doi.org/10.1177/1740774509356002)</span></span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>and</span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Schmidli et al. (2014) <span class="co">[</span><span class="ot">doi:10.1111/biom.12242</span><span class="co">](https://doi.org/10.1111/biom.12242)</span> for</span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a>details on the MAP methodology.</span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-profile="dummy"}</span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview Video</span></span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a>{{&lt; video videos/brms-case-1-historical-data-MAP.mp4 &gt;}}</span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a>A Phase II study is planned to evaluate the efficacy of a test treatment in</span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a>a randomized comparison with placebo in the disease ankylosing</span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a>spondilityis. At the design stage of the trial control group data were available </span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a>from a total of eight historical studies.</span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a>This data-set is part of the <span class="in">`RBesT`</span> package as the <span class="in">`AS`</span></span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a>data-set and here we add as additional column a randomly assigned</span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a><span class="in">`region`</span> variable:</span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RBesT)</span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a>AS_region <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(AS, <span class="at">region=</span><span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"asia"</span>, <span class="st">"europe"</span>, <span class="st">"north_america"</span>), <span class="dv">8</span>, <span class="cn">TRUE</span>))</span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(AS_region)</span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a>The total number of <span class="in">`r sum(AS_region$n)`</span> patients in the <span class="in">`r length(AS_region$n)`</span> trials is quite substantial.</span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model description</span></span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a>The <span class="in">`RBesT`</span> package implements the MAP approach following a standard</span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a>generalized linear modeling framework for a random-effects</span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a>meta-analysis:</span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Y$ is the (control) group summary data for $H$ historical trials</span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Y_{h}|\theta_{h} \sim f(\theta_{h})$</span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$g(\theta_{h}) = \beta + \eta_h$</span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\eta_h|\tau \sim \N(0, \tau^2)$</span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$f$ likelihood: Binomial, Normal (known $\sigma$) or Poisson</span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$g$ link function for each likelihood $f$: $\logit$, identity or $\log$</span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\beta$ population mean with prior $\N(m_{\beta}, s_{\beta}^2)$</span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\tau$ between-trial heterogeneity with prior $P_\tau$</span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a>The priors used for this data-set will be:</span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\beta \sim \N(0, 2^2)$</span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\tau \sim \HN(0, 1)$</span>
<span id="cb49-137"><a href="#cb49-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-138"><a href="#cb49-138" aria-hidden="true" tabindex="-1"></a>We will first run the analysis with the <span class="in">`RBesT`</span> command <span class="in">`gMAP`</span>. As a</span>
<span id="cb49-139"><a href="#cb49-139" aria-hidden="true" tabindex="-1"></a>next step we will convert the analysis to use <span class="in">`brms`</span> for the</span>
<span id="cb49-140"><a href="#cb49-140" aria-hidden="true" tabindex="-1"></a>inference. Finally, we will add an additional random effect for the</span>
<span id="cb49-141"><a href="#cb49-141" aria-hidden="true" tabindex="-1"></a>region $j$ and treat the random effect for the studies to be nested</span>
<span id="cb49-142"><a href="#cb49-142" aria-hidden="true" tabindex="-1"></a>within the region. As the more general model requires two levels of</span>
<span id="cb49-143"><a href="#cb49-143" aria-hidden="true" tabindex="-1"></a>random effects, it is outside the possible models of <span class="in">`RBesT`</span>. Such a</span>
<span id="cb49-144"><a href="#cb49-144" aria-hidden="true" tabindex="-1"></a>more general region specific model can be useful in various situations</span>
<span id="cb49-145"><a href="#cb49-145" aria-hidden="true" tabindex="-1"></a>whenever we wish to borrow strength across regions. Denoting with $j$</span>
<span id="cb49-146"><a href="#cb49-146" aria-hidden="true" tabindex="-1"></a>specific regions, the more general model is then:</span>
<span id="cb49-147"><a href="#cb49-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-148"><a href="#cb49-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-149"><a href="#cb49-149" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$Y_{h,j}|\theta_{h,j} \sim f(\theta_{h,j})$</span>
<span id="cb49-150"><a href="#cb49-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-151"><a href="#cb49-151" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$g(\theta_{h,j}) = \beta + \eta_h + \nu_j$</span>
<span id="cb49-152"><a href="#cb49-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-153"><a href="#cb49-153" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\eta_h|\tau \sim \N(0, \tau^2)$</span>
<span id="cb49-154"><a href="#cb49-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-155"><a href="#cb49-155" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\nu_j|\omega \sim \N(0, \omega^2)$</span>
<span id="cb49-156"><a href="#cb49-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-157"><a href="#cb49-157" aria-hidden="true" tabindex="-1"></a>In our case study we make a simplifying assumption that any trial $h$</span>
<span id="cb49-158"><a href="#cb49-158" aria-hidden="true" tabindex="-1"></a>is run entirely within a given region $j$. Therefore we have a</span>
<span id="cb49-159"><a href="#cb49-159" aria-hidden="true" tabindex="-1"></a>nested structure (trials within regions) such that no correlation is</span>
<span id="cb49-160"><a href="#cb49-160" aria-hidden="true" tabindex="-1"></a>modeled between region and trial. This would be different if some trials</span>
<span id="cb49-161"><a href="#cb49-161" aria-hidden="true" tabindex="-1"></a>were run across different regions and trial results would be reported by</span>
<span id="cb49-162"><a href="#cb49-162" aria-hidden="true" tabindex="-1"></a>region.</span>
<span id="cb49-163"><a href="#cb49-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-164"><a href="#cb49-164" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementation</span></span>
<span id="cb49-165"><a href="#cb49-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-166"><a href="#cb49-166" aria-hidden="true" tabindex="-1"></a>With the <span class="in">`gMAP`</span> command in <span class="in">`RBesT`</span> we can obtain MCMC samples from posterior for the first model as follows:</span>
<span id="cb49-167"><a href="#cb49-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-170"><a href="#cb49-170" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-171"><a href="#cb49-171" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">34767</span>)</span>
<span id="cb49-172"><a href="#cb49-172" aria-hidden="true" tabindex="-1"></a>map_mc_rbest <span class="ot">&lt;-</span> <span class="fu">gMAP</span>(<span class="fu">cbind</span>(r, n<span class="sc">-</span>r) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> study,</span>
<span id="cb49-173"><a href="#cb49-173" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family=</span>binomial,</span>
<span id="cb49-174"><a href="#cb49-174" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data=</span>AS_region,</span>
<span id="cb49-175"><a href="#cb49-175" aria-hidden="true" tabindex="-1"></a>                     <span class="at">tau.dist=</span><span class="st">"HalfNormal"</span>, <span class="at">tau.prior=</span><span class="dv">1</span>,</span>
<span id="cb49-176"><a href="#cb49-176" aria-hidden="true" tabindex="-1"></a>                     <span class="at">beta.prior=</span><span class="fu">cbind</span>(<span class="dv">0</span>,<span class="dv">2</span>))</span>
<span id="cb49-177"><a href="#cb49-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-178"><a href="#cb49-178" aria-hidden="true" tabindex="-1"></a>map_mc_rbest</span>
<span id="cb49-179"><a href="#cb49-179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-180"><a href="#cb49-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-181"><a href="#cb49-181" aria-hidden="true" tabindex="-1"></a>Using <span class="in">`brms`</span> we now specify the MAP model step by step. Binomial data</span>
<span id="cb49-182"><a href="#cb49-182" aria-hidden="true" tabindex="-1"></a>is specified slightly different in <span class="in">`brms`</span>. We first define the model:</span>
<span id="cb49-183"><a href="#cb49-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-186"><a href="#cb49-186" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-187"><a href="#cb49-187" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">bf</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> study), <span class="at">family=</span>binomial)</span>
<span id="cb49-188"><a href="#cb49-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-189"><a href="#cb49-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-190"><a href="#cb49-190" aria-hidden="true" tabindex="-1"></a>The left hand side of the formula, <span class="in">` r | trials(n) ~ ...`</span>, denotes with</span>
<span id="cb49-191"><a href="#cb49-191" aria-hidden="true" tabindex="-1"></a><span class="in">` r`</span> the data being modeled - the number of responders - and adds with</span>
<span id="cb49-192"><a href="#cb49-192" aria-hidden="true" tabindex="-1"></a>a bar <span class="in">`|`</span> additional information on the response, which are the number of</span>
<span id="cb49-193"><a href="#cb49-193" aria-hidden="true" tabindex="-1"></a>overall trials, needed to interpret the binomial likelihood.</span>
<span id="cb49-194"><a href="#cb49-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-195"><a href="#cb49-195" aria-hidden="true" tabindex="-1"></a>With the model (and data) being defined, we are left to specify the</span>
<span id="cb49-196"><a href="#cb49-196" aria-hidden="true" tabindex="-1"></a>model priors. With the help of the call</span>
<span id="cb49-197"><a href="#cb49-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-200"><a href="#cb49-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-201"><a href="#cb49-201" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(model, AS_region)</span>
<span id="cb49-202"><a href="#cb49-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-203"><a href="#cb49-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-204"><a href="#cb49-204" aria-hidden="true" tabindex="-1"></a>we can ask <span class="in">`brms`</span> as to what model parameters it has detected for</span>
<span id="cb49-205"><a href="#cb49-205" aria-hidden="true" tabindex="-1"></a>which priors should be specified. In this example, we need to define</span>
<span id="cb49-206"><a href="#cb49-206" aria-hidden="true" tabindex="-1"></a>the population mean intercept ($\beta$) and the between-study</span>
<span id="cb49-207"><a href="#cb49-207" aria-hidden="true" tabindex="-1"></a>heterogeneity parameter ($\tau$):</span>
<span id="cb49-208"><a href="#cb49-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-211"><a href="#cb49-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-212"><a href="#cb49-212" aria-hidden="true" tabindex="-1"></a>model_prior <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>Intercept) <span class="sc">+</span></span>
<span id="cb49-213"><a href="#cb49-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>study)</span>
<span id="cb49-214"><a href="#cb49-214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-215"><a href="#cb49-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-216"><a href="#cb49-216" aria-hidden="true" tabindex="-1"></a>Now we are ready to run the model in <span class="in">`brms`</span> (we are setting</span>
<span id="cb49-217"><a href="#cb49-217" aria-hidden="true" tabindex="-1"></a><span class="in">`refresh=1000`</span> to suppress most progress output):</span>
<span id="cb49-218"><a href="#cb49-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-221"><a href="#cb49-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-222"><a href="#cb49-222" aria-hidden="true" tabindex="-1"></a>map_mc_brms  <span class="ot">&lt;-</span> <span class="fu">brm</span>(model, AS_region, <span class="at">prior=</span>model_prior,</span>
<span id="cb49-223"><a href="#cb49-223" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed=</span><span class="dv">4767</span>, <span class="at">refresh=</span><span class="dv">1000</span>)</span>
<span id="cb49-224"><a href="#cb49-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-225"><a href="#cb49-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-226"><a href="#cb49-226" aria-hidden="true" tabindex="-1"></a>The model is compiled and then run. Occasionally one observes a</span>
<span id="cb49-227"><a href="#cb49-227" aria-hidden="true" tabindex="-1"></a>warning on divergent transitions after warmup reported like:</span>
<span id="cb49-228"><a href="#cb49-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-229"><a href="#cb49-229" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span><span class="in">`## Warning: There were 1 divergent transitions after warmup.`</span></span>
<span id="cb49-230"><a href="#cb49-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-231"><a href="#cb49-231" aria-hidden="true" tabindex="-1"></a>This is caused in this case by the choice of very conservative priors,</span>
<span id="cb49-232"><a href="#cb49-232" aria-hidden="true" tabindex="-1"></a>which lead to a difficult to sample posterior. As a quick fix we may</span>
<span id="cb49-233"><a href="#cb49-233" aria-hidden="true" tabindex="-1"></a>reduce the aggressiveness of the sampler and increase the sampler</span>
<span id="cb49-234"><a href="#cb49-234" aria-hidden="true" tabindex="-1"></a>parameter on the target acceptance probability <span class="in">`adapt_delta`</span> from it's</span>
<span id="cb49-235"><a href="#cb49-235" aria-hidden="true" tabindex="-1"></a>default value $0.8$ to a value closer to the maximum possible value of</span>
<span id="cb49-236"><a href="#cb49-236" aria-hidden="true" tabindex="-1"></a>$1.0$. For most analyses with weak priors using a value of $0.95$ can</span>
<span id="cb49-237"><a href="#cb49-237" aria-hidden="true" tabindex="-1"></a>be used as a starting value. This is at the cost of some sampling</span>
<span id="cb49-238"><a href="#cb49-238" aria-hidden="true" tabindex="-1"></a>speed as the sampler will take smaller steps, but the choice of a</span>
<span id="cb49-239"><a href="#cb49-239" aria-hidden="true" tabindex="-1"></a>higher than default acceptance probability results in more robust</span>
<span id="cb49-240"><a href="#cb49-240" aria-hidden="true" tabindex="-1"></a>inference and avoids in many instances the warning about</span>
<span id="cb49-241"><a href="#cb49-241" aria-hidden="true" tabindex="-1"></a>divergences. For a more comprehensive overview on possible warnings,</span>
<span id="cb49-242"><a href="#cb49-242" aria-hidden="true" tabindex="-1"></a>their meanings and how to address these, please refer to the [online</span>
<span id="cb49-243"><a href="#cb49-243" aria-hidden="true" tabindex="-1"></a>help of the Stan project on possible Stan stampler warnings and</span>
<span id="cb49-244"><a href="#cb49-244" aria-hidden="true" tabindex="-1"></a>messages](https://mc-stan.org/misc/warnings.html).</span>
<span id="cb49-245"><a href="#cb49-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-246"><a href="#cb49-246" aria-hidden="true" tabindex="-1"></a>In order to also avoid having to compile the Stan code for the model </span>
<span id="cb49-247"><a href="#cb49-247" aria-hidden="true" tabindex="-1"></a>once more, we use the <span class="in">`update`</span> functionality of <span class="in">`brms`</span>:</span>
<span id="cb49-248"><a href="#cb49-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-251"><a href="#cb49-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-252"><a href="#cb49-252" aria-hidden="true" tabindex="-1"></a>map_mc_brms_2 <span class="ot">&lt;-</span> <span class="fu">update</span>(map_mc_brms, <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>),</span>
<span id="cb49-253"><a href="#cb49-253" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># the two options below only silence Stan sampling output</span></span>
<span id="cb49-254"><a href="#cb49-254" aria-hidden="true" tabindex="-1"></a>                        <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="dv">0</span>)</span>
<span id="cb49-255"><a href="#cb49-255" aria-hidden="true" tabindex="-1"></a>map_mc_brms_2</span>
<span id="cb49-256"><a href="#cb49-256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-257"><a href="#cb49-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-258"><a href="#cb49-258" aria-hidden="true" tabindex="-1"></a>We can see that the estimate of the between-study heterogeneity $\tau$</span>
<span id="cb49-259"><a href="#cb49-259" aria-hidden="true" tabindex="-1"></a>is very similar between <span class="in">`RBesT`</span> and <span class="in">`brms`</span>. However, the MAP prior is</span>
<span id="cb49-260"><a href="#cb49-260" aria-hidden="true" tabindex="-1"></a>not apparent from the output of <span class="in">`brms`</span> directly (as it's not designed</span>
<span id="cb49-261"><a href="#cb49-261" aria-hidden="true" tabindex="-1"></a>with this specific application in mind).</span>
<span id="cb49-262"><a href="#cb49-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-263"><a href="#cb49-263" aria-hidden="true" tabindex="-1"></a>To obtain the MAP prior from <span class="in">`brms`</span>, we have to predict the response</span>
<span id="cb49-264"><a href="#cb49-264" aria-hidden="true" tabindex="-1"></a>rate of a new study. To do so, a new data set with the same columns as</span>
<span id="cb49-265"><a href="#cb49-265" aria-hidden="true" tabindex="-1"></a>the modeling data sets needs to be created.</span>
<span id="cb49-266"><a href="#cb49-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-269"><a href="#cb49-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-270"><a href="#cb49-270" aria-hidden="true" tabindex="-1"></a>AS_region_new <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">study=</span><span class="st">"new_study_asia"</span>, <span class="at">r=</span><span class="dv">0</span>, <span class="at">n=</span><span class="dv">6</span>, <span class="at">region=</span><span class="st">"asia"</span>)</span>
<span id="cb49-271"><a href="#cb49-271" aria-hidden="true" tabindex="-1"></a>post_map_mc_brms <span class="ot">&lt;-</span> <span class="fu">posterior_linpred</span>(map_mc_brms_2,</span>
<span id="cb49-272"><a href="#cb49-272" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">newdata=</span>AS_region_new,</span>
<span id="cb49-273"><a href="#cb49-273" aria-hidden="true" tabindex="-1"></a>                                      <span class="co"># apply inverse link function</span></span>
<span id="cb49-274"><a href="#cb49-274" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">transform=</span><span class="cn">TRUE</span>,</span>
<span id="cb49-275"><a href="#cb49-275" aria-hidden="true" tabindex="-1"></a>                                      <span class="co"># allows new studies</span></span>
<span id="cb49-276"><a href="#cb49-276" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>,</span>
<span id="cb49-277"><a href="#cb49-277" aria-hidden="true" tabindex="-1"></a>                                      <span class="co"># and samples these according to the model</span></span>
<span id="cb49-278"><a href="#cb49-278" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">sample_new_levels =</span> <span class="st">"gaussian"</span></span>
<span id="cb49-279"><a href="#cb49-279" aria-hidden="true" tabindex="-1"></a>                                      )</span>
<span id="cb49-280"><a href="#cb49-280" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's have a look at what we got:</span></span>
<span id="cb49-281"><a href="#cb49-281" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(post_map_mc_brms)</span>
<span id="cb49-282"><a href="#cb49-282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-283"><a href="#cb49-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-284"><a href="#cb49-284" aria-hidden="true" tabindex="-1"></a>Model outputs are returned in the standard format of a matrix which</span>
<span id="cb49-285"><a href="#cb49-285" aria-hidden="true" tabindex="-1"></a>contains the model simulations. While the rows label the draws, the</span>
<span id="cb49-286"><a href="#cb49-286" aria-hidden="true" tabindex="-1"></a>columns go along with the rows of the input data set. As in this case</span>
<span id="cb49-287"><a href="#cb49-287" aria-hidden="true" tabindex="-1"></a>we have as input data set a 1-row data frame <span class="in">`AS_region_new`</span> </span>
<span id="cb49-288"><a href="#cb49-288" aria-hidden="true" tabindex="-1"></a>corresponding to predictions for a (single) new study, the</span>
<span id="cb49-289"><a href="#cb49-289" aria-hidden="true" tabindex="-1"></a>output is a 1 column matrix with 4000 rows, since 4000 draws in total</span>
<span id="cb49-290"><a href="#cb49-290" aria-hidden="true" tabindex="-1"></a>were obtained from the sampler run with 4 chains and 1000 draws per</span>
<span id="cb49-291"><a href="#cb49-291" aria-hidden="true" tabindex="-1"></a>chain from the sampling phase.</span>
<span id="cb49-292"><a href="#cb49-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-293"><a href="#cb49-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-294"><a href="#cb49-294" aria-hidden="true" tabindex="-1"></a>Note the following important arguments used to obtain the posterior:</span>
<span id="cb49-295"><a href="#cb49-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-296"><a href="#cb49-296" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`transform=TRUE`</span> applies automatically the inverse link function</span>
<span id="cb49-297"><a href="#cb49-297" aria-hidden="true" tabindex="-1"></a>  such that we get response rates rather than logit values.</span>
<span id="cb49-298"><a href="#cb49-298" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`allow_new_levels=TRUE`</span> is needed to instruct <span class="in">`brms`</span> that new levels</span>
<span id="cb49-299"><a href="#cb49-299" aria-hidden="true" tabindex="-1"></a>  of the fitted random effects are admissible in the data. In this</span>
<span id="cb49-300"><a href="#cb49-300" aria-hidden="true" tabindex="-1"></a>  case we sample a new study random effect level.</span>
<span id="cb49-301"><a href="#cb49-301" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`sample_new_levels="gaussian"`</span> ensures that the new random effect is</span>
<span id="cb49-302"><a href="#cb49-302" aria-hidden="true" tabindex="-1"></a>  sampled according to normal distributions as specified with the</span>
<span id="cb49-303"><a href="#cb49-303" aria-hidden="true" tabindex="-1"></a>  model. The default option <span class="in">`"uncertainty"`</span> samples for each draw from</span>
<span id="cb49-304"><a href="#cb49-304" aria-hidden="true" tabindex="-1"></a>  the fitted random effect levels one realization, which is</span>
<span id="cb49-305"><a href="#cb49-305" aria-hidden="true" tabindex="-1"></a>  essentially bootstrapping random effects on the level of posterior</span>
<span id="cb49-306"><a href="#cb49-306" aria-hidden="true" tabindex="-1"></a>  draws. The option <span class="in">`"old_levels"`</span> samples a random effect level and</span>
<span id="cb49-307"><a href="#cb49-307" aria-hidden="true" tabindex="-1"></a>  substitutes *all* draws for the new level corresponding to</span>
<span id="cb49-308"><a href="#cb49-308" aria-hidden="true" tabindex="-1"></a>  bootstrapping the existing levels. While this avoids normality</span>
<span id="cb49-309"><a href="#cb49-309" aria-hidden="true" tabindex="-1"></a>  assumptions, it can only work well in situations with many levels of</span>
<span id="cb49-310"><a href="#cb49-310" aria-hidden="true" tabindex="-1"></a>  the random effect. The option <span class="in">`"gaussian"`</span> is for most models the</span>
<span id="cb49-311"><a href="#cb49-311" aria-hidden="true" tabindex="-1"></a>  preferred choice and for more details, please refer to the <span class="in">`brms`</span></span>
<span id="cb49-312"><a href="#cb49-312" aria-hidden="true" tabindex="-1"></a>  help page on <span class="in">`prepare_predictions`</span>.</span>
<span id="cb49-313"><a href="#cb49-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-314"><a href="#cb49-314" aria-hidden="true" tabindex="-1"></a>A convenient way to get a summary of the samples is to use</span>
<span id="cb49-315"><a href="#cb49-315" aria-hidden="true" tabindex="-1"></a>the <span class="in">`summarize_draws`</span> function from the <span class="in">`posterior`</span> package (used as</span>
<span id="cb49-316"><a href="#cb49-316" aria-hidden="true" tabindex="-1"></a>a helper package in <span class="in">`brms`</span> already):</span>
<span id="cb49-317"><a href="#cb49-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-320"><a href="#cb49-320" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-321"><a href="#cb49-321" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize_draws</span>(post_map_mc_brms)</span>
<span id="cb49-322"><a href="#cb49-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-323"><a href="#cb49-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-324"><a href="#cb49-324" aria-hidden="true" tabindex="-1"></a>These estimates are now very similar to the results reported from</span>
<span id="cb49-325"><a href="#cb49-325" aria-hidden="true" tabindex="-1"></a><span class="in">`RBesT`</span> reported above (up to sampling error).</span>
<span id="cb49-326"><a href="#cb49-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-327"><a href="#cb49-327" aria-hidden="true" tabindex="-1"></a>Expanding the model to include region would only be possible in</span>
<span id="cb49-328"><a href="#cb49-328" aria-hidden="true" tabindex="-1"></a><span class="in">`RBesT`</span> via the use of an additional fixed effect. However, this would</span>
<span id="cb49-329"><a href="#cb49-329" aria-hidden="true" tabindex="-1"></a>essentially refit the model for each region *separately* and hence</span>
<span id="cb49-330"><a href="#cb49-330" aria-hidden="true" tabindex="-1"></a>limit the amount of information we can borrow among regions. With</span>
<span id="cb49-331"><a href="#cb49-331" aria-hidden="true" tabindex="-1"></a><span class="in">`brms`</span> it is straightforward to specify the nested random effects</span>
<span id="cb49-332"><a href="#cb49-332" aria-hidden="true" tabindex="-1"></a>structure described in the _Model Details_ Section. Following the </span>
<span id="cb49-333"><a href="#cb49-333" aria-hidden="true" tabindex="-1"></a>same steps as before, setting up the brms model may look like:</span>
<span id="cb49-334"><a href="#cb49-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-337"><a href="#cb49-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-338"><a href="#cb49-338" aria-hidden="true" tabindex="-1"></a>region_model <span class="ot">&lt;-</span> <span class="fu">bf</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> region<span class="sc">/</span>study), <span class="at">family=</span>binomial)</span>
<span id="cb49-339"><a href="#cb49-339" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(region_model, AS_region)</span>
<span id="cb49-340"><a href="#cb49-340" aria-hidden="true" tabindex="-1"></a>region_model_prior <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>Intercept) <span class="sc">+</span></span>
<span id="cb49-341"><a href="#cb49-341" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.5</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>region) <span class="sc">+</span></span>
<span id="cb49-342"><a href="#cb49-342" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.25</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>region<span class="sc">:</span>study)</span>
<span id="cb49-343"><a href="#cb49-343" aria-hidden="true" tabindex="-1"></a>region_map_mc_brms  <span class="ot">&lt;-</span> <span class="fu">brm</span>(region_model, AS_region, <span class="at">prior=</span>region_model_prior, <span class="at">seed=</span><span class="dv">4767</span>,</span>
<span id="cb49-344"><a href="#cb49-344" aria-hidden="true" tabindex="-1"></a>                           <span class="at">control=</span><span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.99</span>),</span>
<span id="cb49-345"><a href="#cb49-345" aria-hidden="true" tabindex="-1"></a>                           <span class="at">refresh=</span><span class="dv">0</span>, <span class="at">silent=</span><span class="dv">0</span>)</span>
<span id="cb49-346"><a href="#cb49-346" aria-hidden="true" tabindex="-1"></a>post_region_map_mc_brms <span class="ot">&lt;-</span> <span class="fu">posterior_linpred</span>(region_map_mc_brms,</span>
<span id="cb49-347"><a href="#cb49-347" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">newdata=</span>AS_region_new,</span>
<span id="cb49-348"><a href="#cb49-348" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">transform=</span><span class="cn">TRUE</span>,</span>
<span id="cb49-349"><a href="#cb49-349" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>,</span>
<span id="cb49-350"><a href="#cb49-350" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">sample_new_levels =</span> <span class="st">"gaussian"</span></span>
<span id="cb49-351"><a href="#cb49-351" aria-hidden="true" tabindex="-1"></a>                                             )</span>
<span id="cb49-352"><a href="#cb49-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's have a look at what we got:</span></span>
<span id="cb49-353"><a href="#cb49-353" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize_draws</span>(post_region_map_mc_brms)</span>
<span id="cb49-354"><a href="#cb49-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-355"><a href="#cb49-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-356"><a href="#cb49-356" aria-hidden="true" tabindex="-1"></a>The key difference to the previous model is the nested random effect</span>
<span id="cb49-357"><a href="#cb49-357" aria-hidden="true" tabindex="-1"></a>specification term <span class="in">`(1 | region/study)`</span> of the model formula. This</span>
<span id="cb49-358"><a href="#cb49-358" aria-hidden="true" tabindex="-1"></a>syntax denotes a random intercept term for <span class="in">`region`</span> and <span class="in">`study`</span> in a</span>
<span id="cb49-359"><a href="#cb49-359" aria-hidden="true" tabindex="-1"></a>way which assumes a nested data structure in that a given study is</span>
<span id="cb49-360"><a href="#cb49-360" aria-hidden="true" tabindex="-1"></a>only run in a single region.</span>
<span id="cb49-361"><a href="#cb49-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-362"><a href="#cb49-362" aria-hidden="true" tabindex="-1"></a><span class="fu">## Results</span></span>
<span id="cb49-363"><a href="#cb49-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-364"><a href="#cb49-364" aria-hidden="true" tabindex="-1"></a>Once the MAP prior is obtained in MCMC form a model check of is</span>
<span id="cb49-365"><a href="#cb49-365" aria-hidden="true" tabindex="-1"></a>recommended. In <span class="in">`RBesT`</span> a forest plot augmented with model shrinkage</span>
<span id="cb49-366"><a href="#cb49-366" aria-hidden="true" tabindex="-1"></a>estimates is suggested for this purpose:</span>
<span id="cb49-367"><a href="#cb49-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-370"><a href="#cb49-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-371"><a href="#cb49-371" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map_mc_rbest)<span class="sc">$</span>forest_model</span>
<span id="cb49-372"><a href="#cb49-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-373"><a href="#cb49-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-374"><a href="#cb49-374" aria-hidden="true" tabindex="-1"></a>The dashed lines show the 95% confidence intervals of each study</span>
<span id="cb49-375"><a href="#cb49-375" aria-hidden="true" tabindex="-1"></a>estimate on it's own while the solid line shows the respective</span>
<span id="cb49-376"><a href="#cb49-376" aria-hidden="true" tabindex="-1"></a>shrinkage estimate of the MAP model. This plot is useful to assess the</span>
<span id="cb49-377"><a href="#cb49-377" aria-hidden="true" tabindex="-1"></a>plausibility of the results and may unveil possible issues with the</span>
<span id="cb49-378"><a href="#cb49-378" aria-hidden="true" tabindex="-1"></a>model specification. In <span class="in">`brms`</span> model diagnostic functions are directly</span>
<span id="cb49-379"><a href="#cb49-379" aria-hidden="true" tabindex="-1"></a>available and essentially expose the functionality found in the</span>
<span id="cb49-380"><a href="#cb49-380" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">`bayesplot`</span><span class="co">](https://mc-stan.org/bayesplot/index.html)</span> R package. A</span>
<span id="cb49-381"><a href="#cb49-381" aria-hidden="true" tabindex="-1"></a>suitable <span class="in">`bayesplot`</span> plot in this situation could be an <span class="in">`intervals`</span></span>
<span id="cb49-382"><a href="#cb49-382" aria-hidden="true" tabindex="-1"></a>plot as:</span>
<span id="cb49-383"><a href="#cb49-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-386"><a href="#cb49-386" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-387"><a href="#cb49-387" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(map_mc_brms_2, <span class="at">type=</span><span class="st">"intervals"</span>) <span class="sc">+</span></span>
<span id="cb49-388"><a href="#cb49-388" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">"Study"</span>, <span class="at">breaks=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(AS_region), <span class="at">labels=</span>AS_region<span class="sc">$</span>study) <span class="sc">+</span></span>
<span id="cb49-389"><a href="#cb49-389" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Number of Responders"</span>) <span class="sc">+</span></span>
<span id="cb49-390"><a href="#cb49-390" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb49-391"><a href="#cb49-391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>,</span>
<span id="cb49-392"><a href="#cb49-392" aria-hidden="true" tabindex="-1"></a>          <span class="co"># suppress vertical grid lines for better readability of intervals</span></span>
<span id="cb49-393"><a href="#cb49-393" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>())</span>
<span id="cb49-394"><a href="#cb49-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-395"><a href="#cb49-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-396"><a href="#cb49-396" aria-hidden="true" tabindex="-1"></a>The call of the <span class="in">`pp_check`</span> function is forwarded to the respective</span>
<span id="cb49-397"><a href="#cb49-397" aria-hidden="true" tabindex="-1"></a><span class="in">`ppc_*`</span> functions for posterior predictive checks from <span class="in">`bayesplot`</span></span>
<span id="cb49-398"><a href="#cb49-398" aria-hidden="true" tabindex="-1"></a>(depending on the <span class="in">`type`</span> argument). The plots are designed to compare</span>
<span id="cb49-399"><a href="#cb49-399" aria-hidden="true" tabindex="-1"></a>the *posterior predictive* distribution to the observed data rather</span>
<span id="cb49-400"><a href="#cb49-400" aria-hidden="true" tabindex="-1"></a>than comparing mean estimates to one another. Thus, the outcome of</span>
<span id="cb49-401"><a href="#cb49-401" aria-hidden="true" tabindex="-1"></a>each trial in the original data set is sampled according to the fitted</span>
<span id="cb49-402"><a href="#cb49-402" aria-hidden="true" tabindex="-1"></a>model and the resulting predictive distribution of the outcome (number</span>
<span id="cb49-403"><a href="#cb49-403" aria-hidden="true" tabindex="-1"></a>of responders) is compared to the observed outcome. The <span class="in">`intervals`</span></span>
<span id="cb49-404"><a href="#cb49-404" aria-hidden="true" tabindex="-1"></a>predictive probability check summarises the predictive distributions</span>
<span id="cb49-405"><a href="#cb49-405" aria-hidden="true" tabindex="-1"></a>using a light color for an outer credible interval range and a darker</span>
<span id="cb49-406"><a href="#cb49-406" aria-hidden="true" tabindex="-1"></a>line for an inner credible interval. The outer defaults to a 90%</span>
<span id="cb49-407"><a href="#cb49-407" aria-hidden="true" tabindex="-1"></a>credible interval (<span class="in">`prob_outer`</span> argument) while the inner uses a 50%</span>
<span id="cb49-408"><a href="#cb49-408" aria-hidden="true" tabindex="-1"></a>credible interval (<span class="in">`prob`</span> argument). The light dot in the middle is</span>
<span id="cb49-409"><a href="#cb49-409" aria-hidden="true" tabindex="-1"></a>the median of the predictive distribution and the dark dot is the</span>
<span id="cb49-410"><a href="#cb49-410" aria-hidden="true" tabindex="-1"></a>outcome $y$. As we can observe, the outcomes $y$ of the trials all are</span>
<span id="cb49-411"><a href="#cb49-411" aria-hidden="true" tabindex="-1"></a>contained within outer credible intervals of the predictive</span>
<span id="cb49-412"><a href="#cb49-412" aria-hidden="true" tabindex="-1"></a>distributions for the simulated replicate data $y_{rep}$. However, one</span>
<span id="cb49-413"><a href="#cb49-413" aria-hidden="true" tabindex="-1"></a>may critizise that also the 50% credible intervals contain all but two</span>
<span id="cb49-414"><a href="#cb49-414" aria-hidden="true" tabindex="-1"></a>trials (study 3, study 7). Hence, the *calibration* of the model with</span>
<span id="cb49-415"><a href="#cb49-415" aria-hidden="true" tabindex="-1"></a>the data is possibly not ideal given that every other trial outcome</span>
<span id="cb49-416"><a href="#cb49-416" aria-hidden="true" tabindex="-1"></a>should be outside (or inside) of the 50% predictive</span>
<span id="cb49-417"><a href="#cb49-417" aria-hidden="true" tabindex="-1"></a>interval. Comparing with a binomial distribution one can find that</span>
<span id="cb49-418"><a href="#cb49-418" aria-hidden="true" tabindex="-1"></a>such an outcome can occur in 14% of the cases and does not represent</span>
<span id="cb49-419"><a href="#cb49-419" aria-hidden="true" tabindex="-1"></a>an extreme finding such that we can conclude that the model is</span>
<span id="cb49-420"><a href="#cb49-420" aria-hidden="true" tabindex="-1"></a>consistent with the data.</span>
<span id="cb49-421"><a href="#cb49-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-422"><a href="#cb49-422" aria-hidden="true" tabindex="-1"></a>Once the model has been checked for plausibility, we can proceed and</span>
<span id="cb49-423"><a href="#cb49-423" aria-hidden="true" tabindex="-1"></a>derive the main target of the MAP analysis, which is the MAP prior in</span>
<span id="cb49-424"><a href="#cb49-424" aria-hidden="true" tabindex="-1"></a>*parametric* form. <span class="in">`RBesT`</span> provides a fitting procedure, based in the</span>
<span id="cb49-425"><a href="#cb49-425" aria-hidden="true" tabindex="-1"></a>EM algorithm, for approximating the MCMC output of the MAP prior in</span>
<span id="cb49-426"><a href="#cb49-426" aria-hidden="true" tabindex="-1"></a>parametric form using mixture distributions. In the case of a binomial</span>
<span id="cb49-427"><a href="#cb49-427" aria-hidden="true" tabindex="-1"></a>response Beta mixtures are being estimated:</span>
<span id="cb49-428"><a href="#cb49-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-431"><a href="#cb49-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-432"><a href="#cb49-432" aria-hidden="true" tabindex="-1"></a>map_rbest <span class="ot">&lt;-</span> <span class="fu">automixfit</span>(map_mc_rbest)</span>
<span id="cb49-433"><a href="#cb49-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-434"><a href="#cb49-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-435"><a href="#cb49-435" aria-hidden="true" tabindex="-1"></a>And a comparison of the fitted density vs the histogram of the MCMC</span>
<span id="cb49-436"><a href="#cb49-436" aria-hidden="true" tabindex="-1"></a>sample is available as:</span>
<span id="cb49-437"><a href="#cb49-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-440"><a href="#cb49-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-441"><a href="#cb49-441" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map_rbest)<span class="sc">$</span>mix</span>
<span id="cb49-442"><a href="#cb49-442" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-443"><a href="#cb49-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-444"><a href="#cb49-444" aria-hidden="true" tabindex="-1"></a>The <span class="in">`automixfit`</span> function above recognizes that the  <span class="in">`map_mc_rbest`</span> </span>
<span id="cb49-445"><a href="#cb49-445" aria-hidden="true" tabindex="-1"></a>object is a <span class="in">`gMAP`</span> analysis object and automatically calls the correct </span>
<span id="cb49-446"><a href="#cb49-446" aria-hidden="true" tabindex="-1"></a>Beta EM mixture algorithm for proportions. When working with <span class="in">`brms`</span> we </span>
<span id="cb49-447"><a href="#cb49-447" aria-hidden="true" tabindex="-1"></a>also do obtain the MAP prior in MCMC form on the response scale, but we </span>
<span id="cb49-448"><a href="#cb49-448" aria-hidden="true" tabindex="-1"></a>need to provide <span class="in">`automixfit`</span> additional information on the provided MCMC </span>
<span id="cb49-449"><a href="#cb49-449" aria-hidden="true" tabindex="-1"></a>sample like this:</span>
<span id="cb49-450"><a href="#cb49-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-451"><a href="#cb49-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-454"><a href="#cb49-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-455"><a href="#cb49-455" aria-hidden="true" tabindex="-1"></a>map_brms <span class="ot">&lt;-</span> <span class="fu">automixfit</span>(post_map_mc_brms[,<span class="dv">1</span>], <span class="at">type=</span><span class="st">"beta"</span>)</span>
<span id="cb49-456"><a href="#cb49-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-457"><a href="#cb49-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-458"><a href="#cb49-458" aria-hidden="true" tabindex="-1"></a>At this stage we can work with <span class="in">`map_brms_2`</span> just like we would when</span>
<span id="cb49-459"><a href="#cb49-459" aria-hidden="true" tabindex="-1"></a>using <span class="in">`RBesT`</span> directly such that the graphical diagnostic of the fit</span>
<span id="cb49-460"><a href="#cb49-460" aria-hidden="true" tabindex="-1"></a>still works:</span>
<span id="cb49-461"><a href="#cb49-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-464"><a href="#cb49-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-465"><a href="#cb49-465" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(map_brms)<span class="sc">$</span>mix</span>
<span id="cb49-466"><a href="#cb49-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-467"><a href="#cb49-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-468"><a href="#cb49-468" aria-hidden="true" tabindex="-1"></a>Comparing the results of using either packages shows that the two resulting </span>
<span id="cb49-469"><a href="#cb49-469" aria-hidden="true" tabindex="-1"></a>MAP prior distributions are representing the same evidence (up to MCMC sampling error):</span>
<span id="cb49-470"><a href="#cb49-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-473"><a href="#cb49-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-474"><a href="#cb49-474" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">rbind</span>(<span class="at">rbest=</span><span class="fu">summary</span>(map_rbest),</span>
<span id="cb49-475"><a href="#cb49-475" aria-hidden="true" tabindex="-1"></a>            <span class="at">brms=</span><span class="fu">summary</span>(map_brms)),</span>
<span id="cb49-476"><a href="#cb49-476" aria-hidden="true" tabindex="-1"></a>      <span class="at">digits=</span><span class="dv">3</span>)</span>
<span id="cb49-477"><a href="#cb49-477" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-478"><a href="#cb49-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-479"><a href="#cb49-479" aria-hidden="true" tabindex="-1"></a>For the region specific model, two different types of priors can be derived. </span>
<span id="cb49-480"><a href="#cb49-480" aria-hidden="true" tabindex="-1"></a>One may wish to obtain a MAP prior for one of the considered regions or</span>
<span id="cb49-481"><a href="#cb49-481" aria-hidden="true" tabindex="-1"></a>for a new region:</span>
<span id="cb49-482"><a href="#cb49-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-483"><a href="#cb49-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-486"><a href="#cb49-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-487"><a href="#cb49-487" aria-hidden="true" tabindex="-1"></a><span class="co"># predict a new study for all fitted region and other (=a new region)</span></span>
<span id="cb49-488"><a href="#cb49-488" aria-hidden="true" tabindex="-1"></a>AS_region_all <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">region=</span><span class="fu">c</span>(<span class="st">"asia"</span>, <span class="st">"europe"</span>, <span class="st">"north_america"</span>, <span class="st">"other"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb49-489"><a href="#cb49-489" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">study=</span><span class="fu">paste</span>(<span class="st">"new_study"</span>, region, <span class="at">sep=</span><span class="st">"_"</span>), <span class="at">r=</span><span class="dv">0</span>, <span class="at">n=</span><span class="dv">6</span>)</span>
<span id="cb49-490"><a href="#cb49-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-491"><a href="#cb49-491" aria-hidden="true" tabindex="-1"></a>post_region_all_map_mc_brms <span class="ot">&lt;-</span> <span class="fu">posterior_linpred</span>(region_map_mc_brms,</span>
<span id="cb49-492"><a href="#cb49-492" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">newdata=</span>AS_region_all,</span>
<span id="cb49-493"><a href="#cb49-493" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">transform=</span><span class="cn">TRUE</span>,</span>
<span id="cb49-494"><a href="#cb49-494" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">allow_new_levels =</span> <span class="cn">TRUE</span>,</span>
<span id="cb49-495"><a href="#cb49-495" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">sample_new_levels =</span> <span class="st">"gaussian"</span></span>
<span id="cb49-496"><a href="#cb49-496" aria-hidden="true" tabindex="-1"></a>                                                 )</span>
<span id="cb49-497"><a href="#cb49-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-498"><a href="#cb49-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-499"><a href="#cb49-499" aria-hidden="true" tabindex="-1"></a><span class="co"># name columns according to their region...</span></span>
<span id="cb49-500"><a href="#cb49-500" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(post_region_all_map_mc_brms) <span class="ot">&lt;-</span> AS_region_all<span class="sc">$</span>region</span>
<span id="cb49-501"><a href="#cb49-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-502"><a href="#cb49-502" aria-hidden="true" tabindex="-1"></a><span class="co">#...to obtain nice labels in a visualization with bayesplot</span></span>
<span id="cb49-503"><a href="#cb49-503" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_intervals</span>(post_region_all_map_mc_brms)</span>
<span id="cb49-504"><a href="#cb49-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-505"><a href="#cb49-505" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain parametric mixture for each region, always using </span></span>
<span id="cb49-506"><a href="#cb49-506" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 mixture components (often sufficient) to speed up inference</span></span>
<span id="cb49-507"><a href="#cb49-507" aria-hidden="true" tabindex="-1"></a>map_region <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb49-508"><a href="#cb49-508" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(r <span class="cf">in</span> AS_region_all<span class="sc">$</span>region) {</span>
<span id="cb49-509"><a href="#cb49-509" aria-hidden="true" tabindex="-1"></a>    map_region[[r]] <span class="ot">&lt;-</span> <span class="fu">mixfit</span>(post_region_all_map_mc_brms[,r], <span class="at">type=</span><span class="st">"beta"</span>, <span class="at">Nc=</span><span class="dv">3</span>, <span class="at">constrain_gt1=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-510"><a href="#cb49-510" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-511"><a href="#cb49-511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-512"><a href="#cb49-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-513"><a href="#cb49-513" aria-hidden="true" tabindex="-1"></a>These MAP priors summaries are:</span>
<span id="cb49-514"><a href="#cb49-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-517"><a href="#cb49-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-518"><a href="#cb49-518" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">bind_rows</span>(<span class="fu">lapply</span>(map_region, summary), <span class="at">.id=</span><span class="st">"MAP"</span>), <span class="at">digits=</span><span class="dv">3</span>)</span>
<span id="cb49-519"><a href="#cb49-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-520"><a href="#cb49-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-521"><a href="#cb49-521" aria-hidden="true" tabindex="-1"></a>The summaries show that we have higher precision for regions with more</span>
<span id="cb49-522"><a href="#cb49-522" aria-hidden="true" tabindex="-1"></a>trials and the least precision for the MAP prior for a new (<span class="in">`"other"`</span>) </span>
<span id="cb49-523"><a href="#cb49-523" aria-hidden="true" tabindex="-1"></a>region, for which there were no trials. An alternative way to quantify </span>
<span id="cb49-524"><a href="#cb49-524" aria-hidden="true" tabindex="-1"></a>the informativeness of the MAP prior is the effective sample size as </span>
<span id="cb49-525"><a href="#cb49-525" aria-hidden="true" tabindex="-1"></a>provided by <span class="in">`RBesT`</span>:</span>
<span id="cb49-526"><a href="#cb49-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-529"><a href="#cb49-529" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb49-530"><a href="#cb49-530" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(map_region, ess)</span>
<span id="cb49-531"><a href="#cb49-531" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-532"><a href="#cb49-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-533"><a href="#cb49-533" aria-hidden="true" tabindex="-1"></a>At this point the tools from <span class="in">`RBesT`</span> can be used to assess further</span>
<span id="cb49-534"><a href="#cb49-534" aria-hidden="true" tabindex="-1"></a>properties of trial designs which use these MAP priors. Please refer</span>
<span id="cb49-535"><a href="#cb49-535" aria-hidden="true" tabindex="-1"></a>to the [getting started</span>
<span id="cb49-536"><a href="#cb49-536" aria-hidden="true" tabindex="-1"></a>vignette](https://cran.r-project.org/web/packages/RBesT/vignettes/introduction.html)</span>
<span id="cb49-537"><a href="#cb49-537" aria-hidden="true" tabindex="-1"></a>of <span class="in">`RBesT`</span>.</span>
<span id="cb49-538"><a href="#cb49-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-539"><a href="#cb49-539" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb49-540"><a href="#cb49-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-541"><a href="#cb49-541" aria-hidden="true" tabindex="-1"></a>The random-effects meta-analysis model implemented in <span class="in">`RBesT`</span> has been</span>
<span id="cb49-542"><a href="#cb49-542" aria-hidden="true" tabindex="-1"></a>re-implemented with <span class="in">`brms`</span>. In a second step the meta-analysis has been</span>
<span id="cb49-543"><a href="#cb49-543" aria-hidden="true" tabindex="-1"></a>extended to account for trial regions. This enables stronger borrowing</span>
<span id="cb49-544"><a href="#cb49-544" aria-hidden="true" tabindex="-1"></a>within regions and hence a more informative MAP prior as can be seen by</span>
<span id="cb49-545"><a href="#cb49-545" aria-hidden="true" tabindex="-1"></a>the effective sample size measure. Moreover, the case study also</span>
<span id="cb49-546"><a href="#cb49-546" aria-hidden="true" tabindex="-1"></a>demonstrates how posterior samples produced with <span class="in">`brms`</span> can be used as </span>
<span id="cb49-547"><a href="#cb49-547" aria-hidden="true" tabindex="-1"></a>an input to <span class="in">`RBesT`</span> such that both tools can be used in combination.</span>
<span id="cb49-548"><a href="#cb49-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-549"><a href="#cb49-549" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb49-550"><a href="#cb49-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-551"><a href="#cb49-551" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Create a posterior predictive check based on the predictive</span>
<span id="cb49-552"><a href="#cb49-552" aria-hidden="true" tabindex="-1"></a>   distribution for the response rate.  </span>
<span id="cb49-553"><a href="#cb49-553" aria-hidden="true" tabindex="-1"></a>   Steps:</span>
<span id="cb49-554"><a href="#cb49-554" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Use <span class="in">`posterior_predict`</span> to create samples from the predictive distribution of</span>
<span id="cb49-555"><a href="#cb49-555" aria-hidden="true" tabindex="-1"></a>      outcomes per trial.</span>
<span id="cb49-556"><a href="#cb49-556" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Use <span class="in">`sweep(predictive, 2, AS_region$n, "/")`</span> to convert these samples from</span>
<span id="cb49-557"><a href="#cb49-557" aria-hidden="true" tabindex="-1"></a>      the predictive distribution of the outcome counts to samples from the predictive distribution for responder rates.</span>
<span id="cb49-558"><a href="#cb49-558" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Use <span class="in">`ppc_intervals`</span> from <span class="in">`bayesplot`</span> to create a plot showing your results.</span>
<span id="cb49-559"><a href="#cb49-559" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Redo the analysis with region, but treat region as a fixed</span>
<span id="cb49-560"><a href="#cb49-560" aria-hidden="true" tabindex="-1"></a>   effect. Evaluate the informativeness of the obtained MAP priors.</span>
<span id="cb49-561"><a href="#cb49-561" aria-hidden="true" tabindex="-1"></a>   The model formula for <span class="in">`brms`</span> should look like</span>
<span id="cb49-562"><a href="#cb49-562" aria-hidden="true" tabindex="-1"></a>   `region_model_fixed &lt;- bf(r | trials(n) ~ 1 + region + (1 | study),</span>
<span id="cb49-563"><a href="#cb49-563" aria-hidden="true" tabindex="-1"></a>   family=binomial)`.</span>
<span id="cb49-564"><a href="#cb49-564" aria-hidden="true" tabindex="-1"></a>   Steps:</span>
<span id="cb49-565"><a href="#cb49-565" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Consider the prior for the region fixed effect first. The</span>
<span id="cb49-566"><a href="#cb49-566" aria-hidden="true" tabindex="-1"></a>    reference region is included in the intercept. The reference</span>
<span id="cb49-567"><a href="#cb49-567" aria-hidden="true" tabindex="-1"></a>    region is implicitly defined by the first level of the variable</span>
<span id="cb49-568"><a href="#cb49-568" aria-hidden="true" tabindex="-1"></a>    region when defined as <span class="in">`factor`</span>.</span>
<span id="cb49-569"><a href="#cb49-569" aria-hidden="true" tabindex="-1"></a><span class="ss">      - </span>Define <span class="in">`asia`</span> to be the reference region in the example. Also</span>
<span id="cb49-570"><a href="#cb49-570" aria-hidden="true" tabindex="-1"></a>        include a level <span class="in">`other`</span> in the set of levels.</span>
<span id="cb49-571"><a href="#cb49-571" aria-hidden="true" tabindex="-1"></a><span class="ss">      - </span>Assume that an odds-ratio of $2$ between regions can be seen as very large such</span>
<span id="cb49-572"><a href="#cb49-572" aria-hidden="true" tabindex="-1"></a>        that a prior of $\N(0, (\log(2)/1.96)^2)$ for the region main effect is adequate.</span>
<span id="cb49-573"><a href="#cb49-573" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Obtain the MAP prior for each region by using the</span>
<span id="cb49-574"><a href="#cb49-574" aria-hidden="true" tabindex="-1"></a>      <span class="in">`AS_region_all`</span> data frame defined above and apply</span>
<span id="cb49-575"><a href="#cb49-575" aria-hidden="true" tabindex="-1"></a>      <span class="in">`posterior_linpred`</span> as shown above.</span>
<span id="cb49-576"><a href="#cb49-576" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Convert the MCMC samples from the MAP prior distribution into mixture </span>
<span id="cb49-577"><a href="#cb49-577" aria-hidden="true" tabindex="-1"></a>      distributions with the same code as above.</span>
<span id="cb49-578"><a href="#cb49-578" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Calculate the ESS for each prior distribution with the <span class="in">`ess`</span> function from <span class="in">`RBesT`</span>.</span>
<span id="cb49-579"><a href="#cb49-579" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb49-580"><a href="#cb49-580" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Run the analysis for the normal endpoint in the <span class="in">`crohn`</span> data set of</span>
<span id="cb49-581"><a href="#cb49-581" aria-hidden="true" tabindex="-1"></a>   <span class="in">`RBesT`</span>. Refer to the <span class="in">`RBesT`</span> vignette for a [normal</span>
<span id="cb49-582"><a href="#cb49-582" aria-hidden="true" tabindex="-1"></a>   endpoint](https://cran.r-project.org/web/packages/RBesT/vignettes/introduction_normal.html)</span>
<span id="cb49-583"><a href="#cb49-583" aria-hidden="true" tabindex="-1"></a>   on more details and context. </span>
<span id="cb49-584"><a href="#cb49-584" aria-hidden="true" tabindex="-1"></a>   Steps:</span>
<span id="cb49-585"><a href="#cb49-585" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Use as <span class="in">`family=gaussian`</span> and use the <span class="in">`se`</span> response modifier in</span>
<span id="cb49-586"><a href="#cb49-586" aria-hidden="true" tabindex="-1"></a>      place of <span class="in">`trials`</span> to specify a known standard error.</span>
<span id="cb49-587"><a href="#cb49-587" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Use the same priors as proposed in the vignette.</span>
<span id="cb49-588"><a href="#cb49-588" aria-hidden="true" tabindex="-1"></a><span class="ss">    * </span>Compare the obtained MAP prior (in MCMC sample form) from <span class="in">`RBesT`</span> and <span class="in">`brms`</span>.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>