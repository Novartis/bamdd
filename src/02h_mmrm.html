<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Björn Holzhauer - bjoern.holzhauer@novartis.com">
<meta name="author" content="Sebastian Weber - sebastian.weber@novartis.com">

<title>13&nbsp; Bayesian Mixed effects Model for Repeated Measures – Applied Modelling in Drug Development</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../src/02i_time_to_event.html" rel="next">
<link href="../src/02g_longitudinal.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b619e7580ba2a849d98fc8631a679bb4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="../resources/mathjax/tex-mml-chtml.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../bamdd.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/02_case_studies.html">Case studies</a></li><li class="breadcrumb-item"><a href="../src/02h_mmrm.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Bayesian Mixed effects Model for Repeated Measures</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../bamdd_logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Applied Modelling in Drug Development</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/Novartis/bamdd/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01a_introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01b_basic_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Basic workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/01c_priors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Model setup &amp; priors</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../src/02_case_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Case studies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02a_meta_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Use of historical control data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02ab_meta_analysis_trtdiff.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Meta-analysis to estimate treatment effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02ac_meta_analysis_strata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Use of historical control data with stratification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02l_single_arm_pos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Probability of success from a single arm trial</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02b_dose_finding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dose finding</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02c_dose_escalation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Oncology dose escalation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02cb_tte_dose_escalation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Time-to-event modelling in Oncology dose escalation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02e_multiple_imputation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Multiple imputation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02g_longitudinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Longitudinal data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02h_mmrm.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Bayesian Mixed effects Model for Repeated Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02i_time_to_event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Time-to-event data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/02j_network_meta_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Network meta-analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03a_stan_code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Exposing stan code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../src/03b_parallel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Parallel computation</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background"><span class="header-section-number">13.1</span> Background</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">13.2</span> Data</a></li>
  <li><a href="#model-description" id="toc-model-description" class="nav-link" data-scroll-target="#model-description"><span class="header-section-number">13.3</span> Model description</a>
  <ul class="collapse">
  <li><a href="#the-mixed-model-for-repeated-measures-mmrm" id="toc-the-mixed-model-for-repeated-measures-mmrm" class="nav-link" data-scroll-target="#the-mixed-model-for-repeated-measures-mmrm"><span class="header-section-number">13.3.1</span> The Mixed Model for Repeated Measures (MMRM)</a></li>
  <li><a href="#formal-specification-of-mmrm" id="toc-formal-specification-of-mmrm" class="nav-link" data-scroll-target="#formal-specification-of-mmrm"><span class="header-section-number">13.3.2</span> Formal specification of MMRM</a></li>
  <li><a href="#what-estimand-does-mmrm-address" id="toc-what-estimand-does-mmrm-address" class="nav-link" data-scroll-target="#what-estimand-does-mmrm-address"><span class="header-section-number">13.3.3</span> What estimand does MMRM address?</a></li>
  <li><a href="#is-mmrm-only-good-for-one-variable-across-visits" id="toc-is-mmrm-only-good-for-one-variable-across-visits" class="nav-link" data-scroll-target="#is-mmrm-only-good-for-one-variable-across-visits"><span class="header-section-number">13.3.4</span> Is MMRM only good for one variable across visits?</a></li>
  <li><a href="#should-we-use-the-baseline-measurement-as-a-covariate-or-an-extra-observation" id="toc-should-we-use-the-baseline-measurement-as-a-covariate-or-an-extra-observation" class="nav-link" data-scroll-target="#should-we-use-the-baseline-measurement-as-a-covariate-or-an-extra-observation"><span class="header-section-number">13.3.5</span> Should we use the baseline measurement as a covariate or an extra observation?</a></li>
  <li><a href="#how-is-mmrm-different-from-a-mixed-effects-model-with-a-random-subject-effect-on-the-intercept" id="toc-how-is-mmrm-different-from-a-mixed-effects-model-with-a-random-subject-effect-on-the-intercept" class="nav-link" data-scroll-target="#how-is-mmrm-different-from-a-mixed-effects-model-with-a-random-subject-effect-on-the-intercept"><span class="header-section-number">13.3.6</span> How is MMRM different from a mixed effects model with a random subject effect on the intercept?</a></li>
  <li><a href="#what-covariance-structure-to-use" id="toc-what-covariance-structure-to-use" class="nav-link" data-scroll-target="#what-covariance-structure-to-use"><span class="header-section-number">13.3.7</span> What covariance structure to use?</a></li>
  </ul></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><span class="header-section-number">13.4</span> Implementation</a>
  <ul class="collapse">
  <li><a href="#reference-implementations-using-sas-and-lme4" id="toc-reference-implementations-using-sas-and-lme4" class="nav-link" data-scroll-target="#reference-implementations-using-sas-and-lme4"><span class="header-section-number">13.4.1</span> Reference implementations using SAS and <code>lme4</code></a></li>
  <li><a href="#brms-implementation" id="toc-brms-implementation" class="nav-link" data-scroll-target="#brms-implementation"><span class="header-section-number">13.4.2</span> <code>brms</code> implementation</a></li>
  <li><a href="#model-parameterization-and-the-importance-of-at-least-weak-priors" id="toc-model-parameterization-and-the-importance-of-at-least-weak-priors" class="nav-link" data-scroll-target="#model-parameterization-and-the-importance-of-at-least-weak-priors"><span class="header-section-number">13.4.3</span> Model parameterization and the importance of (at least weak) priors</a></li>
  <li><a href="#meta-analytic-combined-mac-approach-to-historical-data-for-mmrms" id="toc-meta-analytic-combined-mac-approach-to-historical-data-for-mmrms" class="nav-link" data-scroll-target="#meta-analytic-combined-mac-approach-to-historical-data-for-mmrms"><span class="header-section-number">13.4.4</span> Meta-analytic combined (MAC) approach to historical data for MMRMs</a></li>
  <li><a href="#robust-meta-analytic-combined-rmac-approach-to-historical-data-for-mmrms" id="toc-robust-meta-analytic-combined-rmac-approach-to-historical-data-for-mmrms" class="nav-link" data-scroll-target="#robust-meta-analytic-combined-rmac-approach-to-historical-data-for-mmrms"><span class="header-section-number">13.4.5</span> Robust Meta-analytic combined (rMAC) approach to historical data for MMRMs</a></li>
  <li><a href="#going-beyond-the-traditional-mmrm-monotonic-effects" id="toc-going-beyond-the-traditional-mmrm-monotonic-effects" class="nav-link" data-scroll-target="#going-beyond-the-traditional-mmrm-monotonic-effects"><span class="header-section-number">13.4.6</span> Going beyond the traditional MMRM: monotonic effects</a></li>
  <li><a href="#going-beyond-the-traditional-mmrm-non-linear-functions" id="toc-going-beyond-the-traditional-mmrm-non-linear-functions" class="nav-link" data-scroll-target="#going-beyond-the-traditional-mmrm-non-linear-functions"><span class="header-section-number">13.4.7</span> Going beyond the traditional MMRM: non-linear functions</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results"><span class="header-section-number">13.5</span> Results</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">13.6</span> Conclusion</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">13.7</span> Exercises</a>
  <ul class="collapse">
  <li><a href="#excercise-1" id="toc-excercise-1" class="nav-link" data-scroll-target="#excercise-1"><span class="header-section-number">13.7.1</span> Excercise 1</a></li>
  <li><a href="#excercise-2" id="toc-excercise-2" class="nav-link" data-scroll-target="#excercise-2"><span class="header-section-number">13.7.2</span> Excercise 2</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../src/02_case_studies.html">Case studies</a></li><li class="breadcrumb-item"><a href="../src/02h_mmrm.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Bayesian Mixed effects Model for Repeated Measures</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-mmrm" class="quarto-section-identifier"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Bayesian Mixed effects Model for Repeated Measures</span></span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Björn Holzhauer - <a href="mailto:bjoern.holzhauer@novartis.com" class="email">bjoern.holzhauer@novartis.com</a> </p>
             <p>Sebastian Weber - <a href="mailto:sebastian.weber@novartis.com" class="email">sebastian.weber@novartis.com</a> </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<!-- https://raw.githubusercontent.com/Novartis/bamdd/main/src/_macros.qmd -->
<p>This case study covers</p>
<ul>
<li>Fitting mixed models for repeated measures using restricted maximum likelihood (REML) in R using the <code>mmrm</code> package</li>
<li>Fitting Bayesian mixed models for repeated measures using <code>brms</code> package</li>
<li>Distributional regression <code>sigma ~ 1 + AVISIT + TRT01P + AVISIT:TRT01P</code> to allow variances to vary across visits and treatment groups in a MMRM</li>
<li>Specifying an unstructured correlation structure for MMRMs using <code>autocor = ~unstr(time=AVISIT, gr=USUBJID)</code></li>
<li>Estimands addressed by MMRM models</li>
<li>Using the <code>emmeans</code> package to obtain least-squares means (LS-means), differences in LS-means and custom contrasts with highest posterior density credible intervals, as well as using <code>hypothesis</code> as an alternative for complex situations</li>
<li>Options for MMRM paramterization including forward difference contrasts for changes between visits using <code>contrasts(simulated_data$AVISIT) &lt;- MASS::contr.sdif</code></li>
<li>Meta-analytic combined approach to MMRMs for using historical data and attempts to make the approach more robust against prior-data-conflict</li>
<li>Extending MMRMs using covariates with a monotonic effect using <code>mo()</code> and non-linear terms</li>
</ul>
<p>To run the R code of this section please ensure to load these libraries first:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dqrng)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mmrm)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend=</span><span class="st">"cmdstanr"</span>, <span class="at">cmdstanr_write_stan_file_dir=</span><span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># create cache directory if not yet available</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4095867</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># default control argument passed to brms</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>control_args <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># allow wider printing</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">width=</span><span class="dv">120</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="background" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="background"><span class="header-section-number">13.1</span> Background</h2>
<p>In randomized controlled clinical trials efficacy variables are often measured at multiple points of time. This may be at visits to the trial site for assessments that require a patient to be in the investigator’s office, but could also be at a patient’s home (e.g.&nbsp;for a daily quality of life questionnaire). Multiple assessments over time are useful for a wide variety of reasons. Firstly, we get information about how the difference between treatment groups develops over time. I.e. about both the onset of action, as well as whether treatment effects disappear or decline at some point (e.g.&nbsp;after the discontinuation of treatment either by some patients during the treatment period or by all patients during a planned post-treatment follow-up period). Secondly, seeing consistent data over time provides additional evidence for the presence of an effect of an intervention. Thirdly, pre-treatment (baseline) assessment(s) of a variable are often used as a covariate in analyses, because this tends to reduce unexplained variability leading to smaller standard errors. Finally, data from post-baseline visits can help us deal with missing data or data that are not relevant for our estimand of interest.</p>
<p>Sometimes, we would be primarily interested in the treatment difference at one particular visit (e.g.&nbsp;the final visit at the end of the planned treatment period) or we might want to combine (e.g.&nbsp;average) treatment effects across multiple visits.</p>
</section>
<section id="data" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="data"><span class="header-section-number">13.2</span> Data</h2>
<p>We will simulate data from a hypothetical parallel group RCT that tests three doses of a drug (10, 20 or 40 mg once daily) compared with a placebo (0 mg once daily). The endpoint of interest is continuous and assessed at a baseline visit, as well as at 4 post-baseline visits (week 2, 4, 8 and 12). 200 patients are randomly assigned to each treatment group (approximately 50 patients per arm).</p>
<p>We simulate data with the following covariance matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation matrix between visits (baseline + 4 post-baseline visits)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">5</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.48</span>, <span class="fl">0.4</span>, <span class="fl">0.375</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="dv">1</span>,<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> rho[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="dv">2</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> rho[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="dv">3</span>,<span class="dv">4</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> rho[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="dv">4</span>,<span class="dv">5</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> rho[<span class="dv">1</span><span class="sc">:</span><span class="dv">1</span>]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="fu">lower.tri</span>(corr_matrix)] <span class="ot">&lt;-</span> <span class="fu">t</span>(corr_matrix)[<span class="fu">lower.tri</span>(corr_matrix)]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard deviations by visit (baseline + 4 post-baseline visits)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>sds <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">c</span>(<span class="fl">0.75</span>, <span class="fl">0.8</span>, <span class="fl">0.85</span>, <span class="fl">0.95</span>, <span class="fl">1.1</span>))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="ot">&lt;-</span> <span class="fu">diag</span>(sds) <span class="sc">%*%</span> corr_matrix <span class="sc">%*%</span> <span class="fu">diag</span>(sds)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cov_matrix, <span class="at">digits=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]  [,2]  [,3]  [,4]  [,5]
[1,] 0.750 0.465 0.383 0.338 0.341
[2,] 0.465 0.800 0.495 0.418 0.375
[3,] 0.383 0.495 0.850 0.539 0.464
[4,] 0.338 0.418 0.539 0.950 0.613
[5,] 0.341 0.375 0.464 0.613 1.100</code></pre>
</div>
</div>
<p>In our simulation some patients stop treatment before the end of the trial and actually drop out of the study. We no longer follow them, because we are interested in a hypothetical estimand as if they had stayed on drug, which means we are no longer interested in values after treatment discontinuation.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate from multivariate normal for control group </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (before adding treatment effect later)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We simulate 1000 patients and then apply inclusion criteria and keep the</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># first 200 that meet them.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>Nf <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(use_small_N) {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    Nf <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>effect_course <span class="ot">&lt;-</span> <span class="cf">function</span>(dose, time, <span class="at">ed50=</span><span class="dv">8</span>, <span class="at">et50=</span><span class="dv">3</span>) {</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.9</span> <span class="sc">*</span> dose <span class="sc">/</span>(dose <span class="sc">+</span> ed50) <span class="sc">*</span> time<span class="sc">^</span><span class="dv">3</span> <span class="sc">/</span>(time<span class="sc">^</span><span class="dv">3</span> <span class="sc">+</span> et50<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>zero <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="fu">c</span>(<span class="st">"BASE"</span>, <span class="fu">paste0</span>(<span class="st">"visit"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)))</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>simulated_data <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="at">n =</span> N,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">mean =</span> zero,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sigma =</span> cov_matrix) <span class="sc">%&gt;%</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># turn into tibble</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply inclusion criteria and keep first Nf patients</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(BASE<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">&lt;=</span>Nf) <span class="sc">%&gt;%</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign subject ID, treatment group and create missing data</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">USUBJID =</span> <span class="fu">row_number</span>(),</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>           <span class="at">TRT01P =</span> <span class="fu">dqsample</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="dv">0</span>L, <span class="dv">10</span>L, <span class="dv">20</span>L, <span class="dv">40</span>L), <span class="at">size=</span>Nf, <span class="at">replace=</span>T),</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>           <span class="co"># Simulate dropouts</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">dropp2 =</span> <span class="fu">plogis</span>(visit1<span class="dv">-2</span>),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">dropp3 =</span> <span class="fu">plogis</span>(visit2<span class="dv">-2</span>),</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">dropp4 =</span> <span class="fu">plogis</span>(visit3<span class="dv">-2</span>),</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>           <span class="at">dropv =</span> <span class="fu">case_when</span>(<span class="fu">runif</span>(<span class="at">n=</span><span class="fu">n</span>())<span class="sc">&lt;</span>dropp2 <span class="sc">~</span> <span class="dv">2</span>L,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">runif</span>(<span class="at">n=</span><span class="fu">n</span>())<span class="sc">&lt;</span>dropp3 <span class="sc">~</span> <span class="dv">3</span>L,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">runif</span>(<span class="at">n=</span><span class="fu">n</span>())<span class="sc">&lt;</span>dropp4 <span class="sc">~</span> <span class="dv">4</span>L,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                             <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">5</span>L),</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>           <span class="at">visit2 =</span> <span class="fu">ifelse</span>(dropv<span class="sc">&lt;=</span><span class="dv">2</span>L, <span class="cn">NA_real_</span>, visit2),</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>           <span class="at">visit3 =</span> <span class="fu">ifelse</span>(dropv<span class="sc">&lt;=</span><span class="dv">3</span>L, <span class="cn">NA_real_</span>, visit3),</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>           <span class="at">visit4 =</span> <span class="fu">ifelse</span>(dropv<span class="sc">&lt;=</span><span class="dv">3</span>L, <span class="cn">NA_real_</span>, visit4)) <span class="sc">%&gt;%</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dropp2, <span class="sc">-</span>dropp3, <span class="sc">-</span>dropp4, <span class="sc">-</span>dropv) <span class="sc">%&gt;%</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turn data into long-format</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">starts_with</span>(<span class="st">"visit"</span>), <span class="at">names_to =</span> <span class="st">"AVISIT"</span>, <span class="at">values_to=</span><span class="st">"AVAL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign visit days</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">ADY =</span> <span class="fu">case_when</span>(AVISIT<span class="sc">==</span><span class="st">"visit1"</span> <span class="sc">~</span> <span class="dv">2</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>                        AVISIT<span class="sc">==</span><span class="st">"visit2"</span> <span class="sc">~</span> <span class="dv">4</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>                        AVISIT<span class="sc">==</span><span class="st">"visit3"</span> <span class="sc">~</span> <span class="dv">8</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>                        AVISIT<span class="sc">==</span><span class="st">"visit4"</span> <span class="sc">~</span> <span class="dv">12</span>L<span class="sc">*</span><span class="dv">7</span>L),</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Turn to factor with defined order of visits</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">AVISIT =</span> <span class="fu">factor</span>(AVISIT, <span class="fu">paste0</span>(<span class="st">"visit"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assume rising treatment effect over time (half there by week 3) with an </span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Emax dose response (ED50 = 5 mg)</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">AVAL =</span> AVAL <span class="sc">+</span> <span class="fu">effect_course</span>(ADY<span class="sc">/</span><span class="dv">7</span>, TRT01P),</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Change from baseline = value - baseline</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">CHG =</span> AVAL <span class="sc">-</span> BASE,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">TRT01P=</span><span class="fu">factor</span>(TRT01P)) <span class="sc">%&gt;%</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(USUBJID, TRT01P, AVISIT, ADY, AVAL, CHG, BASE) <span class="sc">%&gt;%</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Discard missing data</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(AVAL))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The first 10 rows of the simulated data set are:</p>
<div class="cell">
<div class="cell-output-display">
<div id="nsikoswpba" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#nsikoswpba table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#nsikoswpba thead, #nsikoswpba tbody, #nsikoswpba tfoot, #nsikoswpba tr, #nsikoswpba td, #nsikoswpba th {
  border-style: none;
}

#nsikoswpba p {
  margin: 0;
  padding: 0;
}

#nsikoswpba .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#nsikoswpba .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#nsikoswpba .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#nsikoswpba .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#nsikoswpba .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#nsikoswpba .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#nsikoswpba .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#nsikoswpba .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#nsikoswpba .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#nsikoswpba .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#nsikoswpba .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#nsikoswpba .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#nsikoswpba .gt_spanner_row {
  border-bottom-style: hidden;
}

#nsikoswpba .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#nsikoswpba .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#nsikoswpba .gt_from_md > :first-child {
  margin-top: 0;
}

#nsikoswpba .gt_from_md > :last-child {
  margin-bottom: 0;
}

#nsikoswpba .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#nsikoswpba .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#nsikoswpba .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#nsikoswpba .gt_row_group_first td {
  border-top-width: 2px;
}

#nsikoswpba .gt_row_group_first th {
  border-top-width: 2px;
}

#nsikoswpba .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#nsikoswpba .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#nsikoswpba .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#nsikoswpba .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#nsikoswpba .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#nsikoswpba .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#nsikoswpba .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#nsikoswpba .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#nsikoswpba .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#nsikoswpba .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#nsikoswpba .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#nsikoswpba .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#nsikoswpba .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#nsikoswpba .gt_left {
  text-align: left;
}

#nsikoswpba .gt_center {
  text-align: center;
}

#nsikoswpba .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#nsikoswpba .gt_font_normal {
  font-weight: normal;
}

#nsikoswpba .gt_font_bold {
  font-weight: bold;
}

#nsikoswpba .gt_font_italic {
  font-style: italic;
}

#nsikoswpba .gt_super {
  font-size: 65%;
}

#nsikoswpba .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#nsikoswpba .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#nsikoswpba .gt_indent_1 {
  text-indent: 5px;
}

#nsikoswpba .gt_indent_2 {
  text-indent: 10px;
}

#nsikoswpba .gt_indent_3 {
  text-indent: 15px;
}

#nsikoswpba .gt_indent_4 {
  text-indent: 20px;
}

#nsikoswpba .gt_indent_5 {
  text-indent: 25px;
}

#nsikoswpba .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#nsikoswpba div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="a::stub" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"></th>
<th id="USUBJID" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">USUBJID</th>
<th id="TRT01P" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">TRT01P</th>
<th id="AVISIT" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">AVISIT</th>
<th id="ADY" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">ADY</th>
<th id="AVAL" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">AVAL</th>
<th id="CHG" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">CHG</th>
<th id="BASE" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">BASE</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td id="stub_1_1" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">1</td>
<td class="gt_row gt_right" headers="stub_1_1 USUBJID">1</td>
<td class="gt_row gt_right" headers="stub_1_1 TRT01P">10</td>
<td class="gt_row gt_left" headers="stub_1_1 AVISIT">visit1</td>
<td class="gt_row gt_right" headers="stub_1_1 ADY">14</td>
<td class="gt_row gt_right" headers="stub_1_1 AVAL">0.864</td>
<td class="gt_row gt_right" headers="stub_1_1 CHG">0.785</td>
<td class="gt_row gt_right" headers="stub_1_1 BASE">0.079</td>
</tr>
<tr class="even">
<td id="stub_1_2" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">2</td>
<td class="gt_row gt_right" headers="stub_1_2 USUBJID">1</td>
<td class="gt_row gt_right" headers="stub_1_2 TRT01P">10</td>
<td class="gt_row gt_left" headers="stub_1_2 AVISIT">visit2</td>
<td class="gt_row gt_right" headers="stub_1_2 ADY">28</td>
<td class="gt_row gt_right" headers="stub_1_2 AVAL">0.149</td>
<td class="gt_row gt_right" headers="stub_1_2 CHG">0.070</td>
<td class="gt_row gt_right" headers="stub_1_2 BASE">0.079</td>
</tr>
<tr class="odd">
<td id="stub_1_3" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">3</td>
<td class="gt_row gt_right" headers="stub_1_3 USUBJID">1</td>
<td class="gt_row gt_right" headers="stub_1_3 TRT01P">10</td>
<td class="gt_row gt_left" headers="stub_1_3 AVISIT">visit3</td>
<td class="gt_row gt_right" headers="stub_1_3 ADY">56</td>
<td class="gt_row gt_right" headers="stub_1_3 AVAL">0.530</td>
<td class="gt_row gt_right" headers="stub_1_3 CHG">0.451</td>
<td class="gt_row gt_right" headers="stub_1_3 BASE">0.079</td>
</tr>
<tr class="even">
<td id="stub_1_4" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">4</td>
<td class="gt_row gt_right" headers="stub_1_4 USUBJID">1</td>
<td class="gt_row gt_right" headers="stub_1_4 TRT01P">10</td>
<td class="gt_row gt_left" headers="stub_1_4 AVISIT">visit4</td>
<td class="gt_row gt_right" headers="stub_1_4 ADY">84</td>
<td class="gt_row gt_right" headers="stub_1_4 AVAL">−0.972</td>
<td class="gt_row gt_right" headers="stub_1_4 CHG">−1.051</td>
<td class="gt_row gt_right" headers="stub_1_4 BASE">0.079</td>
</tr>
<tr class="odd">
<td id="stub_1_5" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">5</td>
<td class="gt_row gt_right" headers="stub_1_5 USUBJID">2</td>
<td class="gt_row gt_right" headers="stub_1_5 TRT01P">40</td>
<td class="gt_row gt_left" headers="stub_1_5 AVISIT">visit1</td>
<td class="gt_row gt_right" headers="stub_1_5 ADY">14</td>
<td class="gt_row gt_right" headers="stub_1_5 AVAL">0.225</td>
<td class="gt_row gt_right" headers="stub_1_5 CHG">−0.009</td>
<td class="gt_row gt_right" headers="stub_1_5 BASE">0.235</td>
</tr>
<tr class="even">
<td id="stub_1_6" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">6</td>
<td class="gt_row gt_right" headers="stub_1_6 USUBJID">2</td>
<td class="gt_row gt_right" headers="stub_1_6 TRT01P">40</td>
<td class="gt_row gt_left" headers="stub_1_6 AVISIT">visit2</td>
<td class="gt_row gt_right" headers="stub_1_6 ADY">28</td>
<td class="gt_row gt_right" headers="stub_1_6 AVAL">0.397</td>
<td class="gt_row gt_right" headers="stub_1_6 CHG">0.162</td>
<td class="gt_row gt_right" headers="stub_1_6 BASE">0.235</td>
</tr>
<tr class="odd">
<td id="stub_1_7" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">7</td>
<td class="gt_row gt_right" headers="stub_1_7 USUBJID">3</td>
<td class="gt_row gt_right" headers="stub_1_7 TRT01P">0</td>
<td class="gt_row gt_left" headers="stub_1_7 AVISIT">visit1</td>
<td class="gt_row gt_right" headers="stub_1_7 ADY">14</td>
<td class="gt_row gt_right" headers="stub_1_7 AVAL">0.761</td>
<td class="gt_row gt_right" headers="stub_1_7 CHG">−0.183</td>
<td class="gt_row gt_right" headers="stub_1_7 BASE">0.944</td>
</tr>
<tr class="even">
<td id="stub_1_8" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">8</td>
<td class="gt_row gt_right" headers="stub_1_8 USUBJID">3</td>
<td class="gt_row gt_right" headers="stub_1_8 TRT01P">0</td>
<td class="gt_row gt_left" headers="stub_1_8 AVISIT">visit2</td>
<td class="gt_row gt_right" headers="stub_1_8 ADY">28</td>
<td class="gt_row gt_right" headers="stub_1_8 AVAL">−0.086</td>
<td class="gt_row gt_right" headers="stub_1_8 CHG">−1.030</td>
<td class="gt_row gt_right" headers="stub_1_8 BASE">0.944</td>
</tr>
<tr class="odd">
<td id="stub_1_9" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">9</td>
<td class="gt_row gt_right" headers="stub_1_9 USUBJID">3</td>
<td class="gt_row gt_right" headers="stub_1_9 TRT01P">0</td>
<td class="gt_row gt_left" headers="stub_1_9 AVISIT">visit3</td>
<td class="gt_row gt_right" headers="stub_1_9 ADY">56</td>
<td class="gt_row gt_right" headers="stub_1_9 AVAL">0.680</td>
<td class="gt_row gt_right" headers="stub_1_9 CHG">−0.264</td>
<td class="gt_row gt_right" headers="stub_1_9 BASE">0.944</td>
</tr>
<tr class="even">
<td id="stub_1_10" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">10</td>
<td class="gt_row gt_right" headers="stub_1_10 USUBJID">3</td>
<td class="gt_row gt_right" headers="stub_1_10 TRT01P">0</td>
<td class="gt_row gt_left" headers="stub_1_10 AVISIT">visit4</td>
<td class="gt_row gt_right" headers="stub_1_10 ADY">84</td>
<td class="gt_row gt_right" headers="stub_1_10 AVAL">2.567</td>
<td class="gt_row gt_right" headers="stub_1_10 CHG">1.623</td>
<td class="gt_row gt_right" headers="stub_1_10 BASE">0.944</td>
</tr>
<tr class="odd">
<td id="stub_1_11" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier; font-size: x-small; background-color: #E4E4E4">11..641</td>
<td class="gt_row gt_right" headers="stub_1_11 USUBJID" style="background-color: #E4E4E4"></td>
<td class="gt_row gt_right" headers="stub_1_11 TRT01P" style="background-color: #E4E4E4"></td>
<td class="gt_row gt_left" headers="stub_1_11 AVISIT" style="background-color: #E4E4E4"></td>
<td class="gt_row gt_right" headers="stub_1_11 ADY" style="background-color: #E4E4E4"></td>
<td class="gt_row gt_right" headers="stub_1_11 AVAL" style="background-color: #E4E4E4"></td>
<td class="gt_row gt_right" headers="stub_1_11 CHG" style="background-color: #E4E4E4"></td>
<td class="gt_row gt_right" headers="stub_1_11 BASE" style="background-color: #E4E4E4"></td>
</tr>
<tr class="even">
<td id="stub_1_12" class="gt_row gt_right gt_stub" data-quarto-table-cell-role="th" scope="row" style="font-family: Courier">642</td>
<td class="gt_row gt_right" headers="stub_1_12 USUBJID">200</td>
<td class="gt_row gt_right" headers="stub_1_12 TRT01P">10</td>
<td class="gt_row gt_left" headers="stub_1_12 AVISIT">visit4</td>
<td class="gt_row gt_right" headers="stub_1_12 ADY">84</td>
<td class="gt_row gt_right" headers="stub_1_12 AVAL">0.447</td>
<td class="gt_row gt_right" headers="stub_1_12 CHG">−0.418</td>
<td class="gt_row gt_right" headers="stub_1_12 BASE">0.866</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The assumed true change from baseline relationship in this simulation is:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/plot_of_truth-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The entire simulated data set with simulated residual noise in a graphical representation looks like:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/plot_of_data1-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-description" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="model-description"><span class="header-section-number">13.3</span> Model description</h2>
<section id="the-mixed-model-for-repeated-measures-mmrm" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="the-mixed-model-for-repeated-measures-mmrm"><span class="header-section-number">13.3.1</span> The Mixed Model for Repeated Measures (MMRM)</h3>
<p>The <a href="https://doi.org/10.1177/009286150804200402">Mixed Model for Repeated Measures (MMRM)</a> is a very popular model for continuous endpoints assessed at multiple visits (or their change from a pre-treatment baseline value). Part of its popularity stems from the fact that it is a flexible model for an outcome measured at different visits that accounts for within patient correlation and can handle missing data without imputation (if you are interested in the right estimand). In particular, it was a major milestone for treating missing data and drop-outs more appropriately than via last-observation-carried-forward (LOCF), which lead to it being <a href="https://doi.org/10.1177/009286150804200402">recommended by some as a default analysis approach for a hypothetical estimand</a>. Another contributing factor to MMRM’s success in the pharmaceutical industry is that it can be fit using restricted maximum likelihood (REML) with standard software.</p>
<p>A widely used default analysis is to have the following (fixed effects) model terms</p>
<ul>
<li><p>visit as a factor,</p></li>
<li><p>treatment as a factor,</p></li>
<li><p>treatment by visit interaction,</p></li>
<li><p>baseline (pre-treatment) value of the continuous endpoint as a continuous covariate, and</p></li>
<li><p>visit by baseline value interaction.</p></li>
</ul>
<p>These terms allow for a flexible time course in the control group, as well as different treatment effects at different visits on top of that. Additionally, adjustment for baseline values usually reduces standard errors in clinical trials. By allowing for a visit by baseline interaction we allow the relationship between the values at each visit and the baseline to differ. This reflects that the longer ago a baseline value was measured, the less it will typically be correlated with future measurements.</p>
<p>Where a MMRM differs from a linear model is that the residuals from different visits of the same patient are assumed to be correlated. We do not usually wish to restrict this correlation structure to be of a particular form (such as first-order autoregressive AR(1)), but to allow it to be of an “unstructured” form. This is preferable over simpler structures like first-order autoregressive AR(1), for example. For example, AR(1) assumes a constant correlation between any adjacent visits while raising this correlation to a power for more distant observations. This simple correlation structure may inappropriately model these distant observations for a single patient as almost fully independent resulting in inappropriately small standard errors.</p>
</section>
<section id="formal-specification-of-mmrm" class="level3" data-number="13.3.2">
<h3 data-number="13.3.2" class="anchored" data-anchor-id="formal-specification-of-mmrm"><span class="header-section-number">13.3.2</span> Formal specification of MMRM</h3>
<p>Formally, let us assume that there are <span class="math inline">\(V\)</span> visits. We usually assume that the <span class="math inline">\(V\)</span>-dimensional response <span class="math inline">\(\boldsymbol{Y}_i\)</span> for patient <span class="math inline">\(i\)</span> satisfies <span class="math display">\[\boldsymbol{Y}_i = \boldsymbol{X}_i \boldsymbol{\beta} + \boldsymbol{Z}_i \boldsymbol{b}_i + \boldsymbol{\epsilon}_i,\]</span> where <span class="math inline">\(\boldsymbol{\beta}\)</span> is a vector of regression coefficients for fixed effects, the <span class="math inline">\(\boldsymbol{b}_i \sim \text{MVN}(\boldsymbol{0}, \boldsymbol{D})\)</span> are random effects with the vector <span class="math inline">\(\boldsymbol{Z}_i\)</span> indicating which one applies for which component (each corresponding to a visit) of the response, and the <span class="math inline">\(\boldsymbol{\epsilon}_i \sim \text{MVN}(\boldsymbol{0}, \boldsymbol{\Sigma})\)</span> are residual errors. Then, <span class="math display">\[\boldsymbol{Y}_i \sim \text{MVN}(\boldsymbol{X}_i \boldsymbol{\beta}, \boldsymbol{V}_i),\]</span> where <span class="math display">\[\boldsymbol{V}_i = \boldsymbol{Z}_i \boldsymbol{D} \boldsymbol{Z}_i^T + \boldsymbol{\Sigma}.\]</span></p>
<p>With the goal to avoid unnnecessary assumptions, the marginal covariance matrix <span class="math inline">\(\boldsymbol{V}_i\)</span> is usually kept “unstructured”. I.e. we usually want to avoid imposing any particular structure on the covariance matrix. However, an unstructured covariance matrix requires to inform potentially many parameters which grow exponentially fast in the number of visits <span class="math inline">\(V\)</span>. Modeling the covariance matrix as a structured correlation matrix and by visit residual error standard deviations may facilitate stabilizing fitting procedures.</p>
<!--- we have "V" visits and a V_i covariance matrix here... can we --->
<!--- relabel one of these? Maybe make V_i => \Omega_i? Or make V_i to --->
<!--- be n_i, just like in the paper you cite? --->
</section>
<section id="what-estimand-does-mmrm-address" class="level3" data-number="13.3.3">
<h3 data-number="13.3.3" class="anchored" data-anchor-id="what-estimand-does-mmrm-address"><span class="header-section-number">13.3.3</span> What estimand does MMRM address?</h3>
<p>MMRM <a href="https://www.psiweb.org/docs/default-source/resources/psi-subgroups/scientific/2015/estimands-28-09-2015/jamesroger.pdf">can address a hypothetical estimand</a> about a continuous variable at one or more visits “as if all patients had remained on treatment to the end of the planned treatment period”. This is done by applying MMRM to on-treatment data only and making the assumption that stopping treatment or leaving the study occurs at random conditional on the preceding observations and the covariates being included in the model (“missing at random” or MAR).</p>
<p>One key attractive feature is that MMRM estimates this estimand without us needing to directly impute any data. I.e. there is no need for multiple imputation and fitting the model to each imputation, instead we only need to fit MMRM to the on-treatment data under analysis once. However, note that if there are no post-baseline observations for a patient the model will exclude the patient from the analysis, which is a valid thing to do under the MAR assumption.</p>
<p>Nevertheless, it produces identical results as if we had created a large number of multiple imputations, ran the model and then combined the results.</p>
<p>If we wish to target different estimands or make different assumptions than implied by the MMRM, we would need to impute prior to fitting a MMRM. If we perform multiple imputation, fitting a MMRM becomes unnecessary, because when all patients have (non-missing) data at all visits that should enter the analysis (i.e.&nbsp;is directly assessing our estimand of interest), then fitting a MMRM (with both treatment group and all baseline covariates have an interaction with visit) is equivalent to separately fitting a linear regression model for each visit.</p>
</section>
<section id="is-mmrm-only-good-for-one-variable-across-visits" class="level3" data-number="13.3.4">
<h3 data-number="13.3.4" class="anchored" data-anchor-id="is-mmrm-only-good-for-one-variable-across-visits"><span class="header-section-number">13.3.4</span> Is MMRM only good for one variable across visits?</h3>
<p>There is nothing that requires the separate observations being modeled by a MMRM to be measurements of the same variable across time. You can just as appropriately apply MMRM to multiple outcomes measured at the same time, or across multiple occasions. This can be helpful when missingness or data becoming irrelevant to the estimand of interest depends on multiple variables.</p>
<p>An example would be a diabetes study, where both fasting plasma glucose (FPG) and glycated hemoglobin (HbA1c) are measured at each visit, and rescue medication is initiated when either of the two is above some threshold. In order to estimate the hypothetical estimand for the HbA1c difference “as if no rescue medication had been taken”, you can jointly model FPG and HbA1c.</p>
</section>
<section id="should-we-use-the-baseline-measurement-as-a-covariate-or-an-extra-observation" class="level3" data-number="13.3.5">
<h3 data-number="13.3.5" class="anchored" data-anchor-id="should-we-use-the-baseline-measurement-as-a-covariate-or-an-extra-observation"><span class="header-section-number">13.3.5</span> Should we use the baseline measurement as a covariate or an extra observation?</h3>
<p>For some patients all post-baseline assessments will be missing, additionally some patients may not have a baseline assessment. In this situation (unless we somehow impute these data), the MMRM model we described cannot include such a patient in the analysis.</p>
<p>One potential idea for dealing with this situation is to use the baseline assessment not as a covariate, but as an extra observation. I.e. there is an additional baseline record for each patient, but the baseline term, as well as the baseline by visit interaction terms are removed from the model.</p>
<p>This is a reasonable approach, if the residuals across visits are jointly multivariate normal, which we are already assuming for the post-baseline visits. However, this can be a problematic assumption to make when inclusion criteria are applied at baseline that lead to the residuals for the baseline assessment not following a normal distribution. Such an inclusion criterion could be on the variable under analysis itself, or it could be on a variable that is sufficiently strongly correlated with the analysis variable to deform its distribution.</p>
<!--- Are there papers suggesting that this is really giving -->
<!--reasonable power and the like? As I understand, you would drop the -->
<!--baseline value as a covariate from the model, which would surprise -->
<!--me by now to be a good idea whenever we want to analyze any given -->
<!--data-set. I'd expect that this leads to a power-loss and -->
<!--conditioning on the baseline value is crucial. Maybe we drop this -->
<!--section to avoid the issues of including baseline values as -->
<!--covariate or outcome? -->
</section>
<section id="how-is-mmrm-different-from-a-mixed-effects-model-with-a-random-subject-effect-on-the-intercept" class="level3" data-number="13.3.6">
<h3 data-number="13.3.6" class="anchored" data-anchor-id="how-is-mmrm-different-from-a-mixed-effects-model-with-a-random-subject-effect-on-the-intercept"><span class="header-section-number">13.3.6</span> How is MMRM different from a mixed effects model with a random subject effect on the intercept?</h3>
<p>A mixed (random) effects model with a random subject effect on the intercept effectively assumes that the residuals for all visits are equally strongly correlated (“compound symmetric covariance structure”, see next subsection) and also that the standard deviation is the same across visits (although <code>brms</code> would let us avoid this by using distributional regression as discussed later).</p>
</section>
<section id="what-covariance-structure-to-use" class="level3" data-number="13.3.7">
<h3 data-number="13.3.7" class="anchored" data-anchor-id="what-covariance-structure-to-use"><span class="header-section-number">13.3.7</span> What covariance structure to use?</h3>
<p>There are several options for the covariance structures we can use</p>
<ul>
<li>The standard deviation will usually go up over time in RCTs. This occurs in part because the trial population was originally forced to be somewhat homogenous at baseline by the trial inclusion criteria. The further we move away from that point in time the more heterogenous outcomes will become across patients. Thus, we at least want to allow the variability to differ between visits.</li>
<li>Data from visits that are closer in time to each other tend to be more highly correlated. Thus, a compound symmetric covariance structure that makes all visits equally correlated will not be realistic, but may sometimes be a reasonable approximation.</li>
<li>The correlation between visits of a patient usually never drops to zero even if visits are months or years apart. Generally, assuming a correlation structure that substantially underestimates the correlation between some visits potentially does the most harm. In particular, an AR(1) correlation structure should in practice be avoided as it leads to exponentially fast diminishing correlations between visits.</li>
<li>It is most common to use MMRM with a completely unstructured covariance structure across visits and we often even allow it to differ by treatment group. This avoids making (potentially unnecessary) assumptions. It also ensures the equivalence between MMRM and a by-visit-analysis in the absence of missing data.</li>
</ul>
<p>As an illustration of what covariance matrices look like in practice, here is the estimated covariance structure reported by <a href="https://doi.org/10.1002/pst.1705">Holzhauer et al.&nbsp;2015</a> for the fasting plasma glucose (FPG) values from one treatment group of a diabetes trial.</p>
<div class="cell">
<div class="cell-output-display">
<div id="qnxcarhwyd" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#qnxcarhwyd table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#qnxcarhwyd thead, #qnxcarhwyd tbody, #qnxcarhwyd tfoot, #qnxcarhwyd tr, #qnxcarhwyd td, #qnxcarhwyd th {
  border-style: none;
}

#qnxcarhwyd p {
  margin: 0;
  padding: 0;
}

#qnxcarhwyd .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#qnxcarhwyd .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#qnxcarhwyd .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#qnxcarhwyd .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#qnxcarhwyd .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#qnxcarhwyd .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qnxcarhwyd .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#qnxcarhwyd .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#qnxcarhwyd .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#qnxcarhwyd .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#qnxcarhwyd .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#qnxcarhwyd .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#qnxcarhwyd .gt_spanner_row {
  border-bottom-style: hidden;
}

#qnxcarhwyd .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#qnxcarhwyd .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#qnxcarhwyd .gt_from_md > :first-child {
  margin-top: 0;
}

#qnxcarhwyd .gt_from_md > :last-child {
  margin-bottom: 0;
}

#qnxcarhwyd .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#qnxcarhwyd .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#qnxcarhwyd .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#qnxcarhwyd .gt_row_group_first td {
  border-top-width: 2px;
}

#qnxcarhwyd .gt_row_group_first th {
  border-top-width: 2px;
}

#qnxcarhwyd .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#qnxcarhwyd .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#qnxcarhwyd .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#qnxcarhwyd .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qnxcarhwyd .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#qnxcarhwyd .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#qnxcarhwyd .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#qnxcarhwyd .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#qnxcarhwyd .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qnxcarhwyd .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#qnxcarhwyd .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#qnxcarhwyd .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#qnxcarhwyd .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#qnxcarhwyd .gt_left {
  text-align: left;
}

#qnxcarhwyd .gt_center {
  text-align: center;
}

#qnxcarhwyd .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#qnxcarhwyd .gt_font_normal {
  font-weight: normal;
}

#qnxcarhwyd .gt_font_bold {
  font-weight: bold;
}

#qnxcarhwyd .gt_font_italic {
  font-style: italic;
}

#qnxcarhwyd .gt_super {
  font-size: 65%;
}

#qnxcarhwyd .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#qnxcarhwyd .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#qnxcarhwyd .gt_indent_1 {
  text-indent: 5px;
}

#qnxcarhwyd .gt_indent_2 {
  text-indent: 10px;
}

#qnxcarhwyd .gt_indent_3 {
  text-indent: 15px;
}

#qnxcarhwyd .gt_indent_4 {
  text-indent: 20px;
}

#qnxcarhwyd .gt_indent_5 {
  text-indent: 25px;
}

#qnxcarhwyd .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#qnxcarhwyd div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_heading header">
<th colspan="9" class="gt_heading gt_title gt_font_normal gt_bottom_border"><strong>Example of a covariance matrix for fasting plasma glucose in diabetic patients</strong></th>
</tr>
<tr class="gt_col_headings even">
<th id="Visit" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold" scope="col">Visit</th>
<th id="Week-0" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold" scope="col">Week 0</th>
<th id="Week-4" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold" scope="col">Week 4</th>
<th id="Week-12" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold" scope="col">Week 12</th>
<th id="Week-16" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold" scope="col">Week 16</th>
<th id="Week-24" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold" scope="col">Week 24</th>
<th id="Week-32" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold" scope="col">Week 32</th>
<th id="Week-40" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold" scope="col">Week 40</th>
<th id="Week-52" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold" scope="col">Week 52</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Visit" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold">Week 0</td>
<td class="gt_row gt_right" headers="Week 0">7.68</td>
<td class="gt_row gt_right" headers="Week 4">NA</td>
<td class="gt_row gt_right" headers="Week 12">NA</td>
<td class="gt_row gt_right" headers="Week 16">NA</td>
<td class="gt_row gt_right" headers="Week 24">NA</td>
<td class="gt_row gt_right" headers="Week 32">NA</td>
<td class="gt_row gt_right" headers="Week 40">NA</td>
<td class="gt_row gt_right" headers="Week 52">NA</td>
</tr>
<tr class="even">
<td class="gt_row gt_left gt_striped" headers="Visit" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold">Week 4</td>
<td class="gt_row gt_right gt_striped" headers="Week 0">4.00</td>
<td class="gt_row gt_right gt_striped" headers="Week 4">6.60</td>
<td class="gt_row gt_right gt_striped" headers="Week 12">NA</td>
<td class="gt_row gt_right gt_striped" headers="Week 16">NA</td>
<td class="gt_row gt_right gt_striped" headers="Week 24">NA</td>
<td class="gt_row gt_right gt_striped" headers="Week 32">NA</td>
<td class="gt_row gt_right gt_striped" headers="Week 40">NA</td>
<td class="gt_row gt_right gt_striped" headers="Week 52">NA</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Visit" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold">Week 12</td>
<td class="gt_row gt_right" headers="Week 0">3.55</td>
<td class="gt_row gt_right" headers="Week 4">4.51</td>
<td class="gt_row gt_right" headers="Week 12">6.52</td>
<td class="gt_row gt_right" headers="Week 16">NA</td>
<td class="gt_row gt_right" headers="Week 24">NA</td>
<td class="gt_row gt_right" headers="Week 32">NA</td>
<td class="gt_row gt_right" headers="Week 40">NA</td>
<td class="gt_row gt_right" headers="Week 52">NA</td>
</tr>
<tr class="even">
<td class="gt_row gt_left gt_striped" headers="Visit" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold">Week 16</td>
<td class="gt_row gt_right gt_striped" headers="Week 0">3.03</td>
<td class="gt_row gt_right gt_striped" headers="Week 4">3.83</td>
<td class="gt_row gt_right gt_striped" headers="Week 12">5.02</td>
<td class="gt_row gt_right gt_striped" headers="Week 16">6.90</td>
<td class="gt_row gt_right gt_striped" headers="Week 24">NA</td>
<td class="gt_row gt_right gt_striped" headers="Week 32">NA</td>
<td class="gt_row gt_right gt_striped" headers="Week 40">NA</td>
<td class="gt_row gt_right gt_striped" headers="Week 52">NA</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Visit" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold">Week 24</td>
<td class="gt_row gt_right" headers="Week 0">3.32</td>
<td class="gt_row gt_right" headers="Week 4">4.00</td>
<td class="gt_row gt_right" headers="Week 12">4.29</td>
<td class="gt_row gt_right" headers="Week 16">4.42</td>
<td class="gt_row gt_right" headers="Week 24">6.20</td>
<td class="gt_row gt_right" headers="Week 32">NA</td>
<td class="gt_row gt_right" headers="Week 40">NA</td>
<td class="gt_row gt_right" headers="Week 52">NA</td>
</tr>
<tr class="even">
<td class="gt_row gt_left gt_striped" headers="Visit" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold">Week 32</td>
<td class="gt_row gt_right gt_striped" headers="Week 0">3.06</td>
<td class="gt_row gt_right gt_striped" headers="Week 4">3.22</td>
<td class="gt_row gt_right gt_striped" headers="Week 12">3.72</td>
<td class="gt_row gt_right gt_striped" headers="Week 16">4.23</td>
<td class="gt_row gt_right gt_striped" headers="Week 24">4.45</td>
<td class="gt_row gt_right gt_striped" headers="Week 32">5.73</td>
<td class="gt_row gt_right gt_striped" headers="Week 40">NA</td>
<td class="gt_row gt_right gt_striped" headers="Week 52">NA</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Visit" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold">Week 40</td>
<td class="gt_row gt_right" headers="Week 0">3.60</td>
<td class="gt_row gt_right" headers="Week 4">3.74</td>
<td class="gt_row gt_right" headers="Week 12">4.66</td>
<td class="gt_row gt_right" headers="Week 16">5.10</td>
<td class="gt_row gt_right" headers="Week 24">4.80</td>
<td class="gt_row gt_right" headers="Week 32">5.30</td>
<td class="gt_row gt_right" headers="Week 40">7.80</td>
<td class="gt_row gt_right" headers="Week 52">NA</td>
</tr>
<tr class="even">
<td class="gt_row gt_left gt_striped" headers="Visit" style="background-color: #A9A9A9; color: #FFFFFF; font-weight: bold">Week 52</td>
<td class="gt_row gt_right gt_striped" headers="Week 0">3.60</td>
<td class="gt_row gt_right gt_striped" headers="Week 4">3.44</td>
<td class="gt_row gt_right gt_striped" headers="Week 12">4.48</td>
<td class="gt_row gt_right gt_striped" headers="Week 16">4.53</td>
<td class="gt_row gt_right gt_striped" headers="Week 24">4.67</td>
<td class="gt_row gt_right gt_striped" headers="Week 32">5.16</td>
<td class="gt_row gt_right gt_striped" headers="Week 40">6.26</td>
<td class="gt_row gt_right gt_striped" headers="Week 52">8.51</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In terms of longer term data, <a href="https://doi.org/10.1080/19466315.2013.861766">Holzhauer 2014</a> reported that in a RCT in pre-diabetic patients the correlation matrix for FPG could be well described by the numbers in the table below and that “during the first 3 years of the study, the variance appeared to be relatively constant around 0.68, but there was some indication of an increasing variability in years 3–6.” Unlike the numbers in diabetic patients, these numbers come from a model adjusting for the baseline FPG assessment.</p>
<p>To look at another endpoint, let us look at the covariance matrix for glycated hemoglobin A1c (HbA1c) trial in diabetes patients used in <a href="https://doi.org/10.1002/pst.1705">Holzhauer et al.&nbsp;2015</a>. Many patterns seem similar to FPG, but the correlation of adjacent visits is higher, which makes sense, because HbA1c is less subject to day-to-day variations than FPG.</p>
</section>
</section>
<section id="implementation" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="implementation"><span class="header-section-number">13.4</span> Implementation</h2>
<section id="reference-implementations-using-sas-and-lme4" class="level3" data-number="13.4.1">
<h3 data-number="13.4.1" class="anchored" data-anchor-id="reference-implementations-using-sas-and-lme4"><span class="header-section-number">13.4.1</span> Reference implementations using SAS and <code>lme4</code></h3>
<p>Within a frequentist framework, this model is usually estimated using Restricted Maximum Likelihood Estimation (REML). One popular way of fitting such a model is using SAS code similar to the following</p>
<div class="cell">
<pre class="sas cell-code"><code>PROC MIXED DATA=simulated_data;
  CLASS TRT01P AVISIT USUBJID;
  MODEL CHG ~ TRT01P AVISIT BASE TRT01P*AVISIT AVISIT*BASE 
    / SOLUTION DDFM=KR ALPHA = 0.05;
  REPEATED AVISIT / TYPE=UN SUBJECT = USUBJID R Rcorr GROUP=TRT01P;
  LSMEANS TRT01P*AVISIT / DIFFS PDIFF CL OM E;
RUN;</code></pre>
</div>
<p>Note that <code>GROUP=TRT01P</code> in the <code>REPEATED</code> statement specifies different covariance structures for each treatment groups. Importantly, <code>DDFM=KR</code> refers to using the method of <a href="https://doi.org/10.2307/2533558">Kenward and Roger</a> for figuring out what degrees of freedom to use for inference with Student-t-distributions (or in other words to figure out how many independent observations the correlated observations across all our subjects are worth).</p>
<p>Additionally the <code>OM</code> option to the <code>LSMEANS</code> statement requests the by-treatment-group least squares means for each visit to be calculated for predicted population margins for the observed covariate distribution in the analysis dataset. On this occasion, it does not make a difference, because there are no categorical covariates in the model.</p>
<p>In <code>R</code> we can obtain a very similar frequentist fit for this model using the <code>lme4</code> package using the following <code>R</code> code as explained in a <a href="https://rinpharma.com/publication/rinpharma_143/">R/PHARMA presentation on implementing MMRM in R by Daniel Sabanés Bové</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lmer</span>(<span class="at">data=</span>simulated_data,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>     CHG <span class="sc">~</span> TRT01P <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> AVISIT<span class="sc">*</span>TRT01P <span class="sc">+</span> AVISIT<span class="sc">*</span>BASE <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> AVISIT <span class="sc">|</span> USUBJID),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">check.nobs.vs.nRE =</span> <span class="st">"ignore"</span>, <span class="at">optimizer=</span><span class="st">"nlminbwrap"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, : unable to evaluate scaled gradient</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, : Model failed to converge: degenerate
Hessian with 1 negative eigenvalues</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: CHG ~ TRT01P + AVISIT + BASE + AVISIT * TRT01P + AVISIT * BASE +      (0 + AVISIT | USUBJID)
   Data: simulated_data
Control: lmerControl(check.nobs.vs.nRE = "ignore", optimizer = "nlminbwrap")

REML criterion at convergence: 1395.5

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.24192 -0.47675  0.03313  0.46123  2.44773 

Random effects:
 Groups   Name         Variance Std.Dev. Corr          
 USUBJID  AVISITvisit1 0.2579   0.5078                 
          AVISITvisit2 0.3245   0.5696   0.81          
          AVISITvisit3 0.4164   0.6453   0.38 0.54     
          AVISITvisit4 0.4006   0.6330   0.14 0.28 0.54
 Residual              0.2160   0.4648                 
Number of obs: 642, groups:  USUBJID, 200

Fixed effects:
                       Estimate Std. Error t value
(Intercept)            0.229628   0.125697   1.827
TRT01P10               0.201567   0.138117   1.459
TRT01P20               0.006226   0.142031   0.044
TRT01P40               0.009128   0.138792   0.066
AVISITvisit2          -0.175310   0.150805  -1.162
AVISITvisit3          -0.154552   0.194497  -0.795
AVISITvisit4           0.024264   0.207454   0.117
BASE                  -0.545770   0.089637  -6.089
TRT01P10:AVISITvisit2  0.059005   0.165522   0.356
TRT01P20:AVISITvisit2  0.261248   0.169807   1.538
TRT01P40:AVISITvisit2  0.139579   0.163295   0.855
TRT01P10:AVISITvisit3 -0.022261   0.215628  -0.103
TRT01P20:AVISITvisit3  0.241052   0.219378   1.099
TRT01P40:AVISITvisit3  0.445949   0.216933   2.056
TRT01P10:AVISITvisit4  0.089138   0.229898   0.388
TRT01P20:AVISITvisit4  0.159741   0.234049   0.683
TRT01P40:AVISITvisit4  0.395449   0.231450   1.709
AVISITvisit2:BASE     -0.016562   0.108401  -0.153
AVISITvisit3:BASE     -0.062741   0.144859  -0.433
AVISITvisit4:BASE     -0.137304   0.154126  -0.891</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Correlation matrix not shown by default, as p = 20 &gt; 12.
Use print(x, correlation=TRUE)  or
    vcov(x)        if you need it</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>optimizer (nlminbwrap) convergence code: 0 (OK)
unable to evaluate scaled gradient
Model failed to converge: degenerate  Hessian with 1 negative eigenvalues</code></pre>
</div>
</div>
<p>Note that the choice of the particular optimizer via <code>control = lmerControl(optimizer="nlminbwrap")</code> was chosen based on trying different ones to resolve convergence warnings. Moreover, problems were found out later with the <code>lme4</code> package, which does not allow the fitting of MMRM with many visits, as it can easily lead to very long computation times and low convergence rates. Hence, prototyping of the dedicated <a href="https://cran.r-project.org/package=mmrm"><code>mmrm</code> <code>R</code> package</a> was initiated originall by Daniel Sabanés Bové. The package was then quickly adopted as the first open source project of the <a href="https://openstatsware.org"><code>openstatsware</code></a> group. The <code>mmrm</code> package is a completely new implementation of the MMRM, and implements the log-likelihood function in C++ with the help of the <a href="(https://cran.r-project.org/package=TMB)"><code>TMB</code> package</a>, which enables to use gradient information through the use of automatic differentiation. It is similar with regards to the architecture to the <a href="https://cran.r-project.org/package=glmmTMB"><code>glmmTMB</code> package</a>, but it provides the important Satterthwaite and Kenward-Roger degrees of freedom methods. More details are available e.g.&nbsp;in the <a href="https://rinpharma.com/publication/rinpharma_327/">R/Pharma workshop by Daniel and Doug Kelkhoff</a>.</p>
<p>For this reason the <code>mmrm</code> package is preferable and its usage is demonstrated below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mmrm_fit <span class="ot">&lt;-</span> <span class="fu">mmrm</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> CHG <span class="sc">~</span> TRT01P <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>BASE <span class="sc">+</span> <span class="fu">us</span>(AVISIT <span class="sc">|</span> USUBJID),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">USUBJID=</span><span class="fu">factor</span>(USUBJID)))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># reml=TRUE default option used (not specifically requested)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g. cs(AVISIT | USUBJID) would request compound-symmetric covariance</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   structure instead of unstructed ("us")</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># us(AVISIT | TRT01P / USUBJID) would request separate covariance matrices</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   for each treatment gorup</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>While we can of course summarize the model fit and regression coefficients via <code>summary(mmrm_fit)</code>, this is often not the main output we are interested in. Instead, we often want for each visit the treatment differences or least-squares means by treatment group. For a MMRM this involves linear combinations of regression coefficients, potentially weighted according to the distribution of (categorical baseline covariates). One very convenient way of obtaining these inferences is with the <code>emmeans</code> R package, which we can use with many different types of models including <code>brms</code> models. To obtain LS-means by visit for each treatment group, we use the <code>emmeans</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>emm1 <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(mmrm_fit, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">lmer.df=</span><span class="st">"kenward-roger"</span>, <span class="at">weights =</span> <span class="st">"proportional"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(emm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AVISIT = visit1:
 TRT01P  emmean     SE  df lower.CL upper.CL
 0      -0.1698 0.1010 195  -0.3688  0.02919
 10      0.0317 0.0946 195  -0.1548  0.21831
 20     -0.1636 0.1010 195  -0.3622  0.03498
 40     -0.1607 0.0947 195  -0.3475  0.02610

AVISIT = visit2:
 TRT01P  emmean     SE  df lower.CL upper.CL
 0      -0.3573 0.1230 172  -0.5992 -0.11531
 10     -0.0967 0.1100 169  -0.3138  0.12043
 20     -0.0898 0.1170 169  -0.3213  0.14173
 40     -0.2085 0.1060 165  -0.4183  0.00124

AVISIT = visit3:
 TRT01P  emmean     SE  df lower.CL upper.CL
 0      -0.3703 0.1450 141  -0.6579 -0.08273
 10     -0.1910 0.1280 140  -0.4435  0.06155
 20     -0.1230 0.1320 138  -0.3840  0.13792
 40      0.0848 0.1300 141  -0.1714  0.34098

AVISIT = visit4:
 TRT01P  emmean     SE  df lower.CL upper.CL
 0      -0.2461 0.1450 136  -0.5336  0.04147
 10      0.0447 0.1270 136  -0.2071  0.29643
 20     -0.0801 0.1310 136  -0.3395  0.17934
 40      0.1585 0.1300 136  -0.0977  0.41476

Confidence level used: 0.95 </code></pre>
</div>
</div>
<p>To get the implied contrasts for each dose compared with the control we use the <code>contrast</code> function`:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>contrasts1 <span class="ot">&lt;-</span> <span class="fu">contrast</span>(emm1, <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>, <span class="at">ref=</span><span class="dv">1</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(contrasts1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AVISIT = visit1:
 contrast           estimate    SE  df t.ratio p.value
 TRT01P10 - TRT01P0  0.20157 0.138 195   1.459  0.1461
 TRT01P20 - TRT01P0  0.00623 0.142 195   0.044  0.9651
 TRT01P40 - TRT01P0  0.00913 0.139 195   0.066  0.9476

AVISIT = visit2:
 contrast           estimate    SE  df t.ratio p.value
 TRT01P10 - TRT01P0  0.26057 0.165 171   1.580  0.1159
 TRT01P20 - TRT01P0  0.26747 0.169 170   1.581  0.1156
 TRT01P40 - TRT01P0  0.14871 0.163 169   0.914  0.3618

AVISIT = visit3:
 contrast           estimate    SE  df t.ratio p.value
 TRT01P10 - TRT01P0  0.17931 0.194 140   0.926  0.3558
 TRT01P20 - TRT01P0  0.24728 0.196 140   1.259  0.2101
 TRT01P40 - TRT01P0  0.45508 0.195 141   2.336  0.0209

AVISIT = visit4:
 contrast           estimate    SE  df t.ratio p.value
 TRT01P10 - TRT01P0  0.29071 0.193 136   1.505  0.1348
 TRT01P20 - TRT01P0  0.16597 0.196 136   0.847  0.3983
 TRT01P40 - TRT01P0  0.40458 0.195 136   2.078  0.0396</code></pre>
</div>
</div>
<p>The pairwise comparisons showing nominal p-values only (due to <code>adjust="none"</code>), but we could request e.g.&nbsp;<code>adjust="bonferroni"</code> instead. When we specified <code>method="trt.vs.ctrl"</code>, we told the <code>contrast</code> function to use the first group as the control group by specifying its index via <code>ref=1</code>. Alternatively, we could have asked for all possible pairwise contrasts via <code>contrast(..., method="pairwise")</code> (or <code>pairs(...)</code>).</p>
<p>Sometimes, we may want to average the treatment effects across weeks 8 and 12. E.g. if we are very sure that (almost) the full treatment effect will have set in by week 8. When doing so, it is useful to fit a model that estimates separate treatment effects for both visits and then to average them. In contrast to averaging outcomes across visits for individual patients first, this approach more coherently deals with missing data, intercurrent events and differing effects of covariates. <code>emmeans</code> also allows us to do that, we just need to specify our contrasts slightly more manually. Note that in this case we need to know the ordering of estimates in the output of the <code>emmeans()</code> function in order to specify the contrasts:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>emm1a <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(mmrm_fit, <span class="sc">~</span> TRT01P<span class="sc">:</span>AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(emm1a, </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">method=</span><span class="fu">list</span>(<span class="st">"40 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"20 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dv">0</span>),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"10 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>)),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">adjust=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> contrast      estimate    SE  df t.ratio p.value
 40 vs Placebo    0.430 0.160 140   2.690  0.0080
 20 vs Placebo    0.207 0.161 139   1.283  0.2016
 10 vs Placebo    0.235 0.159 139   1.480  0.1410</code></pre>
</div>
</div>
<p>With the release of <code>brms</code> 2.19.0 in March 2023 it became possible to fit equivalent models easily based on a Bayesian implementation of a MMRM with an unstructured covariance matrix as shown below.</p>
</section>
<section id="brms-implementation" class="level3" data-number="13.4.2">
<h3 data-number="13.4.2" class="anchored" data-anchor-id="brms-implementation"><span class="header-section-number">13.4.2</span> <code>brms</code> implementation</h3>
<p>The code below shows how we specify a MMRM model in a very similar way to <code>SAS</code> and the <code>lme4</code> approach.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup forward difference contrasts for changes between visits</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(simulated_data<span class="sc">$</span>AVISIT) <span class="ot">&lt;-</span> MASS<span class="sc">::</span>contr.sdif</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>mmrm_model1 <span class="ot">&lt;-</span> <span class="fu">bf</span>(CHG <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> TRT01P<span class="sc">:</span>AVISIT,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">autocor =</span> <span class="sc">~</span><span class="fu">unstr</span>(<span class="at">time=</span>AVISIT, <span class="at">gr=</span>USUBJID),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                  sigma <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># If we manually specify priors by providing out own Stan code via the stanvars </span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># option, we may want to use `center=FALSE` in `bf()`, otherwise not.</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Explicitly specifying quite weak priors (given the variability in the data).</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># These priors are set considering that unity is assumed to be the</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co"># sampling standard deviation and that the outcome data is scaled such that</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># unity is a considerable change.</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>mmrm_prior1 <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>Intercept) <span class="sc">+</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class=</span>b) <span class="sc">+</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">10.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>Intercept, <span class="at">dpar=</span>sigma) <span class="sc">+</span> <span class="co"># 90% CrI spans 1/10 - 10</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,  <span class="fu">log</span>(<span class="fl">2.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>b, <span class="at">dpar=</span>sigma) <span class="sc">+</span>         <span class="co"># 90% CrI spans  1/2 - 2x</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">lkj_corr_cholesky</span>(<span class="dv">1</span>), <span class="at">class=</span><span class="st">"Lcortime"</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>brmfit1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula=</span>mmrm_model1,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior=</span> mmrm_prior1,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> simulated_data,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed=</span><span class="dv">234235</span>,</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> control_args,</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>brmfit1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that instead of writing <code>(0 + AVISIT | USUBJID)</code> like in the <code>lme4</code> code, the <code>brms</code> syntax resembles the <code>mmrm</code> package syntax. We specify an unstructured correlation structure over time for groups of observations (here with the same unique patient identifier <code>USUBJID</code>) using <code>autocor=~unstr(time=AVISIT, gr=USUBJID)</code>.</p>
<div class="alert alert-info">
<p>Note that using <code>(0 + AVISIT | USUBJID)</code> as in the <code>lme4</code> turns out to not work well with <code>brms</code>. While conceptually this implies the correct correlation structure via an unstructured random effect, the model becomes overparametrized due to the residual error and random effect standard deviations becoming non-identifiable. Trying to avoid this e.g.&nbsp;by setting the uncorrelated residual standard deviation to a fixed value that is small relative to the total variability (e.g.&nbsp;<code>prior(constant(0.1), sigma)</code>) still results in very poor sampling of the posterior distribution (high Rhat values and very low effective sample size for the MCMC samples). The approach implemented by the <code>unstr</code> syntax uses instead a marginal approach avoiding the non-identifability of the conditional approach.</p>
</div>
<p>The model formula above specifies that the correlation structure is the same across all treatment groups. This is not an assumption we have to make and SAS provides the <code>GROUP=TRT01P</code> option in the <code>REPEATED</code> statement to avoid it. Similarly, the <code>mmrm</code> package allows the user to specify group specific covariance parameter estimates using the <code>us(AVISIT | TRT01P / USUBJID)</code> syntax (so “group / subject” on the right hand side, see <a href="https://openpharma.github.io/mmrm/latest-tag/articles/introduction.html#grouped-covariance-structure">here</a> for details). On the other hand, the <code>brms</code> and <code>lme4</code> packages do not have an option for allowing separate unstructed covariance matrices for the different treatment groups. However, <code>brms</code> offers more flexibility than the other two packages regarding the variation at different visits and treatment groups through “distributional regression” (i.e.&nbsp;we can specify a regression model for parameters of the distribution other than the location, in this case <code>sigma</code>).</p>
<div class="alert alert-info">
<p>If we just wanted a compound symmetric correlation matrix, we would just use <code>(1 | USUBJID)</code>, because a simple random effect on the intercept induces an equal correlation between all visits.</p>
</div>
<p>By writing <code>sigma ~ 1 + AVISIT + TRT01P + AVISIT:TRT01P</code> we specify that we want heterogeneous standard deviations over time that may differ by treatment group (note that <code>brms</code> models the standard deviation rather than the variance), which we would typically assume. If we instead wanted to assume the same variance at each visit, we would simply omit this option. Note that while we did not specify it explicitly, we are using a <span class="math inline">\(\log\)</span>-link function for <code>sigma</code> so that a regression coefficient of <span class="math inline">\(0.69\)</span> approximately corresponds to a doubling of the standard deviation. The user can explicitly define the link using the <code>family</code> argument of <code>bf</code> and set <code>family=gaussian(link_sigma="log")</code> (or use other links if desired). Thus, if we wanted to set prior distributions for the treatment and the visit-by-treatment interaction terms, even a <code>normal(0, 1)</code> prior already allows for considerable a-priori variation in <code>sigma</code> between treatment groups and visits. A useful way for specifying a prior on a <code>log</code> scale is by defining the standard deviation of a normal distribution to be equal to <span class="math inline">\(\log(s)/\Phi^{-1}(1/2+c/2)\)</span>, which implies that the central credible interval <span class="math inline">\(c\)</span> spans the range <span class="math inline">\(1/s - s\)</span>, i.e.&nbsp;<span class="math inline">\(\log(2)/1.64\)</span> corresponds to the central 90% credible interval ranging from 1/2x to 2x around the mean. <!-- However, we could also --> <!-- specify `sigma ~ 1 + AVISIT + TRTO1P + AVISIT:TRTO1P` to allow the --> <!-- covariance matrices to differ by treatment group (although the --> <!-- correlation matrix would still be assumed identical).  --></p>
<p>As for the <code>mmrm</code> package, we can also easily obtain the equivalent of least-squares means with highest-posterior density (HPD) credible intervals for each treatment group by visit using <code>emmeans</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>emm2 <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(brmfit1, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>emm2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AVISIT = visit1:
 TRT01P  emmean lower.HPD upper.HPD
 0      -0.1693    -0.394   0.03287
 10      0.0325    -0.155   0.21754
 20     -0.1629    -0.374   0.03080
 40     -0.1612    -0.323   0.02130

AVISIT = visit2:
 TRT01P  emmean lower.HPD upper.HPD
 0      -0.3556    -0.609  -0.11081
 10     -0.1012    -0.312   0.10257
 20     -0.0958    -0.327   0.12729
 40     -0.2103    -0.419   0.00942

AVISIT = visit3:
 TRT01P  emmean lower.HPD upper.HPD
 0      -0.3590    -0.659  -0.08280
 10     -0.1940    -0.434   0.07200
 20     -0.1369    -0.359   0.10129
 40      0.0708    -0.185   0.35341

AVISIT = visit4:
 TRT01P  emmean lower.HPD upper.HPD
 0      -0.2352    -0.559   0.04403
 10      0.0439    -0.194   0.28888
 20     -0.0780    -0.345   0.18472
 40      0.1499    -0.104   0.40637

Point estimate displayed: median 
HPD interval probability: 0.95 </code></pre>
</div>
</div>
<p>We can also get the pairwise treatment comparisons with HPD credible intervals in this manner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(emm2, <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AVISIT = visit1:
 contrast           estimate lower.HPD upper.HPD
 TRT01P10 - TRT01P0  0.20257  -0.08675     0.478
 TRT01P20 - TRT01P0  0.00996  -0.27573     0.305
 TRT01P40 - TRT01P0  0.01206  -0.25292     0.282

AVISIT = visit2:
 contrast           estimate lower.HPD upper.HPD
 TRT01P10 - TRT01P0  0.25586  -0.05846     0.578
 TRT01P20 - TRT01P0  0.26398  -0.08595     0.571
 TRT01P40 - TRT01P0  0.14628  -0.16936     0.480

AVISIT = visit3:
 contrast           estimate lower.HPD upper.HPD
 TRT01P10 - TRT01P0  0.16472  -0.21193     0.560
 TRT01P20 - TRT01P0  0.22359  -0.13535     0.587
 TRT01P40 - TRT01P0  0.43080   0.06435     0.829

AVISIT = visit4:
 contrast           estimate lower.HPD upper.HPD
 TRT01P10 - TRT01P0  0.27908  -0.09807     0.669
 TRT01P20 - TRT01P0  0.15543  -0.25946     0.556
 TRT01P40 - TRT01P0  0.39095  -0.00921     0.775

Point estimate displayed: median 
HPD interval probability: 0.95 </code></pre>
</div>
</div>
<!-- # Commented this out, as it's unncecessary confusion -->
<!-- contrast(emm2, adjust="none", method="trt.vs.ctrl", frequentist=TRUE) # or pairs(emm2) -->
<!-- confint(emm2, adjust="none", method="trt.vs.ctrl",  ref="TRT01P0", frequentist=TRUE) # or pairs(emm2) -->
<p>HPD and quantile based credible intervals may differ whenever the posterior is heavily skewed or not unimodal. The quantile based credible intervals are numerically simpler in their definition and can be estimated more robustly estimated via MCMC. Furthermore, the quantiles of a distribution are transformation invariant, whereas HPD intervals are not transformation invariant (this of interest for the case of generalized models with non-linear link functions). <code>emmeans</code> can report summaries (using the <code>frequentist=TRUE</code> option) based on a normal approximation resembling the frequentist estimate plus standard error approach.</p>
<p>While the default HPD intervals reported from <code>emmeans</code> are a useful summary of the positerior, the respective quantile summaries can also be extracted by first converting with the <code>as.mcmc</code> conversion function the <code>emmeans</code> results into the respective posterior MCMC sample. This sample one can then conveniently summarized by using utilities from the <code>posterior</code> package:</p>
<!-- SW: drop this??
We can instead obtain quantile based credible intervals using the 
`hypothesis` function provided by `brms` e.g. via 
`hypothesis(brmfit1, "TRT01P10 + `AVISIT4:TRT01P10`", alpha = 0.025, robust=T)`, 
but this is somewhat more complex. Many model plus prior distribution plus data 
combinations result in nicely behaved symmetric and unimodal posterior 
distributions. We would expect this to be usually the case for MMRM analyses,
in which case the convenience of `emmeans` trumps other considerations.
</div>
-->
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>mc.emm2 <span class="ot">&lt;-</span> <span class="fu">as.mcmc</span>(emm2)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise_draws</span>(mc.emm2, <span class="fu">default_summary_measures</span>()) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 7
   variable                   mean  median     sd    mad      q5      q95
   &lt;chr&gt;                     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
 1 TRT01P 0 AVISIT visit1  -0.171  -0.169  0.109  0.107  -0.351   0.00524
 2 TRT01P 10 AVISIT visit1  0.0315  0.0325 0.0952 0.0930 -0.125   0.189  
 3 TRT01P 20 AVISIT visit1 -0.162  -0.163  0.103  0.102  -0.329   0.00510
 4 TRT01P 40 AVISIT visit1 -0.161  -0.161  0.0879 0.0862 -0.303  -0.0170 
 5 TRT01P 0 AVISIT visit2  -0.355  -0.356  0.128  0.125  -0.557  -0.143  
 6 TRT01P 10 AVISIT visit2 -0.101  -0.101  0.107  0.105  -0.275   0.0734 
 7 TRT01P 20 AVISIT visit2 -0.0977 -0.0958 0.116  0.114  -0.292   0.0889 
 8 TRT01P 40 AVISIT visit2 -0.210  -0.210  0.110  0.110  -0.389  -0.0317 
 9 TRT01P 0 AVISIT visit3  -0.361  -0.359  0.147  0.143  -0.606  -0.117  
10 TRT01P 10 AVISIT visit3 -0.192  -0.194  0.131  0.130  -0.403   0.0245 
11 TRT01P 20 AVISIT visit3 -0.136  -0.137  0.117  0.115  -0.329   0.0620 
12 TRT01P 40 AVISIT visit3  0.0720  0.0708 0.139  0.138  -0.154   0.301  
13 TRT01P 0 AVISIT visit4  -0.238  -0.235  0.157  0.154  -0.501   0.0166 
14 TRT01P 10 AVISIT visit4  0.0440  0.0439 0.125  0.125  -0.163   0.242  
15 TRT01P 20 AVISIT visit4 -0.0802 -0.0780 0.138  0.140  -0.308   0.142  
16 TRT01P 40 AVISIT visit4  0.152   0.150  0.132  0.132  -0.0651  0.371  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>mc.contrast.emm2 <span class="ot">&lt;-</span> <span class="fu">as.mcmc</span>(<span class="fu">contrast</span>(emm2, <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise_draws</span>(mc.contrast.emm2, <span class="fu">default_summary_measures</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 7
   variable                                     mean  median    sd   mad      q5   q95
   &lt;chr&gt;                                       &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
 1 contrast TRT01P10 - TRT01P0 AVISIT visit1 0.202   0.203   0.143 0.137 -0.0371 0.438
 2 contrast TRT01P20 - TRT01P0 AVISIT visit1 0.00940 0.00996 0.150 0.147 -0.240  0.248
 3 contrast TRT01P40 - TRT01P0 AVISIT visit1 0.00992 0.0121  0.138 0.134 -0.219  0.240
 4 contrast TRT01P10 - TRT01P0 AVISIT visit2 0.254   0.256   0.164 0.163 -0.0217 0.519
 5 contrast TRT01P20 - TRT01P0 AVISIT visit2 0.257   0.264   0.169 0.169 -0.0277 0.526
 6 contrast TRT01P40 - TRT01P0 AVISIT visit2 0.145   0.146   0.167 0.161 -0.128  0.418
 7 contrast TRT01P10 - TRT01P0 AVISIT visit3 0.169   0.165   0.196 0.191 -0.147  0.497
 8 contrast TRT01P20 - TRT01P0 AVISIT visit3 0.225   0.224   0.184 0.184 -0.0827 0.534
 9 contrast TRT01P40 - TRT01P0 AVISIT visit3 0.433   0.431   0.199 0.201  0.118  0.759
10 contrast TRT01P10 - TRT01P0 AVISIT visit4 0.282   0.279   0.198 0.199 -0.0486 0.617
11 contrast TRT01P20 - TRT01P0 AVISIT visit4 0.157   0.155   0.209 0.207 -0.190  0.508
12 contrast TRT01P40 - TRT01P0 AVISIT visit4 0.389   0.391   0.203 0.200  0.0462 0.719</code></pre>
</div>
</div>
<!-- However, we do not have to use the `emmeans` package, because `brms` also  -->
<!-- provides the quite general `hypothesis` function. -->
<!-- <!--- as discussed, the hypothesis facility is not appropiate when using the custom contrasts as it is deeply tied to transforming parameters, but this neglects the usual standardisation --->
<!-- ```{r} -->
<!-- contrasts_of_interest <- c("TRT01P10", "TRT01P20", "TRT01P40", -->
<!--                            "TRT01P10 + `AVISIT2:TRT01P10`",  -->
<!--                            "TRT01P20 + `AVISIT2:TRT01P20`",  -->
<!--                            "TRT01P40 + `AVISIT2:TRT01P40`",  -->
<!--                            "TRT01P10 + `AVISIT3:TRT01P10`", -->
<!--                            "TRT01P20 + `AVISIT3:TRT01P20`", -->
<!--                            "TRT01P40 + `AVISIT3:TRT01P40`", -->
<!--                            "TRT01P10 + `AVISIT4:TRT01P10`", -->
<!--                            "TRT01P20 + `AVISIT4:TRT01P20`", -->
<!--                            "TRT01P40 + `AVISIT4:TRT01P40`") %>% -->
<!--     paste0(" < 0") -->
<!-- contrasts_of_interest <- contrasts_of_interest[1:3] -->
<!-- hh <- hypothesis(brmfit1, contrasts_of_interest, alpha = 0.025, robust=T)$hypothesis -->
<!-- knitr::kable(hh, digits=2) -->
<!-- ``` -->
<!-- As we can notice, the point estimates are the same as when using -->
<!-- `emmeans`, but there's some very small numerical differences with the  -->
<!-- credible interval limits despite both basing inference on the same  -->
<!-- MCMC samples (although these differences are smaller than the MCMC  -->
<!-- sampling variability you might get with 4000 MCMC samples). -->
<!-- This is due to `emmeans` using highest-posterior density (HPD)  -->
<!-- credible intervals and `hypothesis` using quantile based credible -->
<!-- intervals.  -->
<!-- <div class="alert alert-info"> HPD and quantile based credible -->
<!-- intervals may differ whenever the posterior is heavily skewed or not unimodal.  -->
<!-- The quantile based credible intervals are numerically simpler in  -->
<!-- their definition and can be estimated more robustly estimated via -->
<!-- MCMC. Furthermore, the quantiles of a distribution are transformation -->
<!-- invariant, whereas HPD intervals are not transformation invariant -->
<!-- (this of interest for the case of generalized models with non-linear -->
<!-- link functions). -->
<!-- However, many model plus prior distribution plus data combinations result in  -->
<!-- nicely behaved symmetric and unimodal posterior distributions. In those cases  -->
<!-- HPD intervals will be fine and the convenience of `emmeans` might be the -->
<!-- deciding factor for the approach you choose. Moreover, `emmeans` can  report  -->
<!-- summaries (using the `frequentist=TRUE` option) based on a normal approximation  -->
<!-- resembling the frequentist estimate plus standard error approach. -->
<!-- </div> -->
<p>As with a model fit using the <code>mmrm</code> package, we can also obtain inference about the average treatment effect across weeks 8 and 12 using the <code>emmeans</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>emm2a <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(brmfit1, <span class="sc">~</span> TRT01P<span class="sc">:</span>AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(emm2a, </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">method=</span><span class="fu">list</span>(<span class="st">"40 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"20 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dv">0</span>),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"10 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> contrast      estimate lower.HPD upper.HPD
 40 vs Placebo    0.411    0.0766     0.722
 20 vs Placebo    0.191   -0.1337     0.496
 10 vs Placebo    0.227   -0.0871     0.551

Point estimate displayed: median 
HPD interval probability: 0.95 </code></pre>
</div>
</div>
<!-- We can also, again, use the `brms::hypothesis()` function, for example like this: -->
<!-- ```{r, eval=FALSE} -->
<!-- hypothesis(brmfit1,  -->
<!--            c("(TRT01P40 + `AVISIT3:TRT01P40` + TRT01P40 + `AVISIT4:TRT01P40`)*0.5 <0", -->
<!--              "(TRT01P20 + `AVISIT3:TRT01P20` + TRT01P20 + `AVISIT4:TRT01P20`)*0.5 <0", -->
<!--              "(TRT01P10 + `AVISIT3:TRT01P10` + TRT01P10 + `AVISIT4:TRT01P10`)*0.5 <0"), -->
<!--            alpha = 0.025, robust=T) -->
<!-- ``` -->
</section>
<section id="model-parameterization-and-the-importance-of-at-least-weak-priors" class="level3" data-number="13.4.3">
<h3 data-number="13.4.3" class="anchored" data-anchor-id="model-parameterization-and-the-importance-of-at-least-weak-priors"><span class="header-section-number">13.4.3</span> Model parameterization and the importance of (at least weak) priors</h3>
<p>Here, we explicitly specified a proper prior distribution (but very weak) for each regression coefficient. This is important, because by default <code>brms</code> would only have put a prior distribution on intercept terms. If we instead assume improper flat prior distributions, we often run into issues with sampling from the model. Weakly informative priors ensure stable sampling while not influencing the posterior distribution in relevant ways. One common approach to define a weakly informative prior is by way of identifying the scale of the parameter in question, e.g.&nbsp;parameters on a logarithmic scale commonly do not vary over many magnitudes or a parameter on a logistic scale varies within <span class="math inline">\(-3\)</span> to <span class="math inline">\(3\)</span> provided that the effects are not extreme.</p>
<p>In which way we are comfortable to specify prior distributions may in part determine how we parameterize the model:</p>
<ul>
<li>We chose to setup forward difference contrasts for changes between visits when specifying <code>contrasts(simulated_data$AVISIT) &lt;- MASS::contr.sdif</code> in combination with <code>CHG ~ 1 + AVISIT + BASE + BASE:AVISIT + TRT01P + TRT01P:AVISIT</code>. I.e. the intercept term will refer to the expected change from baseline averaged across all visits, while there will be regression coefficients for the expected difference from visit 1 to 2, 2 to 3 and 3 to 4. We can check this using <code>solve(cbind(1, contrasts(simulated_data$AVISIT)))</code>.</li>
<li>Not only does it seem reasonable to specify prior information about such parameters, but this also induces a reasonable correlation between our prior beliefs for each visit. I.e. if values at one visit are higher, we would expect values at the surrounding visits to also be higher. This is illustrated by the very typical pattern seen in the weight loss over time in the EQUIP study <span class="citation" data-cites="allison2012equip">(<a href="02l_single_arm_pos.html#ref-allison2012equip" role="doc-biblioref">Allison et al. 2012</a>)</span> shown in the figure below. As is typical for clinical trial data, there are only small visit-to-visit changes in the mean outcome, which can be nicely represented by forward difference contrasts. Furthermore, also note that the forward differences parametrization does imply a correlation structure which resembles the fact that we observe patient longitudinally accross the subsequent visits.</li>
<li>If we had specified the same model code without setting up forward difference contrasts, the intercept would have stood for the expected change from baseline at the reference visit (by default visit 1), while the regression coefficients would have represented the difference in the expected change at all the remaining visits compared with the reference visit 1.</li>
<li>Alternatively, we could have chosen the parameterization <code>0 + AVISIT + BASE + BASE:AVISIT + TRT01P + TRT01P:AVISIT</code> as our main approach. In this cell means parametrization, we would need to provide prior distributions for each visit.</li>
<li>If we make the priors for each visit independent in the latter approach, the prior distribution will specify plausible values for the mean outcome at that visit, but will suggest that all sizes of visit-to-visit changes that keep values within the range of a-priori plausible values are equally plausible. This is typically not the case.</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Change in body weight over time in the EQUIP study (data digitized from published figure)</figcaption>
</figure>
</div>
</div>
</div>
<p>With very vague priors the differences between these approach will usually be negligible. If we are interested in specifying weakly informative or even informative prior distributions, one should choose the paramterization, in which it is easiest to express the available prior information. Other ways to set-up contrasts are illustrated in the case study on <a href="02i_time_to_event.html">time-to-event data</a>.</p>
<!-- <div class="alert alert-info"> -->
<!-- Note that writing `1 + AVISIT + BASE + BASE:AVISIT + TRT01P + TRT01P:AVISIT`  -->
<!-- specifies an equivalent model that is parameterized with an intercept included. -->
<!-- As a result, it becomes hard to specify exactly the same prior as we used above. -->
<!-- For example, additionally specifying  -->
<!-- `prior(class="Intercept", normal(0, 5)` would not achieve that, -->
<!-- because the visit effect for the second to fourth visit are in this  -->
<!-- parameterization the sum of the intercept and the term specific to those visits. -->
<!-- However, with very weak priors the differences might be negligible. -->
<!-- </div> -->
<!-- <div class="alert alert-info"> -->
<!-- Note that contrasts can be setup differently (e.g. sum-to-zero contrast for -->
<!-- the visits) in the way that is the most natural to work with for a particular -->
<!-- case. This is illustrated in the case study on time-to-event data. -->
<!-- </div> -->
</section>
<section id="meta-analytic-combined-mac-approach-to-historical-data-for-mmrms" class="level3" data-number="13.4.4">
<h3 data-number="13.4.4" class="anchored" data-anchor-id="meta-analytic-combined-mac-approach-to-historical-data-for-mmrms"><span class="header-section-number">13.4.4</span> Meta-analytic combined (MAC) approach to historical data for MMRMs</h3>
<div class="alert alert-info">
<p><strong>WARNING</strong>: There is very limited experience with a MAC approach for MMRMs and intuitions from MAC/MAP for a single control group parameter may not apply to high-dimensional settings, where many parameters are assumed to be exchangeable between studies.</p>
</div>
<p>One source of informative prior distributions is historical data. Let us assume that we have access to the individual patient data for the placebo groups of 10 historical studies.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3547844</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>N_studies_hist <span class="ot">&lt;-</span> <span class="dv">10</span>L</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>Nf_hist <span class="ot">&lt;-</span> <span class="dv">500</span>L</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(use_small_N) {</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    Nf_hist <span class="ot">&lt;-</span> <span class="dv">50</span>L</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>Nf_per_study_hist <span class="ot">&lt;-</span> Nf_hist<span class="sc">/</span>N_studies_hist</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>historical_studies <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="at">n=</span><span class="dv">10</span> <span class="sc">*</span> Nf_hist,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mean =</span> zero,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sigma =</span> cov_matrix) <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BASE<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">&lt;=</span>Nf_hist) <span class="sc">%&gt;%</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">STUDYID =</span> <span class="fu">rep</span>(<span class="dv">1</span>L<span class="sc">:</span>N_studies_hist, <span class="at">each=</span>Nf_per_study_hist ), <span class="co"># Create a study ID</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Add a random study effect</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">rseff =</span> <span class="fu">rep</span>(<span class="fu">rnorm</span>(<span class="at">n=</span>N_studies_hist, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span><span class="fl">0.1</span>), <span class="at">each=</span>Nf_per_study_hist),</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">USUBJID =</span> <span class="fu">row_number</span>(),</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">TRT01P=</span><span class="fu">factor</span>(<span class="dv">0</span>, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">40</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">starts_with</span>(<span class="st">"visit"</span>), <span class="at">names_to =</span> <span class="st">"AVISIT"</span>, <span class="at">values_to=</span><span class="st">"AVAL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">AVAL =</span> AVAL <span class="sc">+</span> rseff,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">ADY =</span> <span class="fu">case_when</span>(AVISIT<span class="sc">==</span><span class="st">"visit1"</span> <span class="sc">~</span> <span class="dv">2</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>                    AVISIT<span class="sc">==</span><span class="st">"visit2"</span> <span class="sc">~</span> <span class="dv">4</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>                    AVISIT<span class="sc">==</span><span class="st">"visit3"</span> <span class="sc">~</span> <span class="dv">8</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>                    AVISIT<span class="sc">==</span><span class="st">"visit4"</span> <span class="sc">~</span> <span class="dv">12</span>L<span class="sc">*</span><span class="dv">7</span>L),</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">AVISIT =</span> <span class="fu">factor</span>(AVISIT, <span class="fu">paste0</span>(<span class="st">"visit"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">CHG =</span> AVAL <span class="sc">-</span> BASE, </span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">STUDYID =</span> <span class="fu">factor</span>(STUDYID, <span class="at">levels=</span><span class="dv">1</span>L<span class="sc">:</span>N_studies_hist<span class="sc">+</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>rseff) <span class="sc">%&gt;%</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(STUDYID, USUBJID, TRT01P, AVISIT, ADY, AVAL, CHG, BASE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range (`geom_point()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing missing values or values outside the scale range (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/plothistdata-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There are <a href="https://doi.org/10.1111/biom.12242">two mathematically equivalent ways of using historical data</a>: the meta-analytic predictive (MAP) and the meta-analytic combined (MAC) approaches. The first step of the MAP approach involves fitting a model to the historical data with model parameters allowed to vary hierarchically across trials (trial is a random effect). The posterior predictive distribution for the parameters of a new trial obtained from this model is then used as the prior distribution for the analysis of our new trial of interest. In the MAC approach, a single model is fit jointly to the historical and new data.</p>
<p>Here, we use the MAC approach, because it is easier to implement when there are many model parameters that vary across trials. However, the <code>brms</code> models we specify in either case are almost identical. It is also useful to first fit the model to only the historical data, which we could then use as an .</p>
<p>For a MAP approach we would still use the same model structure as below and use the <code>drop_unused_levels=FALSE</code> option in <code>brms</code> in combination with coding <code>STUDYID</code> to have an additional 11th factor level (for our new study) and <code>TRT01P</code> with the treatment groups of the new study included in its factor levels. That way, the number and indexing of parameters inside the generated Stan code remains unchanged and <code>brms</code> already samples parameter values for a new 11th study. We can easily fit such a model only to the historical data in order to inspect the resulting predictive distribution, which tells us how much information about the parameters of a new study the historical data in combination with our specified prior distributions implies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(historical_studies<span class="sc">$</span>AVISIT) <span class="ot">&lt;-</span> MASS<span class="sc">::</span>contr.sdif</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>mmrm_mac_model <span class="ot">&lt;-</span> <span class="fu">bf</span>( CHG  <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> TRT01P<span class="sc">:</span>AVISIT <span class="sc">+</span> ( <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">|</span> STUDYID),  </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">autocor=</span><span class="sc">~</span><span class="fu">unstr</span>(<span class="at">time=</span>AVISIT, <span class="at">gr=</span>USUBJID), </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># center = FALSE, # We would use this option, if we used a MAP approach</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>                     sigma <span class="sc">~</span>  <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P <span class="sc">|</span> STUDYID))</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Priors as set are based on the assumed prior unit standard deviation</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># (usd) of unity. For the random effect for the log of sigma the unit</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># standard deviation is about sqrt(2).</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>mmrm_mac_prior <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>Intercept) <span class="sc">+</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class=</span>b) <span class="sc">+</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.25</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>STUDYID) <span class="sc">+</span> <span class="co"># moderate heterogeneity on the intercept (usd/4)</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>sd, <span class="at">group=</span>STUDYID) <span class="sc">+</span>                <span class="co"># smaller heterogeneity on regression coefficients (usd/8)</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">10.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>Intercept, <span class="at">dpar=</span>sigma) <span class="sc">+</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">2.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>b, <span class="at">dpar=</span>sigma) <span class="sc">+</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="dv">2</span>)<span class="sc">/</span><span class="fl">4.0</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>STUDYID, <span class="at">dpar=</span>sigma) <span class="sc">+</span> <span class="co"># same heterogeneity logic </span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="dv">2</span>)<span class="sc">/</span><span class="fl">8.0</span>), <span class="at">class=</span>sd, <span class="at">group=</span>STUDYID, <span class="at">dpar=</span>sigma) <span class="sc">+</span>                 <span class="co"># as for main regression coefficients</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">lkj_corr_cholesky</span>(<span class="dv">1</span>), <span class="at">class=</span>Lcortime) <span class="sc">+</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">2</span>), <span class="at">class=</span>cor, <span class="at">group=</span>STUDYID)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>histfit <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula=</span>mmrm_mac_model,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior=</span>mmrm_mac_prior,</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> historical_studies,</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop_unused_levels=</span><span class="cn">FALSE</span>,</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">234525</span>,</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> control_args,</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that our simulation code created a dataset with <code>STUDYID</code> column that labels the 10 different studies being simulated and in addition has an extra 11th factor level for a new study.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(historical_studies<span class="sc">$</span>STUDYID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10" "11"</code></pre>
</div>
</div>
<p>This trick with the extra factor level (plus using the <code>drop_unused_levels=FALSE</code> option in <code>brms</code>) automatically creates samples from the predictive distribution for the parameters of a new hypothetical study. Without this trick we would have to sample from a multivariate normal distribution for each MCMC sample in order to get the correlation of predicted parameters right. Instead, we can now simply add the population-level parameter estimate plus the study specific parameter estimate for the hypothetical new (11th) study (for which we had no data). This will then already correctly reflect the correlation between the predictions for the different parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>predictive_dist <span class="ot">&lt;-</span> histfit <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_rvars</span>(<span class="at">variable=</span><span class="fu">c</span>(<span class="st">"^b_"</span>, <span class="st">"^r_STUDYID"</span>), <span class="at">regex=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_variables</span>(<span class="at">b_Intercept =</span> b_Intercept <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"Intercept"</span>],</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b_AVISITvisit2Mvisit1 =</span> b_AVISITvisit2Mvisit1 <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit2Mvisit1"</span>],</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b_AVISITvisit3Mvisit2 =</span> b_AVISITvisit3Mvisit2 <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit3Mvisit2"</span>],</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b_AVISITvisit4Mvisit3 =</span> b_AVISITvisit4Mvisit3 <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit4Mvisit3"</span>],</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b_BASE =</span> b_BASE <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"BASE"</span>],</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">b_AVISITvisit2Mvisit1:BASE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">b_AVISITvisit2Mvisit1:BASE</span><span class="st">`</span> <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit2Mvisit1:BASE"</span>],</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">b_AVISITvisit3Mvisit2:BASE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">b_AVISITvisit3Mvisit2:BASE</span><span class="st">`</span> <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit3Mvisit2:BASE"</span>],</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">b_AVISITvisit4Mvisit3:BASE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">b_AVISITvisit4Mvisit3:BASE</span><span class="st">`</span> <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit4Mvisit3:BASE"</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset_draws</span>(<span class="at">variable=</span><span class="fu">c</span>(<span class="st">"^b_Intercept"</span>, <span class="st">"^b_AVISIT.*"</span>, <span class="st">"^b_BASE.*"</span>), <span class="at">regex=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_df</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could now explore and visualize the joint distribution of these predicted parameter values in order to get an idea for the prior distribution induced by the historical data.</p>
<!-- not sure if this plot is really helpful. Drop? --->
<!-- ```{r} -->
<!-- predictive_dist %>%  -->
<!--   as_tibble() %>%  -->
<!--   dplyr::select(-.chain, -.iteration, -.draw) %>% -->
<!--   GGally::ggpairs() + -->
<!--   theme_bw(base_size=12) -->
<!-- ``` -->
<div class="alert alert-info">
<p>The <a href="https://doi.org/10.1002/sim.5851">MAP approach</a> has been very popular at Novartis, especially for proof of concept studies. To use it, we would now have to approximate the joint predictive distribution of the model parameters using a suitable multivariate distribution such as a multivariate Student-t distribution. Then, we would have to correctly add Stan code to the <code>stanvars</code> argument to the <code>brm</code> call in order to specify this prior distribution. We would also use <code>center=FALSE</code> to the brms-formula function <code>bf()</code> in order to make setting priors easier, which would otherwise get harder if we let <code>brms</code> center covariates.</p>
<p>Thus, implementing the MAP approach with <code>brms</code> is currently a quite advanced task. However, this will become a lot easier once support for it is available in the <code>RBesT</code> package.</p>
</div>
<p>Below is the code for fitting a MMRM to the historical and new trial data jointly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>combined_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(historical_studies <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">mutate</span>(<span class="at">historical=</span><span class="fu">factor</span>(<span class="dv">1</span>L, <span class="at">levels=</span><span class="dv">0</span>L<span class="sc">:</span><span class="dv">1</span>L)),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                           simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">mutate</span>(<span class="at">STUDYID=</span><span class="fu">factor</span>(<span class="dv">11</span>, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">USUBJID=</span>USUBJID<span class="sc">+</span><span class="fu">max</span>(historical_studies<span class="sc">$</span>USUBJID),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">historical=</span><span class="fu">factor</span>(<span class="dv">0</span>L, <span class="at">levels=</span><span class="dv">0</span>L<span class="sc">:</span><span class="dv">1</span>L)))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(combined_data<span class="sc">$</span>AVISIT) <span class="ot">&lt;-</span> MASS<span class="sc">::</span>contr.sdif</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>macfit <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> mmrm_mac_model,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> mmrm_mac_prior,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> combined_data,       <span class="co"># now using the combined data</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop_unused_levels =</span> <span class="cn">FALSE</span>, <span class="co"># Important, if we fit only to the historical data</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">234525</span>,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> control_args,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">iter=</span><span class="dv">20</span>, <span class="at">warmup=</span><span class="dv">10</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This gives us the following inference about the treatment effects at each visit: <!-- # ```{r} --> <!-- # # Or, of course again via  --> <!-- # # emmeans(brmfit1b, ~ TRT01P | AVISIT, weights = "proportional") --> <!-- # hypothesis(macfit, contrasts_of_interest)$hypothesis %>% --> <!-- #   ggplot(aes(y=Hypothesis, x=Estimate, xmin=CI.Lower, xmax=CI.Upper)) + --> <!-- #       geom_vline(xintercept=0) + --> <!-- #       geom_point() + --> <!-- #       geom_errorbar() + --> <!-- #       xlab("Treatment difference to placebo") --> <!-- # ``` --></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(macfit, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights =</span> <span class="st">"proportional"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">contrast</span>(., <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AVISIT, <span class="at">y=</span>estimate, <span class="at">ymin=</span>lower.HPD, <span class="at">ymax=</span>upper.HPD, <span class="at">color=</span>contrast)) <span class="sc">+</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Treatment difference to placebo"</span>) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Visit"</span>) <span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)[<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">nrow=</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/lsmeans_mac_brms-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="robust-meta-analytic-combined-rmac-approach-to-historical-data-for-mmrms" class="level3" data-number="13.4.5">
<h3 data-number="13.4.5" class="anchored" data-anchor-id="robust-meta-analytic-combined-rmac-approach-to-historical-data-for-mmrms"><span class="header-section-number">13.4.5</span> Robust Meta-analytic combined (rMAC) approach to historical data for MMRMs</h3>
<div class="alert alert-info">
<p><strong>WARNING</strong>: This section presents initial ideas for a robust MAC approach. The discussed technique is not well-understood in the MMRM setting with a larger number of parameters, about which borrowing of information is needed. The discussed approach is the subject of ongoing research and its operating characteristics are not well-understood. It is shared to illustrate features of <code>brms</code> and to gather feedback. Do not use without careful testing for your specific setting (e.g.&nbsp;via simulation).</p>
</div>
<p>One popular variant of the <a href="https://doi.org/10.1002/sim.5851">MAP approach</a> is <a href="https://doi.org/10.1111/biom.12242">its robust rMAP version</a> that adds a uninformative or weakly informative mixture component to the MAP prior. In this way the historical prior information can be discarded or donweighted when there is an apparent prior-data-conflict.</p>
<p>A way of obtaining a type of <a href="https://doi.org/10.1080/19466315.2019.1610043">robust MAC (rMAC) approach</a> is to introduce an additional model parameter that indicates how much the parameters of the new data differ from the historical data and to assign this parameter a “slab-and-spike”-type prior. I.e. a prior distribution that is peaked at zero and heavy-tailed such as a double-exponential (DE) distribution (aka “Laplace distribution”).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">expand_grid</span>(<span class="at">mean=</span><span class="dv">0</span>, <span class="at">scale=</span><span class="fu">c</span>(<span class="fl">0.125</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">x=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.5</span>, <span class="fl">2.5</span>, <span class="fl">0.01</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">dasym_laplace</span>(x, mean, scale),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">scale=</span><span class="fu">factor</span>(scale)) <span class="sc">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>density, <span class="at">col=</span>scale, <span class="at">label=</span>scale)) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth=</span><span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"DE(0, scale) density for various</span><span class="sc">\n</span><span class="st">scale parameter values"</span>) <span class="sc">+</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    directlabels<span class="sc">::</span><span class="fu">geom_dl</span>(<span class="at">method=</span><span class="st">"smart.grid"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/plot_de_dist-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>However, while this approach is well understood for a single control group log-event-rate or logit-proportion, there is currently no experience with it for continuous data and multiple parameters. For example, it is not immediately obvious how to encode a prior belief that when outcomes at one visit are similar to historical data, we become more likely to believe this about other visits. Here we setup the scale of the DE distribution such that the tail probability beyond the unit standard deviation of unity is close to 5%. This will ensure that most mass of the prior is centered around 0 while very large deviations are allowed for by the long tail of the DE distribution. A more detailed analysis of this prior is subject to research.</p>
<p>With these caveats stated, here is how one can implement this model with <code>brms</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>mmrm_rmac_model <span class="ot">&lt;-</span> <span class="fu">bf</span>( CHG  <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> historical <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> TRT01P<span class="sc">:</span>AVISIT <span class="sc">+</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                         AVISIT<span class="sc">:</span>historical <span class="sc">+</span> BASE<span class="sc">:</span>historical <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT<span class="sc">:</span>historical <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                         ( <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">|</span> STUDYID),  </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">autocor=</span><span class="sc">~</span><span class="fu">unstr</span>(<span class="at">time=</span>AVISIT, <span class="at">gr=</span>USUBJID), </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># center = FALSE, # We would use this option, if we used a MAP approach</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                     sigma <span class="sc">~</span>  <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">|</span> STUDYID))</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co"># can be used to find out on instantiated parameters</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">#get_prior(mmrm_rmac_model, combined_data)</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>mmrm_rmac_prior <span class="ot">&lt;-</span> mmrm_mac_prior <span class="sc">+</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.25</span>), <span class="at">class=</span>b, <span class="at">coef=</span>historical1) <span class="sc">+</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>BASE<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit2Mvisit1<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit3Mvisit2<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit4Mvisit3<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit2Mvisit1<span class="sc">:</span>BASE<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit3Mvisit2<span class="sc">:</span>BASE<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit4Mvisit3<span class="sc">:</span>BASE<span class="sc">:</span>historical1)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>rmacfit <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula=</span>mmrm_rmac_model,</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior=</span>mmrm_rmac_prior,</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> combined_data,</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop_unused_levels=</span><span class="cn">FALSE</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">234525</span>,</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> control_args,</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Rows containing NAs were excluded from the model.</code></pre>
</div>
</div>
<p>This gives us the following inference about the treatment effects at each visit:</p>
<!-- ```{r} -->
<!-- # Or, of course again via  -->
<!-- # emmeans(brmfit1b, ~ TRT01P | AVISIT, weights = "proportional") -->
<!-- hypothesis(rmacfit, contrasts_of_interest)$hypothesis %>% -->
<!--   ggplot(aes(y=Hypothesis, x=Estimate, xmin=CI.Lower, xmax=CI.Upper)) + -->
<!--       geom_vline(xintercept=0) + -->
<!--       geom_point() + -->
<!--       geom_errorbar() + -->
<!--       xlab("Treatment difference to placebo") -->
<!-- ``` -->
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(rmacfit, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights =</span> <span class="st">"proportional"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">contrast</span>(., <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AVISIT, <span class="at">y=</span>estimate, <span class="at">ymin=</span>lower.HPD, <span class="at">ymax=</span>upper.HPD, <span class="at">color=</span>contrast)) <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Treatment difference to placebo"</span>) <span class="sc">+</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Visit"</span>) <span class="sc">+</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)[<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">nrow=</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/contrasts_for_rmac-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="going-beyond-the-traditional-mmrm-monotonic-effects" class="level3" data-number="13.4.6">
<h3 data-number="13.4.6" class="anchored" data-anchor-id="going-beyond-the-traditional-mmrm-monotonic-effects"><span class="header-section-number">13.4.6</span> Going beyond the traditional MMRM: monotonic effects</h3>
<p>Now, let us look at some ways, in which we can add some advanced features of <code>brms</code> on top of a MMRM.</p>
<p>What if we wanted to make our analysis more efficient by exploiting knowledge about the structure of the experiment? E.g. what if we wanted to assume a monotonic increase of efficacy across doses (for the treatment main effect) and assume the how this effect differs at each visit is also monotonly across doses?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(simulated_data<span class="sc">$</span>AVISIT) <span class="ot">&lt;-</span> MASS<span class="sc">::</span>contr.sdif</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>mmrm_mo_model <span class="ot">&lt;-</span> <span class="fu">bf</span>( CHG <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> <span class="fu">mo</span>(TRT01P) <span class="sc">+</span> BASE <span class="sc">+</span> <span class="fu">mo</span>(TRT01P)<span class="sc">:</span>AVISIT <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">autocor=</span><span class="sc">~</span><span class="fu">unstr</span>(AVISIT, USUBJID), </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                     sigma <span class="sc">~</span><span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># use the same prior as before and use the default dirichlet(1) priors</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co"># of brms for the increase fractions of the monotonic effects. This</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># represents a a uniform prior over the fractions</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>mmrm_mo_prior <span class="ot">&lt;-</span> mmrm_prior1</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>brmfit2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> mmrm_mo_model,</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> mmrm_mo_prior,</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> simulated_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">TRT01P=</span><span class="fu">ordered</span>(TRT01P)),</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> control_args,</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The syntax of <code>emmeans</code> would in this case still be very straightforward:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(brmfit2, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">contrast</span>(<span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AVISIT, <span class="at">y=</span>estimate, <span class="at">ymin=</span>lower.HPD, <span class="at">ymax=</span>upper.HPD, <span class="at">color=</span>contrast)) <span class="sc">+</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Treatment difference to placebo"</span>) <span class="sc">+</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Visit"</span>) <span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)[<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">nrow=</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/contrasts_mo_mmrm-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- Instead, the `brms` specific approach using `hypothesis` requires us to -->
<!-- understand the exact way that `brms` parameterizes monotonic predictors. For -->
<!-- a variable with $K+1$ ordinal categories, the effect of the variable is -->
<!-- parameterized to be $0$ for the reference category and -->
<!-- $$(\text{maximum effect in highest category}) \times K \times \sum_{m=1}^k \zeta_m$$ -->
<!-- for a category $k$ above the reference category, where -->
<!-- $\sum_{m=1}^K \zeta_m = 1$. -->
<!-- In our case, $K=3$ for the doses, because there are three active doses and -->
<!-- placebo is the reference category. With this, we can look up how these -->
<!-- parameters are called within the fit model (the maximum possible effect for -->
<!-- a variable has the prefix `bsp_mo` and the $\zeta_m$ have the prefix `simo_mo`). -->
<!-- On this basis, we can specify the treatment comparisons with placebo as follows: -->
<!-- ```{r, eval=FALSE} -->
<!-- monotonic_comparisons <- list( -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * `simo_moTRT01P1[1]` < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * (`simo_moTRT01P1[1]` + `simo_moTRT01P1[2]`) < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * `simo_moTRT01P1[1]` + `bsp_moTRT01P:AVISIT2` * 3.0 * `simo_moTRT01P:AVISIT21[1]` < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * (`simo_moTRT01P1[1]` + `simo_moTRT01P1[2]`) + `bsp_moTRT01P:AVISIT2` * 3.0 *  (`simo_moTRT01P:AVISIT21[1]` + `simo_moTRT01P:AVISIT21[2]`) < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 + `bsp_moTRT01P:AVISIT2` * 3.0 < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * `simo_moTRT01P1[1]` + `bsp_moTRT01P:AVISIT3` * 3.0 * `simo_moTRT01P:AVISIT31[1]` < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * (`simo_moTRT01P1[1]` + `simo_moTRT01P1[2]`) + `bsp_moTRT01P:AVISIT3` * 3.0 *  (`simo_moTRT01P:AVISIT31[1]` + `simo_moTRT01P:AVISIT31[2]`) < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 + `bsp_moTRT01P:AVISIT3` * 3.0 < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * `simo_moTRT01P1[1]` + `bsp_moTRT01P:AVISIT4` * 3.0 * `simo_moTRT01P:AVISIT41[1]` < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * (`simo_moTRT01P1[1]` + `simo_moTRT01P1[2]`) + `bsp_moTRT01P:AVISIT4` * 3.0 * ( `simo_moTRT01P:AVISIT41[1]` + `simo_moTRT01P:AVISIT41[2]`) < 0", class=NULL), -->
<!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0  + `bsp_moTRT01P:AVISIT4` * 3.0 < 0", class=NULL)) %>% -->
<!--   map_dfr(\(x) x$hypothesis %>% as_tibble()) %>% -->
<!--   mutate(week = rep(c(2,4,8,12), each=3), -->
<!--          dose = rep(c(10, 20, 40), 4)) %>% -->
<!--   mutate(Comparison = case_when(week==2 ~ paste0("Visit 1: ", dose, " vs. placebo"), -->
<!--                                 week==4 ~ paste0("Visit 2: ", dose, " vs. placebo"), -->
<!--                                 week==8 ~ paste0("Visit 3: ", dose, " vs. placebo"), -->
<!--                                 TRUE ~ paste0("Visit 4: ", dose, " vs. placebo")), -->
<!--          Model = "MMRM + monotonic dose response") -->
<!-- monotonic_comparisons %>% -->
<!--   bind_rows(expand_grid(week=0, dose=c(10,20,40), Estimate=0)) %>% -->
<!--   ggplot(aes(x=week, y=Estimate, ymin = CI.Lower, ymax=CI.Upper, -->
<!--              group=factor(dose), color=factor(dose),  -->
<!--              label=paste0(dose, " mg") )) + -->
<!--   geom_hline(yintercept = 0) + -->
<!--   geom_point(position=position_dodge(width=0.2)) + -->
<!--   geom_errorbar(position=position_dodge(width=0.2)) + -->
<!--   geom_line(position=position_dodge(width=0.2))  + -->
<!--   theme(legend.position="right") + -->
<!--   scale_color_brewer(palette="YlOrRd", limits=c("0","10","20","40"), -->
<!--                      breaks=c("10","20","40")) + -->
<!--   ylab("Difference to placebo in change from baseline") -->
<!-- ``` -->
</section>
<section id="going-beyond-the-traditional-mmrm-non-linear-functions" class="level3" data-number="13.4.7">
<h3 data-number="13.4.7" class="anchored" data-anchor-id="going-beyond-the-traditional-mmrm-non-linear-functions"><span class="header-section-number">13.4.7</span> Going beyond the traditional MMRM: non-linear functions</h3>
<p>As an alternative to the assumptions we made regarding monotonic predictors, we can explicitly specify a functional form for how doses are related and how their effect develops over time. However, while we will assume a particular functional form for the treatment effect over time, we will keep how the control group is modeled as flexible as possible. Notice that we would want to set <code>control = list(adapt_delta=0.999, max_treedepth=13)</code>, because we received warnings that there were divergent transitions (hence an <code>adapt_delta</code> closer to 1 than before) and poor sampling with many transitions hitting the maximum tree depth (hence <code>max_treedepth</code> increased from 10 to 13).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>mmrm_dr_model <span class="ot">&lt;-</span> <span class="fu">bf</span>( CHG <span class="sc">~</span> E0 <span class="sc">+</span> Emax <span class="sc">*</span> ndose<span class="sc">^</span>h<span class="sc">/</span>(ndose<span class="sc">^</span>h <span class="sc">+</span> ED50<span class="sc">^</span>h) <span class="sc">*</span> nweek<span class="sc">^</span>ht<span class="sc">/</span>(nweek<span class="sc">^</span>ht <span class="sc">+</span> ET50<span class="sc">^</span>ht),</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">autocor=</span><span class="sc">~</span><span class="fu">unstr</span>(AVISIT, USUBJID), </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                     sigma <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">nlf</span>(h <span class="sc">~</span> <span class="fu">exp</span>(logh)), <span class="fu">nlf</span>(ED50 <span class="sc">~</span> <span class="fu">exp</span>(logED50)),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">nlf</span>(ht <span class="sc">~</span> <span class="fu">exp</span>(loght)), <span class="fu">nlf</span>(ET50 <span class="sc">~</span> <span class="fu">exp</span>(logET50)),</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>                     E0 <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>                     Emax <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>                     logED50 <span class="sc">~</span> <span class="dv">1</span>, logh <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>                     logET50 <span class="sc">~</span> <span class="dv">1</span>, loght <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nl=</span><span class="cn">TRUE</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family=</span><span class="fu">gaussian</span>())</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>mmrm_dr_prior <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>b, <span class="at">coef=</span>Intercept, <span class="at">nlpar=</span>E0) <span class="sc">+</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class=</span>b, <span class="at">nlpar=</span>E0) <span class="sc">+</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">4.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">nlpar=</span>logh) <span class="sc">+</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">4.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">nlpar=</span>loght) <span class="sc">+</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">nlpar=</span>Emax) <span class="sc">+</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">2.5</span>, <span class="fu">log</span>(<span class="fl">10.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">nlpar=</span>logED50) <span class="sc">+</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="dv">4</span>), <span class="fu">log</span>(<span class="dv">5</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">nlpar=</span>logET50) <span class="sc">+</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">10.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>Intercept, <span class="at">dpar=</span>sigma) <span class="sc">+</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">2.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>b, <span class="at">dpar=</span>sigma) <span class="sc">+</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">lkj_corr_cholesky</span>(<span class="dv">1</span>), <span class="at">class=</span>Lcortime)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>brmfit3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula=</span>mmrm_dr_model,</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> mmrm_dr_prior,</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">nweek =</span> ADY<span class="sc">/</span><span class="dv">7</span>,</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>           <span class="at">ndose =</span> <span class="fu">as.numeric</span>(<span class="fu">levels</span>(TRT01P)[TRT01P])),</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> control_args,</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that here, it is hard to see how to make <code>emmeans</code> work. Instead, we use <code>hypothesis</code> to get treatment differences at each visit.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>comparisons_for_sigemax <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">dose =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">40</span>), <span class="at">week=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">12</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Hypothesis string</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Emax_Intercept * "</span>, dose, <span class="st">"^exp(logh_Intercept)/("</span>, dose,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"^exp(logh_Intercept) + exp(logED50_Intercept)^exp(logh_Intercept)) * "</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>        week, <span class="st">"^exp(loght_Intercept)/("</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        week,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"^exp(loght_Intercept) + exp(logET50_Intercept)^exp(loght_Intercept)) &lt; 0"</span>),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">evaluation =</span> <span class="fu">map</span>(<span class="st">`</span><span class="at">Hypothesis string</span><span class="st">`</span>,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>                         \(x) <span class="fu">hypothesis</span>(brmfit3, x)<span class="sc">$</span>hypothesis <span class="sc">%&gt;%</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">as_tibble</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(evaluation) <span class="sc">%&gt;%</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Comparison =</span> <span class="fu">case_when</span>(week<span class="sc">==</span><span class="dv">2</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Visit 1: "</span>, dose, <span class="st">" vs. placebo"</span>),</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>                                    week<span class="sc">==</span><span class="dv">4</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Visit 2: "</span>, dose, <span class="st">" vs. placebo"</span>),</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>                                    week<span class="sc">==</span><span class="dv">8</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Visit 3: "</span>, dose, <span class="st">" vs. placebo"</span>),</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>                                    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Visit 4: "</span>, dose, <span class="st">" vs. placebo"</span>)),</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">Model =</span> <span class="st">"BMMRM (non-linear)"</span>)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the results</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>comparisons_for_sigemax <span class="sc">%&gt;%</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(<span class="fu">expand_grid</span>(<span class="at">week=</span><span class="dv">0</span>, <span class="at">Estimate=</span><span class="dv">0</span>, <span class="at">dose=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">40</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week, <span class="at">y=</span>Estimate, <span class="at">ymin=</span>CI.Lower, <span class="at">ymax=</span>CI.Upper,</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>               <span class="at">group=</span>dose, <span class="at">col=</span><span class="fu">factor</span>(dose))) <span class="sc">+</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="st">"Dose"</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)[<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Change from baseline"</span>) <span class="sc">+</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Treatment difference to placebo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/contrasts_nonlin-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Just note that the string specifying the hypothesis become something complex and long like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>comparisons_for_sigemax<span class="sc">$</span><span class="st">`</span><span class="at">Hypothesis string</span><span class="st">`</span>[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Emax_Intercept * 10^exp(logh_Intercept)/(10^exp(logh_Intercept) + exp(logED50_Intercept)^exp(logh_Intercept)) * 2^exp(loght_Intercept)/(2^exp(loght_Intercept) + exp(logET50_Intercept)^exp(loght_Intercept)) &lt; 0"</code></pre>
</div>
</div>
<p>for the difference to placebo for the 10 mg dose at week 2.</p>
</section>
</section>
<section id="results" class="level2" data-number="13.5">
<h2 data-number="13.5" class="anchored" data-anchor-id="results"><span class="header-section-number">13.5</span> Results</h2>
<p>Here is an overview of the results with some the different models we tried.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map2_dfr</span>(<span class="fu">list</span>(brmfit1, brmfit2, macfit, rmacfit),</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>         <span class="fu">c</span>(<span class="st">"BMMRM"</span>, <span class="st">"BMMRM (monotonic)"</span>, <span class="st">"BMMRM (MAC)"</span>, <span class="st">"BMMRM (rMAC)"</span>),</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>         \(x, y) <span class="fu">emmeans</span>(x, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">contrast</span>(<span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>, <span class="at">ref=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>           <span class="fu">mutate</span>(<span class="at">Model=</span>y)) <span class="sc">%&gt;%</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(comparisons_for_sigemax <span class="sc">%&gt;%</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename</span>(<span class="at">estimate=</span>Estimate, <span class="at">lower.HPD=</span>CI.Lower, <span class="at">upper.HPD=</span>CI.Upper) <span class="sc">%&gt;%</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">AVISIT =</span> <span class="fu">paste0</span>(<span class="st">"visit"</span>, <span class="fu">case_when</span>(week<span class="sc">==</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                                                        week<span class="sc">==</span><span class="dv">4</span><span class="sc">~</span><span class="dv">2</span>,</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>                                                        week<span class="sc">==</span><span class="dv">8</span><span class="sc">~</span><span class="dv">3</span>,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>                                                        week<span class="sc">==</span><span class="dv">12</span><span class="sc">~</span><span class="dv">4</span>)),</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">contrast =</span> <span class="fu">paste0</span>(dose,<span class="st">" - 0"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(contrasts1 <span class="sc">%&gt;%</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">confint</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">lower.HPD=</span>lower.CL,</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">upper.HPD=</span>upper.CL) <span class="sc">%&gt;%</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Model=</span><span class="st">"Frequentist MMRM"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Model, contrast, AVISIT, estimate, lower.HPD, upper.HPD) <span class="sc">%&gt;%</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="fu">factor</span>(Model,</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>                        <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"Frequentist MMRM"</span>,</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"BMMRM"</span>, </span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"BMMRM (MAC)"</span>, <span class="st">"BMMRM (rMAC)"</span>,</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"BMMRM (monotonic)"</span>, <span class="st">"BMMRM (non-linear)"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>contrast, <span class="at">y=</span>estimate,</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">ymin=</span>lower.HPD, <span class="at">ymax=</span>upper.HPD, <span class="at">col=</span>Model)) <span class="sc">+</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">ncol=</span><span class="dv">2</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"#1b9e77"</span>,</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"#7570b3"</span>, <span class="st">"#e7298a"</span>, <span class="st">"#e6ab02"</span>, <span class="st">"#d95f02"</span>)) <span class="sc">+</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>AVISIT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02h_mmrm_files/figure-html/plotallresults-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Using a BMMRM in the particular example had without informative prior distributions no particular advantage over a MMRM fit with REML. It is possible that there would be some advantage to using BMMRM with vague priors with smaller sample sizes. However, using historical control group informtion with a MAC (or rMAC) approach narrows the credible intervals. Making stronger assumptions about the dose response relationship over time turns out to also have a substantial effect on the width of the credible intervals. Of course, we could also use both prior information about the control group and assumptions about the dose response relationship for the drug.</p>
<p>Unsurprisingly, putting in more information either in terms of prior knowledge about the control group or in terms of the structure of the dose response relationship leads to narrower CrIs and also affects the point estimates.</p>
</section>
<section id="conclusion" class="level2" data-number="13.6">
<h2 data-number="13.6" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">13.6</span> Conclusion</h2>
<p>We can easily fit Bayesian MMRM models using <code>brms</code> including using an unstructured covariance matrix for how the residuals are correlated. As in other cases, a benefit of <code>brms</code> is that we can combine this feature with the many other features available in <code>brms</code> to gain a lot of flexibility in our modelling. With this modeling flexibility we can evaluate varying assumptions which can lead to greater statistical efficiency in our estimation as demonstrated. Given the flexibility of <code>brms</code>, these assumptions can range from just monotonicity up to a full non-linear model for the shape of the dose-response curve.</p>
</section>
<section id="exercises" class="level2" data-number="13.7">
<h2 data-number="13.7" class="anchored" data-anchor-id="exercises"><span class="header-section-number">13.7</span> Exercises</h2>
<section id="excercise-1" class="level3" data-number="13.7.1">
<h3 data-number="13.7.1" class="anchored" data-anchor-id="excercise-1"><span class="header-section-number">13.7.1</span> Excercise 1</h3>
<p>Analyze the following data from the ACTIVE RCT, which compared interventions focused on memory, reasoning and speed of processing with a control group. The data of the ACTIVE trial is available from the <a href="https://doi.org/10.3886/ICPSR36036.v1">US National archive of Computerized Data on Aging</a> and is used as an example for repeated measures on the <a href="https://advstats.psychstat.org/">Advanced Statistics using R website</a>. The outcome variable of interest is the Hopkins Verbal Learning Test (HVLT) total score compared with time 1 (baseline, <code>hvltt</code> column) assessed immediately after training (<code>hvltt2</code> column), 1 year later (<code>hvltt3</code> column) and 2 years later (<code>hvltt4</code> column). Consider how to structure your analysis dataset and covariates might be sensible to include in the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>active <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://advstats.psychstat.org/data/active.csv"</span>, </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">col_types =</span> <span class="st">"iiiiiiiiiiiiii"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">factor</span>(group, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"control"</span>, <span class="st">"memory"</span>, <span class="st">"reasoning"</span>, <span class="st">"speed"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(id, group, hvltt, hvltt2, hvltt3, hvltt4)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(active)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="excercise-2" class="level3" data-number="13.7.2">
<h3 data-number="13.7.2" class="anchored" data-anchor-id="excercise-2"><span class="header-section-number">13.7.2</span> Excercise 2</h3>
<p>Try changing the size of the simulated data so that there is 80 (or 90%) power at the one-sided 2.5%, 5% or 10% significance level. Do our priors become more influential as the sample size decreases (compared with a frequentist MMRM fit using the <code>mmrm</code> package)</p>
<ol type="1">
<li>when you use the standard Bayesian MMRM and</li>
<li>when using the MAC (or rMAC) approaches?</li>
</ol>
</section>
</section>
<section id="references" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-allison2012equip" class="csl-entry" role="listitem">
Allison, David B., Kishore M. Gadde, William Timothy Garvey, Craig A. Peterson, Michael L. Schwiers, Thomas Najarian, Peter Y. Tam, Barbara Troupin, and Wesley W. Day. 2012. <span>“Controlled-Release Phentermine/Topiramate in Severely Obese Adults: A Randomized Controlled Trial (EQUIP).”</span> <em>Obesity</em> 20 (2): 330–42. <a href="https://doi.org/10.1038/oby.2011.330">https://doi.org/10.1038/oby.2011.330</a>.
</div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/opensource\.nibr\.com\/bamdd\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../src/02g_longitudinal.html" class="pagination-link" aria-label="Longitudinal data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Longitudinal data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../src/02i_time_to_event.html" class="pagination-link" aria-label="Time-to-event data">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Time-to-event data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb51" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co">  - Björn Holzhauer - &lt;bjoern.holzhauer@novartis.com&gt;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - Sebastian Weber - &lt;sebastian.weber@novartis.com&gt;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- https://raw.githubusercontent.com/Novartis/bamdd/main/src/_macros.qmd --&gt;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>{{&lt; include _macros.qmd &gt;}}</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bayesian Mixed effects Model for Repeated Measures {#sec-mmrm}</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>This case study covers</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Fitting mixed models for repeated measures using restricted maximum likelihood (REML) in R using the <span class="in">`mmrm`</span> package</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Fitting Bayesian mixed models for repeated measures using <span class="in">`brms`</span> package</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Distributional regression <span class="in">`sigma ~ 1 + AVISIT + TRT01P + AVISIT:TRT01P`</span> to allow variances to vary across visits and treatment groups in a MMRM</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Specifying an unstructured correlation structure for MMRMs using <span class="in">`autocor = ~unstr(time=AVISIT, gr=USUBJID)`</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Estimands addressed by MMRM models</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Using the <span class="in">`emmeans`</span> package to obtain least-squares means (LS-means), differences in LS-means and custom contrasts with highest posterior density credible intervals, as well as using <span class="in">`hypothesis`</span> as an alternative for complex situations</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Options for MMRM paramterization including forward difference contrasts for changes between visits using <span class="in">`contrasts(simulated_data$AVISIT) &lt;- MASS::contr.sdif`</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Meta-analytic combined approach to MMRMs for using historical data and attempts to make the approach more robust against prior-data-conflict</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Extending MMRMs using covariates with a monotonic effect using <span class="in">`mo()`</span> and non-linear terms</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>To run the R code of this section please ensure to load these libraries first:</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=TRUE,echo=TRUE,results=FALSE,message=FALSE,warning=FALSE}</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dqrng)</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mmrm)</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans)</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a><span class="co"># instruct brms to use cmdstanr as backend and cache all Stan binaries</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">brms.backend=</span><span class="st">"cmdstanr"</span>, <span class="at">cmdstanr_write_stan_file_dir=</span><span class="fu">here</span>(<span class="st">"_brms-cache"</span>))</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a><span class="co"># create cache directory if not yet available</span></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">"_brms-cache"</span>), <span class="cn">FALSE</span>)</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4095867</span>)</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a><span class="co"># default control argument passed to brms</span></span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>control_args <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.95</span>)</span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a><span class="co"># allow wider printing</span></span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">width=</span><span class="dv">120</span>)</span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, include=FALSE, echo=FALSE, eval=TRUE}</span></span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a><span class="co"># invisible to the reader additional setup steps, which are optional</span></span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a><span class="co"># {{&lt; include setup.R &gt;}}</span></span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"setup.R"</span>)</span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include=FALSE}</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores=</span>parallelly<span class="sc">::</span><span class="fu">availableCores</span>(<span class="at">logical=</span><span class="cn">FALSE</span>))</span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a><span class="co"># speedup things by lowering adapt_delta for now, which speeds up things a lot</span></span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a><span class="co"># do this only if caching is on (which is when we want things go fast)</span></span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a><span class="do">##if(use_knitr_cache) {</span></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>    control_args <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">adapt_delta=</span><span class="fl">0.8</span>)</span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a><span class="do">##}</span></span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a><span class="co"># can be used to speedup rendering of this vignette  </span></span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>use_small_N <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a><span class="do">##use_small_N &lt;- TRUE</span></span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## Background</span></span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a>In randomized controlled clinical trials efficacy variables are often</span>
<span id="cb51-73"><a href="#cb51-73" aria-hidden="true" tabindex="-1"></a>measured at multiple points of time. This may be at visits to the</span>
<span id="cb51-74"><a href="#cb51-74" aria-hidden="true" tabindex="-1"></a>trial site for assessments that require a patient to be in the</span>
<span id="cb51-75"><a href="#cb51-75" aria-hidden="true" tabindex="-1"></a>investigator's office, but could also be at a patient's home (e.g. for</span>
<span id="cb51-76"><a href="#cb51-76" aria-hidden="true" tabindex="-1"></a>a daily quality of life questionnaire).  Multiple assessments over</span>
<span id="cb51-77"><a href="#cb51-77" aria-hidden="true" tabindex="-1"></a>time are useful for a wide variety of reasons.  Firstly, we get</span>
<span id="cb51-78"><a href="#cb51-78" aria-hidden="true" tabindex="-1"></a>information about how the difference between treatment groups develops</span>
<span id="cb51-79"><a href="#cb51-79" aria-hidden="true" tabindex="-1"></a>over time.  I.e. about both the onset of action, as well as whether</span>
<span id="cb51-80"><a href="#cb51-80" aria-hidden="true" tabindex="-1"></a>treatment effects disappear or decline at some point (e.g. after the</span>
<span id="cb51-81"><a href="#cb51-81" aria-hidden="true" tabindex="-1"></a>discontinuation of treatment either by some patients during the</span>
<span id="cb51-82"><a href="#cb51-82" aria-hidden="true" tabindex="-1"></a>treatment period or by all patients during a planned post-treatment</span>
<span id="cb51-83"><a href="#cb51-83" aria-hidden="true" tabindex="-1"></a>follow-up period). Secondly, seeing consistent data over time provides</span>
<span id="cb51-84"><a href="#cb51-84" aria-hidden="true" tabindex="-1"></a>additional evidence for the presence of an effect of an intervention.</span>
<span id="cb51-85"><a href="#cb51-85" aria-hidden="true" tabindex="-1"></a>Thirdly, pre-treatment (baseline) assessment(s) of a variable are</span>
<span id="cb51-86"><a href="#cb51-86" aria-hidden="true" tabindex="-1"></a>often used as a covariate in analyses, because this tends to reduce</span>
<span id="cb51-87"><a href="#cb51-87" aria-hidden="true" tabindex="-1"></a>unexplained variability leading to smaller standard errors. Finally,</span>
<span id="cb51-88"><a href="#cb51-88" aria-hidden="true" tabindex="-1"></a>data from post-baseline visits can help us deal with missing data or</span>
<span id="cb51-89"><a href="#cb51-89" aria-hidden="true" tabindex="-1"></a>data that are not relevant for our estimand of interest.</span>
<span id="cb51-90"><a href="#cb51-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-91"><a href="#cb51-91" aria-hidden="true" tabindex="-1"></a>Sometimes, we would be primarily interested in the treatment difference </span>
<span id="cb51-92"><a href="#cb51-92" aria-hidden="true" tabindex="-1"></a>at one particular visit (e.g. the final visit at the end of the planned </span>
<span id="cb51-93"><a href="#cb51-93" aria-hidden="true" tabindex="-1"></a>treatment period) or we might want to combine (e.g. average) treatment effects</span>
<span id="cb51-94"><a href="#cb51-94" aria-hidden="true" tabindex="-1"></a>across multiple visits.</span>
<span id="cb51-95"><a href="#cb51-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-96"><a href="#cb51-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-97"><a href="#cb51-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-98"><a href="#cb51-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-99"><a href="#cb51-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-100"><a href="#cb51-100" aria-hidden="true" tabindex="-1"></a>::: {.content-visible when-profile="dummy"}</span>
<span id="cb51-101"><a href="#cb51-101" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview Video</span></span>
<span id="cb51-102"><a href="#cb51-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-103"><a href="#cb51-103" aria-hidden="true" tabindex="-1"></a>{{&lt; video videos/brms-20230426-1-mmrm.mp4 &gt;}}</span>
<span id="cb51-104"><a href="#cb51-104" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb51-105"><a href="#cb51-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-106"><a href="#cb51-106" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data</span></span>
<span id="cb51-107"><a href="#cb51-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-108"><a href="#cb51-108" aria-hidden="true" tabindex="-1"></a>We will simulate data from a hypothetical parallel group RCT that tests three </span>
<span id="cb51-109"><a href="#cb51-109" aria-hidden="true" tabindex="-1"></a>doses of a drug (10, 20 or 40 mg once daily) compared with a placebo (0 mg once </span>
<span id="cb51-110"><a href="#cb51-110" aria-hidden="true" tabindex="-1"></a>daily). The endpoint of interest is continuous and assessed at a baseline visit,</span>
<span id="cb51-111"><a href="#cb51-111" aria-hidden="true" tabindex="-1"></a>as well as at 4 post-baseline visits (week 2, 4, 8 and 12). </span>
<span id="cb51-112"><a href="#cb51-112" aria-hidden="true" tabindex="-1"></a>200 patients are randomly assigned to each treatment group </span>
<span id="cb51-113"><a href="#cb51-113" aria-hidden="true" tabindex="-1"></a>(approximately 50 patients per arm). </span>
<span id="cb51-114"><a href="#cb51-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-115"><a href="#cb51-115" aria-hidden="true" tabindex="-1"></a>We simulate data with the following covariance matrix:</span>
<span id="cb51-116"><a href="#cb51-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-117"><a href="#cb51-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r covariance_matrix}</span></span>
<span id="cb51-118"><a href="#cb51-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation matrix between visits (baseline + 4 post-baseline visits)</span></span>
<span id="cb51-119"><a href="#cb51-119" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">5</span>)</span>
<span id="cb51-120"><a href="#cb51-120" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.48</span>, <span class="fl">0.4</span>, <span class="fl">0.375</span>)</span>
<span id="cb51-121"><a href="#cb51-121" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="dv">1</span>,<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> rho[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb51-122"><a href="#cb51-122" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="dv">2</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> rho[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb51-123"><a href="#cb51-123" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="dv">3</span>,<span class="dv">4</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> rho[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb51-124"><a href="#cb51-124" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="dv">4</span>,<span class="dv">5</span><span class="sc">:</span><span class="dv">5</span>] <span class="ot">&lt;-</span> rho[<span class="dv">1</span><span class="sc">:</span><span class="dv">1</span>]</span>
<span id="cb51-125"><a href="#cb51-125" aria-hidden="true" tabindex="-1"></a>corr_matrix[<span class="fu">lower.tri</span>(corr_matrix)] <span class="ot">&lt;-</span> <span class="fu">t</span>(corr_matrix)[<span class="fu">lower.tri</span>(corr_matrix)]</span>
<span id="cb51-126"><a href="#cb51-126" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb51-127"><a href="#cb51-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard deviations by visit (baseline + 4 post-baseline visits)</span></span>
<span id="cb51-128"><a href="#cb51-128" aria-hidden="true" tabindex="-1"></a>sds <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">c</span>(<span class="fl">0.75</span>, <span class="fl">0.8</span>, <span class="fl">0.85</span>, <span class="fl">0.95</span>, <span class="fl">1.1</span>))</span>
<span id="cb51-129"><a href="#cb51-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-130"><a href="#cb51-130" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="ot">&lt;-</span> <span class="fu">diag</span>(sds) <span class="sc">%*%</span> corr_matrix <span class="sc">%*%</span> <span class="fu">diag</span>(sds)</span>
<span id="cb51-131"><a href="#cb51-131" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cov_matrix, <span class="at">digits=</span><span class="dv">3</span>)</span>
<span id="cb51-132"><a href="#cb51-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-133"><a href="#cb51-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-134"><a href="#cb51-134" aria-hidden="true" tabindex="-1"></a>In our simulation some patients stop treatment before the end of the trial </span>
<span id="cb51-135"><a href="#cb51-135" aria-hidden="true" tabindex="-1"></a>and actually drop out of the study. We no longer follow them, because we are </span>
<span id="cb51-136"><a href="#cb51-136" aria-hidden="true" tabindex="-1"></a>interested in a hypothetical estimand as if they had stayed on drug, which means</span>
<span id="cb51-137"><a href="#cb51-137" aria-hidden="true" tabindex="-1"></a>we are no longer interested in values after treatment</span>
<span id="cb51-138"><a href="#cb51-138" aria-hidden="true" tabindex="-1"></a>discontinuation.</span>
<span id="cb51-139"><a href="#cb51-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-140"><a href="#cb51-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r simulate_time_series }</span></span>
<span id="cb51-141"><a href="#cb51-141" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb51-142"><a href="#cb51-142" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show the code"</span></span>
<span id="cb51-143"><a href="#cb51-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate from multivariate normal for control group </span></span>
<span id="cb51-144"><a href="#cb51-144" aria-hidden="true" tabindex="-1"></a><span class="co"># (before adding treatment effect later)</span></span>
<span id="cb51-145"><a href="#cb51-145" aria-hidden="true" tabindex="-1"></a><span class="co"># We simulate 1000 patients and then apply inclusion criteria and keep the</span></span>
<span id="cb51-146"><a href="#cb51-146" aria-hidden="true" tabindex="-1"></a><span class="co"># first 200 that meet them.</span></span>
<span id="cb51-147"><a href="#cb51-147" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb51-148"><a href="#cb51-148" aria-hidden="true" tabindex="-1"></a>Nf <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb51-149"><a href="#cb51-149" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(use_small_N) {</span>
<span id="cb51-150"><a href="#cb51-150" aria-hidden="true" tabindex="-1"></a>    Nf <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb51-151"><a href="#cb51-151" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-152"><a href="#cb51-152" aria-hidden="true" tabindex="-1"></a>effect_course <span class="ot">&lt;-</span> <span class="cf">function</span>(dose, time, <span class="at">ed50=</span><span class="dv">8</span>, <span class="at">et50=</span><span class="dv">3</span>) {</span>
<span id="cb51-153"><a href="#cb51-153" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.9</span> <span class="sc">*</span> dose <span class="sc">/</span>(dose <span class="sc">+</span> ed50) <span class="sc">*</span> time<span class="sc">^</span><span class="dv">3</span> <span class="sc">/</span>(time<span class="sc">^</span><span class="dv">3</span> <span class="sc">+</span> et50<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb51-154"><a href="#cb51-154" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-155"><a href="#cb51-155" aria-hidden="true" tabindex="-1"></a>zero <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="fu">c</span>(<span class="st">"BASE"</span>, <span class="fu">paste0</span>(<span class="st">"visit"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)))</span>
<span id="cb51-156"><a href="#cb51-156" aria-hidden="true" tabindex="-1"></a>simulated_data <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="at">n =</span> N,</span>
<span id="cb51-157"><a href="#cb51-157" aria-hidden="true" tabindex="-1"></a>                          <span class="at">mean =</span> zero,</span>
<span id="cb51-158"><a href="#cb51-158" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sigma =</span> cov_matrix) <span class="sc">%&gt;%</span></span>
<span id="cb51-159"><a href="#cb51-159" aria-hidden="true" tabindex="-1"></a>    <span class="co"># turn into tibble</span></span>
<span id="cb51-160"><a href="#cb51-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-161"><a href="#cb51-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply inclusion criteria and keep first Nf patients</span></span>
<span id="cb51-162"><a href="#cb51-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(BASE<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-163"><a href="#cb51-163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">&lt;=</span>Nf) <span class="sc">%&gt;%</span></span>
<span id="cb51-164"><a href="#cb51-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign subject ID, treatment group and create missing data</span></span>
<span id="cb51-165"><a href="#cb51-165" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">USUBJID =</span> <span class="fu">row_number</span>(),</span>
<span id="cb51-166"><a href="#cb51-166" aria-hidden="true" tabindex="-1"></a>           <span class="at">TRT01P =</span> <span class="fu">dqsample</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="dv">0</span>L, <span class="dv">10</span>L, <span class="dv">20</span>L, <span class="dv">40</span>L), <span class="at">size=</span>Nf, <span class="at">replace=</span>T),</span>
<span id="cb51-167"><a href="#cb51-167" aria-hidden="true" tabindex="-1"></a>           <span class="co"># Simulate dropouts</span></span>
<span id="cb51-168"><a href="#cb51-168" aria-hidden="true" tabindex="-1"></a>           <span class="at">dropp2 =</span> <span class="fu">plogis</span>(visit1<span class="dv">-2</span>),</span>
<span id="cb51-169"><a href="#cb51-169" aria-hidden="true" tabindex="-1"></a>           <span class="at">dropp3 =</span> <span class="fu">plogis</span>(visit2<span class="dv">-2</span>),</span>
<span id="cb51-170"><a href="#cb51-170" aria-hidden="true" tabindex="-1"></a>           <span class="at">dropp4 =</span> <span class="fu">plogis</span>(visit3<span class="dv">-2</span>),</span>
<span id="cb51-171"><a href="#cb51-171" aria-hidden="true" tabindex="-1"></a>           <span class="at">dropv =</span> <span class="fu">case_when</span>(<span class="fu">runif</span>(<span class="at">n=</span><span class="fu">n</span>())<span class="sc">&lt;</span>dropp2 <span class="sc">~</span> <span class="dv">2</span>L,</span>
<span id="cb51-172"><a href="#cb51-172" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">runif</span>(<span class="at">n=</span><span class="fu">n</span>())<span class="sc">&lt;</span>dropp3 <span class="sc">~</span> <span class="dv">3</span>L,</span>
<span id="cb51-173"><a href="#cb51-173" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">runif</span>(<span class="at">n=</span><span class="fu">n</span>())<span class="sc">&lt;</span>dropp4 <span class="sc">~</span> <span class="dv">4</span>L,</span>
<span id="cb51-174"><a href="#cb51-174" aria-hidden="true" tabindex="-1"></a>                             <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">5</span>L),</span>
<span id="cb51-175"><a href="#cb51-175" aria-hidden="true" tabindex="-1"></a>           <span class="at">visit2 =</span> <span class="fu">ifelse</span>(dropv<span class="sc">&lt;=</span><span class="dv">2</span>L, <span class="cn">NA_real_</span>, visit2),</span>
<span id="cb51-176"><a href="#cb51-176" aria-hidden="true" tabindex="-1"></a>           <span class="at">visit3 =</span> <span class="fu">ifelse</span>(dropv<span class="sc">&lt;=</span><span class="dv">3</span>L, <span class="cn">NA_real_</span>, visit3),</span>
<span id="cb51-177"><a href="#cb51-177" aria-hidden="true" tabindex="-1"></a>           <span class="at">visit4 =</span> <span class="fu">ifelse</span>(dropv<span class="sc">&lt;=</span><span class="dv">3</span>L, <span class="cn">NA_real_</span>, visit4)) <span class="sc">%&gt;%</span></span>
<span id="cb51-178"><a href="#cb51-178" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dropp2, <span class="sc">-</span>dropp3, <span class="sc">-</span>dropp4, <span class="sc">-</span>dropv) <span class="sc">%&gt;%</span></span>
<span id="cb51-179"><a href="#cb51-179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turn data into long-format</span></span>
<span id="cb51-180"><a href="#cb51-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">starts_with</span>(<span class="st">"visit"</span>), <span class="at">names_to =</span> <span class="st">"AVISIT"</span>, <span class="at">values_to=</span><span class="st">"AVAL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-181"><a href="#cb51-181" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb51-182"><a href="#cb51-182" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign visit days</span></span>
<span id="cb51-183"><a href="#cb51-183" aria-hidden="true" tabindex="-1"></a>        <span class="at">ADY =</span> <span class="fu">case_when</span>(AVISIT<span class="sc">==</span><span class="st">"visit1"</span> <span class="sc">~</span> <span class="dv">2</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb51-184"><a href="#cb51-184" aria-hidden="true" tabindex="-1"></a>                        AVISIT<span class="sc">==</span><span class="st">"visit2"</span> <span class="sc">~</span> <span class="dv">4</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb51-185"><a href="#cb51-185" aria-hidden="true" tabindex="-1"></a>                        AVISIT<span class="sc">==</span><span class="st">"visit3"</span> <span class="sc">~</span> <span class="dv">8</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb51-186"><a href="#cb51-186" aria-hidden="true" tabindex="-1"></a>                        AVISIT<span class="sc">==</span><span class="st">"visit4"</span> <span class="sc">~</span> <span class="dv">12</span>L<span class="sc">*</span><span class="dv">7</span>L),</span>
<span id="cb51-187"><a href="#cb51-187" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Turn to factor with defined order of visits</span></span>
<span id="cb51-188"><a href="#cb51-188" aria-hidden="true" tabindex="-1"></a>        <span class="at">AVISIT =</span> <span class="fu">factor</span>(AVISIT, <span class="fu">paste0</span>(<span class="st">"visit"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb51-189"><a href="#cb51-189" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assume rising treatment effect over time (half there by week 3) with an </span></span>
<span id="cb51-190"><a href="#cb51-190" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Emax dose response (ED50 = 5 mg)</span></span>
<span id="cb51-191"><a href="#cb51-191" aria-hidden="true" tabindex="-1"></a>        <span class="at">AVAL =</span> AVAL <span class="sc">+</span> <span class="fu">effect_course</span>(ADY<span class="sc">/</span><span class="dv">7</span>, TRT01P),</span>
<span id="cb51-192"><a href="#cb51-192" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Change from baseline = value - baseline</span></span>
<span id="cb51-193"><a href="#cb51-193" aria-hidden="true" tabindex="-1"></a>        <span class="at">CHG =</span> AVAL <span class="sc">-</span> BASE,</span>
<span id="cb51-194"><a href="#cb51-194" aria-hidden="true" tabindex="-1"></a>        <span class="at">TRT01P=</span><span class="fu">factor</span>(TRT01P)) <span class="sc">%&gt;%</span></span>
<span id="cb51-195"><a href="#cb51-195" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(USUBJID, TRT01P, AVISIT, ADY, AVAL, CHG, BASE) <span class="sc">%&gt;%</span></span>
<span id="cb51-196"><a href="#cb51-196" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Discard missing data</span></span>
<span id="cb51-197"><a href="#cb51-197" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(AVAL))</span>
<span id="cb51-198"><a href="#cb51-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-199"><a href="#cb51-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-200"><a href="#cb51-200" aria-hidden="true" tabindex="-1"></a>The first 10 rows of the simulated data set are:</span>
<span id="cb51-201"><a href="#cb51-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-202"><a href="#cb51-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r listing_of_data1,echo=FALSE}</span></span>
<span id="cb51-203"><a href="#cb51-203" aria-hidden="true" tabindex="-1"></a><span class="fu">gt_preview</span>(simulated_data, <span class="at">top_n=</span><span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">fmt_number</span>(<span class="fu">where</span>(is.double), <span class="at">decimals=</span><span class="dv">3</span>)</span>
<span id="cb51-204"><a href="#cb51-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-205"><a href="#cb51-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-206"><a href="#cb51-206" aria-hidden="true" tabindex="-1"></a>The assumed true change from baseline relationship in this simulation is:</span>
<span id="cb51-207"><a href="#cb51-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-208"><a href="#cb51-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot_of_truth,echo=FALSE}</span></span>
<span id="cb51-209"><a href="#cb51-209" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb51-210"><a href="#cb51-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show the code"</span></span>
<span id="cb51-211"><a href="#cb51-211" aria-hidden="true" tabindex="-1"></a><span class="fu">expand_grid</span>(<span class="at">ADY=</span><span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">12</span><span class="sc">*</span><span class="dv">7</span>, <span class="at">length=</span><span class="dv">51</span>),</span>
<span id="cb51-212"><a href="#cb51-212" aria-hidden="true" tabindex="-1"></a>            <span class="at">dose=</span><span class="fu">as.numeric</span>(<span class="fu">levels</span>(simulated_data<span class="sc">$</span>TRT01P))) <span class="sc">%&gt;%</span></span>
<span id="cb51-213"><a href="#cb51-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">CHG=</span><span class="fu">effect_course</span>(dose, ADY<span class="sc">/</span><span class="dv">7</span>),</span>
<span id="cb51-214"><a href="#cb51-214" aria-hidden="true" tabindex="-1"></a>           <span class="at">TRT01P=</span><span class="fu">factor</span>(dose)) <span class="sc">%&gt;%</span></span>
<span id="cb51-215"><a href="#cb51-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(ADY<span class="sc">/</span><span class="dv">7</span>, CHG, <span class="at">colour=</span>TRT01P)) <span class="sc">+</span></span>
<span id="cb51-216"><a href="#cb51-216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb51-217"><a href="#cb51-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">12</span>), <span class="at">linetype=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb51-218"><a href="#cb51-218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">12</span>)) <span class="sc">+</span></span>
<span id="cb51-219"><a href="#cb51-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)) <span class="sc">+</span></span>
<span id="cb51-220"><a href="#cb51-220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb51-221"><a href="#cb51-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Time since randomization [weeks]"</span>) <span class="sc">+</span></span>
<span id="cb51-222"><a href="#cb51-222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Simulated true change from baseline effect"</span>,</span>
<span id="cb51-223"><a href="#cb51-223" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Dashed lines mark observed visits"</span>)</span>
<span id="cb51-224"><a href="#cb51-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-225"><a href="#cb51-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-226"><a href="#cb51-226" aria-hidden="true" tabindex="-1"></a>The entire simulated data set with simulated residual noise in a</span>
<span id="cb51-227"><a href="#cb51-227" aria-hidden="true" tabindex="-1"></a>graphical representation looks like:</span>
<span id="cb51-228"><a href="#cb51-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-229"><a href="#cb51-229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot_of_data1,echo=FALSE, fig.height=7, fig.width=8}</span></span>
<span id="cb51-230"><a href="#cb51-230" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb51-231"><a href="#cb51-231" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show the code"</span></span>
<span id="cb51-232"><a href="#cb51-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-233"><a href="#cb51-233" aria-hidden="true" tabindex="-1"></a>comb_simulated_data <span class="ot">&lt;-</span> simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb51-234"><a href="#cb51-234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb51-235"><a href="#cb51-235" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(USUBJID) <span class="sc">%&gt;%</span></span>
<span id="cb51-236"><a href="#cb51-236" aria-hidden="true" tabindex="-1"></a>              <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-237"><a href="#cb51-237" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">AVISIT=</span><span class="st">"Baseline"</span>, <span class="at">ADY=</span><span class="dv">0</span>, <span class="at">CHG=</span><span class="dv">0</span>, <span class="at">AVAL=</span>BASE)</span>
<span id="cb51-238"><a href="#cb51-238" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span></span>
<span id="cb51-239"><a href="#cb51-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(USUBJID, ADY)</span>
<span id="cb51-240"><a href="#cb51-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-241"><a href="#cb51-241" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span>  comb_simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb51-242"><a href="#cb51-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AVISIT, <span class="at">y=</span>AVAL, <span class="at">col=</span>TRT01P)) <span class="sc">+</span></span>
<span id="cb51-243"><a href="#cb51-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">height=</span><span class="dv">0</span>, <span class="at">width=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb51-244"><a href="#cb51-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)) <span class="sc">+</span></span>
<span id="cb51-245"><a href="#cb51-245" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb51-246"><a href="#cb51-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb51-247"><a href="#cb51-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>,</span>
<span id="cb51-248"><a href="#cb51-248" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb51-249"><a href="#cb51-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="cn">NULL</span>)</span>
<span id="cb51-250"><a href="#cb51-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-251"><a href="#cb51-251" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> comb_simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb51-252"><a href="#cb51-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AVISIT, <span class="at">y=</span>CHG, <span class="at">fill=</span>TRT01P)) <span class="sc">+</span></span>
<span id="cb51-253"><a href="#cb51-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb51-254"><a href="#cb51-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">alpha=</span><span class="fl">0.4</span>, <span class="at">size=</span><span class="fl">0.65</span>, <span class="at">col=</span><span class="st">"black"</span>, <span class="at">shape=</span><span class="dv">22</span>, </span>
<span id="cb51-255"><a href="#cb51-255" aria-hidden="true" tabindex="-1"></a>             <span class="at">position=</span><span class="fu">position_jitterdodge</span>(<span class="at">dodge.width=</span><span class="fl">0.75</span>, </span>
<span id="cb51-256"><a href="#cb51-256" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">jitter.width=</span><span class="fl">0.2</span>, <span class="at">jitter.height=</span><span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb51-257"><a href="#cb51-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.alpha =</span> <span class="dv">0</span>, <span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb51-258"><a href="#cb51-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)) <span class="sc">+</span></span>
<span id="cb51-259"><a href="#cb51-259" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">2.5</span>, <span class="fl">2.5</span>)) <span class="sc">+</span> </span>
<span id="cb51-260"><a href="#cb51-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb51-261"><a href="#cb51-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb51-262"><a href="#cb51-262" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x=</span><span class="fu">element_blank</span>())</span>
<span id="cb51-263"><a href="#cb51-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-264"><a href="#cb51-264" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">bayesplot_grid</span>(p2, p1)</span>
<span id="cb51-265"><a href="#cb51-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-266"><a href="#cb51-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-267"><a href="#cb51-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-268"><a href="#cb51-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-269"><a href="#cb51-269" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model description</span></span>
<span id="cb51-270"><a href="#cb51-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-271"><a href="#cb51-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-272"><a href="#cb51-272" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Mixed Model for Repeated Measures (MMRM)</span></span>
<span id="cb51-273"><a href="#cb51-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-274"><a href="#cb51-274" aria-hidden="true" tabindex="-1"></a>The <span class="co">[</span><span class="ot">Mixed Model for Repeated Measures (MMRM)</span><span class="co">](https://doi.org/10.1177/009286150804200402)</span> </span>
<span id="cb51-275"><a href="#cb51-275" aria-hidden="true" tabindex="-1"></a>is a very popular model for continuous endpoints assessed at multiple visits (or </span>
<span id="cb51-276"><a href="#cb51-276" aria-hidden="true" tabindex="-1"></a>their change from a pre-treatment baseline value). Part of its popularity stems</span>
<span id="cb51-277"><a href="#cb51-277" aria-hidden="true" tabindex="-1"></a>from the fact that it is a flexible model for an outcome measured at different</span>
<span id="cb51-278"><a href="#cb51-278" aria-hidden="true" tabindex="-1"></a>visits that accounts for within patient correlation and can handle missing data</span>
<span id="cb51-279"><a href="#cb51-279" aria-hidden="true" tabindex="-1"></a>without imputation (if you are interested in the right estimand). In particular,</span>
<span id="cb51-280"><a href="#cb51-280" aria-hidden="true" tabindex="-1"></a>it was a major milestone for treating missing data and drop-outs more </span>
<span id="cb51-281"><a href="#cb51-281" aria-hidden="true" tabindex="-1"></a>appropriately than via last-observation-carried-forward (LOCF), which lead to it</span>
<span id="cb51-282"><a href="#cb51-282" aria-hidden="true" tabindex="-1"></a>being <span class="co">[</span><span class="ot">recommended by some as a default analysis approach for a hypothetical estimand</span><span class="co">](https://doi.org/10.1177/009286150804200402)</span>.</span>
<span id="cb51-283"><a href="#cb51-283" aria-hidden="true" tabindex="-1"></a>Another contributing factor to MMRM's success in the pharmaceutical industry is </span>
<span id="cb51-284"><a href="#cb51-284" aria-hidden="true" tabindex="-1"></a>that it can be fit using restricted maximum likelihood (REML) with standard </span>
<span id="cb51-285"><a href="#cb51-285" aria-hidden="true" tabindex="-1"></a>software. </span>
<span id="cb51-286"><a href="#cb51-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-287"><a href="#cb51-287" aria-hidden="true" tabindex="-1"></a>A widely used default analysis is to have the following (fixed </span>
<span id="cb51-288"><a href="#cb51-288" aria-hidden="true" tabindex="-1"></a>effects) model terms</span>
<span id="cb51-289"><a href="#cb51-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-290"><a href="#cb51-290" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>visit as a factor,</span>
<span id="cb51-291"><a href="#cb51-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-292"><a href="#cb51-292" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>treatment as a factor,</span>
<span id="cb51-293"><a href="#cb51-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-294"><a href="#cb51-294" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>treatment by visit interaction,</span>
<span id="cb51-295"><a href="#cb51-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-296"><a href="#cb51-296" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>baseline (pre-treatment) value of the continuous endpoint as a continuous covariate, and</span>
<span id="cb51-297"><a href="#cb51-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-298"><a href="#cb51-298" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>visit by baseline value interaction.</span>
<span id="cb51-299"><a href="#cb51-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-300"><a href="#cb51-300" aria-hidden="true" tabindex="-1"></a>These terms allow for a flexible time course in the control group, as well as </span>
<span id="cb51-301"><a href="#cb51-301" aria-hidden="true" tabindex="-1"></a>different treatment effects at different visits on top of that. Additionally, </span>
<span id="cb51-302"><a href="#cb51-302" aria-hidden="true" tabindex="-1"></a>adjustment for baseline values usually reduces standard errors in clinical </span>
<span id="cb51-303"><a href="#cb51-303" aria-hidden="true" tabindex="-1"></a>trials. By allowing for a visit by baseline interaction we allow the </span>
<span id="cb51-304"><a href="#cb51-304" aria-hidden="true" tabindex="-1"></a>relationship between the values at each visit and the baseline to differ. </span>
<span id="cb51-305"><a href="#cb51-305" aria-hidden="true" tabindex="-1"></a>This reflects that the longer ago a baseline value was measured, the less it </span>
<span id="cb51-306"><a href="#cb51-306" aria-hidden="true" tabindex="-1"></a>will typically be correlated with future measurements.</span>
<span id="cb51-307"><a href="#cb51-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-308"><a href="#cb51-308" aria-hidden="true" tabindex="-1"></a>Where a MMRM differs from a linear model is that the residuals from</span>
<span id="cb51-309"><a href="#cb51-309" aria-hidden="true" tabindex="-1"></a>different visits of the same patient are assumed to be correlated. We</span>
<span id="cb51-310"><a href="#cb51-310" aria-hidden="true" tabindex="-1"></a>do not usually wish to restrict this correlation structure to be of a</span>
<span id="cb51-311"><a href="#cb51-311" aria-hidden="true" tabindex="-1"></a>particular form (such as first-order autoregressive AR(1)), but to</span>
<span id="cb51-312"><a href="#cb51-312" aria-hidden="true" tabindex="-1"></a>allow it to be of an "unstructured" form.  This is preferable over</span>
<span id="cb51-313"><a href="#cb51-313" aria-hidden="true" tabindex="-1"></a>simpler structures like first-order autoregressive AR(1), for</span>
<span id="cb51-314"><a href="#cb51-314" aria-hidden="true" tabindex="-1"></a>example. For example, AR(1) assumes a constant correlation between any</span>
<span id="cb51-315"><a href="#cb51-315" aria-hidden="true" tabindex="-1"></a>adjacent visits while raising this correlation to a power for more</span>
<span id="cb51-316"><a href="#cb51-316" aria-hidden="true" tabindex="-1"></a>distant observations. This simple correlation structure may</span>
<span id="cb51-317"><a href="#cb51-317" aria-hidden="true" tabindex="-1"></a>inappropriately model these distant observations for a single patient as</span>
<span id="cb51-318"><a href="#cb51-318" aria-hidden="true" tabindex="-1"></a>almost fully independent resulting in inappropriately small standard errors.</span>
<span id="cb51-319"><a href="#cb51-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-320"><a href="#cb51-320" aria-hidden="true" tabindex="-1"></a><span class="fu">### Formal specification of MMRM</span></span>
<span id="cb51-321"><a href="#cb51-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-322"><a href="#cb51-322" aria-hidden="true" tabindex="-1"></a>Formally, let us assume that there are $V$ visits. We usually assume that the </span>
<span id="cb51-323"><a href="#cb51-323" aria-hidden="true" tabindex="-1"></a>$V$-dimensional response $\boldsymbol{Y}_i$ for patient $i$ satisfies</span>
<span id="cb51-324"><a href="#cb51-324" aria-hidden="true" tabindex="-1"></a>$$\boldsymbol{Y}_i = \boldsymbol{X}_i \boldsymbol{\beta} + \boldsymbol{Z}_i \boldsymbol{b}_i + \boldsymbol{\epsilon}_i,$$</span>
<span id="cb51-325"><a href="#cb51-325" aria-hidden="true" tabindex="-1"></a>where $\boldsymbol{\beta}$ is a vector of regression coefficients </span>
<span id="cb51-326"><a href="#cb51-326" aria-hidden="true" tabindex="-1"></a>for fixed effects, the </span>
<span id="cb51-327"><a href="#cb51-327" aria-hidden="true" tabindex="-1"></a>$\boldsymbol{b}_i \sim \text{MVN}(\boldsymbol{0}, \boldsymbol{D})$ are </span>
<span id="cb51-328"><a href="#cb51-328" aria-hidden="true" tabindex="-1"></a>random effects with the vector $\boldsymbol{Z}_i$ indicating which one applies</span>
<span id="cb51-329"><a href="#cb51-329" aria-hidden="true" tabindex="-1"></a>for which component (each corresponding to a visit) of the response, and the </span>
<span id="cb51-330"><a href="#cb51-330" aria-hidden="true" tabindex="-1"></a>$\boldsymbol{\epsilon}_i \sim \text{MVN}(\boldsymbol{0}, \boldsymbol{\Sigma})$</span>
<span id="cb51-331"><a href="#cb51-331" aria-hidden="true" tabindex="-1"></a>are residual errors. Then,</span>
<span id="cb51-332"><a href="#cb51-332" aria-hidden="true" tabindex="-1"></a>$$\boldsymbol{Y}_i \sim \text{MVN}(\boldsymbol{X}_i \boldsymbol{\beta}, \boldsymbol{V}_i),$$</span>
<span id="cb51-333"><a href="#cb51-333" aria-hidden="true" tabindex="-1"></a>where </span>
<span id="cb51-334"><a href="#cb51-334" aria-hidden="true" tabindex="-1"></a>$$\boldsymbol{V}_i = \boldsymbol{Z}_i \boldsymbol{D} \boldsymbol{Z}_i^T + \boldsymbol{\Sigma}.$$</span>
<span id="cb51-335"><a href="#cb51-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-336"><a href="#cb51-336" aria-hidden="true" tabindex="-1"></a>With the goal to avoid unnnecessary assumptions, the marginal</span>
<span id="cb51-337"><a href="#cb51-337" aria-hidden="true" tabindex="-1"></a>covariance matrix $\boldsymbol{V}_i$ is usually kept</span>
<span id="cb51-338"><a href="#cb51-338" aria-hidden="true" tabindex="-1"></a>“unstructured”. I.e. we usually want to avoid imposing any particular</span>
<span id="cb51-339"><a href="#cb51-339" aria-hidden="true" tabindex="-1"></a>structure on the covariance matrix. However, an unstructured</span>
<span id="cb51-340"><a href="#cb51-340" aria-hidden="true" tabindex="-1"></a>covariance matrix requires to inform potentially many parameters which</span>
<span id="cb51-341"><a href="#cb51-341" aria-hidden="true" tabindex="-1"></a>grow exponentially fast in the number of visits $V$. Modeling the</span>
<span id="cb51-342"><a href="#cb51-342" aria-hidden="true" tabindex="-1"></a>covariance matrix as a structured correlation matrix and by visit</span>
<span id="cb51-343"><a href="#cb51-343" aria-hidden="true" tabindex="-1"></a>residual error standard deviations may facilitate stabilizing fitting</span>
<span id="cb51-344"><a href="#cb51-344" aria-hidden="true" tabindex="-1"></a>procedures.</span>
<span id="cb51-345"><a href="#cb51-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-346"><a href="#cb51-346" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--- we have "V" visits and a V_i covariance matrix here... can we ---&gt;</span></span>
<span id="cb51-347"><a href="#cb51-347" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--- relabel one of these? Maybe make V_i =&gt; \Omega_i? Or make V_i to ---&gt;</span></span>
<span id="cb51-348"><a href="#cb51-348" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--- be n_i, just like in the paper you cite? ---&gt;</span></span>
<span id="cb51-349"><a href="#cb51-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-350"><a href="#cb51-350" aria-hidden="true" tabindex="-1"></a><span class="fu">### What estimand does MMRM address?</span></span>
<span id="cb51-351"><a href="#cb51-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-352"><a href="#cb51-352" aria-hidden="true" tabindex="-1"></a>MMRM </span>
<span id="cb51-353"><a href="#cb51-353" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">can address a hypothetical estimand</span><span class="co">](https://www.psiweb.org/docs/default-source/resources/psi-subgroups/scientific/2015/estimands-28-09-2015/jamesroger.pdf)</span> </span>
<span id="cb51-354"><a href="#cb51-354" aria-hidden="true" tabindex="-1"></a>about a continuous variable at one or more visits "as if all patients had </span>
<span id="cb51-355"><a href="#cb51-355" aria-hidden="true" tabindex="-1"></a>remained on treatment to the end of the planned treatment period". </span>
<span id="cb51-356"><a href="#cb51-356" aria-hidden="true" tabindex="-1"></a>This is done by applying MMRM to on-treatment data </span>
<span id="cb51-357"><a href="#cb51-357" aria-hidden="true" tabindex="-1"></a>only and making the assumption that stopping treatment or leaving the study</span>
<span id="cb51-358"><a href="#cb51-358" aria-hidden="true" tabindex="-1"></a>occurs at random conditional on the preceding observations and the covariates </span>
<span id="cb51-359"><a href="#cb51-359" aria-hidden="true" tabindex="-1"></a>being included in the model ("missing at random" or MAR).</span>
<span id="cb51-360"><a href="#cb51-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-361"><a href="#cb51-361" aria-hidden="true" tabindex="-1"></a>One key attractive feature is that MMRM estimates this estimand</span>
<span id="cb51-362"><a href="#cb51-362" aria-hidden="true" tabindex="-1"></a>without us needing to directly impute any data. I.e. there is no need</span>
<span id="cb51-363"><a href="#cb51-363" aria-hidden="true" tabindex="-1"></a>for multiple imputation and fitting the model to each imputation,</span>
<span id="cb51-364"><a href="#cb51-364" aria-hidden="true" tabindex="-1"></a>instead we only need to fit MMRM to the on-treatment data under</span>
<span id="cb51-365"><a href="#cb51-365" aria-hidden="true" tabindex="-1"></a>analysis once. However, note that if there are no post-baseline</span>
<span id="cb51-366"><a href="#cb51-366" aria-hidden="true" tabindex="-1"></a>observations for a patient the model will exclude the patient from the</span>
<span id="cb51-367"><a href="#cb51-367" aria-hidden="true" tabindex="-1"></a>analysis, which is a valid thing to do under the MAR assumption.</span>
<span id="cb51-368"><a href="#cb51-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-369"><a href="#cb51-369" aria-hidden="true" tabindex="-1"></a>Nevertheless, it produces identical results as if we had created a</span>
<span id="cb51-370"><a href="#cb51-370" aria-hidden="true" tabindex="-1"></a>large number of multiple imputations, ran the model and then combined</span>
<span id="cb51-371"><a href="#cb51-371" aria-hidden="true" tabindex="-1"></a>the results.</span>
<span id="cb51-372"><a href="#cb51-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-373"><a href="#cb51-373" aria-hidden="true" tabindex="-1"></a>If we wish to target different estimands or make different assumptions than</span>
<span id="cb51-374"><a href="#cb51-374" aria-hidden="true" tabindex="-1"></a>implied by the MMRM, we would need to impute prior to fitting a MMRM. If we </span>
<span id="cb51-375"><a href="#cb51-375" aria-hidden="true" tabindex="-1"></a>perform multiple imputation, fitting a MMRM becomes unnecessary, because </span>
<span id="cb51-376"><a href="#cb51-376" aria-hidden="true" tabindex="-1"></a>when all patients have (non-missing) data at all visits that should enter</span>
<span id="cb51-377"><a href="#cb51-377" aria-hidden="true" tabindex="-1"></a>the analysis (i.e. is directly assessing our estimand of interest), then fitting</span>
<span id="cb51-378"><a href="#cb51-378" aria-hidden="true" tabindex="-1"></a>a MMRM (with both treatment group and all baseline covariates have an </span>
<span id="cb51-379"><a href="#cb51-379" aria-hidden="true" tabindex="-1"></a>interaction with visit) is equivalent to separately fitting a linear regression </span>
<span id="cb51-380"><a href="#cb51-380" aria-hidden="true" tabindex="-1"></a>model for each visit.</span>
<span id="cb51-381"><a href="#cb51-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-382"><a href="#cb51-382" aria-hidden="true" tabindex="-1"></a><span class="fu">### Is MMRM only good for one variable across visits?</span></span>
<span id="cb51-383"><a href="#cb51-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-384"><a href="#cb51-384" aria-hidden="true" tabindex="-1"></a>There is nothing that requires the separate observations being modeled by a </span>
<span id="cb51-385"><a href="#cb51-385" aria-hidden="true" tabindex="-1"></a>MMRM to be measurements of the same variable across time. You can just as </span>
<span id="cb51-386"><a href="#cb51-386" aria-hidden="true" tabindex="-1"></a>appropriately apply MMRM to multiple outcomes measured at the same time, or </span>
<span id="cb51-387"><a href="#cb51-387" aria-hidden="true" tabindex="-1"></a>across multiple occasions. This can be helpful when missingness or data becoming</span>
<span id="cb51-388"><a href="#cb51-388" aria-hidden="true" tabindex="-1"></a>irrelevant to the estimand of interest depends on multiple variables.</span>
<span id="cb51-389"><a href="#cb51-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-390"><a href="#cb51-390" aria-hidden="true" tabindex="-1"></a>An example would be a diabetes study, where both fasting plasma glucose (FPG) </span>
<span id="cb51-391"><a href="#cb51-391" aria-hidden="true" tabindex="-1"></a>and glycated hemoglobin (HbA1c) are measured at each visit, and rescue </span>
<span id="cb51-392"><a href="#cb51-392" aria-hidden="true" tabindex="-1"></a>medication is initiated when either of the two is above some threshold. In order </span>
<span id="cb51-393"><a href="#cb51-393" aria-hidden="true" tabindex="-1"></a>to estimate the hypothetical estimand for the HbA1c difference "as if no rescue </span>
<span id="cb51-394"><a href="#cb51-394" aria-hidden="true" tabindex="-1"></a>medication had been taken", you can jointly model FPG and HbA1c.</span>
<span id="cb51-395"><a href="#cb51-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-396"><a href="#cb51-396" aria-hidden="true" tabindex="-1"></a><span class="fu">### Should we use the baseline measurement as a covariate or an extra observation?</span></span>
<span id="cb51-397"><a href="#cb51-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-398"><a href="#cb51-398" aria-hidden="true" tabindex="-1"></a>For some patients all post-baseline assessments will be missing,</span>
<span id="cb51-399"><a href="#cb51-399" aria-hidden="true" tabindex="-1"></a>additionally some patients may not have a baseline assessment. In this</span>
<span id="cb51-400"><a href="#cb51-400" aria-hidden="true" tabindex="-1"></a>situation (unless we somehow impute these data), the MMRM model we</span>
<span id="cb51-401"><a href="#cb51-401" aria-hidden="true" tabindex="-1"></a>described cannot include such a patient in the analysis.</span>
<span id="cb51-402"><a href="#cb51-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-403"><a href="#cb51-403" aria-hidden="true" tabindex="-1"></a>One potential idea for dealing with this situation is to use the baseline </span>
<span id="cb51-404"><a href="#cb51-404" aria-hidden="true" tabindex="-1"></a>assessment not as a covariate, but as an extra observation. </span>
<span id="cb51-405"><a href="#cb51-405" aria-hidden="true" tabindex="-1"></a>I.e. there is an additional baseline record for each patient, but the baseline</span>
<span id="cb51-406"><a href="#cb51-406" aria-hidden="true" tabindex="-1"></a>term, as well as the baseline by visit interaction terms are removed from the </span>
<span id="cb51-407"><a href="#cb51-407" aria-hidden="true" tabindex="-1"></a>model.</span>
<span id="cb51-408"><a href="#cb51-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-409"><a href="#cb51-409" aria-hidden="true" tabindex="-1"></a>This is a reasonable approach, if the residuals across visits are jointly</span>
<span id="cb51-410"><a href="#cb51-410" aria-hidden="true" tabindex="-1"></a>multivariate normal, which we are already assuming for the post-baseline visits.</span>
<span id="cb51-411"><a href="#cb51-411" aria-hidden="true" tabindex="-1"></a>However, this can be a problematic assumption to make when inclusion criteria</span>
<span id="cb51-412"><a href="#cb51-412" aria-hidden="true" tabindex="-1"></a>are applied at baseline that lead to the residuals for the baseline assessment </span>
<span id="cb51-413"><a href="#cb51-413" aria-hidden="true" tabindex="-1"></a>not following a normal distribution. Such an inclusion criterion could be on </span>
<span id="cb51-414"><a href="#cb51-414" aria-hidden="true" tabindex="-1"></a>the variable under analysis itself, or it could be on a variable that is </span>
<span id="cb51-415"><a href="#cb51-415" aria-hidden="true" tabindex="-1"></a>sufficiently strongly correlated with the analysis variable to deform its </span>
<span id="cb51-416"><a href="#cb51-416" aria-hidden="true" tabindex="-1"></a>distribution.</span>
<span id="cb51-417"><a href="#cb51-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-418"><a href="#cb51-418" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--- Are there papers suggesting that this is really giving --&gt;</span></span>
<span id="cb51-419"><a href="#cb51-419" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--reasonable power and the like? As I understand, you would drop the --&gt;</span></span>
<span id="cb51-420"><a href="#cb51-420" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--baseline value as a covariate from the model, which would surprise --&gt;</span></span>
<span id="cb51-421"><a href="#cb51-421" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--me by now to be a good idea whenever we want to analyze any given --&gt;</span></span>
<span id="cb51-422"><a href="#cb51-422" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--data-set. I'd expect that this leads to a power-loss and --&gt;</span></span>
<span id="cb51-423"><a href="#cb51-423" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--conditioning on the baseline value is crucial. Maybe we drop this --&gt;</span></span>
<span id="cb51-424"><a href="#cb51-424" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--section to avoid the issues of including baseline values as --&gt;</span></span>
<span id="cb51-425"><a href="#cb51-425" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--covariate or outcome? --&gt;</span></span>
<span id="cb51-426"><a href="#cb51-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-427"><a href="#cb51-427" aria-hidden="true" tabindex="-1"></a><span class="fu">### How is MMRM different from a mixed effects model with a random subject effect on the intercept?</span></span>
<span id="cb51-428"><a href="#cb51-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-429"><a href="#cb51-429" aria-hidden="true" tabindex="-1"></a>A mixed (random) effects model with a random subject effect on the intercept</span>
<span id="cb51-430"><a href="#cb51-430" aria-hidden="true" tabindex="-1"></a>effectively assumes that the residuals for all visits are equally strongly </span>
<span id="cb51-431"><a href="#cb51-431" aria-hidden="true" tabindex="-1"></a>correlated ("compound symmetric covariance structure", see next subsection) and </span>
<span id="cb51-432"><a href="#cb51-432" aria-hidden="true" tabindex="-1"></a>also that the standard deviation is the same across visits (although <span class="in">`brms`</span> </span>
<span id="cb51-433"><a href="#cb51-433" aria-hidden="true" tabindex="-1"></a>would let us avoid this by using distributional regression as discussed later). </span>
<span id="cb51-434"><a href="#cb51-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-435"><a href="#cb51-435" aria-hidden="true" tabindex="-1"></a><span class="fu">### What covariance structure to use?</span></span>
<span id="cb51-436"><a href="#cb51-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-437"><a href="#cb51-437" aria-hidden="true" tabindex="-1"></a>There are several options for the covariance structures we can use</span>
<span id="cb51-438"><a href="#cb51-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-439"><a href="#cb51-439" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The standard deviation will usually go up over time in RCTs. This </span>
<span id="cb51-440"><a href="#cb51-440" aria-hidden="true" tabindex="-1"></a>occurs in part because the trial population was originally forced to be somewhat </span>
<span id="cb51-441"><a href="#cb51-441" aria-hidden="true" tabindex="-1"></a>homogenous at baseline by the trial inclusion criteria. The further we move</span>
<span id="cb51-442"><a href="#cb51-442" aria-hidden="true" tabindex="-1"></a>away from that point in time the more heterogenous outcomes will become across </span>
<span id="cb51-443"><a href="#cb51-443" aria-hidden="true" tabindex="-1"></a>patients. Thus, we at least want to allow the variability to differ between </span>
<span id="cb51-444"><a href="#cb51-444" aria-hidden="true" tabindex="-1"></a>visits.</span>
<span id="cb51-445"><a href="#cb51-445" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Data from visits that are closer in time to each other tend to be more highly</span>
<span id="cb51-446"><a href="#cb51-446" aria-hidden="true" tabindex="-1"></a>correlated. Thus, a compound symmetric covariance structure that makes all</span>
<span id="cb51-447"><a href="#cb51-447" aria-hidden="true" tabindex="-1"></a>visits equally correlated will not be realistic, but may sometimes be a </span>
<span id="cb51-448"><a href="#cb51-448" aria-hidden="true" tabindex="-1"></a>reasonable approximation.</span>
<span id="cb51-449"><a href="#cb51-449" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>The correlation between visits of a patient usually never drops to</span>
<span id="cb51-450"><a href="#cb51-450" aria-hidden="true" tabindex="-1"></a>zero even if visits are months or years apart. Generally, assuming a</span>
<span id="cb51-451"><a href="#cb51-451" aria-hidden="true" tabindex="-1"></a>correlation structure that substantially underestimates the</span>
<span id="cb51-452"><a href="#cb51-452" aria-hidden="true" tabindex="-1"></a>correlation between some visits potentially does the most harm. In</span>
<span id="cb51-453"><a href="#cb51-453" aria-hidden="true" tabindex="-1"></a>particular, an AR(1) correlation structure should in practice be</span>
<span id="cb51-454"><a href="#cb51-454" aria-hidden="true" tabindex="-1"></a>avoided as it leads to exponentially fast diminishing correlations</span>
<span id="cb51-455"><a href="#cb51-455" aria-hidden="true" tabindex="-1"></a>between visits.</span>
<span id="cb51-456"><a href="#cb51-456" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>It is most common to use MMRM with a completely unstructured covariance </span>
<span id="cb51-457"><a href="#cb51-457" aria-hidden="true" tabindex="-1"></a>structure across visits and we often even allow it to differ by treatment group.</span>
<span id="cb51-458"><a href="#cb51-458" aria-hidden="true" tabindex="-1"></a>This avoids making (potentially unnecessary) assumptions. It also ensures the </span>
<span id="cb51-459"><a href="#cb51-459" aria-hidden="true" tabindex="-1"></a>equivalence between MMRM and a by-visit-analysis in the absence of missing data.</span>
<span id="cb51-460"><a href="#cb51-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-461"><a href="#cb51-461" aria-hidden="true" tabindex="-1"></a>As an illustration of what covariance matrices look like in practice, here</span>
<span id="cb51-462"><a href="#cb51-462" aria-hidden="true" tabindex="-1"></a>is the estimated covariance structure reported by </span>
<span id="cb51-463"><a href="#cb51-463" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Holzhauer et al. 2015</span><span class="co">](https://doi.org/10.1002/pst.1705)</span> for the fasting </span>
<span id="cb51-464"><a href="#cb51-464" aria-hidden="true" tabindex="-1"></a>plasma glucose (FPG) values from one treatment group of a diabetes</span>
<span id="cb51-465"><a href="#cb51-465" aria-hidden="true" tabindex="-1"></a>trial.</span>
<span id="cb51-466"><a href="#cb51-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-467"><a href="#cb51-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fpgcov_example, echo=FALSE}</span></span>
<span id="cb51-468"><a href="#cb51-468" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb51-469"><a href="#cb51-469" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show the code"</span></span>
<span id="cb51-470"><a href="#cb51-470" aria-hidden="true" tabindex="-1"></a>fpg_cov <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb51-471"><a href="#cb51-471" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 0</span><span class="st">`</span> <span class="ot">=</span>  <span class="fu">c</span>(<span class="fl">7.68</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">7</span>)),</span>
<span id="cb51-472"><a href="#cb51-472" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 4</span><span class="st">`</span> <span class="ot">=</span>  <span class="fu">c</span>(<span class="fl">4.00</span>, <span class="fl">6.60</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">6</span>)),</span>
<span id="cb51-473"><a href="#cb51-473" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 12</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">3.55</span>, <span class="fl">4.51</span>, <span class="fl">6.52</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">5</span>)),</span>
<span id="cb51-474"><a href="#cb51-474" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 16</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">3.03</span>, <span class="fl">3.83</span>, <span class="fl">5.02</span>, <span class="fl">6.90</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">4</span>)),</span>
<span id="cb51-475"><a href="#cb51-475" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 24</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">3.32</span>, <span class="fl">4.00</span>, <span class="fl">4.29</span>, <span class="fl">4.42</span>, <span class="fl">6.20</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">3</span>)),</span>
<span id="cb51-476"><a href="#cb51-476" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 32</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">3.06</span>, <span class="fl">3.22</span>, <span class="fl">3.72</span>, <span class="fl">4.23</span>, <span class="fl">4.45</span>, <span class="fl">5.73</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">2</span>)),</span>
<span id="cb51-477"><a href="#cb51-477" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 40</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">3.60</span>, <span class="fl">3.74</span>, <span class="fl">4.66</span>, <span class="fl">5.10</span>, <span class="fl">4.80</span>, <span class="fl">5.30</span>, <span class="fl">7.80</span>, <span class="cn">NA_real_</span>),</span>
<span id="cb51-478"><a href="#cb51-478" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 52</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">3.60</span>, <span class="fl">3.44</span>, <span class="fl">4.48</span>, <span class="fl">4.53</span>, <span class="fl">4.67</span>, <span class="fl">5.16</span>, <span class="fl">6.26</span>, <span class="fl">8.51</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-479"><a href="#cb51-479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-480"><a href="#cb51-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-481"><a href="#cb51-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames=</span><span class="st">"Visit"</span>,</span>
<span id="cb51-482"><a href="#cb51-482" aria-hidden="true" tabindex="-1"></a>            <span class="at">.name_repair =</span> <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"V"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x)))</span>
<span id="cb51-483"><a href="#cb51-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-484"><a href="#cb51-484" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(fpg_cov) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Visit"</span>, <span class="fu">paste0</span>(<span class="st">"Week "</span>, <span class="fu">c</span>(<span class="dv">0</span>L, <span class="dv">4</span>L, <span class="dv">12</span>L, <span class="dv">16</span>L, <span class="dv">24</span>L, <span class="dv">32</span>L, <span class="dv">40</span>L, <span class="dv">52</span>L)))</span>
<span id="cb51-485"><a href="#cb51-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-486"><a href="#cb51-486" aria-hidden="true" tabindex="-1"></a>fpg_cov <span class="sc">%&gt;%</span></span>
<span id="cb51-487"><a href="#cb51-487" aria-hidden="true" tabindex="-1"></a>   <span class="fu">gt</span>() <span class="sc">%&gt;%</span> <span class="co">#groupname_col="Week"</span></span>
<span id="cb51-488"><a href="#cb51-488" aria-hidden="true" tabindex="-1"></a>  <span class="co">#fmt_missing(is.numeric, missing_text="---") %&gt;% ## sub_missing is the new function for gt &gt;=0.8.0</span></span>
<span id="cb51-489"><a href="#cb51-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Example of a covariance matrix for fasting plasma glucose in diabetic patients**"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-490"><a href="#cb51-490" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sub_missing(missing_text = " ") %&gt;% # commented out due to outdated gt version on system</span></span>
<span id="cb51-491"><a href="#cb51-491" aria-hidden="true" tabindex="-1"></a>    <span class="fu">opt_row_striping</span>(<span class="at">row_striping =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-492"><a href="#cb51-492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(<span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="st">"darkgrey"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb51-493"><a href="#cb51-493" aria-hidden="true" tabindex="-1"></a>            <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb51-494"><a href="#cb51-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(<span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="st">"darkgrey"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb51-495"><a href="#cb51-495" aria-hidden="true" tabindex="-1"></a>            <span class="at">locations =</span> <span class="fu">cells_body</span>(<span class="at">columns =</span> <span class="st">"Visit"</span>))</span>
<span id="cb51-496"><a href="#cb51-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-497"><a href="#cb51-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-498"><a href="#cb51-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-499"><a href="#cb51-499" aria-hidden="true" tabindex="-1"></a>In terms of longer term data, </span>
<span id="cb51-500"><a href="#cb51-500" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Holzhauer 2014</span><span class="co">](https://doi.org/10.1080/19466315.2013.861766)</span> reported that in</span>
<span id="cb51-501"><a href="#cb51-501" aria-hidden="true" tabindex="-1"></a>a RCT in pre-diabetic patients the correlation matrix for FPG could be </span>
<span id="cb51-502"><a href="#cb51-502" aria-hidden="true" tabindex="-1"></a>well described by the numbers in the table below and that "during the first</span>
<span id="cb51-503"><a href="#cb51-503" aria-hidden="true" tabindex="-1"></a>3 years of the study, the variance appeared to be relatively constant around </span>
<span id="cb51-504"><a href="#cb51-504" aria-hidden="true" tabindex="-1"></a>0.68, but there was some indication of an increasing variability in years 3–6."</span>
<span id="cb51-505"><a href="#cb51-505" aria-hidden="true" tabindex="-1"></a>Unlike the numbers in diabetic patients, these numbers come from a model</span>
<span id="cb51-506"><a href="#cb51-506" aria-hidden="true" tabindex="-1"></a>adjusting for the baseline FPG assessment.</span>
<span id="cb51-507"><a href="#cb51-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-508"><a href="#cb51-508" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fpgprediab_example, echo=FALSE, eval = FALSE}</span></span>
<span id="cb51-509"><a href="#cb51-509" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb51-510"><a href="#cb51-510" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show the code"</span></span>
<span id="cb51-511"><a href="#cb51-511" aria-hidden="true" tabindex="-1"></a><span class="fu">expand_grid</span>(<span class="at">i=</span><span class="fu">seq</span>(<span class="fl">0.5</span>, <span class="fl">5.5</span>, <span class="fl">0.5</span>), <span class="at">j=</span><span class="fu">seq</span>(<span class="fl">0.5</span>, <span class="fl">5.5</span>, <span class="fl">0.5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-512"><a href="#cb51-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Correlation =</span> <span class="fu">ifelse</span>(i<span class="sc">==</span>j, <span class="fl">1.0</span>, <span class="fl">0.48</span> <span class="sc">-</span> <span class="fl">0.037</span> <span class="sc">*</span> <span class="fu">abs</span>(i<span class="sc">/</span><span class="fl">0.5</span><span class="sc">-</span>j<span class="sc">/</span><span class="fl">0.5</span>)),</span>
<span id="cb51-513"><a href="#cb51-513" aria-hidden="true" tabindex="-1"></a>         <span class="at">Visit =</span> <span class="fu">paste0</span>(<span class="st">"Month "</span>, <span class="fu">as.integer</span>(i<span class="sc">*</span><span class="dv">12</span>)),</span>
<span id="cb51-514"><a href="#cb51-514" aria-hidden="true" tabindex="-1"></a>         <span class="at">Monthj =</span> <span class="fu">paste0</span>(<span class="st">"Month "</span>, <span class="fu">as.integer</span>(j<span class="sc">*</span><span class="dv">12</span>)),</span>
<span id="cb51-515"><a href="#cb51-515" aria-hidden="true" tabindex="-1"></a>         <span class="at">Correlation =</span> <span class="fu">if_else</span>(i <span class="sc">&lt;</span> j, <span class="cn">NA_real_</span>, Correlation)) <span class="sc">%&gt;%</span></span>
<span id="cb51-516"><a href="#cb51-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols=</span><span class="st">"Visit"</span>, <span class="at">names_from=</span><span class="st">"Monthj"</span>, <span class="at">values_from=</span>Correlation) <span class="sc">%&gt;%</span></span>
<span id="cb51-517"><a href="#cb51-517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-518"><a href="#cb51-518" aria-hidden="true" tabindex="-1"></a>    <span class="co">#fmt_missing(is.numeric, missing_text="---") %&gt;% ## sub_missing is the new function for gt &gt;=0.8.0</span></span>
<span id="cb51-519"><a href="#cb51-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Example of a correlation matrix for FPG in pre-diabetic patients**"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-520"><a href="#cb51-520" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sub_missing(missing_text = " ") %&gt;%</span></span>
<span id="cb51-521"><a href="#cb51-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_row_striping</span>(<span class="at">row_striping =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-522"><a href="#cb51-522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(<span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="st">"darkgrey"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb51-523"><a href="#cb51-523" aria-hidden="true" tabindex="-1"></a>            <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb51-524"><a href="#cb51-524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(<span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="st">"darkgrey"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb51-525"><a href="#cb51-525" aria-hidden="true" tabindex="-1"></a>            <span class="at">locations =</span> <span class="fu">cells_body</span>(<span class="at">columns =</span> <span class="st">"Visit"</span>))</span>
<span id="cb51-526"><a href="#cb51-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-527"><a href="#cb51-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-528"><a href="#cb51-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-529"><a href="#cb51-529" aria-hidden="true" tabindex="-1"></a>To look at another endpoint, let us look at the covariance matrix for glycated</span>
<span id="cb51-530"><a href="#cb51-530" aria-hidden="true" tabindex="-1"></a>hemoglobin A1c (HbA1c) trial in diabetes patients used in </span>
<span id="cb51-531"><a href="#cb51-531" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Holzhauer et al. 2015</span><span class="co">](https://doi.org/10.1002/pst.1705)</span>. Many patterns </span>
<span id="cb51-532"><a href="#cb51-532" aria-hidden="true" tabindex="-1"></a>seem similar to FPG, but the correlation of adjacent visits is higher, which </span>
<span id="cb51-533"><a href="#cb51-533" aria-hidden="true" tabindex="-1"></a>makes sense, because HbA1c is less subject to day-to-day variations than FPG.</span>
<span id="cb51-534"><a href="#cb51-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-535"><a href="#cb51-535" aria-hidden="true" tabindex="-1"></a><span class="in">```{r hba1c_examplecov, echo=FALSE, eval = FALSE}</span></span>
<span id="cb51-536"><a href="#cb51-536" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb51-537"><a href="#cb51-537" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show the code"</span></span>
<span id="cb51-538"><a href="#cb51-538" aria-hidden="true" tabindex="-1"></a>hba1c_cov <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb51-539"><a href="#cb51-539" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 0</span><span class="st">`</span> <span class="ot">=</span>  <span class="fu">c</span>(<span class="fl">1.09</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">7</span>)),</span>
<span id="cb51-540"><a href="#cb51-540" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 4</span><span class="st">`</span> <span class="ot">=</span>  <span class="fu">c</span>(<span class="fl">0.97</span>, <span class="fl">1.19</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">6</span>)),      </span>
<span id="cb51-541"><a href="#cb51-541" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 12</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.84</span>, <span class="fl">1.01</span>, <span class="fl">1.35</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">5</span>)),                    </span>
<span id="cb51-542"><a href="#cb51-542" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 16</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.76</span>, <span class="fl">0.92</span>, <span class="fl">1.24</span>, <span class="fl">1.36</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">4</span>)),              </span>
<span id="cb51-543"><a href="#cb51-543" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 24</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.62</span>, <span class="fl">0.76</span>, <span class="fl">0.97</span>, <span class="fl">1.13</span>, <span class="fl">1.21</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">3</span>)),            </span>
<span id="cb51-544"><a href="#cb51-544" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 32</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.61</span>, <span class="fl">0.76</span>, <span class="fl">0.91</span>, <span class="fl">1.00</span>, <span class="fl">1.06</span>, <span class="fl">1.23</span>, <span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="dv">2</span>)),  </span>
<span id="cb51-545"><a href="#cb51-545" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 40</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.61</span>, <span class="fl">0.72</span>, <span class="fl">0.85</span>, <span class="fl">0.94</span>, <span class="fl">0.94</span>, <span class="fl">1.06</span>, <span class="fl">1.19</span>, <span class="cn">NA_real_</span>),</span>
<span id="cb51-546"><a href="#cb51-546" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Week 52</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.67</span>, <span class="fl">0.74</span>, <span class="fl">0.89</span>, <span class="fl">0.95</span>, <span class="fl">0.96</span>, <span class="fl">1.09</span>, <span class="fl">1.19</span>, <span class="fl">1.53</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-547"><a href="#cb51-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-548"><a href="#cb51-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-549"><a href="#cb51-549" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames=</span><span class="st">"Visit"</span>,</span>
<span id="cb51-550"><a href="#cb51-550" aria-hidden="true" tabindex="-1"></a>            <span class="at">.name_repair =</span> <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="st">"V"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x)))</span>
<span id="cb51-551"><a href="#cb51-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-552"><a href="#cb51-552" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(hba1c_cov) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Visit"</span>, <span class="fu">paste0</span>(<span class="st">"Week "</span>, <span class="fu">c</span>(<span class="dv">0</span>L, <span class="dv">4</span>L, <span class="dv">12</span>L, <span class="dv">16</span>L, <span class="dv">24</span>L, <span class="dv">32</span>L, <span class="dv">40</span>L, <span class="dv">52</span>L)))</span>
<span id="cb51-553"><a href="#cb51-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-554"><a href="#cb51-554" aria-hidden="true" tabindex="-1"></a>hba1c_cov <span class="sc">%&gt;%</span></span>
<span id="cb51-555"><a href="#cb51-555" aria-hidden="true" tabindex="-1"></a>     <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-556"><a href="#cb51-556" aria-hidden="true" tabindex="-1"></a>    <span class="co">#fmt_missing(is.numeric, missing_text="---") %&gt;% ## sub_missing is the new function for gt &gt;=0.8.0</span></span>
<span id="cb51-557"><a href="#cb51-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="fu">md</span>(<span class="st">"**Example of a covariance matrix for HbA1c in diabetic patients**"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-558"><a href="#cb51-558" aria-hidden="true" tabindex="-1"></a>  <span class="do">## sub_missing(missing_text = " ") %&gt;%</span></span>
<span id="cb51-559"><a href="#cb51-559" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_row_striping</span>(<span class="at">row_striping =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-560"><a href="#cb51-560" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(<span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="st">"darkgrey"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb51-561"><a href="#cb51-561" aria-hidden="true" tabindex="-1"></a>            <span class="at">locations =</span> <span class="fu">cells_column_labels</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb51-562"><a href="#cb51-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_style</span>(<span class="at">style =</span> <span class="fu">list</span>(<span class="fu">cell_fill</span>(<span class="st">"darkgrey"</span>),<span class="fu">cell_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">weight =</span> <span class="st">"bold"</span>)),</span>
<span id="cb51-563"><a href="#cb51-563" aria-hidden="true" tabindex="-1"></a>            <span class="at">locations =</span> <span class="fu">cells_body</span>(<span class="at">columns =</span> <span class="st">"Visit"</span>))</span>
<span id="cb51-564"><a href="#cb51-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-565"><a href="#cb51-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-566"><a href="#cb51-566" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementation</span></span>
<span id="cb51-567"><a href="#cb51-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-568"><a href="#cb51-568" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reference implementations using SAS and `lme4`</span></span>
<span id="cb51-569"><a href="#cb51-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-570"><a href="#cb51-570" aria-hidden="true" tabindex="-1"></a>Within a frequentist framework, this model is usually estimated using </span>
<span id="cb51-571"><a href="#cb51-571" aria-hidden="true" tabindex="-1"></a>Restricted Maximum Likelihood Estimation (REML). One popular way of fitting </span>
<span id="cb51-572"><a href="#cb51-572" aria-hidden="true" tabindex="-1"></a>such a model is using SAS code similar to the following</span>
<span id="cb51-573"><a href="#cb51-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-574"><a href="#cb51-574" aria-hidden="true" tabindex="-1"></a><span class="in">```{sas, eval = FALSE}</span></span>
<span id="cb51-575"><a href="#cb51-575" aria-hidden="true" tabindex="-1"></a><span class="in">PROC MIXED DATA=simulated_data;</span></span>
<span id="cb51-576"><a href="#cb51-576" aria-hidden="true" tabindex="-1"></a><span class="in">  CLASS TRT01P AVISIT USUBJID;</span></span>
<span id="cb51-577"><a href="#cb51-577" aria-hidden="true" tabindex="-1"></a><span class="in">  MODEL CHG ~ TRT01P AVISIT BASE TRT01P*AVISIT AVISIT*BASE </span></span>
<span id="cb51-578"><a href="#cb51-578" aria-hidden="true" tabindex="-1"></a><span class="in">    / SOLUTION DDFM=KR ALPHA = 0.05;</span></span>
<span id="cb51-579"><a href="#cb51-579" aria-hidden="true" tabindex="-1"></a><span class="in">  REPEATED AVISIT / TYPE=UN SUBJECT = USUBJID R Rcorr GROUP=TRT01P;</span></span>
<span id="cb51-580"><a href="#cb51-580" aria-hidden="true" tabindex="-1"></a><span class="in">  LSMEANS TRT01P*AVISIT / DIFFS PDIFF CL OM E;</span></span>
<span id="cb51-581"><a href="#cb51-581" aria-hidden="true" tabindex="-1"></a><span class="in">RUN;</span></span>
<span id="cb51-582"><a href="#cb51-582" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-583"><a href="#cb51-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-584"><a href="#cb51-584" aria-hidden="true" tabindex="-1"></a>Note that <span class="in">`GROUP=TRT01P`</span> in the <span class="in">`REPEATED`</span> statement specifies different </span>
<span id="cb51-585"><a href="#cb51-585" aria-hidden="true" tabindex="-1"></a>covariance structures for each treatment groups. Importantly, <span class="in">`DDFM=KR`</span> refers</span>
<span id="cb51-586"><a href="#cb51-586" aria-hidden="true" tabindex="-1"></a>to using the method of <span class="co">[</span><span class="ot">Kenward and Roger</span><span class="co">](https://doi.org/10.2307/2533558)</span> for</span>
<span id="cb51-587"><a href="#cb51-587" aria-hidden="true" tabindex="-1"></a>figuring out what degrees of freedom to use for inference with </span>
<span id="cb51-588"><a href="#cb51-588" aria-hidden="true" tabindex="-1"></a>Student-t-distributions (or in other words to figure out how many independent </span>
<span id="cb51-589"><a href="#cb51-589" aria-hidden="true" tabindex="-1"></a>observations the correlated observations across all our subjects are worth).</span>
<span id="cb51-590"><a href="#cb51-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-591"><a href="#cb51-591" aria-hidden="true" tabindex="-1"></a>Additionally the <span class="in">`OM`</span> option to the <span class="in">`LSMEANS`</span> statement requests the </span>
<span id="cb51-592"><a href="#cb51-592" aria-hidden="true" tabindex="-1"></a>by-treatment-group least squares means for each visit to be calculated for </span>
<span id="cb51-593"><a href="#cb51-593" aria-hidden="true" tabindex="-1"></a>predicted population margins for the observed covariate distribution in the </span>
<span id="cb51-594"><a href="#cb51-594" aria-hidden="true" tabindex="-1"></a>analysis dataset. On this occasion, it does not make a difference, because</span>
<span id="cb51-595"><a href="#cb51-595" aria-hidden="true" tabindex="-1"></a>there are no categorical covariates in the model.</span>
<span id="cb51-596"><a href="#cb51-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-597"><a href="#cb51-597" aria-hidden="true" tabindex="-1"></a>In <span class="in">`R`</span> we can obtain a very similar frequentist fit for this model using </span>
<span id="cb51-598"><a href="#cb51-598" aria-hidden="true" tabindex="-1"></a>the <span class="in">`lme4`</span> package using the following <span class="in">`R`</span> code as explained in a </span>
<span id="cb51-599"><a href="#cb51-599" aria-hidden="true" tabindex="-1"></a>[R/PHARMA presentation on implementing MMRM in R by Daniel Sabanés</span>
<span id="cb51-600"><a href="#cb51-600" aria-hidden="true" tabindex="-1"></a>Bové](https://rinpharma.com/publication/rinpharma_143/).</span>
<span id="cb51-601"><a href="#cb51-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-602"><a href="#cb51-602" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lmermodel_example}</span></span>
<span id="cb51-603"><a href="#cb51-603" aria-hidden="true" tabindex="-1"></a><span class="fu">lmer</span>(<span class="at">data=</span>simulated_data,</span>
<span id="cb51-604"><a href="#cb51-604" aria-hidden="true" tabindex="-1"></a>     CHG <span class="sc">~</span> TRT01P <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> AVISIT<span class="sc">*</span>TRT01P <span class="sc">+</span> AVISIT<span class="sc">*</span>BASE <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> AVISIT <span class="sc">|</span> USUBJID),</span>
<span id="cb51-605"><a href="#cb51-605" aria-hidden="true" tabindex="-1"></a>     <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">check.nobs.vs.nRE =</span> <span class="st">"ignore"</span>, <span class="at">optimizer=</span><span class="st">"nlminbwrap"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-606"><a href="#cb51-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb51-607"><a href="#cb51-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-608"><a href="#cb51-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-609"><a href="#cb51-609" aria-hidden="true" tabindex="-1"></a>Note that the choice of the particular optimizer via `control =</span>
<span id="cb51-610"><a href="#cb51-610" aria-hidden="true" tabindex="-1"></a>lmerControl(optimizer="nlminbwrap")` was chosen based on trying</span>
<span id="cb51-611"><a href="#cb51-611" aria-hidden="true" tabindex="-1"></a>different ones to resolve convergence warnings. Moreover, problems</span>
<span id="cb51-612"><a href="#cb51-612" aria-hidden="true" tabindex="-1"></a>were found out later with the <span class="in">`lme4`</span> package, which does not allow the</span>
<span id="cb51-613"><a href="#cb51-613" aria-hidden="true" tabindex="-1"></a>fitting of MMRM with many visits, as it can easily lead to very long</span>
<span id="cb51-614"><a href="#cb51-614" aria-hidden="true" tabindex="-1"></a>computation times and low convergence rates. Hence, prototyping of the</span>
<span id="cb51-615"><a href="#cb51-615" aria-hidden="true" tabindex="-1"></a>dedicated [<span class="in">`mmrm`</span> <span class="in">`R`</span></span>
<span id="cb51-616"><a href="#cb51-616" aria-hidden="true" tabindex="-1"></a>package](https://cran.r-project.org/package=mmrm) was initiated</span>
<span id="cb51-617"><a href="#cb51-617" aria-hidden="true" tabindex="-1"></a>originall by Daniel Sabanés Bové. The package was then quickly adopted</span>
<span id="cb51-618"><a href="#cb51-618" aria-hidden="true" tabindex="-1"></a>as the first open source project of the</span>
<span id="cb51-619"><a href="#cb51-619" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">`openstatsware`</span><span class="co">](https://openstatsware.org)</span> group. The <span class="in">`mmrm`</span> package</span>
<span id="cb51-620"><a href="#cb51-620" aria-hidden="true" tabindex="-1"></a>is a completely new implementation of the MMRM, and implements the</span>
<span id="cb51-621"><a href="#cb51-621" aria-hidden="true" tabindex="-1"></a>log-likelihood function in C++ with the help of the [<span class="in">`TMB`</span></span>
<span id="cb51-622"><a href="#cb51-622" aria-hidden="true" tabindex="-1"></a>package]((https://cran.r-project.org/package=TMB)), which enables to</span>
<span id="cb51-623"><a href="#cb51-623" aria-hidden="true" tabindex="-1"></a>use gradient information through the use of automatic</span>
<span id="cb51-624"><a href="#cb51-624" aria-hidden="true" tabindex="-1"></a>differentiation. It is similar with regards to the architecture to the</span>
<span id="cb51-625"><a href="#cb51-625" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">`glmmTMB` package</span><span class="co">](https://cran.r-project.org/package=glmmTMB)</span>, but</span>
<span id="cb51-626"><a href="#cb51-626" aria-hidden="true" tabindex="-1"></a>it provides the important Satterthwaite and Kenward-Roger degrees of</span>
<span id="cb51-627"><a href="#cb51-627" aria-hidden="true" tabindex="-1"></a>freedom methods. More details are available e.g. in the [R/Pharma</span>
<span id="cb51-628"><a href="#cb51-628" aria-hidden="true" tabindex="-1"></a>workshop by Daniel and Doug</span>
<span id="cb51-629"><a href="#cb51-629" aria-hidden="true" tabindex="-1"></a>Kelkhoff](https://rinpharma.com/publication/rinpharma_327/).</span>
<span id="cb51-630"><a href="#cb51-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-631"><a href="#cb51-631" aria-hidden="true" tabindex="-1"></a>For this reason the <span class="in">`mmrm`</span> package is preferable and its usage is</span>
<span id="cb51-632"><a href="#cb51-632" aria-hidden="true" tabindex="-1"></a>demonstrated below:</span>
<span id="cb51-633"><a href="#cb51-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-634"><a href="#cb51-634" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mmrm_package_example}</span></span>
<span id="cb51-635"><a href="#cb51-635" aria-hidden="true" tabindex="-1"></a>mmrm_fit <span class="ot">&lt;-</span> <span class="fu">mmrm</span>(</span>
<span id="cb51-636"><a href="#cb51-636" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> CHG <span class="sc">~</span> TRT01P <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>BASE <span class="sc">+</span> <span class="fu">us</span>(AVISIT <span class="sc">|</span> USUBJID),</span>
<span id="cb51-637"><a href="#cb51-637" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb51-638"><a href="#cb51-638" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">USUBJID=</span><span class="fu">factor</span>(USUBJID)))</span>
<span id="cb51-639"><a href="#cb51-639" aria-hidden="true" tabindex="-1"></a><span class="co"># reml=TRUE default option used (not specifically requested)</span></span>
<span id="cb51-640"><a href="#cb51-640" aria-hidden="true" tabindex="-1"></a><span class="co"># e.g. cs(AVISIT | USUBJID) would request compound-symmetric covariance</span></span>
<span id="cb51-641"><a href="#cb51-641" aria-hidden="true" tabindex="-1"></a><span class="co">#   structure instead of unstructed ("us")</span></span>
<span id="cb51-642"><a href="#cb51-642" aria-hidden="true" tabindex="-1"></a><span class="co"># us(AVISIT | TRT01P / USUBJID) would request separate covariance matrices</span></span>
<span id="cb51-643"><a href="#cb51-643" aria-hidden="true" tabindex="-1"></a><span class="co">#   for each treatment gorup</span></span>
<span id="cb51-644"><a href="#cb51-644" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-645"><a href="#cb51-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-646"><a href="#cb51-646" aria-hidden="true" tabindex="-1"></a>While we can of course summarize the model fit and regression coefficients via </span>
<span id="cb51-647"><a href="#cb51-647" aria-hidden="true" tabindex="-1"></a><span class="in">`summary(mmrm_fit)`</span>, this is often not the main output we are interested in. </span>
<span id="cb51-648"><a href="#cb51-648" aria-hidden="true" tabindex="-1"></a>Instead, we often want for each visit the treatment differences or least-squares </span>
<span id="cb51-649"><a href="#cb51-649" aria-hidden="true" tabindex="-1"></a>means by treatment group. For a MMRM this involves linear combinations of</span>
<span id="cb51-650"><a href="#cb51-650" aria-hidden="true" tabindex="-1"></a>regression coefficients, potentially weighted according to the distribution</span>
<span id="cb51-651"><a href="#cb51-651" aria-hidden="true" tabindex="-1"></a>of (categorical baseline covariates). One very convenient way of obtaining </span>
<span id="cb51-652"><a href="#cb51-652" aria-hidden="true" tabindex="-1"></a>these inferences is with the <span class="in">`emmeans`</span> R package, which we can use with many</span>
<span id="cb51-653"><a href="#cb51-653" aria-hidden="true" tabindex="-1"></a>different types of models including <span class="in">`brms`</span> models. To obtain LS-means by visit</span>
<span id="cb51-654"><a href="#cb51-654" aria-hidden="true" tabindex="-1"></a>for each treatment group, we use the <span class="in">`emmeans`</span> function:</span>
<span id="cb51-655"><a href="#cb51-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-656"><a href="#cb51-656" aria-hidden="true" tabindex="-1"></a><span class="in">```{r getting_lsmeans_mmrm}</span></span>
<span id="cb51-657"><a href="#cb51-657" aria-hidden="true" tabindex="-1"></a>emm1 <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(mmrm_fit, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, </span>
<span id="cb51-658"><a href="#cb51-658" aria-hidden="true" tabindex="-1"></a>                <span class="at">lmer.df=</span><span class="st">"kenward-roger"</span>, <span class="at">weights =</span> <span class="st">"proportional"</span>)</span>
<span id="cb51-659"><a href="#cb51-659" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(emm1)</span>
<span id="cb51-660"><a href="#cb51-660" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-661"><a href="#cb51-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-662"><a href="#cb51-662" aria-hidden="true" tabindex="-1"></a>To get the implied contrasts for each dose compared with the control </span>
<span id="cb51-663"><a href="#cb51-663" aria-hidden="true" tabindex="-1"></a>we use the <span class="in">`contrast`</span> function`:</span>
<span id="cb51-664"><a href="#cb51-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-665"><a href="#cb51-665" aria-hidden="true" tabindex="-1"></a><span class="in">```{r getting_contrasts_mmrm}</span></span>
<span id="cb51-666"><a href="#cb51-666" aria-hidden="true" tabindex="-1"></a>contrasts1 <span class="ot">&lt;-</span> <span class="fu">contrast</span>(emm1, <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>, <span class="at">ref=</span><span class="dv">1</span>)</span>
<span id="cb51-667"><a href="#cb51-667" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(contrasts1)</span>
<span id="cb51-668"><a href="#cb51-668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-669"><a href="#cb51-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-670"><a href="#cb51-670" aria-hidden="true" tabindex="-1"></a>The pairwise comparisons showing nominal p-values only (due to <span class="in">`adjust="none"`</span>),</span>
<span id="cb51-671"><a href="#cb51-671" aria-hidden="true" tabindex="-1"></a>but we could request e.g. <span class="in">`adjust="bonferroni"`</span> instead. When we specified</span>
<span id="cb51-672"><a href="#cb51-672" aria-hidden="true" tabindex="-1"></a><span class="in">`method="trt.vs.ctrl"`</span>, we told the <span class="in">`contrast`</span> function to use the first group</span>
<span id="cb51-673"><a href="#cb51-673" aria-hidden="true" tabindex="-1"></a>as the control group by specifying its index via <span class="in">`ref=1`</span>.</span>
<span id="cb51-674"><a href="#cb51-674" aria-hidden="true" tabindex="-1"></a>Alternatively, we could have asked for all possible pairwise contrasts via </span>
<span id="cb51-675"><a href="#cb51-675" aria-hidden="true" tabindex="-1"></a><span class="in">`contrast(..., method="pairwise")`</span> (or <span class="in">`pairs(...)`</span>).</span>
<span id="cb51-676"><a href="#cb51-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-677"><a href="#cb51-677" aria-hidden="true" tabindex="-1"></a>Sometimes, we may want to average the treatment effects across weeks 8 and 12.</span>
<span id="cb51-678"><a href="#cb51-678" aria-hidden="true" tabindex="-1"></a>E.g. if we are very sure that (almost) the full treatment effect will have set </span>
<span id="cb51-679"><a href="#cb51-679" aria-hidden="true" tabindex="-1"></a>in by week 8. When doing so, it is useful to fit a model that estimates separate </span>
<span id="cb51-680"><a href="#cb51-680" aria-hidden="true" tabindex="-1"></a>treatment effects for both visits and then to average them. In contrast to </span>
<span id="cb51-681"><a href="#cb51-681" aria-hidden="true" tabindex="-1"></a>averaging outcomes across visits for individual patients first, this approach </span>
<span id="cb51-682"><a href="#cb51-682" aria-hidden="true" tabindex="-1"></a>more coherently deals with missing data, intercurrent events and differing </span>
<span id="cb51-683"><a href="#cb51-683" aria-hidden="true" tabindex="-1"></a>effects of covariates. <span class="in">`emmeans`</span> also allows us to do that, we just need to </span>
<span id="cb51-684"><a href="#cb51-684" aria-hidden="true" tabindex="-1"></a>specify our contrasts slightly more manually. Note that in this case we need </span>
<span id="cb51-685"><a href="#cb51-685" aria-hidden="true" tabindex="-1"></a>to know the ordering of estimates in the output of the <span class="in">`emmeans()`</span> </span>
<span id="cb51-686"><a href="#cb51-686" aria-hidden="true" tabindex="-1"></a>function in order to specify the contrasts:</span>
<span id="cb51-687"><a href="#cb51-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-688"><a href="#cb51-688" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wk8_12_contrasts_mmrm}</span></span>
<span id="cb51-689"><a href="#cb51-689" aria-hidden="true" tabindex="-1"></a>emm1a <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(mmrm_fit, <span class="sc">~</span> TRT01P<span class="sc">:</span>AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>)</span>
<span id="cb51-690"><a href="#cb51-690" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(emm1a, </span>
<span id="cb51-691"><a href="#cb51-691" aria-hidden="true" tabindex="-1"></a>         <span class="at">method=</span><span class="fu">list</span>(<span class="st">"40 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb51-692"><a href="#cb51-692" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"20 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dv">0</span>),</span>
<span id="cb51-693"><a href="#cb51-693" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"10 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>)),</span>
<span id="cb51-694"><a href="#cb51-694" aria-hidden="true" tabindex="-1"></a>         <span class="at">adjust=</span><span class="st">"none"</span>)</span>
<span id="cb51-695"><a href="#cb51-695" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-696"><a href="#cb51-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-697"><a href="#cb51-697" aria-hidden="true" tabindex="-1"></a>With the release of <span class="in">`brms`</span> 2.19.0 in March 2023 it became</span>
<span id="cb51-698"><a href="#cb51-698" aria-hidden="true" tabindex="-1"></a>possible to fit equivalent models easily based on a Bayesian</span>
<span id="cb51-699"><a href="#cb51-699" aria-hidden="true" tabindex="-1"></a>implementation of a MMRM with an unstructured covariance matrix as</span>
<span id="cb51-700"><a href="#cb51-700" aria-hidden="true" tabindex="-1"></a>shown below.</span>
<span id="cb51-701"><a href="#cb51-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-702"><a href="#cb51-702" aria-hidden="true" tabindex="-1"></a><span class="fu">### `brms` implementation</span></span>
<span id="cb51-703"><a href="#cb51-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-704"><a href="#cb51-704" aria-hidden="true" tabindex="-1"></a>The code below shows how we specify a MMRM model in a very similar way</span>
<span id="cb51-705"><a href="#cb51-705" aria-hidden="true" tabindex="-1"></a>to <span class="in">`SAS`</span> and the <span class="in">`lme4`</span> approach.</span>
<span id="cb51-706"><a href="#cb51-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-707"><a href="#cb51-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r basic_brms_bmmrm, results='hide',message=FALSE,warning=FALSE}</span></span>
<span id="cb51-708"><a href="#cb51-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-709"><a href="#cb51-709" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup forward difference contrasts for changes between visits</span></span>
<span id="cb51-710"><a href="#cb51-710" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(simulated_data<span class="sc">$</span>AVISIT) <span class="ot">&lt;-</span> MASS<span class="sc">::</span>contr.sdif</span>
<span id="cb51-711"><a href="#cb51-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-712"><a href="#cb51-712" aria-hidden="true" tabindex="-1"></a>mmrm_model1 <span class="ot">&lt;-</span> <span class="fu">bf</span>(CHG <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> TRT01P<span class="sc">:</span>AVISIT,</span>
<span id="cb51-713"><a href="#cb51-713" aria-hidden="true" tabindex="-1"></a>                  <span class="at">autocor =</span> <span class="sc">~</span><span class="fu">unstr</span>(<span class="at">time=</span>AVISIT, <span class="at">gr=</span>USUBJID),</span>
<span id="cb51-714"><a href="#cb51-714" aria-hidden="true" tabindex="-1"></a>                  sigma <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P)</span>
<span id="cb51-715"><a href="#cb51-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-716"><a href="#cb51-716" aria-hidden="true" tabindex="-1"></a><span class="co"># If we manually specify priors by providing out own Stan code via the stanvars </span></span>
<span id="cb51-717"><a href="#cb51-717" aria-hidden="true" tabindex="-1"></a><span class="co"># option, we may want to use `center=FALSE` in `bf()`, otherwise not.</span></span>
<span id="cb51-718"><a href="#cb51-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-719"><a href="#cb51-719" aria-hidden="true" tabindex="-1"></a><span class="co"># Explicitly specifying quite weak priors (given the variability in the data).</span></span>
<span id="cb51-720"><a href="#cb51-720" aria-hidden="true" tabindex="-1"></a><span class="co"># These priors are set considering that unity is assumed to be the</span></span>
<span id="cb51-721"><a href="#cb51-721" aria-hidden="true" tabindex="-1"></a><span class="co"># sampling standard deviation and that the outcome data is scaled such that</span></span>
<span id="cb51-722"><a href="#cb51-722" aria-hidden="true" tabindex="-1"></a><span class="co"># unity is a considerable change.</span></span>
<span id="cb51-723"><a href="#cb51-723" aria-hidden="true" tabindex="-1"></a>mmrm_prior1 <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>Intercept) <span class="sc">+</span></span>
<span id="cb51-724"><a href="#cb51-724" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class=</span>b) <span class="sc">+</span></span>
<span id="cb51-725"><a href="#cb51-725" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">10.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>Intercept, <span class="at">dpar=</span>sigma) <span class="sc">+</span> <span class="co"># 90% CrI spans 1/10 - 10</span></span>
<span id="cb51-726"><a href="#cb51-726" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,  <span class="fu">log</span>(<span class="fl">2.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>b, <span class="at">dpar=</span>sigma) <span class="sc">+</span>         <span class="co"># 90% CrI spans  1/2 - 2x</span></span>
<span id="cb51-727"><a href="#cb51-727" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">lkj_corr_cholesky</span>(<span class="dv">1</span>), <span class="at">class=</span><span class="st">"Lcortime"</span>)</span>
<span id="cb51-728"><a href="#cb51-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-729"><a href="#cb51-729" aria-hidden="true" tabindex="-1"></a>brmfit1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb51-730"><a href="#cb51-730" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula=</span>mmrm_model1,</span>
<span id="cb51-731"><a href="#cb51-731" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior=</span> mmrm_prior1,</span>
<span id="cb51-732"><a href="#cb51-732" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> simulated_data,</span>
<span id="cb51-733"><a href="#cb51-733" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed=</span><span class="dv">234235</span>,</span>
<span id="cb51-734"><a href="#cb51-734" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> control_args,</span>
<span id="cb51-735"><a href="#cb51-735" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb51-736"><a href="#cb51-736" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-737"><a href="#cb51-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-738"><a href="#cb51-738" aria-hidden="true" tabindex="-1"></a>brmfit1</span>
<span id="cb51-739"><a href="#cb51-739" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-740"><a href="#cb51-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-741"><a href="#cb51-741" aria-hidden="true" tabindex="-1"></a>Note that instead of writing <span class="in">`(0 + AVISIT | USUBJID)`</span> like</span>
<span id="cb51-742"><a href="#cb51-742" aria-hidden="true" tabindex="-1"></a>in the <span class="in">`lme4`</span> code, the <span class="in">`brms`</span> syntax resembles the <span class="in">`mmrm`</span> package syntax. </span>
<span id="cb51-743"><a href="#cb51-743" aria-hidden="true" tabindex="-1"></a>We specify an unstructured correlation structure over time for groups of </span>
<span id="cb51-744"><a href="#cb51-744" aria-hidden="true" tabindex="-1"></a>observations (here with the same unique patient identifier <span class="in">`USUBJID`</span>) using </span>
<span id="cb51-745"><a href="#cb51-745" aria-hidden="true" tabindex="-1"></a><span class="in">`autocor=~unstr(time=AVISIT, gr=USUBJID)`</span>.</span>
<span id="cb51-746"><a href="#cb51-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-747"><a href="#cb51-747" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"alert alert-info"</span><span class="dt">&gt;</span> Note that using `(0 + AVISIT |</span>
<span id="cb51-748"><a href="#cb51-748" aria-hidden="true" tabindex="-1"></a>USUBJID)<span class="in">` as in the `</span>lme4` turns out to not work well with</span>
<span id="cb51-749"><a href="#cb51-749" aria-hidden="true" tabindex="-1"></a><span class="in">`brms`</span>. While conceptually this implies the correct correlation</span>
<span id="cb51-750"><a href="#cb51-750" aria-hidden="true" tabindex="-1"></a>structure via an unstructured random effect, the model becomes</span>
<span id="cb51-751"><a href="#cb51-751" aria-hidden="true" tabindex="-1"></a>overparametrized due to the residual error and random effect standard</span>
<span id="cb51-752"><a href="#cb51-752" aria-hidden="true" tabindex="-1"></a>deviations becoming non-identifiable. Trying to avoid this e.g. by</span>
<span id="cb51-753"><a href="#cb51-753" aria-hidden="true" tabindex="-1"></a>setting the uncorrelated residual standard deviation to a fixed value</span>
<span id="cb51-754"><a href="#cb51-754" aria-hidden="true" tabindex="-1"></a>that is small relative to the total variability</span>
<span id="cb51-755"><a href="#cb51-755" aria-hidden="true" tabindex="-1"></a>(e.g. <span class="in">`prior(constant(0.1), sigma)`</span>) still results in very poor</span>
<span id="cb51-756"><a href="#cb51-756" aria-hidden="true" tabindex="-1"></a>sampling of the posterior distribution (high Rhat values and very low</span>
<span id="cb51-757"><a href="#cb51-757" aria-hidden="true" tabindex="-1"></a>effective sample size for the MCMC samples). The approach implemented</span>
<span id="cb51-758"><a href="#cb51-758" aria-hidden="true" tabindex="-1"></a>by the <span class="in">`unstr`</span> syntax uses instead a marginal approach avoiding the</span>
<span id="cb51-759"><a href="#cb51-759" aria-hidden="true" tabindex="-1"></a>non-identifability of the conditional approach. </span>
<span id="cb51-760"><a href="#cb51-760" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb51-761"><a href="#cb51-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-762"><a href="#cb51-762" aria-hidden="true" tabindex="-1"></a>The model formula above specifies that the correlation structure is</span>
<span id="cb51-763"><a href="#cb51-763" aria-hidden="true" tabindex="-1"></a>the same across all treatment groups. This is not an assumption we</span>
<span id="cb51-764"><a href="#cb51-764" aria-hidden="true" tabindex="-1"></a>have to make and SAS provides the <span class="in">`GROUP=TRT01P`</span> option in the</span>
<span id="cb51-765"><a href="#cb51-765" aria-hidden="true" tabindex="-1"></a><span class="in">`REPEATED`</span> statement to avoid it. Similarly, the <span class="in">`mmrm`</span> package allows</span>
<span id="cb51-766"><a href="#cb51-766" aria-hidden="true" tabindex="-1"></a>the user to specify group specific covariance parameter estimates</span>
<span id="cb51-767"><a href="#cb51-767" aria-hidden="true" tabindex="-1"></a>using the <span class="in">`us(AVISIT | TRT01P / USUBJID)`</span> syntax (so "group / subject"</span>
<span id="cb51-768"><a href="#cb51-768" aria-hidden="true" tabindex="-1"></a>on the right hand side, see</span>
<span id="cb51-769"><a href="#cb51-769" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">here</span><span class="co">](https://openpharma.github.io/mmrm/latest-tag/articles/introduction.html#grouped-covariance-structure)</span></span>
<span id="cb51-770"><a href="#cb51-770" aria-hidden="true" tabindex="-1"></a>for details). On the other hand, the <span class="in">`brms`</span> and <span class="in">`lme4`</span> packages do not</span>
<span id="cb51-771"><a href="#cb51-771" aria-hidden="true" tabindex="-1"></a>have an option for allowing separate unstructed covariance matrices</span>
<span id="cb51-772"><a href="#cb51-772" aria-hidden="true" tabindex="-1"></a>for the different treatment groups. However, <span class="in">`brms`</span> offers more</span>
<span id="cb51-773"><a href="#cb51-773" aria-hidden="true" tabindex="-1"></a>flexibility than the other two packages regarding the variation at</span>
<span id="cb51-774"><a href="#cb51-774" aria-hidden="true" tabindex="-1"></a>different visits and treatment groups through "distributional</span>
<span id="cb51-775"><a href="#cb51-775" aria-hidden="true" tabindex="-1"></a>regression" (i.e. we can specify a regression model for parameters of</span>
<span id="cb51-776"><a href="#cb51-776" aria-hidden="true" tabindex="-1"></a>the distribution other than the location, in this case <span class="in">`sigma`</span>).</span>
<span id="cb51-777"><a href="#cb51-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-778"><a href="#cb51-778" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"alert alert-info"</span><span class="dt">&gt;</span> If we just wanted a compound symmetric</span>
<span id="cb51-779"><a href="#cb51-779" aria-hidden="true" tabindex="-1"></a>correlation matrix, we would just use <span class="in">`(1 | USUBJID)`</span>, because a simple</span>
<span id="cb51-780"><a href="#cb51-780" aria-hidden="true" tabindex="-1"></a>random effect on the intercept induces an equal correlation between </span>
<span id="cb51-781"><a href="#cb51-781" aria-hidden="true" tabindex="-1"></a>all visits.</span>
<span id="cb51-782"><a href="#cb51-782" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb51-783"><a href="#cb51-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-784"><a href="#cb51-784" aria-hidden="true" tabindex="-1"></a>By writing <span class="in">`sigma ~ 1 + AVISIT + TRT01P + AVISIT:TRT01P`</span> we specify that we </span>
<span id="cb51-785"><a href="#cb51-785" aria-hidden="true" tabindex="-1"></a>want heterogeneous standard deviations over time that may differ by treatment</span>
<span id="cb51-786"><a href="#cb51-786" aria-hidden="true" tabindex="-1"></a>group (note that <span class="in">`brms`</span> models the standard</span>
<span id="cb51-787"><a href="#cb51-787" aria-hidden="true" tabindex="-1"></a>deviation rather than the variance), which we would typically</span>
<span id="cb51-788"><a href="#cb51-788" aria-hidden="true" tabindex="-1"></a>assume. If we instead wanted to assume the same variance at each</span>
<span id="cb51-789"><a href="#cb51-789" aria-hidden="true" tabindex="-1"></a>visit, we would simply omit this option.  Note that while</span>
<span id="cb51-790"><a href="#cb51-790" aria-hidden="true" tabindex="-1"></a>we did not specify it explicitly, we are using a $\log$-link function</span>
<span id="cb51-791"><a href="#cb51-791" aria-hidden="true" tabindex="-1"></a>for <span class="in">`sigma`</span> so that a regression coefficient of $0.69$ approximately</span>
<span id="cb51-792"><a href="#cb51-792" aria-hidden="true" tabindex="-1"></a>corresponds to a doubling of the standard deviation. The user can</span>
<span id="cb51-793"><a href="#cb51-793" aria-hidden="true" tabindex="-1"></a>explicitly define the link using the <span class="in">`family`</span> argument of <span class="in">`bf`</span> and set</span>
<span id="cb51-794"><a href="#cb51-794" aria-hidden="true" tabindex="-1"></a><span class="in">`family=gaussian(link_sigma="log")`</span> (or use other links if</span>
<span id="cb51-795"><a href="#cb51-795" aria-hidden="true" tabindex="-1"></a>desired). Thus, if we wanted to set prior distributions for the</span>
<span id="cb51-796"><a href="#cb51-796" aria-hidden="true" tabindex="-1"></a>treatment and the visit-by-treatment interaction terms, even a</span>
<span id="cb51-797"><a href="#cb51-797" aria-hidden="true" tabindex="-1"></a><span class="in">`normal(0, 1)`</span> prior already allows for considerable a-priori</span>
<span id="cb51-798"><a href="#cb51-798" aria-hidden="true" tabindex="-1"></a>variation in <span class="in">`sigma`</span> between treatment groups and visits. A useful way</span>
<span id="cb51-799"><a href="#cb51-799" aria-hidden="true" tabindex="-1"></a>for specifying a prior on a <span class="in">`log`</span> scale is by defining the standard</span>
<span id="cb51-800"><a href="#cb51-800" aria-hidden="true" tabindex="-1"></a>deviation of a normal distribution to be equal to</span>
<span id="cb51-801"><a href="#cb51-801" aria-hidden="true" tabindex="-1"></a>$\log(s)/\Phi^{-1}(1/2+c/2)$, which implies that the central credible</span>
<span id="cb51-802"><a href="#cb51-802" aria-hidden="true" tabindex="-1"></a>interval $c$ spans the range $1/s - s$, i.e. $\log(2)/1.64$</span>
<span id="cb51-803"><a href="#cb51-803" aria-hidden="true" tabindex="-1"></a>corresponds to the central 90% credible interval ranging from 1/2x to</span>
<span id="cb51-804"><a href="#cb51-804" aria-hidden="true" tabindex="-1"></a>2x around the mean.</span>
<span id="cb51-805"><a href="#cb51-805" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- However, we could also --&gt;</span></span>
<span id="cb51-806"><a href="#cb51-806" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- specify `sigma ~ 1 + AVISIT + TRTO1P + AVISIT:TRTO1P` to allow the --&gt;</span></span>
<span id="cb51-807"><a href="#cb51-807" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- covariance matrices to differ by treatment group (although the --&gt;</span></span>
<span id="cb51-808"><a href="#cb51-808" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- correlation matrix would still be assumed identical).  --&gt;</span></span>
<span id="cb51-809"><a href="#cb51-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-810"><a href="#cb51-810" aria-hidden="true" tabindex="-1"></a>As for the <span class="in">`mmrm`</span> package, we can also easily obtain the equivalent of </span>
<span id="cb51-811"><a href="#cb51-811" aria-hidden="true" tabindex="-1"></a>least-squares means with highest-posterior density (HPD) credible intervals</span>
<span id="cb51-812"><a href="#cb51-812" aria-hidden="true" tabindex="-1"></a>for each treatment group by visit using <span class="in">`emmeans`</span>.</span>
<span id="cb51-813"><a href="#cb51-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-814"><a href="#cb51-814" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lsmeans_for_brms}</span></span>
<span id="cb51-815"><a href="#cb51-815" aria-hidden="true" tabindex="-1"></a>emm2 <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(brmfit1, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>)</span>
<span id="cb51-816"><a href="#cb51-816" aria-hidden="true" tabindex="-1"></a>emm2</span>
<span id="cb51-817"><a href="#cb51-817" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-818"><a href="#cb51-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-819"><a href="#cb51-819" aria-hidden="true" tabindex="-1"></a>We can also get the pairwise treatment comparisons with HPD</span>
<span id="cb51-820"><a href="#cb51-820" aria-hidden="true" tabindex="-1"></a>credible intervals in this manner.</span>
<span id="cb51-821"><a href="#cb51-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-822"><a href="#cb51-822" aria-hidden="true" tabindex="-1"></a><span class="in">```{r contrasts_with_brms}</span></span>
<span id="cb51-823"><a href="#cb51-823" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(emm2, <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>)</span>
<span id="cb51-824"><a href="#cb51-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-825"><a href="#cb51-825" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-826"><a href="#cb51-826" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Commented this out, as it's unncecessary confusion --&gt;</span></span>
<span id="cb51-827"><a href="#cb51-827" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- contrast(emm2, adjust="none", method="trt.vs.ctrl", frequentist=TRUE) # or pairs(emm2) --&gt;</span></span>
<span id="cb51-828"><a href="#cb51-828" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- confint(emm2, adjust="none", method="trt.vs.ctrl",  ref="TRT01P0", frequentist=TRUE) # or pairs(emm2) --&gt;</span></span>
<span id="cb51-829"><a href="#cb51-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-830"><a href="#cb51-830" aria-hidden="true" tabindex="-1"></a>HPD and quantile based credible intervals may differ whenever the</span>
<span id="cb51-831"><a href="#cb51-831" aria-hidden="true" tabindex="-1"></a>posterior is heavily skewed or not unimodal.  The quantile based</span>
<span id="cb51-832"><a href="#cb51-832" aria-hidden="true" tabindex="-1"></a>credible intervals are numerically simpler in their definition and can</span>
<span id="cb51-833"><a href="#cb51-833" aria-hidden="true" tabindex="-1"></a>be estimated more robustly estimated via MCMC. Furthermore, the</span>
<span id="cb51-834"><a href="#cb51-834" aria-hidden="true" tabindex="-1"></a>quantiles of a distribution are transformation invariant, whereas HPD</span>
<span id="cb51-835"><a href="#cb51-835" aria-hidden="true" tabindex="-1"></a>intervals are not transformation invariant (this of interest for the</span>
<span id="cb51-836"><a href="#cb51-836" aria-hidden="true" tabindex="-1"></a>case of generalized models with non-linear link functions). <span class="in">`emmeans`</span></span>
<span id="cb51-837"><a href="#cb51-837" aria-hidden="true" tabindex="-1"></a>can report summaries (using the <span class="in">`frequentist=TRUE`</span> option) based on a</span>
<span id="cb51-838"><a href="#cb51-838" aria-hidden="true" tabindex="-1"></a>normal approximation resembling the frequentist estimate plus standard</span>
<span id="cb51-839"><a href="#cb51-839" aria-hidden="true" tabindex="-1"></a>error approach.</span>
<span id="cb51-840"><a href="#cb51-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-841"><a href="#cb51-841" aria-hidden="true" tabindex="-1"></a>While the default HPD intervals reported from <span class="in">`emmeans`</span> are a useful</span>
<span id="cb51-842"><a href="#cb51-842" aria-hidden="true" tabindex="-1"></a>summary of the positerior, the respective quantile summaries can also</span>
<span id="cb51-843"><a href="#cb51-843" aria-hidden="true" tabindex="-1"></a>be extracted by first converting with the <span class="in">`as.mcmc`</span> conversion</span>
<span id="cb51-844"><a href="#cb51-844" aria-hidden="true" tabindex="-1"></a>function the <span class="in">`emmeans`</span> results into the respective posterior MCMC</span>
<span id="cb51-845"><a href="#cb51-845" aria-hidden="true" tabindex="-1"></a>sample. This sample one can then conveniently summarized by using</span>
<span id="cb51-846"><a href="#cb51-846" aria-hidden="true" tabindex="-1"></a>utilities from the <span class="in">`posterior`</span> package:</span>
<span id="cb51-847"><a href="#cb51-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-848"><a href="#cb51-848" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- SW: drop this??</span></span>
<span id="cb51-849"><a href="#cb51-849" aria-hidden="true" tabindex="-1"></a><span class="co">We can instead obtain quantile based credible intervals using the </span></span>
<span id="cb51-850"><a href="#cb51-850" aria-hidden="true" tabindex="-1"></a><span class="co">`hypothesis` function provided by `brms` e.g. via </span></span>
<span id="cb51-851"><a href="#cb51-851" aria-hidden="true" tabindex="-1"></a><span class="co">`hypothesis(brmfit1, "TRT01P10 + `AVISIT4:TRT01P10`", alpha = 0.025, robust=T)`, </span></span>
<span id="cb51-852"><a href="#cb51-852" aria-hidden="true" tabindex="-1"></a><span class="co">but this is somewhat more complex. Many model plus prior distribution plus data </span></span>
<span id="cb51-853"><a href="#cb51-853" aria-hidden="true" tabindex="-1"></a><span class="co">combinations result in nicely behaved symmetric and unimodal posterior </span></span>
<span id="cb51-854"><a href="#cb51-854" aria-hidden="true" tabindex="-1"></a><span class="co">distributions. We would expect this to be usually the case for MMRM analyses,</span></span>
<span id="cb51-855"><a href="#cb51-855" aria-hidden="true" tabindex="-1"></a><span class="co">in which case the convenience of `emmeans` trumps other considerations.</span></span>
<span id="cb51-856"><a href="#cb51-856" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;/div&gt;</span></span>
<span id="cb51-857"><a href="#cb51-857" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb51-858"><a href="#cb51-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-859"><a href="#cb51-859" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mcmc_contrasts_with_brms}</span></span>
<span id="cb51-860"><a href="#cb51-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-861"><a href="#cb51-861" aria-hidden="true" tabindex="-1"></a>mc.emm2 <span class="ot">&lt;-</span> <span class="fu">as.mcmc</span>(emm2)</span>
<span id="cb51-862"><a href="#cb51-862" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise_draws</span>(mc.emm2, <span class="fu">default_summary_measures</span>()) </span>
<span id="cb51-863"><a href="#cb51-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-864"><a href="#cb51-864" aria-hidden="true" tabindex="-1"></a>mc.contrast.emm2 <span class="ot">&lt;-</span> <span class="fu">as.mcmc</span>(<span class="fu">contrast</span>(emm2, <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>))</span>
<span id="cb51-865"><a href="#cb51-865" aria-hidden="true" tabindex="-1"></a><span class="fu">summarise_draws</span>(mc.contrast.emm2, <span class="fu">default_summary_measures</span>())</span>
<span id="cb51-866"><a href="#cb51-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-867"><a href="#cb51-867" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-868"><a href="#cb51-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-869"><a href="#cb51-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-870"><a href="#cb51-870" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- However, we do not have to use the `emmeans` package, because `brms` also  --&gt;</span></span>
<span id="cb51-871"><a href="#cb51-871" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- provides the quite general `hypothesis` function. --&gt;</span></span>
<span id="cb51-872"><a href="#cb51-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-873"><a href="#cb51-873" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &lt;!--- as discussed, the hypothesis facility is not appropiate when using the custom contrasts as it is deeply tied to transforming parameters, but this neglects the usual standardisation ---&gt;</span></span>
<span id="cb51-874"><a href="#cb51-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-875"><a href="#cb51-875" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb51-876"><a href="#cb51-876" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- contrasts_of_interest &lt;- c("TRT01P10", "TRT01P20", "TRT01P40", --&gt;</span></span>
<span id="cb51-877"><a href="#cb51-877" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            "TRT01P10 + `AVISIT2:TRT01P10`",  --&gt;</span></span>
<span id="cb51-878"><a href="#cb51-878" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            "TRT01P20 + `AVISIT2:TRT01P20`",  --&gt;</span></span>
<span id="cb51-879"><a href="#cb51-879" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            "TRT01P40 + `AVISIT2:TRT01P40`",  --&gt;</span></span>
<span id="cb51-880"><a href="#cb51-880" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            "TRT01P10 + `AVISIT3:TRT01P10`", --&gt;</span></span>
<span id="cb51-881"><a href="#cb51-881" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            "TRT01P20 + `AVISIT3:TRT01P20`", --&gt;</span></span>
<span id="cb51-882"><a href="#cb51-882" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            "TRT01P40 + `AVISIT3:TRT01P40`", --&gt;</span></span>
<span id="cb51-883"><a href="#cb51-883" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            "TRT01P10 + `AVISIT4:TRT01P10`", --&gt;</span></span>
<span id="cb51-884"><a href="#cb51-884" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            "TRT01P20 + `AVISIT4:TRT01P20`", --&gt;</span></span>
<span id="cb51-885"><a href="#cb51-885" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                            "TRT01P40 + `AVISIT4:TRT01P40`") %&gt;% --&gt;</span></span>
<span id="cb51-886"><a href="#cb51-886" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     paste0(" &lt; 0") --&gt;</span></span>
<span id="cb51-887"><a href="#cb51-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-888"><a href="#cb51-888" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- contrasts_of_interest &lt;- contrasts_of_interest[1:3] --&gt;</span></span>
<span id="cb51-889"><a href="#cb51-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-890"><a href="#cb51-890" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- hh &lt;- hypothesis(brmfit1, contrasts_of_interest, alpha = 0.025, robust=T)$hypothesis --&gt;</span></span>
<span id="cb51-891"><a href="#cb51-891" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- knitr::kable(hh, digits=2) --&gt;</span></span>
<span id="cb51-892"><a href="#cb51-892" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb51-893"><a href="#cb51-893" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- As we can notice, the point estimates are the same as when using --&gt;</span></span>
<span id="cb51-894"><a href="#cb51-894" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- `emmeans`, but there's some very small numerical differences with the  --&gt;</span></span>
<span id="cb51-895"><a href="#cb51-895" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- credible interval limits despite both basing inference on the same  --&gt;</span></span>
<span id="cb51-896"><a href="#cb51-896" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- MCMC samples (although these differences are smaller than the MCMC  --&gt;</span></span>
<span id="cb51-897"><a href="#cb51-897" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sampling variability you might get with 4000 MCMC samples). --&gt;</span></span>
<span id="cb51-898"><a href="#cb51-898" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- This is due to `emmeans` using highest-posterior density (HPD)  --&gt;</span></span>
<span id="cb51-899"><a href="#cb51-899" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- credible intervals and `hypothesis` using quantile based credible --&gt;</span></span>
<span id="cb51-900"><a href="#cb51-900" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- intervals.  --&gt;</span></span>
<span id="cb51-901"><a href="#cb51-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-902"><a href="#cb51-902" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &lt;div class="alert alert-info"&gt; HPD and quantile based credible --&gt;</span></span>
<span id="cb51-903"><a href="#cb51-903" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- intervals may differ whenever the posterior is heavily skewed or not unimodal.  --&gt;</span></span>
<span id="cb51-904"><a href="#cb51-904" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The quantile based credible intervals are numerically simpler in  --&gt;</span></span>
<span id="cb51-905"><a href="#cb51-905" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- their definition and can be estimated more robustly estimated via --&gt;</span></span>
<span id="cb51-906"><a href="#cb51-906" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- MCMC. Furthermore, the quantiles of a distribution are transformation --&gt;</span></span>
<span id="cb51-907"><a href="#cb51-907" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- invariant, whereas HPD intervals are not transformation invariant --&gt;</span></span>
<span id="cb51-908"><a href="#cb51-908" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- (this of interest for the case of generalized models with non-linear --&gt;</span></span>
<span id="cb51-909"><a href="#cb51-909" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- link functions). --&gt;</span></span>
<span id="cb51-910"><a href="#cb51-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-911"><a href="#cb51-911" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- However, many model plus prior distribution plus data combinations result in  --&gt;</span></span>
<span id="cb51-912"><a href="#cb51-912" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- nicely behaved symmetric and unimodal posterior distributions. In those cases  --&gt;</span></span>
<span id="cb51-913"><a href="#cb51-913" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- HPD intervals will be fine and the convenience of `emmeans` might be the --&gt;</span></span>
<span id="cb51-914"><a href="#cb51-914" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- deciding factor for the approach you choose. Moreover, `emmeans` can  report  --&gt;</span></span>
<span id="cb51-915"><a href="#cb51-915" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- summaries (using the `frequentist=TRUE` option) based on a normal approximation  --&gt;</span></span>
<span id="cb51-916"><a href="#cb51-916" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- resembling the frequentist estimate plus standard error approach. --&gt;</span></span>
<span id="cb51-917"><a href="#cb51-917" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &lt;/div&gt; --&gt;</span></span>
<span id="cb51-918"><a href="#cb51-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-919"><a href="#cb51-919" aria-hidden="true" tabindex="-1"></a>As with a model fit using the <span class="in">`mmrm`</span> package, we can also obtain inference</span>
<span id="cb51-920"><a href="#cb51-920" aria-hidden="true" tabindex="-1"></a>about the average treatment effect across weeks 8 and 12 using the <span class="in">`emmeans`</span></span>
<span id="cb51-921"><a href="#cb51-921" aria-hidden="true" tabindex="-1"></a>package:</span>
<span id="cb51-922"><a href="#cb51-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-923"><a href="#cb51-923" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wk8_12_pooled_with_brms}</span></span>
<span id="cb51-924"><a href="#cb51-924" aria-hidden="true" tabindex="-1"></a>emm2a <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(brmfit1, <span class="sc">~</span> TRT01P<span class="sc">:</span>AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>)</span>
<span id="cb51-925"><a href="#cb51-925" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(emm2a, </span>
<span id="cb51-926"><a href="#cb51-926" aria-hidden="true" tabindex="-1"></a>         <span class="at">method=</span><span class="fu">list</span>(<span class="st">"40 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb51-927"><a href="#cb51-927" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"20 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dv">0</span>),</span>
<span id="cb51-928"><a href="#cb51-928" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"10 vs Placebo"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>, <span class="sc">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">0</span>,<span class="dv">0</span>)))</span>
<span id="cb51-929"><a href="#cb51-929" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-930"><a href="#cb51-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-931"><a href="#cb51-931" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We can also, again, use the `brms::hypothesis()` function, for example like this: --&gt;</span></span>
<span id="cb51-932"><a href="#cb51-932" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r, eval=FALSE} --&gt;</span></span>
<span id="cb51-933"><a href="#cb51-933" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- hypothesis(brmfit1,  --&gt;</span></span>
<span id="cb51-934"><a href="#cb51-934" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--            c("(TRT01P40 + `AVISIT3:TRT01P40` + TRT01P40 + `AVISIT4:TRT01P40`)*0.5 &lt;0", --&gt;</span></span>
<span id="cb51-935"><a href="#cb51-935" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              "(TRT01P20 + `AVISIT3:TRT01P20` + TRT01P20 + `AVISIT4:TRT01P20`)*0.5 &lt;0", --&gt;</span></span>
<span id="cb51-936"><a href="#cb51-936" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              "(TRT01P10 + `AVISIT3:TRT01P10` + TRT01P10 + `AVISIT4:TRT01P10`)*0.5 &lt;0"), --&gt;</span></span>
<span id="cb51-937"><a href="#cb51-937" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--            alpha = 0.025, robust=T) --&gt;</span></span>
<span id="cb51-938"><a href="#cb51-938" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb51-939"><a href="#cb51-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-940"><a href="#cb51-940" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model parameterization and the importance of (at least weak) priors</span></span>
<span id="cb51-941"><a href="#cb51-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-942"><a href="#cb51-942" aria-hidden="true" tabindex="-1"></a>Here, we explicitly specified a proper prior distribution (but very</span>
<span id="cb51-943"><a href="#cb51-943" aria-hidden="true" tabindex="-1"></a>weak) for each regression coefficient. This is important, because by</span>
<span id="cb51-944"><a href="#cb51-944" aria-hidden="true" tabindex="-1"></a>default <span class="in">`brms`</span> would only have put a prior distribution on intercept</span>
<span id="cb51-945"><a href="#cb51-945" aria-hidden="true" tabindex="-1"></a>terms. If we instead assume improper flat prior distributions, we</span>
<span id="cb51-946"><a href="#cb51-946" aria-hidden="true" tabindex="-1"></a>often run into issues with sampling from the model. Weakly informative</span>
<span id="cb51-947"><a href="#cb51-947" aria-hidden="true" tabindex="-1"></a>priors ensure stable sampling while not influencing the posterior</span>
<span id="cb51-948"><a href="#cb51-948" aria-hidden="true" tabindex="-1"></a>distribution in relevant ways. One common approach to define a weakly</span>
<span id="cb51-949"><a href="#cb51-949" aria-hidden="true" tabindex="-1"></a>informative prior is by way of identifying the scale of the parameter</span>
<span id="cb51-950"><a href="#cb51-950" aria-hidden="true" tabindex="-1"></a>in question, e.g. parameters on a logarithmic scale commonly do not</span>
<span id="cb51-951"><a href="#cb51-951" aria-hidden="true" tabindex="-1"></a>vary over many magnitudes or a parameter on a logistic scale varies</span>
<span id="cb51-952"><a href="#cb51-952" aria-hidden="true" tabindex="-1"></a>within $-3$ to $3$ provided that the effects are not extreme.</span>
<span id="cb51-953"><a href="#cb51-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-954"><a href="#cb51-954" aria-hidden="true" tabindex="-1"></a>In which way we are comfortable to specify prior distributions may in part</span>
<span id="cb51-955"><a href="#cb51-955" aria-hidden="true" tabindex="-1"></a>determine how we parameterize the model:</span>
<span id="cb51-956"><a href="#cb51-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-957"><a href="#cb51-957" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>We chose to setup forward difference contrasts for changes between</span>
<span id="cb51-958"><a href="#cb51-958" aria-hidden="true" tabindex="-1"></a>visits when specifying `contrasts(simulated_data$AVISIT) &lt;-</span>
<span id="cb51-959"><a href="#cb51-959" aria-hidden="true" tabindex="-1"></a>MASS::contr.sdif<span class="in">` in combination with `</span>CHG ~ 1 + AVISIT + BASE +</span>
<span id="cb51-960"><a href="#cb51-960" aria-hidden="true" tabindex="-1"></a>BASE:AVISIT + TRT01P + TRT01P:AVISIT`. I.e. the intercept term will</span>
<span id="cb51-961"><a href="#cb51-961" aria-hidden="true" tabindex="-1"></a>refer to the expected change from baseline averaged across all visits,</span>
<span id="cb51-962"><a href="#cb51-962" aria-hidden="true" tabindex="-1"></a>while there will be regression coefficients for the expected</span>
<span id="cb51-963"><a href="#cb51-963" aria-hidden="true" tabindex="-1"></a>difference from visit 1 to 2, 2 to 3 and 3 to 4. We can check this</span>
<span id="cb51-964"><a href="#cb51-964" aria-hidden="true" tabindex="-1"></a>using <span class="in">`solve(cbind(1, contrasts(simulated_data$AVISIT)))`</span>.</span>
<span id="cb51-965"><a href="#cb51-965" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Not only does it seem reasonable to specify prior information about</span>
<span id="cb51-966"><a href="#cb51-966" aria-hidden="true" tabindex="-1"></a>such parameters, but this also induces a reasonable correlation</span>
<span id="cb51-967"><a href="#cb51-967" aria-hidden="true" tabindex="-1"></a>between our prior beliefs for each visit. I.e. if values at one visit</span>
<span id="cb51-968"><a href="#cb51-968" aria-hidden="true" tabindex="-1"></a>are higher, we would expect values at the surrounding visits to also</span>
<span id="cb51-969"><a href="#cb51-969" aria-hidden="true" tabindex="-1"></a>be higher. This is illustrated by the very typical pattern seen in the</span>
<span id="cb51-970"><a href="#cb51-970" aria-hidden="true" tabindex="-1"></a>weight loss over time in the EQUIP study <span class="co">[</span><span class="ot">@allison2012equip</span><span class="co">]</span> shown in</span>
<span id="cb51-971"><a href="#cb51-971" aria-hidden="true" tabindex="-1"></a>the figure below. As is typical for clinical trial data, there are</span>
<span id="cb51-972"><a href="#cb51-972" aria-hidden="true" tabindex="-1"></a>only small visit-to-visit changes in the mean outcome, which can be</span>
<span id="cb51-973"><a href="#cb51-973" aria-hidden="true" tabindex="-1"></a>nicely represented by forward difference contrasts. Furthermore, also</span>
<span id="cb51-974"><a href="#cb51-974" aria-hidden="true" tabindex="-1"></a>note that the forward differences parametrization does imply a</span>
<span id="cb51-975"><a href="#cb51-975" aria-hidden="true" tabindex="-1"></a>correlation structure which resembles the fact that we observe patient</span>
<span id="cb51-976"><a href="#cb51-976" aria-hidden="true" tabindex="-1"></a>longitudinally accross the subsequent visits.</span>
<span id="cb51-977"><a href="#cb51-977" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If we had specified the same model code without setting up forward</span>
<span id="cb51-978"><a href="#cb51-978" aria-hidden="true" tabindex="-1"></a>difference contrasts, the intercept would have stood for the expected</span>
<span id="cb51-979"><a href="#cb51-979" aria-hidden="true" tabindex="-1"></a>change from baseline at the reference visit (by default visit 1),</span>
<span id="cb51-980"><a href="#cb51-980" aria-hidden="true" tabindex="-1"></a>while the regression coefficients would have represented the</span>
<span id="cb51-981"><a href="#cb51-981" aria-hidden="true" tabindex="-1"></a>difference in the expected change at all the remaining visits compared</span>
<span id="cb51-982"><a href="#cb51-982" aria-hidden="true" tabindex="-1"></a>with the reference visit 1.</span>
<span id="cb51-983"><a href="#cb51-983" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Alternatively, we could have chosen the parameterization `0 +</span>
<span id="cb51-984"><a href="#cb51-984" aria-hidden="true" tabindex="-1"></a>AVISIT + BASE + BASE:AVISIT + TRT01P + TRT01P:AVISIT` as our main</span>
<span id="cb51-985"><a href="#cb51-985" aria-hidden="true" tabindex="-1"></a>approach. In this cell means parametrization, we would need to provide</span>
<span id="cb51-986"><a href="#cb51-986" aria-hidden="true" tabindex="-1"></a>prior distributions for each visit.</span>
<span id="cb51-987"><a href="#cb51-987" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>If we make the priors for each visit independent in the latter approach, the </span>
<span id="cb51-988"><a href="#cb51-988" aria-hidden="true" tabindex="-1"></a>prior distribution will specify plausible values for the mean outcome at that</span>
<span id="cb51-989"><a href="#cb51-989" aria-hidden="true" tabindex="-1"></a>visit, but will suggest that all sizes of visit-to-visit changes that keep values</span>
<span id="cb51-990"><a href="#cb51-990" aria-hidden="true" tabindex="-1"></a>within the range of a-priori plausible values are equally plausible. </span>
<span id="cb51-991"><a href="#cb51-991" aria-hidden="true" tabindex="-1"></a>This is typically not the case.</span>
<span id="cb51-992"><a href="#cb51-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-993"><a href="#cb51-993" aria-hidden="true" tabindex="-1"></a><span class="in">```{r echo=FALSE, fig.cap="Change in body weight over time in the EQUIP study (data digitized from published figure)"}</span></span>
<span id="cb51-994"><a href="#cb51-994" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">treatment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"PHEN/TPM CR 15/92"</span>, <span class="dv">15</span>),</span>
<span id="cb51-995"><a href="#cb51-995" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rep</span>(<span class="st">"PHEN/TPM CR 3.75/23"</span>, <span class="dv">15</span>),</span>
<span id="cb51-996"><a href="#cb51-996" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rep</span>(<span class="st">"placebo"</span>, <span class="dv">15</span>)),</span>
<span id="cb51-997"><a href="#cb51-997" aria-hidden="true" tabindex="-1"></a>       <span class="at">week =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">12</span>, <span class="dv">16</span>, <span class="dv">20</span>, <span class="dv">24</span>, <span class="dv">28</span>, <span class="dv">32</span>, <span class="dv">36</span>, <span class="dv">40</span>, <span class="dv">44</span>, <span class="dv">48</span>, <span class="dv">52</span>, <span class="dv">56</span>), <span class="dv">3</span>),</span>
<span id="cb51-998"><a href="#cb51-998" aria-hidden="true" tabindex="-1"></a>       <span class="at">chg =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="fl">3.73913043478261</span>, <span class="sc">-</span><span class="fl">5.88405797101449</span>, <span class="sc">-</span><span class="fl">7.50724637681159</span>,<span class="sc">-</span><span class="fl">8.95652173913043</span>, <span class="sc">-</span><span class="fl">10.0289855072464</span>, <span class="sc">-</span><span class="fl">11.1014492753623</span>, <span class="sc">-</span><span class="fl">11.8260869565217</span>, <span class="sc">-</span><span class="fl">12.3478260869565</span>, <span class="sc">-</span><span class="fl">12.8405797101449</span>, <span class="sc">-</span><span class="fl">13.2173913043478</span>, <span class="sc">-</span><span class="fl">13.304347826087</span>, <span class="sc">-</span><span class="fl">13.3333333333333</span>, <span class="sc">-</span><span class="fl">13.4492753623188</span>, <span class="sc">-</span><span class="fl">13.1884057971014</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="fl">2.57971014492753</span>, <span class="sc">-</span><span class="fl">3.50724637681159</span>, <span class="sc">-</span><span class="fl">4.17391304347826</span>, <span class="sc">-</span><span class="fl">4.98550724637681</span>, <span class="sc">-</span><span class="fl">5.56521739130435</span>, <span class="sc">-</span><span class="fl">6.14492753623188</span>, <span class="sc">-</span><span class="fl">6.55072463768116</span>, <span class="sc">-</span><span class="fl">6.72463768115942</span>, <span class="sc">-</span><span class="fl">6.89855072463768</span>, <span class="sc">-</span><span class="fl">7.18840579710145</span>, <span class="sc">-</span><span class="fl">7.15942028985507</span>, <span class="sc">-</span><span class="fl">6.98550724637681</span>, <span class="sc">-</span><span class="fl">6.84057971014492</span>, <span class="sc">-</span><span class="fl">6.7536231884058</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="fl">1.07246376811594</span>, <span class="sc">-</span><span class="fl">1.47826086956522</span>, <span class="sc">-</span><span class="fl">1.88405797101449</span>, <span class="sc">-</span><span class="fl">2.08695652173913</span>, <span class="sc">-</span><span class="fl">2.31884057971014</span>, <span class="sc">-</span><span class="fl">2.43478260869565</span>, <span class="sc">-</span><span class="fl">2.60869565217391</span>, <span class="sc">-</span><span class="fl">2.69565217391304</span>, <span class="sc">-</span><span class="fl">2.78260869565217</span>, <span class="sc">-</span><span class="fl">2.92753623188406</span>, <span class="sc">-</span><span class="fl">2.66666666666666</span>, <span class="sc">-</span><span class="fl">2.46376811594203</span>, <span class="sc">-</span><span class="fl">2.34782608695652</span>, </span>
<span id="cb51-999"><a href="#cb51-999" aria-hidden="true" tabindex="-1"></a>               <span class="sc">-</span><span class="fl">2.20289855072464</span>), </span>
<span id="cb51-1000"><a href="#cb51-1000" aria-hidden="true" tabindex="-1"></a>       <span class="at">stderr =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fl">0.594202898550725</span>, <span class="fl">0.347826086956522</span>, <span class="fl">0.434782608695651</span>, <span class="fl">0.521739130434784</span>, <span class="fl">0.594202898550725</span>, <span class="fl">0.666666666666667</span>, <span class="fl">0.710144927536232</span>, <span class="fl">0.826086956521739</span>, <span class="fl">0.869565217391306</span>, <span class="fl">0.898550724637681</span>, <span class="fl">0.942028985507246</span>, <span class="fl">0.956521739130435</span>, <span class="fl">0.971014492753623</span>, <span class="fl">1.02898550724638</span>, <span class="cn">NA</span>, <span class="fl">0.449275362318841</span>, <span class="fl">0.449275362318841</span>, <span class="fl">0.579710144927535</span>, <span class="fl">0.652173913043478</span>, <span class="fl">0.797101449275361</span>, <span class="fl">0.956521739130435</span>, <span class="fl">1.02898550724638</span>, <span class="fl">1.13043478260869</span>, <span class="fl">1.15942028985507</span>, <span class="fl">1.23188405797102</span>, <span class="fl">1.31884057971014</span>, <span class="fl">1.3768115942029</span>, <span class="fl">1.44927536231884</span>, <span class="fl">1.42028985507246</span>, <span class="cn">NA</span>, <span class="fl">0.333333333333332</span>, <span class="fl">0.289855072463769</span>, <span class="fl">0.391304347826086</span>, <span class="fl">0.492753623188404</span>, <span class="fl">0.623188405797102</span>, <span class="fl">0.724637681159422</span>, <span class="fl">0.782608695652174</span>, <span class="fl">0.840579710144927</span>, <span class="fl">0.869565217391304</span>, <span class="fl">0.956521739130434</span>, <span class="fl">1.01449275362319</span>, <span class="fl">1.05797101449275</span>, <span class="fl">1.10144927536232</span>, <span class="fl">1.10144927536232</span>), </span>
<span id="cb51-1001"><a href="#cb51-1001" aria-hidden="true" tabindex="-1"></a>       <span class="at">lcl =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="sc">-</span><span class="fl">4.90374671545133</span>, <span class="sc">-</span><span class="fl">6.56578457433277</span>, <span class="sc">-</span><span class="fl">8.35940463095944</span>, <span class="sc">-</span><span class="fl">9.97911164410786</span>, <span class="sc">-</span><span class="fl">11.1936017879151</span>, <span class="sc">-</span><span class="fl">12.4080919317224</span>, <span class="sc">-</span><span class="fl">13.2179454382966</span>, <span class="sc">-</span><span class="fl">13.9669267698374</span>, <span class="sc">-</span><span class="fl">14.5448962184406</span>, <span class="sc">-</span><span class="fl">14.97851836292</span>, <span class="sc">-</span><span class="fl">15.150690710074</span>, <span class="sc">-</span><span class="fl">15.2080814924586</span>, <span class="sc">-</span><span class="fl">15.3524287965824</span>, <span class="sc">-</span><span class="fl">15.205180331918</span>, <span class="cn">NA</span>, <span class="sc">-</span><span class="fl">3.46027367421365</span>, <span class="sc">-</span><span class="fl">4.3878099060977</span>, <span class="sc">-</span><span class="fl">5.31012404900872</span>, <span class="sc">-</span><span class="fl">6.26374462759858</span>, <span class="sc">-</span><span class="fl">7.12750752390873</span>, <span class="sc">-</span><span class="fl">8.01967569535715</span>, <span class="sc">-</span><span class="fl">8.56749917249773</span>, <span class="sc">-</span><span class="fl">8.94024914194382</span>, <span class="sc">-</span><span class="fl">9.17097273569861</span>, <span class="sc">-</span><span class="fl">9.60285418385369</span>, <span class="sc">-</span><span class="fl">9.74430032743688</span>, <span class="sc">-</span><span class="fl">9.68400838451167</span>, <span class="sc">-</span><span class="fl">9.68110722397109</span>, <span class="sc">-</span><span class="fl">9.53734015195544</span>, <span class="cn">NA</span>, <span class="sc">-</span><span class="fl">1.72578509629596</span>, <span class="sc">-</span><span class="fl">2.04636637233045</span>, <span class="sc">-</span><span class="fl">2.65100039974755</span>, <span class="sc">-</span><span class="fl">3.05273587644002</span>, <span class="sc">-</span><span class="fl">3.54026741065539</span>, <span class="sc">-</span><span class="fl">3.85504636560874</span>, <span class="sc">-</span><span class="fl">4.14258050964004</span>, <span class="sc">-</span><span class="fl">4.34315813193221</span>, <span class="sc">-</span><span class="fl">4.48692520394787</span>, <span class="sc">-</span><span class="fl">4.80228439100932</span>, <span class="sc">-</span><span class="fl">4.65503592634498</span>, <span class="sc">-</span><span class="fl">4.53735320103513</span>, <span class="sc">-</span><span class="fl">4.5066269974644</span>, <span class="sc">-</span><span class="fl">4.36169946123252</span>), </span>
<span id="cb51-1002"><a href="#cb51-1002" aria-hidden="true" tabindex="-1"></a>       <span class="at">ucl =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="sc">-</span><span class="fl">2.57451415411388</span>, <span class="sc">-</span><span class="fl">5.20233136769621</span>, <span class="sc">-</span><span class="fl">6.65508812266374</span>, <span class="sc">-</span><span class="fl">7.93393183415301</span>, <span class="sc">-</span><span class="fl">8.86436922657765</span>, <span class="sc">-</span><span class="fl">9.79480661900228</span>, <span class="sc">-</span><span class="fl">10.4342284747469</span>, <span class="sc">-</span><span class="fl">10.7287254040756</span>, <span class="sc">-</span><span class="fl">11.1362632018492</span>, <span class="sc">-</span><span class="fl">11.4562642457756</span>, <span class="sc">-</span><span class="fl">11.4580049420999</span>, <span class="sc">-</span><span class="fl">11.4585851742081</span>, <span class="sc">-</span><span class="fl">11.5461219280553</span>, <span class="sc">-</span><span class="fl">11.1716312622849</span>, <span class="cn">NA</span>, <span class="sc">-</span><span class="fl">1.69914661564142</span>, <span class="sc">-</span><span class="fl">2.62668284752548</span>, <span class="sc">-</span><span class="fl">3.0377020379478</span>, <span class="sc">-</span><span class="fl">3.70726986515503</span>, <span class="sc">-</span><span class="fl">4.00292725869996</span>, <span class="sc">-</span><span class="fl">4.27017937710661</span>, <span class="sc">-</span><span class="fl">4.53395010286458</span>, <span class="sc">-</span><span class="fl">4.50902622037501</span>, <span class="sc">-</span><span class="fl">4.62612871357675</span>, <span class="sc">-</span><span class="fl">4.7739574103492</span>, <span class="sc">-</span><span class="fl">4.57454025227326</span>, <span class="sc">-</span><span class="fl">4.28700610824195</span>, <span class="sc">-</span><span class="fl">4.00005219631876</span>, <span class="sc">-</span><span class="fl">3.96990622485616</span>, <span class="cn">NA</span>, <span class="sc">-</span><span class="fl">0.419142439935926</span>, <span class="sc">-</span><span class="fl">0.910155366799983</span>, <span class="sc">-</span><span class="fl">1.11711554228143</span>, <span class="sc">-</span><span class="fl">1.12117716703824</span>, <span class="sc">-</span><span class="fl">1.09741374876489</span>, <span class="sc">-</span><span class="fl">1.01451885178257</span>, <span class="sc">-</span><span class="fl">1.07481079470778</span>, <span class="sc">-</span><span class="fl">1.04814621589387</span>, <span class="sc">-</span><span class="fl">1.07829218735647</span>, <span class="sc">-</span><span class="fl">1.05278807275879</span>, <span class="sc">-</span><span class="fl">0.678297406988347</span>, <span class="sc">-</span><span class="fl">0.390183030848927</span>, <span class="sc">-</span><span class="fl">0.189025176448641</span>, <span class="sc">-</span><span class="fl">0.0440976402167492</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-1003"><a href="#cb51-1003" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week, <span class="at">y=</span>chg, <span class="at">ymin=</span>lcl, <span class="at">ymax=</span>ucl, <span class="at">col=</span>treatment, <span class="at">label=</span>treatment)) <span class="sc">+</span>  </span>
<span id="cb51-1004"><a href="#cb51-1004" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb51-1005"><a href="#cb51-1005" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb51-1006"><a href="#cb51-1006" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">width=</span><span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb51-1007"><a href="#cb51-1007" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb51-1008"><a href="#cb51-1008" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb51-1009"><a href="#cb51-1009" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data=</span>.<span class="sc">%&gt;%</span> <span class="fu">filter</span>(week<span class="sc">==</span><span class="dv">48</span>), <span class="at">size=</span><span class="dv">6</span>,</span>
<span id="cb51-1010"><a href="#cb51-1010" aria-hidden="true" tabindex="-1"></a>            <span class="at">nudge_y=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="sc">-</span><span class="fl">3.25</span>, <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb51-1011"><a href="#cb51-1011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization [weeks]"</span>) <span class="sc">+</span></span>
<span id="cb51-1012"><a href="#cb51-1012" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Percent change in body weight (%)"</span>) <span class="sc">+</span></span>
<span id="cb51-1013"><a href="#cb51-1013" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#e41a1c"</span>, <span class="st">"#ff7f00"</span>, <span class="st">"#377eb8"</span>))</span>
<span id="cb51-1014"><a href="#cb51-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1015"><a href="#cb51-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1016"><a href="#cb51-1016" aria-hidden="true" tabindex="-1"></a>With very vague priors the differences between these approach will</span>
<span id="cb51-1017"><a href="#cb51-1017" aria-hidden="true" tabindex="-1"></a>usually be negligible. If we are interested in specifying weakly</span>
<span id="cb51-1018"><a href="#cb51-1018" aria-hidden="true" tabindex="-1"></a>informative or even informative prior distributions, one should choose</span>
<span id="cb51-1019"><a href="#cb51-1019" aria-hidden="true" tabindex="-1"></a>the paramterization, in which it is easiest to express the available</span>
<span id="cb51-1020"><a href="#cb51-1020" aria-hidden="true" tabindex="-1"></a>prior information. Other ways to set-up contrasts are illustrated in</span>
<span id="cb51-1021"><a href="#cb51-1021" aria-hidden="true" tabindex="-1"></a>the case study on <span class="co">[</span><span class="ot">time-to-event data</span><span class="co">](02i_time_to_event.html)</span>.</span>
<span id="cb51-1022"><a href="#cb51-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1023"><a href="#cb51-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1024"><a href="#cb51-1024" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &lt;div class="alert alert-info"&gt; --&gt;</span></span>
<span id="cb51-1025"><a href="#cb51-1025" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Note that writing `1 + AVISIT + BASE + BASE:AVISIT + TRT01P + TRT01P:AVISIT`  --&gt;</span></span>
<span id="cb51-1026"><a href="#cb51-1026" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- specifies an equivalent model that is parameterized with an intercept included. --&gt;</span></span>
<span id="cb51-1027"><a href="#cb51-1027" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- As a result, it becomes hard to specify exactly the same prior as we used above. --&gt;</span></span>
<span id="cb51-1028"><a href="#cb51-1028" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- For example, additionally specifying  --&gt;</span></span>
<span id="cb51-1029"><a href="#cb51-1029" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- `prior(class="Intercept", normal(0, 5)` would not achieve that, --&gt;</span></span>
<span id="cb51-1030"><a href="#cb51-1030" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- because the visit effect for the second to fourth visit are in this  --&gt;</span></span>
<span id="cb51-1031"><a href="#cb51-1031" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- parameterization the sum of the intercept and the term specific to those visits. --&gt;</span></span>
<span id="cb51-1032"><a href="#cb51-1032" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- However, with very weak priors the differences might be negligible. --&gt;</span></span>
<span id="cb51-1033"><a href="#cb51-1033" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &lt;/div&gt; --&gt;</span></span>
<span id="cb51-1034"><a href="#cb51-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1035"><a href="#cb51-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1036"><a href="#cb51-1036" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &lt;div class="alert alert-info"&gt; --&gt;</span></span>
<span id="cb51-1037"><a href="#cb51-1037" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Note that contrasts can be setup differently (e.g. sum-to-zero contrast for --&gt;</span></span>
<span id="cb51-1038"><a href="#cb51-1038" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- the visits) in the way that is the most natural to work with for a particular --&gt;</span></span>
<span id="cb51-1039"><a href="#cb51-1039" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- case. This is illustrated in the case study on time-to-event data. --&gt;</span></span>
<span id="cb51-1040"><a href="#cb51-1040" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &lt;/div&gt; --&gt;</span></span>
<span id="cb51-1041"><a href="#cb51-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1042"><a href="#cb51-1042" aria-hidden="true" tabindex="-1"></a><span class="fu">### Meta-analytic combined (MAC) approach to historical data for MMRMs</span></span>
<span id="cb51-1043"><a href="#cb51-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1044"><a href="#cb51-1044" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"alert alert-info"</span><span class="dt">&gt;</span></span>
<span id="cb51-1045"><a href="#cb51-1045" aria-hidden="true" tabindex="-1"></a>  **WARNING**: There is very limited experience with a MAC approach for</span>
<span id="cb51-1046"><a href="#cb51-1046" aria-hidden="true" tabindex="-1"></a>  MMRMs and intuitions from MAC/MAP for a single control group parameter</span>
<span id="cb51-1047"><a href="#cb51-1047" aria-hidden="true" tabindex="-1"></a>  may not apply to high-dimensional settings, where many parameters are</span>
<span id="cb51-1048"><a href="#cb51-1048" aria-hidden="true" tabindex="-1"></a>  assumed to be exchangeable between studies.</span>
<span id="cb51-1049"><a href="#cb51-1049" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb51-1050"><a href="#cb51-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1051"><a href="#cb51-1051" aria-hidden="true" tabindex="-1"></a>One source of informative prior distributions is historical data. Let us assume </span>
<span id="cb51-1052"><a href="#cb51-1052" aria-hidden="true" tabindex="-1"></a>that we have access to the individual patient data for the placebo groups of </span>
<span id="cb51-1053"><a href="#cb51-1053" aria-hidden="true" tabindex="-1"></a>10 historical studies.</span>
<span id="cb51-1054"><a href="#cb51-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1055"><a href="#cb51-1055" aria-hidden="true" tabindex="-1"></a><span class="in">```{r simulate_hist_data}</span></span>
<span id="cb51-1056"><a href="#cb51-1056" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb51-1057"><a href="#cb51-1057" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show the code"</span></span>
<span id="cb51-1058"><a href="#cb51-1058" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">3547844</span>)</span>
<span id="cb51-1059"><a href="#cb51-1059" aria-hidden="true" tabindex="-1"></a>N_studies_hist <span class="ot">&lt;-</span> <span class="dv">10</span>L</span>
<span id="cb51-1060"><a href="#cb51-1060" aria-hidden="true" tabindex="-1"></a>Nf_hist <span class="ot">&lt;-</span> <span class="dv">500</span>L</span>
<span id="cb51-1061"><a href="#cb51-1061" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(use_small_N) {</span>
<span id="cb51-1062"><a href="#cb51-1062" aria-hidden="true" tabindex="-1"></a>    Nf_hist <span class="ot">&lt;-</span> <span class="dv">50</span>L</span>
<span id="cb51-1063"><a href="#cb51-1063" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-1064"><a href="#cb51-1064" aria-hidden="true" tabindex="-1"></a>Nf_per_study_hist <span class="ot">&lt;-</span> Nf_hist<span class="sc">/</span>N_studies_hist</span>
<span id="cb51-1065"><a href="#cb51-1065" aria-hidden="true" tabindex="-1"></a>historical_studies <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(<span class="at">n=</span><span class="dv">10</span> <span class="sc">*</span> Nf_hist,</span>
<span id="cb51-1066"><a href="#cb51-1066" aria-hidden="true" tabindex="-1"></a>                              <span class="at">mean =</span> zero,</span>
<span id="cb51-1067"><a href="#cb51-1067" aria-hidden="true" tabindex="-1"></a>                              <span class="at">sigma =</span> cov_matrix) <span class="sc">%&gt;%</span></span>
<span id="cb51-1068"><a href="#cb51-1068" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-1069"><a href="#cb51-1069" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(BASE<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1070"><a href="#cb51-1070" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">&lt;=</span>Nf_hist) <span class="sc">%&gt;%</span></span>
<span id="cb51-1071"><a href="#cb51-1071" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">STUDYID =</span> <span class="fu">rep</span>(<span class="dv">1</span>L<span class="sc">:</span>N_studies_hist, <span class="at">each=</span>Nf_per_study_hist ), <span class="co"># Create a study ID</span></span>
<span id="cb51-1072"><a href="#cb51-1072" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Add a random study effect</span></span>
<span id="cb51-1073"><a href="#cb51-1073" aria-hidden="true" tabindex="-1"></a>         <span class="at">rseff =</span> <span class="fu">rep</span>(<span class="fu">rnorm</span>(<span class="at">n=</span>N_studies_hist, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span><span class="fl">0.1</span>), <span class="at">each=</span>Nf_per_study_hist),</span>
<span id="cb51-1074"><a href="#cb51-1074" aria-hidden="true" tabindex="-1"></a>         <span class="at">USUBJID =</span> <span class="fu">row_number</span>(),</span>
<span id="cb51-1075"><a href="#cb51-1075" aria-hidden="true" tabindex="-1"></a>         <span class="at">TRT01P=</span><span class="fu">factor</span>(<span class="dv">0</span>, <span class="at">levels=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">40</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb51-1076"><a href="#cb51-1076" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">starts_with</span>(<span class="st">"visit"</span>), <span class="at">names_to =</span> <span class="st">"AVISIT"</span>, <span class="at">values_to=</span><span class="st">"AVAL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1077"><a href="#cb51-1077" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-1078"><a href="#cb51-1078" aria-hidden="true" tabindex="-1"></a>    <span class="at">AVAL =</span> AVAL <span class="sc">+</span> rseff,</span>
<span id="cb51-1079"><a href="#cb51-1079" aria-hidden="true" tabindex="-1"></a>    <span class="at">ADY =</span> <span class="fu">case_when</span>(AVISIT<span class="sc">==</span><span class="st">"visit1"</span> <span class="sc">~</span> <span class="dv">2</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb51-1080"><a href="#cb51-1080" aria-hidden="true" tabindex="-1"></a>                    AVISIT<span class="sc">==</span><span class="st">"visit2"</span> <span class="sc">~</span> <span class="dv">4</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb51-1081"><a href="#cb51-1081" aria-hidden="true" tabindex="-1"></a>                    AVISIT<span class="sc">==</span><span class="st">"visit3"</span> <span class="sc">~</span> <span class="dv">8</span>L<span class="sc">*</span><span class="dv">7</span>L,</span>
<span id="cb51-1082"><a href="#cb51-1082" aria-hidden="true" tabindex="-1"></a>                    AVISIT<span class="sc">==</span><span class="st">"visit4"</span> <span class="sc">~</span> <span class="dv">12</span>L<span class="sc">*</span><span class="dv">7</span>L),</span>
<span id="cb51-1083"><a href="#cb51-1083" aria-hidden="true" tabindex="-1"></a>    <span class="at">AVISIT =</span> <span class="fu">factor</span>(AVISIT, <span class="fu">paste0</span>(<span class="st">"visit"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb51-1084"><a href="#cb51-1084" aria-hidden="true" tabindex="-1"></a>    <span class="at">CHG =</span> AVAL <span class="sc">-</span> BASE, </span>
<span id="cb51-1085"><a href="#cb51-1085" aria-hidden="true" tabindex="-1"></a>    <span class="at">STUDYID =</span> <span class="fu">factor</span>(STUDYID, <span class="at">levels=</span><span class="dv">1</span>L<span class="sc">:</span>N_studies_hist<span class="sc">+</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-1086"><a href="#cb51-1086" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>rseff) <span class="sc">%&gt;%</span></span>
<span id="cb51-1087"><a href="#cb51-1087" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(STUDYID, USUBJID, TRT01P, AVISIT, ADY, AVAL, CHG, BASE)</span>
<span id="cb51-1088"><a href="#cb51-1088" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1089"><a href="#cb51-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1090"><a href="#cb51-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plothistdata, echo=FALSE}</span></span>
<span id="cb51-1091"><a href="#cb51-1091" aria-hidden="true" tabindex="-1"></a>historical_studies <span class="sc">%&gt;%</span></span>
<span id="cb51-1092"><a href="#cb51-1092" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(STUDYID, AVISIT) <span class="sc">%&gt;%</span></span>
<span id="cb51-1093"><a href="#cb51-1093" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="st">`</span><span class="at">Mean change from baseline</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(CHG),</span>
<span id="cb51-1094"><a href="#cb51-1094" aria-hidden="true" tabindex="-1"></a>            <span class="st">`</span><span class="at">SE for mean change</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sd</span>(CHG)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">n</span>()),</span>
<span id="cb51-1095"><a href="#cb51-1095" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups=</span><span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1096"><a href="#cb51-1096" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">STUDYID=</span><span class="fu">factor</span>(<span class="dv">1</span>L<span class="sc">:</span><span class="dv">10</span>L, <span class="at">levels=</span><span class="dv">1</span>L<span class="sc">:</span><span class="dv">11</span>L), <span class="at">AVISIT=</span><span class="st">"Baseline"</span>, </span>
<span id="cb51-1097"><a href="#cb51-1097" aria-hidden="true" tabindex="-1"></a>                   <span class="st">`</span><span class="at">Mean change from baseline</span><span class="st">`</span><span class="ot">=</span><span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-1098"><a href="#cb51-1098" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AVISIT, <span class="at">y=</span><span class="st">`</span><span class="at">Mean change from baseline</span><span class="st">`</span>, <span class="at">group=</span>STUDYID, <span class="at">col=</span>STUDYID,</span>
<span id="cb51-1099"><a href="#cb51-1099" aria-hidden="true" tabindex="-1"></a>             <span class="at">ymin=</span><span class="st">`</span><span class="at">Mean change from baseline</span><span class="st">`</span><span class="sc">-</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span><span class="st">`</span><span class="at">SE for mean change</span><span class="st">`</span>,</span>
<span id="cb51-1100"><a href="#cb51-1100" aria-hidden="true" tabindex="-1"></a>             <span class="at">ymax=</span><span class="st">`</span><span class="at">Mean change from baseline</span><span class="st">`</span><span class="sc">+</span><span class="fu">qnorm</span>(<span class="fl">0.975</span>)<span class="sc">*</span><span class="st">`</span><span class="at">SE for mean change</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb51-1101"><a href="#cb51-1101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb51-1102"><a href="#cb51-1102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb51-1103"><a href="#cb51-1103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.1</span>)) <span class="sc">+</span> </span>
<span id="cb51-1104"><a href="#cb51-1104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb51-1105"><a href="#cb51-1105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette=</span><span class="st">"Paired"</span>)</span>
<span id="cb51-1106"><a href="#cb51-1106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1107"><a href="#cb51-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1108"><a href="#cb51-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1109"><a href="#cb51-1109" aria-hidden="true" tabindex="-1"></a>There are [two mathematically equivalent ways of using historical</span>
<span id="cb51-1110"><a href="#cb51-1110" aria-hidden="true" tabindex="-1"></a>data](https://doi.org/10.1111/biom.12242): the meta-analytic</span>
<span id="cb51-1111"><a href="#cb51-1111" aria-hidden="true" tabindex="-1"></a>predictive (MAP) and the meta-analytic combined (MAC) approaches. The</span>
<span id="cb51-1112"><a href="#cb51-1112" aria-hidden="true" tabindex="-1"></a>first step of the MAP approach involves fitting a model to the</span>
<span id="cb51-1113"><a href="#cb51-1113" aria-hidden="true" tabindex="-1"></a>historical data with model parameters allowed to vary hierarchically</span>
<span id="cb51-1114"><a href="#cb51-1114" aria-hidden="true" tabindex="-1"></a>across trials (trial is a random effect). The posterior predictive</span>
<span id="cb51-1115"><a href="#cb51-1115" aria-hidden="true" tabindex="-1"></a>distribution for the parameters of a new trial obtained from this</span>
<span id="cb51-1116"><a href="#cb51-1116" aria-hidden="true" tabindex="-1"></a>model is then used as the prior distribution for the analysis of our</span>
<span id="cb51-1117"><a href="#cb51-1117" aria-hidden="true" tabindex="-1"></a>new trial of interest. In the MAC approach, a single model is fit</span>
<span id="cb51-1118"><a href="#cb51-1118" aria-hidden="true" tabindex="-1"></a>jointly to the historical and new data.</span>
<span id="cb51-1119"><a href="#cb51-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1120"><a href="#cb51-1120" aria-hidden="true" tabindex="-1"></a>Here, we use the MAC approach, because it is easier to implement when there</span>
<span id="cb51-1121"><a href="#cb51-1121" aria-hidden="true" tabindex="-1"></a>are many model parameters that vary across trials. </span>
<span id="cb51-1122"><a href="#cb51-1122" aria-hidden="true" tabindex="-1"></a>However, the <span class="in">`brms`</span> models we specify in either case are almost identical.</span>
<span id="cb51-1123"><a href="#cb51-1123" aria-hidden="true" tabindex="-1"></a>It is also useful to first fit the model to only the historical data, which we </span>
<span id="cb51-1124"><a href="#cb51-1124" aria-hidden="true" tabindex="-1"></a>could then use as an . </span>
<span id="cb51-1125"><a href="#cb51-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1126"><a href="#cb51-1126" aria-hidden="true" tabindex="-1"></a>For a MAP approach we would still use the same model structure as below and use </span>
<span id="cb51-1127"><a href="#cb51-1127" aria-hidden="true" tabindex="-1"></a>the <span class="in">`drop_unused_levels=FALSE`</span> option in <span class="in">`brms`</span> in combination with coding </span>
<span id="cb51-1128"><a href="#cb51-1128" aria-hidden="true" tabindex="-1"></a><span class="in">`STUDYID`</span> to have an additional 11th factor level (for our new study) and </span>
<span id="cb51-1129"><a href="#cb51-1129" aria-hidden="true" tabindex="-1"></a><span class="in">`TRT01P`</span> with the treatment groups of the new study included in its factor </span>
<span id="cb51-1130"><a href="#cb51-1130" aria-hidden="true" tabindex="-1"></a>levels. That way, the number and indexing of parameters inside the generated </span>
<span id="cb51-1131"><a href="#cb51-1131" aria-hidden="true" tabindex="-1"></a>Stan code remains unchanged and <span class="in">`brms`</span> already samples parameter values for a </span>
<span id="cb51-1132"><a href="#cb51-1132" aria-hidden="true" tabindex="-1"></a>new 11th study. We can easily fit such a model only to the historical data </span>
<span id="cb51-1133"><a href="#cb51-1133" aria-hidden="true" tabindex="-1"></a>in order to inspect the resulting predictive distribution, which tells us</span>
<span id="cb51-1134"><a href="#cb51-1134" aria-hidden="true" tabindex="-1"></a>how much information about the parameters of a new study the historical data</span>
<span id="cb51-1135"><a href="#cb51-1135" aria-hidden="true" tabindex="-1"></a>in combination with our specified prior distributions implies.</span>
<span id="cb51-1136"><a href="#cb51-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1137"><a href="#cb51-1137" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mac_with_brms, results='hide', message=FALSE, warning=FALSE}</span></span>
<span id="cb51-1138"><a href="#cb51-1138" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(historical_studies<span class="sc">$</span>AVISIT) <span class="ot">&lt;-</span> MASS<span class="sc">::</span>contr.sdif</span>
<span id="cb51-1139"><a href="#cb51-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1140"><a href="#cb51-1140" aria-hidden="true" tabindex="-1"></a>mmrm_mac_model <span class="ot">&lt;-</span> <span class="fu">bf</span>( CHG  <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> TRT01P<span class="sc">:</span>AVISIT <span class="sc">+</span> ( <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">|</span> STUDYID),  </span>
<span id="cb51-1141"><a href="#cb51-1141" aria-hidden="true" tabindex="-1"></a>                     <span class="at">autocor=</span><span class="sc">~</span><span class="fu">unstr</span>(<span class="at">time=</span>AVISIT, <span class="at">gr=</span>USUBJID), </span>
<span id="cb51-1142"><a href="#cb51-1142" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># center = FALSE, # We would use this option, if we used a MAP approach</span></span>
<span id="cb51-1143"><a href="#cb51-1143" aria-hidden="true" tabindex="-1"></a>                     sigma <span class="sc">~</span>  <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P <span class="sc">|</span> STUDYID))</span>
<span id="cb51-1144"><a href="#cb51-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1145"><a href="#cb51-1145" aria-hidden="true" tabindex="-1"></a><span class="co"># Priors as set are based on the assumed prior unit standard deviation</span></span>
<span id="cb51-1146"><a href="#cb51-1146" aria-hidden="true" tabindex="-1"></a><span class="co"># (usd) of unity. For the random effect for the log of sigma the unit</span></span>
<span id="cb51-1147"><a href="#cb51-1147" aria-hidden="true" tabindex="-1"></a><span class="co"># standard deviation is about sqrt(2).</span></span>
<span id="cb51-1148"><a href="#cb51-1148" aria-hidden="true" tabindex="-1"></a>mmrm_mac_prior <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>Intercept) <span class="sc">+</span></span>
<span id="cb51-1149"><a href="#cb51-1149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">class=</span>b) <span class="sc">+</span></span>
<span id="cb51-1150"><a href="#cb51-1150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.25</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>STUDYID) <span class="sc">+</span> <span class="co"># moderate heterogeneity on the intercept (usd/4)</span></span>
<span id="cb51-1151"><a href="#cb51-1151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>sd, <span class="at">group=</span>STUDYID) <span class="sc">+</span>                <span class="co"># smaller heterogeneity on regression coefficients (usd/8)</span></span>
<span id="cb51-1152"><a href="#cb51-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1153"><a href="#cb51-1153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">10.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>Intercept, <span class="at">dpar=</span>sigma) <span class="sc">+</span></span>
<span id="cb51-1154"><a href="#cb51-1154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">2.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>b, <span class="at">dpar=</span>sigma) <span class="sc">+</span></span>
<span id="cb51-1155"><a href="#cb51-1155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="dv">2</span>)<span class="sc">/</span><span class="fl">4.0</span>), <span class="at">class=</span>sd, <span class="at">coef=</span>Intercept, <span class="at">group=</span>STUDYID, <span class="at">dpar=</span>sigma) <span class="sc">+</span> <span class="co"># same heterogeneity logic </span></span>
<span id="cb51-1156"><a href="#cb51-1156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="dv">2</span>)<span class="sc">/</span><span class="fl">8.0</span>), <span class="at">class=</span>sd, <span class="at">group=</span>STUDYID, <span class="at">dpar=</span>sigma) <span class="sc">+</span>                 <span class="co"># as for main regression coefficients</span></span>
<span id="cb51-1157"><a href="#cb51-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1158"><a href="#cb51-1158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">lkj_corr_cholesky</span>(<span class="dv">1</span>), <span class="at">class=</span>Lcortime) <span class="sc">+</span></span>
<span id="cb51-1159"><a href="#cb51-1159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">lkj</span>(<span class="dv">2</span>), <span class="at">class=</span>cor, <span class="at">group=</span>STUDYID)</span>
<span id="cb51-1160"><a href="#cb51-1160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-1161"><a href="#cb51-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1162"><a href="#cb51-1162" aria-hidden="true" tabindex="-1"></a>histfit <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb51-1163"><a href="#cb51-1163" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula=</span>mmrm_mac_model,</span>
<span id="cb51-1164"><a href="#cb51-1164" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior=</span>mmrm_mac_prior,</span>
<span id="cb51-1165"><a href="#cb51-1165" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> historical_studies,</span>
<span id="cb51-1166"><a href="#cb51-1166" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop_unused_levels=</span><span class="cn">FALSE</span>,</span>
<span id="cb51-1167"><a href="#cb51-1167" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">234525</span>,</span>
<span id="cb51-1168"><a href="#cb51-1168" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> control_args,</span>
<span id="cb51-1169"><a href="#cb51-1169" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb51-1170"><a href="#cb51-1170" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1171"><a href="#cb51-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1172"><a href="#cb51-1172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1173"><a href="#cb51-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1174"><a href="#cb51-1174" aria-hidden="true" tabindex="-1"></a>Note that our simulation code created a dataset with <span class="in">`STUDYID`</span> column that</span>
<span id="cb51-1175"><a href="#cb51-1175" aria-hidden="true" tabindex="-1"></a>labels the 10 different studies being simulated and in addition has an extra</span>
<span id="cb51-1176"><a href="#cb51-1176" aria-hidden="true" tabindex="-1"></a>11th factor level for a new study.</span>
<span id="cb51-1177"><a href="#cb51-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1178"><a href="#cb51-1178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=TRUE}</span></span>
<span id="cb51-1179"><a href="#cb51-1179" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(historical_studies<span class="sc">$</span>STUDYID)</span>
<span id="cb51-1180"><a href="#cb51-1180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1181"><a href="#cb51-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1182"><a href="#cb51-1182" aria-hidden="true" tabindex="-1"></a>This trick with the extra factor level (plus using the </span>
<span id="cb51-1183"><a href="#cb51-1183" aria-hidden="true" tabindex="-1"></a><span class="in">`drop_unused_levels=FALSE`</span> option in <span class="in">`brms`</span>) automatically creates samples </span>
<span id="cb51-1184"><a href="#cb51-1184" aria-hidden="true" tabindex="-1"></a>from the predictive distribution for the parameters of a new hypothetical study. </span>
<span id="cb51-1185"><a href="#cb51-1185" aria-hidden="true" tabindex="-1"></a>Without this trick we would have to sample from a multivariate normal </span>
<span id="cb51-1186"><a href="#cb51-1186" aria-hidden="true" tabindex="-1"></a>distribution for each MCMC sample in order to get the correlation of predicted</span>
<span id="cb51-1187"><a href="#cb51-1187" aria-hidden="true" tabindex="-1"></a>parameters right. Instead, we can now simply add the population-level parameter </span>
<span id="cb51-1188"><a href="#cb51-1188" aria-hidden="true" tabindex="-1"></a>estimate plus the study specific parameter estimate for the hypothetical new </span>
<span id="cb51-1189"><a href="#cb51-1189" aria-hidden="true" tabindex="-1"></a>(11th) study (for which we had no data). This will then already correctly </span>
<span id="cb51-1190"><a href="#cb51-1190" aria-hidden="true" tabindex="-1"></a>reflect the correlation between the predictions for the different</span>
<span id="cb51-1191"><a href="#cb51-1191" aria-hidden="true" tabindex="-1"></a>parameters.</span>
<span id="cb51-1192"><a href="#cb51-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1193"><a href="#cb51-1193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r predictive_dist_brms, message=FALSE, warning=FALSE}</span></span>
<span id="cb51-1194"><a href="#cb51-1194" aria-hidden="true" tabindex="-1"></a>predictive_dist <span class="ot">&lt;-</span> histfit <span class="sc">%&gt;%</span></span>
<span id="cb51-1195"><a href="#cb51-1195" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_rvars</span>(<span class="at">variable=</span><span class="fu">c</span>(<span class="st">"^b_"</span>, <span class="st">"^r_STUDYID"</span>), <span class="at">regex=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1196"><a href="#cb51-1196" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_variables</span>(<span class="at">b_Intercept =</span> b_Intercept <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"Intercept"</span>],</span>
<span id="cb51-1197"><a href="#cb51-1197" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b_AVISITvisit2Mvisit1 =</span> b_AVISITvisit2Mvisit1 <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit2Mvisit1"</span>],</span>
<span id="cb51-1198"><a href="#cb51-1198" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b_AVISITvisit3Mvisit2 =</span> b_AVISITvisit3Mvisit2 <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit3Mvisit2"</span>],</span>
<span id="cb51-1199"><a href="#cb51-1199" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b_AVISITvisit4Mvisit3 =</span> b_AVISITvisit4Mvisit3 <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit4Mvisit3"</span>],</span>
<span id="cb51-1200"><a href="#cb51-1200" aria-hidden="true" tabindex="-1"></a>                     <span class="at">b_BASE =</span> b_BASE <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"BASE"</span>],</span>
<span id="cb51-1201"><a href="#cb51-1201" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">b_AVISITvisit2Mvisit1:BASE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">b_AVISITvisit2Mvisit1:BASE</span><span class="st">`</span> <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit2Mvisit1:BASE"</span>],</span>
<span id="cb51-1202"><a href="#cb51-1202" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">b_AVISITvisit3Mvisit2:BASE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">b_AVISITvisit3Mvisit2:BASE</span><span class="st">`</span> <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit3Mvisit2:BASE"</span>],</span>
<span id="cb51-1203"><a href="#cb51-1203" aria-hidden="true" tabindex="-1"></a>                     <span class="st">`</span><span class="at">b_AVISITvisit4Mvisit3:BASE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">b_AVISITvisit4Mvisit3:BASE</span><span class="st">`</span> <span class="sc">+</span> r_STUDYID[<span class="dv">11</span>,<span class="st">"AVISITvisit4Mvisit3:BASE"</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb51-1204"><a href="#cb51-1204" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset_draws</span>(<span class="at">variable=</span><span class="fu">c</span>(<span class="st">"^b_Intercept"</span>, <span class="st">"^b_AVISIT.*"</span>, <span class="st">"^b_BASE.*"</span>), <span class="at">regex=</span><span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1205"><a href="#cb51-1205" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_draws_df</span>()</span>
<span id="cb51-1206"><a href="#cb51-1206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1207"><a href="#cb51-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1208"><a href="#cb51-1208" aria-hidden="true" tabindex="-1"></a>We could now explore and visualize the joint distribution of these predicted</span>
<span id="cb51-1209"><a href="#cb51-1209" aria-hidden="true" tabindex="-1"></a>parameter values in order to get an idea for the prior distribution induced</span>
<span id="cb51-1210"><a href="#cb51-1210" aria-hidden="true" tabindex="-1"></a>by the historical data.</span>
<span id="cb51-1211"><a href="#cb51-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1212"><a href="#cb51-1212" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- not sure if this plot is really helpful. Drop? ---&gt;</span></span>
<span id="cb51-1213"><a href="#cb51-1213" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb51-1214"><a href="#cb51-1214" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- predictive_dist %&gt;%  --&gt;</span></span>
<span id="cb51-1215"><a href="#cb51-1215" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   as_tibble() %&gt;%  --&gt;</span></span>
<span id="cb51-1216"><a href="#cb51-1216" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   dplyr::select(-.chain, -.iteration, -.draw) %&gt;% --&gt;</span></span>
<span id="cb51-1217"><a href="#cb51-1217" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   GGally::ggpairs() + --&gt;</span></span>
<span id="cb51-1218"><a href="#cb51-1218" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   theme_bw(base_size=12) --&gt;</span></span>
<span id="cb51-1219"><a href="#cb51-1219" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb51-1220"><a href="#cb51-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1221"><a href="#cb51-1221" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"alert alert-info"</span><span class="dt">&gt;</span></span>
<span id="cb51-1222"><a href="#cb51-1222" aria-hidden="true" tabindex="-1"></a>The <span class="co">[</span><span class="ot">MAP approach</span><span class="co">](https://doi.org/10.1002/sim.5851)</span> has been very popular </span>
<span id="cb51-1223"><a href="#cb51-1223" aria-hidden="true" tabindex="-1"></a>at Novartis, especially for proof of </span>
<span id="cb51-1224"><a href="#cb51-1224" aria-hidden="true" tabindex="-1"></a>concept studies. To use it, we would now have to approximate the joint </span>
<span id="cb51-1225"><a href="#cb51-1225" aria-hidden="true" tabindex="-1"></a>predictive distribution of the model parameters using a suitable multivariate </span>
<span id="cb51-1226"><a href="#cb51-1226" aria-hidden="true" tabindex="-1"></a>distribution such as a multivariate Student-t distribution. Then, we would have</span>
<span id="cb51-1227"><a href="#cb51-1227" aria-hidden="true" tabindex="-1"></a>to correctly add Stan code to the <span class="in">`stanvars`</span> argument to the <span class="in">`brm`</span> call in order</span>
<span id="cb51-1228"><a href="#cb51-1228" aria-hidden="true" tabindex="-1"></a>to specify this prior distribution. We would also use <span class="in">`center=FALSE`</span> to the </span>
<span id="cb51-1229"><a href="#cb51-1229" aria-hidden="true" tabindex="-1"></a>brms-formula function <span class="in">`bf()`</span> in order to make setting priors easier, which </span>
<span id="cb51-1230"><a href="#cb51-1230" aria-hidden="true" tabindex="-1"></a>would otherwise get harder if we let <span class="in">`brms`</span> center covariates.</span>
<span id="cb51-1231"><a href="#cb51-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1232"><a href="#cb51-1232" aria-hidden="true" tabindex="-1"></a>Thus, implementing the MAP approach with <span class="in">`brms`</span> is currently a quite advanced </span>
<span id="cb51-1233"><a href="#cb51-1233" aria-hidden="true" tabindex="-1"></a>task. However, this will become a lot easier once support for it is available </span>
<span id="cb51-1234"><a href="#cb51-1234" aria-hidden="true" tabindex="-1"></a>in the <span class="in">`RBesT`</span> package.</span>
<span id="cb51-1235"><a href="#cb51-1235" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb51-1236"><a href="#cb51-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1237"><a href="#cb51-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1238"><a href="#cb51-1238" aria-hidden="true" tabindex="-1"></a>Below is the code for fitting a MMRM to the historical and new trial data jointly. </span>
<span id="cb51-1239"><a href="#cb51-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1240"><a href="#cb51-1240" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fit_mac_with_brms, results='hide', message=FALSE, warning=FALSE}</span></span>
<span id="cb51-1241"><a href="#cb51-1241" aria-hidden="true" tabindex="-1"></a>combined_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(historical_studies <span class="sc">%&gt;%</span></span>
<span id="cb51-1242"><a href="#cb51-1242" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">mutate</span>(<span class="at">historical=</span><span class="fu">factor</span>(<span class="dv">1</span>L, <span class="at">levels=</span><span class="dv">0</span>L<span class="sc">:</span><span class="dv">1</span>L)),</span>
<span id="cb51-1243"><a href="#cb51-1243" aria-hidden="true" tabindex="-1"></a>                           simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb51-1244"><a href="#cb51-1244" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">mutate</span>(<span class="at">STUDYID=</span><span class="fu">factor</span>(<span class="dv">11</span>, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>),</span>
<span id="cb51-1245"><a href="#cb51-1245" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">USUBJID=</span>USUBJID<span class="sc">+</span><span class="fu">max</span>(historical_studies<span class="sc">$</span>USUBJID),</span>
<span id="cb51-1246"><a href="#cb51-1246" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">historical=</span><span class="fu">factor</span>(<span class="dv">0</span>L, <span class="at">levels=</span><span class="dv">0</span>L<span class="sc">:</span><span class="dv">1</span>L)))</span>
<span id="cb51-1247"><a href="#cb51-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1248"><a href="#cb51-1248" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(combined_data<span class="sc">$</span>AVISIT) <span class="ot">&lt;-</span> MASS<span class="sc">::</span>contr.sdif</span>
<span id="cb51-1249"><a href="#cb51-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1250"><a href="#cb51-1250" aria-hidden="true" tabindex="-1"></a>macfit <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb51-1251"><a href="#cb51-1251" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> mmrm_mac_model,</span>
<span id="cb51-1252"><a href="#cb51-1252" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> mmrm_mac_prior,</span>
<span id="cb51-1253"><a href="#cb51-1253" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> combined_data,       <span class="co"># now using the combined data</span></span>
<span id="cb51-1254"><a href="#cb51-1254" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop_unused_levels =</span> <span class="cn">FALSE</span>, <span class="co"># Important, if we fit only to the historical data</span></span>
<span id="cb51-1255"><a href="#cb51-1255" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">234525</span>,</span>
<span id="cb51-1256"><a href="#cb51-1256" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> control_args,</span>
<span id="cb51-1257"><a href="#cb51-1257" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">iter=</span><span class="dv">20</span>, <span class="at">warmup=</span><span class="dv">10</span></span>
<span id="cb51-1258"><a href="#cb51-1258" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1259"><a href="#cb51-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1260"><a href="#cb51-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1261"><a href="#cb51-1261" aria-hidden="true" tabindex="-1"></a>This gives us the following inference about the treatment effects at </span>
<span id="cb51-1262"><a href="#cb51-1262" aria-hidden="true" tabindex="-1"></a>each visit:</span>
<span id="cb51-1263"><a href="#cb51-1263" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # ```{r} --&gt;</span></span>
<span id="cb51-1264"><a href="#cb51-1264" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # # Or, of course again via  --&gt;</span></span>
<span id="cb51-1265"><a href="#cb51-1265" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # # emmeans(brmfit1b, ~ TRT01P | AVISIT, weights = "proportional") --&gt;</span></span>
<span id="cb51-1266"><a href="#cb51-1266" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # hypothesis(macfit, contrasts_of_interest)$hypothesis %&gt;% --&gt;</span></span>
<span id="cb51-1267"><a href="#cb51-1267" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   ggplot(aes(y=Hypothesis, x=Estimate, xmin=CI.Lower, xmax=CI.Upper)) + --&gt;</span></span>
<span id="cb51-1268"><a href="#cb51-1268" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #       geom_vline(xintercept=0) + --&gt;</span></span>
<span id="cb51-1269"><a href="#cb51-1269" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #       geom_point() + --&gt;</span></span>
<span id="cb51-1270"><a href="#cb51-1270" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #       geom_errorbar() + --&gt;</span></span>
<span id="cb51-1271"><a href="#cb51-1271" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #       xlab("Treatment difference to placebo") --&gt;</span></span>
<span id="cb51-1272"><a href="#cb51-1272" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # ``` --&gt;</span></span>
<span id="cb51-1273"><a href="#cb51-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1274"><a href="#cb51-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lsmeans_mac_brms}</span></span>
<span id="cb51-1275"><a href="#cb51-1275" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(macfit, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights =</span> <span class="st">"proportional"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1276"><a href="#cb51-1276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">contrast</span>(., <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1277"><a href="#cb51-1277" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-1278"><a href="#cb51-1278" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AVISIT, <span class="at">y=</span>estimate, <span class="at">ymin=</span>lower.HPD, <span class="at">ymax=</span>upper.HPD, <span class="at">color=</span>contrast)) <span class="sc">+</span></span>
<span id="cb51-1279"><a href="#cb51-1279" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb51-1280"><a href="#cb51-1280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb51-1281"><a href="#cb51-1281" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb51-1282"><a href="#cb51-1282" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb51-1283"><a href="#cb51-1283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Treatment difference to placebo"</span>) <span class="sc">+</span></span>
<span id="cb51-1284"><a href="#cb51-1284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Visit"</span>) <span class="sc">+</span></span>
<span id="cb51-1285"><a href="#cb51-1285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)[<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb51-1286"><a href="#cb51-1286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb51-1287"><a href="#cb51-1287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">nrow=</span><span class="dv">3</span>))</span>
<span id="cb51-1288"><a href="#cb51-1288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1289"><a href="#cb51-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1290"><a href="#cb51-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1291"><a href="#cb51-1291" aria-hidden="true" tabindex="-1"></a><span class="fu">### Robust Meta-analytic combined (rMAC) approach to historical data for MMRMs</span></span>
<span id="cb51-1292"><a href="#cb51-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1293"><a href="#cb51-1293" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"alert alert-info"</span><span class="dt">&gt;</span></span>
<span id="cb51-1294"><a href="#cb51-1294" aria-hidden="true" tabindex="-1"></a>  **WARNING**: This section presents initial ideas for a robust MAC approach.</span>
<span id="cb51-1295"><a href="#cb51-1295" aria-hidden="true" tabindex="-1"></a>  The discussed technique is not well-understood in the MMRM setting with a</span>
<span id="cb51-1296"><a href="#cb51-1296" aria-hidden="true" tabindex="-1"></a>  larger number of parameters, about which borrowing of information is needed. </span>
<span id="cb51-1297"><a href="#cb51-1297" aria-hidden="true" tabindex="-1"></a>  The discussed approach is the subject of ongoing research and its</span>
<span id="cb51-1298"><a href="#cb51-1298" aria-hidden="true" tabindex="-1"></a>  operating characteristics are not well-understood. It is shared to</span>
<span id="cb51-1299"><a href="#cb51-1299" aria-hidden="true" tabindex="-1"></a>  illustrate features of <span class="in">`brms`</span> and to gather feedback. Do not</span>
<span id="cb51-1300"><a href="#cb51-1300" aria-hidden="true" tabindex="-1"></a>  use without careful testing for your specific setting (e.g. via simulation).</span>
<span id="cb51-1301"><a href="#cb51-1301" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb51-1302"><a href="#cb51-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1303"><a href="#cb51-1303" aria-hidden="true" tabindex="-1"></a>One popular variant of the <span class="co">[</span><span class="ot">MAP approach</span><span class="co">](https://doi.org/10.1002/sim.5851)</span> is</span>
<span id="cb51-1304"><a href="#cb51-1304" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">its robust rMAP version</span><span class="co">](https://doi.org/10.1111/biom.12242)</span> that adds a</span>
<span id="cb51-1305"><a href="#cb51-1305" aria-hidden="true" tabindex="-1"></a>uninformative or weakly informative mixture component to the MAP prior. In this</span>
<span id="cb51-1306"><a href="#cb51-1306" aria-hidden="true" tabindex="-1"></a>way the historical prior information can be discarded or donweighted when there</span>
<span id="cb51-1307"><a href="#cb51-1307" aria-hidden="true" tabindex="-1"></a>is an apparent prior-data-conflict.</span>
<span id="cb51-1308"><a href="#cb51-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1309"><a href="#cb51-1309" aria-hidden="true" tabindex="-1"></a>A way of obtaining a type of</span>
<span id="cb51-1310"><a href="#cb51-1310" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">robust MAC (rMAC) approach</span><span class="co">](https://doi.org/10.1080/19466315.2019.1610043)</span> is</span>
<span id="cb51-1311"><a href="#cb51-1311" aria-hidden="true" tabindex="-1"></a>to introduce an additional model parameter that indicates how much the parameters </span>
<span id="cb51-1312"><a href="#cb51-1312" aria-hidden="true" tabindex="-1"></a>of the new data differ from the historical data and to assign this parameter</span>
<span id="cb51-1313"><a href="#cb51-1313" aria-hidden="true" tabindex="-1"></a>a "slab-and-spike"-type prior. I.e. a prior distribution that is peaked at zero</span>
<span id="cb51-1314"><a href="#cb51-1314" aria-hidden="true" tabindex="-1"></a>and heavy-tailed such as a double-exponential (DE) distribution (aka "Laplace </span>
<span id="cb51-1315"><a href="#cb51-1315" aria-hidden="true" tabindex="-1"></a>distribution"). </span>
<span id="cb51-1316"><a href="#cb51-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1317"><a href="#cb51-1317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot_de_dist}</span></span>
<span id="cb51-1318"><a href="#cb51-1318" aria-hidden="true" tabindex="-1"></a><span class="fu">expand_grid</span>(<span class="at">mean=</span><span class="dv">0</span>, <span class="at">scale=</span><span class="fu">c</span>(<span class="fl">0.125</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">x=</span><span class="fu">seq</span>(<span class="sc">-</span><span class="fl">2.5</span>, <span class="fl">2.5</span>, <span class="fl">0.01</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-1319"><a href="#cb51-1319" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">density =</span> <span class="fu">dasym_laplace</span>(x, mean, scale),</span>
<span id="cb51-1320"><a href="#cb51-1320" aria-hidden="true" tabindex="-1"></a>           <span class="at">scale=</span><span class="fu">factor</span>(scale)) <span class="sc">%&gt;%</span></span>
<span id="cb51-1321"><a href="#cb51-1321" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>density, <span class="at">col=</span>scale, <span class="at">label=</span>scale)) <span class="sc">+</span></span>
<span id="cb51-1322"><a href="#cb51-1322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth=</span><span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb51-1323"><a href="#cb51-1323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"DE(0, scale) density for various</span><span class="sc">\n</span><span class="st">scale parameter values"</span>) <span class="sc">+</span></span>
<span id="cb51-1324"><a href="#cb51-1324" aria-hidden="true" tabindex="-1"></a>    directlabels<span class="sc">::</span><span class="fu">geom_dl</span>(<span class="at">method=</span><span class="st">"smart.grid"</span>)</span>
<span id="cb51-1325"><a href="#cb51-1325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1326"><a href="#cb51-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1327"><a href="#cb51-1327" aria-hidden="true" tabindex="-1"></a>However, while this approach is well understood for a single control</span>
<span id="cb51-1328"><a href="#cb51-1328" aria-hidden="true" tabindex="-1"></a>group log-event-rate or logit-proportion, there is currently no</span>
<span id="cb51-1329"><a href="#cb51-1329" aria-hidden="true" tabindex="-1"></a>experience with it for continuous data and multiple parameters. For</span>
<span id="cb51-1330"><a href="#cb51-1330" aria-hidden="true" tabindex="-1"></a>example, it is not immediately obvious how to encode a prior belief</span>
<span id="cb51-1331"><a href="#cb51-1331" aria-hidden="true" tabindex="-1"></a>that when outcomes at one visit are similar to historical data, we</span>
<span id="cb51-1332"><a href="#cb51-1332" aria-hidden="true" tabindex="-1"></a>become more likely to believe this about other visits. Here we setup</span>
<span id="cb51-1333"><a href="#cb51-1333" aria-hidden="true" tabindex="-1"></a>the scale of the DE distribution such that the tail probability beyond</span>
<span id="cb51-1334"><a href="#cb51-1334" aria-hidden="true" tabindex="-1"></a>the unit standard deviation of unity is close to 5%. This will ensure</span>
<span id="cb51-1335"><a href="#cb51-1335" aria-hidden="true" tabindex="-1"></a>that most mass of the prior is centered around 0 while very large</span>
<span id="cb51-1336"><a href="#cb51-1336" aria-hidden="true" tabindex="-1"></a>deviations are allowed for by the long tail of the DE distribution. A</span>
<span id="cb51-1337"><a href="#cb51-1337" aria-hidden="true" tabindex="-1"></a>more detailed analysis of this prior is subject to research.</span>
<span id="cb51-1338"><a href="#cb51-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1339"><a href="#cb51-1339" aria-hidden="true" tabindex="-1"></a>With these caveats stated, here is how one can implement this model</span>
<span id="cb51-1340"><a href="#cb51-1340" aria-hidden="true" tabindex="-1"></a>with <span class="in">`brms`</span>:</span>
<span id="cb51-1341"><a href="#cb51-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1342"><a href="#cb51-1342" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fit_rmac_brms, message=FALSE, results="hide"}</span></span>
<span id="cb51-1343"><a href="#cb51-1343" aria-hidden="true" tabindex="-1"></a>mmrm_rmac_model <span class="ot">&lt;-</span> <span class="fu">bf</span>( CHG  <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> historical <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> TRT01P<span class="sc">:</span>AVISIT <span class="sc">+</span> </span>
<span id="cb51-1344"><a href="#cb51-1344" aria-hidden="true" tabindex="-1"></a>                         AVISIT<span class="sc">:</span>historical <span class="sc">+</span> BASE<span class="sc">:</span>historical <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT<span class="sc">:</span>historical <span class="sc">+</span></span>
<span id="cb51-1345"><a href="#cb51-1345" aria-hidden="true" tabindex="-1"></a>                         ( <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT <span class="sc">|</span> STUDYID),  </span>
<span id="cb51-1346"><a href="#cb51-1346" aria-hidden="true" tabindex="-1"></a>                     <span class="at">autocor=</span><span class="sc">~</span><span class="fu">unstr</span>(<span class="at">time=</span>AVISIT, <span class="at">gr=</span>USUBJID), </span>
<span id="cb51-1347"><a href="#cb51-1347" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># center = FALSE, # We would use this option, if we used a MAP approach</span></span>
<span id="cb51-1348"><a href="#cb51-1348" aria-hidden="true" tabindex="-1"></a>                     sigma <span class="sc">~</span>  <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">|</span> STUDYID))</span>
<span id="cb51-1349"><a href="#cb51-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1350"><a href="#cb51-1350" aria-hidden="true" tabindex="-1"></a><span class="co"># can be used to find out on instantiated parameters</span></span>
<span id="cb51-1351"><a href="#cb51-1351" aria-hidden="true" tabindex="-1"></a><span class="co">#get_prior(mmrm_rmac_model, combined_data)</span></span>
<span id="cb51-1352"><a href="#cb51-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1353"><a href="#cb51-1353" aria-hidden="true" tabindex="-1"></a>mmrm_rmac_prior <span class="ot">&lt;-</span> mmrm_mac_prior <span class="sc">+</span></span>
<span id="cb51-1354"><a href="#cb51-1354" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.25</span>), <span class="at">class=</span>b, <span class="at">coef=</span>historical1) <span class="sc">+</span></span>
<span id="cb51-1355"><a href="#cb51-1355" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>BASE<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb51-1356"><a href="#cb51-1356" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit2Mvisit1<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb51-1357"><a href="#cb51-1357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit3Mvisit2<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb51-1358"><a href="#cb51-1358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit4Mvisit3<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb51-1359"><a href="#cb51-1359" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit2Mvisit1<span class="sc">:</span>BASE<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb51-1360"><a href="#cb51-1360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit3Mvisit2<span class="sc">:</span>BASE<span class="sc">:</span>historical1) <span class="sc">+</span></span>
<span id="cb51-1361"><a href="#cb51-1361" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">double_exponential</span>(<span class="dv">0</span>, <span class="fl">0.125</span>), <span class="at">class=</span>b, <span class="at">coef=</span>AVISITvisit4Mvisit3<span class="sc">:</span>BASE<span class="sc">:</span>historical1)</span>
<span id="cb51-1362"><a href="#cb51-1362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1363"><a href="#cb51-1363" aria-hidden="true" tabindex="-1"></a>rmacfit <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb51-1364"><a href="#cb51-1364" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula=</span>mmrm_rmac_model,</span>
<span id="cb51-1365"><a href="#cb51-1365" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior=</span>mmrm_rmac_prior,</span>
<span id="cb51-1366"><a href="#cb51-1366" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> combined_data,</span>
<span id="cb51-1367"><a href="#cb51-1367" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop_unused_levels=</span><span class="cn">FALSE</span>,</span>
<span id="cb51-1368"><a href="#cb51-1368" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">234525</span>,</span>
<span id="cb51-1369"><a href="#cb51-1369" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> control_args,</span>
<span id="cb51-1370"><a href="#cb51-1370" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb51-1371"><a href="#cb51-1371" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1372"><a href="#cb51-1372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1373"><a href="#cb51-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1374"><a href="#cb51-1374" aria-hidden="true" tabindex="-1"></a>This gives us the following inference about the treatment effects at </span>
<span id="cb51-1375"><a href="#cb51-1375" aria-hidden="true" tabindex="-1"></a>each visit:</span>
<span id="cb51-1376"><a href="#cb51-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1377"><a href="#cb51-1377" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb51-1378"><a href="#cb51-1378" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Or, of course again via  --&gt;</span></span>
<span id="cb51-1379"><a href="#cb51-1379" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # emmeans(brmfit1b, ~ TRT01P | AVISIT, weights = "proportional") --&gt;</span></span>
<span id="cb51-1380"><a href="#cb51-1380" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- hypothesis(rmacfit, contrasts_of_interest)$hypothesis %&gt;% --&gt;</span></span>
<span id="cb51-1381"><a href="#cb51-1381" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ggplot(aes(y=Hypothesis, x=Estimate, xmin=CI.Lower, xmax=CI.Upper)) + --&gt;</span></span>
<span id="cb51-1382"><a href="#cb51-1382" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--       geom_vline(xintercept=0) + --&gt;</span></span>
<span id="cb51-1383"><a href="#cb51-1383" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--       geom_point() + --&gt;</span></span>
<span id="cb51-1384"><a href="#cb51-1384" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--       geom_errorbar() + --&gt;</span></span>
<span id="cb51-1385"><a href="#cb51-1385" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--       xlab("Treatment difference to placebo") --&gt;</span></span>
<span id="cb51-1386"><a href="#cb51-1386" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb51-1387"><a href="#cb51-1387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r contrasts_for_rmac}</span></span>
<span id="cb51-1388"><a href="#cb51-1388" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(rmacfit, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights =</span> <span class="st">"proportional"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1389"><a href="#cb51-1389" aria-hidden="true" tabindex="-1"></a>    <span class="fu">contrast</span>(., <span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1390"><a href="#cb51-1390" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-1391"><a href="#cb51-1391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AVISIT, <span class="at">y=</span>estimate, <span class="at">ymin=</span>lower.HPD, <span class="at">ymax=</span>upper.HPD, <span class="at">color=</span>contrast)) <span class="sc">+</span></span>
<span id="cb51-1392"><a href="#cb51-1392" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb51-1393"><a href="#cb51-1393" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb51-1394"><a href="#cb51-1394" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb51-1395"><a href="#cb51-1395" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb51-1396"><a href="#cb51-1396" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Treatment difference to placebo"</span>) <span class="sc">+</span></span>
<span id="cb51-1397"><a href="#cb51-1397" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Visit"</span>) <span class="sc">+</span></span>
<span id="cb51-1398"><a href="#cb51-1398" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)[<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb51-1399"><a href="#cb51-1399" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb51-1400"><a href="#cb51-1400" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">nrow=</span><span class="dv">3</span>))</span>
<span id="cb51-1401"><a href="#cb51-1401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1402"><a href="#cb51-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1403"><a href="#cb51-1403" aria-hidden="true" tabindex="-1"></a><span class="fu">### Going beyond the traditional MMRM: monotonic effects</span></span>
<span id="cb51-1404"><a href="#cb51-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1405"><a href="#cb51-1405" aria-hidden="true" tabindex="-1"></a>Now, let us look at some ways, in which we can add some advanced features</span>
<span id="cb51-1406"><a href="#cb51-1406" aria-hidden="true" tabindex="-1"></a>of <span class="in">`brms`</span> on top of a MMRM. </span>
<span id="cb51-1407"><a href="#cb51-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1408"><a href="#cb51-1408" aria-hidden="true" tabindex="-1"></a>What if we wanted to make our analysis more efficient by exploiting knowledge</span>
<span id="cb51-1409"><a href="#cb51-1409" aria-hidden="true" tabindex="-1"></a>about the structure of the experiment? E.g. what if we wanted to assume a</span>
<span id="cb51-1410"><a href="#cb51-1410" aria-hidden="true" tabindex="-1"></a>monotonic increase of efficacy across doses (for the treatment main effect) and</span>
<span id="cb51-1411"><a href="#cb51-1411" aria-hidden="true" tabindex="-1"></a>assume the how this effect differs at each visit is also monotonly across</span>
<span id="cb51-1412"><a href="#cb51-1412" aria-hidden="true" tabindex="-1"></a>doses?</span>
<span id="cb51-1413"><a href="#cb51-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1414"><a href="#cb51-1414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mmrm_mo_brms, results='hide', message=FALSE, warning=FALSE}</span></span>
<span id="cb51-1415"><a href="#cb51-1415" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(simulated_data<span class="sc">$</span>AVISIT) <span class="ot">&lt;-</span> MASS<span class="sc">::</span>contr.sdif</span>
<span id="cb51-1416"><a href="#cb51-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1417"><a href="#cb51-1417" aria-hidden="true" tabindex="-1"></a>mmrm_mo_model <span class="ot">&lt;-</span> <span class="fu">bf</span>( CHG <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> <span class="fu">mo</span>(TRT01P) <span class="sc">+</span> BASE <span class="sc">+</span> <span class="fu">mo</span>(TRT01P)<span class="sc">:</span>AVISIT <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT,</span>
<span id="cb51-1418"><a href="#cb51-1418" aria-hidden="true" tabindex="-1"></a>                     <span class="at">autocor=</span><span class="sc">~</span><span class="fu">unstr</span>(AVISIT, USUBJID), </span>
<span id="cb51-1419"><a href="#cb51-1419" aria-hidden="true" tabindex="-1"></a>                     sigma <span class="sc">~</span><span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P)</span>
<span id="cb51-1420"><a href="#cb51-1420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1421"><a href="#cb51-1421" aria-hidden="true" tabindex="-1"></a><span class="co"># use the same prior as before and use the default dirichlet(1) priors</span></span>
<span id="cb51-1422"><a href="#cb51-1422" aria-hidden="true" tabindex="-1"></a><span class="co"># of brms for the increase fractions of the monotonic effects. This</span></span>
<span id="cb51-1423"><a href="#cb51-1423" aria-hidden="true" tabindex="-1"></a><span class="co"># represents a a uniform prior over the fractions</span></span>
<span id="cb51-1424"><a href="#cb51-1424" aria-hidden="true" tabindex="-1"></a>mmrm_mo_prior <span class="ot">&lt;-</span> mmrm_prior1</span>
<span id="cb51-1425"><a href="#cb51-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1426"><a href="#cb51-1426" aria-hidden="true" tabindex="-1"></a>brmfit2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb51-1427"><a href="#cb51-1427" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> mmrm_mo_model,</span>
<span id="cb51-1428"><a href="#cb51-1428" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> mmrm_mo_prior,</span>
<span id="cb51-1429"><a href="#cb51-1429" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> simulated_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">TRT01P=</span><span class="fu">ordered</span>(TRT01P)),</span>
<span id="cb51-1430"><a href="#cb51-1430" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> control_args,</span>
<span id="cb51-1431"><a href="#cb51-1431" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb51-1432"><a href="#cb51-1432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1433"><a href="#cb51-1433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1434"><a href="#cb51-1434" aria-hidden="true" tabindex="-1"></a>The syntax of <span class="in">`emmeans`</span> would in this case still be very</span>
<span id="cb51-1435"><a href="#cb51-1435" aria-hidden="true" tabindex="-1"></a>straightforward:</span>
<span id="cb51-1436"><a href="#cb51-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1437"><a href="#cb51-1437" aria-hidden="true" tabindex="-1"></a><span class="in">```{r contrasts_mo_mmrm}</span></span>
<span id="cb51-1438"><a href="#cb51-1438" aria-hidden="true" tabindex="-1"></a><span class="fu">emmeans</span>(brmfit2, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1439"><a href="#cb51-1439" aria-hidden="true" tabindex="-1"></a>    <span class="fu">contrast</span>(<span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1440"><a href="#cb51-1440" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-1441"><a href="#cb51-1441" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>AVISIT, <span class="at">y=</span>estimate, <span class="at">ymin=</span>lower.HPD, <span class="at">ymax=</span>upper.HPD, <span class="at">color=</span>contrast)) <span class="sc">+</span></span>
<span id="cb51-1442"><a href="#cb51-1442" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb51-1443"><a href="#cb51-1443" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb51-1444"><a href="#cb51-1444" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb51-1445"><a href="#cb51-1445" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb51-1446"><a href="#cb51-1446" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Treatment difference to placebo"</span>) <span class="sc">+</span></span>
<span id="cb51-1447"><a href="#cb51-1447" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Visit"</span>) <span class="sc">+</span></span>
<span id="cb51-1448"><a href="#cb51-1448" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)[<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb51-1449"><a href="#cb51-1449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb51-1450"><a href="#cb51-1450" aria-hidden="true" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">nrow=</span><span class="dv">3</span>))</span>
<span id="cb51-1451"><a href="#cb51-1451" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1452"><a href="#cb51-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1453"><a href="#cb51-1453" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Instead, the `brms` specific approach using `hypothesis` requires us to --&gt;</span></span>
<span id="cb51-1454"><a href="#cb51-1454" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- understand the exact way that `brms` parameterizes monotonic predictors. For --&gt;</span></span>
<span id="cb51-1455"><a href="#cb51-1455" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- a variable with $K+1$ ordinal categories, the effect of the variable is --&gt;</span></span>
<span id="cb51-1456"><a href="#cb51-1456" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- parameterized to be $0$ for the reference category and --&gt;</span></span>
<span id="cb51-1457"><a href="#cb51-1457" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$(\text{maximum effect in highest category}) \times K \times \sum_{m=1}^k \zeta_m$$ --&gt;</span></span>
<span id="cb51-1458"><a href="#cb51-1458" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- for a category $k$ above the reference category, where --&gt;</span></span>
<span id="cb51-1459"><a href="#cb51-1459" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $\sum_{m=1}^K \zeta_m = 1$. --&gt;</span></span>
<span id="cb51-1460"><a href="#cb51-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1461"><a href="#cb51-1461" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- In our case, $K=3$ for the doses, because there are three active doses and --&gt;</span></span>
<span id="cb51-1462"><a href="#cb51-1462" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- placebo is the reference category. With this, we can look up how these --&gt;</span></span>
<span id="cb51-1463"><a href="#cb51-1463" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- parameters are called within the fit model (the maximum possible effect for --&gt;</span></span>
<span id="cb51-1464"><a href="#cb51-1464" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- a variable has the prefix `bsp_mo` and the $\zeta_m$ have the prefix `simo_mo`). --&gt;</span></span>
<span id="cb51-1465"><a href="#cb51-1465" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- On this basis, we can specify the treatment comparisons with placebo as follows: --&gt;</span></span>
<span id="cb51-1466"><a href="#cb51-1466" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r, eval=FALSE} --&gt;</span></span>
<span id="cb51-1467"><a href="#cb51-1467" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- monotonic_comparisons &lt;- list( --&gt;</span></span>
<span id="cb51-1468"><a href="#cb51-1468" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * `simo_moTRT01P1[1]` &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1469"><a href="#cb51-1469" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * (`simo_moTRT01P1[1]` + `simo_moTRT01P1[2]`) &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1470"><a href="#cb51-1470" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1471"><a href="#cb51-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1472"><a href="#cb51-1472" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * `simo_moTRT01P1[1]` + `bsp_moTRT01P:AVISIT2` * 3.0 * `simo_moTRT01P:AVISIT21[1]` &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1473"><a href="#cb51-1473" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * (`simo_moTRT01P1[1]` + `simo_moTRT01P1[2]`) + `bsp_moTRT01P:AVISIT2` * 3.0 *  (`simo_moTRT01P:AVISIT21[1]` + `simo_moTRT01P:AVISIT21[2]`) &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1474"><a href="#cb51-1474" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 + `bsp_moTRT01P:AVISIT2` * 3.0 &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1475"><a href="#cb51-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1476"><a href="#cb51-1476" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * `simo_moTRT01P1[1]` + `bsp_moTRT01P:AVISIT3` * 3.0 * `simo_moTRT01P:AVISIT31[1]` &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1477"><a href="#cb51-1477" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * (`simo_moTRT01P1[1]` + `simo_moTRT01P1[2]`) + `bsp_moTRT01P:AVISIT3` * 3.0 *  (`simo_moTRT01P:AVISIT31[1]` + `simo_moTRT01P:AVISIT31[2]`) &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1478"><a href="#cb51-1478" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 + `bsp_moTRT01P:AVISIT3` * 3.0 &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1479"><a href="#cb51-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1480"><a href="#cb51-1480" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * `simo_moTRT01P1[1]` + `bsp_moTRT01P:AVISIT4` * 3.0 * `simo_moTRT01P:AVISIT41[1]` &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1481"><a href="#cb51-1481" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0 * (`simo_moTRT01P1[1]` + `simo_moTRT01P1[2]`) + `bsp_moTRT01P:AVISIT4` * 3.0 * ( `simo_moTRT01P:AVISIT41[1]` + `simo_moTRT01P:AVISIT41[2]`) &lt; 0", class=NULL), --&gt;</span></span>
<span id="cb51-1482"><a href="#cb51-1482" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis(brmfit2, "bsp_moTRT01P * 3.0  + `bsp_moTRT01P:AVISIT4` * 3.0 &lt; 0", class=NULL)) %&gt;% --&gt;</span></span>
<span id="cb51-1483"><a href="#cb51-1483" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   map_dfr(\(x) x$hypothesis %&gt;% as_tibble()) %&gt;% --&gt;</span></span>
<span id="cb51-1484"><a href="#cb51-1484" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(week = rep(c(2,4,8,12), each=3), --&gt;</span></span>
<span id="cb51-1485"><a href="#cb51-1485" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--          dose = rep(c(10, 20, 40), 4)) %&gt;% --&gt;</span></span>
<span id="cb51-1486"><a href="#cb51-1486" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(Comparison = case_when(week==2 ~ paste0("Visit 1: ", dose, " vs. placebo"), --&gt;</span></span>
<span id="cb51-1487"><a href="#cb51-1487" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                 week==4 ~ paste0("Visit 2: ", dose, " vs. placebo"), --&gt;</span></span>
<span id="cb51-1488"><a href="#cb51-1488" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                 week==8 ~ paste0("Visit 3: ", dose, " vs. placebo"), --&gt;</span></span>
<span id="cb51-1489"><a href="#cb51-1489" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                 TRUE ~ paste0("Visit 4: ", dose, " vs. placebo")), --&gt;</span></span>
<span id="cb51-1490"><a href="#cb51-1490" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--          Model = "MMRM + monotonic dose response") --&gt;</span></span>
<span id="cb51-1491"><a href="#cb51-1491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1492"><a href="#cb51-1492" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- monotonic_comparisons %&gt;% --&gt;</span></span>
<span id="cb51-1493"><a href="#cb51-1493" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   bind_rows(expand_grid(week=0, dose=c(10,20,40), Estimate=0)) %&gt;% --&gt;</span></span>
<span id="cb51-1494"><a href="#cb51-1494" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ggplot(aes(x=week, y=Estimate, ymin = CI.Lower, ymax=CI.Upper, --&gt;</span></span>
<span id="cb51-1495"><a href="#cb51-1495" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              group=factor(dose), color=factor(dose),  --&gt;</span></span>
<span id="cb51-1496"><a href="#cb51-1496" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              label=paste0(dose, " mg") )) + --&gt;</span></span>
<span id="cb51-1497"><a href="#cb51-1497" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   geom_hline(yintercept = 0) + --&gt;</span></span>
<span id="cb51-1498"><a href="#cb51-1498" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   geom_point(position=position_dodge(width=0.2)) + --&gt;</span></span>
<span id="cb51-1499"><a href="#cb51-1499" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   geom_errorbar(position=position_dodge(width=0.2)) + --&gt;</span></span>
<span id="cb51-1500"><a href="#cb51-1500" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   geom_line(position=position_dodge(width=0.2))  + --&gt;</span></span>
<span id="cb51-1501"><a href="#cb51-1501" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   theme(legend.position="right") + --&gt;</span></span>
<span id="cb51-1502"><a href="#cb51-1502" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   scale_color_brewer(palette="YlOrRd", limits=c("0","10","20","40"), --&gt;</span></span>
<span id="cb51-1503"><a href="#cb51-1503" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                      breaks=c("10","20","40")) + --&gt;</span></span>
<span id="cb51-1504"><a href="#cb51-1504" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ylab("Difference to placebo in change from baseline") --&gt;</span></span>
<span id="cb51-1505"><a href="#cb51-1505" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb51-1506"><a href="#cb51-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1507"><a href="#cb51-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1508"><a href="#cb51-1508" aria-hidden="true" tabindex="-1"></a><span class="fu">### Going beyond the traditional MMRM: non-linear functions</span></span>
<span id="cb51-1509"><a href="#cb51-1509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1510"><a href="#cb51-1510" aria-hidden="true" tabindex="-1"></a>As an alternative to the assumptions we made regarding monotonic predictors,</span>
<span id="cb51-1511"><a href="#cb51-1511" aria-hidden="true" tabindex="-1"></a>we can explicitly specify a functional form for how doses are related and how</span>
<span id="cb51-1512"><a href="#cb51-1512" aria-hidden="true" tabindex="-1"></a>their effect develops over time. However, while we will assume</span>
<span id="cb51-1513"><a href="#cb51-1513" aria-hidden="true" tabindex="-1"></a>a particular functional form for the treatment effect over time, we will</span>
<span id="cb51-1514"><a href="#cb51-1514" aria-hidden="true" tabindex="-1"></a>keep how the control group is modeled as flexible as possible.</span>
<span id="cb51-1515"><a href="#cb51-1515" aria-hidden="true" tabindex="-1"></a>Notice that we would want to set</span>
<span id="cb51-1516"><a href="#cb51-1516" aria-hidden="true" tabindex="-1"></a><span class="in">`control = list(adapt_delta=0.999, max_treedepth=13)`</span>, because we received</span>
<span id="cb51-1517"><a href="#cb51-1517" aria-hidden="true" tabindex="-1"></a>warnings that there were divergent transitions (hence an <span class="in">`adapt_delta`</span></span>
<span id="cb51-1518"><a href="#cb51-1518" aria-hidden="true" tabindex="-1"></a>closer to 1 than before) and poor sampling with many transitions hitting the</span>
<span id="cb51-1519"><a href="#cb51-1519" aria-hidden="true" tabindex="-1"></a>maximum tree depth (hence <span class="in">`max_treedepth`</span> increased from 10 to 13).</span>
<span id="cb51-1520"><a href="#cb51-1520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1521"><a href="#cb51-1521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r nonlin_brms, results='hide', message=FALSE, warning=FALSE}</span></span>
<span id="cb51-1522"><a href="#cb51-1522" aria-hidden="true" tabindex="-1"></a>mmrm_dr_model <span class="ot">&lt;-</span> <span class="fu">bf</span>( CHG <span class="sc">~</span> E0 <span class="sc">+</span> Emax <span class="sc">*</span> ndose<span class="sc">^</span>h<span class="sc">/</span>(ndose<span class="sc">^</span>h <span class="sc">+</span> ED50<span class="sc">^</span>h) <span class="sc">*</span> nweek<span class="sc">^</span>ht<span class="sc">/</span>(nweek<span class="sc">^</span>ht <span class="sc">+</span> ET50<span class="sc">^</span>ht),</span>
<span id="cb51-1523"><a href="#cb51-1523" aria-hidden="true" tabindex="-1"></a>                     <span class="at">autocor=</span><span class="sc">~</span><span class="fu">unstr</span>(AVISIT, USUBJID), </span>
<span id="cb51-1524"><a href="#cb51-1524" aria-hidden="true" tabindex="-1"></a>                     sigma <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> TRT01P <span class="sc">+</span> AVISIT<span class="sc">:</span>TRT01P,</span>
<span id="cb51-1525"><a href="#cb51-1525" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">nlf</span>(h <span class="sc">~</span> <span class="fu">exp</span>(logh)), <span class="fu">nlf</span>(ED50 <span class="sc">~</span> <span class="fu">exp</span>(logED50)),</span>
<span id="cb51-1526"><a href="#cb51-1526" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">nlf</span>(ht <span class="sc">~</span> <span class="fu">exp</span>(loght)), <span class="fu">nlf</span>(ET50 <span class="sc">~</span> <span class="fu">exp</span>(logET50)),</span>
<span id="cb51-1527"><a href="#cb51-1527" aria-hidden="true" tabindex="-1"></a>                     E0 <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AVISIT <span class="sc">+</span> BASE <span class="sc">+</span> BASE<span class="sc">:</span>AVISIT,</span>
<span id="cb51-1528"><a href="#cb51-1528" aria-hidden="true" tabindex="-1"></a>                     Emax <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb51-1529"><a href="#cb51-1529" aria-hidden="true" tabindex="-1"></a>                     logED50 <span class="sc">~</span> <span class="dv">1</span>, logh <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb51-1530"><a href="#cb51-1530" aria-hidden="true" tabindex="-1"></a>                     logET50 <span class="sc">~</span> <span class="dv">1</span>, loght <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb51-1531"><a href="#cb51-1531" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nl=</span><span class="cn">TRUE</span>,</span>
<span id="cb51-1532"><a href="#cb51-1532" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family=</span><span class="fu">gaussian</span>())</span>
<span id="cb51-1533"><a href="#cb51-1533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1534"><a href="#cb51-1534" aria-hidden="true" tabindex="-1"></a>mmrm_dr_prior <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">class=</span>b, <span class="at">coef=</span>Intercept, <span class="at">nlpar=</span>E0) <span class="sc">+</span></span>
<span id="cb51-1535"><a href="#cb51-1535" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class=</span>b, <span class="at">nlpar=</span>E0) <span class="sc">+</span></span>
<span id="cb51-1536"><a href="#cb51-1536" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">4.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">nlpar=</span>logh) <span class="sc">+</span></span>
<span id="cb51-1537"><a href="#cb51-1537" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">4.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">nlpar=</span>loght) <span class="sc">+</span></span>
<span id="cb51-1538"><a href="#cb51-1538" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">nlpar=</span>Emax) <span class="sc">+</span></span>
<span id="cb51-1539"><a href="#cb51-1539" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">2.5</span>, <span class="fu">log</span>(<span class="fl">10.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">nlpar=</span>logED50) <span class="sc">+</span></span>
<span id="cb51-1540"><a href="#cb51-1540" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fu">log</span>(<span class="dv">4</span>), <span class="fu">log</span>(<span class="dv">5</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">nlpar=</span>logET50) <span class="sc">+</span></span>
<span id="cb51-1541"><a href="#cb51-1541" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">10.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>Intercept, <span class="at">dpar=</span>sigma) <span class="sc">+</span></span>
<span id="cb51-1542"><a href="#cb51-1542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fl">2.0</span>)<span class="sc">/</span><span class="fl">1.64</span>), <span class="at">class=</span>b, <span class="at">dpar=</span>sigma) <span class="sc">+</span></span>
<span id="cb51-1543"><a href="#cb51-1543" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">lkj_corr_cholesky</span>(<span class="dv">1</span>), <span class="at">class=</span>Lcortime)</span>
<span id="cb51-1544"><a href="#cb51-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1545"><a href="#cb51-1545" aria-hidden="true" tabindex="-1"></a>brmfit3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb51-1546"><a href="#cb51-1546" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula=</span>mmrm_dr_model,</span>
<span id="cb51-1547"><a href="#cb51-1547" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> mmrm_dr_prior,</span>
<span id="cb51-1548"><a href="#cb51-1548" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> simulated_data <span class="sc">%&gt;%</span></span>
<span id="cb51-1549"><a href="#cb51-1549" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">nweek =</span> ADY<span class="sc">/</span><span class="dv">7</span>,</span>
<span id="cb51-1550"><a href="#cb51-1550" aria-hidden="true" tabindex="-1"></a>           <span class="at">ndose =</span> <span class="fu">as.numeric</span>(<span class="fu">levels</span>(TRT01P)[TRT01P])),</span>
<span id="cb51-1551"><a href="#cb51-1551" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> control_args,</span>
<span id="cb51-1552"><a href="#cb51-1552" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb51-1553"><a href="#cb51-1553" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1554"><a href="#cb51-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1555"><a href="#cb51-1555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1556"><a href="#cb51-1556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1557"><a href="#cb51-1557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1558"><a href="#cb51-1558" aria-hidden="true" tabindex="-1"></a>Note that here, it is hard to see how to make <span class="in">`emmeans`</span> work. Instead,</span>
<span id="cb51-1559"><a href="#cb51-1559" aria-hidden="true" tabindex="-1"></a>we use <span class="in">`hypothesis`</span> to get treatment differences at each visit. </span>
<span id="cb51-1560"><a href="#cb51-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1561"><a href="#cb51-1561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r contrasts_nonlin}</span></span>
<span id="cb51-1562"><a href="#cb51-1562" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb51-1563"><a href="#cb51-1563" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show the code"</span></span>
<span id="cb51-1564"><a href="#cb51-1564" aria-hidden="true" tabindex="-1"></a>comparisons_for_sigemax <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">dose =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">40</span>), <span class="at">week=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">12</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-1565"><a href="#cb51-1565" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Hypothesis string</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(</span>
<span id="cb51-1566"><a href="#cb51-1566" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Emax_Intercept * "</span>, dose, <span class="st">"^exp(logh_Intercept)/("</span>, dose,</span>
<span id="cb51-1567"><a href="#cb51-1567" aria-hidden="true" tabindex="-1"></a>        <span class="st">"^exp(logh_Intercept) + exp(logED50_Intercept)^exp(logh_Intercept)) * "</span>,</span>
<span id="cb51-1568"><a href="#cb51-1568" aria-hidden="true" tabindex="-1"></a>        week, <span class="st">"^exp(loght_Intercept)/("</span>,</span>
<span id="cb51-1569"><a href="#cb51-1569" aria-hidden="true" tabindex="-1"></a>        week,</span>
<span id="cb51-1570"><a href="#cb51-1570" aria-hidden="true" tabindex="-1"></a>        <span class="st">"^exp(loght_Intercept) + exp(logET50_Intercept)^exp(loght_Intercept)) &lt; 0"</span>),</span>
<span id="cb51-1571"><a href="#cb51-1571" aria-hidden="true" tabindex="-1"></a>        <span class="at">evaluation =</span> <span class="fu">map</span>(<span class="st">`</span><span class="at">Hypothesis string</span><span class="st">`</span>,</span>
<span id="cb51-1572"><a href="#cb51-1572" aria-hidden="true" tabindex="-1"></a>                         \(x) <span class="fu">hypothesis</span>(brmfit3, x)<span class="sc">$</span>hypothesis <span class="sc">%&gt;%</span></span>
<span id="cb51-1573"><a href="#cb51-1573" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">as_tibble</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb51-1574"><a href="#cb51-1574" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(evaluation) <span class="sc">%&gt;%</span></span>
<span id="cb51-1575"><a href="#cb51-1575" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Comparison =</span> <span class="fu">case_when</span>(week<span class="sc">==</span><span class="dv">2</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Visit 1: "</span>, dose, <span class="st">" vs. placebo"</span>),</span>
<span id="cb51-1576"><a href="#cb51-1576" aria-hidden="true" tabindex="-1"></a>                                    week<span class="sc">==</span><span class="dv">4</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Visit 2: "</span>, dose, <span class="st">" vs. placebo"</span>),</span>
<span id="cb51-1577"><a href="#cb51-1577" aria-hidden="true" tabindex="-1"></a>                                    week<span class="sc">==</span><span class="dv">8</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Visit 3: "</span>, dose, <span class="st">" vs. placebo"</span>),</span>
<span id="cb51-1578"><a href="#cb51-1578" aria-hidden="true" tabindex="-1"></a>                                    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Visit 4: "</span>, dose, <span class="st">" vs. placebo"</span>)),</span>
<span id="cb51-1579"><a href="#cb51-1579" aria-hidden="true" tabindex="-1"></a>             <span class="at">Model =</span> <span class="st">"BMMRM (non-linear)"</span>)</span>
<span id="cb51-1580"><a href="#cb51-1580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1581"><a href="#cb51-1581" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the results</span></span>
<span id="cb51-1582"><a href="#cb51-1582" aria-hidden="true" tabindex="-1"></a>comparisons_for_sigemax <span class="sc">%&gt;%</span></span>
<span id="cb51-1583"><a href="#cb51-1583" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(<span class="fu">expand_grid</span>(<span class="at">week=</span><span class="dv">0</span>, <span class="at">Estimate=</span><span class="dv">0</span>, <span class="at">dose=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">40</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb51-1584"><a href="#cb51-1584" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week, <span class="at">y=</span>Estimate, <span class="at">ymin=</span>CI.Lower, <span class="at">ymax=</span>CI.Upper,</span>
<span id="cb51-1585"><a href="#cb51-1585" aria-hidden="true" tabindex="-1"></a>               <span class="at">group=</span>dose, <span class="at">col=</span><span class="fu">factor</span>(dose))) <span class="sc">+</span></span>
<span id="cb51-1586"><a href="#cb51-1586" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb51-1587"><a href="#cb51-1587" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb51-1588"><a href="#cb51-1588" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb51-1589"><a href="#cb51-1589" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.2</span>)) <span class="sc">+</span></span>
<span id="cb51-1590"><a href="#cb51-1590" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb51-1591"><a href="#cb51-1591" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="st">"Dose"</span>, <span class="at">values=</span><span class="fu">c</span>(<span class="st">"#377eb8"</span>, <span class="st">"#fd8d3c"</span>, <span class="st">"#f03b20"</span>, <span class="st">"#bd0026"</span>)[<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb51-1592"><a href="#cb51-1592" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Change from baseline"</span>) <span class="sc">+</span></span>
<span id="cb51-1593"><a href="#cb51-1593" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Treatment difference to placebo"</span>)</span>
<span id="cb51-1594"><a href="#cb51-1594" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1595"><a href="#cb51-1595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1596"><a href="#cb51-1596" aria-hidden="true" tabindex="-1"></a>Just note that the string specifying the hypothesis become something complex and</span>
<span id="cb51-1597"><a href="#cb51-1597" aria-hidden="true" tabindex="-1"></a>long like</span>
<span id="cb51-1598"><a href="#cb51-1598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1599"><a href="#cb51-1599" aria-hidden="true" tabindex="-1"></a><span class="in">```{r hypothesis_strings_nonlin, eval=TRUE}</span></span>
<span id="cb51-1600"><a href="#cb51-1600" aria-hidden="true" tabindex="-1"></a>comparisons_for_sigemax<span class="sc">$</span><span class="st">`</span><span class="at">Hypothesis string</span><span class="st">`</span>[<span class="dv">1</span>]</span>
<span id="cb51-1601"><a href="#cb51-1601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1602"><a href="#cb51-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1603"><a href="#cb51-1603" aria-hidden="true" tabindex="-1"></a>for the difference to placebo for the 10 mg dose at week 2. </span>
<span id="cb51-1604"><a href="#cb51-1604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1605"><a href="#cb51-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1606"><a href="#cb51-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1607"><a href="#cb51-1607" aria-hidden="true" tabindex="-1"></a><span class="fu">## Results</span></span>
<span id="cb51-1608"><a href="#cb51-1608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1609"><a href="#cb51-1609" aria-hidden="true" tabindex="-1"></a>Here is an overview of the results with some the different models we</span>
<span id="cb51-1610"><a href="#cb51-1610" aria-hidden="true" tabindex="-1"></a>tried.</span>
<span id="cb51-1611"><a href="#cb51-1611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1612"><a href="#cb51-1612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plotallresults, eval=TRUE, fig.height=7, fig.width=8}</span></span>
<span id="cb51-1613"><a href="#cb51-1613" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb51-1614"><a href="#cb51-1614" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Show the code"</span></span>
<span id="cb51-1615"><a href="#cb51-1615" aria-hidden="true" tabindex="-1"></a><span class="fu">map2_dfr</span>(<span class="fu">list</span>(brmfit1, brmfit2, macfit, rmacfit),</span>
<span id="cb51-1616"><a href="#cb51-1616" aria-hidden="true" tabindex="-1"></a>         <span class="fu">c</span>(<span class="st">"BMMRM"</span>, <span class="st">"BMMRM (monotonic)"</span>, <span class="st">"BMMRM (MAC)"</span>, <span class="st">"BMMRM (rMAC)"</span>),</span>
<span id="cb51-1617"><a href="#cb51-1617" aria-hidden="true" tabindex="-1"></a>         \(x, y) <span class="fu">emmeans</span>(x, <span class="sc">~</span> TRT01P <span class="sc">|</span> AVISIT, <span class="at">weights=</span><span class="st">"proportional"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1618"><a href="#cb51-1618" aria-hidden="true" tabindex="-1"></a>           <span class="fu">contrast</span>(<span class="at">adjust=</span><span class="st">"none"</span>, <span class="at">method=</span><span class="st">"trt.vs.ctrl"</span>, <span class="at">ref=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-1619"><a href="#cb51-1619" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-1620"><a href="#cb51-1620" aria-hidden="true" tabindex="-1"></a>           <span class="fu">mutate</span>(<span class="at">Model=</span>y)) <span class="sc">%&gt;%</span></span>
<span id="cb51-1621"><a href="#cb51-1621" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(comparisons_for_sigemax <span class="sc">%&gt;%</span></span>
<span id="cb51-1622"><a href="#cb51-1622" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename</span>(<span class="at">estimate=</span>Estimate, <span class="at">lower.HPD=</span>CI.Lower, <span class="at">upper.HPD=</span>CI.Upper) <span class="sc">%&gt;%</span></span>
<span id="cb51-1623"><a href="#cb51-1623" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">AVISIT =</span> <span class="fu">paste0</span>(<span class="st">"visit"</span>, <span class="fu">case_when</span>(week<span class="sc">==</span><span class="dv">2</span><span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb51-1624"><a href="#cb51-1624" aria-hidden="true" tabindex="-1"></a>                                                        week<span class="sc">==</span><span class="dv">4</span><span class="sc">~</span><span class="dv">2</span>,</span>
<span id="cb51-1625"><a href="#cb51-1625" aria-hidden="true" tabindex="-1"></a>                                                        week<span class="sc">==</span><span class="dv">8</span><span class="sc">~</span><span class="dv">3</span>,</span>
<span id="cb51-1626"><a href="#cb51-1626" aria-hidden="true" tabindex="-1"></a>                                                        week<span class="sc">==</span><span class="dv">12</span><span class="sc">~</span><span class="dv">4</span>)),</span>
<span id="cb51-1627"><a href="#cb51-1627" aria-hidden="true" tabindex="-1"></a>                <span class="at">contrast =</span> <span class="fu">paste0</span>(dose,<span class="st">" - 0"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb51-1628"><a href="#cb51-1628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(contrasts1 <span class="sc">%&gt;%</span></span>
<span id="cb51-1629"><a href="#cb51-1629" aria-hidden="true" tabindex="-1"></a>    <span class="fu">confint</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb51-1630"><a href="#cb51-1630" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-1631"><a href="#cb51-1631" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">lower.HPD=</span>lower.CL,</span>
<span id="cb51-1632"><a href="#cb51-1632" aria-hidden="true" tabindex="-1"></a>           <span class="at">upper.HPD=</span>upper.CL) <span class="sc">%&gt;%</span></span>
<span id="cb51-1633"><a href="#cb51-1633" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Model=</span><span class="st">"Frequentist MMRM"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-1634"><a href="#cb51-1634" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Model, contrast, AVISIT, estimate, lower.HPD, upper.HPD) <span class="sc">%&gt;%</span></span>
<span id="cb51-1635"><a href="#cb51-1635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Model =</span> <span class="fu">factor</span>(Model,</span>
<span id="cb51-1636"><a href="#cb51-1636" aria-hidden="true" tabindex="-1"></a>                        <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"Frequentist MMRM"</span>,</span>
<span id="cb51-1637"><a href="#cb51-1637" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"BMMRM"</span>, </span>
<span id="cb51-1638"><a href="#cb51-1638" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"BMMRM (MAC)"</span>, <span class="st">"BMMRM (rMAC)"</span>,</span>
<span id="cb51-1639"><a href="#cb51-1639" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"BMMRM (monotonic)"</span>, <span class="st">"BMMRM (non-linear)"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb51-1640"><a href="#cb51-1640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>contrast, <span class="at">y=</span>estimate,</span>
<span id="cb51-1641"><a href="#cb51-1641" aria-hidden="true" tabindex="-1"></a>             <span class="at">ymin=</span>lower.HPD, <span class="at">ymax=</span>upper.HPD, <span class="at">col=</span>Model)) <span class="sc">+</span></span>
<span id="cb51-1642"><a href="#cb51-1642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb51-1643"><a href="#cb51-1643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb51-1644"><a href="#cb51-1644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb51-1645"><a href="#cb51-1645" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb51-1646"><a href="#cb51-1646" aria-hidden="true" tabindex="-1"></a>      <span class="fu">guides</span>(<span class="at">color=</span><span class="fu">guide_legend</span>(<span class="at">ncol=</span><span class="dv">2</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb51-1647"><a href="#cb51-1647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb51-1648"><a href="#cb51-1648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"#1b9e77"</span>,</span>
<span id="cb51-1649"><a href="#cb51-1649" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"#7570b3"</span>, <span class="st">"#e7298a"</span>, <span class="st">"#e6ab02"</span>, <span class="st">"#d95f02"</span>)) <span class="sc">+</span></span>
<span id="cb51-1650"><a href="#cb51-1650" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>AVISIT)</span>
<span id="cb51-1651"><a href="#cb51-1651" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1652"><a href="#cb51-1652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1653"><a href="#cb51-1653" aria-hidden="true" tabindex="-1"></a>Using a BMMRM in the particular example had without informative prior distributions</span>
<span id="cb51-1654"><a href="#cb51-1654" aria-hidden="true" tabindex="-1"></a>no particular advantage over a MMRM fit with REML. It is possible that there would</span>
<span id="cb51-1655"><a href="#cb51-1655" aria-hidden="true" tabindex="-1"></a>be some advantage to using BMMRM with vague priors with smaller sample sizes.</span>
<span id="cb51-1656"><a href="#cb51-1656" aria-hidden="true" tabindex="-1"></a>However, using historical </span>
<span id="cb51-1657"><a href="#cb51-1657" aria-hidden="true" tabindex="-1"></a>control group informtion with a MAC (or rMAC) approach </span>
<span id="cb51-1658"><a href="#cb51-1658" aria-hidden="true" tabindex="-1"></a>narrows the credible intervals. Making stronger assumptions about the dose</span>
<span id="cb51-1659"><a href="#cb51-1659" aria-hidden="true" tabindex="-1"></a>response relationship over time turns out to also have a substantial effect on </span>
<span id="cb51-1660"><a href="#cb51-1660" aria-hidden="true" tabindex="-1"></a>the width of the credible intervals. Of course, we could also use both prior </span>
<span id="cb51-1661"><a href="#cb51-1661" aria-hidden="true" tabindex="-1"></a>information about the control group and assumptions about the dose response </span>
<span id="cb51-1662"><a href="#cb51-1662" aria-hidden="true" tabindex="-1"></a>relationship for the drug.</span>
<span id="cb51-1663"><a href="#cb51-1663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1664"><a href="#cb51-1664" aria-hidden="true" tabindex="-1"></a>Unsurprisingly, putting in more information either in terms of prior</span>
<span id="cb51-1665"><a href="#cb51-1665" aria-hidden="true" tabindex="-1"></a>knowledge about the control group or in terms of the structure of the dose</span>
<span id="cb51-1666"><a href="#cb51-1666" aria-hidden="true" tabindex="-1"></a>response relationship leads to narrower CrIs and also affects the point </span>
<span id="cb51-1667"><a href="#cb51-1667" aria-hidden="true" tabindex="-1"></a>estimates.</span>
<span id="cb51-1668"><a href="#cb51-1668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1669"><a href="#cb51-1669" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb51-1670"><a href="#cb51-1670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1671"><a href="#cb51-1671" aria-hidden="true" tabindex="-1"></a>We can easily fit Bayesian MMRM models using <span class="in">`brms`</span> including using an</span>
<span id="cb51-1672"><a href="#cb51-1672" aria-hidden="true" tabindex="-1"></a>unstructured covariance matrix for how the residuals are</span>
<span id="cb51-1673"><a href="#cb51-1673" aria-hidden="true" tabindex="-1"></a>correlated. As in other cases, a benefit of <span class="in">`brms`</span> is that we can</span>
<span id="cb51-1674"><a href="#cb51-1674" aria-hidden="true" tabindex="-1"></a>combine this feature with the many other features available in <span class="in">`brms`</span></span>
<span id="cb51-1675"><a href="#cb51-1675" aria-hidden="true" tabindex="-1"></a>to gain a lot of flexibility in our modelling. With this modeling</span>
<span id="cb51-1676"><a href="#cb51-1676" aria-hidden="true" tabindex="-1"></a>flexibility we can evaluate varying assumptions which can lead to</span>
<span id="cb51-1677"><a href="#cb51-1677" aria-hidden="true" tabindex="-1"></a>greater statistical efficiency in our estimation as</span>
<span id="cb51-1678"><a href="#cb51-1678" aria-hidden="true" tabindex="-1"></a>demonstrated. Given the flexibility of <span class="in">`brms`</span>, these assumptions can</span>
<span id="cb51-1679"><a href="#cb51-1679" aria-hidden="true" tabindex="-1"></a>range from just monotonicity up to a full non-linear model for the</span>
<span id="cb51-1680"><a href="#cb51-1680" aria-hidden="true" tabindex="-1"></a>shape of the dose-response curve.</span>
<span id="cb51-1681"><a href="#cb51-1681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1682"><a href="#cb51-1682" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb51-1683"><a href="#cb51-1683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1684"><a href="#cb51-1684" aria-hidden="true" tabindex="-1"></a><span class="fu">### Excercise 1</span></span>
<span id="cb51-1685"><a href="#cb51-1685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1686"><a href="#cb51-1686" aria-hidden="true" tabindex="-1"></a>Analyze the following data from the ACTIVE RCT, which compared interventions </span>
<span id="cb51-1687"><a href="#cb51-1687" aria-hidden="true" tabindex="-1"></a>focused on memory, reasoning and speed of processing with a control group. </span>
<span id="cb51-1688"><a href="#cb51-1688" aria-hidden="true" tabindex="-1"></a>The data of the ACTIVE trial is available from the </span>
<span id="cb51-1689"><a href="#cb51-1689" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">US National archive of Computerized Data on Aging</span><span class="co">](https://doi.org/10.3886/ICPSR36036.v1)</span></span>
<span id="cb51-1690"><a href="#cb51-1690" aria-hidden="true" tabindex="-1"></a>and is used as an example for repeated measures on the </span>
<span id="cb51-1691"><a href="#cb51-1691" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Advanced Statistics using R website</span><span class="co">](https://advstats.psychstat.org/)</span>.</span>
<span id="cb51-1692"><a href="#cb51-1692" aria-hidden="true" tabindex="-1"></a>The outcome variable of interest is the Hopkins Verbal Learning Test (HVLT) </span>
<span id="cb51-1693"><a href="#cb51-1693" aria-hidden="true" tabindex="-1"></a>total score compared with time 1 (baseline, <span class="in">`hvltt`</span> column) </span>
<span id="cb51-1694"><a href="#cb51-1694" aria-hidden="true" tabindex="-1"></a>assessed immediately after training (<span class="in">`hvltt2`</span> column),</span>
<span id="cb51-1695"><a href="#cb51-1695" aria-hidden="true" tabindex="-1"></a>1 year later (<span class="in">`hvltt3`</span> column) and 2 years later (<span class="in">`hvltt4`</span> column).</span>
<span id="cb51-1696"><a href="#cb51-1696" aria-hidden="true" tabindex="-1"></a>Consider how to structure your analysis dataset and covariates might be sensible</span>
<span id="cb51-1697"><a href="#cb51-1697" aria-hidden="true" tabindex="-1"></a>to include in the model.</span>
<span id="cb51-1698"><a href="#cb51-1698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1699"><a href="#cb51-1699" aria-hidden="true" tabindex="-1"></a><span class="in">```{r exercisedata1, eval=FALSE}</span></span>
<span id="cb51-1700"><a href="#cb51-1700" aria-hidden="true" tabindex="-1"></a>active <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://advstats.psychstat.org/data/active.csv"</span>, </span>
<span id="cb51-1701"><a href="#cb51-1701" aria-hidden="true" tabindex="-1"></a>                   <span class="at">col_types =</span> <span class="st">"iiiiiiiiiiiiii"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb51-1702"><a href="#cb51-1702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">factor</span>(group, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, </span>
<span id="cb51-1703"><a href="#cb51-1703" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"control"</span>, <span class="st">"memory"</span>, <span class="st">"reasoning"</span>, <span class="st">"speed"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb51-1704"><a href="#cb51-1704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(id, group, hvltt, hvltt2, hvltt3, hvltt4)</span>
<span id="cb51-1705"><a href="#cb51-1705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1706"><a href="#cb51-1706" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(active)</span>
<span id="cb51-1707"><a href="#cb51-1707" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1708"><a href="#cb51-1708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1709"><a href="#cb51-1709" aria-hidden="true" tabindex="-1"></a><span class="fu">### Excercise 2</span></span>
<span id="cb51-1710"><a href="#cb51-1710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1711"><a href="#cb51-1711" aria-hidden="true" tabindex="-1"></a>Try changing the size of the simulated data so that there is 80 (or 90\%) power</span>
<span id="cb51-1712"><a href="#cb51-1712" aria-hidden="true" tabindex="-1"></a>at the one-sided 2.5\%, 5\% or 10\% significance level. Do our priors </span>
<span id="cb51-1713"><a href="#cb51-1713" aria-hidden="true" tabindex="-1"></a>become more influential as the sample size decreases (compared with a </span>
<span id="cb51-1714"><a href="#cb51-1714" aria-hidden="true" tabindex="-1"></a>frequentist MMRM fit using the <span class="in">`mmrm`</span> package)</span>
<span id="cb51-1715"><a href="#cb51-1715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1716"><a href="#cb51-1716" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>when you use the standard Bayesian MMRM and</span>
<span id="cb51-1717"><a href="#cb51-1717" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>when using the MAC (or rMAC) approaches?</span>
<span id="cb51-1718"><a href="#cb51-1718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1719"><a href="#cb51-1719" aria-hidden="true" tabindex="-1"></a><span class="fu">## References {.unnumbered}</span></span>
<span id="cb51-1720"><a href="#cb51-1720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1721"><a href="#cb51-1721" aria-hidden="true" tabindex="-1"></a>::: {#refs}</span>
<span id="cb51-1722"><a href="#cb51-1722" aria-hidden="true" tabindex="-1"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/Novartis/bamdd/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>